"id"	"creationdate"	"failurereason"	"insyncwithsource"	"lastmodifieddate"	"name"	"notinsyncreason"	"sqltext"	"state"
6	2015-04-24 18:17:10	"1112787622"	true	2015-04-24 18:17:10	raw.stock_location		"CREATE VIEW raw.stock_location AS

SELECT 
	id AS stock_location_id,
	CASE
		WHEN id = 1	THEN 'Zalando Germany'
		WHEN id = 2	THEN 'Outfittery'
		WHEN id = 3	THEN 'Zalando Switzerland'
		WHEN id = 4	THEN 'FashionID'
	END AS stock_location_supplier,
	supplier_id
FROM postgres.stock_location"	READY
3	2015-04-24 18:17:10	"638184474"	true	2015-04-24 18:17:10	views.ga_transactions_source_medium		"CREATE view views.ga_transactions_source_medium as
SELECT
	source_medium as sourceMedium,
	channel as channel
FROM ""dwh.ga_channel_translation"""	READY
4	2015-04-24 18:17:10	"638184475"	true	2015-04-24 18:17:10	views.salesforce_user_info		"CREATE view views.salesforce_user_info 
as
SELECT 
	/*User Information*/
	sf_user.Id as sf_user_id,
	sf_user.Username,
	sf_user.LastName,
	sf_user.FirstName,
	sf_user.Name,
	sf_user.CompanyName,
	/*Salesforce Profile*/
	prof.""Name"" as profile_name,
	/*User role are based on team lead of stylist*/
	urole.id,
	urole.""Name"" as user_role
FROM ""salesforce"".""User_"" sf_user 
inner join ""salesforce"".""UserRole"" urole on urole.id=sf_user.UserRoleId
inner join ""salesforce"".""Profile"" prof on prof.id=sf_user.ProfileId"	READY
12	2015-04-24 18:17:12	"1112787626"	true	2015-04-24 18:17:12	views.doc_data_stock_mutation		"CREATE view views.doc_data_stock_mutation AS

SELECT 
	id,
	version,
	booking_code,
	customer_article_number,
	""date"",
	parseTimestamp(date_created, 'yyyy-MM-dd HH:mm:ss.S' ) as date_created,
	parseTimestamp(date_processed, 'yyyy-MM-dd HH:mm:ss.S' ) as date_processed,
	parseTimestamp(last_updated, 'yyyy-MM-dd HH:mm:ss.S' ) as last_updated,
	packing_slip_number,
	po_number,
	processing_reason,
	processing_result,
	processing_state,
	quantity_defect,
	quantity_good,
	supplier_code 
FROM postgres.doc_data_stock_mutation



/* new code; needs fixing for quantity_defect and quantity_good due to data changes
SELECT 
	stock_booking_id AS id,
	CAST(NULL AS LONG) AS version,
	CAST(stock_booking_code AS STRING(50)) AS booking_code,
	CAST(article_id AS STRING(50)) AS customer_article_number,
	stock_date AS ""date"",  						      	
	date_stock_booked as date_created,
	date_stock_booking_processed as date_processed,
	date_stock_booking_updated as last_updated,
	stock_booking_packing_slip_number AS packing_slip_number,
	CAST(
		CASE
			WHEN purchase_order_id IS NULL THEN ''
			ELSE purchase_order_id
		END 
	AS STRING(20)) AS po_number,
	stock_booking_processing_reason as processing_reason, 		      	
	stock_booking_processing_result as processing_result,
	stock_booking_processing_state_number as processing_state,
	CAST(NULL AS STRING(50)) AS quantity_defect, 				      	
	CAST(stock_booked AS STRING(50)) AS quantity_good,
	CAST(supplier_id AS STRING(50)) AS supplier_code
FROM raw.stock_booked
*/"	READY
13	2015-04-24 18:17:12	"1112787627"	true	2015-04-24 18:17:12	raw.stock_booked		"CREATE VIEW raw.stock_booked AS

SELECT 
    CAST(sm.id AS LONG) AS stock_booked_id,
    CAST(CASE WHEN po_number = '' THEN NULL ELSE po_number END AS LONG) AS purchase_order_id,
    CAST(sm.customer_article_number AS LONG) AS article_id,
    ""date"" AS stock_date,
    parseTimestamp(sm.date_created, 'yyyy-MM-dd HH:mm:ss.S') AS date_stock_booked,
    parseTimestamp(sm.date_processed, 'yyyy-MM-dd HH:mm:ss.S') AS date_processed,
    parseTimestamp(sm.last_updated, 'yyyy-MM-dd HH:mm:ss.S') AS last_updated,
    sm.packing_slip_number AS stock_booking_packing_slip_number,
    CAST(sm.booking_code AS INTEGER) AS stock_booking_code,
    LEFT(processing_reason, 4000) AS stock_booking_processing_reason,
    CAST(sm.processing_state AS INTEGER) AS stock_booking_processing_state_number,
    CAST(sm.processing_result AS INTEGER) AS stock_booking_processing_result,
    CAST(sm.supplier_code AS INTEGER) AS supplier_id,
    CAST(CASE WHEN sm.quantity_defect = '' THEN NULL ELSE sm.quantity_defect END AS INTEGER) AS stock_defects,
    CAST(CASE WHEN sm.quantity_good   = '' THEN NULL ELSE sm.quantity_good   END AS INTEGER) AS stock_booked
FROM 
	postgres.doc_data_stock_mutation sm"	READY
18	2015-04-24 18:17:14	"1112787629"	true	2015-04-24 18:17:14	views.purchase_order_position		"CREATE VIEW views.purchase_order_position AS 

SELECT 
	pop.id, 
	pop.article_id, 
	pop.purchase_order_id, 
	pop.date_created, 
	pop.fulfilled_quantity, 
	pop.last_updated, 
	pop.quantity, 
	pop.supplier_order_number, 
	pop.date_canceled, 
	pop.date_fulfilled, 
	pop.order_position_id, 
	pop.state, 
	pop.initial_quantity, 
	pop.retail_price, 
	pop.purchase_price, 
	pop.purchase_order_positions_idx, 
	pop.earliest_delivery_date, 
	pop.latest_delivery_date, 
	case when pim.ean is null then sa.ean else pim.ean end as ean, 
	pim.article_name, 
	pim.color1, 
	pim.eu_size, 
	pim.hanging_garments, 
	pim.pic1, 
	pim.supplier_sku, 
	pim.alternative_supplier_sku, 
	pim.commodity_group3,
	pim.eu_length 
FROM postgres.purchase_order_position pop 
LEFT JOIN postgres.supplier_article sa ON sa.article_id = pop.article_id
LEFT JOIN 
(
	SELECT 
		o.ean, 
		o.article_name, 
		o.color1, 
		o.eu_size,
		o.pic1, 
		o.hanging_garments, 
		o.supplier_sku, 
		o.alternative_supplier_sku, 
		o.eu_length,
		CASE 
			WHEN cg3.title_de is not null THEN cg3.title_de 
			ELSE o.commodity_group3 
		END as commodity_group3
  	FROM pim.object_17 o
	INNER JOIN pim.object_17 AS parent ON parent.o_id = o.o_parentid 
	INNER JOIN pim.object_17 AS parent_parent ON parent_parent.o_id = parent.o_parentid
	LEFT JOIN dwh.commodity_group3 cg3 ON cg3.commodity_group3 = o.commodity_group3
)AS pim ON pim.ean = sa.ean
WHERE sa.supplier_id = 15


/* reverting to original code for erp
SELECT 
	poa.poa_id AS id, 
	poa.article_id, 
	poa.purchase_order_id, 
	poa.date_poa_created AS date_created, 
	CAST(poa.stock_booked AS INTEGER) AS fulfilled_quantity, 
	poa.date_poa_updated AS last_updated, 
	poa.stock_ordered_revised AS quantity, 
	poa.poa_supplier_order_number AS supplier_order_number, 
	poa.date_poa_cancelled AS date_canceled, 
	CAST(poa.date_stock_booked_min AS TIMESTAMP) AS date_fulfilled, 
	poa.order_position_id AS order_position_id, 
	CAST(poa.poa_state_number AS INTEGER) AS state, 
	CAST(poa.stock_ordered_initially AS LONG) AS initial_quantity, 
	poa.article_sales_price AS retail_price, 
	poa.article_cost AS purchase_price, 
	CAST(poa.poa_position_number AS INTEGER) AS purchase_order_positions_idx, 
	CAST(poa.date_poa_delivery_earliest AS TIMESTAMP) AS earliest_delivery_date, 
	CAST(poa.date_poa_delivery_latest AS TIMESTAMP) AS latest_delivery_date, 
	CAST(a.article_ean AS STRING(4000)) AS ean,
	a.article_name,
	a.article_color1 AS color1,
	CAST(a.article_eu_size AS STRING(255)) AS eu_size,
	a.article_hanging_garment AS hanging_garments,
	a.article_pic1 AS pic1,
	CAST(a.article_supplier_sku AS STRING(255)) AS supplier_sku,
	CAST(a.article_supplier_alternative_sku AS STRING(255)) AS alternative_supplier_sku,
	pim.commodity_group3,
	CAST(a.article_eu_length AS STRING(255)) AS eu_length
FROM
	bi.purchase_order_articles poa
	JOIN
	bi.article a
		ON a.article_id = poa.article_id
	LEFT JOIN
	(
		SELECT DISTINCT
			o.ean,
			COALESCE(cg3.title_de, o.commodity_group3) AS commodity_group3
	  	FROM raw.article_detail_pim o
	  	INNER JOIN raw.article_detail_pim AS parent ON parent.oo_id = o.o_parent_id
		INNER JOIN raw.article_detail_pim AS parent_parent ON parent_parent.oo_id = parent.o_parent_id
		LEFT JOIN dwh.commodity_group3 cg3 ON cg3.commodity_group3 = o.commodity_group3
	) AS pim ON pim.ean = poa.article_ean
WHERE 
	a.article_ever_supplied_by_outfittery = 'Outfittery'
AND poa.driving_tbl_poa IS NOT NULL	
*/"	READY
20	2015-04-24 18:17:14	"1112787630"	true	2015-04-24 18:17:14	ml.amidala_category_leaves		"/*
   The leaves from the Amidala catgory tree
   attribute_id, identifier and last_updated same as columns postgres.attribute
   c0..c5 are the identifiers from the root c0 to the the leave
   sale_or_premium indicates if there is 'sale' or 'premium' in at least one c0..c5
*/
CREATE VIEW ml.amidala_category_leaves AS
WITH leaves AS
(
   SELECT
   a0.id AS id_0,
   a0.last_updated,
         (CAST ((a0.id IS NOT NULL) AS INTEGER)) +
   (CAST ((a1.id IS NOT NULL) AS INTEGER)) +
   (CAST ((a2.id IS NOT NULL) AS INTEGER)) +
   (CAST ((a3.id IS NOT NULL) AS INTEGER)) +
   (CAST ((a4.id IS NOT NULL) AS INTEGER)) +
   (CAST ((a5.id IS NOT NULL) AS INTEGER)) AS depth,
         COALESCE( ('sale' = a0.identifier), FALSE ) OR
   COALESCE( ('sale' = a1.identifier), FALSE ) OR
   COALESCE( ('sale' = a2.identifier), FALSE ) OR
   COALESCE( ('sale' = a3.identifier), FALSE ) OR
   COALESCE( ('sale' = a4.identifier), FALSE ) OR
   COALESCE( ('sale' = a5.identifier), FALSE ) OR
   COALESCE( ('premium' = a0.identifier), FALSE ) OR
   COALESCE( ('premium' = a1.identifier), FALSE ) OR
   COALESCE( ('premium' = a2.identifier), FALSE ) OR
   COALESCE( ('premium' = a3.identifier), FALSE ) OR
   COALESCE( ('premium' = a4.identifier), FALSE ) OR
   COALESCE( ('premium' = a5.identifier), FALSE ) AS sale_or_premium,
         a0.identifier AS identifier_0,
   a1.identifier AS identifier_1,
   a2.identifier AS identifier_2,
   a3.identifier AS identifier_3,
   a4.identifier AS identifier_4,
   a5.identifier AS identifier_5
   from postgres.attribute a0
   LEFT JOIN postgres.attribute a1 ON (a0.parent_id = a1.id)
   LEFT JOIN postgres.attribute a2 ON a1.parent_id = a2.id
   LEFT JOIN postgres.attribute a3 ON a2.parent_id = a3.id
   LEFT JOIN postgres.attribute a4 ON a3.parent_id = a4.id
   LEFT JOIN postgres.attribute a5 ON a4.parent_id = a5.id
   LEFT JOIN postgres.attribute att_child ON att_child.parent_id = a0.id
   WHERE a0.property_id = 280118
   AND att_child.id IS NULL
   AND a0.active = 'true'
)
SELECT
    l.id_0 AS attribute_id,
    l.identifier_0 AS identifier,
    l.depth,
    l.sale_or_premium,
    l.last_updated,
/**/
    CASE
    WHEN l.depth = 6 THEN identifier_5
    WHEN l.depth = 5 THEN identifier_4
    WHEN l.depth = 4 THEN identifier_3
    WHEN l.depth = 3 THEN identifier_2
    WHEN l.depth = 2 THEN identifier_1
    WHEN l.depth = 1 THEN identifier_0
    END AS c0,
/**/
    CASE
    WHEN l.depth = 5+1 THEN identifier_4
    WHEN l.depth = 4+1 THEN identifier_3
    WHEN l.depth = 3+1 THEN identifier_2
    WHEN l.depth = 2+1 THEN identifier_1
    WHEN l.depth = 1+1 THEN identifier_0
    END AS c1,
/**/
    CASE
    WHEN l.depth = 4+2 THEN identifier_3
    WHEN l.depth = 3+2 THEN identifier_2
    WHEN l.depth = 2+2 THEN identifier_1
    WHEN l.depth = 1+2 THEN identifier_0
    END AS c2,
/**/
    CASE
    WHEN l.depth = 3+3 THEN identifier_2
    WHEN l.depth = 2+3 THEN identifier_1
    WHEN l.depth = 1+3 THEN identifier_0
    END AS c3,
/**/
    CASE
    WHEN l.depth = 2+4 THEN identifier_1
    WHEN l.depth = 1+4 THEN identifier_0
    END AS c4,
/**/
    CASE
    WHEN l.depth = 1+5 THEN identifier_0
    END AS c5
FROM leaves AS l"	READY
10	2015-04-24 18:17:11	"638184485"	true	2015-04-24 18:17:11	views.deskcom_cases		"CREATE view views.deskcom_cases
as 
SELECT Deskcom__Account__c,Name,Deskcom__created_at__c 
FROM salesforce.Deskcom__Case__c"	READY
23	2015-04-24 18:17:15	"1112787633"	true	2015-04-24 18:17:15	ml.attribute_season		"CREATE VIEW ml.attribute_season AS
SELECT
    a.id AS attribute_id,
    a.identifier AS attribute_identifier
FROM postgres.attribute AS a
LEFT JOIN postgres.property AS p
    ON p.id = a.property_id
WHERE p.id = 2031418
ORDER BY a.id ASC"	READY
491,522	2015-08-10 15:24:01	"1141300582"	true	2015-08-10 15:24:01	desk_com_connector_example.example_show_article		CREATE view desk_com_connector_example.example_show_article as 
select * from (call "desk_com_connector.show_article"(
    "in_article_id" => '1947938')
)ss	READY
14	2015-04-24 18:17:12	"1112787628"	true	2015-04-24 18:17:12	views.supplier		"CREATE view views.supplier 
AS 
SELECT 
	su.id,
	su.version,
	su.""name"",
	su.active,
	su.address_id,
	su.contact_person,
	su.cross_docking,
	su.date_created,
	su.fax_number,
	su.last_updated,
	su.phone_number,
	su.address_city,
	su.address_co,
	su.address_country,
	su.address_street,
	su.address_street_number,
	su.address_zip,
	su.address_first_name,
	su.address_last_name,
	su.address_salutation,
	su.address_active,
	su.address_default_address
FROM postgres.supplier su"	READY
24	2015-04-24 18:17:15	"1112787634"	true	2015-04-24 18:17:15	raw.purchase_order_articles		"CREATE VIEW raw.purchase_order_articles AS

SELECT
/* IDENTIFIERS AND STATUSES */
	CAST(pop.id AS LONG) AS poa_id,
	CAST(pop.purchase_order_id AS LONG) AS purchase_order_id,
	CAST(pop.order_position_id AS LONG) AS order_position_id,
	CAST(pop.purchase_order_positions_idx AS SHORT) AS poa_position_number,
	pop.supplier_order_number AS poa_supplier_order_number,
	CAST(pop.article_id AS LONG) AS article_id,
	a.ean AS article_ean,
	CAST(pop.state AS SHORT) AS poa_state_number,
	
/* DATES */
	CAST(pop.date_created AS TIMESTAMP) AS date_poa_created,
	CAST(pop.date_canceled AS TIMESTAMP) AS date_poa_cancelled,
	CAST(pop.date_fulfilled AS TIMESTAMP) AS date_poa_fulfilled,
	pop.last_updated AS date_poa_updated,
	CAST(pop.earliest_delivery_date AS DATE) AS date_poa_delivery_earliest,
	CAST(pop.latest_delivery_date AS DATE) AS date_poa_delivery_latest,

/* QUANTITIES */	
	CAST(pop.initial_quantity AS INTEGER) AS stock_ordered_initially,
	CAST(pop.quantity AS INTEGER) AS stock_ordered_revised,
	CAST(pop.fulfilled_quantity AS INTEGER) AS stock_fulfilled,

/* OTHER */
	pop.retail_price AS article_sales_price,
	pop.purchase_price AS article_cost

FROM 
	postgres.purchase_order_position pop
	LEFT JOIN
	postgres.article a
		 ON pop.article_id = a.id
		 
/* TO ELIMINATE SOME OF THE DUP ARTICLES IN AN ORDER
WHERE  
	   pop.initial_quantity 	!= 0
	OR pop.quantity 			!= 0
	OR pop.fulfilled_quantity 	!= 0
*/"	READY
27	2015-04-24 18:17:16	"1112787637"	true	2015-04-24 18:17:16	raw.customer_order_articles		"CREATE VIEW raw.customer_order_articles
as
SELECT 
	op.id as order_position_id,
	op.order_id,
	op.group_id,
	op.order_id || '_' || op.group_id as outfit_id,
	op.article_id,
	op.stock_location_id,
	op.supplier_article_id,
	op.supplier_order_number,
	op.track_and_trace_number,
	op.order_positions_idx as order_position_count,
	CASE 
		WHEN co.state = 2048 THEN 'Cancelled'
		WHEN op.state = 8 THEN 'Placed'
		WHEN op.state >= 16  AND op.state < 128 THEN 'Packing'    /*WHEN op.state = 32 THEN 'Stocked' WHEN op.state = 64 THEN 'Placed'*/
		WHEN op.state >= 128 AND op.state < 512 THEN 'Sent'       /*WHEN op.state = 256 THEN 'Arrived' WHEN op.state = 384 THEN 'Returned Online'*/
		WHEN op.state = 512 THEN 'Returned'
		WHEN op.state = 1024 THEN 'Kept'
		WHEN op.state = 1536 THEN 'Lost'
		WHEN op.state = 2048 THEN 'Cancelled'
		ELSE 'Unknown'
	END as order_article_state,
	op.state as order_article_state_number,
	CASE WHEN NOT (op.retail_price = 0 AND sa.article_id is not null) AND op.state >= 16 AND op.state < 2048 THEN op.quantity ELSE null END as articles_picked,
	CASE WHEN NOT (op.retail_price = 0 AND sa.article_id is not null) AND op.state >= 128 AND op.state < 2048 THEN op.quantity ELSE null END as articles_sent,
	CASE WHEN NOT (op.retail_price = 0 AND sa.article_id is not null) AND op.state = 1024 THEN op.quantity ELSE null END as articles_kept,
	CASE WHEN NOT (op.retail_price = 0 AND sa.article_id is not null) AND op.state = 512  THEN op.quantity ELSE null END as articles_returned,
	CASE WHEN NOT (op.retail_price = 0 AND sa.article_id is not null) AND op.state = 1536 THEN op.quantity ELSE null END as articles_lost,
	op.retail_price as sales_in_local_currency,  /* In local currency */
	op.purchase_price as cost,  /* In EUR */
	op.date_created,
	op.date_picked,
	op.date_canceled as date_cancelled,
	op.date_returned,
	op.date_shipped,
	op.date_incoming,
	op.date_returned_online,
	op.date_lost, 
	feedback_case.feedback_good_colour,
	feedback_case.feedback_good_quality,
	feedback_case.feedback_good_match_to_customers_style,
	feedback_case.feedback_dont_like_style,
	feedback_case.feedback_good_fit,	
	feedback_case.feedback_bad_fit,
	feedback_case.feedback_too_big,
	feedback_case.feedback_too_small,
	feedback_case.feedback_too_short,
	feedback_case.feedback_too_long,
	feedback_case.feedback_too_tight,
	feedback_case.feedback_too_wide,
	feedback_case.feedback_too_outrageous,
	feedback_case.feedback_too_simple,
	feedback_case.feedback_too_cheap,
	feedback_case.feedback_too_expensive,
	feedback_case.feedback_too_low_quality,
	feedback_case.feedback_dont_like_the_brand,
	feedback_case.feedback_dont_like_the_pattern,
	feedback_case.feedback_dont_like_the_colour,
	feedback_case.feedback_not_needed,
	feedback_case.feedback_would_like_to_try_something_new,	
	feedback_case.feedback_damaged,
	feedback_case.feedback_was_dirty,
	feedback_case.feedback_late_delivery,	
	feedback_case.feedback_fraud,
	cm.feedback_comment	
FROM postgres.order_position op
JOIN postgres.customer_order co on co.id = op.order_id
/* Need to join to supplier article to check if articles are gifts. It needs to be a subselect due to duplicates in the table */
LEFT JOIN (
	SELECT
		sa.article_id
	FROM postgres.supplier_article sa 
	WHERE sa.supplier_id = 15
	GROUP BY sa.article_id
) sa on sa.article_id = op.article_id
LEFT JOIN (
	SELECT 
		ddr.original_orderid as order_id, 
		ddr.outfittery_article_number as article_id, 
		LOWER(MAX(ddr.comment)) as feedback_comment
	FROM postgres.doc_data_return ddr
	WHERE ddr.comment is not null 
	AND ddr.comment != ''
	GROUP BY 1,2
 	) cm ON op.order_id = cm.order_id AND op.article_id = cm.article_id
LEFT JOIN (
	SELECT
		fd.order_position_id,
		/* NOTE: Feedback reasons are ordered by feedback_reason_id here to make it easier to compare to postgres.feedback_reason */
		MAX(CASE WHEN fd.feedback_reason_id = '380476' THEN 1 ELSE null END)  as feedback_dont_like_the_brand,
		MAX(CASE WHEN fd.feedback_reason_id in ('380477', '1426276') THEN 1 ELSE null END) as feedback_too_big,
		MAX(CASE WHEN fd.feedback_reason_id in ('380478', '1426275') THEN 1 ELSE null END) as feedback_too_small,
		MAX(CASE WHEN fd.feedback_reason_id = '380479' THEN 1 ELSE null END)  as feedback_too_expensive,
		MAX(CASE WHEN fd.feedback_reason_id = '380482' THEN 1 ELSE null END)  as feedback_not_needed,
		MAX(CASE WHEN fd.feedback_reason_id = '380483' THEN 1 ELSE null END)  as feedback_damaged,
		MAX(CASE WHEN fd.feedback_reason_id = '412965' THEN 1 ELSE null END)  as feedback_late_delivery,
		MAX(CASE WHEN fd.feedback_reason_id in ('412966', '1426274') THEN 1 ELSE null END) as feedback_too_long,
		MAX(CASE WHEN fd.feedback_reason_id in ('412967', '1426277') THEN 1 ELSE null END) as feedback_too_short,
		MAX(CASE WHEN fd.feedback_reason_id in ('412968', '1426273') THEN 1 ELSE null END) as feedback_too_tight,
		MAX(CASE WHEN fd.feedback_reason_id in ('412969', '1426272') THEN 1 ELSE null END) as feedback_too_wide,
		MAX(CASE WHEN fd.feedback_reason_id = '539682' THEN 1 ELSE null END)  as feedback_too_simple,
		MAX(CASE WHEN fd.feedback_reason_id = '1126870' THEN 1 ELSE null END) as feedback_too_cheap,
		MAX(CASE WHEN fd.feedback_reason_id = '1295094' THEN 1 ELSE null END) as feedback_good_colour,
		MAX(CASE WHEN fd.feedback_reason_id = '1295097' THEN 1 ELSE null END) as feedback_good_fit,
		MAX(CASE WHEN fd.feedback_reason_id = '1295099' THEN 1 ELSE null END) as feedback_good_match_to_customers_style,
		MAX(CASE WHEN fd.feedback_reason_id = '1295102' THEN 1 ELSE null END) as feedback_good_quality,
		MAX(CASE WHEN fd.feedback_reason_id = '1295105' THEN 1 ELSE null END) as feedback_would_like_to_try_something_new,
		MAX(CASE WHEN fd.feedback_reason_id = '1296049' THEN 1 ELSE null END) as feedback_too_outrageous,
		MAX(CASE WHEN fd.feedback_reason_id = '1296060' THEN 1 ELSE null END) as feedback_too_low_quality,
		MAX(CASE WHEN fd.feedback_reason_id = '1361878' THEN 1 ELSE null END) as feedback_dont_like_style,
		/* These are merged into the original feedbacks as they are no longer really used
		MAX(CASE WHEN fd.feedback_reason_id = '1426272' THEN 1 ELSE null END) as feedback_too_wide_reorder,
		MAX(CASE WHEN fd.feedback_reason_id = '1426273' THEN 1 ELSE null END) as feedback_too_tight_reorder,
		MAX(CASE WHEN fd.feedback_reason_id = '1426274' THEN 1 ELSE null END) as feedback_too_long_reorder,
		MAX(CASE WHEN fd.feedback_reason_id = '1426275' THEN 1 ELSE null END) as feedback_too_small_reorder,
		MAX(CASE WHEN fd.feedback_reason_id = '1426276' THEN 1 ELSE null END) as feedback_too_big_reorder,
		MAX(CASE WHEN fd.feedback_reason_id = '1426277' THEN 1 ELSE null END) as feedback_too_short_reorder,
		*/
		MAX(CASE WHEN fd.feedback_reason_id = '1426279' THEN 1 ELSE null END) as feedback_was_dirty,
		MAX(CASE WHEN fd.feedback_reason_id = '1426280' THEN 1 ELSE null END) as feedback_fraud,
		MAX(CASE WHEN fd.feedback_reason_id = '1427266' THEN 1 ELSE null END) as feedback_dont_like_the_colour,
		MAX(CASE WHEN fd.feedback_reason_id = '1539154' THEN 1 ELSE null END) as feedback_dont_like_the_pattern,
		MAX(CASE WHEN fd.feedback_reason_id = '1539155' THEN 1 ELSE null END) as feedback_bad_fit
	FROM postgres.feedback fd
	WHERE fd.order_position_id is not null
	GROUP BY fd.order_position_id 
) feedback_case on feedback_case.order_position_id = op.id"	READY
41	2015-04-24 18:17:20	"1112787639"	true	2015-04-24 18:17:20	views.article		"CREATE VIEW views.article
AS
SELECT 
	a.id as article_id,
	sa.id as supplier_article_id,
	sa.article_id as  supplier_article_article_id,
	sa.sku as supplier_article_sku,
	sa.supplier_id as supplier_id,
	s.""name"" as supplier_name ,
	sa.active as supplier_article_active,
	sa.ean as supplier_article_ean,
	sa.image_url as supplier_article_image_url,
	sa.partner_shop_url as ""supplier_article_partner_shop_url"",
	sa.manufacturer_sku as supplier_article_manufacturer_sku,
	sa.date_created as ""supplier_article_date_created"",
	sa.last_updated as ""supplier_article_last_updated"",
	sa.retail_price as ""supplier_article_retail_price"",
	sa.purchase_price as ""supplier_article_purchase_price"",
	cast(a.description as varchar(4000)) as ""article_description"",
	a.title as article_title,
	case when b.name is not null then b.name else a.brand end as article_brand,
	a.color as article_color,
	a.""size"" as article_size,
	a.sku as article_sku,
	a.date_created as ""article_date_created"",
	a.last_updated as ""aarticle_last_updated"",
	a.country_of_origin as article_country_of_origin,
	a.del as ""article_del"",
	a.weight as article_weight,
	a.ean as article_ean,
	a.model_id as article_model_id,
	a.manufacturer_color_code as article_manufacturer_color_code,
	a.manufacturer_color_name as article_manufacturer_color_name,
	a.manufacturer_sku as article_manufacturer_sku,
	a.manufacturer_alternative_sku as article_manufacturer_alternative_sku,
	a.manufacturer_size as article_manufacturer_size,
	prices.retail_min_price_NL,
	prices.retail_max_price_NL,
	prices.retail_min_price_DE,
	prices.retail_max_price_DE,
	prices.retail_min_price_AT,
	prices.retail_max_price_AT,
	prices.retail_min_price_CH,
	prices.retail_max_price_CH,
	prices.retail_min_price_SE,
	prices.retail_max_price_SE,
	prices.retail_min_price_DK,
	prices.retail_max_price_DK,
	CASE WHEN cg1.title_de is not null THEN cg1.title_de ELSE ad.commodity_group1 END as commodity_group1,
	CASE WHEN cg2.title_de is not null THEN cg2.title_de ELSE ad.commodity_group2 END as commodity_group2,
	CASE WHEN cg3.title_de is not null THEN cg3.title_de ELSE ad.commodity_group3 END as commodity_group3,
	CASE WHEN cg4.title_de is not null THEN cg4.title_de ELSE ad.commodity_group4 END as commodity_group4,
	CASE WHEN cg5.title_de is not null THEN cg5.title_de ELSE ad.commodity_group5 END as commodity_group5,
	ad.commodity_group6,
	left(ad.amidala_categories  ,4000) as amidala_categories  ,
	left(ad.amidala_check  ,4000) as amidala_check  ,
	left(ad.amidala_deactive  ,4000) as amidala_deactive  ,
	left(ad.article_name  ,4000) as article_name  ,
	left(ad.basic_unit  ,4000) as basic_unit  ,
	left(case when b.name is not null then b.name else a.brand  end ,4000) as brand  ,
	left(ad.check_details  ,4000) as check_details  ,
	left(ad.check_fitting  ,4000) as check_fitting  ,
	left(ad.check_material_style_attributes  ,4000) as check_material_style_attributes  ,
	left(ad.check_schulung  ,4000) as check_schulung  ,
	left(ad.color1  ,4000) as color1  ,
	left(ad.color1_shade  ,4000) as color1_shade  ,
	left(ad.country_of_origin  ,4000) as country_of_origin  ,
	left(ad.country_of_production  ,4000) as country_of_production  ,
	left(ad.customs_tariff_number  ,4000) as customs_tariff_number  ,
	left(ad.ean  ,4000) as ean  ,
	left(ad.model_o_id  ,4000) as model_o_id  ,
	left(ad.nos  ,4000) as nos  ,
	left(ad.o_classid  ,4000) as o_classid  ,
	left(ad.o_classname  ,4000) as o_classname  ,
	left(ad.o_creationdate  ,4000) as o_creationdate  ,
	left(ad.o_id  ,4000) as o_id  ,
	left(ad.o_index  ,4000) as o_index  ,
	left(ad.o_key  ,4000) as o_key  ,
	left(ad.o_modificationdate  ,4000) as o_modificationdate  ,
	left(ad.o_parentid  ,4000) as o_parentid  ,
	left(ad.o_path  ,4000) as o_path  ,
	left(ad.o_published  ,4000) as o_published  ,
	left(ad.o_type  ,4000) as o_type  ,
	left(ad.o_usermodification  ,4000) as o_usermodification  ,
	left(ad.o_userowner  ,4000) as o_userowner  ,
	left(ad.oo_classid  ,4000) as oo_classid  ,
	left(ad.oo_classname  ,4000) as oo_classname  ,
	left(ad.oo_id  ,4000) as oo_id  ,
	left(ad.pic1  ,4000) as pic1  ,
	left(ad.pic2  ,4000) as pic2  ,
	left(ad.pic3 ,4000) as pic3 ,
	left(ad.pic4  ,4000) as pic4  ,
	left(ad.pic5  ,4000) as pic5  ,
	left(ad.price_retail_at  ,4000) as price_retail_at  ,
	left(ad.price_retail_ch  ,4000) as price_retail_ch  ,
	left(ad.price_retail_de  ,4000) as price_retail_de  ,
	left(ad.processing_code  ,4000) as processing_code  ,
	left(ad.purchase_price  ,4000) as purchase_price  ,
	left(ad.season  ,4000) as season  ,
	left(ad.supplier_article_name  ,4000) as supplier_article_name  ,
	left(ad.supplier_color_code  ,4000) as supplier_color_code  ,
	left(ad.supplier_color_name  ,4000) as supplier_color_name  ,
	left(ad.supplier_finish  ,4000) as supplier_finish  ,
	left(ad.supplier_length  ,4000) as supplier_length  ,
	left(ad.supplier_size  ,4000) as supplier_size  ,
	left(ad.supplier_sku  ,4000) as supplier_sku  ,
	left(ad.net_weight  ,4000) as net_weight  ,
	left(ad.special_charakteristics_accessories  ,4000) as special_charakteristics_accessories  ,
	left(ad.gross_weight  ,4000) as gross_weight  ,
	left(ad.buyer  ,4000) as buyer  ,
	left(ad.FittingHoselenght_pants,4000) as ""F_Hose_lenght_pants"",
	left(ad.FittingHosefit,4000) as ""F_Hose_fit"",
	left(ad.FittingHosewaist_line,4000) as ""F_Hose_waist_line"",
	left(ad.FittingHosecrotch,4000) as ""F_Hose_crotch"",
	left(ad.FittingHosefitting_trousers,4000) as ""F_Hose_fitting_trousers"",
	left(ad.FittingHosefitting_extras,4000) as ""F_Hose_fitting_extras"",
	left(ad.FittingHosefitting_normalizer,4000) as ""F_Hose_fitting_normalizer"",
	left(ad.FittingKonfektionfit,4000) as ""F_Konfektion_fit"",
	left(ad.FittingKonfektionblazer_length,4000) as ""F_Konfektion_blazer_length"",
	left(ad.FittingKonfektionfitting_trousers,4000) as ""F_Konfektion_fitting_trousers"",
	left(ad.FittingKonfektionfitting_extras,4000) as ""F_Konfektion_fitting_extras"",
	left(ad.FittingKonfektionfitting_normalizer,4000) as ""F_Konfektion_fitting_normalizer"",
	left(ad.FittingKonfektionfitting_top,4000) as ""F_Konfektion_fitting_top"",
	left(ad.FittingKonfektionwaist_line,4000) as ""F_Konfektion_waist_line"",
	left(ad.FittingOberteilsleeve_length,4000) as ""F_Oberteil_sleeve_length"",
	left(ad.FittingOberteilfit,4000) as ""F_Oberteil_fit"",
	left(ad.FittingOberteilfitting_top,4000) as ""F_Oberteil_fitting_top"",
	left(ad.FittingOberteilfitting_extras,4000) as ""F_Oberteil_fitting_extras"",
	left(ad.FittingOberteilfitting_normalizer,4000) as ""F_Oberteil_fitting_normalizer"",
	left(ad.FittingOberteillenght_top,4000) as ""F_Oberteil_lenght_top"",
	left(ad.FittingOberteilwidth_top,4000) as ""F_Oberteil_width_top"",
	left(ad.FittingOutdoorfit,4000) as ""F_Outdoor_fit"",
	left(ad.FittingOutdoorlength_coat,4000) as ""F_Outdoor_length_coat"",
	left(ad.FittingOutdoorfitting_extras,4000) as ""F_Outdoor_fitting_extras"",
	left(ad.FittingOutdoorfitting_normalizer,4000) as ""F_Outdoor_fitting_normalizer"",
	left(ad.FittingOutdoorfitting_top,4000) as ""F_Outdoor_fitting_top"",
	left(ad.FittingSchuhwidth_shoes,4000) as ""F_Schuh_width_shoes"",
	left(ad.FittingSchuhfitting_shoes,4000) as ""F_Schuh_fitting_shoes"",
	left(ad.FittingSchuhfitting_normalizer,4000) as ""F_Schuh_fitting_normalizer"",
	left(ad.FittingSchuhfitting_extras,4000) as ""F_Schuh_fitting_extras"",
	left(ad.DetailsGuertelbelt_width_cm,4000) as ""D_Guertel_belt_width_cm"",
	left(ad.DetailsGuertelclosure_accessories,4000) as ""D_Guertel_closure_accessories"",
	left(ad.DetailsGuertelspecial_charakteristics_accessories,4000) as ""D_Guertel_special_charakteristics_accessories"",
	left(ad.DetailsGuerteldetails,4000) as ""D_Guertel_details"",
	left(ad.DetailsHandschuhelenght_cm,4000) as ""D_Handschuhe_lenght_cm"",
	left(ad.DetailsHandschuheclosure_accessories,4000) as ""D_Handschuhe_closure_accessories"",
	left(ad.DetailsHandschuhespecial_charakteristics_accessories,4000) as ""D_Handschuhe_special_charakteristics_accessories"",
	left(ad.DetailsHandschuhedetails,4000) as ""D_Handschuhe_details"",
	left(ad.DetailsHoseclosure_trousers,4000) as ""D_Hose_closure_trousers"",
	left(ad.DetailsHosetrousers_pocket,4000) as ""D_Hose_trousers_pocket"",
	left(ad.DetailsHosecrease,4000) as ""D_Hose_crease"",
	left(ad.DetailsHosetuck,4000) as ""D_Hose_tuck"",
	left(ad.DetailsHosespecial_attributes_trousers,4000) as ""D_Hose_special_attributes_trousers"",
	left(ad.DetailsHosedetails,4000) as ""D_Hose_details"",
	left(ad.DetailsKonfektioncollar,4000) as ""D_Konfektion_collar"",
	left(ad.DetailsKonfektionclosure_tops,4000) as ""D_Konfektion_closure_tops"",
	left(ad.DetailsKonfektionclosure_trousers,4000) as ""D_Konfektion_closure_trousers"",
	left(ad.DetailsKonfektionslit,4000) as ""D_Konfektion_slit"",
	left(ad.DetailsKonfektionpockets_tops,4000) as ""D_Konfektion_pockets_tops"",
	left(ad.DetailsKonfektiontrousers_pocket,4000) as ""D_Konfektion_trousers_pocket"",
	left(ad.DetailsKonfektioncrease,4000)as ""D_Konfektion_crease"",
	left(ad.DetailsKonfektiontuck,4000) as ""D_Konfektion_tuck"",
	left(ad.DetailsKonfektionspecial_attributes_tops,4000) as ""D_Konfektion_special_attributes_tops"",
	left(ad.DetailsKonfektionspecial_attributes_trousers,4000) as ""D_Konfektion_special_attributes_trousers"",
	left(ad.DetailsKonfektiondetails,4000) as ""D_Konfektion_details"",
	left(ad.DetailsKopfaccessoirescircumference_cm,4000) as ""D_Kopfaccessoires_circumference_cm"",
	left(ad.DetailsKopfaccessoiresclosure_accessories,4000) as ""D_Kopfaccessoires_closure_accessories"",
	left(ad.DetailsKopfaccessoiresdetails,4000) as ""D_Kopfaccessoires_details"",
	left(ad.DetailsKrawatteFliegelenght_cm ,4000)as ""D_Krawatte_Fliege_lenght_cm"",
	left(ad.DetailsKrawatteFliegewidth_cm ,4000)as ""D_Krawatte_Fliege_width_cm"",
	left(ad.DetailsKrawatteFliegespecial_charakteristics_accessories ,4000)as ""D_Krawatte_Fliege_special_charakteristics_accessories"",
	left(ad.DetailsKrawatteFliegedetails ,4000)as ""D_Krawatte_Fliege_details"",
	left(ad.DetailsOberteiltype_print,4000) as ""D_Oberteil_type_print"",
	left(ad.DetailsOberteilclosure_tops,4000) as ""D_Oberteil_closure_tops"",
	left(ad.DetailsOberteilpockets_tops,4000) as ""D_Oberteil_pockets_tops"",
	left(ad.DetailsOberteilcollar,4000) as ""D_Oberteil_collar"",
	left(ad.DetailsOberteilhood,4000) as ""D_Oberteil_hood"",
	left(ad.DetailsOberteilslit,4000) as ""D_Oberteil_slit"",
	left(ad.DetailsOberteilspecial_attributes_tops,4000) as ""D_Oberteil_special_attributes_tops"",
	left(ad.DetailsOberteildetails,4000) as ""D_Oberteil_details"",
	left(ad.DetailsOberteilquality_print,4000) as ""D_Oberteil_quality_print"",
	left(ad.DetailsOutdoorclosure_tops,4000) as ""D_Outdoor_closure_tops"",
	left(ad.DetailsOutdoorcollar,4000) as ""D_Outdoor_collar"",
	left(ad.DetailsOutdoorslit,4000) as ""D_Outdoor_slit"",
	left(ad.DetailsOutdoorhood,4000) as ""D_Outdoor_hood"",
	left(ad.DetailsOutdoorpockets_tops,4000) as ""D_Outdoor_pockets_tops"",
	left(ad.DetailsOutdoorspecial_attributes_tops,4000) as ""D_Outdoor_special_attributes_tops"",
	left(ad.DetailsOutdoordetails,4000) as ""D_Outdoor_details"",
	left(ad.DetailsSchuhtoe_shoes,4000) as ""D_Schuh_toe_shoes"",
	left(ad.DetailsSchuhclosure_shoes,4000) as ""D_Schuh_closure_shoes"",
	left(ad.DetailsSchuhheight_upper_cm,4000) as ""D_Schuh_height_upper_cm"",
	left(ad.DetailsSchuhwidth_upper_cm,4000) as ""D_Schuh_width_upper_cm"",
	left(ad.DetailsSchuhheight_heel_cm,4000) as ""D_Schuh_height_heel_cm"",
	left(ad.DetailsSchuhheel,4000) as ""D_Schuh_heel"",
	left(ad.DetailsSchuhfootbed,4000) as ""D_Schuh_footbed"",
	left(ad.DetailsSchuhspecial_attributes_shoes,4000) as ""D_Schuh_special_attributes_shoes"",
	left(ad.DetailsSchuhdetails,4000) as ""D_Schuh_details"",
	left(ad.DetailsSockendetails,4000)as ""DetailsSocken_details"",
	left(ad.DetailsTuecherSchallenght_cm ,4000)as ""D_Tuecher_Schal_lenght_cm"",
	left(ad.DetailsTuecherSchalwidth_cm ,4000)as ""D_Tuecher_Schal_width_cm"",
	left(ad.DetailsTuecherSchaldiameter_cm ,4000)as ""D_Tuecher_Schal_diameter_cm"",
	left(ad.DetailsTuecherSchalspecial_charakteristics_accessories ,4000)as ""D_Tuecher_Schal_special_charakteristics_accessories"",
	left(ad.DetailsTuecherSchaldetails ,4000)as ""D_Tuecher_Schal_details"",
	left(ad.DetailsUnterhosespecial_characteristics_underwear,4000) as ""D_Unterhose_special_characteristics_underwear"",
	left(ad.DetailsUnterhosedetails,4000) as ""D_Unterhose_details"",
	left(ad.MaterialStyleAccessoiresGuertelpercentage1_upper_fabric,4000) as ""MStyle_Accessoires_Guertel_percentage1_upper_fabric"",
	left(ad.MaterialStyleAccessoiresGuertelupper_fabric_share1,4000) as ""MStyle_Accessoires_Guertel_upper_fabric_share1"",
	left(ad.MaterialStyleAccessoiresGuertelpattern,4000) as ""MStyle_Accessoires_Guertel_pattern"",
	left(ad.MaterialStyleAccessoiresGuertelfinish_metal,4000) as ""MStyle_Accessoires_Guertel_finish_metal"",
	left(ad.MaterialStyleAccessoiresGuertelquality_upper_fabric,4000) as ""MStyle_Accessoires_Guertel_quality_upper_fabric"",
	left(ad.MaterialStyleAccessoiresGuertelquality_finishing,4000) as ""MStyle_Accessoires_Guertel_quality_finishing"",
	left(ad.MaterialStyleAccessoiresGuerteloutfittery_occasion,4000)as ""MStyle_Accessoires_Guertel_outfittery_occasion"",
	left(ad.MaterialStyleAccessoiresGuerteloutfittery_style,4000) as ""MStyle_Accessoires_Guertel_outfittery_style"",
	left(ad.MaterialStyleAccessoiresGuertelpercentage2_upper_fabric,4000) as ""MStyle_Accessoires_Guertel_percentage2_upper_fabric"",
	left(ad.MaterialStyleAccessoiresGuertelupper_fabric_share2,4000) as ""MStyle_Accessoires_Guertel_upper_fabric_share2"",
	left(ad.MaterialStyleAccessoiresTextilpercentage1_upper_fabric,4000) as ""MStyle_Accessoires_Textil_percentage1_upper_fabric"",
	left(ad.MaterialStyleAccessoiresTextilpercentage2_upper_fabric,4000) as ""MStyle_Accessoires_Textil_percentage2_upper_fabric"",
	left(ad.MaterialStyleAccessoiresTextilupper_fabric_share2,4000) as ""MStyle_Accessoires_Textil_upper_fabric_share2"",
	left(ad.MaterialStyleAccessoiresTextilpercentage1_material_lining,4000) as ""MStyle_Accessoires_Textil_percentage1_material_lining"",
	left(ad.MaterialStyleAccessoiresTextilmaterial_lining_share1,4000) as ""MStyle_Accessoires_Textil_material_lining_share1"",
	left(ad.MaterialStyleAccessoiresTextilmaterialname_fabric_upper,4000) as ""MStyle_Accessoires_Textil_materialname_fabric_upper"",
	left(ad.MaterialStyleAccessoiresTextilcare_instructions,4000) as ""MStyle_Accessoires_Textil_care_instructions"",
	left(ad.MaterialStyleAccessoiresTextilproduction_information,4000) as ""MStyle_Accessoires_Textil_production_information"",
	left(ad.MaterialStyleAccessoiresTextilpattern,4000) as ""MStyle_Accessoires_Textil_pattern"",
	left(ad.MaterialStyleAccessoiresTextilfineness_of_material,4000) as ""MStyle_Accessoires_Textil_fineness_of_material"",
	left(ad.MaterialStyleAccessoiresTextilfinish_textile,4000) as ""MStyle_Accessoires_Textil_finish_textile"",
	left(ad.MaterialStyleAccessoiresTextilquality_upper_fabric,4000) as ""MStyle_Accessoires_Textil_quality_upper_fabric"",
	left(ad.MaterialStyleAccessoiresTextilquality_finishing,4000) as ""MStyle_Accessoires_Textil_quality_finishing"",
	left(ad.MaterialStyleAccessoiresTextiloutfittery_style,4000) as ""MStyle_Accessoires_Textil_outfittery_style"",
	left(ad.MaterialStyleAccessoiresTextiloutfittery_occasion ,4000)as ""MStyle_Accessoires_Textil_outfittery_occasion"",
	left(ad.MaterialStyleAccessoiresTextilupper_fabric_share1,4000) as ""MStyle_Accessoires_Textil_upper_fabric_share1"",
	left(ad.MaterialStyleAccessoiresTextilpercentage3_upper_fabric,4000) as ""MStyle_Accessoires_Textil_percentage3_upper_fabric"",
	left(ad.MaterialStyleAccessoiresTextilupper_fabric_share3,4000) as ""MStyle_Accessoires_Textil_upper_fabric_share3"",
	left(ad.MaterialStyleAccessoiresTextilpercentage2_material_lining,4000) as ""MStyle_Accessoires_Textil_percentage2_material_lining"",
	left(ad.MaterialStyleAccessoiresTextilmaterial_lining_share2,4000) as ""MStyle_Accessoires_Textil_material_lining_share2"",
	left(ad.MaterialStyleAccessoiresTextiloutfittery_upper_fabric,4000) as ""MStyle_Accessoires_Textil_outfittery_upper_fabric"",
	left(ad.MaterialStyleAccessoiresTextillining_textile,4000) as ""MStyle_Accessoires_Textil_lining_textile"",
	left(ad.MaterialStyleBekleidungpattern,4000) as ""MStyle_Bekleidung_pattern"",
	left(ad.MaterialStyleBekleidungcare_instructions,4000) as ""MStyle_Bekleidung_care_instructions"",
	left(ad.MaterialStyleBekleidungproduction_information,4000) as ""MStyle_Bekleidung_production_information"",
	left(ad.MaterialStyleBekleidunglining_textile,4000) as ""MStyle_Bekleidung_lining_textile"",
	left(ad.MaterialStyleBekleidungmaterialname_fabric_upper,4000) as ""MStyle_Bekleidung_materialname_fabric_upper"",
	left(ad.MaterialStyleBekleidungoutfittery_upper_fabric,4000) as ""MStyle_Bekleidung_outfittery_upper_fabric"",
	left(ad.MaterialStyleBekleidungfineness_of_material,4000) as ""MStyle_Bekleidung_fineness_of_material"",
	left(ad.MaterialStyleBekleidungquality_upper_fabric,4000) as ""MStyle_Bekleidung_quality_upper_fabric"",
	left(ad.MaterialStyleBekleidungquality_finishing,4000) as ""MStyle_Bekleidung_quality_finishing"",
	left(ad.MaterialStyleBekleidungfinish_textile,4000) as ""MStyle_Bekleidung_finish_textile"",
	left(ad.MaterialStyleBekleidungelasticity ,4000)as ""MStyle_Bekleidung_elasticity"",
	left(ad.MaterialStyleBekleidungoutfittery_style,4000) as ""MStyle_Bekleidung_outfittery_style"",
	left(ad.MaterialStyleBekleidungoutfittery_occasion,4000) as ""MStyle_Bekleidung_outfittery_occasion"",
	left(ad.MaterialStyleBekleidungupper_fabric_share1,4000) as ""MStyle_Bekleidung_upper_fabric_share1"",
	left(ad.MaterialStyleBekleidungpercentage1_upper_fabric,4000) as ""MStyle_Bekleidung_percentage1_upper_fabric"",
	left(ad.MaterialStyleBekleidungpercentage2_upper_fabric,4000) as ""MStyle_Bekleidung_percentage2_upper_fabric"",
	left(ad.MaterialStyleBekleidungupper_fabric_share2,4000) as ""MStyle_Bekleidung_upper_fabric_share2"",
	left(ad.MaterialStyleBekleidungmaterial_lining_share1,4000) as ""MStyle_Bekleidung_material_lining_share1"",
	left(ad.MaterialStyleBekleidungpercentage1_material_lining,4000) as ""MStyle_Bekleidung_percentage1_material_lining"",
	left(ad.MaterialStyleBekleidungpercentage3_upper_fabric,4000) as ""MStyle_Bekleidung_percentage3_upper_fabric"",
	left(ad.MaterialStyleBekleidungupper_fabric_share3,4000) as ""MStyle_Bekleidung_upper_fabric_share3"",
	left(ad.MaterialStyleBekleidungpercentage2_material_lining,4000) as ""MStyle_Bekleidung_percentage2_material_lining"",
	left(ad.MaterialStyleBekleidungmaterial_lining_share2,4000) as ""MStyle_Bekleidung_material_lining_share2"",
	left(ad.MaterialStyleBekleidungpercentage4_upper_fabric,4000) as ""MStyle_Bekleidung_percentage4_upper_fabric"",
	left(ad.MaterialStyleBekleidungupper_fabric_share4,4000) as ""MStyle_Bekleidung_upper_fabric_share4"",
	left(ad.MaterialStyleSchuheupper_material_shoes,4000) as ""MStyle_Schuhe_upper_material_shoes"",
	left(ad.MaterialStyleSchuhelining_shoes,4000) as ""MStyle_Schuhe_lining_shoes"",
	left(ad.MaterialStyleSchuheinnersole_shoes,4000) as ""MStyle_Schuhe_innersole_shoes"",
	left(ad.MaterialStyleSchuhesoletype_shoes,4000) as ""MStyle_Schuhe_soletype_shoes"",
	left(ad.MaterialStyleSchuhepattern,4000) as ""MStyle_Schuhe_pattern"",
	left(ad.MaterialStyleSchuhefinish_leather,4000) as ""MStyle_Schuhe_finish_leather"",
	left(ad.MaterialStyleSchuhequality_finishing,4000) as ""MStyle_Schuhe_quality_finishing"",
	left(ad.MaterialStyleSchuheoutfittery_style,4000) as ""MStyle_Schuhe_outfittery_style"",
	left(ad.MaterialStyleSchuheoutfittery_occasion,4000) as ""MStyle_Schuhe_outfittery_occasion"",
	left(ad.MaterialStyleSchuheproduction_information,4000) as ""MStyle_Schuhe_production_information"",
	left(ad.MaterialStyleSchuhesole_shoes,4000) as ""MStyle_Schuhe_sole_shoes"",
	left(ad.MaterialStyleSchuheinner_material_shoes,4000) as ""MStyle_Schuhe_inner_material_shoes"",
	left(ad.category_breadcrumbs,4000) as category_breadcrumbs,
	left(ad.category,4000) as category,
	at.""Push Own Stock"",
	se.quantity as current_inventory,
	se.reserved as current_reserved
FROM postgres.supplier_article sa
JOIN postgres.supplier s on s.id=sa.supplier_id
JOIN postgres.article a on sa.article_id=a.id
JOIN postgres.article_details ad on ad.id=sa.id
LEFT JOIN dwh.brands b on b.name_db = a.brand
LEFT JOIN postgres.stock_entry se on se.sku = sa.article_id AND se.stock_location_id = 2
LEFT JOIN dwh.commodity_group1 cg1 on cg1.commodity_group1 = ad.commodity_group1
LEFT JOIN dwh.commodity_group2 cg2 on cg2.commodity_group2 = ad.commodity_group2
LEFT JOIN dwh.commodity_group3 cg3 on cg3.commodity_group3 = ad.commodity_group3
LEFT JOIN dwh.commodity_group4 cg4 on cg4.commodity_group4 = ad.commodity_group4
LEFT JOIN dwh.commodity_group5 cg5 on cg5.commodity_group5 = ad.commodity_group5
LEFT JOIN
(
	SELECT
	at.article_attributes_id, 
	cast(ar.name as string) as ""Push Own Stock"" 
	FROM postgres.article_attribute at 
	JOIN postgres.attribute ar on ar.id = at.attribute_id 
	WHERE ar.property_id = 60716143	 
	GROUP BY at.article_attributes_id, ar.name
) at on at.article_attributes_id = a.id
LEFT JOIN 
(
	SELECT 
	ap.article_id,
	min(case when ap.iso_country_code = 'NL' then ap.price else null end) as retail_min_price_NL,
	max(case when ap.iso_country_code = 'NL' then ap.price else null end) as retail_max_price_NL,
	min(case when ap.iso_country_code = 'DE' then ap.price else null end) as retail_min_price_DE,
	max(case when ap.iso_country_code = 'DE' then ap.price else null end) as retail_max_price_DE,
	min(case when ap.iso_country_code = 'AT' then ap.price else null end) as retail_min_price_AT,
	max(case when ap.iso_country_code = 'AT' then ap.price else null end) as retail_max_price_AT,
	min(case when ap.iso_country_code = 'CH' then ap.price else null end) as retail_min_price_CH,
	max(case when ap.iso_country_code = 'CH' then ap.price else null end) as retail_max_price_CH,
	min(case when ap.iso_country_code = 'SE' then ap.price else null end) as retail_min_price_SE,
	max(case when ap.iso_country_code = 'SE' then ap.price else null end) as retail_max_price_SE,
	min(case when ap.iso_country_code = 'DK' then ap.price else null end) as retail_min_price_DK,
	max(case when ap.iso_country_code = 'DK' then ap.price else null end) as retail_max_price_DK
	FROM postgres.article_price ap
	GROUP BY ap.article_id
) prices on prices.article_id = a.id

WHERE exists (SELECT 1 from postgres.order_position op WHERE op.supplier_article_id = sa.id)
OR sa.supplier_id = 15"	READY
16	2015-04-24 18:17:13	"638184499"	true	2015-04-24 18:17:13	views.ga_adcosts		"CREATE view views.ga_adcosts
AS
SELECT
	date_created,
	country,
	source,
	medium,
	campaign,
	adcosts
FROM dwh.ga_adcosts"	READY
17	2015-04-24 18:17:13	"638184500"	true	2015-04-24 18:17:13	views.scantemplates		"CREATE view views.scantemplates 
AS
SELECT
	scan.po,
	scan.ean,
	scan.ean_unknown,
	scan.article_overdelivered,
	scan.photo_article,
	scan.hanging,
	scan.added_value,
	parseTimestamp(scan.date_delivered, 'yyyy-MM-dd HH:mm:ss.S' ) AS date_delivered,
	scan.delivery_note,
	parseTimestamp(scan.date_given_to_serviceprovi, 'yyyy-MM-dd HH:mm:ss.S' ) AS date_given_to_serviceprovi,
	parseTimestamp(scan.date_scanned, 'yyyy-MM-dd HH:mm:ss.S' ) AS date_scanned,
	parseTimestamp(date_uploaded, 'yyyy-MM-dd HH:mm:ss.S' ) as date_uploaded
FROM ""dwh.scantemplatestool"" scan"	READY
48	2015-04-24 18:17:21	"1112787646"	true	2015-04-24 18:17:21	raw.discount_campaigns		"CREATE VIEW raw.discount_campaigns 
AS
SELECT
	c.id as campaign_id,
	c.code as discount_code,
	c.campaign_type,
	c.campaign_title,
	c.date_start as date_discount_start,
	c.date_end as date_discount_end,
	c.useable_amount as discount_usable_amount,
	c.currency as discount_currency,	
	c.discount_percentage,
	c.discount_absolute
FROM postgres.campaign c"	READY
29	2015-04-24 18:17:16	"638184538"	true	2015-04-24 18:17:16	views.futuredate		"CREATE view views.futuredate
as
SELECT 
  date_created,
  year(date_created) as ""year"",
  quarter(date_created) as ""quarter"",
  month(date_created) as ""month"",
  monthname(date_created) as ""monthname"",
  week(date_created) as ""week"",
  dayname(date_created) as ""dayname"",
  dayofmonth(date_created) as ""dayofmonth"",
  dayofyear(date_created) as ""dayofyear"",
  case 
    when dayname(date_created) in ('Saturday','Sunday') then 1 
    else 0
  end as weekend,
  case 
    when dayname(date_created)='Saturday' then timestampadd(SQL_TSI_DAY,2,date_created) 
    when dayname(date_created)='Sunday' then timestampadd(SQL_TSI_DAY,1,date_created)
    else date_created 
  end as date_created_exl_weekends,
  case 
    when 
    date_created in
    ( 
      '2013-01-01','2013-03-29','2013-04-01','2013-05-01','2013-05-09','2013-05-20','2013-10-03','2013-12-25','2013-12-26', 
      '2014-01-01','2014-04-18','2014-04-21','2014-05-01','2014-05-29','2014-06-09','2014-10-03','2014-12-25','2014-12-26',
      '2015-01-01','2015-04-03','2015-04-06','2015-05-01','2015-05-14','2015-05-25','2015-10-03','2015-12-25','2015-12-26',
      '2016-01-01','2016-03-25','2016-03-28','2016-05-01','2016-05-05','2016-05-16','2016-10-03','2016-12-25','2016-12-26'
    )then 1 
    else 0 
  end as holiday
FROM dwh.futuredate"	READY
491,523	2015-08-10 15:24:01	"1141300583"	true	2015-08-10 15:24:01	desk_com_connector_example.example_show_translations_article		CREATE view desk_com_connector_example.example_show_translations_article as select
        *
    from
        (
            call "desk_com_connector.show_translations_article" (
                "in_article_id" => '1947938'
                ,"in_locale" => 'en'
            )
        ) dd	READY
89	2015-04-24 18:17:47	"1112787664"	true	2015-04-24 18:17:47	tableau.finance_analyse_credit_card_campaign		"CREATE view tableau.finance_analyse_credit_card_campaign
AS
SELECT 
	co.id,
	co.state,
	co.customer_id,
	co.date_created,
	co.date_shipped,
	co.payment_state,
	co.total_amount_billed_discount,
	co.total_amount_billed_retail_gross,
	co.total_goodwill_credit,
	ship_add.country,
	co.payment_method,
	a.retoure_value,
	ref_no.reference_number,
	ref_no.amount as voucher_amount,
	ref_no.date_created as voucher_date_created,
	ref_no.voucher_type,
	cc.credit_card_number
FROM postgres.customer_order co 
/*Address*/
LEFT JOIN postgres.address ship_add ON ship_add.id=co.shipping_address_id
/*Voucher Type*/
JOIN 
(
	SELECT 
		order_id,
		voucher_type,
		reference_number,
		amount,
		date_created,
		last_updated 
	FROM ""postgres"".""voucher""
) ref_no ON ref_no.order_id=co.id
/*Retour Value*/
LEFT JOIN 
(
	SELECT 
		order_id,
		sum(quantity*retail_price) as retoure_value 
		FROM postgres.order_positiON 
	WHERE state=512 group by 1
)a ON a.order_id=co.id
/*Credit Card Details*/
LEFT JOIN
(
	SELECT 
		customer_id,
		credit_card_number
	FROM ""postgres"".""billing_data""
) cc ON cc.customer_id=co.customer_id
WHERE ref_no.date_created IS NOT NULL"	READY
491,524	2015-08-10 15:24:01	"1141300584"	true	2015-08-10 15:24:01	desk_com_connector_example.example_list_cases		CREATE view desk_com_connector_example.example_list_cases as select
        *
    from
        ( call "desk_com_connector.get_list_cases" ( "dwh_table" => 'dwh.table_list_cases4' ) ) ss	READY
491,525	2015-08-10 15:24:02	"1141300585"	true	2015-08-10 15:24:02	desk_com_connector_example.example_show_case		create view desk_com_connector_example.example_show_case as select
        *
    from
        (
            call "desk_com_connector.show_case" (
                "in_case_id" => '1'
            )
        ) ss	READY
491,526	2015-08-10 15:24:02	"1141300586"	true	2015-08-10 15:24:02	desk_com_connector_example.example_show_case_message		CREATE view desk_com_connector_example.example_show_case_message as select
        *
    from
        (
            call "desk_com_connector.show_case_message" (
                "in_case_id" => '2'
            )
        ) ww	READY
19	2015-04-24 18:17:14	"638184506"	true	2015-04-24 18:17:14	raw.article_detail_pim		"CREATE VIEW raw.article_detail_pim
AS
SELECT
	o.oo_id,
	o.o_parentId as o_parent_id,
	o.sku,
	o.supplier_sku,
	o.alternative_supplier_sku,		
	o.ean,
	o.o_key as ""key"",
	o.buyer,		
	o.supplier_availability,
	o.nos,
	o.season,
	o.season_start,	
	o.brand as brand,
	o.article_name,
	o.supplier_article_name,
	o.o_published as published,	
	o.promotion_item,
	o.core_article,	
	o.push,
	o.reduced,
	o.amidala_deactive,	
	LEFT(CAST(o.amidala_categories AS STRING),4000) AS amidala_categories,
	o.reason_deactive,
	CASE 
		WHEN o.age = 'all' THEN 'all'
		WHEN o.age = 'over_40' THEN 'over 40'
		ELSE 'under 40'
	END as age_group,
	substring(cast(o.style as string), 2, (Length(cast (o.style as string)) -2)) as style,		
	o.commodity_group1,
	o.commodity_group2,
	o.commodity_group3,
	o.commodity_group4,
	o.commodity_group5,
	o.country_of_origin,
	o.country_of_production,
	cast(o.country_block as string) as country_block,	
	o.basic_unit,
	o.color1,
	o.color2,
	o.color3,
	o.color1_shade,	
	o.supplier_color_code,
	o.supplier_color_name,
	
/* Dates */
	FROM_UNIXTIME(cast(o.""date"" as integer)) as pim_date,
	FROM_UNIXTIME(cast(o.o_creationDate as integer)) as date_created,
	FROM_UNIXTIME(cast(o.o_modificationDate as integer)) as date_updated,	
	FROM_UNIXTIME(cast(o.latest_delivery_date as integer)) as date_latest_delivery,
	FROM_UNIXTIME(cast(o.earliest_delivery_date as integer)) as date_earliest_delivery,

/* Prices & Customs */
	o.purchase_price,
	o.price_retail_original,		
	o.price_retail_de,
	o.price_retail_at,
	CASE WHEN o.price_retail_ch is null or o.price_retail_ch=6110209100 THEN null ELSE cast(o.price_retail_ch as double) END as price_retail_ch,
	o.price_retail_benelux,
	o.price_retail_original_benelux,
	o.price_retail_chf,
	o.price_retail_original_chf,
	o.price_retail_dkk,
	o.price_retail_original_dkk,
	o.price_retail_sek,
	o.price_retail_original_sek,
	o.check_tariff_numbers,
	cast(o.additional_levy as string) as additional_levy,
	o.customs_tariff_number,
	case when o.de_customs_tarff_number is null then 0 else cast(o.de_customs_tarff_number as bigint) end as customs_tariff_number_de,
	case when o.ch_customs_tariff_number is null then 0 else cast(o.ch_customs_tariff_number as bigint) end as customs_tariff_number_ch,	

	o.supplier_finish,
	o.pic1,
	o.pic2,
	o.pic3,
	o.pic4,
	o.pic5,	
	o.pic6,	
	o.pic_raw,
	
	o.net_weight,
	o.gross_weight,
	o.net_weight_gram,
	o.gross_weight_gram,	
	o.supplier_size,
	o.eu_size,
	o.supplier_length,
	o.eu_length,

	cast(at.fineness_of_material as string) as accessories_fineness_of_material, 
	cast(at.percentage1_upper_fabric as string) as accessories_percentage_of_fabric_1, 
	cast(at.upper_fabric_share1 as string) as accessories_upper_fabric_1,
	cast(at.percentage2_upper_fabric as string) as accessories_percentage_of_fabric_2,
	cast(at.upper_fabric_share2 as string) as accessories_upper_fabric_2,
	cast(at.percentage3_upper_fabric as string) as accessories_percentage_of_fabric_3,
	cast(at.upper_fabric_share3 as string) as accessories_upper_fabric_3,

	cast(ag.percentage1_upper_fabric as string) as belt_percentage_of_upper_fabric_1,
	cast(ag.upper_fabric_share1 as string) as belt_upper_fabric_1,
	cast(ag.percentage2_upper_fabric as string) as belt_percentage_of_upper_fabric_2,
	cast(ag.upper_fabric_share2 as string) as belt_upper_fabric_2,

	SUBSTRING(cast(ms.upper_material_shoes as varchar), 2,(Length(cast(ms.upper_material_shoes as varchar))-2)) as shoes_upper_material,
	SUBSTRING(cast(ms.inner_material_shoes as varchar), 2,(Length(cast(ms.inner_material_shoes as varchar))-2)) as shoes_inner_material,
	cast(ms.sole_shoes as string) as shoes_sole,
	cast(ms.lining_shoes as string) as soes_lining,

	cast(msb.upper_fabric_share1 as string) as apparel_upper_fabric_1,
	cast(msb.percentage1_upper_fabric as string) as apparel_percentage_of_upper_fabric_1,
	cast(msb.percentage2_upper_fabric as string) as apparel_percentage_of_upper_fabric_2,
	cast(msb.upper_fabric_share2 as string) as apparel_upper_fabric_2,
	cast(msb.upper_fabric_share3 as string) as apparel_upper_fabric_3,
	cast(msb.percentage3_upper_fabric as string) as apparel_percentage_of_upper_fabric_3,

	o.hanging_garments,	
	o.production_textile,
	o.percentage4_upper_fabric,
	o.upper_fabric_share4,
	o.activation_ch,
	o.o_path,
	o.check_material_style_attributes,
	o.check_fitting,
	o.check_schulung,
	o.check_details,
	o.amidala_check,
	o.processing_code
FROM pim.object_17 o
LEFT JOIN pim.object_17 as parent ON parent.o_id = o.o_parentId
LEFT JOIN pim.object_17 as parent_parent ON parent_parent.o_id = parent.o_parentId
LEFT JOIN pim.object_brick_query_MaterialStyleAccessoiresTextil_17 at ON at.o_id = o.o_parentId 
LEFT JOIN pim.object_brick_query_MaterialStyleAccessoiresGuertel_17 ag ON ag.o_id = o.o_parentId
LEFT JOIN pim.object_brick_query_MaterialStyleSchuhe_17 ms on ms.o_id = o.o_parentId
LEFT JOIN pim.object_brick_query_MaterialStyleBekleidung_17 msb on msb.o_id = o.o_parentId"	READY
21	2015-04-24 18:17:15	"1112787631"	true	2015-04-24 18:17:15	ml.attribute_amidala_age		"CREATE VIEW ml.attribute_amidala_age AS
SELECT
    a.id AS attribute_id,
    a.identifier AS attribute_identifier
FROM postgres.attribute AS a
LEFT JOIN postgres.property AS p
    ON p.id = a.property_id
WHERE p.id = 125863535
ORDER BY a.id ASC"	READY
22	2015-04-24 18:17:15	"1112787632"	true	2015-04-24 18:17:15	ml.attribute_outfittery_style		"CREATE VIEW ml.attribute_outfittery_style AS
SELECT
    a.id AS attribute_id,
    a.identifier AS attribute_identifier
FROM postgres.attribute AS a
LEFT JOIN postgres.property AS p
    ON p.id = a.property_id
WHERE p.id = 18792295
ORDER BY a.id ASC"	READY
93	2015-04-24 18:17:48	"1112787666"	true	2015-04-24 18:17:48	tableau.ops_monthly_doc_data_bookings_po_import_result		"CREATE view tableau.ops_monthly_doc_data_bookings_po_import_result
as
SELECT a.outfittery_purchaseid, 
       a.date_created  AS po_import_result_max_date, 
       a.message, 
       a.processing_reason, 
       po.date_created AS po_date_created,
       dpo.doc_data_po_last_updated,
       sm.date_booked
FROM   (SELECT * 
        FROM   (SELECT Row_number() OVER (partition BY outfittery_purchaseid ORDER BY date_created DESC) AS rnum, 
                       outfittery_purchaseid, 
                       date_created, 
                       message, 
                       processing_reason 
                FROM   postgres.doc_data_purchase_order_import_result
                ) a 
        WHERE  rnum = 1
        ) a 
       JOIN postgres.purchase_order po 
       ON a.outfittery_purchaseid = po.id 
       LEFT JOIN	(select
       				outfittery_purchase_orderid,
       				max(last_updated) as doc_data_po_last_updated
       				FROM postgres.doc_data_purchase_order
       				GROUP BY 1
       			) dpo
       ON a.outfittery_purchaseid = dpo.outfittery_purchase_orderid
       LEFT JOIN (select
       			po_number,
       			max(date_created) as date_booked
       			FROM postgres.doc_data_stock_mutation
       			GROUP BY 1
       		) sm
       ON a.outfittery_purchaseid = sm.po_number"	READY
25	2015-04-24 18:17:15	"638184516"	true	2015-04-24 18:17:15	raw.stock_credit_note		"CREATE VIEW raw.stock_credit_note AS

SELECT
	/* po cant be easily converted to LONG, so leaving as string */
	po AS purchase_order_id,
	ean AS article_ean,
	CAST(credit_note_quantity AS INTEGER) AS stock_credit_note_qty,
	credit_note_no As stock_credit_note_no,
	delivery_note AS stock_delivery_note,
	CAST(date_of_receipt AS DATE) AS date_stock_credit_note_receipt,
	CAST(date_processed AS DATE) AS date_stock_credit_note_processed,
	accountant AS stock_credit_note_accountant
FROM
(
	SELECT 
		ROW_NUMBER() OVER (PARTITION BY po, ean ORDER BY date_of_receipt DESC) AS rnum,
		c.*
	FROM
		dwh.creditnoteupload c
) cn
WHERE rnum = 1"	READY
491,527	2015-08-10 15:24:02	"1141300587"	true	2015-08-10 15:24:02	desk_com_connector_example.example_get_list_case_replies		CREATE view desk_com_connector_example.example_get_list_case_replies as 
select
        *
    from
        (
            call "desk_com_connector.get_list_case_replies" (
                "in_case_id" => '606'
            )
        ) ss	READY
491,528	2015-08-10 15:24:03	"1141300588"	true	2015-08-10 15:24:03	desk_com_connector_example.example_get_list_case_attachments		CREATE view "desk_com_connector_example"."example_get_list_case_attachments" as select
        *
    from
        ( call "desk_com_connector.get_list_case_attachments" ( "in_case_id" => '606' ) ) dd	READY
86	2015-04-24 18:17:47	"638184653"	true	2015-04-24 18:17:47	ml.flat_brand_bi_brand		"CREATE VIEW ml.flat_brand_bi_brand AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('bi_brand_flat.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""flat_brand"" STRING,
		""bi_brand"" STRING 
		DELIMITER ',' 
		HEADER 1 
	)
""csv_table"""	READY
136	2015-04-24 18:17:56	"638184750"	true	2015-04-24 18:17:56	meta.schema__ml		CREATE VIEW meta.schema__ml AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('ml', 'schema')) as a	READY
491,529	2015-08-10 15:24:03	"1141300589"	true	2015-08-10 15:24:03	desk_com_connector_example.example_show_case_attachment		create view "desk_com_connector_example"."example_show_case_attachment" as select
        *
    from
        (
            call "desk_com_connector.show_case_attachment" (
                "in_case_id" => '1'
                ,"in_attachment_id" => '110193435'
            )
        ) ss	READY
30	2015-04-24 18:17:17	"884478868"	true	2015-06-14 10:47:12	raw.customer_salesforce		"CREATE view ""raw.customer_salesforce"" 
AS
SELECT
	ExternalCustomerid__c as customer_id,
	Id as salesforce_customer_id,
	OwnerId as salesforce_account_owner,
	CustomerStatus__c as customer_status,
	inkasso__c as debt_collection,
	vip__c as vip_customer,
	favoritecustomer__c as favourite_customer,
	polite__c as informal,
	DuSie__c as formal_or_informal,
	Stylist_Lead__c as stylist_lead,
	Upcload__c as upcload,
	Kundenstatus__c as salesforce_account_status,
	
	/*---Finance Information
	  Buergel score is manually updated by finance once there recieved score from 3rd party company
	  Orders are process based on NegativeEntry and Negativmerkal
	---*/
	BuergelScore__c as finance_buergel_score,
	NegativeEntry__c as finance_negative_entry,
	Negativmerkmal__c as finance_negative_features,
	Vorkasse_Email_gesendet__c as prepayment_email_sent,
	MaxBasketValue__c as finace_max_basket_value,
	DifMaxneu__c as finace_basket_diff,
	
	
	/*---Customer Contact Information
	This information is updated by stylist based on customer information
	---*/
	secondtelephonnr__c as alternative_phone_number,
	phone_extension__c as phone_extension,
	nicht_erreicht_2ter_versuch__c as not_reached,
	Ergebnis_letzte_Reaktivierung_2__c as last_reactivation_result,
	Letzter_Anrufversuch_f_r_Reaktivierung__c as last_call_reactivation,
	telefonnummer_falsch__c as wrong_phone_number,
	set_customer_email_to_invalid_sf_only__c as wrong_email_address,
	
	
	/*---Unsbuscribe Newsletter/SMS---*/
	SMS_Unsubscribe__c as unsubscribe_sms,
	UnsubscribedNL__c as unsubscribe_newsletter,
	
	/*--Feedback Calls Information--*/
	Date_Last_Contact_Aggregated__c as date_last_contacted,
	Feedback_Call_Umfrage__c as feedback_call_poll,
	Zuweisung_Feedback_Call__c as feedback_caller,
	Source__c as customer_source,
	
	/*---Social Profiles---*/
	social_profil_wie_gefunden__c as social_profile,
	facebook_profil_gefunden__c as facebook_profile,
	facebook_url__c as facebook_page,
	linkedin_url__c as linkedin_page,
	xing_url__c as xing_page,
	
	
	/*---Club Member---*/
	Outfittery_Club_Typ_der_Mitgliedschaft__c as club_membership_type,
	Outfittery_Club_Mitglied__c as club_member,
	Outfittery_Club_Kundenfeedback__c as club_customer_feedback,
	Outfittery_Club_Einf_hrungskampagne__c as club_campaign_member,
	Next_Club_box__c as club_first_box,
	Outfittery_Club_Mitgliedschaft_angebot__c as club_member_offer,
	
	
	/*---customer more detailed information*/       	
	branchworkinginother__c as customer_career,
	detailsberuf__c as career_details,
	detailsprivat__c as personal_details,
	national_id_number__c as national_id,
	wife__c as married,
	girlfriend__c as girlfriend,
	kunde_betr__c as fraudulent_customer,
	betrugsverd_chtig_grund__c as fraud_reason,
		
	/*---Body Measurements
	BMI is caluclate using formula: Q_weight__c / ((Q_BodySize__c/100) ^ 2)
	---*/
	q_bodysize__c as bodysize,
	q_weight__c as weight,
	sizecheck1__c as size_check,
	JeansWidth__c as jeans_width,
	BMI__c as bmi,
	q_fittingissues__c as fitting_issues,
	
	/*---Additional Information---*/
	DataQualityScore__c as data_qualitty_score,
	left(costumerneeds__c,4000) as customer_needs,
	customerneedsmultiple__c as customer_needs_options,
	picarticleneeded__c as customer_article_needed,
	customersexpection__c as customer_expectaion,
	left(exspectationsindetail__c,4000) as customer_expectation,
	braucht_nicht_will_nicht__c as does_not_want_or_need,
	willingnesstospendoverall__c as willingness_to_spend,
	ocassionforfirstorder__c as occasion_first_order,
	
	/*--Other Information--*/
	left(furtherquestionnaireinformation__c,4000) as furtherinformation,
	occasioncommoditygroups__c as commodity_group,
	left(CommentsOperations__c,4000) as operations_comments,
	SystemModstamp as last_updated_date

FROM ""salesforce.Account"""	READY
491,530	2015-08-10 15:24:03	"1141300590"	true	2015-08-10 15:24:03	desk_com_connector_example.example_get_list_case_feed		CREATE view "desk_com_connector_example"."example_get_list_case_feed" as 
select
        *
    from
        (
            call "desk_com_connector.get_list_case_feed"(
                "in_case_id" => '606'
            )) ss	READY
491,559	2015-08-10 15:24:14	"1141300619"	true	2015-08-10 15:24:14	desk_com_connector_example.example_get_list_users_macros		CREATE view "desk_com_connector_example"."example_get_list_users_macros" as select
        *
    from
        ( call "desk_com_connector.get_list_users_macros" ( "in_user_id" => '21674781' ) ) ee	READY
32	2015-04-24 18:17:17	"638184552"	true	2015-04-24 18:17:17	views.salesforce_task		"CREATE view views.salesforce_task 
as
SELECT 
Id,
AccountId,
Subject,
WhatId as opportunity_id,
CreatedDate
FROM salesforce.Task 
where subject = 'Email: Feedback mit Mail' or subject = 'Freunde empfehlen - DU'"	READY
491,531	2015-08-10 15:24:03	"1141300591"	true	2015-08-10 15:24:03	desk_com_connector_example.example_show_case_history		create view "desk_com_connector_example"."example_show_case_history" as select
        *
    from
        (
            call "desk_com_connector.show_case_history" (
                "in_case_id" => '1'
            )
        ) dd	READY
65	2015-04-24 18:17:43	"1112787651"	true	2015-04-24 18:17:43	ml.order_position_ml_response		"CREATE VIEW ml.order_position_ml_response AS
SELECT
	op.id AS order_position_id,
	aml.ml_response_id
FROM
(SELECT
	tbl.article_id,
	tbl.order_id,
	tbl.ml_response_id
FROM
(SELECT
	at.foreign_id AS article_id,
	at.order_id AS order_id,
	at.ml_response_id AS ml_response_id,
	at.date_created,
	ROW_NUMBER() OVER (PARTITION BY at.order_id, at.foreign_id ORDER BY at.date_created DESC) AS rk
FROM postgres.action_tracking as at
WHERE action = 'ARTICLE_ADD') AS tbl
WHERE tbl.rk = 1) AS aml
INNER JOIN postgres.order_position AS op
	ON op.order_id = aml.order_id and op.article_id = aml.article_id"	READY
35	2015-04-24 18:17:18	"638184557"	true	2015-04-24 18:17:18	views.marketingtv		"CREATE view ""views.marketingtv""
as
SELECT
	cast(order_id as string) as order_id,
	tv_spot_date_utc,
	utc_gmt as tv_spot_date,
	SUBSTRING(utc_gmt,0,11) AS ""date_spot_aired"",
	left(SUBSTRING(utc_gmt,12,19),8) AS ""timestamp_spot_aired"",
	tv_station,
	tv_program
FROM 
(	 SELECT 
		tv.order_id,
		tv.program_after,
		tv.program_before as tv_program,
		tv.spotname as tv_spotname,
		tv.spotstation as tv_station,
		tv.airingtime as tv_spot_date_utc,
		tv.nb_of_visits,
		/*this case statement converts time from utc to gmt*/
		case 
		when tv.airingtime between parsetimestamp('2014-03-30 02:00:00.000','yyyy-MM-dd HH:mm:ss.S') and parsetimestamp('2014-10-26 03:00:00.000','yyyy-MM-dd HH:mm:ss.S') 
			then timestampadd(SQL_TSI_HOUR,+2,tv.airingtime)
		when tv.airingtime between parsetimestamp('2014-10-26 03:00:00.000','yyyy-MM-dd HH:mm:ss.S') and parsetimestamp('2015-03-29 02:00:00.000','yyyy-MM-dd HH:mm:ss.S') 
			then timestampadd(SQL_TSI_HOUR,+1,tv.airingtime)
		when tv.airingtime between parsetimestamp('2015-03-29 02:00:00.000','yyyy-MM-dd HH:mm:ss.S') and parsetimestamp('2015-10-25 03:00:00.000','yyyy-MM-dd HH:mm:ss.S') 
			then timestampadd(SQL_TSI_HOUR,+2,tv.airingtime)
		when tv.airingtime between parsetimestamp('2015-10-25 03:00:00.000','yyyy-MM-dd HH:mm:ss.S') and parsetimestamp('2016-03-27 02:00:00.000','yyyy-MM-dd HH:mm:ss.S') 
			then timestampadd(SQL_TSI_HOUR,+1,tv.airingtime)
		when tv.airingtime between parsetimestamp('2015-03-29 02:00:00.000','yyyy-MM-dd HH:mm:ss.S') and parsetimestamp('2015-10-25 03:00:00.000','yyyy-MM-dd HH:mm:ss.S') 
			then timestampadd(SQL_TSI_HOUR,+2,tv.airingtime)
		when tv.airingtime between parsetimestamp('2015-10-25 03:00:00.000','yyyy-MM-dd HH:mm:ss.S') and parsetimestamp('2016-03-27 02:00:00.000','yyyy-MM-dd HH:mm:ss.S') 
			then timestampadd(SQL_TSI_HOUR,+1,tv.airingtime)
		when tv.airingtime between parsetimestamp('2016-03-27 02:00:00.000','yyyy-MM-dd HH:mm:ss.S') and parsetimestamp('2016-10-30 03:00:00.000','yyyy-MM-dd HH:mm:ss.S') 
			then timestampadd(SQL_TSI_HOUR,+2,tv.airingtime)
		when tv.airingtime between parsetimestamp('2016-10-30 03:00:00.000','yyyy-MM-dd HH:mm:ss.S') and parsetimestamp('2017-03-26 02:00:00.000','yyyy-MM-dd HH:mm:ss.S') 
			then timestampadd(SQL_TSI_HOUR,+1,tv.airingtime)
		else tv.airingtime
		end as utc_gmt
	FROM ""dwh"".""marketing_tv"" tv
)a"	READY
66	2015-04-24 18:17:43	"1112787652"	true	2015-04-24 18:17:43	raw.article_suppliers		"CREATE VIEW raw.article_suppliers
AS
SELECT 
x.article_id,
x.supplier_id
FROM
(
SELECT
	pop.article_id,
	po.supplier_id,
	row_number() over (partition by pop.article_id order by pop.date_created desc) as ""rnum""
FROM postgres.purchase_order po
JOIN postgres.purchase_order_position pop on pop.purchase_order_id = po.id
WHERE po.stock_location_id = 2
) x 
WHERE x.rnum = 1"	READY
68	2015-04-24 18:17:43	"1112787653"	true	2015-04-24 18:17:43	ml.attribute		"CREATE VIEW ml.attribute AS
SELECT
att.id attribute_id,
prop.id property_id,
prop.identifier property_identifier,
att.identifier attribute_identifier,
att.name attribute_name
FROM
postgres.attribute att
JOIN postgres.property prop ON att.property_id = prop.id"	READY
107	2015-04-24 18:17:51	"1112787673"	true	2015-07-02 12:05:27	raw.customer_order_articles_logistics_before_3mo		"CREATE view raw.customer_order_articles_logistics_before_3mo AS

WITH so AS
(
SELECT 
	h.order_id,
	h.date_header_created,
	h.shipping_code,
	l.article_id,
	l.line_number,
	l.date_order_line_created,
	l.date_line_created,
	l.date_line_cancelled
FROM
/*---there are often multiple entries in doc_data_sales_order_header, because every time an order is adjusted (by finance or a line item is cancelled because it is out of stock) it is re-submitted. Therefore, always use the min ---*/
	(
	SELECT
		order_id,
		MIN(date_stock_sales_order_header_created) AS date_header_created,
		MAX(shipping_code) AS shipping_code /* almost never more than 1 */
	FROM
		raw.stock_sales_order_header
	GROUP BY 1
	HAVING
		MIN(date_stock_sales_order_header_created) < TIMESTAMPADD(SQL_TSI_MONTH,-3,CURDATE())
	AND	MIN(date_stock_sales_order_header_created) >= '2014-01-01'
	) h
	JOIN
/*---quantity = 0 means that the articles is out of stock and will go on backorder. This leads to the item getting cancelled off of the order. Therefore the max date where quantity = 0 is sales_order_line_date_cancelled ---*/
	(
	SELECT
	    b.*,
	    CASE
	        WHEN date_line_cancelled_sub IS NOT NULL AND date_line_created IS NULL  THEN date_line_cancelled_sub
	        WHEN date_line_cancelled_sub > date_line_created                        THEN date_line_cancelled_sub
	    END AS date_line_cancelled
	FROM
		(
		SELECT
			order_id,
			article_id,
			line_number,
			MIN(date_stock_sales_order_line_created) AS date_order_line_created,
			MIN(CASE WHEN articles = 1 THEN date_stock_sales_order_line_created END) AS date_line_created,
			MIN(CASE WHEN articles < 1 THEN date_stock_sales_order_line_created END) AS date_line_cancelled_sub
		FROM
			raw.stock_sales_order_line
		GROUP BY 1,2,3
		) b
	) l
		 ON h.order_id 		= l.order_id
),
ir AS
(
/*--- if the line item in doc_data_sales_order_import_result has a message, that means it is ""on error"" and requires action from operations. Sometimes a line entry with a message shows up with the 
error message, ""No changes possible in order"", after it has been shipped. These can be ignored.  ---*/
SELECT 
    order_id,
    line_number,
	MIN(date_stock_imported) AS date_import_created,
    MIN(CASE WHEN message  = '' THEN date_stock_imported END) AS date_imported, /* '' equals success */
    MIN(CASE WHEN message != '' THEN date_stock_imported END) AS date_import_error,
    MAX(CASE WHEN message != '' THEN message END) AS import_error /* there are cases where >1 messages; if all messages are needed, then need to change */
FROM
	raw.stock_imported
WHERE
		message != 'No changes possible in order' /* message is not null */
	AND line_number != 0
GROUP BY 1,2
),

sc AS
(
SELECT
    y.*,
    CASE /* THIS CATORGIZES THE ORDER INTO A BUCKET BASED UPON THE LAST ROW OF DATA BEFORE manifest_shipping */
        WHEN date_picklist_created_max IS NOT NULL AND date_backordered_nos_max IS NULL THEN 'picklist created'
        WHEN date_picklist_created_max > date_backordered_nos_max                       THEN 'picklist created'
        ELSE 'backordered/not on stock'
    END AS order_status_change_state /* ARTICLE LEVEL */
FROM
    (
    SELECT
        sc.order_id,
        sc.article_id,
        MIN(sc.date_status_change) AS date_order_status_change_created,
        /* message has only 3 values, 'PICKLIST CREATED', 'BACKORDER', 'NOT ON STOCK' */
        MIN(CASE WHEN sc.message  = 'PICKLIST CREATED' 	THEN sc.date_status_change END) AS date_picklist_created,
        MIN(CASE WHEN sc.message  = 'BACKORDER' 		THEN sc.date_status_change END) AS date_backordered,
        MIN(CASE WHEN sc.message  = 'NOT ON STOCK' 		THEN sc.date_status_change END) AS date_not_on_stock,
        /* MAX USED AT ORDER LEVEL ROLLUP */
        MAX(CASE WHEN sc.message  = 'PICKLIST CREATED' 	THEN sc.date_status_change END) AS date_picklist_created_max,
        MAX(CASE WHEN sc.message != 'PICKLIST CREATED' 	THEN sc.date_status_change END) AS date_backordered_nos_max
    FROM
        raw.stock_sales_order_status_change sc
        LEFT JOIN
        /* JOIN TO doc_data_manifest_shipping TO FILTER OUT ANY DATES AFTER AN ORDER ARRIVES INTO THAT TABLE */
        raw.stock_shipped AS ms
            ON sc.order_id = ms.order_id
    WHERE
            sc.date_status_change < ms.date_stock_shipped
         OR ms.order_id IS NULL
    GROUP BY 1,2
    ) AS y
)


/* MAIN BODY */
SELECT 
	/* Identifiers */
	CAST(so.order_id AS LONG) AS order_id,
	CAST(so.article_id AS LONG) AS article_id,
	
	/* Dates (in order) */
	MIN(so.date_header_created) AS date_header_created,
	MIN(so.date_order_line_created) AS date_order_line_created,
	MIN(so.date_line_created) AS date_line_created,
	MIN(so.date_line_cancelled) AS date_line_cancelled,
	MIN(ir.date_import_created) AS date_import_created,
	MIN(ir.date_imported) AS date_imported,
	CASE
		WHEN MIN(ir.date_import_error) < MIN(sc.date_order_status_change_created)
		THEN MIN(ir.date_import_error)
		WHEN MIN(ir.date_import_error) IS NOT NULL AND MIN(sc.date_order_status_change_created) IS NULL
		THEN MIN(ir.date_import_error)
	END AS date_import_error,
	MIN(sc.date_order_status_change_created) AS date_order_status_change_created,
	MAX(sc.date_picklist_created_max) AS date_picklist_created_max,
	MAX(sc.date_backordered_nos_max) AS date_backordered_nos_max,
	MIN(sc.date_backordered) AS date_backordered,
	MIN(sc.date_not_on_stock) AS date_not_on_stock,
	MIN(sc.date_picklist_created) AS date_picklist_created,
	MIN(ddsc.date_stock_packed) AS date_packed,
	MIN(ddms.date_stock_shipped) AS date_shipped,
	/* add row for date deliverd once data is available from ""postgres.delivery_tracking"" */
	MIN(ddr.date_stock_returned) AS date_returned,
	
	/* other data points */
	MAX(ir.import_error) AS import_error,
	MAX(CAST(ddsc.transport_company_code AS LONG)) AS transport_company_code,
	MAX(ddms.track_and_trace_number) AS track_and_trace_number,
	MAX(ddms.receiver_country_code) AS shipping_country,
	MAX(so.shipping_code) AS shipping_code,
	MAX(LEFT(CAST(ddms.processing_reason AS STRING), 4000)) AS shipment_error,
	MAX(ddms.return_track_and_trace_number) AS return_track_and_trace_number,
	MAX(ddr.return_number) AS return_number,
	MAX(LEFT(CAST(ddr.processing_reason AS STRING), 4000)) AS return_error,
	MAX(sc.order_status_change_state) AS order_status_change_state
	
FROM 
	so
	LEFT JOIN
	ir
		 ON so.order_id 		= ir.order_id
		AND so.line_number 		= ir.line_number
	LEFT JOIN
	sc
		 ON so.order_id 		= sc.order_id
		AND so.article_id		= sc.article_id
	LEFT JOIN 
	raw.stock_packed AS ddsc 
		 ON so.order_id 		= ddsc.order_id
		AND so.article_id		= ddsc.article_id
	LEFT JOIN
	raw.stock_shipped AS ddms 
		 ON so.order_id  		= ddms.order_id
		AND so.article_id		= ddms.article_id		
	LEFT JOIN 
	raw.stock_returned AS ddr
		 ON so.order_id 		= ddr.order_id
		AND so.article_id 		= ddr.article_id
GROUP BY 1,2"	READY
491,532	2015-08-10 15:24:04	"1141300592"	true	2015-08-10 15:24:04	desk_com_connector_example.example_list_companies_cases		CREATE view desk_com_connector_example.example_list_companies_cases as select
        *
    from
        (
            call "desk_com_connector.get_list_company_cases" (
                "in_company_id" => '34288705'
            )
        ) dd	READY
491,533	2015-08-10 15:24:04	"1141300593"	true	2015-08-10 15:24:04	desk_com_connector_example.example_list_company_customers		CREATE view desk_com_connector_example.example_list_company_customers as 
select
        *
    from
        (
            call "desk_com_connector.get_list_company_customers" (
                "in_company_id" => '39852364'
            )
        ) dd	READY
491,534	2015-08-10 15:24:04	"1141300594"	true	2015-08-10 15:24:04	desk_com_connector_example.example_show_customer		CREATE view desk_com_connector_example.example_show_customer as 
select
        *
    from
        (
            call "desk_com_connector.show_customer" (
                "in_customer_id" => '343206165'
            )
        ) ss	READY
491,535	2015-08-10 15:24:05	"1141300595"	true	2015-08-10 15:24:05	desk_com_connector_example.example_get_list_customer_cases		CREATE view desk_com_connector_example.example_get_list_customer_cases as select
        *
    from
        ( call "desk_com_connector.get_list_customer_cases" ( "in_customer_id" => '39852364' ) ) a	READY
31	2015-04-24 18:17:17	"988772309"	true	2015-07-08 14:43:27	views.ga_information		"CREATE view views.ga_information
as
/* GA data */
select
	foo.date_created,
	foo.hour_created,
	foo.transaction_id,
	foo.country,
	foo.channel,
	/* DETERMINING IF CUSTOMER WAS REFERRED OR NOT */
	case
		when foo.source= 'referral' and foo.medium= 'referralpage' then 'referred by customer'
		else 'not referred by customer'
	end as ""referred_by_customer"",
	/* RECONSTRUCTION OF MANGLED REFERRING CUSTOMER TOKEN TO LINK TO ACCOUNT LATER ON */
	case
		when foo.source= 'referral' and foo.medium= 'referralpage' then substring(foo.adcontent,20,13) || substring(foo.adcontent,0,19)
		else '(not set)'
	end as ""referring_customer_token"",
	foo.source,
	foo.medium,
	foo.source || ' / ' || foo.medium as ""source_medium"",
	foo.campaign,
	foo1.cam_bit_1,
	foo1.cam_bit_2,
	foo1.cam_bit_3,
	foo1.cam_bit_4,
	foo1.cam_bit_5,
	foo1.cam_bit_6,
	foo1.cam_bit_7,
	foo1.cam_bit_8,
	foo1.cam_bit_9,
	foo1.cam_bit_10,
	foo1.cam_bit_11,
	foo1.cam_bit_12,
	foo1.cam_bit_13,
	foo1.cam_bit_14,
	foo1.cam_bit_15,
	foo1.cam_bit_16,
	foo1.cam_bit_17,
	foo1.cam_bit_18,
	foo1.cam_bit_19,
	foo1.cam_bit_20,
	foo.keyword,
	foo.adcontent,
	foo.optimizely_campaign,
	'0' as visits_per_transactionid,
	foo.device_category,
	foo.java_enabled,
	foo.flash_version,
	foo.browser,
	foo.browser_version,
	foo.operating_system,
	foo.operating_system_version,
	foo.mobile_device_branding,
	foo.mobile_device_model,
	foo.mobile_device_info,
	foo.screen_colors,
	foo.screen_resolution
from (
	select
		row_number() over (partition by utm.transaction_id order by utm.date_created desc, utm.hour_created desc) as ""rnum"",
		utm.date_created,
		utm.hour_created,
		utm.transaction_id,
		utm.country,
		gct.channel,
		lower(utm.source) as ""source"",
		lower(utm.medium) as ""medium"",
		lower(utm.campaign) as ""campaign"",
		lower(misc2.adcontent) as ""adcontent"",
		key.keyword,
		sys.browser,
		sys.browser_version,
		sys.operating_system,
		sys.operating_system_version,
		dev.device_category,
		dev.mobile_device_branding,
		dev.mobile_device_model,
		dev.mobile_device_info,
		misc.java_enabled,
		misc.flash_version,
		misc.screen_colors,
		misc.screen_resolution,
		/*vis.visits, */
		misc2.optimizely as ""optimizely_campaign""
	from dwh.ga_information_utm utm
	left join dwh.ga_information_system sys on utm.transaction_id = sys.transaction_id and utm.date_created = sys.date_created and utm.hour_created = sys.hour_created
	left join dwh.ga_information_device dev on utm.transaction_id = dev.transaction_id and  utm.date_created = dev.date_created and utm.hour_created = dev.hour_created
	left join dwh.ga_information_misc misc on utm.transaction_id = misc.transaction_id and utm.date_created = misc.date_created and utm.hour_created = misc.hour_created
	/*left join dwh.ga_information_visits vis on utm.transaction_id = vis.transaction_id and utm.date_created = vis.date_created and utm.hour_created = vis.hour_created Excluded due to poor data quality*/
	left join dwh.ga_information_keyword key on utm.transaction_id = key.transaction_id and utm.date_created = key.date_created and utm.hour_created = key.hour_created
	left join dwh.ga_information_misc2 misc2 on utm.transaction_id = misc2.transaction_id and utm.date_created = misc2.date_created  
	left join dwh.ga_channel_translation gct on lower(utm.source) || ' / ' || lower(utm.medium) = gct.source_medium 
	WHERE utm.transaction_id != 'undefined'
	) foo,
	texttable (foo.campaign columns
					cam_bit_1 string,
					cam_bit_2 string,
					cam_bit_3 string,
					cam_bit_4 string,
					cam_bit_5 string,
					cam_bit_6 string,
					cam_bit_7 string,
					cam_bit_8 string,
					cam_bit_9 string,
					cam_bit_10 string,
					cam_bit_11 string,
					cam_bit_12 string,
					cam_bit_13 string,
					cam_bit_14 string,
					cam_bit_15 string,
					cam_bit_16 string,
					cam_bit_17 string,
					cam_bit_18 string,
					cam_bit_19 string,
					cam_bit_20 string
					delimiter '_' ) foo1
			where foo.rnum= '1'
AND foo.date_created < '2015-05-28'
UNION
/* Snowplow data */
SELECT
	CAST(sp.date_created as date) as date_created,
	HOUR(sp.date_created) as hour_created,
	sp.order_id as transaction_id,
	domain as country,
	 CASE 
		WHEN marketing_channel = 'Direct' THEN 'direct'
		WHEN marketing_channel = 'SEM Non-brand' THEN 'google sem'
		WHEN marketing_channel = 'CRM' THEN	'crm'
		WHEN marketing_channel = 'Cooperations' THEN 'kooperation'
		WHEN marketing_channel = 'Facebook' THEN 'facebook'
		WHEN marketing_channel = 'SEO' THEN	'organic'
		WHEN marketing_channel = 'Display' THEN	'display'
		WHEN marketing_channel = 'Affiliate' THEN 'affiliate'
		WHEN marketing_channel = 'SEM Brand' THEN 'google sem'
		WHEN marketing_channel = 'Social Media' THEN 'social media'
		WHEN marketing_channel = 'Remarketing' THEN	'remarketing'
		WHEN marketing_channel = 'Referral Program' THEN 'praemienprogramm'
	END AS channel,
	null as referred_by_customer,
	null as referring_customer_token,
	LOWER(source) as source,
	LOWER(medium) as medium,
	LOWER(source) || ' / ' || LOWER(medium) as source_medium,
	LOWER(campaign) as campaign,
	sp3.cam_bit_1,
	sp3.cam_bit_2,
	sp3.cam_bit_3,
	sp3.cam_bit_4,
	sp3.cam_bit_5,
	sp3.cam_bit_6,
	sp3.cam_bit_7,
	sp3.cam_bit_8,
	sp3.cam_bit_9,
	sp3.cam_bit_10,
	sp3.cam_bit_11,
	sp3.cam_bit_12,
	sp3.cam_bit_13,
	sp3.cam_bit_14,
	sp3.cam_bit_15,
	sp3.cam_bit_16,
	sp3.cam_bit_17,
	sp3.cam_bit_18,
	sp3.cam_bit_19,
	sp3.cam_bit_20,
	null as keyword,
	null as adcontent,
	null as optimizely_campaign,
	'0' as visits_per_transactionid,
	CASE 
    	WHEN device_type = 'Computer' THEN 'desktop'
        WHEN device_type = 'Mobile' THEN 'mobile'
        WHEN device_type = 'Tablet' THEN 'tablet'   
    END AS device_category,
    null as java_enabled,
    null as flash_version,
    br_family as browser,
	br_type as browswer_version,
	os_family as operating_system,
	os_name as operating_system_version,
	null as mobile_device_brand,
	null as mobile_device_model,
	null as mobile_device_info,
	null as screen_colors,
	null as screen_resolution
FROM raw.snowplow_transactions sp
LEFT JOIN
(
	SELECT
		sp2.order_id,
		ab.cam_bit_1,
		ab.cam_bit_2,
		ab.cam_bit_3,
		ab.cam_bit_4,
		ab.cam_bit_5,
		ab.cam_bit_6,
		ab.cam_bit_7,
		ab.cam_bit_8,
		ab.cam_bit_9,
		ab.cam_bit_10,
		ab.cam_bit_11,
		ab.cam_bit_12,
		ab.cam_bit_13,
		ab.cam_bit_14,
		ab.cam_bit_15,
		ab.cam_bit_16,
		ab.cam_bit_17,
		ab.cam_bit_18,
		ab.cam_bit_19,
		ab.cam_bit_20
	FROM
	(
		SELECT
			order_id,
			campaign
		FROM raw.snowplow_transactions 
		) sp2,
		texttable(LOWER(sp2.campaign) columns
							cam_bit_1 string,
							cam_bit_2 string,
							cam_bit_3 string,
							cam_bit_4 string,
							cam_bit_5 string,
							cam_bit_6 string,
							cam_bit_7 string,
							cam_bit_8 string,
							cam_bit_9 string,
							cam_bit_10 string,
							cam_bit_11 string,
							cam_bit_12 string,
							cam_bit_13 string,
							cam_bit_14 string,
							cam_bit_15 string,
							cam_bit_16 string,
							cam_bit_17 string,
							cam_bit_18 string,
							cam_bit_19 string,
							cam_bit_20 string
							delimiter '_' ) ab	
) sp3 ON sp.order_id = sp3.order_id
WHERE CAST(date_created as date) >= '2015-05-28'"	READY
491,536	2015-08-10 15:24:05	"1141300596"	true	2015-08-10 15:24:05	desk_com_connector_example.example_get_list_etags		create view desk_com_connector_example.example_get_list_etags as select
        *
    from
        (
            call "desk_com_connector.get_list_etags" ()) dd	READY
491,537	2015-08-10 15:24:05	"1141300597"	true	2015-08-10 15:24:05	desk_com_connector_example.example_get_list_filters		CREATE view "desk_com_connector_example"."example_get_list_filters" as 
select
        *
    from
        (
            call "desk_com_connector.get_list_filters" ()) dd	READY
491,538	2015-08-10 15:24:06	"1141300598"	true	2015-08-10 15:24:06	desk_com_connector_example.example_show_filter		create view "desk_com_connector_example"."example_show_filter" as select
        *
    from
        (
            call "desk_com_connector.show_filter" (
                "in_filter_id" => '2368287'
            )
        ) aa	READY
491,539	2015-08-10 15:24:06	"1141300599"	true	2015-08-10 15:24:06	desk_com_connector_example.example_get_list_groups		CREATE view "desk_com_connector_example"."example_get_list_groups" as 
select
        *
    from
        ( call "desk_com_connector.get_list_groups" ( ) ) ss	READY
45	2015-04-24 18:17:21	"1308953060"	true	2015-09-13 12:22:47	raw.customer_order_salesforce		"CREATE VIEW raw.customer_order_salesforce
AS
SELECT

  ExternalOrderId__c as order_id,
  Id as salesforce_order_id,
  OwnerId as salesforce_owner,
  StageName as salesforce_order_stage,
  OrderType__c as salesforce_order_type,
  ContactOver__c as contact_type,

  /*Call Information*/
  Kalender_war_geblockt__c as calender_full,
  CallConfirmed__c as call_confirmed,
  kunde_hat_termin_abgesagt__c as call_cancelled,
  Neuer_Termin_f_r_erreicht__c as new_phone_appointment,
  Anrufversuche__c as nb_of_call_attempts,
  notReached__c as not_reached,
  Telefonnummer_Falsch__c as wrong_phone_number,
  threeTimesNotReached__c as nb_of_times_not_reached,
  Number_of_calls_made__c as nb_of_reactivation_calls_made,

  /*Finance Check-All OPS columns are formula field in salesforce (check finance document)
    for formulas*/
  PaymentCheck__c as payment_check,
  Prepay_requirement_currency__c as pre_pay_requrirement,
  Vorkasse_Email_sent__c as prepayment_email_sent,
  Score_Empfehlung__c as score_recommendation,
  /*Finace Check*/
  Ops_Check_B__c as ops_check_b,
  Ops_Check_A__c as ops_check_a,
  Ops_Check_C__c as ops_check_c,
  OpsAction__c as ops_action,
  OpsCheck__c as ops_check,
  Finance_check__c as finance_check,
  Finance_Ops_Check_test__c as finance_ops_check,
  Inkasso__c as debt_collection_set,
  
  /* OPS/CS information*/
  CS_hat_informiert_Finance__c as cs_informed_finance,
  Finance_to_CSset__c as finance_to_cs_set,
  Finance_to_CS__c as finance_to_cs,
  Ops_Check_ausstehende_Orders__c as ops_outstanding_order,
  CommentsOperations__c as ops_comments,
  OpsCommentRead__c as ops_comments_read,

  /*DHL Information-dhl link and dhl return link is updated from doc_data_manifest shipping and kettle jobs,
    return next steps is updated by operations or stylist*/
  Box_erneut_versendet_storniert__c as box_resent_cancelled,
  DHL_Link__c as dhl_link,
  DHLReturnLink__c as dhl_return_link,
  DHLReturnNextSteps__c as dhl_return_next_steps,
  Neue_Adresse_R_ckl_ufer__c as new_return_address,
  DHL_Status__c as dhl_status,
  Abholauftrag__c as pick_up_order,
  Refusals_comment__c as refusual_comment,

  /*All Dates*/
  DateFirstOrder__c as date_first_order,
  DateNextContact__c as date_next_contact,
  PreviewDate__c as preview_date,
  Date_Vorkasse_Email_sent__c as date_prepayment,
  DateOpsCheckSet__c as date_ops_check,
  DateFeedback__c as date_feedback,
  Datum_Feedback_Call__c as date_feedback_call,
  Datum_Inkasso_gesetzt__c as date_debt_collection,
  InkassoComments__c as debt_collection_comments,
  R_ckl_ufer_erneut_versenden_am__c as date_return_resend,
  Latest_Call_Attempt__c as date_last_reactivation_call_order,
                                                SystemModstamp as last_updated_date,

  /*Arvato Checks
    NOTE: NewCardRecommendation is sometimes updated by finance*/
  ArvatoYorN__c as arvato_y_n,
  arvatoStatus__c as arvato_status,
  NewCardrecommendation__c as newcardrecommendation,
  Max_Warenkorbempfehlung_Arvato__c as max_basket_arvato,

  /*Preview Information*/
  DislikedPreview__c as preview_not_liked,
  SentPreview__c as preview_sent,

  /*Sales Channel*/
  SalesChannel__c as sales_channel,
  SalesChannel_Special__c as saleschannel_special,
  TextOrderConfirmation__c as order_confirmation_sent,
  On_Hold_Grund__c as onhold_reason,
  InactiveReason__c as inactive_reasons,
  FirstOrder__c as first_order,
  CS_Reason__c as customer_support_reason,
  NL_Ghost_Stylist__c as nl_ghost_stylist,
  NoCall_Box__c as no_call_box,
  Keine_Nachbestellung__c as no_repeat,

  /*Arvato Payment Information-These fields are updated by BI using arvato's xml file*/
  Paid_to_Arvato__c as paid_arvato_amount,
  Open_Ammount_Arvato__c as open_arvato_amount,
  Arvato_Payment_Confirmation_Sent__c as arvato_confrimation_sent,

  /*Feedback Information*/
  Feedback_Status__c as feedback_status,
  Feedback_Caller_ID__c as feedback_caller_id,
  FeedbackDate__c as feedback_date,
  Kunde_m_chte_Feedback_Call_Termin__c as feedback_appointment,
  FeedbackCallNotReached__c as feedback_not_reached,
  FeedbackDataQualityScore__c as feedback_data_quality_score,
  DontSentFeedbackMail__c as feedback_mail_dont_sent,

  /*Other Information*/
  ReturnRate__c as return_rate,
  NPS__c as nps_score,
  FriendsNames__c as friends_names,
  Upcload_tested__c as upcload_tested,
  VoucherCode__c as voucher_code,
  WeDidNotForgetYou__c as didnot_forgot,

  /*Customer Feedback Information*/
  DontSentFeedbackMail__c as feedback_mail_not_sent,
  LEFT(generalFeedback__c,4000) as customers_feedback,
  FurtherCustomerInformation__c as futher_cust_information

FROM ""salesforce.Opportunity"""	READY
42	2015-04-24 18:17:20	"1112787641"	true	2015-04-24 18:17:20	raw.financial_transactions		"CREATE VIEW raw.financial_transactions
AS
SELECT 
a.id as financial_transaction_id,
a.order_id,
a.customer_id,
a.date_created,
a.provider,
a.transaction_id,
a.provider_transaction_id,
a.provider_transaction_token,
a.status,
a.valuation, 
LEFT(ftd.arvatotype, 4000) as arvato_type,
CAST(LEFT(ftd.arvatoorderlimit, 4000) as float) as arvato_order_limit,
LEFT(ftd.arvatoresult, 4000) as arvato_result,
CAST(LEFT(ftd.arvatoscore, 4000) as integer) as arvato_score,
LEFT(a.response_code, 4000) as response_code,
LEFT(a.request_body, 4000) as request_body,
LEFT(a.response_body, 4000) as response_body
FROM postgres.financial_transaction a
JOIN postgres.financial_transaction_details ftd on a.id = ftd.id"	READY
44	2015-04-24 18:17:20	"1112787644"	true	2015-07-31 09:47:11	raw.customer_survey		"CREATE VIEW raw.customer_survey
AS
SELECT
*
FROM postgres.customer_survey"	READY
51	2015-04-24 18:17:22	"638184605"	true	2015-04-24 18:17:22	views.pim_article		"CREATE VIEW views.pim_article
AS
SELECT
	o.oo_id,
	o.oo_classId,
	o.oo_className,
	o.sku,
	o.ean,
	o.supplier_availability,
	case when b.name is not null then b.name else o.brand end as brand,
	o.article_name,
  	CASE WHEN cg1.title_de is not null THEN cg1.title_de ELSE o.commodity_group1 END as commodity_group1,
  	CASE WHEN cg2.title_de is not null THEN cg2.title_de ELSE o.commodity_group2 END as commodity_group2,
  	CASE WHEN cg3.title_de is not null THEN cg3.title_de ELSE o.commodity_group3 END as commodity_group3,
  	CASE WHEN cg4.title_de is not null THEN cg4.title_de ELSE o.commodity_group4 END as commodity_group4,
  	CASE WHEN cg5.title_de is not null THEN cg5.title_de ELSE o.commodity_group5 END as commodity_group5,
  	o.commodity_group6,
	o.buyer,
	o.country_of_origin,
	o.country_of_production,
	o.processing_code,
	o.basic_unit,
	o.color1,
	o.color2,
	o.color3,
	o.supplier_sku,
	o.supplier_article_name,
	o.supplier_color_code,
	o.supplier_color_name,
	o.purchase_price,
	o.push_types,
	o.price_retail_benelux,
	o.price_retail_original_benelux,
	o.price_retail_chf,
	o.price_retail_original_chf,
	o.price_retail_dkk,
	o.price_retail_original_dkk,
	o.price_retail_sek,
	o.price_retail_original_sek,
	o.net_weight,
	o.gross_weight,
	o.check_tariff_numbers,
	cast(o.additional_levy as string) as additional_levy,
	o.customs_tariff_number,
	cast(o.country_block as string) as country_block,
	o.supplier_finish,
	o.pic1,
	o.pic2,
	o.pic3,
	o.color1_shade,
	o.nos,
	o.season,
	o.check_material_style_attributes,
	o.check_fitting,
	o.pic4,
	o.amidala_deactive,
	o.check_schulung,
	cast(o.amidala_categories as string) as amidala_categories,
	o.check_details,
	o.price_retail_de,
	o.price_retail_at,
	case when o.price_retail_ch is null or o.price_retail_ch=6110209100 then 0 else cast(o.price_retail_ch as double) end as price_retail_ch,
	o.price_retail_original,
	o.supplier_size,
	o.eu_size,
	o.supplier_length,
	o.eu_length,
	o.alternative_supplier_sku,
	o.amidala_check,
	o.pic5,
	FROM_UNIXTIME(cast(o.date as integer)) as ""date"",
	FROM_UNIXTIME(cast(o.latest_delivery_date as integer)) as latest_delivery_date,
	FROM_UNIXTIME(cast(o.earliest_delivery_date as integer)) as earliest_delivery_date,
	FROM_UNIXTIME(cast(o.o_creationDate as integer)) as o_creationDate,
	FROM_UNIXTIME(cast(o.o_modificationDate as integer)) as o_modificationDate,
	FROM_UNIXTIME(cast(o.date_available as integer)) as date_available,
	o.pic6,
	o.hanging_garments,
	o.pic_raw,
	o.push,
	o.reduced,
	o.season_start,
	o.net_weight_gram,
	o.gross_weight_gram,
	case when o.de_customs_tarff_number is null then 0 else cast(o.de_customs_tarff_number as bigint) end as de_customs_tarff_number,
	case when o.ch_customs_tariff_number is null then 0 else cast(o.ch_customs_tariff_number as bigint) end as ch_customs_tariff_number,
	o.percentage1_upper_fabric,
	o.upper_fabric_share1,
	o.percentage2_upper_fabric,
	o.upper_fabric_share2,
	o.percentage3_upper_fabric,
	o.upper_fabric_share3,
	o.percentage4_upper_fabric,
	o.upper_fabric_share4,
	o.age, 
	substring(cast(o.style as string), 2, (Length(cast (o.style as string)) -2)) as style,
	o.activation_ch,
	o.core_article,
	o.o_id,
	o.o_parentId,
	o.o_type,
	o.o_key,
	o.o_path,
	o.o_index,
	o.o_published,
	o.o_userOwner,
	o.o_userModification,
	o.o_classId,
	o.o_className, 
	o.promotion_item,
	o.production_textile,
	o.reason_deactive,
	guertel_closure_accessories,
	guertel_special_charakteristics_accessories,
	guertel_details,
	handschuhe_closure_accessories,
	handschuhe_special_charakteristics_accessories,
	handschuhe_details,
	closure_trousers,
	trousers_pocket,
	trousers_crease,
	trousers_tuck,
	special_attributes_trousers,
	trousers_details,
	konfektion_collar,
	konfektion_closure_tops,
	konfektion_closure_trousers,
	konfektion_slit,
	konfektion_pockets_tops,
	konfektion_trousers_pocket,
	konfektion_crease,
	konfektion_tuck,
	konfektion_special_attributes_tops,
	konfektion_special_attributes_trousers,
	konfektion_details,
	Kopfaccessoires_circumference_cm,
	Kopfaccessoires_closure_accessories,
	Kopfaccessoires_special_charakteristics_accessories,
	Kopfaccessoires_details,
	KrawatteFliege_lenght_cm,
	KrawatteFliege_width_cm,
	KrawatteFliege_width,
	KrawatteFliege_special_charakteristics_accessories,
	KrawatteFliege_details,
	Oberteile_type_print,
	Oberteile_closure_tops,
	Oberteile_pockets_tops,
	Oberteile_collar,
	Oberteile_hood,
	Oberteile_slit,
	Oberteile_special_attributes_tops,
	Oberteile_details,
	Oberteile_quality_print,
	Outdoor_closure_tops,
	Outdoor_collar,
	Outdoor_slit,
	Outdoor_hood,
	Outdoor_pockets_tops,
	Outdoor_special_attributes_tops,
	Outdoor_Oberteile_details,
	Schunhe_toe_shoes,
	Schuhe_closure_shoes,
	Schuhe_height_upper_cm,
	Schuhe_width_upper_cm,
	Schuhe_height_heel_cm,
	Schuhe_heel,
	Schuhe_footbed,
	Schuhe_details,
	Socken_details,
	TuecherSchals_lenght_cm,
	TuecherSchals_width_cm,
	TuecherSchals_diameter_cm,
	TuecherSchals_special_charakteristics_accessories,
	TuecherSchals_details,
	Hosen_lenght_pants,
	Hosen_fit,
	Hosen_waist_line,
	Hosen_crotch,
	Hosen_fitting_trousers,
	Hosen_fitting_extras,
	Hosen_fitting_normalizer,
	Konfektion_fit,
	Konfektion_blazer_length,
	Konfektion_fitting_top,
	Konfektion_fitting_trousers,
	Konfektion_fitting_extras,
	Konfektion_waist_line,
	Konfektion_fitting_normalizer,
	Oberteile_sleeve_length,
	Oberteile_fit,
	Oberteile_fitting_top,
	Oberteile_fitting_extras,
	Oberteile_fitting_normalizer,
	Oberteile_lenght_top,
	Oberteile_sleeves_length,
	Outdoor_fit,
	Outdoor_length_coat,
	Outdoor_fitting_extras,
	Outdoor_fitting_normalizer,
	Outdoor_fitting_top,
	Schuhe_width_shoes,
	Schuhe_fitting_shoes,
	Schuhe_fitting_normalizer,
	Schuhe_fitting_extras,
	Guertel_percentage1_upper_fabric,
	Guertel_upper_fabric_share1,
	Guertel_production_information,
	Guertel_pattern,
	Guertel_finish_metal,
	Guertel_finish_leather,
	Guertel_quality_upper_fabric,
	Guertel_quality_finishing,
	Guertel_outfittery_occasion,
	Guertel_outfittery_style,
	Guertel_percentage2_upper_fabric,
	Guertel_upper_fabric_share2,
	AccessoiresTextil_percentage1_upper_fabric,
	AccessoiresTextil_percentage2_upper_fabric,
	AccessoiresTextil_upper_fabric_share2,
	AccessoiresTextil_percentage1_material_lining,
	AccessoiresTextil_material_lining_share1,
	AccessoiresTextil_materialname_fabric_upper,
	AccessoiresTextil_care_instructions,
	AccessoiresTextil_production_information,
	AccessoiresTextil_pattern,
	AccessoiresTextil_fineness_of_material,
	AccessoiresTextil_finish_textile,
	AccessoiresTextil_quality_upper_fabric,
	AccessoiresTextil_quality_finishing,
	AccessoiresTextil_outfittery_style,
	AccessoiresTextil_outfittery_occasion,
	AccessoiresTextil_upper_fabric_share1,
	AccessoiresTextil_percentage3_upper_fabric,
	AccessoiresTextil_upper_fabric_share3,
	AccessoiresTextil_percentage2_material_lining,
	AccessoiresTextil_material_lining_share2,
	AccessoiresTextil_elasticity,
	AccessoiresTextil_outfittery_upper_fabric,
	AccessoiresTextil_lining_textile,
	StyleBekleidung_pattern,
	StyleBekleidung_care_instructions,
	StyleBekleidung_production_information,
	StyleBekleidung_lining_textile,
	StyleBekleidung_materialname_fabric_upper,
	StyleBekleidung_outfittery_upper_fabric,
	StyleBekleidung_fineness_of_material,
	StyleBekleidung_quality_upper_fabric,
	StyleBekleidung_quality_finishing,
	StyleBekleidung_finish_textile,
	StyleBekleidung_elasticity,
	StyleBekleidung_outfittery_style,
	StyleBekleidung_outfittery_occasion,
	StyleBekleidung_upper_fabric_share1,
	StyleBekleidung_percentage1_upper_fabric,
	StyleBekleidung_percentage2_upper_fabric,
	StyleBekleidung_upper_fabric_share2,
	StyleBekleidung_material_lining_share1,
	StyleBekleidung_percentage1_material_lining,
	StyleBekleidung_percentage3_upper_fabric,
	StyleBekleidung_upper_fabric_share3,
	StyleBekleidung_percentage2_material_lining,
	StyleBekleidung_material_lining_share2,
	StyleBekleidung_percentage4_upper_fabric,
	StyleBekleidung_upper_fabric_share4,
	StyleBekleidung_material_extra,
	StyleBekleidung_percentage1_material_sleeve_lining,
	StyleBekleidung_material_sleeve_lining,
	StyleSchuhe_upper_material_shoes,
	StyleSchuhe_lining_shoes,
	StyleSchuhe_innersole_shoes,
	StyleSchuhe_soletype_shoes,
	StyleSchuhe_pattern,
	StyleSchuhe_finish_leather,
	StyleSchuhe_quality_upper_fabric,
	StyleSchuhe_quality_finishing,
	StyleSchuhe_outfittery_style,
	StyleSchuhe_outfittery_occasion,
	StyleSchuhe_production_information,
	StyleSchuhe_sole_shoes,
	StyleSchuhe_inner_material_shoes
FROM pim.object_17 o
JOIN pim.object_17 as parent ON parent.o_id = o.o_parentId
JOIN pim.object_17 as parent_parent ON parent_parent.o_id = parent.o_parentId
LEFT JOIN dwh.brands b on b.name_db = o.brand 
LEFT JOIN dwh.commodity_group1 cg1 ON cg1.commodity_group1 = o.commodity_group1
LEFT JOIN dwh.commodity_group2 cg2 ON cg2.commodity_group2 = o.commodity_group2
LEFT JOIN dwh.commodity_group3 cg3 ON cg3.commodity_group3 = o.commodity_group3
LEFT JOIN dwh.commodity_group4 cg4 ON cg4.commodity_group4 = o.commodity_group4
LEFT JOIN dwh.commodity_group5 cg5 ON cg5.commodity_group5 = o.commodity_group5
LEFT JOIN 
(
	SELECT 
		o_id,
		belt_width_cm,
		SUBSTRING(cast(closure_accessories as varchar), 2,(Length(cast(closure_accessories as varchar))-2)) as ""guertel_closure_accessories"",
		SUBSTRING(cast(special_charakteristics_accessories as varchar), 2,(Length(cast(special_charakteristics_accessories as varchar))-2)) as ""guertel_special_charakteristics_accessories"",
		cast(details as varchar) as ""guertel_details"" 
	FROM pim.object_brick_query_DetailsGuertel_17
	) DetailsGuertel on DetailsGuertel.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		lenght_cm,
		SUBSTRING(cast(closure_accessories as varchar), 2,(Length(cast(closure_accessories as varchar))-2)) as ""handschuhe_closure_accessories"",
		SUBSTRING(cast(special_charakteristics_accessories as varchar), 2,(Length(cast(special_charakteristics_accessories as varchar))-2)) as ""handschuhe_special_charakteristics_accessories"",
		cast(details as varchar) as ""handschuhe_details"" 
	FROM ""pim"".""object_brick_query_DetailsHandschuhe_17""
) DetailsHandschuhe on DetailsHandschuhe.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		SUBSTRING(cast(closure_trousers as varchar), 2,(Length(cast(closure_trousers as varchar))-2)) as ""closure_trousers"",
		SUBSTRING(cast(trousers_pocket as varchar), 2,(Length(cast(trousers_pocket as varchar))-2)) as ""trousers_pocket"",
		cast(crease as boolean) as trousers_crease,
		cast(tuck as boolean) as trousers_tuck,
		SUBSTRING(cast(special_attributes_trousers as varchar), 2,(Length(cast(special_attributes_trousers as varchar))-2)) as ""special_attributes_trousers"",
		cast(details as varchar) as ""trousers_details"" 
	FROM ""pim"".""object_brick_query_DetailsHosen_17""
) DetailsHosen on DetailsHosen.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		SUBSTRING(cast(collar as varchar), 2,(Length(cast(collar as varchar))-2)) as konfektion_collar,
		SUBSTRING(cast(closure_tops as varchar), 2,(Length(cast(closure_tops as varchar))-2)) as konfektion_closure_tops,
		SUBSTRING(cast(closure_trousers as varchar), 2,(Length(cast(closure_trousers as varchar))-2)) as konfektion_closure_trousers,
		cast(slit as varchar) as konfektion_slit,
		SUBSTRING(cast(pockets_tops as varchar), 2,(Length(cast(pockets_tops as varchar))-2)) as konfektion_pockets_tops,
		SUBSTRING(cast(trousers_pocket as varchar), 2,(Length(cast(trousers_pocket as varchar))-2)) as konfektion_trousers_pocket,
		cast(crease as boolean) as konfektion_crease,
		cast(tuck as varchar) as konfektion_tuck,
		SUBSTRING(cast(special_attributes_tops as varchar), 2,(Length(cast(special_attributes_tops as varchar))-2)) as konfektion_special_attributes_tops,
		SUBSTRING(cast(special_attributes_trousers as varchar), 2,(Length(cast(special_attributes_trousers as varchar))-2)) as konfektion_special_attributes_trousers,
		cast(details as varchar) as konfektion_details
	FROM ""pim"".""object_brick_query_DetailsKonfektion_17""
) DetailsKonfektion on DetailsKonfektion.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		cast(circumference_cm as string) as Kopfaccessoires_circumference_cm,
		SUBSTRING(cast(closure_accessories as varchar), 2,(Length(cast(closure_accessories as varchar))-2)) as Kopfaccessoires_closure_accessories,
		SUBSTRING(cast(special_charakteristics_accessories as varchar), 2,(Length(cast(special_charakteristics_accessories as varchar))-2)) as Kopfaccessoires_special_charakteristics_accessories,
		cast(details as varchar) as Kopfaccessoires_details 
	FROM ""pim"".""object_brick_query_DetailsKopfaccessoires_17""
) DetailsKopfaccessoires on DetailsKopfaccessoires.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		cast(lenght_cm as string) as KrawatteFliege_lenght_cm,
		cast(width_cm as string) as KrawatteFliege_width_cm,
		cast(width as string) as KrawatteFliege_width,
		SUBSTRING(cast(special_charakteristics_accessories as varchar), 2,(Length(cast(special_charakteristics_accessories as varchar))-2)) as KrawatteFliege_special_charakteristics_accessories,
		cast(details as varchar) as KrawatteFliege_details 
	FROM ""pim"".""object_brick_query_DetailsKrawatteFliege_17""
) KrawatteFliege on KrawatteFliege.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		SUBSTRING(cast(type_print as varchar), 2,(Length(cast(type_print as varchar))-2)) as Oberteile_type_print,
		SUBSTRING(cast(closure_tops as varchar), 2,(Length(cast(closure_tops as varchar))-2)) as Oberteile_closure_tops,
		SUBSTRING(cast(pockets_tops as varchar), 2,(Length(cast(pockets_tops as varchar))-2)) as Oberteile_pockets_tops,
		SUBSTRING(cast(collar as varchar), 2,(Length(cast(collar as varchar))-2)) as Oberteile_collar,
		SUBSTRING(cast(hood as varchar), 2,(Length(cast(hood as varchar))-2)) as Oberteile_hood,
		cast(slit as string) as Oberteile_slit,
		SUBSTRING(cast(special_attributes_tops as varchar), 2,(Length(cast(special_attributes_tops as varchar))-2)) as Oberteile_special_attributes_tops,
		cast(details as varchar) as Oberteile_details,
		cast(quality_print as string) as Oberteile_quality_print 
	FROM ""pim"".""object_brick_query_DetailsOberteile_17""
) DetailsOberteile on DetailsOberteile.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		SUBSTRING(cast(closure_tops as varchar), 2,(Length(cast(closure_tops as varchar))-2)) as Outdoor_closure_tops,
		SUBSTRING(cast(collar as varchar), 2,(Length(cast(collar as varchar))-2)) as Outdoor_collar,
		cast(slit as string) as Outdoor_slit,
		SUBSTRING(cast(hood as varchar), 2,(Length(cast(hood as varchar))-2)) as Outdoor_hood,
		SUBSTRING(cast(pockets_tops as varchar), 2,(Length(cast(pockets_tops as varchar))-2)) as Outdoor_pockets_tops,
		SUBSTRING(cast(special_attributes_tops as varchar), 2,(Length(cast(special_attributes_tops as varchar))-2)) as Outdoor_special_attributes_tops,
		cast(details as varchar) as Outdoor_Oberteile_details
	FROM ""pim"".""object_brick_query_DetailsOutdoor_17""
) DetailsOutdoor on DetailsOutdoor.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		cast(toe_shoes as string) as Schunhe_toe_shoes,
		SUBSTRING(cast(closure_shoes as varchar), 2,(Length(cast(closure_shoes as varchar))-2)) as Schuhe_closure_shoes,
		cast(height_upper_cm as string) as Schuhe_height_upper_cm,
		cast(width_upper_cm as string) as Schuhe_width_upper_cm,
		cast(height_heel_cm as string) as Schuhe_height_heel_cm,
		cast(heel as boolean) as Schuhe_heel,
		SUBSTRING(cast(footbed as varchar), 2,(Length(cast(footbed as varchar))-2)) as Schuhe_footbed,
		cast(details as varchar) as Schuhe_details 
	FROM ""pim"".""object_brick_query_DetailsSchuhe_17""
	) DetailsSchuhe on DetailsSchuhe.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		cast(details as varchar) as Socken_details 
	FROM ""pim"".""object_brick_query_DetailsSocken_17""
) DetailsSocken on DetailsSocken.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		cast(lenght_cm as string) as TuecherSchals_lenght_cm,
		cast(width_cm as string) as TuecherSchals_width_cm,
		cast(diameter_cm as string) as TuecherSchals_diameter_cm,
		SUBSTRING(cast(special_charakteristics_accessories as varchar), 2,(Length(cast(special_charakteristics_accessories as varchar))-2)) as TuecherSchals_special_charakteristics_accessories,
		cast(details as varchar) as TuecherSchals_details 
	FROM ""pim"".""object_brick_query_DetailsTuecherSchals_17""
) DetailsTuecherSchals on DetailsTuecherSchals.o_id = o.o_parentId
LEFT JOIN
(
	SELECT o_id,
		SUBSTRING(cast(special_characteristics_underwear as varchar), 2,(Length(cast(special_characteristics_underwear as varchar))-2)) as Unterhosen_special_characteristics_underwear,
		cast(details as varchar) as Unterhosen_details 
	FROM ""pim"".""object_brick_query_DetailsUnterhosen_17""
) DetailsUnterhosen on DetailsUnterhosen.o_id = o.o_parentId 
LEFT JOIN
(
	SELECT o_id,
		cast(lenght_pants as string) as Hosen_lenght_pants,
		cast(fit as string) as Hosen_fit,
		cast(waist_line as string) as Hosen_waist_line,
		cast(crotch as string) as Hosen_crotch,
		SUBSTRING(cast(fitting_trousers as varchar), 2,(Length(cast(fitting_trousers as varchar))-2)) as Hosen_fitting_trousers,
		SUBSTRING(cast(fitting_extras as varchar), 2,(Length(cast(fitting_extras as varchar))-2)) as Hosen_fitting_extras,
		cast(fitting_normalizer as string) as Hosen_fitting_normalizer
	FROM ""pim"".""object_brick_query_FittingHosen_17""
) FittingHosen ON FittingHosen.o_id = o.o_parentId 
LEFT JOIN
(
	SELECT o_id,
		cast(fit as string) as Konfektion_fit,
		cast(blazer_length as string) as Konfektion_blazer_length,
		SUBSTRING(cast(fitting_top as varchar), 2,(Length(cast(fitting_top as varchar))-2)) as Konfektion_fitting_top,
		SUBSTRING(cast(fitting_trousers as varchar), 2,(Length(cast(fitting_trousers as varchar))-2)) as Konfektion_fitting_trousers,
		SUBSTRING(cast(fitting_extras as varchar), 2,(Length(cast(fitting_extras as varchar))-2)) as Konfektion_fitting_extras,
		cast(waist_line as string) as Konfektion_waist_line,
		cast(fitting_normalizer as string) as Konfektion_fitting_normalizer
	FROM ""pim"".""object_brick_query_FittingKonfektion_17""
) FittingKonfektion on FittingKonfektion.o_id = o.o_parentId 
LEFT JOIN
(
	SELECT o_id,
		SUBSTRING(cast(sleeve_length as varchar), 2,(Length(cast(sleeve_length as varchar))-2)) as Oberteile_sleeve_length,
		cast(fit as string) as Oberteile_fit,
		SUBSTRING(cast(fitting_top as varchar), 2,(Length(cast(fitting_top as varchar))-2)) as Oberteile_fitting_top,
		SUBSTRING(cast(fitting_extras as varchar), 2,(Length(cast(fitting_extras as varchar))-2)) as Oberteile_fitting_extras,
		cast(fitting_normalizer as string) as Oberteile_fitting_normalizer,
		cast(lenght_top as string) as Oberteile_lenght_top,
		cast(width_top as string) as Oberteile_width_top,
		cast(sleeves_length as string) as Oberteile_sleeves_length
	FROM ""pim"".""object_brick_query_FittingOberteile_17""
) FittingOberteile on FittingOberteile.o_id = o.o_parentId 
LEFT JOIN
(
	SELECT o_id,
		cast(fit as string) as Outdoor_fit,
		cast(length_coat as string) as Outdoor_length_coat,
		SUBSTRING(cast(fitting_extras as varchar), 2,(Length(cast(fitting_extras as varchar))-2)) as Outdoor_fitting_extras,
		cast(fitting_normalizer as string) as Outdoor_fitting_normalizer,
		cast(fitting_top as string) as Outdoor_fitting_top
	FROM ""pim"".""object_brick_query_FittingOutdoor_17""
) FittingOutdoor on FittingOutdoor.o_id = o.o_parentId 
LEFT JOIN
(
	SELECT o_id,
		cast(width_shoes as string) as Schuhe_width_shoes,
		SUBSTRING(cast(fitting_shoes as varchar), 2,(Length(cast(fitting_shoes as varchar))-2)) as Schuhe_fitting_shoes,
		cast(fitting_normalizer as string) as Schuhe_fitting_normalizer,
		SUBSTRING(cast(fitting_extras as varchar), 2,(Length(cast(fitting_extras as varchar))-2)) as Schuhe_fitting_extras
	FROM ""pim"".""object_brick_query_FittingSchuhe_17""
) FittingSchuhe on FittingSchuhe.o_id = o.o_parentId 
LEFT JOIN
(
	SELECT o_id,
		cast(percentage1_upper_fabric as string) as Guertel_percentage1_upper_fabric,
		cast(upper_fabric_share1 as string) as Guertel_upper_fabric_share1,
		SUBSTRING(cast(production_information as varchar), 2,(Length(cast(production_information as varchar))-2)) as Guertel_production_information,
		SUBSTRING(cast(pattern as varchar), 2,(Length(cast(pattern as varchar))-2)) as Guertel_pattern,
		SUBSTRING(cast(finish_metal as varchar), 2,(Length(cast(finish_metal as varchar))-2)) as Guertel_finish_metal,
		SUBSTRING(cast(finish_leather as varchar), 2,(Length(cast(finish_leather as varchar))-2)) as Guertel_finish_leather,
		cast(quality_upper_fabric as string) as Guertel_quality_upper_fabric,
		cast(quality_finishing as string) as Guertel_quality_finishing,
		SUBSTRING(cast(outfittery_occasion as varchar), 2,(Length(cast(outfittery_occasion as varchar))-2)) as Guertel_outfittery_occasion,
		SUBSTRING(cast(outfittery_style as varchar), 2,(Length(cast(outfittery_style as varchar))-2)) as Guertel_outfittery_style,
		cast(percentage2_upper_fabric as string) as Guertel_percentage2_upper_fabric,
		cast(upper_fabric_share2 as string) as Guertel_upper_fabric_share2
	FROM ""pim"".""object_brick_query_MaterialStyleAccessoiresGuertel_17""
) AccessoiresGuertel on AccessoiresGuertel.o_id = o.o_parentId 
LEFT JOIN
(
	SELECT o_id,
		cast(percentage1_upper_fabric as string) as AccessoiresTextil_percentage1_upper_fabric,
		cast(percentage2_upper_fabric as string) as AccessoiresTextil_percentage2_upper_fabric, 
		cast(upper_fabric_share2 as string) as AccessoiresTextil_upper_fabric_share2,
		cast(percentage1_material_lining as string) as AccessoiresTextil_percentage1_material_lining,
		cast(material_lining_share1 as string) as AccessoiresTextil_material_lining_share1,
		SUBSTRING(cast(materialname_fabric_upper as varchar), 2,(Length(cast(materialname_fabric_upper as varchar))-2)) as AccessoiresTextil_materialname_fabric_upper,
		SUBSTRING(cast(care_instructions as varchar), 2,(Length(cast(care_instructions as varchar))-2)) as AccessoiresTextil_care_instructions,
		SUBSTRING(cast(production_information as varchar), 2,(Length(cast(production_information as varchar))-2)) as AccessoiresTextil_production_information,
		SUBSTRING(cast(pattern as varchar), 2,(Length(cast(pattern as varchar))-2)) as AccessoiresTextil_pattern,
		cast(fineness_of_material as string) as AccessoiresTextil_fineness_of_material,
		SUBSTRING(cast(finish_textile as varchar), 2,(Length(cast(finish_textile as varchar))-2)) as AccessoiresTextil_finish_textile,
		cast(quality_upper_fabric as string) as AccessoiresTextil_quality_upper_fabric,
		cast(quality_finishing as string) as AccessoiresTextil_quality_finishing,
		SUBSTRING(cast(outfittery_style as varchar), 2,(Length(cast(outfittery_style as varchar))-2)) as AccessoiresTextil_outfittery_style, 
		SUBSTRING(cast(outfittery_occasion as varchar), 2,(Length(cast(outfittery_occasion as varchar))-2)) as AccessoiresTextil_outfittery_occasion,
		cast(upper_fabric_share1 as string) as AccessoiresTextil_upper_fabric_share1,
		cast(percentage3_upper_fabric as string) as AccessoiresTextil_percentage3_upper_fabric,
		cast(upper_fabric_share3 as string) as AccessoiresTextil_upper_fabric_share3,
		cast(percentage2_material_lining as string) as AccessoiresTextil_percentage2_material_lining,
		cast(material_lining_share2 as string) as AccessoiresTextil_material_lining_share2,
		cast(elasticity as string) as AccessoiresTextil_elasticity,
		SUBSTRING(cast(outfittery_upper_fabric as varchar), 2,(Length(cast(outfittery_upper_fabric as varchar))-2)) as AccessoiresTextil_outfittery_upper_fabric,
		SUBSTRING(cast(lining_textile as varchar), 2,(Length(cast(lining_textile as varchar))-2)) as AccessoiresTextil_lining_textile
	FROM ""pim"".""object_brick_query_MaterialStyleAccessoiresTextil_17""
) AccessoiresTextil on AccessoiresTextil.o_id = o.o_parentId 
LEFT JOIN
(
	SELECT o_id,
		SUBSTRING(cast(pattern as varchar), 2,(Length(cast(pattern as varchar))-2)) as StyleBekleidung_pattern,
		SUBSTRING(cast(care_instructions as varchar), 2,(Length(cast(care_instructions as varchar))-2)) as StyleBekleidung_care_instructions,
		SUBSTRING(cast(production_information as varchar), 2,(Length(cast(production_information as varchar))-2)) as StyleBekleidung_production_information,
		SUBSTRING(cast(lining_textile as varchar), 2,(Length(cast(lining_textile as varchar))-2)) as StyleBekleidung_lining_textile,
		SUBSTRING(cast(materialname_fabric_upper as varchar), 2,(Length(cast(materialname_fabric_upper as varchar))-2)) as StyleBekleidung_materialname_fabric_upper,
		SUBSTRING(cast(outfittery_upper_fabric as varchar), 2,(Length(cast(outfittery_upper_fabric as varchar))-2)) as StyleBekleidung_outfittery_upper_fabric,
		cast(fineness_of_material as string) as StyleBekleidung_fineness_of_material,
		cast(quality_upper_fabric as string) as StyleBekleidung_quality_upper_fabric,
		cast(quality_finishing as string) as StyleBekleidung_quality_finishing,
		SUBSTRING(cast(finish_textile as varchar), 2,(Length(cast(finish_textile as varchar))-2)) as StyleBekleidung_finish_textile,
		cast(elasticity as string) as StyleBekleidung_elasticity,
		SUBSTRING(cast(outfittery_style as varchar), 2,(Length(cast(outfittery_style as varchar))-2)) as StyleBekleidung_outfittery_style,
		SUBSTRING(cast(outfittery_occasion as varchar), 2,(Length(cast(outfittery_occasion as varchar))-2)) as StyleBekleidung_outfittery_occasion,
		cast(upper_fabric_share1 as string) as StyleBekleidung_upper_fabric_share1,
		cast(percentage1_upper_fabric as string) as StyleBekleidung_percentage1_upper_fabric,
		cast(percentage2_upper_fabric as string) as StyleBekleidung_percentage2_upper_fabric,
		cast(upper_fabric_share2 as string) as StyleBekleidung_upper_fabric_share2,
		cast(material_lining_share1 as string) as StyleBekleidung_material_lining_share1,
		cast(percentage1_material_lining as string) as StyleBekleidung_percentage1_material_lining,
		cast(percentage3_upper_fabric as string) as StyleBekleidung_percentage3_upper_fabric,
		cast(upper_fabric_share3 as string) as StyleBekleidung_upper_fabric_share3,
		cast(percentage2_material_lining as string) as StyleBekleidung_percentage2_material_lining,
		cast(material_lining_share2 as string) as StyleBekleidung_material_lining_share2,
		cast(percentage4_upper_fabric as string) as StyleBekleidung_percentage4_upper_fabric,
		cast(upper_fabric_share4 as string) as StyleBekleidung_upper_fabric_share4,
		SUBSTRING(cast(material_extra as varchar), 2,(Length(cast(material_extra as varchar))-2)) as StyleBekleidung_material_extra,
		cast(percentage1_material_sleeve_lining as string) as StyleBekleidung_percentage1_material_sleeve_lining,
		cast(material_sleeve_lining as string) as StyleBekleidung_material_sleeve_lining
	FROM ""pim"".""object_brick_query_MaterialStyleBekleidung_17""
) MaterialStyleBekleidung on MaterialStyleBekleidung.o_id = o.o_parentId 
LEFT JOIN
(
	SELECT o_id,
		SUBSTRING(cast(upper_material_shoes as varchar), 2,(Length(cast(upper_material_shoes as varchar))-2)) as StyleSchuhe_upper_material_shoes,
		cast(lining_shoes as string) as StyleSchuhe_lining_shoes,
		SUBSTRING(cast(innersole_shoes as varchar), 2,(Length(cast(innersole_shoes as varchar))-2)) as StyleSchuhe_innersole_shoes, 
		SUBSTRING(cast(soletype_shoes as varchar), 2,(Length(cast(soletype_shoes as varchar))-2)) as StyleSchuhe_soletype_shoes,
		SUBSTRING(cast(pattern as varchar), 2,(Length(cast(pattern as varchar))-2)) as StyleSchuhe_pattern,
		SUBSTRING(cast(finish_leather as varchar), 2,(Length(cast(finish_leather as varchar))-2)) as StyleSchuhe_finish_leather,
		cast(quality_upper_fabric as string) as StyleSchuhe_quality_upper_fabric,
		cast(quality_finishing as string) as StyleSchuhe_quality_finishing,
		SUBSTRING(cast(outfittery_style as varchar), 2,(Length(cast(outfittery_style as varchar))-2)) as StyleSchuhe_outfittery_style,
		SUBSTRING(cast(outfittery_occasion as varchar), 2,(Length(cast(outfittery_occasion as varchar))-2)) as StyleSchuhe_outfittery_occasion,
		SUBSTRING(cast(production_information as varchar), 2,(Length(cast(production_information as varchar))-2)) as StyleSchuhe_production_information,
		cast(sole_shoes as string) as StyleSchuhe_sole_shoes,
		SUBSTRING(cast(inner_material_shoes as varchar), 2,(Length(cast(inner_material_shoes as varchar))-2)) as StyleSchuhe_inner_material_shoes
	FROM ""pim"".""object_brick_query_MaterialStyleSchuhe_17""
) MaterialStyleSchuhe on MaterialStyleSchuhe.o_id = o.o_parentId"	READY
49	2015-04-24 18:17:21	"1112787647"	true	2015-04-24 18:17:21	views.stock_entry		"CREATE view views.stock_entry 
AS 
SELECT 
	CAST(curdate() AS DATE) as date_created, 
	quantity, 
	reserved, 
	sku 
FROM postgres.stock_entry se
WHERE stock_location_id=2"	READY
108	2015-04-24 18:17:51	"1112787675"	true	2015-04-24 18:17:51	raw.customer_order_state_number		"CREATE VIEW raw.customer_order_state_number AS

/*	CERTAIN FIELDS ARE BEING BROUGHT INTO THIS QUERY THAT WOULD OTHERWISE COME DIRECTLY FROM BI.CUSTOMER_ORDER. THE REASON FOR THAT IS BECAUSE THIS IS UPDATED HOURLY, NOT DAILY */

SELECT 
  	co.id AS order_id,
  	co.state AS order_state_number,
  	co.date_created,
  	co.date_picked AS date_stylist_picked,
  	ad.country AS shipping_country
FROM 
  	postgres.customer_order co
  	JOIN
  	postgres.address ad
  		ON co.shipping_address_id = ad.id
  	LEFT JOIN
	(
	  	SELECT DISTINCT
	      order_id
	    FROM 
	    	postgres.order_position
	    GROUP BY 1
	    HAVING 
	    	SUM(state)/SUM(quantity) = 2048
	) op
		 ON co.id = op.order_id
WHERE 
	co.state < 1536
AND op.order_id IS NULL"	READY
111	2015-04-24 18:17:52	"1112787676"	true	2015-04-24 18:17:52	raw.delivery_tracking		"CREATE view raw.delivery_tracking
AS
SELECT 
*
FROM postgres.delivery_tracking_info"	READY
491,540	2015-08-10 15:24:06	"1141300600"	true	2015-08-10 15:24:06	desk_com_connector_example.example_show_group		create view "desk_com_connector_example"."example_show_group" as select
        *
    from
        (
            call "desk_com_connector.show_group" (
                "in_group_id" => '496868'
            )
        ) ff	READY
57	2015-04-24 18:17:24	"638184617"	true	2015-04-24 18:17:24	views.arvatopayments		"CREATE view views.arvatopayments
AS
SELECT 
	mandantid,
	debitornumber,
	journalentrytype,
	ordernumber,
	journalentrynumber,
	journalentrydate,
	cast(amount as bigdecimal) as amount,
	currency,
	dunninglevel,
	returndebitnote,
	creditcardchargeback,
	indebtcollection,
	id,
	date_created 
FROM ""dwh"".""arvato_payments"""	READY
491,541	2015-08-10 15:24:06	"1141300601"	true	2015-08-10 15:24:06	desk_com_connector_example.example_get_list_group_permissions		CREATE view "desk_com_connector_example"."example_get_list_group_permissions" as select
        *
    from
        ( call "desk_com_connector.get_list_group_permissions" ( "in_group_id" => '357346' ) ) gg	READY
131,076	2015-05-14 10:19:14	"741634196"	true	2015-05-14 10:19:14	views.scans_and_stock_mutation_agg_leveled		"create view 
views.scans_and_stock_mutation_agg_leveled
as select 1"	READY
124	2015-04-24 18:17:54	"1112787680"	true	2015-04-24 18:17:54	raw.stock_returned		"CREATE view raw.stock_returned AS

SELECT
	id AS stock_returned_id,
	CAST(original_orderid AS LONG) AS order_id,
	CAST(original_customerid AS LONG) AS customer_id,
	CAST(outfittery_article_number AS LONG) AS article_id,
	parseTimestamp(date_created, 'yyyy-MM-dd HH:mm:ss.S') AS date_stock_returned,
	parseTimestamp(last_updated, 'yyyy-MM-dd HH:mm:ss.S') AS last_updated,
	LEFT(comment, 4000) AS comment,
	CAST(condition_code AS INTEGER) AS condition_code,
	CAST(number_of_articles_return AS INTEGER) AS stock_returned,
	processing_result,
	processing_state,
	LEFT(processing_reason, 4000) AS processing_reason,
	CAST(reason_code AS INTEGER) AS reason_code,
	return_number
FROM 
	postgres.doc_data_return"	READY
131,079	2015-05-15 12:51:36	"746378929"	true	2015-05-15 12:51:36	tableau.it_nfone_data		"CREATE VIEW tableau.it_nfone_data
as

SELECT 
	cast(date_called as date) as date_called,
	call_queue,
	call_handled_by,
	phone_number,
	MAX(CASE WHEN n.call_duration > 90 THEN 'Success' ELSE 'No Success' END) as reached,
	COUNT(n.phone_number) as num_tries,
	SUM(CASE WHEN n.call_duration > 90 THEN 1 ELSE 0 END) as num_succesful_tries,
	MAX(CASE WHEN n.call_duration > 90 THEN n.call_duration ELSE null END)/60 as max_call_duration
from ""dwh.nfone_data"" n
GROUP BY 1,2,3,4"	READY
491,542	2015-08-10 15:24:07	"1141300602"	true	2015-08-10 15:24:07	desk_com_connector_example.example_show_mailbox_inbound		create view "desk_com_connector_example"."example_show_mailbox_inbound" as select
        *
    from
        (
            call "desk_com_connector.show_mailbox_inbound" (
                "in_mailbox_id" => '122661'
            )
        ) aa	READY
130	2015-04-24 18:17:55	"1112787684"	true	2015-04-24 18:17:55	raw.stock_sales_order_line		"CREATE VIEW raw.stock_sales_order_line AS

SELECT
	doc_data_sales_order_header_id AS stock_sales_order_header_id,
	CAST(orderid AS LONG) AS order_id,
	CAST(outfittery_article_number AS LONG) AS article_id,
	CAST(line_number AS INTEGER) AS line_number,
	parseTimestamp(date_created, 'yyyy-MM-dd HH:mm:ss.S') as date_stock_sales_order_line_created,
	parseTimestamp(last_updated, 'yyyy-MM-dd HH:mm:ss.S') as last_updated,
	description_in_preferred_language,
	processing_result,
	processing_state,
	quantity AS articles,
	/*----retail price information----*/
	unit_price_including_vat,
	unit_price_total_standard,
	unit_price_without_vat,
	unit_vat_price,
	vat_code,
	poid,
	supplier
FROM
	postgres.doc_data_sales_order_line"	READY
491,543	2015-08-10 15:24:07	"1141300603"	true	2015-08-10 15:24:07	desk_com_connector_example.example_show_integration_url		create view "desk_com_connector_example"."example_show_integration_url" as select
        *
    from
        (
            call "desk_com_connector.show_integration_url" (
                "in_url_id" => '349355'
            )
        ) ss	READY
491,544	2015-08-10 15:24:07	"1141300604"	true	2015-08-10 15:24:07	desk_com_connector_example.example_get_list_labels		CREATE view desk_com_connector_example.example_get_list_labels as 
select
        *
    from
        (
            call "desk_com_connector.get_list_labels" ()) ss	READY
59	2015-04-24 18:17:41	"638184620"	true	2015-04-24 18:17:41	views.z_mails		"CREATE view views.z_mails 
AS 
SELECT
	best.best_supplierorderid,
	best.kundennummer,
	best.received_date_confirmed,
	best.nb_of_articles_confirmed,
	best.zwischensumme_de,
	best.zwischensumme_chf,
	best.rabatt_de,
	best.rabatt_chf,
	best.gesamtsumme_de,
	best.gesamtsumme_chf,
	gut.gutschrift,
	gut.nb_of_articles_returned,
	gu.retoure_received_date_time,
	dhl.dhlnumber,
	dhl.shipped_recieveddate,
	dhl.subject,
	CASE 
		when dhl.subject LIKE '%Versandbesttigung%' THEN 'yes'
		ELSE 'no'
	END AS ""shipping_confirmation""
FROM 
/*Customer Order Box*/
(
	SELECT 
		CAST(kundennummer AS long) kundennummer,
		CAST(supplierorderid AS long) best_supplierorderid,
		parseTimestamp( received_date, 'yyyy-MM-dd HH:mm:ss.S' ) AS received_date_confirmed,
		COUNT(article_nr) AS nb_of_articles_confirmed,
		MIN(CAST(replace(zwischensumme_de, ',', '.') AS double)) AS zwischensumme_de,
		MIN(CAST(replace(rabatt_de, ',', '.') AS double)) AS rabatt_de,
		MIN(CAST(zwischensumme_chf AS double)) AS zwischensumme_chf,
		MIN(CAST(rabatt_chf AS double)) AS rabatt_chf,
		MIN(CAST(replace(gesamtsumme_de, ',', '.') AS double)) AS gesamtsumme_de,
		MIN(CAST(gesamtsumme_chf AS double)) AS gesamtsumme_chf
	FROM dwh.customerorderbox 
	GROUP BY 1,2,3
) best
/*All Retoure Mails*/
LEFT JOIN
(
	SELECT 
		supplierorderid,
		parseTimestamp(received_date_time, 'yyyy-MM-dd HH:mm:ss.S') AS retoure_received_date_time,
		MIN(CAST(gutschrift AS double)) AS gutschrift_de,
		MIN(CAST(gutschrift_chf AS double)) AS gutschrift_chf 
	FROM dwh.retouremails 
	GROUP BY 1,2
) gu ON gu.supplierorderid=best.best_supplierorderid
/*DHL Package Status*/
LEFT JOIN
(
	SELECT 
		distinct orderid,
		parseTimestamp( recieveddate, 'yyyy-MM-dd HH:mm:ss.S' ) AS shipped_recieveddate,
		dhlnumber,
		subject 
	FROM dwh.dhl_package_status
) dhl ON dhl.orderid=best.best_supplierorderid
/*All Retour Mails*/
LEFT JOIN
(
	SELECT
	supplierorderid,
	sum(gutschrift) gutschrift,
	sum(nb_of_articles_returned) nb_of_articles_returned 
	FROM
	(
		SELECT
			received_date_time,
			supplierorderid,
			max(CASE when CAST(gutschrift AS double) IS NULL then CAST(gutschrift_chf AS double) 
			else CAST(gutschrift AS double)end) gutschrift,
			COUNT(distinct CASE when artikel_description='Artikel' then artikel_grosse else artikel_description end) nb_of_articles_returned 
		FROM ""dwh"".""retouremails""
		GROUP BY 1,2
	)gutschrift GROUP BY 1
) gut ON gut.supplierorderid=best.best_supplierorderid"	READY
60	2015-04-24 18:17:42	"638184622"	true	2015-04-24 18:17:42	views.campaign_cost		"CREATE view views.campaign_cost
as
SELECT
	cast(date_created as date) as date_created,
	country,
    source as channel,
	campaign,
	sum(adcosts) as ""costs""
FROM dwh.ga_adcosts 
GROUP BY 1,2,3,4
UNION ALL
SELECT
	cast(datecreated as date) as date_created,
	LEFT(campaign,2) as country,
	channel,
	campaign,
	sum(cast(costs as double)) as ""costs""
FROM ""dwh.campaigncost"" 
GROUP BY 1,2,3,4"	READY
61	2015-04-24 18:17:42	"638184623"	true	2015-04-24 18:17:42	bi.stock_reconciliation		"CREATE VIEW bi.stock_reconciliation AS

SELECT
	c.date,
	se.sku,
	se.quantity,
	CASE WHEN dd.docdata_quantity is null THEN 0 ELSE dd.docdata_quantity END as docdata_quantity,
	CASE 
		WHEN se.quantity != 
			CASE WHEN dd.docdata_quantity is null THEN 0 ELSE dd.docdata_quantity END
			THEN 1 
		ELSE 0 
	END as stock_mismatch,
	se.reserved,
	CASE WHEN dd.docdata_reserved is null THEN 0 ELSE dd.docdata_reserved END as docdata_reserved
FROM 
	dwh.calendar c 
	JOIN 
	dwh.stock_entry_history se 
		 on se.date_created = c.date
	LEFT JOIN 
	dwh.stock_entry_history_dd dd 
		 on dd.date_created = c.date 
		AND dd.sku = se.sku
WHERE 
	c.date >  timestampadd(SQL_TSI_DAY, -7, curdate())
AND c.date <= curdate()
AND c.date >= '2014-12-02'"	READY
63	2015-04-24 18:17:42	"1112787650"	true	2015-04-24 18:17:42	ml.article		"CREATE VIEW ml.article AS
SELECT
a.id AS article_id,
a.model_id as model,
a.color as color,
a.active
FROM
""postgres.article"" a"	READY
117	2015-04-24 18:17:53	"1112787677"	true	2015-04-24 18:17:53	ml.attribute_push		"CREATE VIEW ml.attribute_push AS
SELECT
    a.id AS attribute_id,
    a.identifier AS attribute_identifier
FROM postgres.attribute AS a
LEFT JOIN postgres.property AS p
    ON p.id = a.property_id
WHERE p.id = 60716143
ORDER BY a.id ASC"	READY
137	2015-04-24 18:17:56	"638184751"	true	2015-04-24 18:17:56	meta.schema__raw		CREATE VIEW meta.schema__raw AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('raw', 'schema')) as a	READY
138	2015-04-24 18:17:57	"638184752"	true	2015-04-24 18:17:57	meta.schema__tableau		CREATE VIEW meta.schema__tableau AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('tableau', 'schema')) as a	READY
139	2015-04-24 18:17:57	"638184753"	true	2015-04-24 18:17:57	meta.schema__views		CREATE VIEW meta.schema__views AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('views', 'schema')) as a	READY
140	2015-04-24 18:17:57	"638184754"	true	2015-04-24 18:17:57	meta.schema__postgres		CREATE VIEW meta.schema__postgres AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('postgres', 'schema')) as a	READY
132	2015-04-24 18:17:56	"1112787685"	true	2015-04-24 18:17:56	raw.stock_sales_order_status_change		"CREATE VIEW raw.stock_sales_order_status_change AS

SELECT
	id AS stock_sales_order_status_change_id,
	/* leaving order_id as string due to bad data */
	orderid AS order_id,
	/* leaving order_id as string due to bad data */
	customerid AS customer_id,
	CAST(customer_article_number AS LONG) AS article_id,
	parseTimestamp(date_created, 'yyyy-MM-dd HH:mm:ss.S') as date_status_change,
	parseTimestamp(date_processed, 'yyyy-MM-dd HH:mm:ss.S') as date_processed,
	parseTimestamp(last_updated, 'yyyy-MM-dd HH:mm:ss.S') as last_updated,
	line_number,
	LEFT(message, 4000) AS message,
	LEFT(processing_reason, 4000) AS processing_reason,
	processing_result,
	processing_state,
	CAST(quantity_in_backorder AS SHORT) AS articles_backordered,
	CAST(quantity_on_picklist AS SHORT) AS articles_on_picklist
FROM
	postgres.doc_data_sales_order_status_change"	READY
168	2015-04-24 18:18:01	"1112787686"	true	2015-04-24 18:18:01	bi.purchase_order		"CREATE VIEW bi.purchase_order AS

SELECT
	po.*,
	poi.po_date_import_result
FROM 
	raw.purchase_order po
	LEFT JOIN
	(
		SELECT 
			purchase_order_id, MAX(po_date_import_result) AS po_date_import_result
		FROM
		  raw.purchase_order_import_result
		GROUP BY 1
	) AS poi
		ON po.purchase_order_id = poi.purchase_order_id

/*
SELECT 
	po.*,
	sl.stock_location_supplier	
FROM 
	raw.purchase_order po
	JOIN
	raw.stock_location sl
		ON po.stock_location_id = sl.stock_location_id
order by 1 desc
*/"	READY
184	2015-04-24 18:18:06	"1112787696"	true	2015-04-24 18:18:06	views.ownstock_article		"CREATE view ""views.ownstock_article""
as

SELECT
  ao.article_id,
  p.ean,
  ao.brand,
  ao.article_name,
  p.oo_id,
  p.supplier_availability,
  p.commodity_group1,
  p.commodity_group2,
  p.commodity_group3,
  p.commodity_group4,
  p.commodity_group5,
  p.country_of_production,
  p.processing_code,
  p.color1,
  p.supplier_sku,
  p.supplier_color_code,
  p.supplier_color_name,
  p.purchase_price,
  p.pic1,
  p.color1_shade,
  p.nos,
  p.season,
  p.amidala_deactive,
  p.amidala_categories,
  p.supplier_size,
  p.eu_size,
  p.supplier_length,
  p.eu_length,
  p.alternative_supplier_sku,
  p.push,
  p.reduced,
  p.season_start,
  p.net_weight_gram,
  p.gross_weight_gram,
  p.de_customs_tarff_number,
  p.ch_customs_tariff_number,
  p.age,
  p.style,
  p.core_article,
  p.o_parentId,
  p.o_published,
  p.o_creationDate,
  p.basic_unit,
  p.""date"",
  p.hanging_garments,
  p.percentage1_upper_fabric,
  p.upper_fabric_share1,
  p.percentage2_upper_fabric,
  p.upper_fabric_share2,
  p.percentage3_upper_fabric,
  p.upper_fabric_share3,
  p.percentage4_upper_fabric,
  p.upper_fabric_share4,
  p.activation_ch,
  p.o_id,
  p.o_modificationDate,
  p.o_userOwner,
  p.o_userModification,
  p.date_available,
  p.promotion_item,
  p.production_textile,
  p.reason_deactive,
  p.check_tariff_numbers,
  p.price_retail_de,
  p.price_retail_original,
  p.price_retail_chf,
  p.price_retail_original_chf,
  p.price_retail_dkk,
  p.price_retail_original_dkk,
  p.price_retail_sek,
  p.price_retail_original_sek,
  p.price_retail_benelux,
  p.price_retail_original_benelux,
  p.AccessoiresTextil_fineness_of_material,
  p.AccessoiresTextil_percentage1_upper_fabric,
  p.AccessoiresTextil_percentage2_upper_fabric,
  p.AccessoiresTextil_percentage3_upper_fabric,
  p.AccessoiresTextil_upper_fabric_share1,
  p.AccessoiresTextil_upper_fabric_share2,
  p.AccessoiresTextil_upper_fabric_share3,
  p.additional_levy,
  p.amidala_check,
  p.commodity_group6,
  p.Guertel_percentage1_upper_fabric,
  p.Guertel_percentage2_upper_fabric,
  p.Guertel_upper_fabric_share1,
  p.Guertel_upper_fabric_share2,
  p.pic2,
  p.pic3,
  p.pic4,
  p.pic5,
  p.price_retail_at,
  p.price_retail_ch,
  p.StyleBekleidung_percentage1_upper_fabric,
  p.StyleBekleidung_percentage2_upper_fabric,
  p.StyleBekleidung_percentage3_upper_fabric,
  p.StyleBekleidung_upper_fabric_share1,
  p.StyleBekleidung_upper_fabric_share2,
  p.StyleSchuhe_inner_material_shoes,
  p.StyleSchuhe_lining_shoes,
  p.StyleSchuhe_sole_shoes,
  p.StyleSchuhe_upper_material_shoes,
  p.customs_tariff_number,
  ao.MStyle_Bekleidung_upper_fabric_share3,
  ao.supplier_article_id,
  ao.supplier_article_article_id,
  ao.supplier_article_sku,
  ao.supplier_article_purchase_price,
  ao.supplier_article_ean,
  ao.supplier_article_image_url,
  ao.supplier_article_partner_shop_url,
  ao.supplier_article_manufacturer_sku,
  ao.article_title,
  ao.article_color,
  ao.article_size,
  ao.article_sku,
  ao.article_model_id,
  ao.supplier_id,
  ao.category as article_category,
  ao.article_brand,
  ao.article_ean,
  ao.MStyle_Bekleidung_percentage3_upper_fabric,
  ao.MStyle_Bekleidung_percentage4_upper_fabric,
  ao.MStyle_Bekleidung_upper_fabric_share4,
  ao.stock_type
FROM views.pim_article p
JOIN
(
	SELECT *
	FROM
	(
		SELECT 
			row_number() over (partition by a.ean order by CASE WHEN a.supplier_id = 15 THEN 1 ELSE 0 END DESC, a.supplier_id desc) as rnum,
			a.*,
			/*--Gets oo_id from pim if oo_id is null in article table*/
			CASE when a.oo_id IS NULL THEN p.oo_id else a.oo_id end as oo_id_new,
			/*--Assigns stock_type if ean is from Z-Stock or Own Stock*/
			CASE when a.oo_id IS NULL OR a1.nb_of_dup>=2 THEN 'Patner Stock' else 'Own Stock' end as stock_type
		FROM views.article a
		LEFT JOIN views.pim_article p on p.ean=a.ean
		INNER JOIN
		(
			SELECT 
				a.ean,
				count(*) AS nb_of_dup
			FROM views.article a
			WHERE a.ean IS NOT NULL
			GROUP BY 1
		)a1 on a1.ean=a.ean
	)a2  
	WHERE a2.rnum=1 and a2.oo_id_new IS NOT NULL
)ao on p.oo_id=oo_id_new"	READY
426,004	2015-08-05 09:21:52	"1117513095"	true	2015-08-05 09:21:52	raw.customer_cluster		"CREATE VIEW raw.customer_cluster
AS

/*This view has current status of customer if the customer is active or passive*/
SELECT 
	customer_id,
	cluster,
	level_1,
	""date""
FROM
(
	SELECT 
		ROW_NUMBER() OVER(PARTITION BY customer_id ORDER BY ""date"" DESC) AS rank_cust,
		customer_id,
		""date"",
		cluster, 
		level_1
	FROM mlpg.customer_states
)a
WHERE rank_cust=1"	READY
192	2015-04-24 18:18:54	"1112787702"	true	2015-04-24 18:18:54	views.outlet_store_sold		"create view views.outlet_store_sold
as
select
	cast(sold.ean as string) as ean, 
	sold.quantity_sold,
	sold.date_uploaded as sold_date_created,
	sold.purchase_price as sold_purchase_price,
	sold.price_sold as sold_price_sold,
	a.purchase_price as article_purchase_price, 
	cast(a.price_retail_de as double) as article_price_retail,
	a.article_title, 
	a.article_brand
	from  dwh.outlet_sold sold 
	left join views.article a on a.ean = sold.ean"	READY
193	2015-04-24 18:18:54	"1112787703"	true	2015-04-24 18:18:54	views.inventory_daily_cg		"CREATE VIEW views.inventory_daily_cg
AS
SELECT
	datum,  
	sum(case when cg3 = 'Schuhe' then quantity else 0 end) as c_Schuhe, 
	sum(case when cg3 = 'Outdoor' then quantity else 0 end) as c_Outdoor,	
	sum(case when cg3 = 'Kleinaccessoires' then quantity else 0 end) as c_Kleinaccessoires,
	sum(case when cg3 = 'Schlaf- und Bademode' then quantity else 0 end) as c_schlafbade,
	sum(case when cg3 = 'Konfektion' then quantity else 0 end) as c_Konfektion,
	sum(case when cg3 = 'Schuhpflege' then quantity else 0 end) as c_Schuhpflege,
	sum(case when cg3 = 'Tcher und Schals' then quantity else 0 end) as c_tuecherschals,
	sum(case when cg3 = 'Grtel' then quantity else 0 end) as c_Guertel,
	sum(case when cg3 = 'Stiefel' then quantity else 0 end) as c_Stiefel,
	sum(case when cg3 = 'Krawatten und Fliegen' then quantity else 0 end) as c_KrawattenFliegen,
	sum(case when cg3 = 'Formal wear accessories' then quantity else 0 end) as c_Formalwearaccessories,
	sum(case when cg3 = 'Kooperationen' then quantity else 0 end) as c_cooperations,
	sum(case when cg3 = 'Oberteile' then quantity else 0 end) as c_Oberteile,
	sum(case when cg3 = 'Handschuhe' then quantity else 0 end) as c_Handschuhe,
	sum(case when cg3 = 'Electronic cases' then quantity else 0 end) as c_Electroniccases,
	sum(case when cg3 = 'Kopfaccessoires' then quantity else 0 end) as c_Kopfaccessoires,
	sum(case when cg3 = 'Hosen' then quantity else 0 end) as c_Hosen,
	sum(case when cg3 = 'Taschen' then quantity else 0 end) as c_Taschen,
	sum(case when cg3 = 'Unterbekleidung' then quantity else 0 end) as c_Unterbekleidung,
	sum(case when cg3 is null then quantity else 0 end) as c_unknowncg3,
	sum(case when cg3 = 'Schuhe' then quantity*purchase_price else 0 end) as v_Schuhe,
	sum(case when cg3 = 'Outdoor' then quantity*purchase_price else 0 end) as v_Outdoor,	
	sum(case when cg3 = 'Kleinaccessoires' then quantity*purchase_price else 0 end) as v_Kleinaccessoires,
	sum(case when cg3 = 'Schlaf- und Bademode' then quantity*purchase_price else 0 end) as v_schlafbade,
	sum(case when cg3 = 'Konfektion' then quantity*purchase_price else 0 end) as v_Konfektion,
	sum(case when cg3 = 'Schuhpflege' then quantity*purchase_price else 0 end) as v_Schuhpflege,
	sum(case when cg3 = 'Tcher und Schals' then quantity*purchase_price else 0 end) as v_tuecherschals,
	sum(case when cg3 = 'Grtel' then quantity*purchase_price else 0 end) as v_Guertel,
	sum(case when cg3 = 'Stiefel' then quantity*purchase_price else 0 end) as v_Stiefel,
	sum(case when cg3 = 'Krawatten und Fliegen' then quantity*purchase_price else 0 end) as v_KrawattenFliegen,
	sum(case when cg3 = 'Formal wear accessories' then quantity*purchase_price else 0 end) as v_Formalwearaccessories,
	sum(case when cg3 = 'cooperations' then quantity*purchase_price else 0 end) as v_cooperations,
	sum(case when cg3 = 'Oberteile' then quantity*purchase_price else 0 end) as v_Oberteile,
	sum(case when cg3 = 'Handschuhe' then quantity*purchase_price else 0 end) as v_Handschuhe,
	sum(case when cg3 = 'Electronic cases' then quantity*purchase_price else 0 end) as v_Electroniccases,
	sum(case when cg3 = 'Kopfaccessoires' then quantity*purchase_price else 0 end) as v_Kopfaccessoires,
	sum(case when cg3 = 'Hosen' then quantity*purchase_price else 0 end) as v_Hosen,
	sum(case when cg3 = 'Taschen' then quantity*purchase_price else 0 end) as v_Taschen,
	sum(case when cg3 = 'Unterbekleidung' then quantity*purchase_price else 0 end) as v_Unterbekleidung,
	sum(case when cg3 is null then quantity*purchase_price else 0 end) as v_unknowncg3 
FROM 
(
	SELECT 
		seh.sku, 
		cast(date_created as date) as datum, 
		quantity, 
		p.commodity_group3 as cg3, 
		p.purchase_price 
	FROM dwh.stock_entry_history seh
	JOIN views.article a  on a.article_id = sku 
	JOIN views.pim_article p on p.ean = a.article_ean
) as inv 
GROUP BY datum"	READY
194	2015-04-24 18:18:55	"1112787704"	true	2015-04-24 18:18:55	bi.customer_order_preview_lookup		"CREATE VIEW bi.customer_order_preview_lookup
AS
/* This view matches preview articles to customer order articles to show whether preview 
articles were actually sent in an order. It's done with a few subqueries to make sure
that we don't create duplicates. Basically the data isn't perfect here, so this gives a 
best guess */

/* Third, select only the last order_position_id for a given customer_preview_position_id*/
SELECT
	MAX(x.order_position_id) as order_position_id,
	x.customer_preview_position_id
FROM 
(
	/* Second, select only one instance of a customer_preview_position_id per order_position_id */
	SELECT
		pr.order_position_id,
		pr.customer_preview_position_id
	FROM
	(
		/* First match order_positions to customer_preview_positions on article_model_id */
		SELECT 
			coa.order_position_id, 
			p.customer_preview_position_id,
			row_number() over (partition by coa.order_position_id order by p.customer_preview_position_id) as ""rnum""
		FROM raw.customer_order_articles coa
		JOIN raw.customer_order co ON co.order_id = coa.order_id
		JOIN views.article a on a.article_id = coa.article_id 
		JOIN raw.customer_preview_articles p on p.customer_preview_id = co.customer_preview_id AND p.article_model_id = a.article_model_id
	) pr 
	WHERE pr.rnum = 1
) x
GROUP BY x.customer_preview_position_id"	READY
196	2015-04-24 18:18:56	"1112787705"	true	2015-04-24 18:18:56	bi.stylist_weighted_activity		"CREATE VIEW bi.stylist_weighted_activity 
AS
SELECT 
	s.stylist_id, 
	s.date_invoiced, 
	s.shipping_country as country, 
	s.orders_for_country, 
	c.orders_for_day,
	s.orders_for_country/CAST(c.orders_for_day AS DECIMAL) AS stylist_weighted_activity
FROM
(
	SELECT  
		CAST(co.date_invoiced AS DATE) AS date_invoiced, 
		co.stylist_id, 
		co.shipping_country, 
		COUNT(DISTINCT co.order_id) orders_for_country
	FROM raw.customer_order co
	GROUP BY 1,2,3
) s
JOIN
(
	SELECT  
		CAST(co.date_invoiced AS DATE) AS date_invoiced, 
		co.stylist_id, 
		COUNT(DISTINCT co.order_id) orders_for_day
	FROM raw.customer_order co
	GROUP BY 1,2
) c ON c.stylist_id = s.stylist_id AND c.date_invoiced = s.date_invoiced"	READY
199	2015-04-24 18:18:59	"1112787707"	true	2015-04-24 18:18:59	ml.preview_articles		"CREATE VIEW ml.preview_articles AS
SELECT
	DISTINCT article_agg.preview_id,
	article_agg.date_created,
	CAST(trim(trailing ',' from replace(to_chars(article_agg.article_blob, 'UTF-8'), unescape('\n'), ',')) AS STRING) AS articles
FROM
(SELECT 
	oa.preview_id,
	oa.date_created,
	TEXTAGG(oa.article_id QUOTE '') OVER (PARTITION BY oa.preview_id) AS article_blob
FROM
(SELECT
	pa.preview_id || '_' || pa.outfit_id AS preview_id,
	p.date_created,
	pa.article_id
FROM raw.previews AS p
INNER JOIN raw.preview_articles AS pa
	ON p.preview_id = pa.preview_id) AS oa) AS article_agg"	READY
200	2015-04-24 18:19:16	"1112787708"	true	2015-04-24 18:19:16	bi.customer_order_phone_dates		"CREATE VIEW bi.customer_order_phone_dates
AS
SELECT 
	f.order_id,
	CASE 
		WHEN f.date_phone_call > TIMESTAMPADD(SQL_TSI_DAY, 30, CURDATE()) THEN null   /*Remove all stupid future dates*/
		WHEN CAST(EXTRACT(minute from f.date_phone_call) as float)/30 BETWEEN 0.0001 AND 0.9999   /*Make sure that only exact multiples of 30 minutes are used*/
		THEN TIMESTAMPADD(SQL_TSI_MINUTE, -extract(minute from f.date_phone_call), f.date_phone_call)
		ELSE f.date_phone_call
	END as date_phone_call,
	f.date_created,
	l.date_created as date_invalidated,
	f.phone_date_count,
	f.phone_date_count_desc
FROM raw.customer_order_phone_dates f
LEFT JOIN raw.customer_order_phone_dates l on f.order_id = l.order_id AND f.phone_date_count + 1 = l.phone_date_count"	READY
491,545	2015-08-10 15:24:07	"1141300605"	true	2015-08-10 15:24:07	desk_com_connector_example.example_show_label		create view "desk_com_connector_example"."example_show_label" as select
        *
    from
        (
            call "desk_com_connector.show_label" (
                "in_label_id" => '2480512'
            )
        ) ff	READY
85	2015-04-24 18:17:47	"638184652"	true	2015-04-24 18:17:47	ml.flat_brand_properties		"CREATE VIEW ml.flat_brand_properties AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('flat_brand_properties.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""flat_brand"" STRING,
		""brand_over_40"" INTEGER,
		""brand_under_40"" INTEGER,
		""price_high""  INTEGER,
		""price_medium"" INTEGER,
		""price_low"" INTEGER
		DELIMITER ',' 
		HEADER 1 
	)
""csv_table"""	READY
141	2015-04-24 18:17:57	"638184755"	true	2015-04-24 18:17:57	meta.schema__pim		CREATE VIEW meta.schema__pim AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('pim', 'schema')) as a	READY
65,567	2015-05-06 16:30:35	"712301489"	true	2015-05-07 09:36:44	sandbox.snowplow_nocall_success		"CREATE VIEW sandbox.snowplow_nocall_success
AS

SELECT * FROM
(
	SELECT
	row_number() over(partition by tr_orderid order by collector_tstamp desc) as rank,
	tr_orderid,
	collector_tstamp,
	user_id,
	page_url,
	page_referrer,
	page_urlpath,
	refr_urlquery
	FROM snowplow.events where 
	tr_orderid is not null
)a 
WHERE a.rank=1"	READY
74	2015-04-24 18:17:44	"1112787659"	true	2015-04-24 18:17:44	raw.stylist_action_tracking		"CREATE VIEW raw.stylist_action_tracking AS

/* THIS QUERY CAPTURES STYLIST ACTIONS IN ADMIDALA AND TIMES ASSOCIATED WITH THEM */

SELECT
	at.stylist_id,
	st.stylist_name,
	at.order_id,
	MIN(at2.first_pick) as first_pick,
	MAX(at2.last_pick) as last_pick,
	TIMESTAMPDIFF(SQL_TSI_MINUTE, MIN(at2.first_pick), MAX(at2.last_pick)) AS stylist_pick_minutes,
	COUNT(case when at.action = 'ARTICLE_ADD' then 1 end) AS stylist_article_adds,
	COUNT(case when at.action = 'SEARCH' then 1 end) as stylist_article_searches,
	COUNT(case when at.action = 'ARTICLE_REMOVE' then 1 end) as stylist_article_removals,
	MIN(CASE WHEN action = 'PHONE_INTERFACE_START' THEN date_created END) as date_phone_call_started,
	MAX(CASE WHEN action = 'PHONE_INTERFACE_STOP' THEN date_created END) as date_phone_call_ended
FROM postgres.action_tracking at
JOIN
	(SELECT
		at.order_id,
		at.stylist_id,
		MIN(case when at.action = 'ARTICLE_ADD' then at.date_created else null end) AS first_pick, 
		MAX(case when at.action = 'ARTICLE_ADD' then at.date_created else null end) AS last_pick
		FROM postgres.action_tracking at
		group by 1,2
	) at2 on at.order_id = at2.order_id and at.stylist_id = at2.stylist_id
LEFT JOIN
	(SELECT      
		p.id AS stylist_id,
          p.first_name  || ' ' || p.last_name AS stylist_name
          FROM postgres.principal p
          WHERE p.class='com.ps.stylelist.Stylelist'
     ) st on st.stylist_id = at.stylist_id 
where at.date_created < at2.last_pick
group by 1,2,3"	READY
76	2015-04-24 18:17:45	"638184643"	true	2015-04-24 18:17:45	sandbox.marketing_contacts		"CREATE VIEW sandbox.marketing_contacts
AS
SELECT
    CAST(u.transaction_id as long) as order_id,
    u.date_created,
    u.hour_created,
    rank() OVER (PARTITION BY u.transaction_id ORDER BY u.date_created ASC, u.hour_created ASC) as visit_count_asc,  
    rank() OVER (PARTITION BY u.transaction_id ORDER BY u.date_created DESC, u.hour_created DESC) as visit_count_desc,    
    u.country,
    lower(u.source) as source,
    lower(u.medium) as medium,
    lower(u.source) || ' / ' || lower(u.medium) as source_medium,
    lower(u.campaign) as campaign
FROM 
(
	SELECT date_created,hour_created,transaction_id,
	MAX(country) as country,
	COALESCE(MAX(CASE WHEN source = '(direct)' THEN NULL ELSE source END), '(direct)') as source,
	COALESCE(MAX(CASE WHEN medium = '(none)' THEN NULL ELSE medium END), '(none)') as medium,
	COALESCE(MAX(CASE WHEN campaign = '(not set)' THEN NULL ELSE campaign END), '(not set)') as campaign 
	FROM dwh.ga_information_utm
	GROUP BY 1,2,3
) u
                                                                                                                                                                                          LIMIT 1000000000"	READY
232	2015-04-24 18:19:25	"1112787727"	true	2015-04-24 18:19:25	ml.project_second_step		"CREATE VIEW ml.project_second_step AS
SELECT
co.order_id,
co.customer_id,
x.phone_date,
co.date_created AS customer_date_created,
CAST((co.date_picked IS NOT NULL AND co.order_state_number >= 16 AND co.order_state_number != 2048) AS FLOAT) processed,
CAST(so.notReached__c AS INTEGER) AS not_reached,
CAST(so.Telefonnummer_Falsch__c AS INTEGER) phone_number_incorrect,
so.OpsCheck__c,
CASE WHEN x.raw_days_until_phone_call > 14 AND x.raw_days_until_phone_call <= 100 THEN 1 ELSE 0 END ""phone_call_rescheduled"",
CASE WHEN x.raw_days_until_phone_call > 100 THEN 1 ELSE 0 END ""phone_call_cancelled""
FROM
raw.customer_order co
LEFT JOIN views.salesforce_opportunity so ON co.order_id = so.ExternalOrderId__c
LEFT JOIN (
	SELECT
	cc.order_id,
	CEILING(CAST(TIMESTAMPDIFF(SQL_TSI_HOUR, date_created, date_phone_call) AS FLOAT) / 24.0) AS raw_days_until_phone_call,
	CASE
	WHEN cc.date_phone_call > '2012-05-10'
		AND cc.date_phone_call < TIMESTAMPADD(SQL_TSI_MONTH, 2, curdate())
		AND cc.date_phone_call >= cc.date_created
		THEN cc.date_phone_call
	WHEN cod.original_phone_date > '2012-05-10'
		AND cod.original_phone_date < TIMESTAMPADD(SQL_TSI_MONTH, 2, curdate())
		AND cod.original_phone_date >= cc.date_created
		THEN cod.original_phone_date
	ELSE null
    END as phone_date
	FROM
	raw.customer_order cc
	LEFT JOIN raw.customer_order_details__audit_log cod ON cod.order_id = cc.order_id
) x ON x.order_id = co.order_id
WHERE co.date_created >= '2014-08-01'
AND co.date_created < '2014-11-01'
AND	co.order_type = 'First Order'
AND co.payment_type != 4
AND co.sales_channel IN ('userbackendWithDate', 'appWithDate', 'websiteWithoutDate', 'websiteWithDate', 'miniAppWithDate')
AND co.date_phone_call IS NOT NULL"	FAILED
491,546	2015-08-10 15:24:08	"1141300606"	true	2015-08-10 15:24:08	desk_com_connector_example.example_get_list_macros		CREATE view "desk_com_connector_example"."example_get_list_macros" as select
        *
    from
        (
            call "desk_com_connector.get_list_macros" ()) dd	READY
235	2015-04-24 18:19:26	"1112787728"	true	2015-06-04 13:59:25	tableau.buying_article_photographed		"CREATE VIEW tableau.buying_article_photographed AS

SELECT 
	ap.*,
	item.season,
	item.item_description,
	item.brand,
	item.parent_no
FROM 
	dwh.article_picture ap
	LEFT JOIN 
	bi.item
		 ON ap.ean = item.ean"	READY
491,547	2015-08-10 15:24:08	"1141300607"	true	2015-08-10 15:24:08	desk_com_connector_example.example_show_macros		CREATE view "desk_com_connector_example"."example_show_macros" as select
        *
    from
        (
            call "desk_com_connector.show_macros" (
                "in_macros_id" => '1458957'
            )
        ) aa	READY
81	2015-04-24 18:17:46	"638184648"	true	2015-04-24 18:17:46	ml.last50queries		"CREATE VIEW ml.last50queries AS
SELECT * FROM ""SYSADMIN.Queries""
WHERE issuer = 'lando'
ORDER BY startTime DESC
LIMIT 50"	READY
82	2015-04-24 18:17:46	"638184649"	true	2015-04-24 18:17:46	ml.flat_category		"CREATE VIEW ml.flat_category AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('ml_flat_category.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""flat_category"" STRING ,
		""outfit_slot"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
83	2015-04-24 18:17:46	"638184650"	true	2015-04-24 18:17:46	ml.amidala_category_flat		"CREATE VIEW ml.amidala_category_flat AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('ml_amidala_category_flat.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""attribute_id"" STRING ,
		""flat_category"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
491,548	2015-08-10 15:24:08	"1141300608"	true	2015-08-10 15:24:08	desk_com_connector_example.example_show_macros_action		create view "desk_com_connector_example"."example_show_macros_action" as select
        *
    from
        (
            call "desk_com_connector.show_macros_action" (
                "in_macros_id" => '1406171'
                ,"in_action_id" => '49795431'
            )
        ) d	READY
491,549	2015-08-10 15:24:08	"1141300609"	true	2015-08-10 15:24:08	desk_com_connector_example.example_show_rule		create view "desk_com_connector_example"."example_show_rule" as select
        *
    from
        (
            call "desk_com_connector.show_rule" (
                "in_rules_id" => '2910966'
            )
        ) ff	READY
491,550	2015-08-10 15:24:09	"1141300610"	true	2015-08-10 15:24:09	desk_com_connector_example.example_get_list_site_settings		CREATE view "desk_com_connector_example"."example_get_list_site_settings" as 
select
        *
    from
        (
            call "desk_com_connector.get_list_site_settings" ()) dd	READY
87	2015-04-24 18:17:47	"1112787663"	true	2015-04-24 18:17:47	raw.customer_order_logistics		"CREATE view raw.customer_order_logistics
AS
SELECT aaaaa.*, MIN(r.date_created) as date_returned
FROM
(SELECT aaaa.*, MIN(sc.date_created) as date_shipment_confirmation
FROM
  (
  SELECT aaa.*, MIN(ms.date_created) as date_shipment_manifest
  FROM
    (
    SELECT 
      aa.*, 
      MIN(CASE WHEN p.message  = 'PICKLIST CREATED' THEN p.date_created END) AS date_picklist_created,
      CASE
        WHEN 
          MIN(CASE WHEN p.message != 'PICKLIST CREATED' THEN p.date_created END) /* AS date_picklist_not_created */
          < MIN(CASE WHEN p.message  = 'PICKLIST CREATED' THEN p.date_created END) /* AS date_picklist_created */ 
        THEN 
          MIN(CASE WHEN p.message != 'PICKLIST CREATED' THEN p.date_created END) /* AS date_picklist_not_created */
        WHEN 
          MIN(CASE WHEN p.message  = 'PICKLIST CREATED' THEN p.date_created END) is null
        THEN 
          MIN(CASE WHEN p.message != 'PICKLIST CREATED' THEN p.date_created END)
        ELSE
          NULL
        END AS date_backorder
    FROM
      (
      SELECT a.*, MIN(e.date_created) as date_on_error, MAX(e.message) as logistics_error_message
      FROM
        (
        SELECT 
          co.order_id, co.date_stylist_picked, co.country, co.state, MIN(h.date_created) as sales_order_header_created
        FROM 
              (SELECT
                 co.id as order_id,
                 co.date_picked as date_stylist_picked,
                 ad.country,
                 co.state
              FROM postgres.customer_order as co
              JOIN postgres.address ad on ad.id = co.shipping_address_id
              JOIN (select
          				order_id,
            			sum(state)/sum(quantity) as state_agg
            			FROM postgres.order_position
            			group by 1
              		) op on op.order_id = co.id
              	where state_agg < 1536
              ) co
          LEFT JOIN
          postgres.doc_data_sales_order_header h
             ON h.orderid = co.order_id
        WHERE co.state > 8
        and co.state < 1536
        GROUP BY 1,2,3,4
        ) a
        LEFT JOIN
        postgres.doc_data_sales_order_import_result e
           ON e.orderid = a.order_id
          AND e.message is not null
          AND e.message <> ''
      GROUP BY 1,2,3,4,5
      ) aa
      LEFT JOIN
        postgres.doc_data_sales_order_status_change p 
           ON p.orderid = aa.order_id
      GROUP BY 1,2,3,4,5,6,7
    ) aaa
    LEFT JOIN
    postgres.doc_data_manifest_shipping ms
         ON ms.orderid = aaa.order_id
        AND ms.processing_reason is null
      GROUP BY 1,2,3,4,5,6,7,8,9
  ) aaaa
  LEFT JOIN
  postgres.doc_data_shipment_confirmation sc 
    ON sc.orderid = aaaa.order_id
  GROUP BY 1,2,3,4,5,6,7,8,9,10
) aaaaa
LEFT JOIN 
postgres.doc_data_return r
   ON r.original_orderid = aaaaa.order_id
  AND r.processing_reason is null
GROUP BY 1,2,3,4,5,6,7,8,9,10,11"	READY
237	2015-04-24 18:19:27	"1112787730"	true	2015-04-24 18:19:27	ml.article_push		"CREATE VIEW ml.article_push AS
SELECT
	aa.article_id AS article_id,
	CASE WHEN ap.attribute_identifier = 'true' THEN 1
	 	 WHEN ap.attribute_identifier = 'push_own_stock' THEN 1
	     WHEN ap.attribute_identifier = 'false' THEN 0
	     ELSE NULL
	  END AS push_item
FROM ml.article_attribute AS aa
JOIN ml.attribute_push AS ap
	ON aa.attribute_id = ap.attribute_id"	READY
90	2015-04-24 18:17:47	"638184659"	true	2015-04-24 18:17:47	tableau.finance_zstock_order_confirmation		"CREATE VIEW tableau.finance_zstock_order_confirmation
AS
SELECT 
	cast(supplierorderid as long) best_supplierorderid,
	cast(kundennummer as long) kundennummer,
	parseTimestamp( received_date, 'yyyy-MM-dd HH:mm:ss.S' ) as received_date_confirmed,
	count(article_nr) as nb_of_articles_confirmed,
	min(cast(replace(zwischensumme_de, ',', '.') as double)) as zwischensumme_de,
	min(cast(replace(rabatt_de, ',', '.') as double)) as rabatt_de,
	min(cast(zwischensumme_chf as double)) as zwischensumme_chf,
	min(cast(rabatt_chf as double)) as rabatt_chf,
	min(cast(replace(gesamtsumme_de, ',', '.') as double)) as gesamtsumme_de,
	min(cast(gesamtsumme_chf as double)) as gesamtsumme_chf
from dwh.customerorderbox group by 1,2,3"	READY
91	2015-04-24 18:17:48	"638184660"	true	2015-04-24 18:17:48	tableau.finance_zstock_returnmail_check		"CREATE VIEW tableau.finance_zstock_returnmail_check
AS
SELECT
	supplierorderid,
	retoure_received_date_time,
	sum(gutschrift) gutschrift,
	sum(nb_of_articles_returned) nb_of_articles_returned
FROM 
(
	SELECT
		parseTimestamp(received_date_time, 'yyyy-MM-dd HH:mm:ss.S') as retoure_received_date_time,
		supplierorderid,
		max
		(
			case when cast(gutschrift as double) is null then cast(gutschrift_chf as double)
			else cast(gutschrift as double)
			end
		)gutschrift,
		count
		(
			distinct case when artikel_description='Artikel' then artikel_grosse 
			else artikel_description 
			end
		)nb_of_articles_returned 
	FROM ""dwh"".""retouremails""
	GROUP BY 1,2
)gutschrift 
GROUP BY 1,2"	READY
243	2015-04-24 18:19:31	"1112787733"	true	2015-04-24 18:19:31	bi.article		"CREATE VIEW bi.article AS

SELECT
	a.article_id,
	a.article_ean,
	amc.attribute_id AS article_attribute_id,
	a.article_oo_id,
	a.article_o_parent_id,
	/* a.article_sku,  THIS FIELD ALMOST ALWAYS NULL
	a.article_manufacturer_sku,
	a.article_manufacturer_alternative_sku, */
	a.article_supplier_sku, 
	a.article_supplier_alternative_sku,
	a.article_model_id,
	a.article_model_o_id,
	a.article_in_pim,
	a.article_suppliers,
	a.article_ever_supplied_by_outfittery,
	a.article_date_created,
	a.article_latest_delivery_date,
	a.article_earliest_delivery_date,
	a.article_amidala_active,
	a.article_amidala_deactive,
	a.article_reason_amidala_deactive,
	a.article_activation_ch,
	a.article_core_item,
	a.article_published,
	a.article_name,
	a.article_pic1,
	a.article_title,
	COALESCE(b.name, a.article_brand) AS article_brand,
	b.marketing_cluster AS article_marketing_cluster,
	CASE WHEN cg1.title_en IS NOT NULL THEN cg1.title_en ELSE a.article_commodity_group1 END AS article_commodity_group1,
	CASE WHEN cg2.title_en IS NOT NULL THEN cg2.title_en ELSE a.article_commodity_group2 END AS article_commodity_group2,
	CASE WHEN cg3.title_en IS NOT NULL THEN cg3.title_en ELSE a.article_commodity_group3 END AS article_commodity_group3,
	CASE WHEN cg4.title_en IS NOT NULL THEN cg4.title_en ELSE a.article_commodity_group4 END AS article_commodity_group4,
	CASE WHEN cg5.title_en IS NOT NULL THEN cg5.title_en ELSE a.article_commodity_group5 END AS article_commodity_group5,
	a.article_category,
	a.article_basic_unit,
	a.article_color,
	a.article_color1,
	a.article_color1_shade,
	a.article_supplier_color_code,
	a.article_supplier_color_name,
	/*	a.article_manufacturer_color_code,
	a.article_manufacturer_color_name, */
	a.article_hanging_garment,
	a.article_size,
	a.article_eu_size,
	a.article_supplier_size,
	a.article_eu_length,
	a.article_supplier_length,
	a.article_gross_weight_gram,
	a.article_net_weight_gram,
	a.article_image_url,
	a.article_country_of_production,
	a.article_country_of_origin,
	a.article_buyer,
	a.article_customs_tariff_number,
	a.article_customs_tariff_number_ch,
	a.article_customs_tariff_number_de,
	a.article_check_tariff_numbers,
	a.article_amidala_categories,
	a.article_promotion_item,
	a.article_push_stock,
	a.article_nos,
	a.article_never_out_of_stock,
	a.article_supplier_availability,
	a.article_season_start,
	a.article_season,
	a.article_cost,
	a.article_sales_price_de,
	a.article_sales_price_at,
	a.article_sales_price_ch,
	a.article_sales_price_original,
	a.article_sales_price_reduced
FROM
		  raw.article a
LEFT JOIN dwh.brands b ON b.name_db = a.article_brand
LEFT JOIN dwh.commodity_group1 cg1 ON cg1.commodity_group1 = a.article_commodity_group1
LEFT JOIN dwh.commodity_group2 cg2 ON cg2.commodity_group2 = a.article_commodity_group2
LEFT JOIN dwh.commodity_group3 cg3 ON cg3.commodity_group3 = a.article_commodity_group3
LEFT JOIN dwh.commodity_group4 cg4 ON cg4.commodity_group4 = a.article_commodity_group4
LEFT JOIN dwh.commodity_group5 cg5 ON cg5.commodity_group5 = a.article_commodity_group5
LEFT JOIN ml.article_amidala_category amc ON a.article_id = amc.article_id"	READY
250	2015-04-24 18:19:35	"1112787740"	true	2015-04-24 18:19:35	views.stylist		"CREATE VIEW ""views.stylist"" 
AS
SELECT 
    salesforce_customer_id as salesforce_id,
    stylist_id,
    first_name,
    last_name,
    balance_strategy_resolver_string,
    stylist as Name,
    stylist_original, /*this stylist name is based order level*/
    ""enabled"",
    real_stylist,
    profile_name,   
    '0' as Id,
    team as user_role
FROM ""bi.stylist"""	READY
142	2015-04-24 18:17:57	"638184756"	true	2015-04-24 18:17:57	meta.schema__salesforce		CREATE VIEW meta.schema__salesforce AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('salesforce', 'schema')) as a	READY
491,551	2015-08-10 15:24:09	"1141300611"	true	2015-08-10 15:24:09	desk_com_connector_example.example_show_site_setting		CREATE view desk_com_connector_example.example_show_site_setting as select
        *
    from
        (
            call "desk_com_connector.show_site_setting" (
                "in_site_setting_id" => '25696881'
            )
        ) dd	READY
255	2015-04-24 18:19:36	"1112787742"	true	2015-04-24 18:19:36	tableau.ops_lost_articles_by_date_returned		"CREATE view tableau.ops_lost_articles_by_date_returned
as
SELECT op.article_id, 
       op.lost_articles, 
       ddr.return_file_count, 
       op.date_returned, 
       sb.all_bookings, 
       sb.all_bookings_on_po, 
       sb.all_999998_bookings, 
       sb.all_999997_bookings, 
       sb.all_999996_bookings_plus,
       sb.all_999996_bookings_minus,
       sb.all_999995_bookings,  
       sb.all_999992_bookings, 
       sb.all_supplier_return_bookings, 
       sb.ch_return_bookings,
       sb.zalando_bookings,
       sb.zalando_return_bookings,
       sb.samples,
       sb.samples_plus,
       sb.samples_minus,
       sb.outlet_store_bookings
FROM
        (SELECT    coa.order_id, 
               cast(coa2.date_returned AS DATE) AS date_returned, 
               coa.article_id, 
               count(article_id)               AS lost_articles 
        FROM   bi.customer_order_articles coa 
               JOIN (SELECT 
                          order_id, 
                          max(date_returned) AS date_returned 
                    FROM   bi.customer_order_articles 
                    GROUP  BY 1
                    ) coa2 ON coa.order_id = coa2.order_id 
        WHERE  order_article_state_number = 1536 
        GROUP  BY 1, 2, 3
        ) op 
       LEFT JOIN (SELECT  sb.article_id, 
                          sum(sb.stock_booked) AS all_bookings, 
                          sum(sb.po_bookings) AS all_bookings_on_po, 
                          sum(sb.manual_unbookings) AS all_999998_bookings, 
                          sum(sb.customer_returns) AS all_999997_bookings, 
                          sum(sb.picklist_plus) AS all_999996_bookings_plus,
                          sum(sb.picklist_minus) AS all_999996_bookings_minus,
                          sum(sb.cycle_counts) AS all_999995_bookings,  
                          sum(sb.custom_requests) AS all_999992_bookings, 
                          sum(sb.supplier_returns) AS all_supplier_return_bookings, 
                          sum(sb.swiss_returns) AS ch_return_bookings,
                          sum(sb.zalando_bookings) AS zalando_bookings,
                          sum(sb.zalando_returns) AS zalando_return_bookings,
                          sum(sb.samples) AS samples,
                          sum(sb.samples_plus) AS samples_plus,
                          sum(sb.samples_minus) AS samples_minus,
                          sum(sb.outlet_store_bookings) AS outlet_store_bookings
                  FROM bi.stock_booked sb
                  GROUP  BY 1
                  ) sb ON sb.article_id = op.article_id 
       LEFT JOIN (SELECT r.outfittery_article_number, 
                         count(r.outfittery_article_number) AS return_file_count 
                  FROM   postgres.doc_data_return r 
                  GROUP  BY 1
                  ) ddr ON op.article_id = ddr.outfittery_article_number"	READY
491,552	2015-08-10 15:24:09	"1141300612"	true	2015-08-10 15:24:09	desk_com_connector_example.example_get_list_site_languages		CREATE view desk_com_connector_example.example_get_list_site_languages as 
select
        *
    from
        (
            call "desk_com_connector.get_list_site_languages" ()) ff	READY
491,553	2015-08-10 15:24:10	"1141300613"	true	2015-08-10 15:24:10	desk_com_connector_example.example_show_site_language		create view desk_com_connector_example.example_show_site_language as select
        *
    from
        (
            call "desk_com_connector.show_site_language" (
                "in_lang_id" => 'en'
            )
        ) ff	READY
491,554	2015-08-10 15:24:10	"1141300614"	true	2015-08-10 15:24:10	desk_com_connector_example.example_get_list_snippets		CREATE view desk_com_connector_example.example_get_list_snippets as 
select
        *
    from
        (
            call "desk_com_connector.get_list_snippets" ()) kk	READY
491,555	2015-08-10 15:24:10	"1141300615"	true	2015-08-10 15:24:10	desk_com_connector_example.example_show_topic		create view desk_com_connector_example.example_show_topic as select
        *
    from
        (
            call "desk_com_connector.show_topic" (
                "in_topic_id" => '786247'
            )
        ) ff	READY
100	2015-04-24 18:17:50	"1112787668"	true	2015-04-24 18:17:50	tableau.ops_stock_reconciliation_sku_history		"CREATE view tableau.ops_stock_reconciliation_sku_history
as
select 
	seh.outfittery_article_number, 
	cast(seh.date_created as date) as stock_date,
	seh.available_stock, 
	sm.plus_bookings, 
	sm.minus_bookings,
	ms.shipped_articles, 
	ms.shipped_articles_cancellations
FROM postgres.doc_data_inventory_count seh
LEFT JOIN
/*----all plus and minus bookings----*/
	(select 
		customer_article_number, 
		cast(date_created as date) as stock_mutation_date,
		sum(case when cast(quantity_good as integer) > 0 then cast(quantity_good as integer) else 0 end) as plus_bookings,
		sum(case when cast(quantity_good as integer) < 0 then cast(quantity_good as integer) else 0 end) as minus_bookings
		FROM postgres.doc_data_stock_mutation group by 1,2
	) sm
on sm.customer_article_number = seh.outfittery_article_number and sm.stock_mutation_date = cast(seh.date_created as date)
left join 
/*----shipped articles----*/
	(select 
		outfittery_article_number, 
		cast(date_created as date) as shipped_date,
		count(case when processing_reason like '%A doc data service exception%' then 1 else null end) as shipped_articles_cancellations,
		count(*) as shipped_articles from postgres.doc_data_manifest_shipping group by 1,2
	) ms
on ms.outfittery_article_number = seh.outfittery_article_number and ms.shipped_date = cast(seh.date_created as date)"	READY
256	2015-04-24 18:19:36	"1112787743"	true	2015-04-24 18:19:36	tableau.ops_lost_articles_month_overview		"CREATE view tableau.ops_lost_articles_month_overview
as
SELECT op.article_id, 
       op.lost_articles, 
       ddr.return_file_count, 
       sb.month_stock_booked,
       op.op_month_shipped, 
       ddr.month_returned, 
       sb.all_bookings, 
       sb.all_bookings_on_po, 
       sb.all_999998_bookings, 
       sb.all_999997_bookings, 
       sb.all_999996_bookings_plus,
       sb.all_999996_bookings_minus,
       sb.all_999995_bookings,  
       sb.all_999992_bookings, 
       sb.all_supplier_return_bookings, 
       sb.ch_return_bookings,
       sb.zalando_bookings,
       sb.zalando_return_bookings,
       sb.samples,
       sb.samples_plus,
       sb.samples_minus,
       sb.outlet_store_bookings
FROM
/*--- Thomas wanted to see all the movements of an article in the same month as the shipments and returns; hence the link to dwh.calendar table---*/
        (SELECT 
               extract(month FROM date_shipped) || ' ' || Extract(year FROM date_shipped) AS op_month_shipped,
               article_id, 
               Count(article_id)    AS lost_articles 
        FROM   bi.customer_order_articles op
        WHERE  order_article_state_number = 1536 
        GROUP BY 1, 2
        ) op
       LEFT JOIN 
          (SELECT
                sb.article_id,
                extract(month FROM date_stock_booked) || ' ' || Extract(year FROM date_stock_booked) AS month_stock_booked,
                sum(sb.stock_booked) AS all_bookings, 
                sum(sb.po_bookings) AS all_bookings_on_po, 
                sum(sb.manual_unbookings) AS all_999998_bookings, 
                sum(sb.customer_returns) AS all_999997_bookings, 
                sum(sb.picklist_plus) AS all_999996_bookings_plus,
                sum(sb.picklist_minus) AS all_999996_bookings_minus,
                sum(sb.cycle_counts) AS all_999995_bookings,  
                sum(sb.custom_requests) AS all_999992_bookings, 
                sum(sb.supplier_returns) AS all_supplier_return_bookings, 
                sum(sb.swiss_returns) AS ch_return_bookings,
                sum(sb.zalando_bookings) AS zalando_bookings,
                sum(sb.zalando_returns) AS zalando_return_bookings,
                sum(sb.samples) AS samples,
                sum(sb.samples_plus) AS samples_plus,
                sum(sb.samples_minus) AS samples_minus,
                sum(sb.outlet_store_bookings) AS outlet_store_bookings
          FROM bi.stock_booked sb
          GROUP BY 1,2
          ) sb ON sb.article_id = op.article_id
       LEFT JOIN 
            (SELECT   extract(month FROM date_created) || ' ' || Extract(year FROM date_created) AS month_returned, 
                      outfittery_article_number, 
                      count(outfittery_article_number)       AS return_file_count 
                FROM postgres.doc_data_return 
                GROUP BY 1, 2
                ) ddr ON op.article_id = ddr.outfittery_article_number"	READY
97	2015-04-24 18:17:49	"638184670"	true	2015-04-24 18:17:49	ml.project_size_category		"CREATE VIEW ml.project_size_category AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('ml_project_size_category.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""attribute_id_size"" STRING ,
		""attribute_id_category"" STRING ,
		""count"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
98	2015-04-24 18:17:49	"638184671"	true	2015-04-24 18:17:49	tableau.ops_logistics_overview_last_updated		"CREATE view tableau.ops_logistics_overview_last_updated
AS
SELECT 
	max(endTime) as last_updated_at
FROM SYSADMIN.ScheduleJobRun where sqlCommand like '%views.logistics_overview%'
and status='finished'"	READY
257	2015-04-24 18:19:37	"1112787744"	true	2015-04-24 18:19:37	tableau.ops_lost_articles_stock_mutations_agg		"CREATE view tableau.ops_lost_articles_stock_mutations_agg
as
SELECT op.article_id, 
       op.lost_articles, 
       ddr.return_file_count, 
       sb.all_bookings, 
       sb.all_bookings_on_po, 
       sb.all_999998_bookings, 
       sb.all_999997_bookings, 
       sb.all_999996_bookings_plus,
       sb.all_999996_bookings_minus,
       sb.all_999995_bookings,  
       sb.all_999992_bookings, 
       sb.all_supplier_return_bookings, 
       sb.ch_return_bookings,
       sb.zalando_bookings,
       sb.zalando_return_bookings,
       sb.samples,
       sb.samples_plus,
       sb.samples_minus,
       sb.outlet_store_bookings 
FROM   (SELECT op.article_id, 
               count(op.article_id)    AS lost_articles 
        FROM   bi.customer_order_articles op
        WHERE  op.order_article_state_number = 1536 
        GROUP  BY 1
        ) op 
       LEFT JOIN (SELECT
                      sb.article_id,
                      sum(sb.stock_booked) AS all_bookings, 
                      sum(sb.po_bookings) AS all_bookings_on_po, 
                      sum(sb.manual_unbookings) AS all_999998_bookings, 
                      sum(sb.customer_returns) AS all_999997_bookings, 
                      sum(sb.picklist_plus) AS all_999996_bookings_plus,
                      sum(sb.picklist_minus) AS all_999996_bookings_minus,
                      sum(sb.cycle_counts) AS all_999995_bookings,  
                      sum(sb.custom_requests) AS all_999992_bookings, 
                      sum(sb.supplier_returns) AS all_supplier_return_bookings, 
                      sum(sb.swiss_returns) AS ch_return_bookings,
                      sum(sb.zalando_bookings) AS zalando_bookings,
                      sum(sb.zalando_returns) AS zalando_return_bookings,
                      sum(sb.samples) AS samples,
                      sum(sb.samples_plus) AS samples_plus,
                      sum(sb.samples_minus) AS samples_minus,
                      sum(sb.outlet_store_bookings) AS outlet_store_bookings
                  FROM bi.stock_booked sb
                  GROUP  BY 1
                  ) sb  ON sb.article_id = op.article_id 
       LEFT JOIN (SELECT r.outfittery_article_number, 
                         count(r.outfittery_article_number) AS return_file_count 
                  FROM   postgres.doc_data_return r
                  GROUP  BY 1
                  ) ddr ON op.article_id = ddr.outfittery_article_number"	READY
101	2015-04-24 18:17:50	"638184677"	true	2015-04-24 18:17:50	raw.accounting_upload		"CREATE view raw.accounting_upload
AS
SELECT
	po AS purchase_order_id, /* conversion to long results in error */
	delivery_note,
	ean,
	cast(delivery_note_quantity_sup as integer) as delivery_note_quantity_supplier,
	invoice_number,
	cast(invoice_quantity as integer) as invoice_quantity,
	parseTimestamp(accounting_date, 'yyyy-MM-dd HH:mm:ss.S' ) as accounting_date,
	accountant
FROM dwh.accountingupload"	READY
491,556	2015-08-10 15:24:11	"1141300616"	true	2015-08-10 15:24:11	desk_com_connector_example.example_show_topics_translation		CREATE view desk_com_connector_example.example_show_topics_translation as select
        *
    from
        (
            call "desk_com_connector.show_topics_translation" (
                "in_topic_id" => '786247'
                ,"in_locale" => 'en'
            )
        ) ss	READY
259	2015-04-24 18:19:38	"1112787747"	true	2015-06-15 11:13:21	tableau.stylist_overview_dashboard_live		"CREATE VIEW tableau.stylist_overview_dashboard_live
AS
SELECT
  co.id as order_id,
  co.stylelist_id as stylist_id,  
  CASE 
	WHEN s.role = 'Fake' AND s.stylist_id != 118566682 THEN 'Fake Stylist ' || s.team
	ELSE s.first_name || ' ' || s.last_name 
  END as stylist_name,
  s.team as stylist_team,
  s.role as stylist_role,
  co.customer_id,  
  co.sales_channel, 
  CASE
    WHEN real_order.real_order_count = 1 THEN 'First Order'
    WHEN co.sales_channel like 'club%' THEN 'Outfittery Club Order'
    WHEN real_order.real_order_count > 1 AND co.parent_order_id is null THEN 'Repeat Order'
    WHEN co.parent_order_id is not null THEN 'Follow-on Order'
  END as order_type,
  CASE 
    WHEN co.state = 4  THEN 'Initiated'
    WHEN co.state = 8  THEN 'Incoming'
    WHEN co.state = 16 THEN 'Stylist Picked'
    WHEN co.state = 20 THEN 'Purchase Order Created'
    WHEN co.state = 24 THEN 'Sales Order Submitted'
    WHEN co.state = 32 THEN 'Stocked'
    WHEN co.state = 64 THEN 'Placed'
    WHEN co.state = 128 THEN 'Sent'
    WHEN co.state = 256 THEN 'Arrived'
    WHEN co.state = 384 THEN 'Returned Online'
    WHEN co.state = 512 THEN 'Returned'
    WHEN co.state = 1024 THEN 'Completed'
    WHEN co.state = 2048 THEN 'Cancelled'
    ELSE 'Ask BI'
  END as order_state,
  CASE 
    WHEN co.payment_method = 1 THEN 'Invoice'
    WHEN co.payment_method = 2 THEN 'Credit Card'
    WHEN co.payment_method = 4 THEN 'Pre-pay'
    WHEN co.payment_method = 6 THEN 'Arvato'
    ELSE 'Ask BI'
  END as payment_type,
  
/* All dates */
  co.date_created as date_incoming,
  co.phone_date as date_phone_call,
  inv.date_created as date_invoiced,
  co.date_picked as date_stylist_picked,

  CASE 
    WHEN ship_add.country='A' THEN 'AT'
    WHEN ship_add.country='' THEN null
    ELSE ship_add.country 
  END as shipping_country,
  cos.preview_not_liked

FROM postgres.customer_order as co
JOIN postgres.address as ship_add on ship_add.id = co.shipping_address_id
LEFT JOIN postgres.voucher as inv on inv.order_id = co.id AND inv.voucher_type = 'INVOICE'
LEFT JOIN raw.customer_order_salesforce cos on cos.order_id=co.id
LEFT JOIN 
(
  SELECT 
    co1.id,
    rank() OVER(PARTITION BY co1.customer_id ORDER BY co1.id) as ""real_order_count""
  FROM postgres.customer_order as co1
  WHERE co1.parent_order_id is null
  OR id=parent_order_id                   /* to deal with bad data where order_id=parent_id */
) as real_order on real_order.id = co.id
JOIN bi.stylist s on s.stylist_id = co.stylelist_id
WHERE CAST(co.date_picked as DATE) = CURDATE()
AND s.enabled"	READY
491,557	2015-08-10 15:24:11	"1141300617"	true	2015-08-10 15:24:11	desk_com_connector_example.example_show_twitter_user		CREATE view desk_com_connector_example.example_show_twitter_user as select
        *
    from
        (
            call "desk_com_connector.show_twitter_user" (
                "in_twitter_user_id" => '18249755'
            )
        ) dd	READY
491,558	2015-08-10 15:24:11	"1141300618"	true	2015-08-10 15:24:11	desk_com_connector_example.example_show_user		create view "desk_com_connector_example"."example_show_user" as select
        *
    from
        (
            call "desk_com_connector.show_user" (
                "in_user_id" => '23129264'
            )
        ) ss	READY
491,562	2015-08-10 15:24:16	"1141300622"	true	2015-08-10 15:24:16	desk_com_connector_example.example_get_list_user_groups		CREATE view desk_com_connector_example.example_get_list_user_groups as select
        *
    from
        (
            call "desk_com_connector.get_list_user_groups" (
                "in_user_id" => '23129264'
            )
        ) ss	READY
491,565	2015-08-10 15:24:18	"1141300625"	true	2015-08-10 15:24:18	desk_com_connector_example.get_list_cases_wo_pagination		CREATE view desk_com_connector_example.get_list_cases_wo_pagination as select
        *
    from
        (
            call "desk_com_connector.get_list_cases_wo_pagination" (
                "in_pade_num" => 1
                ,"in_page_size" => 100
            )
        ) ii	READY
104	2015-04-24 18:17:50	"638184680"	true	2015-04-24 18:17:50	tableau.ops_stock_reconciliation_last_updated		"CREATE view tableau.ops_stock_reconciliation_last_updated
AS
SELECT 
cal.""date"",
dd.doc_data_last_updated_at,
os.stock_entry_last_updated_at,
sr.report_last_updated_at
FROM 
dwh.calendar cal
LEFT JOIN
(SELECT 
	max(endTime) as doc_data_last_updated_at
	FROM SYSADMIN.ScheduleJobRun 
	WHERE sqlCommand like '%dwh.stock_entry_history_dd%'
	AND status='finished'
) dd on cast(dd.doc_data_last_updated_at as date) = cal.""date""
LEFT JOIN
(SELECT
	max(endTime) as stock_entry_last_updated_at
	FROM SYSADMIN.ScheduleJobRun 
	WHERE sqlCommand like '%dwh.stock_entry_history%'
	AND status='finished'
	AND cast(endTime as date) = curdate()
	AND extract(hour from endTime)<=7 and extract(minute from endTime)<=50
)os on cast(os.stock_entry_last_updated_at as date) = cal.""date""
LEFT JOIN
(SELECT
	max(endTime) as report_last_updated_at
	FROM SYSADMIN.ScheduleJobRun 
	WHERE sqlCommand like '%bi.stock_reconciliation%'
	AND status='finished'
) sr ON cast(sr.report_last_updated_at as date) = cal.""date""
WHERE cal.""date"" = curdate()"	READY
103	2015-04-24 18:17:50	"1112787669"	true	2015-04-24 18:17:50	tableau.ops_error_log_not_checked_out		"CREATE view tableau.ops_error_log_not_checked_out
AS
SELECT 
order_id,
date_created as order_position_date_created,
article_id,
state
FROM postgres.order_position 
where state = 8
and cast(date_created as date) >= timestampadd(SQL_TSI_day, -5, curdate())"	READY
105	2015-04-24 18:17:50	"1112787670"	true	2015-04-24 18:17:50	tableau.ops_monthly_doc_data_bookings_shipped		"CREATE view tableau.ops_monthly_doc_data_bookings_shipped
as
SELECT 
	cast(ddsc.date_created as date) as shipment_confirmation_date,
	sum(case when op.stock_location_id = 1 then cast(ddsc.quantity_shipped as integer) end) as quantity_stock_location_1,
	sum(case when op.stock_location_id = 2 then cast(ddsc.quantity_shipped as integer) end) as quantity_stock_location_2,
	sum(case when op.stock_location_id = 4 then cast(ddsc.quantity_shipped as integer) end) as quantity_stock_location_4
FROM postgres.doc_data_shipment_confirmation ddsc
join postgres.order_position op on op.order_id = ddsc.orderid and op.article_id = ddsc.outfittery_article_number
group by 1"	READY
260	2015-04-24 18:19:38	"1112787748"	true	2015-05-12 11:14:46	tableau.stylist_overview_dashboard_live_created_today		"CREATE VIEW tableau.stylist_overview_dashboard_live_created_today
AS
SELECT
  co.id as order_id,
  co.stylelist_id as stylist_id,  
  CASE 
  WHEN s.role = 'Fake' AND s.stylist_id != 118566682 THEN 'Fake Stylist ' || s.team
  ELSE s.first_name || ' ' || s.last_name 
  END as stylist_name,
  s.team as stylist_team,
  s.role as stylist_role,
  co.customer_id,  
  co.sales_channel, 
  CASE
    WHEN real_order.real_order_count = 1 THEN 'First Order'
    WHEN co.sales_channel like 'club%' THEN 'Outfittery Club Order'
    WHEN real_order.real_order_count > 1 AND co.parent_order_id is null THEN 'Repeat Order'
    WHEN co.parent_order_id is not null THEN 'Follow-on Order'
  END as order_type,
  CASE 
    WHEN co.state = 4  THEN 'Initiated'
    WHEN co.state = 8  THEN 'Incoming'
    WHEN co.state = 16 THEN 'Stylist Picked'
    WHEN co.state = 20 THEN 'Purchase Order Created'
    WHEN co.state = 24 THEN 'Sales Order Submitted'
    WHEN co.state = 32 THEN 'Stocked'
    WHEN co.state = 64 THEN 'Placed'
    WHEN co.state = 128 THEN 'Sent'
    WHEN co.state = 256 THEN 'Arrived'
    WHEN co.state = 384 THEN 'Returned Online'
    WHEN co.state = 512 THEN 'Returned'
    WHEN co.state = 1024 THEN 'Completed'
    WHEN co.state = 2048 THEN 'Cancelled'
    ELSE 'Ask BI'
  END as order_state,
  CASE 
    WHEN co.payment_method = 1 THEN 'Invoice'
    WHEN co.payment_method = 2 THEN 'Credit Card'
    WHEN co.payment_method = 4 THEN 'Pre-pay'
    WHEN co.payment_method = 6 THEN 'Arvato'
    ELSE 'Ask BI'
  END as payment_type,
  
/* All dates */
  co.date_created as date_incoming,
  co.phone_date as date_phone_call,
  inv.date_created as date_invoiced,
  co.date_picked as date_stylist_picked,

  CASE 
    WHEN ship_add.country='A' THEN 'AT'
    WHEN ship_add.country='' THEN null
    ELSE ship_add.country 
  END as shipping_country

FROM postgres.customer_order as co
JOIN postgres.address as ship_add on ship_add.id = co.shipping_address_id
LEFT JOIN postgres.voucher as inv on inv.order_id = co.id AND inv.voucher_type = 'INVOICE'
LEFT JOIN 
(
  SELECT 
    co1.id,
    rank() OVER(PARTITION BY co1.customer_id ORDER BY co1.id) as ""real_order_count""
  FROM postgres.customer_order as co1
  WHERE co1.parent_order_id is null
  OR id=parent_order_id                   /* to deal with bad data where order_id=parent_id */
) as real_order on real_order.id = co.id
JOIN bi.stylist s on s.stylist_id = co.stylelist_id
WHERE CAST(co.date_created as DATE) = CURDATE()
AND (co.phone_date < TIMESTAMPADD(SQL_TSI_DAY, 30, CURDATE()) OR co.phone_date is NULL)
AND co.sales_channel != 'website'
AND s.enabled"	READY
264	2015-04-24 18:19:39	"1112787751"	true	2015-04-24 18:19:39	tableau.ops_stock_movement_details		"CREATE VIEW tableau.ops_stock_movement_details AS

SELECT
	'booked' AS source,
    date_stock_booked AS date_created,
	article_id,
	purchase_order_id,
    supplier_id,
	NULL AS order_id,
	SUM(stock_booked) AS articles
FROM 
	bi.stock_booked
WHERE
	date_stock_booked >= TIMESTAMPADD(SQL_TSI_DAY, -28, CURDATE())
/* AND article_id = 39041817 */
GROUP BY 2,3,4,5

UNION

SELECT
	'packed' AS source,
	date_stock_packed,                                   	                         	
	article_id,
	NULL AS purchase_order_id,
	NULL AS supplier_id,
	order_id,	
	-stock_packed AS stock_packed
FROM
	raw.stock_packed
WHERE
	date_stock_packed >= TIMESTAMPADD(SQL_TSI_DAY, -28, CURDATE())
/* AND CAST(outfittery_article_number AS LONG) = 39041817 */

UNION
	
SELECT
	'inventory' AS transaction,
	seh.date_created,
	CAST(seh.sku AS LONG) AS article_id,
	NULL AS purchase_order_id,
	NULL AS supplier_id,
	NULL AS order_id,
	CAST(seh.quantity AS INTEGER) AS stock
FROM
	dwh.stock_entry_history seh
	JOIN
	(
		SELECT
			sku
		FROM
			dwh.stock_entry_history
		WHERE
			date_created >= TIMESTAMPADD(SQL_TSI_DAY, -28, CURDATE())
		GROUP BY 1
		HAVING
			SUM(CAST(quantity AS INTEGER)) > 0
	) z
		ON seh.sku = z.sku
WHERE
	seh.date_created >= TIMESTAMPADD(SQL_TSI_DAY, -28, CURDATE())
/* AND CAST(sku AS LONG) = 39041817 */

UNION

SELECT
	'inventory doc data' AS transaction,
	sehdd.date_created,
	CAST(sehdd.sku AS LONG) AS article_id,
	NULL AS purchase_order_id,
	NULL AS supplier_id,
	CAST(NULL AS LONG) AS order_id,
	CAST(sehdd.docdata_quantity AS INTEGER) AS stock
FROM
	dwh.stock_entry_history_dd sehdd
	JOIN
	(
		SELECT
			sku
		FROM
			dwh.stock_entry_history_dd
		WHERE
			date_created >= TIMESTAMPADD(SQL_TSI_DAY, -28, CURDATE())
		GROUP BY 1
		HAVING
			SUM(CAST(docdata_quantity AS INTEGER)) > 0
	) q
		ON sehdd.sku = q.sku
WHERE
	date_created >= TIMESTAMPADD(SQL_TSI_DAY, -28, CURDATE())
/* AND CAST(sku AS LONG) = 39041817 */"	READY
491,560	2015-08-10 15:24:15	"1141300620"	true	2015-08-10 15:24:15	desk_com_connector_example.example_get_list_user_preferences		CREATE view "desk_com_connector_example"."example_get_list_user_preferences" as 
select
        *
    from
        (
            call "desk_com_connector.get_list_user_preferences" (
                "in_user_id" => '21674781'
            )
        ) ss	READY
491,561	2015-08-10 15:24:15	"1141300621"	true	2015-08-10 15:24:15	desk_com_connector_example.example_show_user_preference		create view "desk_com_connector_example"."example_show_user_preference" as select
        *
    from
        (
            call "desk_com_connector.show_user_preference" (
                "in_user_id" => '23129264'
                ,"in_pref_id" => '1001'
            )
        ) ss	READY
491,563	2015-08-10 15:24:17	"1141300623"	true	2015-08-10 15:24:17	desk_com_connector_example.example_get_list_custom_fields		create view "desk_com_connector_example"."example_get_list_custom_fields" as select
        *
    from
        (
            call "desk_com_connector.get_list_custom_fields" ()) dd	READY
113	2015-04-24 18:17:52	"638184716"	true	2015-04-24 18:17:52	am.object_17		"CREATE VIEW am.object_17 AS
SELECT * FROM ""pim.object_17"""	READY
114	2015-04-24 18:17:52	"638184717"	true	2015-04-24 18:17:52	am.mapping_commodity_groups		"CREATE VIEW am.mapping_commodity_groups AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.20150327_mapping_commodity_groups.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""commodity_group5"" STRING ,
		""Artikelkategoriencode"" STRING ,
		""Code"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
115	2015-04-24 18:17:52	"638184718"	true	2015-04-24 18:17:52	am.product_group_code		"CREATE VIEW am.product_group_code AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.product_group_code.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""Article Category"" STRING ,
		""Product Group"" STRING ,
		""Description"" STRING 
		DELIMITER ',' 
		QUOTE '""' 
		HEADER 1 
	)
""csv_table"""	READY
491,564	2015-08-10 15:24:17	"1141300624"	true	2015-08-10 15:24:17	desk_com_connector_example.example_show_custom_field		create view "desk_com_connector_example"."example_show_custom_field" as select
        *
    from
        (
            call "desk_com_connector.show_custom_field" (
                "in_field_id" => '66049'
            )
        ) dd	READY
102	2015-04-24 18:17:50	"1047779748"	true	2015-07-21 14:00:34	raw.marketing_contacts_tv		"CREATE VIEW raw.marketing_contacts_tv
AS
SELECT 
	cast(order_id as long) as order_id,
	MODIFYTIMEZONE(tv.airingtime,'UTC+1') as contact_timestamp,
	'TV' as marketing_channel,
	'Commercial' as format,
	LOWER(tv.spotstation) as tv_spot_station,
	LOWER(tv.program_before) as tv_program,
	LOWER(tv.spotname) as tv_spot_name
FROM ""dwh"".""marketing_tv"" tv"	READY
491,569	2015-08-10 15:24:20	"1141300629"	true	2015-08-10 15:24:20	desk_com_connector_example.example_get_list_facebook_accounts		CREATE view "desk_com_connector_example"."example_get_list_facebook_accounts" as select
        *
    from
        ( call "desk_com_connector.get_list_facebook_accounts" ( ) ) ss	READY
122	2015-04-24 18:17:54	"1112787678"	true	2015-04-24 18:17:54	raw.stock_shipped		"CREATE VIEW raw.stock_shipped AS

SELECT
	id AS stock_shipped_id,
	/* order_id should be long, but it has bad data */
	orderid AS order_id,
	cod_amount,
	collo_number,
	parseTimestamp(date_created, 'yyyy-MM-dd HH:mm:ss.S') as date_stock_shipped,
	/* parseTimestamp(date_processed, 'yyyy-MM-dd HH:mm:ss.S') as date_processed, */
	parseTimestamp(last_updated, 'yyyy-MM-dd HH:mm:ss.S') as last_updated,
	/* parsedate(shipping_date, 'yyyymmdd') as date_shipped, */
	shipping_date,    /* Left this in for compatibility with older reports */
	CAST(line_number AS INTEGER) AS line_number,
	CAST(outfittery_article_number AS LONG) article_id, 
	LEFT(processing_reason, 4000) as processing_reason, 
	processing_result, 
	processing_state, 
	CAST(quantity AS INTEGER) AS stock_shipped, 
	receiver_address1, 
	receiver_address2, 
	receiver_city, 
	receiver_company, 
	receiver_country_code,
	receiver_name,
	receiver_zip_code, 
	return_track_and_trace_number, 
	track_and_trace_number, 
	transport_company, 
	used_invoice_number
FROM 
	postgres.doc_data_manifest_shipping"	READY
123	2015-04-24 18:17:54	"1112787679"	true	2015-04-24 18:17:54	raw.stock_packed		"CREATE VIEW raw.stock_packed AS

SELECT
	id AS stock_packed_id,
	parseTimestamp(date_created, 'yyyy-MM-dd HH:mm:ss.S') as date_stock_packed,
	parseTimestamp(last_updated, 'yyyy-MM-dd HH:mm:ss.S') as last_updated,
	CAST(line_number AS INTEGER) AS line_number,
	/* bad data in order_id, so leaving as string */
	orderid AS order_id,
	CAST(outfittery_article_number AS LONG) AS article_id,
	LEFT(processing_reason, 4000) AS processing_reason,
	processing_result,
	processing_state,
	CAST(quantity_shipped AS INTEGER) AS stock_packed,
	shipping_date,
	track_and_trace_number,
	transport_company_code
FROM 
	postgres.doc_data_shipment_confirmation"	READY
491,566	2015-08-10 15:24:18	"1141300626"	true	2015-08-10 15:24:18	desk_com_connector_example.example_list_companies		CREATE view desk_com_connector_example.example_list_companies as 
select
        *
    from
        ( call "desk_com_connector.get_list_companies" ( ) ) df	READY
267	2015-04-24 18:19:41	"1112787754"	true	2015-04-24 18:19:41	views.order_position		"CREATE VIEW views.order_position 
AS
SELECT 
	coa.order_position_id as id,
	coa.order_article_state_number as state,
	null as version,
	coa.article_id,
	coa.date_created,
	null as last_updated,
	coa.order_id,
	coa.articles_picked as quantity,
	coa.supplier_article_id,
	CASE WHEN coa.articles_picked > 0 THEN coa.cost_picked/coa.articles_picked ELSE 0 END as purchase_price,
	CAST(CASE WHEN coa.articles_picked > 0 THEN coa.sales_picked*co.exchange_rate/coa.articles_picked ELSE 0 END as double) as retail_price,
	coa.date_returned,
	coa.date_shipped,
	coa.supplier_order_number,
	coa.date_incoming,
	coa.date_returned_online,
	coa.group_id,
	coa.order_position_count as order_positions_idx,
	coa.track_and_trace_number,
	coa.stock_location_id,
	coa.date_picked,
	coa.date_cancelled as date_canceled,
	coa.date_lost, 
	co.currency_code,
	coa.sales_picked as retail_price_euro,
	co.customer_preview_id as preview_id,
	co.preview_id as topic_box_id,
	coa.feedback_good_colour as feedback_Gute_Farbe,
	coa.feedback_good_quality as feedback_Gute_Qualitaet,
	coa.feedback_good_match_to_customers_style as feedback_Bisherigen_Stil_Gut_Getroffen,
	coa.feedback_damaged as feedback_Artikel_Defekt,
	coa.feedback_good_fit as feedback_Gute_Passform,
	coa.feedback_late_delivery as feedback_Zu_Spaet_Geliefert,
	coa.feedback_not_needed as feedback_Kein_Bedarf,
	coa.feedback_would_like_to_try_something_new as feedback_Lust_Was_Neues_Auszuprobieren,
	0 as feedback_Keine_Aussage1,
	0 as feedback_Keine_Aussage2,
	coa.feedback_too_outrageous feedback_Zu_Ausgefallen,
	coa.feedback_too_big as feedback_Zu_Gross,
	coa.feedback_too_short as feedback_Zu_Kurz,
	coa.feedback_too_cheap as feedback_Zu_Guenstig,
	coa.feedback_dont_like_the_brand as feedback_Marke_Gefaellt_Nicht,
	coa.feedback_too_simple as feedback_Zu_Schlicht,
	coa.feedback_bad_fit as feedback_Schnitt_Sitzt_Nicht,
	coa.feedback_dont_like_the_pattern as feedback_Muster_Gefaellt_Nicht,
	coa.feedback_too_small as feedback_Zu_Klein,
	coa.feedback_dont_like_the_colour as feedback_Farbe_Gefaellt_Nicht,
	0 as feedback_Zu_Kurz_Nochmal_Bestellt,
	0 as feedback_Zu_Gross_Nochmal_Bestellt,
	0 as feedback_Zu_Klein_Nochmal_Bestellt,
	0 as feedback_Zu_Lang_Nochmal_Bestellt,
	0 as feedback_Zu_Eng_Nochmal_Bestellt,
	0 as feedback_Zu_Weit_Nochmal_Bestellt,
	coa.feedback_too_low_quality as feedback_Zu_Minderwertig,
	coa.feedback_too_long as feedback_Zu_Lang,
	coa.feedback_too_tight as feedback_Zu_Eng,
	coa.feedback_too_wide as feedback_Zu_Weit,
	coa.feedback_too_expensive as feedback_Preis_Leistung,
	co.shipping_country
FROM bi.customer_order_articles coa
JOIN bi.customer_order co on co.order_id = coa.order_id"	READY
268	2015-04-24 18:19:47	"1112787755"	true	2015-04-24 18:19:47	views.customer		"CREATE VIEW views.customer
as
SELECT
	c.customer_id,
	c.user_type,
	c.email,
	c.first_name,
	c.last_name,
	null as postfix,
	c.prefix,
	c.profile_id,
	CASE WHEN c.gender = 'Male' THEN 1 ELSE 0 END as salutation,
	c.new_stylist_id as stylist_id,
	c.date_created,
	null as last_login,
	c.token,
	c.facebook_page,
	null as salesforce_id,
	c.referred_by_id,
	c.default_domain as default_page,
	c.national_id,
	f.first_order_date,
	f.first_order_date_completed,
	null as branch_working_in,
	c.date_of_birth,
	c.age_group_felt,
	c.age_group,
	c.height_in_cm,
	c.phone_number,
	null as preferred_brand,
	c.preferred_contact_channel,
	c.preferred_contact_time,
	c.shirt_size,
	c.shoe_size,
	null as trousers_size,
	c.weight_in_kg,
	c.buying_problem_other,
	c.newsletter_accepted,
	null as preferred_brand_other,
	null as spending_budget_for_jeans,
	null as spending_budget_for_shirts,
	null as spending_budget_for_shoes,
	c.occupation as branch_working_in_other,
	c.trousers_size_length,
	c.trousers_size_width,
	null as spending_budget_for_sakkos,
	c.date_created as profile_date_created,
	null as profile_last_updated,
	null as referral,
	c.date_newsletter_confirmed,
	null as preferred_language,
	c.collar_size,
	c.spending_budget_for_shirts_from,
	c.spending_budget_for_shirts_to,
	c.spending_budget_for_jeans_from,
	c.spending_budget_for_jeans_to,
	c.spending_budget_for_shoes_from,
	c.spending_budget_for_shoes_to,
	c.spending_budget_for_jackets_from as spending_budget_for_sakkos_from,
	c.spending_budget_for_jackets_to as spending_budget_for_sakkos_to,
	c.buying_problems,
	null as piclanguage,
	null as picusagereason,
	null as pictypicalbag,
	null as pictypicalshoes,
	null as picclothwork,
	null as picagerange,
	null as pictypicalstyle,
	c.date_first_image_uploaded as customer_image_min_date_created,
	c.date_last_image_uploaded as customer_image_max_last_updated,
	c.image_count as customer_image_image_count,
	c.facebook_image_count as customer_image_facebook_image_count,
	c.other_image_count as customer_image_other_image_count
FROM bi.customer c
LEFT JOIN (
	SELECT 
		co.customer_id,
		min(co.date_created) as first_order_date,
		min(CASE WHEN co.order_state = 'Completed' THEN co.date_created ELSE null END) as first_order_date_completed
	FROM bi.customer_order co 
	GROUP BY co.customer_id
) f on f.customer_id = c.customer_id"	READY
491,567	2015-08-10 15:24:19	"1141300627"	true	2015-08-10 15:24:19	desk_com_connector_example.example_get_list_customers		CREATE view desk_com_connector_example.example_get_list_customers as 
select
        *
    from
        ( call "desk_com_connector.get_list_customers" ( ) ) oo	READY
491,568	2015-08-10 15:24:19	"1141300628"	true	2015-08-10 15:24:19	desk_com_connector_example.example_list_articles		CREATE view desk_com_connector_example.example_list_articles as select
        *
    from
        ( call "desk_com_connector.get_list_articles" ( "dwh_table" => 'dwh.table_list_articles' ) ) df	READY
491,571	2015-08-10 15:24:21	"1141300631"	true	2015-08-10 15:24:21	desk_com_connector_example.example_get_list_facebook_users		CREATE view "desk_com_connector_example"."example_get_list_facebook_users" as select
        *
    from
        ( call "desk_com_connector.get_list_facebook_users" ( ) ) s	READY
491,572	2015-08-10 15:24:21	"1141300632"	true	2015-08-10 15:24:21	desk_com_connector_example.example_get_list_filter_cases		CREATE view "desk_com_connector_example"."example_get_list_filter_cases" as select
        *
    from
        ( call "desk_com_connector.get_list_filter_cases" ( "in_filter_id" => '777', "dwh_table" => 'dwh.list_filter_cases' ) ) aa	READY
491,574	2015-08-10 15:24:22	"1141300634"	true	2015-08-10 15:24:22	desk_com_connector_example.example_get_list_jobs		CREATE view "desk_com_connector_example"."example_get_list_jobs" as select
        *
    from
        ( call "desk_com_connector.get_list_jobs" ( ) ) dd	READY
491,575	2015-08-10 15:24:22	"1141300635"	true	2015-08-10 15:24:22	desk_com_connector_example.example_get_list_macros_actions		create view "desk_com_connector_example"."example_get_list_macros_actions" as 
select
        *
    from
        (
            call "desk_com_connector.get_list_macros_actions" (
                "in_macros_id" => '973715'
            )
        ) aa	READY
491,576	2015-08-10 15:24:23	"1141300636"	true	2015-08-10 15:24:23	desk_com_connector_example.example_get_list_mailboxes_inbound		CREATE view "desk_com_connector_example"."example_get_list_mailboxes_inbound" as 
select
        *
    from
        (
            call "desk_com_connector.get_list_mailboxes_inbound" ()) rr	READY
491,577	2015-08-10 15:24:23	"1141300637"	true	2015-08-10 15:24:23	desk_com_connector_example.example_get_list_mailboxes_outbound		create view "desk_com_connector_example"."example_get_list_mailboxes_outbound" as select
        *
    from
        ( call "desk_com_connector.get_list_mailboxes_outbound" ( ) ) gg	READY
491,578	2015-08-10 15:24:23	"1141300638"	true	2015-08-10 15:24:23	desk_com_connector_example.example_get_list_rules		CREATE view "desk_com_connector_example"."example_get_list_rules" as select
        *
    from
        ( call "desk_com_connector.get_list_rules" ( ) ) ff	READY
491,579	2015-08-10 15:24:24	"1141300639"	true	2015-08-10 15:24:24	desk_com_connector_example.example_get_list_topics		CREATE view desk_com_connector_example.example_get_list_topics as select
        *
    from
        ( call "desk_com_connector.get_list_topics" ( ) ) ff	READY
126	2015-04-24 18:17:55	"1112787681"	true	2015-04-24 18:17:55	raw.stock_imported		"CREATE VIEW raw.stock_imported AS

SELECT
	id AS stock_imported_id,
	code,
	/* have to leave order_id as string due to bad data */
	orderid AS order_id,
	CAST(line_number AS SHORT) AS line_number,
	LEFT(message, 4000) AS message,
	parseTimestamp(date_created, 'yyyy-MM-dd HH:mm:ss.S') as date_stock_imported,
	parseTimestamp(last_updated, 'yyyy-MM-dd HH:mm:ss.S') as last_updated,
	LEFT(processing_reason, 4000) AS processing_reason,
	processing_result,
	processing_state
FROM 
	postgres.doc_data_sales_order_import_result"	READY
491,570	2015-08-10 15:24:21	"1141300630"	true	2015-08-10 15:24:21	desk_com_connector_example.example_get_list_facebook_feeds		CREATE view "desk_com_connector_example"."example_get_list_facebook_feeds" as select
        *
    from
        ( call "desk_com_connector.get_list_facebook_feeds" ( ) ) ss	READY
127	2015-04-24 18:17:55	"1112787682"	true	2015-04-24 18:17:55	raw.purchase_order_import_result		"CREATE VIEW raw.purchase_order_import_result AS

SELECT
	id AS po_import_id,
	code,
	PARSETIMESTAMP(date_created, 'yyyy-MM-dd HH:mm:ss.S') AS po_date_import_result,
	PARSETIMESTAMP(last_updated, 'yyyy-MM-dd HH:mm:ss.S') AS last_updated,
	CAST(outfittery_purchaseid AS LONG) AS purchase_order_id,
	LEFT(message, 4000) AS message,
	LEFT(processing_reason, 4000) AS processing_reason,
	processing_result,
	processing_state,
	type
FROM
	postgres.doc_data_purchase_order_import_result"	READY
129	2015-04-24 18:17:55	"1112787683"	true	2015-04-24 18:17:55	raw.stock_sales_order_header		"CREATE VIEW raw.stock_sales_order_header AS

SELECT
	id AS stock_sales_order_header_id,
	affiliateid AS affiliate_id,
	CAST(orderid AS LONG) AS order_id,
	CAST(customerid AS LONG) AS customer_id,
	parseTimestamp(date_created, 'yyyy-MM-dd HH:mm:ss.S') as date_stock_sales_order_header_created,
	parseTimestamp(last_updated, 'yyyy-MM-dd HH:mm:ss.S') as last_updated,
	LEFT(banking_information, 12) as banking_information,
	country_code,
	currency_code,
	invoice_number,
	/*----customer information----*/
	""name"" AS customer_name,
	order_date,
	""e_mail""  AS customer_email,
	payment_method,
	preferred_language,
	salutation,
	/*----shipping information----*/
	shipping_code,
	city,
	street_address1,
	zip_code
FROM 
	postgres.doc_data_sales_order_header"	READY
273	2015-04-24 18:19:49	"1112787759"	true	2015-04-24 18:19:49	ml.project_phone		"CREATE VIEW ml.project_phone AS
SELECT
co.order_id,
co.customer_id,
co.phone_date,
co.date_created AS customer_date_created,
co.total_gross_billed_amount_in_eur,
co.state,
CAST((co.date_picked IS NOT NULL
		  AND co.state_number >= 16
		  AND co.state_number != 2048)
     	 AS FLOAT) is_processed,
so.notReached__c AS not_reached,
CEILING(CAST(TIMESTAMPDIFF(SQL_TSI_HOUR, co.date_created, co.phone_date) AS FLOAT) / 24.0) AS waiting_days,
CASE WHEN state = 'Cancelled' THEN 1 ELSE 0 END AS cancelled
FROM
bi.customer_order co
JOIN views.salesforce_opportunity so ON co.order_id = so.ExternalOrderId__c
JOIN bi.customer c ON co.customer_id = c.customer_id
JOIN ml.customer_survey cs ON co.customer_id = cs.customer_id
WHERE co.date_created > '2014-07-01'
AND c.user_type = 'Real User'
AND	co.order_type = 'First Order'
AND co.payment_method != 'Pre-pay'
AND co.sales_channel IN ('userbackendWithDate', 'appWithDate', 'websiteWithoutDate', 'websiteWithDate', 'miniAppWithDate')"	FAILED
284	2015-04-24 18:19:54	"1112787765"	true	2015-04-24 18:19:54	ml.customer_articles		"CREATE VIEW ml.customer_articles AS
SELECT
	akr.customer_id,
 	CAST(trim(both ',' from replace(to_chars(akr.kept_articles, 'UTF-8'), unescape('\n'), ',')) AS STRING) AS kept_articles,
 	CAST(trim(both ',' from replace(to_chars(akr.returned_articles, 'UTF-8'), unescape('\n'), ',')) AS STRING) AS returned_articles
FROM
(SELECT
    cas.customer_id,
    textagg(CASE WHEN cas.state = 'Kept' THEN cas.article_ids END QUOTE '') as kept_articles,
    textagg(CASE WHEN cas.state = 'Returned' THEN cas.article_ids END QUOTE '') as returned_articles
FROM
(SELECT
	article_agg.customer_id,
	article_agg.state,
 	CAST(trim(trailing ',' from replace(to_chars(article_agg.articles_blob, 'UTF-8'), unescape('\n'), ',')) AS STRING) AS article_ids
 FROM
(SELECT
	ca.customer_id,
	ca.state,
	textagg(ca.article_id QUOTE '') AS articles_blob
FROM
(SELECT
	co.customer_id,
	coa.article_id,
	coa.order_article_state AS state
FROM bi.customer_order AS co
INNER JOIN bi.customer_order_articles AS coa
	ON co.order_id = coa.order_id) AS ca
GROUP BY ca.customer_id, ca.state)
AS article_agg)
AS cas
GROUP BY cas.customer_id)
AS akr
WHERE akr.kept_articles IS NOT NULL OR akr.returned_articles IS NOT NULL
ORDER BY akr.customer_id ASC"	READY
134	2015-04-24 18:17:56	"638184748"	true	2015-04-24 18:17:56	meta.schema__am		CREATE VIEW meta.schema__am AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('am', 'schema')) as a	READY
135	2015-04-24 18:17:56	"638184749"	true	2015-04-24 18:17:56	meta.schema__bi		CREATE VIEW meta.schema__bi AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('bi', 'schema')) as a	READY
491,573	2015-08-10 15:24:22	"1141300633"	true	2015-08-10 15:24:22	desk_com_connector_example.example_get_list_integration_urls		create view "desk_com_connector_example"."example_get_list_integration_urls" as select
        *
    from
        ( call "desk_com_connector.get_list_integration_urls" ( ) ) ff	READY
491,584	2015-08-10 15:24:25	"1141300644"	true	2015-08-10 15:24:25	desk_com_connector_example.example_get_list_users		CREATE view desk_com_connector_example.example_get_list_users as select
        *
    from
        ( call "desk_com_connector.get_list_users" ( ) ) a	READY
491,585	2015-08-10 15:24:26	"1141300645"	true	2015-08-10 15:24:26	desk_com_connector_example.example_get_list_user_searches		create view "desk_com_connector_example"."example_get_list_user_searches" as select
        *
    from
        ( call "desk_com_connector.get_list_user_searches" ( "in_user_id" => '21674781' ) ) dd	READY
285	2015-04-24 18:19:54	"1112787766"	true	2015-04-24 18:19:54	ml.outfit_articles		"CREATE VIEW ml.outfit_articles AS
SELECT
	DISTINCT article_agg.outfit_id,
	article_agg.date_picked,
 	CAST(trim(trailing ',' from replace(to_chars(article_agg.article_blob, 'UTF-8'), unescape('\n'), ',')) AS STRING) AS articles
 FROM
(SELECT
	coa.outfit_id,
	co.date_stylist_picked AS date_picked,
	TEXTAGG(coa.article_id QUOTE '') OVER (PARTITION BY coa.outfit_id) AS article_blob
FROM bi.customer_order_articles AS coa
INNER JOIN bi.customer_order AS co
	ON coa.order_id = co.order_id) AS article_agg
ORDER BY article_agg.date_picked ASC"	READY
491,586	2015-08-10 15:24:26	"1141300646"	true	2015-08-10 15:24:26	desk_com_connector_example.example_get_list_users_mobile_devices		create view "desk_com_connector_example"."example_get_list_users_mobile_devices" as select
        *
    from
        ( call "desk_com_connector.get_list_users_mobile_devices" ( "in_user_id" => '21674781' ) ) ee	READY
491,587	2015-08-10 15:24:27	"1141300647"	true	2015-08-10 15:24:27	desk_com_connector_example.example_get_list_group_users		create view "desk_com_connector_example"."example_get_list_group_users" as select
        *
    from
        ( call "desk_com_connector.get_list_group_users" ( "in_group_id" => '357346' ) ) ss	READY
143	2015-04-24 18:17:57	"638184757"	true	2015-04-24 18:17:57	meta.schema__snowplow		CREATE VIEW meta.schema__snowplow AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('snowplow', 'schema')) as a	READY
144	2015-04-24 18:17:57	"638184758"	true	2015-04-24 18:17:57	meta.schema__dhltracking		CREATE VIEW meta.schema__dhltracking AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('dhltracking', 'schema')) as a	READY
145	2015-04-24 18:17:57	"638184759"	true	2015-04-24 18:17:57	meta.schema__analytics		CREATE VIEW meta.schema__analytics AS SELECT a.* FROM (call SYSADMIN.getResourceDependencies('analytics', 'schema')) as a	READY
146	2015-04-24 18:17:58	"638184760"	true	2015-04-24 18:17:58	meta.nodes		"CREATE VIEW meta.nodes AS
SELECT
SchemaName || '.' || Name AS ""node"",
SchemaName ""schema""
FROM ""SYS.Tables""
WHERE SchemaName in ( 'am', 'analytics', 'bi', 'dhltracking', 'ml', 'pim', 'postgres', 'raw', 'salesforce', 'snowplow', 'tableau', 'views' )"	READY
69	2015-04-24 18:17:44	"1112787654"	true	2015-04-24 18:17:44	ml.category_new		"CREATE VIEW ml.category_new AS
WITH leaves AS
(
   SELECT
   a0.id AS id_0,
   a0.last_updated,
         (CAST ((a0.id IS NOT NULL) AS INTEGER)) +
   (CAST ((a1.id IS NOT NULL) AS INTEGER)) +
   (CAST ((a2.id IS NOT NULL) AS INTEGER)) +
   (CAST ((a3.id IS NOT NULL) AS INTEGER)) +
   (CAST ((a4.id IS NOT NULL) AS INTEGER)) +
   (CAST ((a5.id IS NOT NULL) AS INTEGER)) AS depth,
         COALESCE( ('sale' = a0.identifier), FALSE ) OR
   COALESCE( ('sale' = a1.identifier), FALSE ) OR
   COALESCE( ('sale' = a2.identifier), FALSE ) OR
   COALESCE( ('sale' = a3.identifier), FALSE ) OR
   COALESCE( ('sale' = a4.identifier), FALSE ) OR
   COALESCE( ('sale' = a5.identifier), FALSE ) OR
   COALESCE( ('premium' = a0.identifier), FALSE ) OR
   COALESCE( ('premium' = a1.identifier), FALSE ) OR
   COALESCE( ('premium' = a2.identifier), FALSE ) OR
   COALESCE( ('premium' = a3.identifier), FALSE ) OR
   COALESCE( ('premium' = a4.identifier), FALSE ) OR
   COALESCE( ('premium' = a5.identifier), FALSE ) AS sale_or_premium,
         a0.identifier AS identifier_0,
   a1.identifier AS identifier_1,
   a2.identifier AS identifier_2,
   a3.identifier AS identifier_3,
   a4.identifier AS identifier_4,
   a5.identifier AS identifier_5
   from postgres.attribute a0
   LEFT JOIN postgres.attribute a1 ON (a0.parent_id = a1.id)
   LEFT JOIN postgres.attribute a2 ON a1.parent_id = a2.id
   LEFT JOIN postgres.attribute a3 ON a2.parent_id = a3.id
   LEFT JOIN postgres.attribute a4 ON a3.parent_id = a4.id
   LEFT JOIN postgres.attribute a5 ON a4.parent_id = a5.id
   LEFT JOIN postgres.attribute att_child ON att_child.parent_id = a0.id
   WHERE a0.property_id = 280118
   AND att_child.id IS NULL
),
fc AS (
	SELECT ""csv_table"".* FROM
   (call ""file"".getFiles('ml_flat_categories.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8')
		COLUMNS
		""category_identifier"" STRING ,
		""flat_category"" STRING
		DELIMITER ','
		QUOTE ''''
		HEADER 1
	)
""csv_table""
)
SELECT
    l.id_0 AS attribute_id,
    l.identifier_0 AS identifier,
    l.depth,
    l.sale_or_premium,
    l.last_updated,
    fc.flat_category,
/**/
    CASE
    WHEN l.depth = 6 THEN identifier_5
    WHEN l.depth = 5 THEN identifier_4
    WHEN l.depth = 4 THEN identifier_3
    WHEN l.depth = 3 THEN identifier_2
    WHEN l.depth = 2 THEN identifier_1
    WHEN l.depth = 1 THEN identifier_0
    END AS c0,
/**/
    CASE
    WHEN l.depth = 5+1 THEN identifier_4
    WHEN l.depth = 4+1 THEN identifier_3
    WHEN l.depth = 3+1 THEN identifier_2
    WHEN l.depth = 2+1 THEN identifier_1
    WHEN l.depth = 1+1 THEN identifier_0
    END AS c1,
/**/
    CASE
    WHEN l.depth = 4+2 THEN identifier_3
    WHEN l.depth = 3+2 THEN identifier_2
    WHEN l.depth = 2+2 THEN identifier_1
    WHEN l.depth = 1+2 THEN identifier_0
    END AS c2,
/**/
    CASE
    WHEN l.depth = 3+3 THEN identifier_2
    WHEN l.depth = 2+3 THEN identifier_1
    WHEN l.depth = 1+3 THEN identifier_0
    END AS c3,
/**/
    CASE
    WHEN l.depth = 2+4 THEN identifier_1
    WHEN l.depth = 1+4 THEN identifier_0
    END AS c4,
/**/
    CASE
    WHEN l.depth = 1+5 THEN identifier_0
    END AS c5
FROM leaves AS l
LEFT JOIN fc ON l.identifier_0 = fc.category_identifier"	READY
148	2015-04-24 18:17:58	"638184762"	true	2015-04-24 18:17:58	am.brand		"CREATE VIEW am.brand AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.brand.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""brand_pim"" STRING ,
		""brand_erp"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
180	2015-04-24 18:18:04	"1112787691"	true	2015-04-24 18:18:04	views.supplier_article_categories		"CREATE view views.supplier_article_categories
AS

SELECT 
  distinct t1.supplier_article_id,
  t1.gender,
  /*Category-1*/
  INITCAP(case
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2)= 'premium' then t1.cat3
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2) in ('sport','sports') then t1.cat3
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2)!= 'premium' then t1.cat2
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2) not in ('sport','sports') then t1.cat2
    else t1.cat1
  end) as ""cat1"", 
  INITCAP(case 
    when t1.cat2 = 'anzge' and lower(t1.cat3) = 'businesshemden' then 'hemden'
    when t1.cat2 = 'anzge' and lower(t1.cat3) = 'krawatten & accessoires' then 'krawatten & accessoires' 
    when t1.cat2 = 'bademode' and lower(t1.cat3) = 'bademntel' then 'wsche'
    when t1.cat2 = 'hosen' and lower(t1.cat3) = 'badeshorts' then 'bade- & surfmode'
    when t1.cat2 = 'bade- & surfmode' and lower(t1.cat3) = 'bademntel' then 'wsche'
    when t1.cat2 = 'bademode' and lower(t1.cat3) = 'badeshorts' then 'bade- & surfmode'
    when t1.cat2 = 'bademode' then 'bade- & surfmode'
    when t1.cat2 = 'boots/stiefel' then 'boots / stiefel' 
    when t1.cat2 = 'brillen' and lower(t1.cat3) = 'sonnenbrillen' then 'sport- & sonnenbrillen' 
    when t1.cat2 = 'business-schuhe' and lower(t1.cat3) = 'slipper' then 'slipper'
    when t1.cat2 = 'business-schuhe' then 'business schuhe' 
    when t1.cat2 = 'funktionswsche' and lower(t1.cat3) = 'hosen lang' then 'wsche' 
    when t1.cat2 = 'funktionswsche' and lower(t1.cat3) = 'shirts' then 'shirts'  
    when t1.cat2 = 'geldbrsen' then 'geldbrsen & etuis' 
    when t1.cat2 = 'halbschuhe' and lower(t1.cat3) = 'slipper' then 'business schuhe'
    when t1.cat2 = 'handschuhe & schals' then 'handschuhe' 
    when t1.cat2 = 'shirts' and lower(t1.cat3) = 'hemden' then 'hemden'
    when t1.cat2 = 'hosen' and lower(t1.cat3) = 'grtel' then 'grtel'
    when t1.cat2 = 'wsche' and lower(t1.cat3) = 'hosen kurz' then 'hosen' 
    when t1.cat2 = 'jacken' and lower(t1.cat3) = 'westen' then 'jacken & westen'
    when t1.cat2 = 'jacken' and lower(t1.cat3) = 'sakkos' then 'jacken / sakkos'
    when t1.cat2 = 'jacken / sakkos' and lower(t1.cat3) ='winterjacken' then 'jacken'
    when t1.cat2 = 'jacken / sakkos' and lower(t1.cat3) ='leichte jacken' then 'jacken'
    when t1.cat2 = 'jacken & westen' and lower(t1.cat3) = 'trainingsjacken' then 'jacken'
    when t1.cat2 = 'jacken & westen' and lower(t1.cat3) = 'fleecejacken' then 'jacken'
    when t1.cat2 = 'jacken / sakkos' and lower(t1.cat3) ='lederjacken' then 'jacken'
    when t1.cat2 = 'jacken / sakkos' and lower(t1.cat3) ='leichte jacken' then 'jacken'
    when t1.cat2 = 'jacken & westen' and lower(t1.cat3) = 'winterjacken & -mntel' then 'winterjacken'
    when t1.cat2 = 'jacken / sakkos' and lower(t1.cat3) = 'winterjacken & -mntel' then 'winterjacken'
    when t1.cat2 = 'jacken' and lower(t1.cat3) = 'winterjacken & -mntel' then 'winterjacken'
    when t1.cat2 = 'mntel' and lower(t1.cat3) = 'winterjacken & -mntel' then 'winterjacken'
    when t1.cat2 = 'jacken & westen' and lower(t1.cat3) = 'westen' then 'jacken & westen'
    when t1.cat2 = 'kopfbedeckungen' then 'hte / mtzen' 
    when t1.cat2 = 'krawatten & accessoires' then 'krawatten & accessoires' 
    when t1.cat2 = 'mtzen' then 'hte / mtzen' 
    when t1.cat2 = 'offene schuhe' and lower(t1.cat3) = 'zehentrenner' then 'offene schuhe'
    when t1.cat2 = 'offene schuhe' then 'offene schuhe'
    when t1.cat2 = 'outdoorschuhe' and lower(t1.cat3) = 'hikingschuhe' then 'wander- & bergschuhe'
    when t1.cat2 = 'pullover & strickjacken' and lower(t1.cat3) = 'kapuzenpullover' then 'pullover'
    when t1.cat2 = 'pullover & strickjacken' and lower(t1.cat3) = 'fleecepullover' then 'pullover'
    when t1.cat2 = 'pullover & strickjacken' and lower(t1.cat3) = 'sweatjacken' then 'sweater'
    when t1.cat2 = 'pullover & strickjacken' and lower(t1.cat3) = 'strickpullover' then 'strick'
    when t1.cat2 = 'pullover & strickjacken' and lower(t1.cat3) = 'strickjacken' then 'strick'
    when t1.cat2 = 'pullover & strickjacken' and lower(t1.cat3) = 'sweatshirts' then 'sweater'
    when t1.cat2 = 'pullover & strickjacken' then 'strick'
    when t1.cat2 = 'pullover & sweater' and lower(t1.cat3) = ' kapuzenpullover' then 'pullover' 
    when t1.cat2 = 'pullover & sweater' and lower(t1.cat3) = ' fleecepullover' then 'pullover' 
    when t1.cat2 = 'pullover & sweater' and lower(t1.cat3) = 'sweatjacken' then 'sweater'
    when t1.cat2 = 'pullover & sweater' then 'pullover' 
    when t1.cat2 = 'ruckscke' then 'taschen & koffer' 
    when t1.cat2 = 'sandalen & zehentrenner' then 'offene schuhe' 
    when t1.cat2 = 'sandalen / pantoletten' then 'offene schuhe' 
    when t1.cat2 = 'schmuck' and lower(t1.cat3) = 'halsketten' then 'uhren & schmuck'
    when t1.cat2 = 'schmuck' then 'uhren & schmuck' 
    when t1.cat2 = 'schnrschuhe' and lower(t1.cat3) = 'bootsschuhe' then 'boots / stiefel'
    when t1.cat2 = 'schnrer' then 'schnrschuhe' 
    when t1.cat2 = 'schuhzubehr' then 'schuhzubehr' 
    when t1.cat2 = 'slipper' and lower(t1.cat3) = 'null' then 'slipper' 
    when t1.cat2 = 'socken & strmpfe' then 'socken & strmpfe' 
    when t1.cat2 = 'sonnenbrillen' then 'sport- & sonnenbrillen' 
    when t1.cat2 = 'sport- & sonnenbrillen' and lower(t1.cat3) = 'sonnenbrillen' then 'sport- & sonnenbrillen' 
    when t1.cat2 = 'sportuhren' and lower(t1.cat3) = 'zeitmesser' then 'sportuhren & elektronik' 
    when t1.cat2 = 'sportuhren' then 'sportuhren & elektronik' 
    when t1.cat2 = 'sportuhren & elektronik' then 'sportuhren & elektronik' 
    when t1.cat2 = 'stiefel & boots' and lower(t1.cat3) = 'snowboots' then 'boots / stiefel'
    when t1.cat2 = 'stiefel & boots' and lower(t1.cat3) = 'trekkingstiefel' then 'outdoorschuhe'
    when t1.cat2 = 'stiefel & boots' then 'boots / stiefel' 
    when t1.cat2 = 'strick / sweat' and lower(t1.cat3) = 'strickjacken' then 'strick'
    when t1.cat2 = 'strick / sweat' and lower(t1.cat3) = 'strickpullover' then 'strick'
    when t1.cat2 = 'strick / sweat' and lower(t1.cat3) = 'sweatshirts' then 'sweater'
    when t1.cat2 = 'strick / sweat' and lower(t1.cat3) = 'sweatjacken' then 'sweater'
    when t1.cat2 = 'strick / sweat' then 'sweater' 
    when t1.cat2 = 'strmpfe' then 'socken & strmpfe' 
    when t1.cat2 = 'taschen' and lower(t1.cat3) = 'ruckscke' then 'taschen & koffer'
    when t1.cat2 = 'taschen' and lower(t1.cat3) = 'umhngetaschen' then 'taschen & koffer'
    when t1.cat2 = 'taschen' then 'taschen & koffer' 
    when t1.cat2 = 'tennisschuhe' then 'tennis- & golfschuhe' 
    when t1.cat2 = 'trainings- & hallenschuhe' then 'trainings- & hallenschuhe' 
    when t1.cat2 = 'trainingsanzge' then 'trainingsanzge' 
    when t1.cat2 = 'trikots & fanartikel' then 'trikots & fanartikel' 
    when t1.cat2 = 'tcher & schals' then 'tcher / schals'  
    when t1.cat2 = 'tcher/schals' then 'tcher / schals' 
    when t1.cat2 = 'uhren' then 'uhren & schmuck' 
    when t1.cat2 = 'umhngetaschen' then 'taschen & koffer' 
    when t1.cat2 = 'unterwsche' and lower(t1.cat3) = 'shirts' then 'shirts'
    when t1.cat2 = 'unterwsche' then 'wsche' 
    else t1.cat2 
  end) as ""category2"",
  /*Category-2*/
  INITCAP(case
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2)= 'premium' then t1.cat4
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2) in ('sport','sports') then t1.cat4
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2)!= 'premium' then t1.cat3
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2) not in ('sport','sports') then t1.cat3
    when lower(t1.cat2) = 'Mtzen Hte & Caps' THEN 'Mtzen, Hte & Caps'
    else t1.cat2
  end) as ""cat2"", 
  /*Category-3*/
  INITCAP(replace(case
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2)= 'premium' then t1.cat5
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2) in ('sport','sports') then t1.cat5
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2)!= 'premium' then t1.cat4
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2) not in ('sport','sports') then t1.cat4
    else t1.cat3
  end,' Alle',''))as ""cat3"",
  INITCAP(case  
    when lower(t1.cat3) =  'sporttaschen' then  'sport- & reisetaschen' 
    when lower(t1.cat3) =  'winterjacken' then  'winterjacken & -mntel' 
    when lower(t1.cat3) =  'winterjacken & -mntel' then  'winterjacken & -mntel' 
    when lower(t1.cat3) =  'wintermntel' then  'winterjacken & -mntel' 
    else lower(t1.cat3) 
  end) as ""category3"",
  /*Category-4*/
  INITCAP(case
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2)= 'premium' then null
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2) in ('sport','sports') then null
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2)!= 'premium' then null
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2) not in ('sport','sports') then null
    else t1.cat4
  end) as ""cat4"", 
  /*Category-5*/
  INITCAP(case
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2)= 'premium' then null
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2) in ('sport','sports') then null
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2)!= 'premium' then null
    when lower(t1.cat1) IN ('sale','premium','sport','sports') and lower(t1.cat2) not in ('sport','sports') then null
    else t1.cat5
  end) as ""cat5""
FROM
(
  SELECT
  supplier_article_id,
  gender,
  replace(lower(cat1),'herren','') as cat1,
  replace(lower(cat2),'herren','') as cat2,
  replace(lower(cat3),'herren','') as cat3,
  replace(lower(cat4),'herren','') as cat4,
  replace(lower(cat5),'herren','') as cat5,
  replace(lower(cat6),'herren','') as cat6,
  replace(lower(cat7),'herren','') as cat7
  from
  (
  	/*Split columns based on delimiter '>', column values assigns amidala category if own stock or else z-categories*/
    SELECT
      a.supplier_article_id,
      CASE
        WHEN a.amidala_categories IS NOT NULL THEN replace(a.amidala_categories,',','')
        WHEN a.amidala_categories IS NULL AND a.category_breadcrumbs IS NULL AND a.category IS NOT NULL THEN replace(a.category,',','')
        WHEN a.amidala_categories IS NULL AND a.category_breadcrumbs IS NOT NULL THEN replace(a.category_breadcrumbs,',','')
    END as category1
  FROM views.article a
  )a1,
  texttable (a1.category1 columns gender string, cat1 string,cat2 string,cat3 string,cat4 string,cat5 string,cat6 string,cat7 string delimiter '>') t
)t1"	READY
178	2015-04-24 18:18:04	"638184813"	true	2015-04-24 18:18:04	views.ga_transactions_firstc		"create view views.ga_transactions_firstc
as
select
 tr.transaction_id as ""transactionid"",
 tr.date_created as ""datecreated"",
 tr.hour_created as ""hourcreated"",
 tr.source,
 tr.medium,
 tr.source || ' / ' || tr.medium as ""sourcemedium"",
 lower(tr.campaign) as ""campaign"",
 trc.cam1,
 trc.cam2,
 trc.cam3,
 trc.cam4,
 trc.cam5,
 trc.cam6,
 trc.cam7,
 trc.cam8,
 trc.cam9,
 trc.cam10,
 trc.cam11,
 trc.cam12,
 trc.cam13,
 trc.cam14,
 trc.cam15,
 tr.keyword,
 tr.transactions
 from
  (select 
    row_number() over (partition by transaction_id order by date_created asc) as ""rnum"",
    transaction_id,
    date_created,
    hour_created,
    source,
    medium,
    campaign,
    keyword,
    cast('1' as integer) as transactions 
   from views.ga_information
   ) tr,
   texttable (lower(tr.campaign) columns ""cam1"" string, ""cam2"" string, ""cam3"" string, ""cam4"" string, ""cam5"" string, 
                                         ""cam6"" string, ""cam7"" string, ""cam8"" string, ""cam9"" string, ""cam10"" string, 
                                         ""cam11"" string, ""cam12"" string, ""cam13"" string, ""cam14"" string, ""cam15"" string delimiter '_') trc   
where tr.rnum= '1'"	READY
179	2015-04-24 18:18:04	"638184814"	true	2015-04-24 18:18:04	views.ga_system_firstc		"CREATE view views.ga_system_firstc
as
select
 sy.transaction_id as ""transactionid"",
 sy.date_created as ""datecreated"",
 sy.hour_created as ""hour_created"",
 sy.device_category as ""devicecategory"",
 sy.operating_system as ""operatingsystem"",
 sy.browser,
 sy.transactions 
 from
  (select 
    row_number() over (partition by transaction_id order by date_created asc) as ""rnum"",
    transaction_id,
    date_created,
    hour_created,
    device_category,
    operating_system,
    browser,
    cast('1' as integer) as transactions 
   from views.ga_information
   ) sy
where sy.rnum= '1'"	READY
181	2015-04-24 18:18:05	"1389130257"	true	2015-09-29 12:32:26	bi.customer		"CREATE VIEW bi.customer
as

SELECT
  c.customer_id,
  c.profile_id,
  sty.stylist_id,
  c.referred_by_id,
  sal.customer_status,
  sal.vip_customer,
  c.club_member,
  CASE 
    WHEN c.club_membership_type = 'CALL' THEN 'Call'
    WHEN c.club_membership_type = 'NO_CALL' THEN 'No Call'
    ELSE c.club_membership_type
  END as club_membership_type,
  c.club_customer_feedback,
  c.club_member_offer,
  c.date_club_activated,
  c.date_club_cancelled,
  c.email,
  c.phone_number,
  c.first_name,
  c.last_name,
  c.prefix,
  c.user_type,
  c.gender,
  c.formal,
  c.guest_account,
  c.customer_age,
  c.age_group,   /* Note: these age groups are chosen to line-up with the survey question: How old do you feel? */
  c.age_group_on_registration,
  CASE 
    WHEN cs.age_felt__18_30 = 1 OR cs.old_age_felt__18_30 = 1 THEN '18-30'
    WHEN cs.age_felt__31_35 = 1 OR cs.old_age_felt__31_35 = 1 THEN '31-35'
    WHEN cs.age_felt__36_45 = 1 OR cs.old_age_felt__36_45 = 1 THEN '36-45'
    WHEN cs.age_felt__46_55 = 1 OR cs.old_age_felt__46_55 = 1 THEN '46-55'
    WHEN cs.old_age_felt__55plus = 1 THEN '56+'
    ELSE null
  END as age_group_felt,
  c.stylist_id as new_stylist_id,
  c.default_domain,
  c.national_id,
  arv.arvato_score as initial_arvato_score,
  
  /*Subscription*/
  c.newsletter_accepted,
  c.subscribed_to_sms,
  c.subscribed_to_stylist_emails,
  CASE
    WHEN c.date_newsletter_confirmed IS NULL THEN '0'
    WHEN c.date_newsletter_confirmed IS NOT NULL THEN '1'
  END as newsletter_confirmed,
  CASE
    WHEN c.subscribed_to_newsletter= 'true' THEN 'Subscribed'
    ELSE 'Unsubscribed'
  END as subscribe_status,

  c.token,
  c.facebook_page,
  c.image_count,
  c.facebook_image_count,
  c.other_image_count,
  c.additional_info,

/* Dates */
  c.date_created,
  c.date_of_birth,
  c.date_newsletter_confirmed,
  c.date_first_image_uploaded,
  c.date_last_image_uploaded,
  c.date_first_club_box,
  
/* Size info */
  c.height_in_cm,
  c.weight_in_kg,
  c.shirt_size,
  c.collar_size,
  c.shoe_size,
  c.trousers_size_width,
  c.trousers_size_length,

/* Other questions */
  c.preferred_contact_channel,
  c.preferred_contact_time,
  c.occupation,
  c.buying_problems,
  c.buying_problem_other,
  cbc.marketing_cluster,

/* Spending Budgets - Note: 
      In the old definitions there was no ""to"" in the final segment, then answer was e.g. 180EUR+. In these cases
        we have put some assumed numbers in, like 250EUR (defined in raw.customer)
*/
  CASE 
    WHEN e1.exchange_rate IS NOT NULL THEN c.spending_budget_for_jeans_from/e1.exchange_rate
    WHEN e2.exchange_rate IS NOT NULL THEN c.spending_budget_for_jeans_from/e2.exchange_rate
    ELSE c.spending_budget_for_jeans_from
  END as spending_budget_for_jeans_from,
  CASE 
    WHEN e1.exchange_rate IS NOT NULL THEN c.spending_budget_for_jeans_to/e1.exchange_rate
    WHEN e2.exchange_rate IS NOT NULL THEN c.spending_budget_for_jeans_to/e2.exchange_rate
    ELSE c.spending_budget_for_jeans_to
  END as spending_budget_for_jeans_to,
  CASE 
    WHEN e1.exchange_rate IS NOT NULL THEN c.spending_budget_for_shirts_from/e1.exchange_rate
    WHEN e2.exchange_rate IS NOT NULL THEN c.spending_budget_for_shirts_from/e2.exchange_rate
    ELSE c.spending_budget_for_shirts_from
  END as spending_budget_for_shirts_from,
  CASE 
    WHEN e1.exchange_rate IS NOT NULL THEN c.spending_budget_for_shirts_to/e1.exchange_rate
    WHEN e2.exchange_rate IS NOT NULL THEN c.spending_budget_for_shirts_to/e2.exchange_rate
    ELSE c.spending_budget_for_shirts_to
  END as spending_budget_for_shirts_to,
  CASE 
    WHEN e1.exchange_rate IS NOT NULL THEN c.spending_budget_for_shoes_from/e1.exchange_rate
    WHEN e2.exchange_rate IS NOT NULL THEN c.spending_budget_for_shoes_from/e2.exchange_rate
    ELSE c.spending_budget_for_shoes_from
  END as spending_budget_for_shoes_from,
  CASE 
    WHEN e1.exchange_rate IS NOT NULL THEN c.spending_budget_for_shoes_to/e1.exchange_rate
    WHEN e2.exchange_rate IS NOT NULL THEN c.spending_budget_for_shoes_to/e2.exchange_rate
    ELSE c.spending_budget_for_shoes_to
  END as spending_budget_for_shoes_to,
  CASE 
    WHEN e1.exchange_rate IS NOT NULL THEN c.spending_budget_for_jackets_from/e1.exchange_rate
    WHEN e2.exchange_rate IS NOT NULL THEN c.spending_budget_for_jackets_from/e2.exchange_rate
    ELSE c.spending_budget_for_jackets_from
  END as spending_budget_for_jackets_from,
  CASE 
    WHEN e1.exchange_rate IS NOT NULL THEN c.spending_budget_for_jackets_to/e1.exchange_rate
    WHEN e2.exchange_rate IS NOT NULL THEN c.spending_budget_for_jackets_to/e2.exchange_rate
    ELSE c.spending_budget_for_jackets_to
  END as spending_budget_for_jackets_to
FROM raw.customer c
LEFT JOIN raw.customer_survey cs on cs.customer_id = c.customer_id
LEFT JOIN raw.customer_salesforce sal on sal.customer_id = c.customer_id
LEFT JOIN raw.customer_brand_cluster cbc on cbc.customer_id=c.customer_id
LEFT JOIN 
(
  SELECT 
    co.customer_id,
    co.currency_code,
    row_number() over (partition by co.customer_id order by co.order_id) as ""rnum""
  FROM raw.customer_order co
) cur on cur.customer_id = c.customer_id AND cur.rnum = 1
LEFT JOIN 
(
  SELECT 
    co.customer_id,
    co.stylist_id,
    row_number() over (partition by co.customer_id order by co.order_id DESC) as ""rnum""
  FROM raw.customer_order co
) sty on sty.customer_id = c.customer_id AND sty.rnum = 1
LEFT JOIN 
(
  SELECT 
    co.customer_id,
    f.arvato_score,
    row_number() over (partition by co.customer_id order by f.date_created) as ""rnum""
  FROM raw.customer_order co
  JOIN raw.financial_transactions f on f.order_id = co.order_id
) arv on arv.customer_id = c.customer_id AND arv.rnum = 1
LEFT JOIN dwh.historical_exchange_rates e1 on e1.currency_code = cur.currency_code AND e1.date = '2014-06-01'   /* Why this date? Why not. */
LEFT JOIN dwh.historical_exchange_rates e2 on e2.currency_code = c.default_domain AND e2.date = '2014-06-01'"	READY
286	2015-04-24 18:19:56	"1112787767"	true	2015-04-24 18:19:56	ml.project_outfit_categories		"CREATE VIEW ml.project_outfit_categories AS
SELECT
outfit_id,
SUM(outfit_slot__over_shirt) AS ""outfit_slot__over_shirt"",
SUM(outfit_slot__shoes) AS ""outfit_slot__shoes"",
SUM(outfit_slot__shirt) AS ""outfit_slot__shirt"",
SUM(outfit_slot__trousers) AS ""outfit_slot__trousers"",
SUM(outfit_slot__belt) AS ""outfit_slot__belt"",
SUM(outfit_slot__jacket) AS ""outfit_slot__jacket"",
SUM(outfit_slot__socks) AS ""outfit_slot__socks"",
SUM(outfit_slot__underwear) AS ""outfit_slot__underwear"",
SUM(outfit_slot__tie) AS ""outfit_slot__tie"",
SUM(outfit_slot__suit) AS ""outfit_slot__suit"",
SUM(outfit_slot__neckwear) AS ""outfit_slot__neckwear"",
SUM(outfit_slot__headwear) AS ""outfit_slot__headwear"",
SUM(flat_category__belt) AS ""flat_category__belt"",
SUM(flat_category__boat_shoe) AS ""flat_category__boat_shoe"",
SUM(flat_category__boots) AS ""flat_category__boots"",
SUM(flat_category__caps) AS ""flat_category__caps"",
SUM(flat_category__cardigan) AS ""flat_category__cardigan"",
SUM(flat_category__cargo_pants) AS ""flat_category__cargo_pants"",
SUM(flat_category__casual_belt) AS ""flat_category__casual_belt"",
SUM(flat_category__casual_lace_up) AS ""flat_category__casual_lace_up"",
SUM(flat_category__casual_shirt) AS ""flat_category__casual_shirt"",
SUM(flat_category__chino) AS ""flat_category__chino"",
SUM(flat_category__dress_pants) AS ""flat_category__dress_pants"",
SUM(flat_category__dress_shirt) AS ""flat_category__dress_shirt"",
SUM(flat_category__dress_shoe) AS ""flat_category__dress_shoe"",
SUM(flat_category__hoodie) AS ""flat_category__hoodie"",
SUM(flat_category__jeans) AS ""flat_category__jeans"",
SUM(flat_category__knee_sock) AS ""flat_category__knee_sock"",
SUM(flat_category__knit_pullover) AS ""flat_category__knit_pullover"",
SUM(flat_category__leather_jacket) AS ""flat_category__leather_jacket"",
SUM(flat_category__long_sleeve_t_shirt) AS ""flat_category__long_sleeve_t_shirt"",
SUM(flat_category__other) AS ""flat_category__other"",
SUM(flat_category__outdoor_jacket) AS ""flat_category__outdoor_jacket"",
SUM(flat_category__polo_shirt) AS ""flat_category__polo_shirt"",
SUM(flat_category__pullover) AS ""flat_category__pullover"",
SUM(flat_category__sandals) AS ""flat_category__sandals"",
SUM(flat_category__scarf) AS ""flat_category__scarf"",
SUM(flat_category__shorts) AS ""flat_category__shorts"",
SUM(flat_category__sneakers) AS ""flat_category__sneakers"",
SUM(flat_category__socks) AS ""flat_category__socks"",
SUM(flat_category__sports) AS ""flat_category__sports"",
SUM(flat_category__sports_shoes) AS ""flat_category__sports_shoes"",
SUM(flat_category__suit) AS ""flat_category__suit"",
SUM(flat_category__suit_jacket) AS ""flat_category__suit_jacket"",
SUM(flat_category__sweatshirt) AS ""flat_category__sweatshirt"",
SUM(flat_category__t_shirt_basic) AS ""flat_category__t_shirt_basic"",
SUM(flat_category__t_shirt_print) AS ""flat_category__t_shirt_print"",
SUM(flat_category__tie) AS ""flat_category__tie"",
SUM(flat_category__underwear) AS ""flat_category__underwear"",
SUM(flat_category__vest) AS ""flat_category__vest"",
SUM(flat_category__waistcoat) AS ""flat_category__waistcoat""
FROM (
SELECT
coa.outfit_id,
CASE WHEN fc.outfit_slot = 'over_shirt' THEN 1 ELSE 0 END AS ""outfit_slot__over_shirt"",
CASE WHEN fc.outfit_slot = 'shoes' THEN 1 ELSE 0 END AS ""outfit_slot__shoes"",
CASE WHEN fc.outfit_slot = 'shirt' THEN 1 ELSE 0 END AS ""outfit_slot__shirt"",
CASE WHEN fc.outfit_slot = 'trousers' THEN 1 ELSE 0 END AS ""outfit_slot__trousers"",
CASE WHEN fc.outfit_slot = 'belt' THEN 1 ELSE 0 END AS ""outfit_slot__belt"",
CASE WHEN fc.outfit_slot = 'jacket' THEN 1 ELSE 0 END AS ""outfit_slot__jacket"",
CASE WHEN fc.outfit_slot = 'socks' THEN 1 ELSE 0 END AS ""outfit_slot__socks"",
CASE WHEN fc.outfit_slot = 'underwear' THEN 1 ELSE 0 END AS ""outfit_slot__underwear"",
CASE WHEN fc.outfit_slot = 'tie' THEN 1 ELSE 0 END AS ""outfit_slot__tie"",
CASE WHEN fc.outfit_slot = 'suit' THEN 1 ELSE 0 END AS ""outfit_slot__suit"",
CASE WHEN fc.outfit_slot = 'neckwear' THEN 1 ELSE 0 END AS ""outfit_slot__neckwear"",
CASE WHEN fc.outfit_slot = 'headwear' THEN 1 ELSE 0 END AS ""outfit_slot__headwear"",
CASE WHEN fc.flat_category = 'belt' THEN 1 ELSE 0 END AS ""flat_category__belt"",
CASE WHEN fc.flat_category = 'boat_shoe' THEN 1 ELSE 0 END AS ""flat_category__boat_shoe"",
CASE WHEN fc.flat_category = 'boots' THEN 1 ELSE 0 END AS ""flat_category__boots"",
CASE WHEN fc.flat_category = 'caps' THEN 1 ELSE 0 END AS ""flat_category__caps"",
CASE WHEN fc.flat_category = 'cardigan' THEN 1 ELSE 0 END AS ""flat_category__cardigan"",
CASE WHEN fc.flat_category = 'cargo_pants' THEN 1 ELSE 0 END AS ""flat_category__cargo_pants"",
CASE WHEN fc.flat_category = 'casual_belt' THEN 1 ELSE 0 END AS ""flat_category__casual_belt"",
CASE WHEN fc.flat_category = 'casual_lace_up' THEN 1 ELSE 0 END AS ""flat_category__casual_lace_up"",
CASE WHEN fc.flat_category = 'casual_shirt' THEN 1 ELSE 0 END AS ""flat_category__casual_shirt"",
CASE WHEN fc.flat_category = 'chino' THEN 1 ELSE 0 END AS ""flat_category__chino"",
CASE WHEN fc.flat_category = 'dress_pants' THEN 1 ELSE 0 END AS ""flat_category__dress_pants"",
CASE WHEN fc.flat_category = 'dress_shirt' THEN 1 ELSE 0 END AS ""flat_category__dress_shirt"",
CASE WHEN fc.flat_category = 'dress_shoe' THEN 1 ELSE 0 END AS ""flat_category__dress_shoe"",
CASE WHEN fc.flat_category = 'hoodie' THEN 1 ELSE 0 END AS ""flat_category__hoodie"",
CASE WHEN fc.flat_category = 'jeans' THEN 1 ELSE 0 END AS ""flat_category__jeans"",
CASE WHEN fc.flat_category = 'knee_sock' THEN 1 ELSE 0 END AS ""flat_category__knee_sock"",
CASE WHEN fc.flat_category = 'knit_pullover' THEN 1 ELSE 0 END AS ""flat_category__knit_pullover"",
CASE WHEN fc.flat_category = 'leather_jacket' THEN 1 ELSE 0 END AS ""flat_category__leather_jacket"",
CASE WHEN fc.flat_category = 'long_sleeve_t_shirt' THEN 1 ELSE 0 END AS ""flat_category__long_sleeve_t_shirt"",
CASE WHEN fc.flat_category = 'other' THEN 1 ELSE 0 END AS ""flat_category__other"",
CASE WHEN fc.flat_category = 'outdoor_jacket' THEN 1 ELSE 0 END AS ""flat_category__outdoor_jacket"",
CASE WHEN fc.flat_category = 'polo_shirt' THEN 1 ELSE 0 END AS ""flat_category__polo_shirt"",
CASE WHEN fc.flat_category = 'pullover' THEN 1 ELSE 0 END AS ""flat_category__pullover"",
CASE WHEN fc.flat_category = 'sandals' THEN 1 ELSE 0 END AS ""flat_category__sandals"",
CASE WHEN fc.flat_category = 'scarf' THEN 1 ELSE 0 END AS ""flat_category__scarf"",
CASE WHEN fc.flat_category = 'shorts' THEN 1 ELSE 0 END AS ""flat_category__shorts"",
CASE WHEN fc.flat_category = 'sneakers' THEN 1 ELSE 0 END AS ""flat_category__sneakers"",
CASE WHEN fc.flat_category = 'socks' THEN 1 ELSE 0 END AS ""flat_category__socks"",
CASE WHEN fc.flat_category = 'sports' THEN 1 ELSE 0 END AS ""flat_category__sports"",
CASE WHEN fc.flat_category = 'sports_shoes' THEN 1 ELSE 0 END AS ""flat_category__sports_shoes"",
CASE WHEN fc.flat_category = 'suit' THEN 1 ELSE 0 END AS ""flat_category__suit"",
CASE WHEN fc.flat_category = 'suit_jacket' THEN 1 ELSE 0 END AS ""flat_category__suit_jacket"",
CASE WHEN fc.flat_category = 'sweatshirt' THEN 1 ELSE 0 END AS ""flat_category__sweatshirt"",
CASE WHEN fc.flat_category = 't_shirt_basic' THEN 1 ELSE 0 END AS ""flat_category__t_shirt_basic"",
CASE WHEN fc.flat_category = 't_shirt_print' THEN 1 ELSE 0 END AS ""flat_category__t_shirt_print"",
CASE WHEN fc.flat_category = 'tie' THEN 1 ELSE 0 END AS ""flat_category__tie"",
CASE WHEN fc.flat_category = 'underwear' THEN 1 ELSE 0 END AS ""flat_category__underwear"",
CASE WHEN fc.flat_category = 'vest' THEN 1 ELSE 0 END AS ""flat_category__vest"",
CASE WHEN fc.flat_category = 'waistcoat' THEN 1 ELSE 0 END AS ""flat_category__waistcoat""
FROM
""bi.customer_order"" co
LEFT JOIN ""bi.customer_order_articles"" coa ON coa.order_id = co.order_id
LEFT JOIN ""bi.article"" a ON a.article_id = coa.article_id
LEFT JOIN ""ml.amidala_category_flat"" acf ON acf.attribute_id = a.article_attribute_id
LEFT JOIN ""ml.flat_category"" fc ON fc.flat_category = acf.flat_category
WHERE co.date_stylist_picked > '2014-01-01'
AND coa.outfit_id IS NOT NULL
) x
GROUP BY x.outfit_id"	READY
491,580	2015-08-10 15:24:24	"1141300640"	true	2015-08-10 15:24:24	desk_com_connector_example.example_get_list_topics_translations		CREATE view "desk_com_connector_example"."example_get_list_topics_translations" as select
        *
    from
        ( call "desk_com_connector.get_list_topics_translations" ( "in_topic_id" => '567135' ) ) ss	READY
491,581	2015-08-10 15:24:25	"1141300641"	true	2015-08-10 15:24:25	desk_com_connector_example.example_get_list_translation_article		CREATE view desk_com_connector_example.example_get_list_translation_article as select
        *
    from
        ( call "desk_com_connector.get_list_translation_article" ( "in_article_id" => '1618949' ) ) ff	READY
491,582	2015-08-10 15:24:25	"1141300642"	true	2015-08-10 15:24:25	desk_com_connector_example.example_get_list_twitter_accounts		CREATE view desk_com_connector_example.example_get_list_twitter_accounts as select
        *
    from
        ( call "desk_com_connector.get_list_twitter_accounts" ( ) ) ss	READY
491,583	2015-08-10 15:24:25	"1141300643"	true	2015-08-10 15:24:25	desk_com_connector_example.example_get_list_twitter_users		CREATE view desk_com_connector_example.example_get_list_twitter_users as select
        *
    from
        ( call "desk_com_connector.get_list_twitter_users" ( ) ) ss	READY
70	2015-04-24 18:17:44	"1112787655"	true	2015-04-24 18:17:44	ml.article_image		"/* Arbitrary image for each OWN STOCK article */
CREATE VIEW ml.article_image AS
SELECT
a.id,
ssa.image_url
FROM
""postgres.article"" a
JOIN 
(
	SELECT
		article_id,
		max(id) as supplier_article_id
	FROM postgres.supplier_article s
	WHERE supplier_id = 15
	GROUP BY 1
) sa on sa.article_id = a.id 
JOIN
postgres.supplier_article ssa ON sa.supplier_article_id = ssa.id"	READY
151	2015-04-24 18:17:58	"638184765"	true	2015-04-24 18:17:58	am.brand_pim__brand_erp		"CREATE VIEW am.brand_pim__brand_erp AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.brand.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""brand_pim"" STRING ,
		""brand_erp"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
152	2015-04-24 18:17:58	"638184766"	true	2015-04-24 18:17:58	am.unit_pim__pieces_erp		"CREATE VIEW am.unit_pim__pieces_erp AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.piece.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""unit_pim"" STRING ,
		""pieces_erp"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
153	2015-04-24 18:17:58	"638184767"	true	2015-04-24 18:17:58	am.brand_pim__blacklisted_countries		"CREATE VIEW am.brand_pim__blacklisted_countries AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.blacklist.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""brand_pim"" STRING ,
		""blacklisted_countries"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
154	2015-04-24 18:17:59	"638184768"	true	2015-04-24 18:17:59	am.season_pim__season_erp		"CREATE VIEW am.season_pim__season_erp AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.season.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""season_pim"" STRING ,
		""season_erp"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
491,588	2015-08-10 15:24:27	"1141300648"	true	2015-08-10 15:24:27	desk_com_connector_example.users_groups_list		create view desk_com_connector_example.users_groups_list as select
        gro."id" as groupid
        , gro."name" as groupname
        , usr."id" as usrid
        , usr."name" as usrname
        , usr."email" as usremail
        , usr."created_at" as usrcreated_at
        , usr."updated_at" as usrupdated_at
        , usr."current_login_at" as usrcurrent_login_at
        , usr."last_login_at" as usrlast_login_at
        , usr."level" as usrlevel
        , usr."email_verified" as usremail_verified
        , usr."public_name" as usrpublic_name
        , usr."avatar" as usravatar
        , usr."available" as usravailable
    from
        table ( call "desk_com_connector.get_list_groups" ( ) ) as gro
        , table ( call "desk_com_connector.get_list_group_users" ( "in_group_id" => gro."id" ) ) as usr	READY
262,145	2015-06-29 14:02:07	"948298797"	true	2015-06-29 14:02:07	sandbox.item_model_checks		"CREATE VIEW sandbox.item_model_checks AS
SELECT 1
/*

I've been running these to check for duplicates, etc.

SELECT COUNT(*), count(distinct ""article_id""), count(distinct ""supplier_article_id""), count(distinct ""item_no""|| ""variant_code"") FROM ""postgres.article_item_variant""
--------------------
SELECT 
	COUNT(*) row_cnt, 
	count(distinct ""supplier_article_id"") supplier_article_ids,
	count(case when ""supplier_article_id"" is null then 1 end) null_supplier_article_ids,	
	count(case when ""article_id"" is null then 1 end) null_article_id, 
	count(distinct case when ""article_id"" is not null then article_id end) not_null_article_id, 
 	count(case when ""item_no""|| ""variant_code"" is null then 1 end) null_item_no_variant,
 	count(distinct case when ""item_no""|| ""variant_code"" is not null then ""item_no""|| ""variant_code"" end) not_null_item_no_variant,
 	count(case when ean is null then 1 end) null_eans,
 	count(distinct case when ean is not null then ean end) not_null_eans
FROM ""bi.item""
-------------
select * 
from ""raw.ami_article_item_variant"" a
	join
	(
	SELECT ""item_no"", ""variant_code"" FROM ""raw.ami_article_item_variant""
	group by 1,2
	having count(*)>1
	) y
	 on a.item_no=y.item_no
	and a.variant_code = y.variant_code
order by 3,4
-------------
SELECT ""item_no"", ""variant_code"" FROM ""bi.item""
group by 1,2
having count(*)>1
-------------------
select item_no||variant_code, count(*)
from ""raw.nav_item"" 
group by 1
order by 2 desc
---------------------------
select * from ""postgres.supplier_article"" where article_id in (32711252,32683255)
*/"	READY
158	2015-04-24 18:17:59	"638184772"	true	2015-04-24 18:17:59	am.cg5__article_group		"CREATE VIEW am.cg5__article_group AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.cg5__article_group.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""commodity_group5"" STRING ,
		""article_category"" STRING ,
		""product_group"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
491,589	2015-08-10 15:24:28	"1141300649"	true	2015-08-10 15:24:28	desk_com_connector_example.example_list_cases4		CREATE view desk_com_connector_example.example_list_cases4 as 
select
        *
    from
        ( call "desk_com_connector.cases_dwh_update" ( "dwh_table" => 'dwh.table_list_cases4' ) ) ii	READY
161	2015-04-24 18:18:00	"638184775"	true	2015-04-24 18:18:00	am.assets		"CREATE VIEW am.assets AS
SELECT *
FROM pim.assets"	READY
71	2015-04-24 18:17:44	"1112787656"	true	2015-04-24 18:17:44	raw.preview_articles		"CREATE VIEW raw.preview_articles
AS
SELECT
	p.id as preview_id,
	pp.id as preview_position_id,
	pp.article_id,
	a.model_id as article_model_id,
	pp.group_id as outfit_id,
	p.name as preview_name,
	p.date_created,
	pp.preview_positions_idx as article_count
FROM postgres.preview p 
JOIN postgres.preview_position pp on pp.preview_id = p.id
JOIN postgres.article a on a.id = pp.article_id
WHERE p.class = 'com.ps.customer.preview.Preview'"	READY
171	2015-04-24 18:18:02	"1112787687"	true	2015-04-24 18:18:02	raw.article		"CREATE VIEW raw.article AS

SELECT 
	CAST(a.id AS LONG) AS article_id,
	a.ean AS article_ean, /*postgres.article.ean IS NOT NULL */	
	pim.oo_id article_oo_id,
	pim.o_parent_id AS article_o_parent_id,
	COALESCE(pim.sku, a.sku) AS article_sku, /* THIS FIELD RARELY NOT NULL */
	COALESCE(pim.supplier_sku, a.manufacturer_sku) AS article_supplier_sku, /*PIM ALMOST ALWAYS THE SAME AS MANUFACTURER SKU, BUT article_manufacturer_sku HAS 5X THE DISTINCT VALUES */
	COALESCE(pim.alternative_supplier_sku, /* almost always = article_manufacturer_alternative_sku; pim HAS SLIGHTLY MORE DISTINCT VALUES */
	CASE 
		WHEN a.manufacturer_alternative_sku != 'UNKNOWN' AND length(a.manufacturer_alternative_sku) > 1 THEN a.manufacturer_alternative_sku 
		ELSE NULL
	END) AS article_supplier_alternative_sku,
	CAST(a.model_id AS LONG) AS article_model_id,
	CAST(sad.model_o_id AS LONG) AS article_model_o_id,
	CASE 
		WHEN pim.ean IS NOT NULL THEN 'article in pim' 
		ELSE 'article not in pim' 
	END AS article_in_pim,
	sad.article_suppliers,
	sad.article_ever_supplied_by_outfittery,
	CAST(a.date_created AS DATE) AS article_date_created,
	CAST(pim.date_latest_delivery AS DATE) AS article_latest_delivery_date,
	CAST(pim.date_earliest_delivery AS DATE) AS article_earliest_delivery_date,
	CASE
		WHEN a.active = TRUE  	THEN 'active in amidala'
		WHEN a.active = FALSE 	THEN 'not active in amidala'
		ELSE NULL
	END AS article_amidala_active,
	CASE /*active IN ARTICLE TABLE SHOWED DIFFERENCES, SO USING PIM; ad.amidala_deactive not always populated when PIM is */
		WHEN pim.amidala_deactive = TRUE 	THEN 'deactive in amidala'
		WHEN pim.amidala_deactive = FALSE 	THEN 'not deactive in amidala'
		ELSE NULL
	END AS article_amidala_deactive,
	CASE
		WHEN pim.reason_deactive = 'supplier_return'  		THEN 'stock will be returned to supplier'
		WHEN pim.reason_deactive = 'outlet_offline' 		THEN 'stock will be sent to outlet or store'
		WHEN pim.reason_deactive = 'marketing_campaigne' 	THEN 'marketing campaign that ended'
		WHEN pim.reason_deactive = 'incorrect_data' 		THEN 'incorrect article information in amidala/pimcore'
		WHEN pim.reason_deactive = 'wrong_pictures' 		THEN 'incorrect pictures in midala/pimcore'				
		WHEN pim.reason_deactive IS NULL 					THEN  NULL
		ELSE 'Ask BI'
	END AS article_reason_amidala_deactive,
	CASE
		WHEN pim.activation_ch = TRUE  THEN 'active in ch amidala'
		WHEN pim.activation_ch = FALSE THEN 'not active in ch amidala'
		ELSE NULL
	END AS article_activation_ch,
	CASE
		WHEN pim.core_article = TRUE  THEN 'core article'
		WHEN pim.core_article = FALSE THEN 'not core article'
		ELSE NULL
	END AS article_core_item,
	CASE
		WHEN pim.published = TRUE  THEN 'published in pim'
		WHEN pim.published = FALSE THEN 'not published in pim'
		ELSE NULL
	END AS article_published,
	/* pim.amidala_check, */
	pim.article_name, /*ad.article_name as article_name_ad; very similar; almost same; could go w/ ad */
	pim.pic1 AS article_pic1, /* ad.pic1 very similar; almost same; could go w/ ad */
	a.title AS article_title, /* a.title good; ad.title, */
	a.brand AS article_brand,
	pim.commodity_group1 AS article_commodity_group1,	/*COMMODITY GROUPS IN ENGLISH IN PIM, GERMAN IN AD */
	pim.commodity_group2 AS article_commodity_group2,
	pim.commodity_group3 AS article_commodity_group3,
	pim.commodity_group4 AS article_commodity_group4,	
	pim.commodity_group5 AS article_commodity_group5,
	a.category AS article_category,	/* sad.category AS article_category,   sad.category very different from a.category  */
	CASE /* HAD IN ad.basic_unit BUT MORE CODE FOR A FEW HUNDRED MORE ROWS POPULATED */
		WHEN LOWER(pim.basic_unit) LIKE '1%piece' 	THEN '1 piece'
		WHEN LOWER(pim.basic_unit) LIKE '2%piece%' 	THEN '2 piece'
		WHEN LOWER(pim.basic_unit) LIKE '3%piece%' 	THEN '3 piece'
		WHEN LOWER(pim.basic_unit) LIKE '4%piece%' 	THEN '4 piece'
		WHEN LOWER(pim.basic_unit) LIKE '5%piece%' 	THEN '5 piece'
		WHEN LOWER(pim.basic_unit) LIKE '%ml'  		THEN 'ml volume'
		WHEN pim.basic_unit IS NULL 				THEN NULL
		ELSE 'Ask BI'
	END AS article_basic_unit,
	a.color AS article_color,
	pim.color1  AS article_color1, /*DEFINITELY WANT TO USE PIM; ITS IN ENGLISH; sad IN GERMAN; few where pim null and ad not null */
	pim.color1_shade AS article_color1_shade, /*DEFINITELY WANT TO USE PIM; ITS IN ENGLISH; sad IN GERMAN; few where pim null and ad not null ) */
	COALESCE(pim.supplier_color_code, a.manufacturer_color_code) AS article_supplier_color_code,
	pim.supplier_color_name AS article_supplier_color_name,
	/* a.manufacturer_color_code AS article_manufacturer_color_code,
	a.manufacturer_color_name AS article_manufacturer_color_name, 
	MANUFACTURER COLOR THE SAME AS PIM.SUPPLIER_COLOR, BUT IN GERMAN*/
	a.size AS article_size,
	pim.hanging_garments AS article_hanging_garment,
	COALESCE(pim.eu_size, sad.eu_size) AS article_eu_size, /* PIM OPTIONAL*/
	COALESCE(pim.supplier_size, sad.supplier_size) AS article_supplier_size, /* DOESN'T LOOK LIKE ad.supplier_size ADDS much */
	COALESCE(pim.eu_length, sad.eu_length) AS article_eu_length, /* PIM OPTIONAL*/
	COALESCE(pim.supplier_length, sad.supplier_length) AS article_supplier_length, /* MANY PIM NULL AND AD NOT NULL) */
	COALESCE(pim.gross_weight_gram, a.weight_gross) AS article_gross_weight_gram, /*article.weight is not null and only 2 cases where it's different from pim */
	COALESCE(pim.net_weight_gram, a.weight_net) AS article_net_weight_gram,
	sad.image_url AS article_image_url, /* sa.img_url null a lot */
	COALESCE(pim.country_of_production, sad.country_of_production) AS article_country_of_production, 
	pim.country_of_origin AS article_country_of_origin,
	pim.buyer AS article_buyer,
	/* TIMES WHEN PIM NULL BUT ARTICLE ISNT; ad.customs_tariff_number as customs_tariff_number_ad null at times */
	COALESCE(pim.customs_tariff_number, a.custom_tariff_number) AS article_customs_tariff_number, 
	pim.customs_tariff_number_ch AS article_customs_tariff_number_ch,
	pim.customs_tariff_number_de AS article_customs_tariff_number_de,
	CASE
		WHEN pim.check_tariff_numbers = TRUE  THEN 'tariff numbers checked'
		WHEN pim.check_tariff_numbers = FALSE THEN 'tariff numbers not checked'
		ELSE NULL
	END AS article_check_tariff_numbers,
 	LEFT(pim.amidala_categories,4000) AS article_amidala_categories, /*LEFT(sad.amidala_categories,4000); formatting different than pim */
	CASE 
		WHEN pim.promotion_item = TRUE  THEN 'promo article' 
		WHEN pim.promotion_item = FALSE THEN 'non promo article'
		ELSE NULL
	END AS article_promotion_item,
	CASE 
		WHEN pim.push = TRUE  THEN 'push article' 
		WHEN pim.push = FALSE THEN 'non push article' 
		ELSE NULL
	END AS article_push_stock,
	pim.nos AS article_nos,
	CASE /* ad nos doesnt always match pim nos */
		WHEN LOWER(pim.nos) LIKE '%all%year%' 	THEN 'nos all year at supplier'
		WHEN LOWER(pim.nos) LIKE '%fs%'			THEN 'nos spring/summer at supplier'
		WHEN LOWER(pim.nos) LIKE '%hw%'			THEN 'nos autumn/winter at supplier'
		WHEN pim.nos IS NULL 					THEN  NULL
		ELSE 'Ask BI'
	END AS article_never_out_of_stock,
	CASE
		WHEN LOWER(pim.supplier_availability) = 'nos' 				THEN 'article always available at supplier'
		WHEN LOWER(pim.supplier_availability) = 'stopped_nos' 		THEN 'nos article not available at supplier'		
		WHEN LOWER(pim.supplier_availability) = 'season' 			THEN 'seasonal article available at supplier'
		WHEN LOWER(pim.supplier_availability) = 'stopped_season' 	THEN 'seasonal article not available at supplier'
		WHEN pim.supplier_availability IS NULL 						THEN NULL
		ELSE 'Ask BI'
	END AS article_supplier_availability,
	CASE
		WHEN pim.season_start IS NULL THEN NULL
		ELSE
			CASE
				WHEN pim.season_start LIKE '%13' OR pim.season_start LIKE '%2013%' THEN '2013-'
				WHEN pim.season_start LIKE '%14' OR pim.season_start LIKE '%2014%' THEN '2014-'
				WHEN pim.season_start LIKE '%15' OR pim.season_start LIKE '%2015%' THEN '2015-'
				WHEN pim.season_start LIKE '%16' OR pim.season_start LIKE '%2016%' THEN '2016-'
				WHEN pim.season_start LIKE '%17' OR pim.season_start LIKE '%2017%' THEN '2017-'
				WHEN pim.season_start LIKE '%18' OR pim.season_start LIKE '%2018%' THEN '2018-'
				WHEN pim.season_start LIKE '%19' OR pim.season_start LIKE '%2019%' THEN '2019-'
				WHEN pim.season_start LIKE '%20' OR pim.season_start LIKE '%2020%' THEN '2020-'
				else ''
			END ||
			CASE
				WHEN LOWER(pim.season_start) LIKE '%all%year%'	THEN 'all year'
				WHEN LOWER(pim.season_start) LIKE '%fs%' 	 	THEN '1-SS'
				WHEN LOWER(pim.season_start) LIKE '%hw%'		THEN '2-FW'
				ELSE ''
			END 
	END AS article_season_start,
	CASE
		WHEN pim.season IS NULL THEN NULL
		ELSE
			CASE /* ad.season covers more data, but it's unclean and doesn't always match pim.season */
				WHEN pim.season LIKE '%13' OR pim.season LIKE '%2013%' THEN '2013-'
				WHEN pim.season LIKE '%14' OR pim.season LIKE '%2014%' THEN '2014-'
				WHEN pim.season LIKE '%15' OR pim.season LIKE '%2015%' THEN '2015-'
				WHEN pim.season LIKE '%16' OR pim.season LIKE '%2016%' THEN '2016-'
				WHEN pim.season LIKE '%17' OR pim.season LIKE '%2017%' THEN '2017-'
				WHEN pim.season LIKE '%18' OR pim.season LIKE '%2018%' THEN '2018-'
				WHEN pim.season LIKE '%19' OR pim.season LIKE '%2019%' THEN '2019-'
				WHEN pim.season LIKE '%20' OR pim.season LIKE '%2020%' THEN '2020-'
				else ''
			END ||
			CASE
				WHEN LOWER(pim.season) LIKE '%all%year%'	THEN 'all year'
				WHEN LOWER(pim.season) LIKE '%fs%' 	 		THEN '1-SS'
				WHEN LOWER(pim.season) LIKE '%hw%'			THEN '2-FW'
				ELSE ''
			END 
	END AS article_season,
	/* CASTING RETAIL PRICES SEEMS OK; NOT SURE ABOUT CASTING ARTICLE COST */
	ROUND(CAST(pim.purchase_price AS DECIMAL), 2) AS article_cost,
	ROUND(CAST(pim.price_retail_de AS DECIMAL), 2) AS article_sales_price_de,
	ROUND(CAST(pim.price_retail_at AS DECIMAL), 2) AS article_sales_price_at,
	ROUND(CAST(pim.price_retail_ch AS DECIMAL), 2) AS article_sales_price_ch,
	ROUND(CAST(pim.price_retail_original AS DECIMAL), 2) AS article_sales_price_original,
		CASE
		WHEN pim.reduced = TRUE 	THEN 'retail price reduced' 
		WHEN pim.reduced = FALSE 	THEN 'no retail price reduction'
		ELSE NULL
	END AS article_sales_price_reduced
	
	
FROM      postgres.article a

LEFT JOIN
(	SELECT * FROM
	(	SELECT
		  ROW_NUMBER() OVER (PARTITION BY p.ean ORDER BY p.date_created DESC) AS rnum,
		  p.ean, p.oo_id, p.net_weight_gram, p.amidala_deactive, p.reason_deactive, p.check_tariff_numbers, p.pic1,
		  p.date_earliest_delivery, p.date_latest_delivery, p.core_article, p.season, p.season_start, p.published, p.reduced,
		  p.article_name, p.supplier_availability, p.supplier_sku, p.alternative_supplier_sku, p.supplier_color_name,
		  p.supplier_color_code, p.push, p.supplier_size, p.supplier_length, p.sku, p.purchase_price, p.price_retail_de,
		  p.price_retail_at, p.price_retail_ch, p.gross_weight_gram, p.price_retail_original, p.customs_tariff_number_de,
		  p.customs_tariff_number_ch, p.activation_ch, p.promotion_item, p.nos, p.commodity_group1, p.commodity_group2, p.commodity_group3, 
		  p.commodity_group4, p.commodity_group5, p.o_parent_id, p.basic_unit, p.customs_tariff_number, p.color1, p.country_of_origin,
		  p.country_of_production, p.color1_shade, p.eu_length, p.eu_size, p.amidala_check, p.hanging_garments, p.buyer,
		  LEFT(CAST(p.amidala_categories AS STRING),4000) AS amidala_categories /* MUST CAST amidala_categories */
		FROM  raw.article_detail_pim p
		WHERE p.ean IS NOT NULL
	) z
	WHERE rnum=1
) pim on a.ean = pim.ean /* DETERMINED THAT ROWS WERE DROPPING OUT WHEN TRYING TO JOIN ON ARTICLE_ID */

LEFT JOIN
( /* GETTING ORDERED SUPPLIER ARTICLE FIELDS */
	SELECT
		sa.article_id,
		sa.article_suppliers,
		sa.article_ever_supplied_by_outfittery,
		COALESCE(fit.supplier_manufacturer_sku, fa.supplier_manufacturer_sku, za.supplier_manufacturer_sku) AS supplier_manufacturer_sku,
		COALESCE(fit.o_parentid, fa.o_parentid, za.o_parentid) AS o_parentid,
		COALESCE(fit.image_url, fa.image_url, za.image_url) AS image_url,
		COALESCE(fit.category, fa.category, za.category) AS category,
		COALESCE(fit.basic_unit, fa.basic_unit, za.basic_unit) AS basic_unit,
		COALESCE(fit.eu_length, fa.eu_length, za.eu_length) AS eu_length,
		COALESCE(fit.eu_size, fa.eu_size, za.eu_size) AS eu_size,
		COALESCE(fit.country_of_production, fa.country_of_production, za.country_of_production) AS country_of_production,
		COALESCE(fit.supplier_sku, fa.supplier_sku, za.supplier_sku) AS supplier_sku,
		COALESCE(fit.supplier_size, fa.supplier_size, za.supplier_size) AS supplier_size,	
		COALESCE(fit.supplier_length, fa.supplier_length, za.supplier_length) AS supplier_length,
		COALESCE(fit.model_o_id, fa.model_o_id, za.model_o_id) AS model_o_id		
		/* COALESCE(fit.customs_tariff_number, fa.customs_tariff_number, za.customs_tariff_number) AS customs_tariff_number, 
		COALESCE(fit.nos, fa.nos, za.nos) AS nos*/
		/*COALESCE(fit., fa., za.) AS ,*/
	FROM
		(SELECT
			article_id, 
			COUNT(DISTINCT supplier_id) AS article_suppliers, 
			MAX(CASE WHEN supplier_id = 15 THEN 'Outfittery' END) AS article_ever_supplied_by_outfittery
	 	 FROM 
	 	 	postgres.supplier_article 
	 	 WHERE 
	 	 	article_id IS NOT NULL GROUP BY 1) sa
		LEFT JOIN (
		SELECT
			sa.article_id,
			MAX(sa.manufacturer_sku) AS supplier_manufacturer_sku,
			MAX(ad.o_parentid) AS o_parentid,
			MAX(sa.image_url) AS image_url, 
			MAX(ad.category) AS category,
			MAX(ad.basic_unit) AS basic_unit,
			MAX(ad.eu_length) AS eu_length,
			MAX(ad.eu_size) AS eu_size,
			MAX(ad.country_of_production) AS country_of_production,
			MAX(ad.customs_tariff_number) AS customs_tariff_number,
			MAX(ad.nos) AS nos,
			MAX(ad.supplier_sku) AS supplier_sku,
			MAX(ad.supplier_length) AS supplier_length,
			MAX(ad.supplier_size) AS supplier_size,
			MAX(ad.model_o_id) AS model_o_id
		FROM
			postgres.supplier_article sa join postgres.article_details ad on sa.id = ad.id
		WHERE
			sa.supplier_id = 15 AND sa.article_id IS NOT NULL
		GROUP BY 1
		) AS fit ON sa.article_id = fit.article_id
		LEFT JOIN (	
		SELECT 
			sa.article_id, 
			MAX(sa.manufacturer_sku) AS supplier_manufacturer_sku,
			MAX(ad.o_parentid) AS o_parentid,
			MAX(sa.image_url) AS image_url, 
			MAX(ad.category) AS category,
			MAX(ad.basic_unit) AS basic_unit,
			MAX(ad.eu_length) AS eu_length,
			MAX(ad.eu_size) AS eu_size,
			MAX(ad.country_of_production) AS country_of_production,
			MAX(ad.customs_tariff_number) AS customs_tariff_number,
			MAX(ad.nos) AS nos,
			MAX(ad.supplier_sku) AS supplier_sku,
			MAX(ad.supplier_length) AS supplier_length,
			MAX(ad.supplier_size) AS supplier_size,
			MAX(ad.model_o_id) AS model_o_id
		FROM
			postgres.supplier_article sa join postgres.article_details ad on sa.id = ad.id
		WHERE
			sa.supplier_id = 10	AND sa.article_id IS NOT NULL
		GROUP BY 1
		) AS za on sa.article_id = za.article_id
		LEFT JOIN (
		SELECT 
			sa.article_id, 
			MAX(sa.manufacturer_sku) AS supplier_manufacturer_sku,
			MAX(ad.o_parentid) AS o_parentid,
			MAX(sa.image_url) AS image_url, 
			MAX(ad.category) AS category,
			MAX(ad.basic_unit) AS basic_unit,
			MAX(ad.eu_length) AS eu_length,
			MAX(ad.eu_size) AS eu_size,
			MAX(ad.country_of_production) AS country_of_production,
			MAX(ad.customs_tariff_number) AS customs_tariff_number,
			MAX(ad.nos) AS nos,
			MAX(ad.supplier_sku) AS supplier_sku,
			MAX(ad.supplier_length) AS supplier_length,
			MAX(ad.supplier_size) AS supplier_size,
			MAX(ad.model_o_id) AS model_o_id
		FROM
			postgres.supplier_article sa join postgres.article_details ad on sa.id = ad.id
		WHERE
			sa.supplier_id = 30 AND sa.article_id IS NOT NULL
		GROUP BY 1
		) AS fa on sa.article_id = fa.article_id
) sad on a.id = sad.article_id"	READY
287	2015-04-24 18:19:57	"1112787768"	true	2015-04-24 18:19:57	ml.project_outfit_articles		"CREATE VIEW ml.project_outfit_articles AS
SELECT
coa.outfit_id,
coa.article_id,
a.article_model_id,
a.article_model_id || '_' || a.article_color AS ""molor"",
a.article_color,
a.article_brand,
fc.flat_category,
fc.outfit_slot
FROM
""bi.customer_order_articles"" coa
LEFT JOIN ""bi.customer_order"" co ON coa.order_id = co.order_id
LEFT JOIN ""bi.article"" a ON a.article_id = coa.article_id
LEFT JOIN ""ml.amidala_category_flat"" acf ON acf.attribute_id = a.article_attribute_id
LEFT JOIN ""ml.flat_category"" fc ON fc.flat_category = acf.flat_category
WHERE coa.date_created > '2014-01-01'"	READY
288	2015-04-24 18:19:58	"1112787769"	true	2015-04-24 18:19:58	ml.article_molor		"CREATE VIEW ml.article_molor AS
SELECT
	ar.article_id,
	CASE WHEN ar.article_model_id IS NOT NULL
	  	  AND ar.article_color IS NOT NULL
	      AND ar.article_color != 'UNKNOWN'
	      AND ar.article_model_id != 0
	     THEN ar.article_model_id || '_' || ar.article_color ELSE ar.article_id END AS molor_id
FROM bi.article AS ar
ORDER BY ar.article_id ASC"	READY
289	2015-04-24 18:19:58	"1112787770"	true	2015-04-24 18:19:58	ml.article_season		"CREATE VIEW ml.article_season AS
SELECT
	agohe.article_id,
	CASE WHEN agohe.season_fs15 = 1
         THEN 1 ELSE 0 END AS year_2015,
	CASE WHEN agohe.herbst_winter_2014 = 1
           OR agohe.fruehjahr_sommer_2014 = 1
         THEN 1 ELSE 0 END AS year_2014,
	CASE WHEN agohe.herbst_winter_2013 = 1
           OR agohe.fruehjahr_sommer_2013 = 1
         THEN 1 ELSE 0 END AS year_2013,
	CASE WHEN agohe.herbst_winter_2012 = 1
           OR agohe.fruehjahr_sommer_2012 = 1
         THEN 1 ELSE 0 END AS year_2012,
	CASE WHEN agohe.herbst_winter_2011 = 1
           OR agohe.fruehjahr_sommer_2011 = 1
         THEN 1 ELSE 0 END AS year_2011,
	CASE WHEN agohe.herbst_winter_2010 = 1
           OR agohe.fruehjahr_sommer_2010 = 1
         THEN 1 ELSE 0 END AS year_2010,
	CASE WHEN agohe.herbst_winter_2009 = 1
           OR agohe.fruehjahr_sommer_2009 = 1
         THEN 1 ELSE 0 END AS year_2009,
	CASE WHEN agohe.herbst_winter_2009 = 1
           OR agohe.herbst_winter_2010 = 1
           OR agohe.herbst_winter_2011 = 1
           OR agohe.herbst_winter_2012 = 1
           OR agohe.herbst_winter_2013 = 1
           OR agohe.herbst_winter_2014 = 1
           OR agohe.hw_basisartikel    = 1
         THEN 1 ELSE 0 END AS season_autumn_winter,
    CASE WHEN agohe.fruehjahr_sommer_2009 = 1
           OR agohe.fruehjahr_sommer_2010 = 1
           OR agohe.fruehjahr_sommer_2011 = 1
           OR agohe.fruehjahr_sommer_2012 = 1
           OR agohe.fruehjahr_sommer_2013 = 1
           OR agohe.fruehjahr_sommer_2014 = 1
           OR agohe.season_fs15           = 1
           OR agohe.fs_basisartikel       = 1
         THEN 1 ELSE 0 END AS season_spring_summer,
    CASE WHEN agohe.ganzjaehriger_basisartikel = 1
           OR agohe.hw_basisartikel = 1
           OR agohe.fs_basisartikel = 1
           OR agohe.basisartikel    = 1
         THEN 1 ELSE 0 END AS basic_article
FROM
(SELECT
	aiohe.article_id,
	MAX(aiohe.herbst_winter_2014) AS herbst_winter_2014,
	MAX(aiohe.season_fs15) AS season_fs15,
	MAX(aiohe.herbst_winter_2013) AS herbst_winter_2013,
	MAX(aiohe.fruehjahr_sommer_2013) AS fruehjahr_sommer_2013,
	MAX(aiohe.herbst_winter_2012) AS herbst_winter_2012,
	MAX(aiohe.ganzjaehriger_basisartikel) AS ganzjaehriger_basisartikel,
	MAX(aiohe.fruehjahr_sommer_2012) AS fruehjahr_sommer_2012,
	MAX(aiohe.fruehjahr_sommer_2014) AS fruehjahr_sommer_2014,
	MAX(aiohe.basisartikel) AS basisartikel,
	MAX(aiohe.hw_basisartikel) AS hw_basisartikel,
	MAX(aiohe.herbst_winter_2011) AS herbst_winter_2011,
	MAX(aiohe.fs_basisartikel) AS fs_basisartikel,
	MAX(aiohe.fruehjahr_sommer_2011) AS fruehjahr_sommer_2011,
	MAX(aiohe.herbst_winter_2010) AS herbst_winter_2010,
	MAX(aiohe.herbst_winter_2009) AS herbst_winter_2009,
	MAX(aiohe.fruehjahr_sommer_2010) AS fruehjahr_sommer_2010,
	MAX(aiohe.fruehjahr_sommer_2009) AS fruehjahr_sommer_2009
FROM
 (SELECT
    a.article_id,
    CASE WHEN asi.attribute_identifier = 'herbst_winter_2014' THEN 1 ELSE 0 END AS herbst_winter_2014,
    CASE WHEN asi.attribute_identifier = 'season_fs15' THEN 1 ELSE 0 END AS season_fs15,
    CASE WHEN asi.attribute_identifier = 'herbst_winter_2013' THEN 1 ELSE 0 END AS herbst_winter_2013,
    CASE WHEN asi.attribute_identifier = 'fruehjahr_sommer_2013' THEN 1 ELSE 0 END AS fruehjahr_sommer_2013,
    CASE WHEN asi.attribute_identifier = 'herbst_winter_2012' THEN 1 ELSE 0 END AS herbst_winter_2012,
    CASE WHEN asi.attribute_identifier = 'ganzjaehriger_basisartikel' THEN 1 ELSE 0 END AS ganzjaehriger_basisartikel,
    CASE WHEN asi.attribute_identifier = 'fruehjahr_sommer_2012' THEN 1 ELSE 0 END AS fruehjahr_sommer_2012,
    CASE WHEN asi.attribute_identifier = 'fruehjahr_sommer_2014' THEN 1 ELSE 0 END AS fruehjahr_sommer_2014,
    CASE WHEN asi.attribute_identifier = 'basisartikel' THEN 1 ELSE 0 END AS basisartikel,
    CASE WHEN asi.attribute_identifier = 'hw_basisartikel' THEN 1 ELSE 0 END AS hw_basisartikel,
    CASE WHEN asi.attribute_identifier = 'herbst_winter_2011' THEN 1 ELSE 0 END AS herbst_winter_2011,
    CASE WHEN asi.attribute_identifier = 'fs_basisartikel' THEN 1 ELSE 0 END AS fs_basisartikel,
    CASE WHEN asi.attribute_identifier = 'fruehjahr_sommer_2011' THEN 1 ELSE 0 END AS fruehjahr_sommer_2011,
    CASE WHEN asi.attribute_identifier = 'herbst_winter_2010' THEN 1 ELSE 0 END AS herbst_winter_2010,
    CASE WHEN asi.attribute_identifier = 'herbst_winter_2009' THEN 1 ELSE 0 END AS herbst_winter_2009,
    CASE WHEN asi.attribute_identifier = 'fruehjahr_sommer_2010' THEN 1 ELSE 0 END AS fruehjahr_sommer_2010,
    CASE WHEN asi.attribute_identifier = 'fruehjahr_sommer_2009' THEN 1 ELSE 0 END AS fruehjahr_sommer_2009
FROM bi.article AS a
LEFT JOIN ml.article_attribute AS aa
	ON a.article_id = aa.article_id
LEFT JOIN ml.attribute_season AS asi
	ON asi.attribute_id = aa.attribute_id) AS aiohe
GROUP BY aiohe.article_id) AS agohe
ORDER BY article_id ASC"	READY
491,590	2015-08-10 15:24:28	"1141300650"	true	2015-08-10 15:24:28	desk_com_connector_example.case_overview_report		CREATE view "desk_com_connector_example"."case_overview_report" as select
        rr.date_created_at
        , rr.cont_created
        , rr.cont_resolved
        , ss2.Time_from_seconds_int as avg_frst_resolved
        , ss3.Time_from_seconds_int as avg_resolved
        , ss4.Time_from_seconds_int as avg_handletime
        , rr.FCR_RATE_proc
    from
        table ( select
                parsedate ( g.date_created_at, 'yyyy-MM-dd' ) as date_created_at
                , sum ( g.cou_created ) as cont_created
                , sum ( g.cou_resolved ) as cont_resolved
                , avg ( g.timedifffrstresolve ) as timedifffrstresolve
                , avg ( g.timediffresolve ) as timediffresolve
                , avg ( g.handletime ) / sum ( g.cou_created ) as handletime
                , round ( ( cast ( sum ( g.cou_resolved ) as double ) / cast ( sum ( g.cou_created ) as double ) * 100 ), 2 ) as FCR_RATE_proc
            from
                table ( SELECT
                        count ( created_at ) as cou_created
                        , count ( resolved_at ) as cou_resolved
                        , FORMATTIMESTAMP ( created_at, 'yyyy-MM-dd' ) as date_created_at
                        , timestampdiff ( SQL_TSI_SECOND, "created_at", nvl ( "first_resolved_at", "created_at" ) ) as timedifffrstresolve
                        , timestampdiff ( SQL_TSI_SECOND, "created_at", nvl ( "resolved_at", "created_at" ) ) as timediffresolve
                        , timestampdiff ( SQL_TSI_SECOND, nvl ( "received_at", "created_at" ), nvl ( "first_resolved_at", "created_at" ) ) as handletime
                    FROM
                        "desk_com_connector_example.example_list_cases4"
                    group by
                        created_at
                        , first_resolved_at
                        , resolved_at
                        , received_at ) as g
            group by
                g.date_created_at ) as rr, table ( call "desk_com_connector.internal_integer_to_Time2" ( "in_seconds" => cast ( rr.timedifffrstresolve as integer ) ) ) ss2, table ( call "desk_com_connector.internal_integer_to_Time2" ( "in_seconds" => cast ( rr.timediffresolve as integer ) ) ) ss3, table ( call "desk_com_connector.internal_integer_to_Time2" ( "in_seconds" => cast ( rr.handletime as integer ) ) ) ss4	READY
164	2015-04-24 18:18:00	"638184780"	true	2015-04-24 18:18:00	am.size_mapping_new		"CREATE VIEW am.size_mapping_new AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.size_mapping_new.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""commodity_group4"" STRING ,
		""brand"" STRING ,
		""eu_size"" STRING ,
		""eu_length"" STRING ,
		""Size Group Code"" STRING ,
		""Description"" STRING ,
		""NAV size"" STRING ,
		""eu_size_x_length"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
290	2015-04-24 18:19:59	"1112787771"	true	2015-04-24 18:19:59	bi.customer_order_2nd_step_conversion_forecast		"CREATE VIEW bi.customer_order_2nd_step_conversion_forecast
AS
SELECT 
	a.days_from_incoming,
	b.box_type,
	b.pre_pay,
	CAST(SUM(proc.processed_orders) as float)/avg(tot.total_incoming_orders) as conversion_rate
FROM
(
	SELECT 
		TIMESTAMPDIFF(SQL_TSI_DAY, c.date, CURDATE()) as days_from_incoming
	FROM dwh.calendar c
	WHERE c.date > TIMESTAMPADD(SQL_TSI_DAY, -61, CURDATE())
	AND c.date <= CURDATE()
) a
CROSS JOIN 
(
	SELECT 'Call Box' as box_type, 0 as pre_pay 
	UNION SELECT 'Call Box' as box_type, 1 as pre_pay 
	UNION SELECT 'No Call Box' as box_type, 0 as pre_pay 
	UNION SELECT 'No Call Box' as box_type, 1 as pre_pay 
) b
LEFT JOIN 
(
	SELECT
		box_type,
		pre_pay,
		count(*) as total_incoming_orders
	FROM bi.customer_order co 
	WHERE order_type = 'First Order'
	AND date_incoming > TIMESTAMPADD(SQL_TSI_DAY, -120, CURDATE())
	AND date_incoming < TIMESTAMPADD(SQL_TSI_DAY, -60, CURDATE())
	GROUP BY 1,2
) tot on tot.box_type = b.box_type and tot.pre_pay = b.pre_pay
LEFT JOIN
(
	SELECT
		TIMESTAMPDIFF(SQL_TSI_DAY, date_incoming, date_stylist_picked) as days_from_incoming,
		box_type,
		pre_pay,
		count(*) as processed_orders
	FROM bi.customer_order co 
	WHERE order_type = 'First Order'
	AND date_incoming > TIMESTAMPADD(SQL_TSI_DAY, -120, CURDATE())
	AND date_incoming < TIMESTAMPADD(SQL_TSI_DAY, -60, CURDATE())
	AND date_stylist_picked > date_incoming
	GROUP BY 1,2,3
) proc on proc.days_from_incoming >= a.days_from_incoming AND proc.box_type = b.box_type AND proc.pre_pay = b.pre_pay
GROUP BY 1,2,3"	READY
166	2015-04-24 18:18:01	"638184784"	true	2015-04-24 18:18:01	am.size_raw__size_normalized		"CREATE VIEW ""am.size_raw__size_normalized"" AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.size_normalization.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""eu_size"" STRING ,
		""eu_size_normed"" STRING ,
		""bad"" STRING 
		DELIMITER ',' 
		QUOTE '""' 
		HEADER 1 
	)
""csv_table"""	READY
291	2015-04-24 18:19:59	"1112787772"	true	2015-04-24 18:19:59	ml.article_catbra		"CREATE VIEW ml.article_catbra AS
SELECT
	a.article_id,
	a.article_brand AS brand,
	fc.flat_category,
	CASE WHEN fc.flat_category IS NOT NULL AND a.article_brand IS NOT NULL
		 THEN fc.flat_category || '_' || a.article_brand ELSE a.article_id END AS catbra
FROM bi.article AS a 
LEFT JOIN ml.amidala_category_flat acf 
	ON acf.attribute_id = a.article_attribute_id
LEFT JOIN ml.flat_category fc 
	ON fc.flat_category = acf.flat_category"	READY
294	2015-04-24 18:20:01	"1112787775"	true	2015-04-24 18:20:01	ml.article_amidala_age		"CREATE VIEW ml.article_amidala_age AS
SELECT
	aiohe.article_id,
	MAX(aiohe.all_ages) AS all_ages,
	MAX(aiohe.under_40) AS under_40,
	MAX(aiohe.over_40) AS over_40
FROM
 (SELECT
    a.article_id,
    CASE WHEN age.attribute_identifier = 'all'
           OR age.attribute_identifier = 'alle'
         THEN 1 ELSE 0 END AS all_ages,
    CASE WHEN age.attribute_identifier = 'under_40'
           OR age.attribute_identifier = 'unter_40'
         THEN 1 ELSE 0 END AS under_40,
    CASE WHEN age.attribute_identifier = 'ueber_40'
         THEN 1 ELSE 0 END AS over_40
    FROM bi.article AS a
LEFT JOIN ml.article_attribute AS aa
	ON a.article_id = aa.article_id
LEFT JOIN ml.attribute_amidala_age AS age
	ON age.attribute_id = aa.attribute_id) AS aiohe
GROUP BY aiohe.article_id
ORDER BY article_id ASC"	READY
169	2015-04-24 18:18:01	"638184787"	true	2015-04-24 18:18:01	views.scantemplates_agg		"CREATE view views.scantemplates_agg as
select
po,
ean,
count(*) as count_scans,
count(case when ean_unknown = 'JA' then 1 else null end) as count_ean_unknown,
count(case when photo_article = 'JA' then 1 else null end) as count_photo_article,
count(case when article_overdelivered = 'JA' then 1 else null end) as count_overdelivered,
count(case when hanging = 'JA' then 1 else null end) as count_hanging,
max(date_uploaded) as max_date_uploaded,
min(date_uploaded) as min_date_uploaded,
max(date_scanned) as max_date_scanned,
min(date_scanned) as min_date_scanned,
max(date_given_to_serviceprovi) as max_date_given_to_serviceprovider,
min(date_given_to_serviceprovi) as min_date_given_to_serviceprovider,
max(date_delivered) as max_date_delivered,
min(date_delivered) as min_date_delivered
from views.scantemplates
group by 1,2
order by 1"	READY
491,591	2015-08-10 15:24:29	"1141300651"	true	2015-08-10 15:24:29	desk_com_connector_example.case_overview_report_sum		CREATE view "desk_com_connector_example"."case_overview_report_sum" as select
        rr.cont_created
        , rr.cont_resolved
        , ss2.Time_from_seconds_int as avg_frst_resolved
        , ss3.Time_from_seconds_int as avg_resolved
        , ss4.Time_from_seconds_int as avg_handletime
        , rr.FCR_RATE_proc
    from
        table ( select
                sum ( g.cou_created ) as cont_created
                , sum ( g.cou_resolved ) as cont_resolved
                , avg ( g.timedifffrstresolve ) as timedifffrstresolve
                , avg ( g.timediffresolve ) as timediffresolve
                , avg ( g.handletime ) / sum ( g.cou_created ) as handletime
                , round ( ( cast ( sum ( g.cou_resolved ) as double ) / cast ( sum ( g.cou_created ) as double ) * 100 ), 2 ) as FCR_RATE_proc
            from
                table ( SELECT
                        count ( created_at ) as cou_created
                        , count ( resolved_at ) as cou_resolved
                        , FORMATTIMESTAMP ( created_at, 'yyyy-MM-dd' ) as date_created_at
                        , timestampdiff ( SQL_TSI_SECOND, "created_at", nvl ( "first_resolved_at", "created_at" ) ) as timedifffrstresolve
                        , timestampdiff ( SQL_TSI_SECOND, "created_at", nvl ( "resolved_at", "created_at" ) ) as timediffresolve
                        , timestampdiff ( SQL_TSI_SECOND, nvl ( "received_at", "created_at" ), nvl ( "first_resolved_at", "created_at" ) ) as handletime
                    FROM
                        "desk_com_connector_example.example_list_cases4"
                    group by
                        created_at
                        , first_resolved_at
                        , resolved_at
                        , received_at ) as g ) as rr, table ( call "desk_com_connector.internal_integer_to_Time2" ( "in_seconds" => cast ( rr.timedifffrstresolve as integer ) ) ) ss2, table ( call "desk_com_connector.internal_integer_to_Time2" ( "in_seconds" => cast ( rr.timediffresolve as integer ) ) ) ss3, table ( call "desk_com_connector.internal_integer_to_Time2" ( "in_seconds" => cast ( rr.handletime as integer ) ) ) ss4
    order by
        rr.cont_created desc	READY
75	2015-04-24 18:17:45	"1112787660"	true	2015-07-13 14:17:56	raw.marketing_costs		"CREATE VIEW ""raw.marketing_costs"" 
AS

SELECT
    date_created,
    country,
    channel,
    marketing_channel,
    SUM(cost) as cost
FROM
(
SELECT
      CAST(mco.date_created as date) as date_created,
      mco.country as country,
      CASE
        WHEN mco.channel= 'gdn' THEN 'google gdn'
        WHEN mco.channel= 'sem' THEN 'google sem'
        WHEN mco.channel= 'display' THEN 'display'
        WHEN mco.channel= 'facebook' THEN 'facebook'
        WHEN mco.channel= 'affiliate' THEN 'affiliate'
        WHEN mco.channel= 'crm' THEN 'crm'
        WHEN mco.channel= 'kooperationen' THEN 'kooperation'
        WHEN mco.channel= 'referral' THEN 'praemienprogramm'
        WHEN mco.channel= 'remarketing' THEN 'remarketing'
        WHEN mco.channel= 'seo/direct' THEN 'seo/direct'
        WHEN mco.channel= 'tv' THEN 'tv'
        WHEN mco.channel= 'twitter' THEN 'twitter' 
        WHEN mco.channel= 'youtube' THEN 'youtube'
        WHEN mco.channel= 'sem_brand' THEN 'google sem brand'
        WHEN mco.channel= 'sem_nobrand' THEN 'google sem nobrand'
        WHEN mco.channel= 'appdownload' THEN 'app download campaign'
        WHEN mco.channel= 'offline_promotions' THEN 'Offline_Promotions'
        WHEN mco.channel= 'linkedin' THEN 'LinkedIn'
        WHEN mco.channel= 'xing' THEN 'Xing'
        WHEN mco.channel= 'insert' THEN 'Insert'
    END as channel,
        CASE
        WHEN mco.channel= 'gdn' THEN 'Display'
        WHEN mco.channel= 'sem' THEN 'SEM Non-brand'
        WHEN mco.channel= 'display' THEN 'Display'
        WHEN mco.channel= 'facebook' THEN 'Facebook'
        WHEN mco.channel= 'affiliate' THEN 'Affiliate'
        WHEN mco.channel= 'crm' THEN 'CRM'
        WHEN mco.channel= 'kooperationen' THEN 'Cooperations'
        WHEN mco.channel= 'referral' THEN 'praemienprogramm'
        WHEN mco.channel= 'remarketing' THEN 'Remarketing'
        WHEN mco.channel= 'seo/direct' THEN 'SEO'
        WHEN mco.channel= 'tv' THEN 'TV'
        WHEN mco.channel= 'twitter' THEN 'Social Media' 
        WHEN mco.channel= 'youtube' THEN 'Social Media'
        WHEN mco.channel= 'sem_brand' THEN 'SEM Brand'
        WHEN mco.channel= 'sem_nobrand' THEN 'SEM Non-brand'
        WHEN mco.channel= 'appdownload' THEN 'App campaign'
        WHEN mco.channel= 'offline_promotions' THEN 'Offline Promotions'
        WHEN mco.channel= 'linkedin' THEN 'Social Media'
        WHEN mco.channel= 'xing' THEN 'Xing'
        WHEN mco.channel= 'insert' THEN 'Inserts'
      END as marketing_channel,
      CASE 
        WHEN country NOT IN ('CH','AT') AND mco.channel IN ('insert', 'kooperation') AND CAST(mco.date_created as date) >= '2015-05-01' THEN null
        WHEN country IN ('CH','AT') AND mco.channel IN ('insert', 'kooperation') AND CAST(mco.date_created as date) >= '2015-07-13' THEN null
        ELSE CAST(mco.costs as double)/e.exchange_rate 
      END as cost
    FROM 
    (
      SELECT
        row_number() over (partition by ""datecreated"" || ""country"" || ""channel"" || ""costs"" || ""currency"" order by ""datecreated"" desc) as ""rnum"",
        replace(cast(datecreated as date),' ','') as date_created,
        replace(country,' ','') as ""country"",
        lower(replace(channel,' ','')) as ""channel"",
        replace(cast(costs as double),' ','') as ""costs"",
        replace(currency,' ','') as ""currency""
    FROM dwh.marketingcost 
    ) mco
    JOIN dwh.historical_exchange_rates e on e.currency_code = mco.currency AND e.date = mco.date_created
    WHERE mco.rnum = 1
UNION 
	SELECT 
	    date_created,
	    country,
	    CASE
	        WHEN marketing_channel = 'Cooperations' THEN 'kooperation'
	        WHEN marketing_channel = 'Affiliate' THEN 'affiliate'
	        WHEN marketing_channel = 'Inserts' THEN 'Insert'   
	    END as channel,
	    marketing_channel,
	    SUM(
	    	CASE 
	    	WHEN country IN ('CH','AT') AND date_created <= '2015-07-13' THEN null
	    	ELSE daily_costs END) as cost
	FROM raw.marketing_costs_per_voucher_campaign mc
	WHERE date_created >= '2015-05-01'
	GROUP BY 1,2,3,4
) ac
GROUP BY 1,2,3,4"	READY
297	2015-04-24 18:20:03	"1112787777"	true	2015-04-24 18:20:03	ml.article_outfittery_style		"CREATE VIEW ml.article_outfittery_style AS
SELECT
	osohe.article_id,
	MAX(osohe.basic) AS outfittery_style_basic,
	MAX(osohe.modisch) AS outfittery_style_modisch,
	MAX(osohe.sportlich) AS outfittery_style_sportlich,
	MAX(osohe.elegant) AS outfittery_style_elegant,
	MAX(osohe.klassisch) AS outfittery_style_klassisch,
	MAX(osohe.laessig) AS outfittery_style_laessig
FROM
 (SELECT
    a.article_id,
    CASE WHEN os.attribute_identifier = 'basic'
           OR os.attribute_identifier = 'basics'
         THEN 1 ELSE 0 END AS basic,
    CASE WHEN os.attribute_identifier = 'modisch'
         THEN 1 ELSE 0 END AS modisch,
    CASE WHEN os.attribute_identifier = 'sportlich'
         THEN 1 ELSE 0 END AS sportlich,
    CASE WHEN os.attribute_identifier = 'elegant'
         THEN 1 ELSE 0 END AS elegant,
	CASE WHEN os.attribute_identifier = 'klassisch'
         THEN 1 ELSE 0 END AS klassisch,
	CASE WHEN os.attribute_identifier = 'laessig'
         THEN 1 ELSE 0 END AS laessig
    FROM bi.article AS a
LEFT JOIN ml.article_attribute AS aa
	ON a.article_id = aa.article_id
LEFT JOIN ml.attribute_outfittery_style AS os
	ON os.attribute_id = aa.attribute_id) AS osohe
GROUP BY osohe.article_id"	READY
491,592	2015-08-10 15:24:29	"1141300652"	true	2015-08-10 15:24:29	desk_com_connector_example.groups_overview_report		CREATE view "desk_com_connector_example"."groups_overview_report" as select
        rr.groupname
        , rr.cont_created
        , rr.cont_resolved
        , ss2.Time_from_seconds_int as avg_frst_resolved
        , ss3.Time_from_seconds_int as avg_resolved
        , ss4.Time_from_seconds_int as avg_handletime
        , rr.FCR_RATE_proc
    from
        table ( select
                g.groupname
                , sum ( g.cou_created ) as cont_created
                , sum ( g.cou_resolved ) as cont_resolved
                , avg ( g.timedifffrstresolve ) as avg_timedifffrstresolve
                , avg ( g.timediffresolve ) as avg_timediffresolve
                , avg ( g.handletime ) / sum ( g.cou_created ) as avg_handletime
                , round ( ( cast ( sum ( g.cou_resolved ) as double ) / cast ( sum ( g.cou_created ) as double ) * 100 ), 2 ) as FCR_RATE_proc
            from
                table ( SELECT
                        gl."groupname"
                        , count ( dwhcase4.created_at ) as cou_created
                        , count ( dwhcase4.resolved_at ) as cou_resolved
                        , timestampdiff ( SQL_TSI_SECOND, dwhcase4."created_at", nvl ( dwhcase4."first_resolved_at", dwhcase4."created_at" ) ) as timedifffrstresolve
                        , timestampdiff ( SQL_TSI_SECOND, dwhcase4."created_at", nvl ( dwhcase4."resolved_at", dwhcase4."created_at" ) ) as timediffresolve
                        , timestampdiff ( SQL_TSI_SECOND, nvl ( dwhcase4."received_at", dwhcase4."created_at" ), nvl ( dwhcase4."first_resolved_at", dwhcase4."created_at" ) ) as handletime
                    FROM
                        "desk_com_connector_example.example_list_cases4" as dwhcase4
                        , "desk_com_connector_example.users_groups_list" as gl
                    where
                        gl."usrid" = dwhcase4."userid"
                    group by
                        gl."groupname"
                        , dwhcase4."created_at"
                        , dwhcase4.first_resolved_at
                        , dwhcase4.resolved_at
                        , dwhcase4.received_at ) as g
            group by
                g.groupname ) as rr, table ( call "desk_com_connector.internal_integer_to_Time2" ( "in_seconds" => cast ( rr.avg_timedifffrstresolve as integer ) ) ) ss2, table ( call "desk_com_connector.internal_integer_to_Time2" ( "in_seconds" => cast ( rr.avg_timediffresolve as integer ) ) ) ss3, table ( call "desk_com_connector.internal_integer_to_Time2" ( "in_seconds" => cast ( rr.avg_handletime as integer ) ) ) ss4
    order by
        rr.groupname asc	READY
176	2015-04-24 18:18:03	"638184810"	true	2015-04-24 18:18:03	views.ga_visits		"CREATE view views.ga_visits
as
select
  vi1.date_created,
  vi1.country,
  vi1.source,
  vi1.medium,
  vi1.devicecategory,
  case
    when vi1.channel= 'affiliate' and vit.cam_bit_1!= 'rem' then 'affiliate'
    when vi1.channel= 'crm' and vit.cam_bit_1!= 'rem' then 'crm'
    when vi1.channel= 'display' and vit.cam_bit_1!= 'rem' then 'display'
    when vi1.channel= 'facebook' and vit.cam_bit_1!= 'rem' then 'facebook'
    when vi1.channel= 'google gdn' and vit.cam_bit_1!= 'rem' then 'google gdn'
    when vi1.channel= 'kooperation' and vit.cam_bit_1!= 'rem' then 'kooperation'
    when vi1.channel= 'praemienprogramm' and vit.cam_bit_1!= 'rem' then 'praemienprogramm'
    when vi1.channel= 'remarketing' and vit.cam_bit_1!= 'rem' then 'remarketing'
    when vi1.channel= 'twitter' and vit.cam_bit_1!= 'rem' then 'twitter'
    when vi1.channel= 'youtube' and vit.cam_bit_1!= 'rem' then 'youtube'
    when vi1.channel= 'google sem' and vit.cam_bit_1!= 'rem' and vit.cam_bit_3!= 'brand' then 'google sem nobrand'
    when vi1.channel= 'google sem' and vit.cam_bit_1!= 'rem' and vit.cam_bit_3= 'brand' then 'google sem brand'
    when vi1.channel= 'direct' and vit.cam_bit_1!= 'rem' then 'direct'
    when vi1.channel= 'organic' and vit.cam_bit_1!= 'rem' then 'organic'
    when vi1.channel= '(not set)' and vit.cam_bit_1!= 'rem' then '(not set)'
    when vit.cam_bit_1= 'rem' then 'remarketing'
    else '(not set)'
  end as ""channel"",
  vi1.""campaign"",
  vit.cam_bit_1,
  vit.cam_bit_2,
  vit.cam_bit_3,
  vit.cam_bit_4,
  vit.cam_bit_5,
  vit.cam_bit_6,
  vit.cam_bit_7,
  vit.cam_bit_8,
  vit.cam_bit_9,
  vit.cam_bit_10,
  vit.cam_bit_11,
  vit.cam_bit_12,
  vit.cam_bit_13,
  vit.cam_bit_14,
  vit.cam_bit_15,
  vit.cam_bit_16,
  vit.cam_bit_17,
  vit.cam_bit_18,
  vit.cam_bit_19,
  vit.cam_bit_20,
  vi1.visits
from (
  select
    row_number() over (partition by vi.date_created, vi.country, vi.source, vi.medium, vi.campaign,vi.devicecategory order by vi.visits desc) as ""rnum"",
    vi.date_created,
    vi.country,
    vi.source,
    vi.medium,
    tsm.channel,
    vi.devicecategory,
    ifnull(vi.""campaign"",'(not set)') as ""campaign"",
    ifnull(vi.visits,0) as ""visits""
  from dwh.ga_visits vi
  left join views.ga_transactions_source_medium tsm on lower(vi.source)|| ' / ' || lower(vi.medium) = lower(tsm.sourcemedium) ) vi1,
  texttable (lower(vi1.campaign) columns 
              cam_bit_1 string,
              cam_bit_2 string,
              cam_bit_3 string,
              cam_bit_4 string,
              cam_bit_5 string,
              cam_bit_6 string,
              cam_bit_7 string,
              cam_bit_8 string,
              cam_bit_9 string,
              cam_bit_10 string,
              cam_bit_11 string,
              cam_bit_12 string,
              cam_bit_13 string,
              cam_bit_14 string,
              cam_bit_15 string,
              cam_bit_16 string,
              cam_bit_17 string,
              cam_bit_18 string,
              cam_bit_19 string,
              cam_bit_20 string 
              delimiter '_') vit"	READY
299	2015-04-24 18:20:04	"1112787779"	true	2015-04-24 18:20:04	tableau.finance_5th_item_discounts		"CREATE view tableau.finance_5th_item_discounts
AS
SELECT
  c.first_name,
  c.last_name,
  c.email,
  co.order_id,
  CAST(co.date_created as date) as date_created,
  co.date_shipped,
  v.sales_kept*(1-(co.discount_total/co.sales_kept)) as ""5th_item_discount_to_give_in_eur"",
  co.articles_kept,
  co.discount_total,
  v.sales_kept as ""5th_item_retail_price_eur"",
  co.sales_kept,
  co.discount_total/co.sales_kept as percentage_discount
FROM bi.customer_order co
JOIN bi.customer c on c.customer_id = co.customer_id
JOIN
(
  SELECT
    coa.order_id,
    coa.sales_kept,
    row_number() over (partition by coa.order_id order by coa.sales_kept desc) as ""rnum""
  FROM bi.customer_order_articles coa
  WHERE coa.sales_kept > 0
)as v on v.order_id = co.order_id and v.rnum = 5
WHERE co.articles_kept >= 5
AND 
(
  (cast(co.date_created as date) >= '2014-12-15' AND cast(co.date_created as date) <= '2015-01-18')
  OR
  (cast(co.date_shipped as date) >= '2014-12-15' AND cast(co.date_shipped as date) <= '2015-01-18')
)
AND co.is_real_order = 'Real Order' and co.shipping_country='DE'"	READY
131,098	2015-05-20 15:45:31	"770345455"	true	2015-05-20 15:45:31	am.color_mapping_new		"CREATE VIEW ""am.color_mapping_new"" AS
SELECT
""csv_table.color1"",
""csv_table.color_code_erp"" 
FROM
(call ""file"".getFiles('am.color_mapping_new.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""color1"" STRING ,
		""color_code_erp"" STRING 
		DELIMITER ',' 
		QUOTE '""' 
		HEADER 1 
	)
""csv_table"""	READY
189	2015-04-24 18:18:34	"1112787699"	true	2015-04-24 18:18:34	views.outlet_store		"create view views.outlet_store
as
select
	cast(po.ean as string) as ean, 
	po.initialquantity,
	po.quantity, 
	po.startdate,
	po.enddate,
	po.date_uploaded as po_date_created,
	we.supplier_sku, 
	we.brand, 
	we.article_name, 
	we.price_sold, 
	we.vat,
	we.bestand, 
	we.purchase_price, 
	we.stock_min, 
	we.reorder_point, 
	we.date_uploaded as we_date_created,
	cast(we.ean as string) as we_ean,
	sold.quantity_sold,
	sold.date_uploaded as sold_date_created,
	sold.purchase_price as sold_purchase_price,
	sold.price_sold as sold_price_sold,
	a.purchase_price as article_purchase_price, 
	cast(a.price_retail_de as double) as article_price_retail
	from dwh.outlet_po po 
	left join dwh.outlet_wareneingang we on we.ean = po.ean
	left join dwh.outlet_sold sold on sold.ean = po.ean
	left join views.article a on a.ean = po.ean"	READY
185	2015-04-24 18:18:06	"638184843"	true	2015-04-24 18:18:06	views.salesforce_opportunity		"CREATE view views.salesforce_opportunity
AS
SELECT
	order_id as ExternalOrderId__c,
	salesforce_order_stage as StageName,
	salesforce_order_id as Id,
	prepayment_email_sent as Vorkasse_Email_sent__c,
	not_reached as notReached__c,
	sales_channel as SalesChannel__c,
	call_confirmed as CallConfirmed__c,
	no_call_box as NoCall_Box__c,
	ops_check as OpsCheck__c,
	date_first_order as DateFirstOrder__c,
	inactive_reasons as InactiveReason__c,
	customer_support_reason as CS_Reason__c,
	first_order as FirstOrder__c,
	'' as Facebook_Campaign__c,
	arvato_confrimation_sent as Arvato_Payment_Confirmation_Sent__c,
	open_arvato_amount as Open_Ammount_Arvato__c,
	paid_arvato_amount as Paid_to_Arvato__c,
	calender_full as Kalender_war_geblockt__c,
	upcload_tested as Upcload_tested__c,
	voucher_code as VoucherCode__c,
	dhl_link as DHL_Link__c,
	dhl_return_link as DHLReturnLink__c,
	salesforce_order_type as OrderType__c,
	return_rate as ReturnRate__c,
	newcardrecommendation as NewCardrecommendation__c,
	max_basket_arvato as Max_Warenkorbempfehlung_Arvato__c,
	arvato_status as arvatoStatus__c,
	arvato_y_n as ArvatoYorN__c,
	finance_check as Finance_check__c,
	saleschannel_special as SalesChannel_Special__c,
	nl_ghost_stylist as NL_Ghost_Stylist__c,
	wrong_phone_number as Telefonnummer_Falsch__c,
	'' as DHLPickupLink__c,
	'' as DHL_Status__c,
	dhl_return_next_steps as DHLReturnNextSteps__c,
	nps_score as NPS__c,
	debt_collection_set as Inkasso__c,
	refusual_comment as Refusals_comment__c,
	last_updated_date as SystemModstamp
FROM raw.customer_order_salesforce"	READY
34	2015-04-24 18:17:18	"901272262"	true	2015-06-18 14:42:30	views.marketingcosts		"CREATE view views.marketingcosts
as
select
  cast(mco.datecreated as date) as ""datecreated"",
  mco.country as ""country"",
  case
    when mco.channel= 'gdn' then 'google gdn'
    when mco.channel= 'sem' then 'google sem'
    when mco.channel= 'display' then 'display'
    when mco.channel= 'facebook' then 'facebook'
    when mco.channel= 'affiliate' then 'affiliate'
    when mco.channel= 'crm' then 'crm'
    when mco.channel= 'kooperationen' then 'kooperation'
    when mco.channel= 'referral' then 'praemienprogramm'
    when mco.channel= 'remarketing' then 'remarketing'
    when mco.channel= 'seo/direct' then 'seo/direct'
    when mco.channel= 'tv' then 'tv'
    when mco.channel= 'twitter' then 'twitter' 
    when mco.channel= 'youtube' then 'youtube'
    when mco.channel= 'sem_brand' then 'google sem brand'
    when mco.channel= 'sem_nobrand' then 'google sem nobrand'
    when mco.channel= 'appdownload' then 'app download campaign'
    WHEN mco.channel= 'offline_promotions' THEN 'Offline_Promotions'
    WHEN mco.channel= 'linkedin' THEN 'LinkedIn'
    WHEN mco.channel= 'xing' THEN 'Xing'
    WHEN mco.channel= 'insert' THEN 'Insert'
  end as ""channel"",
  cast(mco.costs as double) as ""costs"",
  mco.currency as ""currency""
from (
  select
    row_number() over (partition by ""datecreated"" || ""country"" || ""channel"" || ""costs"" || ""currency"" order by ""datecreated"" desc) as ""rnum"",
    replace(cast(datecreated as date),' ','') as ""datecreated"",
    replace(country,' ','') as ""country"",
    lower(replace(channel,' ','')) as ""channel"",
    replace(cast(costs as double),' ','') as ""costs"",
    replace(currency,' ','') as ""currency""
from dwh.marketingcost ) mco
where mco.rnum= '1'"	READY
190	2015-04-24 18:18:34	"1112787700"	true	2015-04-24 18:18:34	ml.customer_survey		"CREATE VIEW ml.customer_survey AS
SELECT
*
FROM
raw.customer_survey"	READY
851,974	2015-09-21 17:22:35	"1346130726"	true	2015-09-21 17:22:35	datamart.dim_customer		"/********************************************************************************
-- Author       Hemanth
-- Created      2015-07-01
-- Purpose      This view joins tables from raw and datamart schema.
-- Tables       raw.dim_customer,datamart.dim_opportunity,datamart.dim_order,datamart.dim_case
-----------------------------------------------------------------------------------
-- Modification History

-- Date          Author      Description
-- 2015-09-16    Hemanth     1) Added first_sales_channel_1 and first_sales_channel_2
                             2) Removed nb_orders,nb_case since it is already available
                                in datamart.fact_customer
-- 2015-09-21    Hemanth     Renamed column names according to KPI bilble
**********************************************************************************/
CREATE VIEW datamart.dim_customer
AS

SELECT
  
  a.customer_id,
  c.first_sales_channel_1 AS customer_acquisition_channel_1, /*first saleschannel of customer*/
  c.first_sales_channel_2 AS customer_acquisition_channel_2,

  CASE
    WHEN d.cluster='CLUB' THEN 'Club' 
    WHEN d.cluster='AC' THEN 'Loyal'
    WHEN d.cluster IN ('NOCALL0','CALL0') THEN 'New'
    WHEN d.cluster IN ('CLIM','NCLIM') THEN 'Young'
    WHEN d.cluster='P6' THEN 'Passive'
    WHEN d.cluster='P12' THEN 'Inactive'
  END AS customer_segment,

  a.date_created AS date_account_created,
                                               TIMESTAMPDIFF(SQL_TSI_YEAR, cast(a.date_of_birth AS date),CURDATE()) AS customer_age,
  c.status_last_case as customer_status,

  CASE
    WHEN a.phone_number IS NOT NULL THEN '1'
    ELSE '0'
  END AS has_phone_number,
  
  CASE 
    WHEN a.email IS NOT NULL THEN '1'
    ELSE '0'
  END AS has_email,
  
  CASE 
    WHEN a.providerid='facebook' THEN '1'
    ELSE '0'
  END AS has_facebook,
  
  CASE 
    WHEN a.providerid='linkedin' THEN '1'
    ELSE '0'
  END AS has_linkedin,
  
  CASE 
    WHEN a.providerid='xing' THEN '1'
    ELSE '0'
  END AS has_xing,

  CASE 
    WHEN club_member=true THEN '0'
    WHEN club_member='Cancelled' THEN 'Cancelled'
    ELSE '0'
  END AS is_club_customer,

  a.domain_page,
  a.user_type

FROM raw.dim_customer a
LEFT JOIN
( 
  SELECT
    b.customer_id,
    COUNT(DISTINCT b.opp_id) AS nb_orders,
    COUNT(DISTINCT b.case_no) AS nb_cases,
    MIN(CASE WHEN b.rank_first=1 THEN b.opp_sales_channel_1 ELSE NULL END) AS first_sales_channel_1,
    MIN(CASE WHEN b.rank_first=1 THEN b.opp_sales_channel_2 ELSE NULL END) AS first_sales_channel_2,
    MIN(CASE WHEN b.rank_first=1 THEN b.date_opp_created ELSE NULL END) AS first_date_opp_created,
    MIN(CASE WHEN b.rank_first=2 THEN b.date_opp_created ELSE NULL END) AS second_date_opp_created,
    MIN(CASE WHEN b.rank_last=1 THEN b.date_opp_created ELSE NULL END) AS last_date_opp_created,
    MIN(CASE WHEN b.rank_last=1 THEN b.case_status ELSE NULL END) AS status_last_case
  FROM 
  (  
    SELECT
      ROW_NUMBER() over(partition by op.customer_id ORDER BY op.date_opp_created) AS rank_first,
      ROW_NUMBER() over(partition by op.customer_id ORDER BY op.date_opp_created DESC) AS rank_last,
      op.opp_id,
      op.customer_id,
      ca.case_no,
      ca.case_status,
      op.opp_sales_channel_1,
      op.opp_sales_channel_2,
      co.parent_order_id,
      op.date_opp_created,
      co.date_order_created
    FROM datamart.dim_opportunity op
    LEFT JOIN datamart.dim_order co ON co.order_id=op.opp_id
    LEFT JOIN datamart.dim_case ca ON ca.case_id=op.opp_id
  )b
  GROUP BY b.customer_id
)c ON c.customer_id=a.customer_id
LEFT JOIN raw.customer_cluster d ON a.customer_id=d.customer_id"	READY
300	2015-04-24 18:20:05	"1112787780"	true	2015-04-24 18:20:05	tableau.management_management_report_okrs		"create VIEW tableau.management_management_report_okrs  
AS  
SELECT  
 okr.year_quarter,  
 co.new_customers,  
 co.new_customers + (co.new_customers / okr.working_days_gone * okr.working_days_left) as new_customer_forecast,  
 okr.new_customer_target,  
 co.repeat_customers,   
 co.repeat_customers + (co.repeat_customers / okr.working_days_gone * okr.working_days_left) as repeat_customer_forecast,  
 okr.repeat_customer_target,  
 co.avg_basket,  
 okr.avg_basket_target,  
 okr.revenue_per_stylist_target,  
 (co.billing_total + (co.billing_total / okr.working_days_gone * okr.working_days_left)) / s.stylists / 3 revenue_per_stylist  
FROM   
(  
 SELECT   
  o.year_quarter,  
  o.new_customer_target,  
  o.repeat_customer_target,  
  o.cart_value_target as avg_basket_target,  
  o.revenue_per_stylist_target,  
  SUM(c.working_days) as working_days_quarter,  
  SUM(CASE WHEN c.date < CURDATE() THEN c.working_days ELSE 0 END) as working_days_gone,  
  SUM(CASE WHEN c.date >= CURDATE() THEN c.working_days ELSE 0 END) as working_days_left  
 FROM dwh.company_okrs_quarterly o  
 JOIN dwh.calendar c on c.year_quarter = o.year_quarter  
 GROUP BY 1,2,3,4,5  
) okr  
JOIN   
(  
 SELECT  
  c.year_quarter,  
  COUNT(CASE WHEN order_type = 'First Order' THEN order_id ELSE null END) as new_customers,  
  COUNT(CASE WHEN order_type in ('Repeat Order', 'Outfittery Club Order') THEN order_id ELSE null END) as repeat_customers,  
  AVG(sales_kept) as avg_basket,  
  SUM(billing_total) as billing_total,  
  SUM(billing_net_sales) as net_sales  
 FROM bi.customer_order co   
 JOIN dwh.calendar c on c.date = CAST(co.date_invoiced as date)  
 WHERE co.is_real_order = 'Real Order'  
 AND co.order_state_number BETWEEN 16 and 1024  
 AND co.date_invoiced < CURDATE()  
 GROUP BY c.year_quarter  
) co on co.year_quarter = okr.year_quarter  
JOIN  
(  
 SELECT  
  c.year_quarter,  
  SUM(s.stylist_weighted_activity)/COUNT(DISTINCT s.date_invoiced) as stylists  
 FROM bi.stylist_weighted_activity s  
 JOIN dwh.calendar c on c.date = s.date_invoiced  
 WHERE c.working_days = 1  
 AND c.date >= '2014-10-01'  
 GROUP by 1  
) s on s.year_quarter = okr.year_quarter"	READY
301	2015-04-24 18:20:06	"1112787781"	true	2015-04-24 18:20:06	tableau.ops_lost_articles_order_information		"CREATE view tableau.ops_lost_articles_order_information
as
SELECT co.customer_id, 
       cast(co.date_shipped AS DATE) AS date_shipped, 
       co.order_id, 
       coa.article_id, 
       co.shipping_country, 
       coa.sales_sent 
FROM   bi.customer_order co 
       LEFT JOIN bi.customer_order_articles coa 
              ON coa.order_id = co.order_id 
WHERE  coa.order_article_state_number = 1536"	READY
304	2015-04-24 18:20:08	"1112787784"	true	2015-04-24 18:20:08	tableau.ops_fashion_id		"CREATE view tableau.ops_fashion_id
AS
select 
poa.order_id,
coa.supplier_order_number as fashion_id_order_number, 
coa.stylist_date_picked,
min(poa.date_poa_created) as po_date_created,
max(poa.date_stock_booked_max) as max_date_booked,
poa.purchase_order_id,
sum(poa.stock_booked) as total_stock_mutations,
po.po_date_import_result,
po.stock_location_id,
count(distinct poa.poa_id) as amount_po_lines,
log.sales_order_header_created,
log.date_picklist_created,
log.date_backorder,
log.date_shipment_confirmation,
log.date_returned
FROM bi.purchase_order_articles poa
join bi.purchase_order po
on poa.purchase_order_id = po.purchase_order_id
join (select order_id, supplier_order_number, min(date_picked) as stylist_date_picked from bi.customer_order_articles group by 1,2) coa
on coa.order_id = poa.order_id
left join raw.customer_order_logistics log
on log.order_id = poa.order_id
where po.stock_location_id = 4
and driving_tbl_poa is not null
group by 1,2,3,6,8,9,11,12,13,14,15"	READY
312	2015-04-24 18:20:31	"1112787791"	true	2015-07-08 17:24:07	raw.marketing_contacts_ga		"CREATE VIEW raw.marketing_contacts_ga 
AS
SELECT
 	ga2.order_id,
 	ga2.contact_timestamp,
 	ga2.marketing_channel,
 	ga2.marketing_subchannel,
 	ga2.source,
 	ga2.medium,
 	ga2.campaign,
 	ga2.marketing_campaign
FROM 
(
	SELECT 
		co.order_id,
		parseTIMESTAMP(ga.date_created || ' ' || parseTIME(ga.hour_created, 'H'), 'yyyy-MM-dd H:mm:ss') as contact_timestamp,
		ga.marketing_channel,
		ga.marketing_subchannel,
		ga.source,
		ga.medium,
		ga.campaign,
		ga.source_medium_campaign as marketing_campaign,		
		CASE 
			WHEN parseTIMESTAMP(ga.date_created || ' ' || parseTIME(ga.hour_created, 'H'), 'yyyy-MM-dd H:mm:ss') < co.date_incoming THEN 1
			ELSE 0
		END as contact_before_incoming,
	/* --Highlights  contacts that were placed before date_stylist_picked-- */
		CASE 
			WHEN parseTIMESTAMP(ga.date_created || ' ' || parseTIME(ga.hour_created, 'H'), 'yyyy-MM-dd H:mm:ss') < co.date_stylist_picked THEN 1
			ELSE 0
			END as contact_before_date_stylist_picked
	FROM bi.customer_order co
	LEFT JOIN 
	(
	SELECT 
      DISTINCT 
      utm.date_created,
      utm.hour_created,
      utm.transaction_id, 
      utm.source, 
      utm.medium, 
      utm.campaign, 
      lower(utm.source)|| ' / ' || lower(utm.medium) || ' / ' || lower(utm.campaign) as source_medium_campaign,
      lo.marketing_subchannel,
      lo.marketing_channel
    FROM ""dwh.ga_information_utm"" utm
    left join raw.ga_channel_logic lo ON  lower(utm.source)|| ' / ' || lower(utm.medium) || ' / ' || lower(utm.campaign) = lo.source_medium_campaign
	) ga
	ON co.order_id = ga.transaction_id
	)ga2
WHERE (ga2.contact_before_incoming = 1
OR (ga2.contact_before_incoming = 0 AND ga2.contact_before_date_stylist_picked = 1))"	READY
313	2015-04-24 18:20:32	"1112787792"	true	2015-04-24 18:20:32	tableau.ops_receivings_scans_and_stock_mutation_agg_leveled		"CREATE view tableau.ops_receivings_scans_and_stock_mutation_agg_leveled 
AS
WITH stock_mutation AS
(
    SELECT 
        row_number() over (partition by purchase_order_id, article_id order by d asc) AS ""rnum"",
        cast(d||'00' AS timestamp) AS booking_day,
        article_id,
        purchase_order_id,
        c AS booking_count,
        dc_min AS min_date_created,
        dc_max AS max_date_created
    FROM
    (
        SELECT 
            purchase_order_id,
            article_id,
            left(date_stock_booked, 14) AS d,
            count(*) AS c,
            max(date_stock_booked) AS dc_max ,
            min(date_stock_booked) AS dc_min 
        FROM bi.stock_booked
        WHERE purchase_order_id <> '' 
        GROUP BY 1,2,3
    )a
)
SELECT 
    poa.purchase_order_id as po,
    poa.article_ean as ean,
    poa.article_id,
    poa.stock_scanned as count_scans,
    poa.stock_scanned_photo_articles as count_photo_article, 
    poa.stock_scanned_ean_unknown_articles as count_ean_unknown, 
    poa.stock_scanned_overdelivered_articles as count_overdelivered, 
    poa.date_stock_handedover_min as min_date_given_to_serviceprovider, 
    poa.date_stock_handedover_max as max_date_given_to_serviceprovider,  
    poa.stock_ordered_revised as quantity, 
    poa.stock_ordered_initially as initial_quantity, 
    poa.stock_booked as fulfilled_quantity, 
    countsm.daycount,
    sm1.booking_count AS booking_count1,
    sm1.booking_day AS booking_part1,
    sm1.min_date_created AS min1,
    sm1.max_date_created AS max1,
    sm2.booking_count AS booking_count2,
    sm2.booking_day AS booking_part2, 
    sm2.min_date_created AS min2,
    sm2.max_date_created AS max2,
    sm3.booking_count AS booking_count3, 
    sm3.booking_day AS booking_part3, 
    sm3.min_date_created AS min3, 
    sm3.max_date_created AS max3,
    sm4.booking_count AS booking_count4, 
    sm4.booking_day AS booking_part4,
    sm4.min_date_created AS min4,
    sm4.max_date_created AS max4,
    sm5.booking_count AS booking_count5,
    sm5.booking_day AS booking_part5,
    sm5.min_date_created AS min5,
    sm5.max_date_created AS max5,
    sm6.booking_count AS booking_count6,
    sm6.booking_day AS booking_part6,
    sm6.min_date_created AS min6,
    sm6.max_date_created AS max6,
    sm7.booking_count AS booking_count7,
    sm7.booking_day AS booking_part7,
    sm7.min_date_created AS min7,
    sm7.max_date_created AS max7
FROM bi.purchase_order_articles poa  
LEFT JOIN
(
 SELECT 
        purchase_order_id,
        article_id,
        count(distinct cast(date_stock_booked AS date)) AS daycount 
    FROM bi.stock_booked
    GROUP BY 1,2
) countsm ON countsm.purchase_order_id = poa.purchase_order_id AND countsm.article_id =poa.article_id
LEFT JOIN stock_mutation sm1 ON sm1.article_id = poa.article_id AND sm1.purchase_order_id = poa.purchase_order_id AND sm1.rnum = 1
LEFT JOIN stock_mutation sm2 ON sm2.article_id = poa.article_id AND sm2.purchase_order_id = poa.purchase_order_id AND sm2.rnum = 2
LEFT JOIN stock_mutation sm3 ON sm3.article_id = poa.article_id AND sm3.purchase_order_id = poa.purchase_order_id AND sm3.rnum = 3 
LEFT JOIN stock_mutation sm4 ON sm4.article_id = poa.article_id AND sm4.purchase_order_id = poa.purchase_order_id AND sm4.rnum = 4
LEFT JOIN stock_mutation sm5 ON sm5.article_id = poa.article_id AND sm5.purchase_order_id = poa.purchase_order_id AND sm5.rnum = 5
LEFT JOIN stock_mutation sm6 ON sm6.article_id = poa.article_id AND sm6.purchase_order_id = poa.purchase_order_id AND sm6.rnum = 6
LEFT JOIN stock_mutation sm7 ON sm7.article_id = poa.article_id AND sm7.purchase_order_id = poa.purchase_order_id AND sm7.rnum = 7"	READY
311	2015-04-24 18:20:30	"1214090254"	true	2015-08-25 16:39:23	tableau.mkt_sms_reminder_telephone_call_date		"CREATE VIEW tableau.mkt_sms_reminder_telephone_call_date
AS

SELECT
*
FROM
(
  SELECT 
    row_number() over (partition by co.customer_id order by co.date_created desc) AS ""rnum"",
    cu.email,
    CASE WHEN cu.gender = 'Male' THEN 'Herr' ELSE 'Frau' END as salutation,
    cu.formal as du_sie,
    case
      when cu.gender= 'Male' then 'Lieber'
      when cu.gender= 'Female' then 'Liebe'
    end AS ""lieb_geehrt"",
    cu.first_name,
    cu.last_name,
    cu.phone_number,
    co.shipping_country,
    cu.default_domain as default_page,
    cu.subscribe_status,
    cu.customer_id,
    st.first_name as stylist_firstname,
    st.last_name as stylist_lastname,
    cu.token as customer_token,
    co.date_phone_call as date_phone_call_current,
    CASE 
    	WHEN cu.subscribed_to_sms=true THEN 'Yes'
    	ELSE 'No'
    END AS subscribed_to_sms,
    co.is_real_order
  FROM bi.customer_order co
  LEFT JOIN bi.customer cu on cu.customer_id=co.customer_id
  LEFT JOIN raw.customer_salesforce cs on cs.customer_id=cu.customer_id
  LEFT JOIN bi.stylist st on st.stylist_id=cu.stylist_id
  WHERE 
  co.date_given_to_debt_collection IS NULL 
  AND co.sales_channel != 'website'
  AND co.payment_type != 'Pre-pay'
)a
WHERE a.rnum = '1'"	READY
203	2015-04-24 18:19:16	"1112787711"	true	2015-04-24 18:19:16	bi.previews		"CREATE VIEW bi.previews
AS 
SELECT * FROM raw.previews"	READY
204	2015-04-24 18:19:17	"1112787712"	true	2015-04-24 18:19:17	bi.preview_articles		"CREATE VIEW bi.preview_articles
AS 
SELECT * FROM raw.preview_articles"	READY
207	2015-04-24 18:19:17	"638184876"	true	2015-04-24 18:19:17	raw.ga_visits		"CREATE VIEW raw.ga_visits
AS
SELECT
  vi2.date_created,
  vi2.country as domain,
  vi2.source,
  vi2.medium,
  vi2.campaign,
  vi2.devicecategory,
  ga.source_medium_campaign,
  ga.marketing_subchannel,
  ga.marketing_channel,
  SUM(vi2.visits) as visits
FROM 
(
  SELECT
    vi.date_created,
    vi.country,
    vi.source,
    vi.medium,
    vi.campaign,
    vi.devicecategory,
    IFNULL(vi.visits,0) as ""visits""
  FROM dwh.ga_visits vi
) vi2
LEFT JOIN raw.ga_channel_logic ga ON ga.source_medium_campaign = lower(vi2.source)|| ' / ' || lower(vi2.medium) || ' / ' || lower(vi2.campaign)
GROUP BY 1,2,3,4,5,6,7,8,9"	READY
315	2015-04-24 18:20:33	"1112787794"	true	2015-04-24 18:20:33	tableau.ops_receivings_PO_Kontrolle		"CREATE view tableau.ops_receivings_PO_Kontrolle
AS
select  
    poa.purchase_order_id, 
    poa.article_ean as ean, 
    poa.article_id, 
    poa.stock_ordered_revised as updated_quantity, 
    poa.stock_ordered_initially as initial_quantity, 
    poa.stock_booked as fulfilled_quantity, 
    poa.article_cost as purchase_price,
    poa.article_sales_price as retail_price,
    cast(poa.date_poa_created as date) as purchase_order_date_created,
    poa.stock_invoiced as invoice_quantity,
    poa.stock_delivery_notes,
    pim.brand, 
    pim.supplier_article_name, 
    pim.supplier_color_code, 
    pim.supplier_color_name, 
    pim.supplier_length, 
    pim.eu_size, 
    pim.supplier_size, 
    pim.eu_length, 
    pim.supplier_sku,
    poa.stock_credit_note_qty,
    poa.stock_scanned as count_scans,
    poa.stock_scanned_ean_unknown_articles as count_ean_unknown,
    poa.stock_scanned_overdelivered_articles as count_overdelivered,
    poa.date_stock_delivered_max as max_date_delivered,
    poa.date_stock_handedover_max as max_date_given_to_serviceprovider
FROM bi.purchase_order_articles poa
LEFT JOIN raw.article_detail_pim pim on poa.article_ean = pim.ean
where driving_tbl_poa is not null"	READY
206	2015-04-24 18:19:17	"1308954761"	true	2015-09-13 20:20:15	bi.customer_order_salesforce		"CREATE VIEW bi.customer_order_salesforce AS

SELECT * FROM raw.customer_order_salesforce"	READY
186	2015-04-24 18:18:06	"1146210186"	true	2015-08-11 16:20:28	views.arvatoresults		"CREATE view views.arvatoresults
AS

WITH arv_rank as
(
SELECT
		ft.order_id,
		ft.customer_id,
		ft.date_created,
		ft.arvato_type as arvatotype,
		ft.arvato_result as arvatoresult,
		ft.arvato_order_limit as arvatoorderlimit,
		ft.response_code,
		ft.request_body,
		ft.valuation,
		ft.provider_transaction_id,
		row_number() over(partition by ft.order_id ORDER BY ft.date_created) AS rank
	FROM raw.financial_transactions ft
)
SELECT
	r1.order_id,
	r1.customer_id,
	r1.date_created as arv_date_created,
	r1.arvatoresult_1,
	r2.arvatoresult_2,
	r3.arvatoresult_3,
	/*Response Code*/
	r1.responseCode_1,
	r2.responseCode_2,
	r3.responseCode_3,
	/*Order Limit*/
	r1.arvatoorderlimit1,
	r2.arvatoorderlimit2,
	r3.arvatoorderlimit3,
	/*Valuation*/
	r1.valuation1,
	r2.valuation2,
	r3.valuation3,
	/*Request Code*/
	r1.requestbody_1,
	r2.requestbody_2,
	r3.requestbody_3,
	/*Provider Transaction ID*/
	r1.provider_transaction_id1,
	r2.provider_transaction_id2,
	r3.provider_transaction_id3,
	ft_value.avg_arvatoorderlimit,
	ft_value.max_valuation
FROM
(
	SELECT 
		order_id,
		customer_id,
		date_created,
		arvatoresult AS arvatoresult_1,
		response_code AS responseCode_1,
		request_body AS requestbody_1,
		arvatoorderlimit AS arvatoorderlimit1,
		valuation AS valuation1,
		provider_transaction_id AS provider_transaction_id1
	FROM arv_rank
	WHERE rank=1
)r1
LEFT JOIN
(
	SELECT 
		order_id,
		arvatoresult AS arvatoresult_2,
		response_code AS responseCode_2,
		request_body AS requestbody_2,
		arvatoorderlimit AS arvatoorderlimit2,
		valuation AS valuation2,
		provider_transaction_id AS provider_transaction_id2
	FROM arv_rank
	WHERE rank=2
)r2 on r2.order_id=r1.order_id
LEFT JOIN
(
	SELECT 
		order_id,
		arvatoresult AS arvatoresult_3,
		response_code AS responseCode_3,
		request_body AS requestbody_3,
		arvatoorderlimit AS arvatoorderlimit3,
		valuation AS valuation3,
		provider_transaction_id AS provider_transaction_id3
	FROM arv_rank
	WHERE rank=3
)r3 on r3.order_id=r1.order_id
LEFT JOIN
(
	SELECT
		order_id,
		max(valuation) AS max_valuation,
		avg(arvatoorderlimit) AS avg_arvatoorderlimit
	FROM arv_rank
	group by 1
) ft_value ON ft_value.order_id=r1.order_id"	READY
314	2015-04-24 18:20:32	"1330319822"	true	2015-09-18 16:04:16	tableau.ops_receivings_LS_Kontrolle		"CREATE view tableau.ops_receivings_LS_Kontrolle 
AS

WITH 
scan AS
( /* For this report, grain at po-ean-deliv note */
  SELECT
    purchase_order_id,
    article_ean,
    stock_delivery_note,
    COUNT(*) stock_scanned,
    MIN(date_stock_delivered) 		AS date_stock_delivered_min,
    MAX(date_stock_delivered) 		AS date_stock_delivered_max,
    MIN(date_stock_scanned)  		AS date_stock_scanned_min,
    MAX(date_stock_scanned)  		AS date_stock_scanned_max,
    MIN(date_stock_handedover) 		AS date_stock_handedover_min,
    MAX(date_stock_handedover) 		AS date_stock_handedover_max,
    MIN(date_stock_uploaded) 		AS date_stock_uploaded_min,
    MAX(date_stock_uploaded) 		AS date_stock_uploaded_max,
	SUM(CASE WHEN scan_ean_unknown = 'ean unknown' 										THEN 1 END) AS stock_scanned_ean_unknown_articles,
	SUM(CASE WHEN scan_article_overdelivered = 'article overdelivered' 					THEN 1 END) AS stock_scanned_overdelivered_articles,
	SUM(CASE WHEN scan_photo_article = 'photo article selected' 						THEN 1 END) AS stock_scanned_photo_articles,
	SUM(CASE WHEN scan_clarification_case IN ('ean unknown', 'article overdelivered') 	THEN 1 END) AS stock_scanned_clarification_cases
  FROM
    raw.stock_scanned scan
  GROUP BY 1,2,3
)

/* MAIN BODY */

SELECT 
	poa.purchase_order_id as po,
	poa.article_ean as ean,
	poa.article_id,
	poa.date_poa_fulfilled,
	scan.stock_delivery_note AS delivery_note,
	scan.stock_scanned as anzahl_scans,
	scan.stock_scanned_ean_unknown_articles as anzahl_ean_unbekannt, 
	scan.stock_scanned_photo_articles as anzahl_photo_artikel, 
	scan.stock_scanned_overdelivered_articles as anzahl_ueberlieferung, 
	scan.date_stock_handedover_min as mindatum_Uebergabe_an_Dienstleister, 
	scan.date_stock_handedover_max as maxdatum_Uebergabe_an_Dienstleister, 
	scan.date_stock_scanned_min as mindatum_scan, 
	scan.date_stock_scanned_max as maxdatum_scan, 
	scan.date_stock_delivered_min as mindatum_Lieferdatum, 
	scan.date_stock_delivered_max as maxdatum_Lieferdatum,
	poa.stock_ordered_initially as initial_quantity,
	poa.stock_ordered_revised as quantity,
	poa.stock_booked as fulfilled_quantity,
	poa.article_cost as purchase_price,
	poa.stock_delivery_note_qty as delivery_note_quantity_supplier,
	au.invoice_number,
	au.invoice_quantity,
	au.accounting_date, 
	au.accountant,
	i.item_description,
	i.item_no,
	i.vendor_item_no,
	COALESCE(i.brand,a.article_brand) AS brand,
	i.supplier_color,
	a.article_name AS supplier_article_name,
	a.article_supplier_color_code AS supplier_color_code, 
	a.article_supplier_color_name AS supplier_color_name, 
	a.article_supplier_length AS supplier_length, 
	a.article_eu_size AS eu_size, 
	a.article_supplier_size AS supplier_size, 
	a.article_eu_length AS eu_length, 
	a.article_supplier_sku AS supplier_sku
FROM
	bi.purchase_order_articles poa
	LEFT JOIN
	scan
		 ON poa.purchase_order_id 	= scan.purchase_order_id
		AND poa.article_ean 		= scan.article_ean
	LEFT JOIN
	raw.accounting_upload au
		 ON scan.article_ean 			= au.ean
		AND scan.purchase_order_id 		= au.purchase_order_id
		AND scan.stock_delivery_note 	= au.delivery_note
	LEFT JOIN
	bi.article a
		 ON poa.article_id = a.article_id
	LEFT JOIN
	bi.item i on i.article_id=a.article_id
WHERE 
	poa.driving_tbl_scan IS NOT NULL"	READY
253	2015-04-24 18:19:35	"1112787741"	true	2015-04-24 18:19:35	ml.project_outfit_types		"CREATE VIEW ml.project_outfit_types AS
SELECT
coa.order_id,
coa.article_id,
coa.outfit_id,
ac.flat_category
FROM ""raw.customer_order_articles"" coa
JOIN ""ml.article_category_new"" ac ON coa.article_id = ac.article_id
WHERE coa.date_shipped > '2013-10-01' AND coa.date_shipped < '2014-10-01'"	READY
213	2015-04-24 18:19:19	"638184895"	true	2015-04-24 18:19:19	tableau.ops_stock_reconciliation		"CREATE VIEW tableau.ops_stock_reconciliation AS

SELECT * FROM bi.stock_reconciliation"	READY
851,973	2015-09-21 17:12:04	"1346130749"	true	2015-09-21 17:37:36	tableau.finance_conversion_rate		"CREATE VIEW tableau.finance_conversion_rate
AS

SELECT 
	a.date,
	a.country,
	COALESCE(b.visits,0) AS visits,
	COALESCE(c.orders_incoming,0) AS orders_incoming,
	COALESCE(c.orders_invoiced,0) orders_invoiced
FROM 
(
  SELECT
    c.date,
    x.country
  FROM dwh.calendar c 
  CROSS JOIN (SELECT distinct shipping_country as country FROM bi.customer_order where shipping_country is not null) x
  WHERE c.date > '2014'
  AND c.date < CURDATE()
) a
LEFT JOIN
(
  SELECT 
    date_created  as ""date"",
    domain as country,
    sum(visits) as visits 
  FROM ""bi.marketing_funnel_by_date_domain_channel_device""
  group by 1,2
)b on a.""date""=b.""date"" and a.country=b.country
LEFT JOIN
(

  SELECT  
    CAST(co.date_incoming as date) as ""date"", 
    co.shipping_country as country, 
    COUNT(DISTINCT order_id) AS orders_incoming,
    COUNT(CASE WHEN co.date_invoiced is not null then order_id END) as orders_invoiced
  FROM bi.customer_order co 
  WHERE co.is_real_order = 'Real Order' 
  AND co.date_created > '2014'
  GROUP BY 1,2
)c  on c.""date""=b.""date"" and c.country=b.country"	READY
215	2015-04-24 18:19:20	"638184906"	true	2015-04-24 18:19:20	meta.schemas		"CREATE VIEW meta.schemas AS
SELECT * FROM ""meta.schema__am""
UNION
SELECT * FROM ""meta.schema__bi""
UNION
SELECT * FROM ""meta.schema__ml""
UNION
SELECT * FROM ""meta.schema__raw""
UNION
SELECT * FROM ""meta.schema__tableau""
UNION
SELECT * FROM ""meta.schema__views""
UNION
SELECT * FROM ""meta.schema__postgres""
UNION
SELECT * FROM ""meta.schema__pim""
UNION
SELECT * FROM ""meta.schema__salesforce""
UNION
SELECT * FROM ""meta.schema__snowplow""
UNION
SELECT * FROM ""meta.schema__dhltracking""
UNION
SELECT * FROM ""meta.schema__analytics"""	READY
216	2015-04-24 18:19:20	"638184907"	true	2015-04-24 18:19:20	am.pim_model		"CREATE VIEW am.pim_model AS
SELECT DISTINCT
article.o_id AS ""pim_model_id""
FROM am.object_17 ""article""
INNER JOIN am.object_17 ""color_variation"" ON color_variation.o_parentId = article.o_id
INNER JOIN am.object_17 ""size_variation"" ON size_variation.o_parentId = color_variation.o_id
WHERE article.o_type = 'object'
AND color_variation.o_type='variant'
AND size_variation.o_type = 'variant'"	READY
217	2015-04-24 18:19:20	"638184908"	true	2015-04-24 18:19:20	am.pim_article__tariff_number		"CREATE VIEW am.pim_article__tariff_number AS
SELECT DISTINCT
article.o_id AS ""pim_model_id"",
color_variation.de_customs_tarff_number AS ""tariff_number""
FROM am.object_17 ""article""
INNER JOIN am.object_17 ""color_variation"" ON color_variation.o_parentId = article.o_id
WHERE article.o_type = 'object'
AND color_variation.o_type = 'variant'"	READY
218	2015-04-24 18:19:21	"638184909"	true	2015-04-24 18:19:21	am.o__pics		"CREATE VIEW ""am.o__pics"" AS
SELECT
x.o_id ""o_id"",
CASE
WHEN x.filename6 IS NOT NULL
THEN x.filename1 || '|' || x.filename2 || '|' || x.filename3 || '|' || x.filename4 || '|' || x.filename5 || '|' || x.filename6
WHEN x.filename5 IS NOT NULL
THEN x.filename1 || '|' || x.filename2 || '|' || x.filename3 || '|' || x.filename4 || '|' || x.filename5
WHEN x.filename4 IS NOT NULL
THEN x.filename1 || '|' || x.filename2 || '|' || x.filename3 || '|' || x.filename4
WHEN x.filename3 IS NOT NULL
THEN x.filename1 || '|' || x.filename2 || '|' || x.filename3
WHEN x.filename2 IS NOT NULL
THEN x.filename1 || '|' || x.filename2
WHEN x.filename1 IS NOT NULL
THEN x.filename1
ELSE NULL
END ""pics""
FROM
( SELECT
o.o_id,
assets1.filename ""filename1"",
assets2.filename ""filename2"",
assets3.filename ""filename3"",
assets4.filename ""filename4"",
assets5.filename ""filename5"",
assets6.filename ""filename6""
FROM ""am.object_17"" o
LEFT JOIN ""am.assets"" assets1 ON assets1.id = o.pic1
LEFT JOIN ""am.assets"" assets2 ON assets2.id = o.pic2
LEFT JOIN ""am.assets"" assets3 ON assets3.id = o.pic3
LEFT JOIN ""am.assets"" assets4 ON assets4.id = o.pic4
LEFT JOIN ""am.assets"" assets5 ON assets5.id = o.pic5
LEFT JOIN ""am.assets"" assets6 ON assets6.id = o.pic6 ) x"	READY
219	2015-04-24 18:19:21	"638184910"	true	2015-04-24 18:19:21	am.pim_model__size_variation__smallest		"CREATE VIEW am.pim_model__size_variation__smallest AS
SELECT
article.o_id ""pim_model_id"",
size_variation.o_id ""pim_size_variation_id""
FROM am.object_17 ""article""
INNER JOIN am.object_17 ""color_variation"" ON color_variation.o_parentId = article.o_id
LEFT JOIN am.object_17 ""color_variation_bigger"" ON color_variation_bigger.o_parentId = article.o_id AND color_variation_bigger.o_id > color_variation.o_id
INNER JOIN am.object_17 ""size_variation"" ON size_variation.o_parentId = color_variation.o_id
LEFT JOIN am.object_17 ""size_variation_bigger"" ON size_variation_bigger.o_parentId = color_variation.o_id AND size_variation_bigger.o_id > size_variation.o_id
WHERE color_variation_bigger.o_id IS NULL
AND size_variation_bigger.o_id IS NULL"	READY
220	2015-04-24 18:19:21	"638184911"	true	2015-04-24 18:19:21	am.size_mapping_new__indexed_cg4_brand_size		"CREATE VIEW am.size_mapping_new__indexed_cg4_brand_size AS
SELECT * FROM ""am.size_mapping_new""
WHERE eu_size_x_length IS NULL
AND brand is NOT NULL"	READY
221	2015-04-24 18:19:21	"638184912"	true	2015-04-24 18:19:21	am.size_mapping_new__indexed_cg4_size		"CREATE VIEW am.size_mapping_new__indexed_cg4_size AS
SELECT * FROM ""am.size_mapping_new""
WHERE eu_size_x_length IS NULL
AND brand IS NULL"	READY
222	2015-04-24 18:19:21	"638184913"	true	2015-04-24 18:19:21	am.size_mapping_new__indexed_cg4_sizelength		"CREATE VIEW am.size_mapping_new__indexed_cg4_sizelength AS
SELECT * FROM ""am.size_mapping_new""
WHERE eu_size_x_length IS NOT NULL"	READY
223	2015-04-24 18:19:21	"1112787719"	true	2015-04-24 18:19:21	ml.article_amidala_category		"CREATE VIEW ml.article_amidala_category AS
SELECT
    article_id,
    attribute_id
FROM
    ( SELECT
        a.article_id,
        category.attribute_id,
        category.identifier,
        category.sale_or_premium,
        category.c0,
        category.c1,
        category.c2,
        category.c3,
        category.c4,
        category.c5,
        ROW_NUMBER() OVER ( PARTITION BY a.article_id ORDER BY a.article_id,
                                                               category.sale_or_premium ASC,
                                                               category.depth DESC )
        AS rank
    FROM
        raw.article a
    /**/
        JOIN
        ml.article_attribute aa
        ON a.article_id = aa.article_id
    /**/
        JOIN
        ml.amidala_category_leaves category
        ON aa.attribute_id = category.attribute_id
    ORDER BY a.article_id, category.sale_or_premium ASC, category.depth DESC )
    AS ac
WHERE ac.rank = 1"	READY
491,594	2015-08-10 18:07:01	"1141306924"	true	2015-08-10 18:07:01	tableau.cvr_dashboard_overview_overall		"CREATE VIEW tableau.cvr_dashboard_overview_overall
AS

SELECT
	ab.date_created,
	vi.website_visits,
	oc.other_contacts,
	vi.website_visits +	oc.other_contacts as leads,
	io.incoming_orders,
	sc.stylist_checkout_orders
FROM
(
	SELECT
	    c.date as date_created
	FROM dwh.calendar c 
	WHERE c.date > '2014'
	AND c.date <= CURDATE()
) ab
LEFT JOIN
(
	SELECT 
		date_created,
		SUM(visits) as website_visits
	FROM raw.daily_visits
	GROUP BY 1
	ORDER BY 1 desc
) vi ON vi.date_created = ab.date_created
LEFT JOIN
(
	SELECT 
		CAST(date_created as date) as date_created,
		COUNT(order_id) as other_contacts
	FROM bi.customer_order
	WHERE LOWER(sales_channel) NOT LIKE '%website%'
	GROUP BY 1
	ORDER BY 1 desc
) oc ON oc.date_created = ab.date_created
LEFT JOIN
(
	SELECT 
		CAST(date_created as date) as date_created,
		COUNT(order_id) as incoming_orders
	FROM bi.customer_order
	WHERE date_incoming is not null
	GROUP BY 1
	ORDER BY 1 desc
) io ON io.date_created=ab.date_created
LEFT JOIN
(
SELECT 
	CAST(date_created as date) as date_created,
	COUNT(order_id) as stylist_checkout_orders
FROM bi.customer_order
WHERE date_invoiced is not null
GROUP BY 1
ORDER BY 1 desc
) sc ON sc.date_created = ab.date_created"	READY
229,440	2015-06-24 14:20:58	"1383765190"	true	2015-09-28 17:32:03	tableau.ops_booked_without_return_order_article		"CREATE VIEW tableau.ops_booked_without_return_order_article 
AS

WITH dataset7 as (
    WITH dataset6 as (
        WITH dataset5 as (
            WITH dataset3 as (
                WITH dataset2 as (
                    WITH dataset1 as (
                        SELECT
                                sb.article_id
                                ,sb.date_stock_booked
                                ,cal.day_name as day_name_date_stock_booked
                                ,MAX (
                                    CASE
                                        WHEN coal.date_returned < sb.date_stock_booked
                                        THEN coal.date_returned
                                    END
                                ) as date_last_return
                            FROM
                                bi.stock_booked sb LEFT JOIN bi.customer_order_articles_logistics coal
                                on coal.article_id = sb.article_id LEFT JOIN dwh.calendar cal
                                on cal.date = sb.stock_booking_date
                            WHERE
                                sb.supplier_id = 999997
                            GROUP BY
                                1
                                ,2
                                ,3
                    ) SELECT
                            dataset1.*
                            ,coal2.order_id
                            ,coal2.date_returned as date_article_returned
                            ,co.date_returned as date_customer_order_returned
                            ,co.shipping_country
                        From
                            dataset1 LEFT JOIN bi.customer_order_articles_logistics coal2
                            on dataset1.article_id = coal2.article_id LEFT JOIN bi.customer_order co
                            on co.order_id = coal2.order_id
                        WHERE
                            coal2.date_returned is null
                            AND co.date_returned is not null
                ) SELECT
                        dataset2.*
                        ,coa.date_returned_online
                        ,coa.date_returned as date_article_returned_grails
                        ,coa.date_lost as date_article_lost_grails
                    FROM
                        dataset2 LEFT JOIN bi.customer_order_articles coa
                        on coa.order_id = dataset2.order_id
                        AND coa.article_id = dataset2.article_id
            ) SELECT
                    dataset3.*
                    ,CASE
                        WHEN dataset3.day_name_date_stock_booked = 'Monday'
                        OR dataset3.day_name_date_stock_booked = 'Tuesday'
                        OR dataset3.day_name_date_stock_booked = 'Wednesday'
                        OR dataset3.day_name_date_stock_booked = 'Thursday'
                        THEN - 7
                        ELSE - 7
                    END
                    As days_to_count_from_stock_booked
                FROM
                    dataset3
        ) SELECT
                dataset5.article_id
                ,dataset5.date_stock_booked
                ,dataset5.day_name_date_stock_booked
                ,dataset5.days_to_count_from_stock_booked
                ,TIMESTAMPADD (
                    SQL_TSI_Day
                    ,days_to_count_from_stock_booked
                    ,cast (
                        date_stock_booked as date
                    )
                ) as date_stock_booked_minus_1_week
                ,dataset5.date_last_return
                ,dataset5.order_id
                ,dataset5.date_article_returned
                ,dataset5.date_customer_order_returned
                ,dataset5.date_returned_online
                ,dataset5.shipping_country
                ,dataset5.date_article_returned_grails
                ,dataset5.date_article_lost_grails
            FROM
                dataset5
            GROUP BY
                1
                ,2
                ,3
                ,4
                ,6
                ,7
                ,8
                ,9
                ,10
                ,11
                ,12
                ,13
    ) SELECT
            dataset6.article_id
            ,dataset6.date_stock_booked
            ,dataset6.date_stock_booked_minus_1_week
            ,dataset6.date_last_return
            ,dataset6.order_id
            ,dataset6.date_article_returned
            ,dataset6.date_customer_order_returned
            ,dataset6.date_returned_online
            ,dataset6.shipping_country
            ,dataset6.date_article_returned_grails
            ,dataset6.date_article_lost_grails
        FROM
            dataset6
        WHERE
            cast (
                date_last_return as date
            ) < date_stock_booked_minus_1_week
            AND cast (
                date_customer_order_returned as date
            ) >= date_stock_booked_minus_1_week
            AND cast (
                date_customer_order_returned as date
            ) >= date_stock_booked_minus_1_week
            AND cast (
                date_customer_order_returned as date
            ) <= date_stock_booked
            AND dataset6.shipping_country <> 'CH'
            AND dataset6.date_stock_booked > dataset6.date_customer_order_returned
        ORDER BY
            2 desc
            ,1 desc
) SELECT
		dataset7.order_id,
		dataset7.article_id,
   		dataset7.date_stock_booked_minus_1_week,
   		oc.comment
    FROM
        dataset7 
        JOIN 
        (
        	SELECT 
				order_id,
				comment
			FROM ""raw.order_comment"" oc
			WHERE 
			comment LIKE '%manuell%' OR
			comment LIKE '%Retoure%' OR
			comment LIKE '%retourniert%'
			AND 
			(LOWER(comment) NOT LIKE '%manuell retourniert%' OR LOWER(comment) NOT LIKE '%manuell retourniert%'
		 	OR LOWER(comment) NOT LIKE '%manuelle retoure%')
        ) oc on oc.order_id=dataset7.order_id
        LEFT JOIN bi.customer_order co3
        on YEAR (co3.date_returned) = YEAR (dataset7.date_stock_booked_minus_1_week)
        AND MONTH (co3.date_returned) = MONTH (dataset7.date_stock_booked_minus_1_week)
    WHERE
        co3.shipping_country <> 'CH'
    GROUP BY 1,2,3,4"	READY
225	2015-04-24 18:19:23	"1112787721"	true	2015-04-24 18:19:23	views.inventory_1		"CREATE view views.inventory_1
AS
  /*combine all article_ids -> remove null which caused by FULL JOIN*/
SELECT
  CASE 
    WHEN stock.sku IS NOT NULL THEN stock.sku
    WHEN stock.sku IS NULL THEN sm.article_id
  END AS article_id,
  /*combine all date_created -> remove null which caused by FULL JOIN*/ 
  CASE 
    WHEN stock.date_created IS NOT NULL THEN stock.date_created
    WHEN stock.date_created IS NULL THEN sm.date_created
  END AS date_created,
  /*  inventoty at t0 AND t1 FROM stock_entry history + stock_entry current stock*/
  stock.quantity,
  stock.reserved,
  stock.quantity2,
  stock.reserved2,
  /*Stock movements FROM stock_mutation - for ow only - dlv=dilivery - lret=return to supplier*/
  sm.quantity_ow_dlv,
  sm.quantity_z_dlv,
  sm.quantity_ow_lret,
  sm.quantity_z_lret,
  /*Deliveries AND returns FROM purchase_order ow only*/
  pu.pop_fulfilled_quantity,
  pu.pop_quantity,
  pu.pop_initial_quantity,
  pu.pop_retail_price_min,
  pu.pop_purchase_price_min,
  pu.pop_retail_price_max,
  pu.pop_purchase_price_max,
  pu.pop_retail_price_avg,
  pu.pop_purchase_price_avg,
  pu.pop_intial_quantity_retail,
  pu.pop_intial_quantity_purchase,
  pu.pop_quantity_retail,
  pu.pop_quantity_purchase,
  pu.pop_fulfilled_quantity_retail,
  pu.pop_fulfilled_quantity_purchase,
  /*Article information - SELECTed fields needed by einkauf, do not use an extra view in tableau*/
  a.oo_id,
  a.ean,
  a.brand,
  a.article_name,
  a.supplier_availability,
  a.commodity_group1,
  a.commodity_group2,
  a.commodity_group3,
  a.commodity_group4,
  a.commodity_group5,
  a.country_of_production,
  a.processing_code,
  a.color1,
  a.supplier_sku,
  a.supplier_color_code,
  a.supplier_color_name,
  a.purchase_price,
  a.pic1,
  a.color1_shade,
  a.nos,
  a.season,
  a.amidala_deactive,
  a.amidala_categories,
  a.supplier_size,
  a.eu_size,
  a.supplier_length,
  a.eu_length,
  a.alternative_supplier_sku,
  a.push,
  a.reduced,
  a.season_start,
  a.activation_ch,
  a.net_weight_gram,
  a.gross_weight_gram,
  a.de_customs_tarff_number,
  a.ch_customs_tariff_number,
  a.age,
  a.style,
  a.core_article,
  a.o_parentId AS article_o_parentId,
  a.o_published,
  a.o_creationDate,
  a.supplier_article_id,
  a.supplier_article_article_id,
  a.supplier_article_sku,
  a.supplier_article_purchase_price,
  a.supplier_article_ean,
  a.supplier_article_image_url,
  a.supplier_article_partner_shop_url,
  a.supplier_article_manufacturer_sku,
  a.article_id AS article_article_id,
  a.article_title,
  a.article_color,
  a.article_size,
  a.article_sku,
  a.article_model_id,
  a.check_tariff_numbers,
  a.price_retail_de,
  a.price_retail_original,
  a.price_retail_chf,
  a.price_retail_original_chf,
  a.price_retail_dkk,
  a.price_retail_original_dkk,
  a.price_retail_sek,
  a.price_retail_original_sek,
  a.price_retail_benelux,
  a.price_retail_original_benelux,
  a.date_available,
  a.promotion_item,
  a.production_textile,
  a.reason_deactive,
  a.stock_type,
  /*Deilivery Dates*/
  date_delivery.min_date_delivery,
  date_delivery.max_date_delivery,
  se.quantity AS final_stock,
  se.reserved AS final_reserved
FROM views.stock_inventory stock 
LEFT JOIN views.ownstock_article a ON stock.sku=a.article_id
LEFT JOIN views.stock_entry se ON se.date_created=stock.date_created AND se.sku=stock.sku
LEFT JOIN
(
    SELECT
      a.o_parentID, 
      min(CAST(sm.date_created AS date)) AS min_date_delivery, 
      max(CAST(sm.date_created AS date)) AS max_date_delivery
    FROM views.doc_data_stock_mutation sm
    INNER JOIN views.ownstock_article a ON CAST(sm.customer_article_number AS long)=a.article_id
    WHERE sm.booking_code=1 AND sm.processing_state=2 AND
    sm.po_number IN (SELECT CAST(id AS string) FROM views.purchase_order WHERE stock_location_id=2)
    GROUP BY 1
)date_delivery ON a.o_parentId=date_delivery.o_parentId
/*stock movements FROM stock_mutation - for ow only - dlv=dilivery - lret=return to supplier*/
FULL JOIN
(
  SELECT 
    sm.date_created,
    sm.article_id,
    ow_dlv.quantity_ow_dlv,
    z_dlv.quantity_z_dlv,
    ow_lret.quantity_ow_lret,
    z_lret.quantity_z_lret
  FROM
  (
    SELECT 
      CAST(sm.date_created AS date) AS date_created,
      CAST(sm.customer_article_number AS long) AS article_id,
      count(*) AS nb_of_articles
    FROM views.doc_data_stock_mutation sm
    WHERE sm.processing_state=2 
    AND sm.po_number NOT IN (SELECT CAST(id AS string) FROM views.purchase_order WHERE stock_location_id!=2)
    GROUP BY 1,2
  )sm
  LEFT JOIN
  (
    SELECT
      CAST(date_created AS date) AS date_created,
      CAST(customer_article_number AS long) AS article_id, 
      sum(CAST(quantity_good AS integer)) AS quantity_ow_dlv
    FROM views.doc_data_stock_mutation 
    WHERE booking_code=1 AND processing_state=2 AND
    po_number IN (SELECT CAST(id AS string) FROM views.purchase_order WHERE stock_location_id=2)
    GROUP BY 1,2
  )ow_dlv ON ow_dlv.article_id=sm.article_id AND ow_dlv.date_created=sm.date_created
  LEFT JOIN
  (
    SELECT
      CAST(date_created AS date) AS date_created,
      CAST(customer_article_number AS long) AS article_id,
      sum(CAST(quantity_good AS integer)) AS quantity_z_dlv
    FROM views.doc_data_stock_mutation
    WHERE booking_code=1 AND processing_state=2 AND supplier_code='25'
    GROUP BY 1,2
  )z_dlv ON z_dlv.article_id=sm.article_id AND z_dlv.date_created=sm.date_created
  LEFT JOIN
  (
    SELECT 
      CAST(date_created AS date) AS date_created, 
      CAST(customer_article_number AS long) AS article_id, 
      sum(CAST(quantity_good AS integer)) AS quantity_ow_lret
    FROM views.doc_data_stock_mutation
    WHERE
    booking_code=3  AND supplier_code IN (999992, 999998) AND processing_state=2 AND 
    /*Please check once a month AND IN CASE of errors & questions -> ask operations  - manual process*/
    packing_slip_number
    IN ('KUNDENWUNSCH', 'Lieferr. Retour', 'SO', 'SO/BENSHERMAN', 'SO/BENSHERMAN,', 'SO/BUGATTI', 'SO/CAMPUS','SO/DOCKeRS','SO/DOCKERS','SO/FTC','SO/GANT','SO/LEVIS','SO/LVIS',
    'SO/MAZE','SO/KIOMI','SO/MICHAALSKY','SO/MICHALSKY','SO/MICHALSY','SO/OUTFIT.Basic','SO/OUTFIT.BASIC','SO/PAEZ','SO/SELECTED','SO BENSCHERMAN','SO LEVIS','SO SELECTED',
    'LPP ARNE 11.07.2014', 'LPP126729979', 'LPP', 'LPP 4052871253388', '446850002 DOCKERS', 'CAMPUS', 'GANT S5690', 'Campus', 'REF:  TOM TAILOR'
    ) OR LEFT(packing_slip_number,3)='CNR' OR LEFT(packing_slip_number,6) = 'SO CNR' AND LEFT(packing_slip_number,5)!='CNR-Z'
    GROUP BY 1,2
  )ow_lret ON ow_lret.article_id=sm.article_id AND ow_lret.date_created=sm.date_created
  LEFT JOIN
  (
    SELECT
      CAST(date_created AS date) AS date_created, 
      CAST(customer_article_number AS long) AS article_id, 
      sum(CAST(quantity_good AS integer)) AS quantity_z_lret
    FROM views.doc_data_stock_mutation
    WHERE
    booking_code=3  AND supplier_code IN (999992, 999998) AND processing_state=2 AND packing_slip_number
    IN('20140807-CNR-Z', 'RETOURE Z 1', '20140807-CNR Z', '20140806-CNR-Z', 'SVEN04072014', 'SVEN 4.7.2014', 'AUSBUCH_ LARS', 'Retoure Z1',
    'ZALANDO LIEF RET. 2', 'Z-Retoure 14.08', 'Z-LIEF-RETOUR TEIL 2', 'ZALANDO LIF RET T2', 'CNR-Z', 'Z-LIEF-RET T2', 'Ref Z-RETOURE 1', 'ZALANDO LIEF--RETOUR',
    'ZALANDO LIEFRET', 'RETOURE O 1', 'Z-RETOURE 25.8.14', '20140807_CNR-Z', 'Retoure Z 1', '20140806_CNR-Z', 'SVEN 04.07.2014', 'Z-RETOURE 14.08.2014'
    ) OR LEFT(packing_slip_number,5)='CNR-Z'
    GROUP BY 1,2
  )z_lret ON z_lret.article_id=sm.article_id AND z_lret.date_created=sm.date_created
)sm ON sm.article_id=stock.sku AND sm.date_created=stock.date_created
/*Backlog FROM purchase - always agg. yesterday*/
FULL JOIN
(
  SELECT 
    timestampadd(SQL_TSI_DAY, -1, CAST(now() AS date)) AS date_created,
    pop.article_id AS ""article_id"",
    sum(pop.fulfilled_quantity) AS ""pop_fulfilled_quantity"",
    sum(pop.quantity) AS ""pop_quantity"",
    sum(pop.initial_quantity) AS ""pop_initial_quantity"",
    min(pop.retail_price) AS ""pop_retail_price_min"",
    min(pop.purchase_price) AS ""pop_purchase_price_min"",
    max(pop.retail_price) AS ""pop_retail_price_max"",
    max(pop.purchase_price) AS ""pop_purchase_price_max"",
    avg(pop.retail_price) AS ""pop_retail_price_avg"",
    avg(pop.purchase_price) AS ""pop_purchase_price_avg"",
    sum(pop.initial_quantity*pop.retail_price) AS ""pop_intial_quantity_retail"",
    sum(pop.initial_quantity*pop.purchase_price) AS ""pop_intial_quantity_purchase"",
    sum(pop.quantity*pop.retail_price) AS ""pop_quantity_retail"",
    sum(pop.quantity*pop.purchase_price) AS ""pop_quantity_purchase"",
    sum(pop.fulfilled_quantity*pop.retail_price) AS ""pop_fulfilled_quantity_retail"",
    sum(pop.fulfilled_quantity*pop.purchase_price) AS ""pop_fulfilled_quantity_purchase""
  FROM views.purchase_order_position pop
  INNER JOIN views.purchase_order po ON pop.purchase_order_id=po.id 
  WHERE po.stock_location_id=2 
  GROUP BY 1,2
)pu ON pu.date_created=stock.date_created AND pu.article_id=stock.sku"	READY
270	2015-04-24 18:19:48	"1112787756"	true	2015-04-24 18:19:48	views.logistics_overview		"CREATE VIEW views.logistics_overview as
SELECT 
distinct co.id as order_id, 
co.country, 
co.date_picked, 
ddsoir.order_on_error, 
ddsoh.transmitted_pending_shipment, 
bo.backorder_orderid, 
bo.picklist_created_pending_shipment, 
ddsc.packed_order, 
ddms.shipped_order, 
st.awaiting_stylist_pick,
ddr.returned_order
from  
( 
  SELECT 
  co.id,
  co.state,
  co.date_picked,
  co.shipping_address_id,
  ad.country
  from
  (select 
    id,
    state,
    cast((case when date_picked is null then current_date else date_picked end) as date)as ""date_picked"",
    shipping_address_id
    FROM postgres.customer_order
    where cast(date_created as date) > '2014-01-01'
    and cast(date_picked as date) > timestampadd(sql_tsi_month,-2,curdate())
    and state < 1536
  ) co
  left join 
  (
    SELECT
    order_id as canceled_order,
    state_agg
    FROM (select
          order_id,
            sum(state)/sum(quantity) as state_agg
            FROM postgres.order_position
            group by 1
          ) op 
    where state_agg = 2048
    ) op
  on op.canceled_order = co.id
  inner join 
  (
    SELECT 
    id, 
    country 
    FROM postgres.address
  ) ad 
  on ad.id = co.shipping_address_id
  where op.canceled_order is null
) co
left join 
/* ----order status---- */
(
    SELECT
  sosc.orderid,
  case when message<> 'PICKLIST CREATED' then sosc.orderid  else null end as backorder_orderid,
  case when message = 'PICKLIST CREATED' then sosc.orderid  else null end as picklist_created_pending_shipment
  FROM
  (
   SELECT 
    row_number() over (partition by a.orderid order by a.date_created desc) as rnum, 
    a.orderid, 
    a.message 
    from postgres.doc_data_sales_order_status_change a
    left join (SELECT orderid from postgres.doc_data_shipment_confirmation) b on a.orderid = b.orderid
    where b.orderid is null
  ) sosc
  where rnum = 1 
) bo  on bo.orderid = co.id
left join
/* ----all orders on error: these errors appear in the message field in the sales order import result and usually require some type of action---- */
(
  SELECT 
  ddsoir.orderid as order_on_error 
  FROM 
  (
    SELECT 
    orderid, 
    message from postgres.doc_data_sales_order_import_result group by 1,2
  ) ddsoir 
  left join 
  (
    SELECT 
    orderid from postgres.doc_data_sales_order_status_change
  ) ddsosc 
  on ddsosc.orderid = ddsoir.orderid 
  where ddsosc.orderid is null 
  and message <> ''
) ddsoir
on ddsoir.order_on_error = co.id
left join 
/* ----all orders that have been transmitted to doc data (verified by the receipt of the sales order header) and have made it to the picklist creation (which happens at 7am and 2pm)---- */
(
  SELECT 
  a.orderid as transmitted_pending_shipment
  FROM 
  (
    SELECT 
    ddsoh.orderid from postgres.doc_data_sales_order_header ddsoh 
    left join 
    (
      SELECT 
      orderid from postgres.doc_data_sales_order_status_change
    ) ddsosc on ddsosc.orderid = ddsoh.orderid
    where ddsosc.orderid is null
    group by 1
  ) a
) ddsoh
on ddsoh.transmitted_pending_shipment = co.id
left join 
/* ----all orders that have been added to the shipment confirmation, i.e. all items have been pulled for packing (packing takes about 10 minutes), but are not on the shipment manifest (transmitted 1x per day at 22:30)---- */
(
  SELECT 
  ddsc.orderid as packed_order 
  FROM postgres.doc_data_shipment_confirmation ddsc 
  left join postgres.doc_data_manifest_shipping ddms 
  on ddsc.orderid = ddms.orderid 
  where ddms.orderid is null
  group by 1
) ddsc
on ddsc.packed_order = co.id
left join 
/* ----all orders on the shipment manifest---- */
(
  SELECT 
  orderid as shipped_order, 
  cast(shipping_date as date) as shipping_date from postgres.doc_data_manifest_shipping
) ddms
on ddms.shipped_order = co.id
left join
/* ----all orders awaiting to be picked---- */
(
  SELECT 
  co.id as awaiting_stylist_pick, 
  co.stylelist_id, 
  current_date as ""date_picked"" FROM postgres.customer_order co
  left join views.salesforce_opportunity sfo on sfo.ExternalOrderId__c = co.id
  left join views.stylist st on co.stylelist_id = st.stylist_id
  where OpsCheck__c = 'OK' 
  and stagename = 'Artikel bestellen' 
  and st.name not in ('Eve Rosenthal','Doreen Jansen','Ria Herzog','Lea Maler','Katrin Svensson','Nicole Eden','Lisa Fuchs','Mandy Brunnecker')
) st 
on st.awaiting_stylist_pick = co.id
left join
/* ----all orders that have been returned---- */
(select
ddr.original_orderid as returned_order
FROM postgres.doc_data_return ddr
) ddr
on ddr.returned_order = co.id"	READY
316	2015-04-24 18:20:33	"1112787795"	true	2015-04-24 18:20:33	tableau.ops_receivings_credit_note_upload		"CREATE view tableau.ops_receivings_credit_note_upload
AS
SELECT 
poa.purchase_order_id as po, 
poa.article_ean as ean, 
poa.stock_scanned as count_scans, 
poa.date_stock_handedover_max as max_date_given_to_serviceprovider, 
cu.stock_credit_note_no as credit_note_no, 
cu.stock_credit_note_qty as credit_note_quantity, 
cast(cu.date_stock_credit_note_receipt as date) as date_of_receipt, 
cast(cu.date_stock_credit_note_processed as date) as date_processed, 
cu.stock_credit_note_accountant as credit_accountant,
au.delivery_note_quantity_supplier, 
au.invoice_number, 
au.invoice_quantity, 
au.accounting_date, 
au.accountant as acctg_upload_accountant, 
poa.stock_ordered_revised as quantity, 
poa.stock_booked as fulfilled_quantity, 
poa.article_sales_price as retail_price, 
poa.article_cost as purchase_price, 
pim.brand
from bi.purchase_order_articles poa
left join raw.stock_credit_note cu 
on poa.purchase_order_id = cu.purchase_order_id and poa.article_ean = cu.article_ean 
left join raw.accounting_upload au 
on au.purchase_order_id = poa.purchase_order_id and au.ean = poa.article_ean
left join raw.article_detail_pim pim 
on pim.ean = poa.article_ean
where cu.stock_credit_note_no is not null
and driving_tbl_scan is not null"	READY
319	2015-04-24 18:20:44	"1112787798"	true	2015-04-24 18:20:44	tableau.ops_monthly_doc_data_bookings_stock_mutations		"CREATE view tableau.ops_monthly_doc_data_bookings_stock_mutations
as
SELECT 
sm.article_id,
poa.article_ean,  
sm.date_stock_booked, 
sm.purchase_order_id, 
sm.stock_booking_code,
cast(sm.stock_booked as integer) as stock_booked,
cast(sm.supplier_id as integer) as supplier_id
FROM bi.stock_booked sm
left join 
(select 
  distinct p.article_ean, 
  p.article_id 
  FROM bi.purchase_order_articles p
) poa
ON poa.article_id = sm.article_id"	READY
228	2015-04-24 18:19:24	"1112787724"	true	2015-04-24 18:19:24	ml.article_category_new		"/*
    Article -> Amidala Category Mapping

    Each article has at most one category by breaking ties favoring
    categories that don't have 'sale' or 'premium' in the category
    and having bigger depth
*/
CREATE VIEW ml.article_category_new AS
SELECT
    article_id,
    attribute_id,
    identifier,
    flat_category,
    sale_or_premium,
    c0,
    c1,
    c2,
    c3,
    c4,
    c5
FROM
    ( SELECT
        a.article_id,
        category.attribute_id,
        category.identifier,
        category.flat_category,
        category.sale_or_premium,
        category.c0,
        category.c1,
        category.c2,
        category.c3,
        category.c4,
        category.c5,
        ROW_NUMBER() OVER ( PARTITION BY a.article_id ORDER BY a.article_id,
                                                               category.sale_or_premium ASC,
                                                               category.depth DESC )
        AS rank
    FROM
        ml.article a
    /**/
        JOIN
        ml.article_attribute aa
        ON a.article_id = aa.article_id
    /**/
        JOIN
        ml.category_new category
        ON aa.attribute_id = category.attribute_id
    ORDER BY a.article_id, category.sale_or_premium ASC, category.depth DESC )
    AS ac
WHERE ac.rank = 1"	READY
320	2015-04-24 18:20:44	"1112787799"	true	2015-07-03 12:34:46	tableau.stylist_overview_dashboard		"CREATE VIEW tableau.stylist_overview_dashboard 
AS
SELECT
co.order_id,
co.customer_id,
co.stylist_id,
CASE 
	WHEN s.role = 'Fake' AND s.stylist_id != 118566682 THEN 'Fake Stylist ' || s.team
	ELSE s.first_name || ' ' || s.last_name 
END as stylist_name,
s.team as stylist_team,
s.role as stylist_role,
c.first_name || ' ' || c.last_name as customer_name,
co.order_sales_stage,
co.order_state,
co.order_state_number,
CASE 
  WHEN co.order_type like '%Follow%' THEN 'Follow-on Order'
  ELSE co.order_type
END as order_type,
co.box_type,
co.revenue_state,
co.sales_channel,
co.sales_channel_special,
co.kept_state,
co.ops_check,
co.payment_type,
co.shipping_country,
co.date_incoming,
co.date_invoiced,
co.date_phone_call as date_phone_call_current,
co.date_stylist_picked,
co.date_preview_created,
co.date_next_contact,
COALESCE(co.sales_sent, co.sales_picked) as sales_sent,
co.sales_kept,
case when co.revenue_state='Final' then co.billing_net_sales else null end as billing_net_sales,
case when co.revenue_state='Final' then co.billing_total else null end as billing_total,
co.inactive_reasons,
co.not_reached,
CASE WHEN c.phone_number is null THEN false ELSE true END as has_phone_number,
co.wrong_phone_number,
co.call_cancelled,
co.call_confirmed,
co.given_to_debt_collection,
co.new_phone_appointment,
co.calendar_full,
c.club_membership_type,
c.club_member,
cos.preview_not_liked

FROM bi.customer_order co
LEFT JOIN bi.stylist s on s.stylist_id = co.stylist_id
LEFT JOIN bi.customer c on c.customer_id = co.customer_id
LEFT JOIN raw.customer_order_salesforce cos on cos.order_id=co.order_id
WHERE co.order_state_number > 4
AND s.enabled"	READY
324	2015-04-24 18:20:50	"1112787803"	true	2015-04-24 18:20:50	bi.customer_order_action_tracking		"CREATE VIEW bi.customer_order_action_tracking AS

SELECT
	co.order_id,
	co.stylist_id,
	at.stylist_name,
	SUM(at.stylist_pick_minutes) 		AS stylist_pick_minutes,
	SUM(at.stylist_article_adds) 		AS stylist_article_adds,
	SUM(at.stylist_article_searches) 	AS stylist_article_searches,
	SUM(at.stylist_article_removals) 	AS stylist_article_removals,
	MIN(at.date_phone_call_started) 	AS date_phone_call_started,
	MAX(at.date_phone_call_ended) 		AS date_phone_call_ended
FROM 
	bi.customer_order AS co
	JOIN
	raw.stylist_action_tracking AS at
		 ON co.stylist_id = at.stylist_id
		AND co.order_id = at.order_id
GROUP BY 1,2,3"	READY
491,595	2015-08-10 19:05:24	"1209197452"	true	2015-08-24 14:01:22	raw.arvato_first_address_risk_check		"CREATE VIEW raw.arvato_first_address_risk_check
AS

/*this view has orders where first address is sent to arvato for risk check*/

SELECT
	a.order_id,
	a.customer_id,
	a.arv_date_created,
	a.requestbody_1,
	a.arvatoresult_1,
	a.responseCode_1,
	a.arvatoresult_2,
	a.responseCode_2,
	left(substring(a.requestbody_1, LOCATE('firstName',a.requestbody_1)+12), (LOCATE('""', substring(a.requestbody_1, LOCATE('firstName',a.requestbody_1)+13)))) as ""first_name"", 
	left(substring(a.requestbody_1, LOCATE('lastName',a.requestbody_1)+11), (LOCATE('""', substring(a.requestbody_1, LOCATE('lastName',a.requestbody_1)+13)))) as ""last_name"",
	left(substring(a.requestbody_1, LOCATE('careOf',a.requestbody_1)+9), (LOCATE('""', substring(a.requestbody_1, LOCATE('careOf',a.requestbody_1)+10)))) as careOf,
	left(substring(a.requestbody_1, LOCATE('street',a.requestbody_1)+9), (LOCATE('""', substring(a.requestbody_1, LOCATE('street',a.requestbody_1)+10)))) as street,
	left(substring(a.requestbody_1, LOCATE('streetNumber',a.requestbody_1)+15), (LOCATE('""', substring(a.requestbody_1, LOCATE('streetNumber',a.requestbody_1)+16)))) as streetNumber,
	left(substring(a.requestbody_1, LOCATE('zipCode',a.requestbody_1)+10), (LOCATE('""', substring(a.requestbody_1, LOCATE('zipCode',a.requestbody_1)+11)))) as zipCode,
	left(substring(a.requestbody_1, LOCATE('city',a.requestbody_1)+7), (LOCATE('""', substring(a.requestbody_1, LOCATE('city',a.requestbody_1)+8)))) as city,
	replace(left(left(substring(a.requestbody_1, LOCATE('country',a.requestbody_1)+9), (LOCATE('}', substring(a.requestbody_1, LOCATE('city',a.requestbody_1)+10)))),3),'}','') as country,
	left(substring(a.requestbody_1, LOCATE('email',a.requestbody_1)+8), (LOCATE('""', substring(a.requestbody_1, LOCATE('email',a.requestbody_1)+9)))) as email,
	CASE WHEN b.order_type IS NULL THEN 'First Order' ELSE b.order_type END as order_type,
	cu.default_domain
FROM ""views.arvatoresults"" a
/*assigns last order_type for customers who's orders are not created but risk check is done*/
LEFT JOIN
(
  SELECT
  	ROW_NUMBER() OVER(PARTITION BY customer_id ORDER BY date_created desc) AS rank,
  	customer_id,
  	order_type
  FROM bi.customer_order
)b on a.customer_id=b.customer_id and b.rank=1
LEFT JOIN raw.customer cu on cu.customer_id=a.customer_id"	READY
229	2015-04-24 18:19:24	"1394513958"	true	2015-09-30 17:43:56	bi.marketing_funnel_by_date_domain_channel_device		"CREATE VIEW bi.marketing_funnel_by_date_domain_channel_device
AS

SELECT 
vi.date_created,
vi.domain,
vi.marketing_channel,
vi.devicecategory,
'Google Analytics' as data_source,
SUM(vi.visits) as visits,
CASE
	WHEN pro.goal_1 = 'RE_Survey' THEN COALESCE(go1.goal_1,0)
	WHEN pro.goal_2 = 'RE_Survey' THEN COALESCE(go1.goal_2,0)
	WHEN pro.goal_3 = 'RE_Survey' THEN COALESCE(go1.goal_3,0)
	WHEN pro.goal_4 = 'RE_Survey' THEN COALESCE(go1.goal_4,0)
	WHEN pro.goal_5 = 'RE_Survey' THEN COALESCE(go1.goal_5,0)
	WHEN pro.goal_6 = 'RE_Survey' THEN COALESCE(go1.goal_6,0)
	WHEN pro.goal_7 = 'RE_Survey' THEN COALESCE(go1.goal_7,0)
	WHEN pro.goal_8 = 'RE_Survey' THEN COALESCE(go1.goal_8,0)
	WHEN pro.goal_9 = 'RE_Survey' THEN COALESCE(go1.goal_9,0)
	WHEN pro.goal_10 = 'RE_Survey' THEN COALESCE(go1.goal_10,0)
	WHEN pro.goal_11 = 'RE_Survey' THEN COALESCE(go2.goal_11,0)
	WHEN pro.goal_12 = 'RE_Survey' THEN COALESCE(go2.goal_12,0)
	WHEN pro.goal_13 = 'RE_Survey' THEN COALESCE(go2.goal_13,0)
	WHEN pro.goal_14 = 'RE_Survey' THEN COALESCE(go2.goal_14,0)
	WHEN pro.goal_15 = 'RE_Survey' THEN COALESCE(go2.goal_15,0)
	WHEN pro.goal_16 = 'RE_Survey' THEN COALESCE(go2.goal_16,0)
	WHEN pro.goal_17 = 'RE_Survey' THEN COALESCE(go2.goal_17,0)
	WHEN pro.goal_18 = 'RE_Survey' THEN COALESCE(go2.goal_18,0)
	WHEN pro.goal_19 = 'RE_Survey' THEN COALESCE(go2.goal_19,0)
	WHEN pro.goal_20 = 'RE_Survey' THEN COALESCE(go2.goal_20,0)
END as started_survey,
CASE
	WHEN pro.goal_1 = 'RE_AccountCreation1' THEN COALESCE(go1.goal_1,0)
	WHEN pro.goal_2 = 'RE_AccountCreation1' THEN COALESCE(go1.goal_2,0)
	WHEN pro.goal_3 = 'RE_AccountCreation1' THEN COALESCE(go1.goal_3,0)
	WHEN pro.goal_4 = 'RE_AccountCreation1' THEN COALESCE(go1.goal_4,0)
	WHEN pro.goal_5 = 'RE_AccountCreation1' THEN COALESCE(go1.goal_5,0)
	WHEN pro.goal_6 = 'RE_AccountCreation1' THEN COALESCE(go1.goal_6,0)
	WHEN pro.goal_7 = 'RE_AccountCreation1' THEN COALESCE(go1.goal_7,0)
	WHEN pro.goal_8 = 'RE_AccountCreation1' THEN COALESCE(go1.goal_8,0)
	WHEN pro.goal_9 = 'RE_AccountCreation1' THEN COALESCE(go1.goal_9,0)
	WHEN pro.goal_10 = 'RE_AccountCreation1' THEN COALESCE(go1.goal_10,0)
	WHEN pro.goal_11 = 'RE_AccountCreation1' THEN COALESCE(go2.goal_11,0)
	WHEN pro.goal_12 = 'RE_AccountCreation1' THEN COALESCE(go2.goal_12,0)
	WHEN pro.goal_13 = 'RE_AccountCreation1' THEN COALESCE(go2.goal_13,0)
	WHEN pro.goal_14 = 'RE_AccountCreation1' THEN COALESCE(go2.goal_14,0)
	WHEN pro.goal_15 = 'RE_AccountCreation1' THEN COALESCE(go2.goal_15,0)
	WHEN pro.goal_16 = 'RE_AccountCreation1' THEN COALESCE(go2.goal_16,0)
	WHEN pro.goal_17 = 'RE_AccountCreation1' THEN COALESCE(go2.goal_17,0)
	WHEN pro.goal_18 = 'RE_AccountCreation1' THEN COALESCE(go2.goal_18,0)
	WHEN pro.goal_19 = 'RE_AccountCreation1' THEN COALESCE(go2.goal_19,0)
	WHEN pro.goal_20 = 'RE_AccountCreation1' THEN COALESCE(go2.goal_20,0)
END as completed_survey,
CASE
	WHEN pro.goal_1 = 'RE_ProfileCreation' THEN COALESCE(go1.goal_1,0)
	WHEN pro.goal_2 = 'RE_ProfileCreation' THEN COALESCE(go1.goal_2,0)
	WHEN pro.goal_3 = 'RE_ProfileCreation' THEN COALESCE(go1.goal_3,0)
	WHEN pro.goal_4 = 'RE_ProfileCreation' THEN COALESCE(go1.goal_4,0)
	WHEN pro.goal_5 = 'RE_ProfileCreation' THEN COALESCE(go1.goal_5,0)
	WHEN pro.goal_6 = 'RE_ProfileCreation' THEN COALESCE(go1.goal_6,0)
	WHEN pro.goal_7 = 'RE_ProfileCreation' THEN COALESCE(go1.goal_7,0)
	WHEN pro.goal_8 = 'RE_ProfileCreation' THEN COALESCE(go1.goal_8,0)
	WHEN pro.goal_9 = 'RE_ProfileCreation' THEN COALESCE(go1.goal_9,0)
	WHEN pro.goal_10 = 'RE_ProfileCreation' THEN COALESCE(go1.goal_10,0)
	WHEN pro.goal_11 = 'RE_ProfileCreation' THEN COALESCE(go2.goal_11,0)
	WHEN pro.goal_12 = 'RE_ProfileCreation' THEN COALESCE(go2.goal_12,0)
	WHEN pro.goal_13 = 'RE_ProfileCreation' THEN COALESCE(go2.goal_13,0)
	WHEN pro.goal_14 = 'RE_ProfileCreation' THEN COALESCE(go2.goal_14,0)
	WHEN pro.goal_15 = 'RE_ProfileCreation' THEN COALESCE(go2.goal_15,0)
	WHEN pro.goal_16 = 'RE_ProfileCreation' THEN COALESCE(go2.goal_16,0)
	WHEN pro.goal_17 = 'RE_ProfileCreation' THEN COALESCE(go2.goal_17,0)
	WHEN pro.goal_18 = 'RE_ProfileCreation' THEN COALESCE(go2.goal_18,0)
	WHEN pro.goal_19 = 'RE_ProfileCreation' THEN COALESCE(go2.goal_19,0)
	WHEN pro.goal_20 = 'RE_ProfileCreation' THEN COALESCE(go2.goal_20,0)
END as account_created,
CASE
	WHEN pro.goal_1 = 'RE_OrderCreation' THEN COALESCE(go1.goal_1,0)
	WHEN pro.goal_2 = 'RE_OrderCreation' THEN COALESCE(go1.goal_2,0)
	WHEN pro.goal_3 = 'RE_OrderCreation' THEN COALESCE(go1.goal_3,0)
	WHEN pro.goal_4 = 'RE_OrderCreation' THEN COALESCE(go1.goal_4,0)
	WHEN pro.goal_5 = 'RE_OrderCreation' THEN COALESCE(go1.goal_5,0)
	WHEN pro.goal_6 = 'RE_OrderCreation' THEN COALESCE(go1.goal_6,0)
	WHEN pro.goal_7 = 'RE_OrderCreation' THEN COALESCE(go1.goal_7,0)
	WHEN pro.goal_8 = 'RE_OrderCreation' THEN COALESCE(go1.goal_8,0)
	WHEN pro.goal_9 = 'RE_OrderCreation' THEN COALESCE(go1.goal_9,0)
	WHEN pro.goal_10 = 'RE_OrderCreation' THEN COALESCE(go1.goal_10,0)
	WHEN pro.goal_11 = 'RE_OrderCreation' THEN COALESCE(go2.goal_11,0)
	WHEN pro.goal_12 = 'RE_OrderCreation' THEN COALESCE(go2.goal_12,0)
	WHEN pro.goal_13 = 'RE_OrderCreation' THEN COALESCE(go2.goal_13,0)
	WHEN pro.goal_14 = 'RE_OrderCreation' THEN COALESCE(go2.goal_14,0)
	WHEN pro.goal_15 = 'RE_OrderCreation' THEN COALESCE(go2.goal_15,0)
	WHEN pro.goal_16 = 'RE_OrderCreation' THEN COALESCE(go2.goal_16,0)
	WHEN pro.goal_17 = 'RE_OrderCreation' THEN COALESCE(go2.goal_17,0)
	WHEN pro.goal_18 = 'RE_OrderCreation' THEN COALESCE(go2.goal_18,0)
	WHEN pro.goal_19 = 'RE_OrderCreation' THEN COALESCE(go2.goal_19,0)
	WHEN pro.goal_20 = 'RE_OrderCreation' THEN COALESCE(go2.goal_20,0)
END as size_details_added,
CASE
	WHEN pro.goal_1 = 'RE_PickCallDate' THEN COALESCE(go1.goal_1,0)
	WHEN pro.goal_2 = 'RE_PickCallDate' THEN COALESCE(go1.goal_2,0)
	WHEN pro.goal_3 = 'RE_PickCallDate' THEN COALESCE(go1.goal_3,0)
	WHEN pro.goal_4 = 'RE_PickCallDate' THEN COALESCE(go1.goal_4,0)
	WHEN pro.goal_5 = 'RE_PickCallDate' THEN COALESCE(go1.goal_5,0)
	WHEN pro.goal_6 = 'RE_PickCallDate' THEN COALESCE(go1.goal_6,0)
	WHEN pro.goal_7 = 'RE_PickCallDate' THEN COALESCE(go1.goal_7,0)
	WHEN pro.goal_8 = 'RE_PickCallDate' THEN COALESCE(go1.goal_8,0)
	WHEN pro.goal_9 = 'RE_PickCallDate' THEN COALESCE(go1.goal_9,0)
	WHEN pro.goal_10 = 'RE_PickCallDate' THEN COALESCE(go1.goal_10,0)
	WHEN pro.goal_11 = 'RE_PickCallDate' THEN COALESCE(go2.goal_11,0)
	WHEN pro.goal_12 = 'RE_PickCallDate' THEN COALESCE(go2.goal_12,0)
	WHEN pro.goal_13 = 'RE_PickCallDate' THEN COALESCE(go2.goal_13,0)
	WHEN pro.goal_14 = 'RE_PickCallDate' THEN COALESCE(go2.goal_14,0)
	WHEN pro.goal_15 = 'RE_PickCallDate' THEN COALESCE(go2.goal_15,0)
	WHEN pro.goal_16 = 'RE_PickCallDate' THEN COALESCE(go2.goal_16,0)
	WHEN pro.goal_17 = 'RE_PickCallDate' THEN COALESCE(go2.goal_17,0)
	WHEN pro.goal_18 = 'RE_PickCallDate' THEN COALESCE(go2.goal_18,0)
	WHEN pro.goal_19 = 'RE_PickCallDate' THEN COALESCE(go2.goal_19,0)
	WHEN pro.goal_20 = 'RE_PickCallDate' THEN COALESCE(go2.goal_20,0)
END as personal_details_added,
CASE
	WHEN pro.goal_1 = 'RE_SuccessNC' THEN COALESCE(go1.goal_1,0)
	WHEN pro.goal_2 = 'RE_SuccessNC' THEN COALESCE(go1.goal_2,0)
	WHEN pro.goal_3 = 'RE_SuccessNC' THEN COALESCE(go1.goal_3,0)
	WHEN pro.goal_4 = 'RE_SuccessNC' THEN COALESCE(go1.goal_4,0)
	WHEN pro.goal_5 = 'RE_SuccessNC' THEN COALESCE(go1.goal_5,0)
	WHEN pro.goal_6 = 'RE_SuccessNC' THEN COALESCE(go1.goal_6,0)
	WHEN pro.goal_7 = 'RE_SuccessNC' THEN COALESCE(go1.goal_7,0)
	WHEN pro.goal_8 = 'RE_SuccessNC' THEN COALESCE(go1.goal_8,0)
	WHEN pro.goal_9 = 'RE_SuccessNC' THEN COALESCE(go1.goal_9,0)
	WHEN pro.goal_10 = 'RE_SuccessNC' THEN COALESCE(go1.goal_10,0)
	WHEN pro.goal_11 = 'RE_SuccessNC' THEN COALESCE(go2.goal_11,0)
	WHEN pro.goal_12 = 'RE_SuccessNC' THEN COALESCE(go2.goal_12,0)
	WHEN pro.goal_13 = 'RE_SuccessNC' THEN COALESCE(go2.goal_13,0)
	WHEN pro.goal_14 = 'RE_SuccessNC' THEN COALESCE(go2.goal_14,0)
	WHEN pro.goal_15 = 'RE_SuccessNC' THEN COALESCE(go2.goal_15,0)
	WHEN pro.goal_16 = 'RE_SuccessNC' THEN COALESCE(go2.goal_16,0)
	WHEN pro.goal_17 = 'RE_SuccessNC' THEN COALESCE(go2.goal_17,0)
	WHEN pro.goal_18 = 'RE_SuccessNC' THEN COALESCE(go2.goal_18,0)
	WHEN pro.goal_19 = 'RE_SuccessNC' THEN COALESCE(go2.goal_19,0)
	WHEN pro.goal_20 = 'RE_SuccessNC' THEN COALESCE(go2.goal_20,0)
END as placed_first_order
FROM raw.daily_visits vi
LEFT JOIN 
( 
	SELECT 
		date_created, 
		domain, 
		source, 
		medium, 
		campaign, 
		devicecategory, 
		SUM(goal_1) as goal_1 , 
		SUM(goal_2) as goal_2, 
		SUM(goal_3) as goal_3, 
		SUM(goal_4) as goal_4, 
		SUM(goal_5) as goal_5, 
		SUM(goal_6) as goal_6, 
		SUM(goal_7) as goal_7, 
		SUM(goal_8) as goal_8, 
		SUM(goal_9) as goal_9, 
		SUM(goal_10) as goal_10
	FROM dwh.ga_goals_1
	GROUP BY date_created, domain, source, medium, campaign, devicecategory
) go1 ON vi.date_created = go1.date_created
	AND vi.domain = go1.domain 
	AND vi.source = go1.source
	AND vi.medium = go1.medium
	AND vi.campaign = go1.campaign
	AND vi.devicecategory = go1.devicecategory
LEFT JOIN 
( 
	SELECT 
		date_created, 
		domain, 
		source, 
		medium, 
		campaign, 
		devicecategory, 
		SUM(goal_11) as goal_11, 
		SUM(goal_12) as goal_12, 
		SUM(goal_13) as goal_13, 
		SUM(goal_14) as goal_14, 
		SUM(goal_15) as goal_15, 
		SUM(goal_16) as goal_16, 
		SUM(goal_17) as goal_17, 
		SUM(goal_18) as goal_18, 
		SUM(goal_19) as goal_19, 
		SUM(goal_20) as goal_20
	FROM dwh.ga_goals_2
	GROUP BY date_created, domain, source, medium, campaign, devicecategory
) go2 ON vi.date_created = go2.date_created
	AND vi.domain = go2.domain 
	AND vi.source = go2.source
	AND vi.medium = go2.medium
	AND vi.campaign = go2.campaign
	AND vi.devicecategory = go2.devicecategory
LEFT JOIN dwh.ga_profiles_to_import pro ON vi.domain = pro.domain
WHERE pro.status = 'current'
AND  vi.date_created < '2015-05-28' AND /* Until Snowplow data is fixed */ vi.date_created = '2015-08-24'
GROUP BY 1,2,3,4,5,7,8,9,10,11,12

UNION
	SELECT
		CAST(date_created as date) as date_created,
		domain,
		marketing_channel,
		CASE 
    		WHEN device_type = 'Computer' THEN 'desktop'
        	WHEN device_type = 'Mobile' THEN 'mobile'
        	WHEN device_type = 'Tablet' THEN 'tablet'   
    	END AS devicecategory,
    	'Snowplow' as data_source,
    	COUNT(visitor_session_id) as visits,
		SUM(funnel_questionnaire_visit) as started_survey,
		SUM(funnel_customer_create_visit) as completed_survey,
		SUM(funnel_profile_edit_visit) as account_created,
		SUM(funnel_orders_create_visit) as size_details_added,
		SUM(funnel_pick_call_visit) as personal_details_added,
		SUM(funnel_success_nc_visit) as placed_first_order
	FROM ""raw.snowplow_visits""
	WHERE  CAST(date_created as date) >= '2015-05-28' AND /* Until Snowplow data is fixed */ CAST(date_created as date) != '2015-08-24'
	GROUP BY 1,2,3,4,5"	READY
238	2015-04-24 18:19:28	"1112787731"	true	2015-06-24 16:22:46	bi.stock_booked		"CREATE VIEW bi.stock_booked AS

/* 	please see https://outfittery.atlassian.net/wiki/display/OPS/List+of+Booking-supplier
	for additional explanation of supplier IDs
*/


SELECT
	sb.stock_booked_id,
	sb.purchase_order_id,
	sb.article_id,
	sb.stock_date,
	sb.date_stock_booked,
	CAST(sb.date_stock_booked AS DATE) AS stock_booking_date,
	sb.date_processed,
	sb.last_updated,
	sb.stock_booking_packing_slip_number,
	sb.stock_booking_code,
	sb.stock_booking_processing_reason,
	sb.stock_booking_processing_state_number,
	sb.stock_booking_processing_result,
	sb.supplier_id,
	sb.stock_defects,
	sb.stock_booked,
    /* THERE ISN'T ANY GOOD INFORMATION TO DEFINE THIS, SO JUST A GUESS */
    CASE
      WHEN sb.stock_booking_code = 1 THEN 'po/return'
      WHEN sb.stock_booking_code = 3 THEN 'other bookings'
      ELSE 'Ask BI'
    END AS stock_booking_state,
    /* THERE ISN'T ANY GOOD INFORMATION TO DEFINE THIS, SO JUST A GUESS */
    CASE
      WHEN sb.stock_booking_processing_state_number = 2 THEN 'processed successfully'
      ELSE 'processed unsuccessfully/other'
    END AS stock_booking_processing_state,

	/* SECTION TO COUNT BOOKINGS BY DIFFERENT CLASSIFICATION LOGIC */
	/*----all bookings on a PO----*/
    CASE 
        WHEN sb.stock_booking_code = 1 AND sb.supplier_id NOT IN (999998, 999998, 999997, 999996, 999995, 999992, 1, 20) AND po.stock_location_id = 2 AND sb.purchase_order_id IS NOT NULL
        THEN sb.stock_booked
    END AS po_bookings, /* also known as ow_dlv = own stock delivery received */
    
    /*----all manual un-booking----*/
    /* to cancel a booking */
    CASE
        WHEN sb.stock_booking_code = 3 AND sb.supplier_id = 999998 AND sb.stock_booking_processing_state_number = 2                                               
        THEN sb.stock_booked
    END AS manual_unbookings,
    /*----all 999997 (customer return) bookings----*/
    CASE 
        WHEN sb.stock_booking_code = 1 AND sb.supplier_id = 999997 AND sb.stock_booking_processing_state_number = 2                                               
        THEN sb.stock_booked
    END AS customer_returns, 
    /*----all picklist difference bookings: plus----*/
    /* The picklist is by grouping items to be shipped from multiple orders together; did too may or too few get picked */
    CASE 
        WHEN sb.stock_booking_code = 3 AND sb.supplier_id = 999996 AND sb.stock_booking_processing_state_number = 2 AND sb.stock_booked> 0   
        THEN sb.stock_booked
    END AS picklist_plus, 
    /*----all picklist difference bookings: minus----*/
    CASE 
        WHEN sb.stock_booking_code = 3 AND sb.supplier_id = 999996 AND sb.stock_booking_processing_state_number = 2 AND sb.stock_booked< 0   
        THEN sb.stock_booked
    END AS picklist_minus, 
    /*----all doc data cycle counts bookings----*/
    /*A cycle count is an inventory auditing procedure where a small subset of inventory, in a specific location, is counted on a specified day.*/
    CASE 
        WHEN sb.stock_booking_code = 3 AND sb.supplier_id = 999995 AND sb.stock_booking_processing_state_number = 2                                              
        THEN sb.stock_booked
    END AS cycle_counts,
    /*----all custom request bookings (cycle counts)----*/
    CASE 
        WHEN sb.stock_booking_code = 3 AND sb.supplier_id = 999992 AND sb.stock_booking_processing_state_number = 2 AND sb.stock_booking_packing_slip_number NOT IN ('Lieferr. Retour', 'KUNDENWUNSCH') 
        THEN sb.stock_booked
    END AS custom_requests, 
    /*----all supplier return bookings----*/
    CASE 
        WHEN sb.stock_booking_code = 3 AND sb.supplier_id IN (999992, 999998) AND sb.stock_booking_processing_state_number = 2 
			AND sb.stock_booking_packing_slip_number IN ('KUNDENWUNSCH', 'Lieferr. Retour', 'SO', 'SO/BENSHERMAN', 'SO/BENSHERMAN,', 'SO/BUGATTI', 'SO/CAMPUS','SO/DOCKeRS', 'SO/DOCKERS','SO/FTC',
              	'SO/GANT','SO/LEVIS','SO/LVIS','SO/MAZE','SO/KIOMI','SO/MICHAALSKY','SO/MICHALSKY','SO/MICHALSY','SO/OUTFIT.Basic','SO/OUTFIT.BASIC','SO/PAEZ','SO/SELECTED', 'SO BENSCHERMAN','SO LEVIS',
              	'SO SELECTED', 'LPP ARNE 11.07.2014', 'LPP126729979', 'LPP', 'LPP 4052871253388', '446850002 DOCKERS', 'CAMPUS', 'GANT S5690', 'Campus', 'REF:  TOM TAILOR') 
             OR LEFT(sb.stock_booking_packing_slip_number, 3)  = 'CNR'
             OR LEFT(sb.stock_booking_packing_slip_number, 6)  = 'SO CNR'
            AND LEFT(sb.stock_booking_packing_slip_number, 5) != 'CNR-Z'
        THEN sb.stock_booked
    END AS supplier_returns, /* also called ow_lret */   
    /*----all swiss return bookings----*/
    CASE
        WHEN sb.stock_booking_code = 3 AND sb.supplier_id = 999987 AND sb.stock_booking_processing_state_number = 2
        THEN sb.stock_booked
    END AS swiss_returns,
    /*----all Zalando bookings----*/
    CASE 
        WHEN sb.stock_booking_code = 1 AND sb.supplier_id = 25     AND sb.stock_booking_processing_state_number = 2
        THEN sb.stock_booked
    END AS zalando_bookings, /* also known as quantity_z_dlv = zalando deliveries received */
    /*----all Zalando return bookings----*/
	CASE
		WHEN sb.stock_booking_code = 3 AND sb.supplier_id IN (999992, 999998) AND sb.stock_booking_processing_state_number = 2
    		AND sb.stock_booking_packing_slip_number IN ('20140807-CNR-Z', 'RETOURE Z 1', '20140807-CNR Z', '20140806-CNR-Z', 'SVEN04072014', 'SVEN 4.7.2014', 'AUSBUCH_ LARS', 'Retoure Z1',
				'ZALANDO LIEF RET. 2', 'Z-Retoure 14.08', 'Z-LIEF-RETOUR TEIL 2', 'ZALANDO LIF RET T2', 'CNR-Z', 'Z-LIEF-RET T2', 'Ref Z-RETOURE 1', 'ZALANDO LIEF--RETOUR',
    			'ZALANDO LIEFRET', 'RETOURE O 1', 'Z-RETOURE 25.8.14', '20140807_CNR-Z', 'Retoure Z 1', '20140806_CNR-Z', 'SVEN 04.07.2014', 'Z-RETOURE 14.08.2014') 
    		OR LEFT(sb.stock_booking_packing_slip_number,5) = 'CNR-Z'
		THEN sb.stock_booked
    END AS zalando_returns, /* also known as z_lret */ 
	/*----sample bookings----*/
    CASE
        WHEN sb.stock_booking_code = 1 AND sb.supplier_id = 20     AND sb.stock_booking_processing_state_number = 2
        THEN sb.stock_booked
    END AS samples,
    /*----minus sample bookings----*/
    CASE 
        WHEN sb.stock_booking_code = 1 AND sb.supplier_id = 20     AND sb.stock_booking_processing_state_number = 2 AND sb.stock_booked> 0   
        THEN sb.stock_booked
    END AS samples_plus,
    /*----plus sample bookings----*/
    CASE 
        WHEN sb.stock_booking_code = 1 AND sb.supplier_id = 20     AND sb.stock_booking_processing_state_number = 2 AND sb.stock_booked< 0   
        THEN sb.stock_booked
    END AS samples_minus,
    /*----all Outlet Store bookings----*/
    CASE 
        WHEN sb.stock_booking_code = 3 AND sb.supplier_id IN (999992, 999998) AND sb.stock_booking_processing_state_number = 2 AND LOWER(sb.stock_booking_packing_slip_number) LIKE 'outlet%' 
        THEN sb.stock_booked
    END AS outlet_store_bookings   
    
FROM
	raw.stock_booked AS sb
	LEFT JOIN 
	bi.purchase_order po
        ON sb.purchase_order_id = po.purchase_order_id"	READY
240	2015-04-24 18:19:28	"638184966"	true	2015-04-24 18:19:28	meta.edges		"CREATE VIEW meta.edges AS
SELECT
edges_raw.child ""child"",
edges_raw.parent ""parent""
FROM
( SELECT DISTINCT
dependentResourceName AS ""child"",
parentResourceName AS ""parent""
FROM ""meta.schemas""
WHERE
( dependentResourceType = 'VIEW' OR dependentResourceType = 'TABLE' )
AND
( parentResourceType = 'VIEW' OR parentResourceType = 'TABLE' ) ) ""edges_raw""
INNER JOIN ""meta.nodes"" ON meta.nodes.node = edges_raw.child
INNER JOIN ""meta.nodes"" n2 ON n2.node = edges_raw.parent"	READY
241	2015-04-24 18:19:30	"638184967"	true	2015-04-24 18:19:30	am.pim_article__tariff_number_indexed		"CREATE VIEW ""am.pim_article__tariff_number_indexed"" AS
SELECT
pm.pim_model_id,
CAST(pim_article__count.count = 1 AS INTEGER) ""tariff_is_constant"",
pam.tariff_number
FROM
""am.pim_model"" pm
LEFT JOIN
( SELECT
pim_model_id,
COUNT(*) ""count""
FROM ""am.pim_article__tariff_number""
GROUP BY pim_model_id ) pim_article__count
ON pim_article__count.pim_model_id = pm.pim_model_id
LEFT JOIN ""am.pim_article__tariff_number"" pam ON pam.pim_model_id = pim_article__count.pim_model_id AND pim_article__count.count = 1"	READY
491,597	2015-08-11 10:53:35	"1146182548"	true	2015-08-11 10:53:35	tableau.mkt_attributed_channel_order_details		"CREATE VIEW tableau.mkt_attributed_channel_order_details
AS

SELECT
  	cast(co.date_incoming as date) as ""date"",
  	cu.default_domain as domain,
  	cu.customer_age,
  	co.box_type,
  	oa.marketing_channel,
    oa.marketing_subchannel,
    oa.source,
    oa.medium,
    oa.marketing_campaign,
  	SUM(oa.contact_weight) as incoming_first_orders,
  	SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 AND co.order_state_number < 2048 AND co.date_stylist_picked is not null THEN oa.contact_weight ELSE 0 END) as invoiced_first_orders,
 	SUM(oa.contact_weight*co.sales_sent) as sales_sent,
  	SUM(oa.contact_weight*co.sales_kept) as sales_kept,
  	SUM(oa.contact_weight*co.billing_net_sales) as billing_net_sales 
FROM bi.customer_order co
LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
WHERE co.date_incoming is not null
AND co.is_real_order = 'Real Order'
AND order_type = 'First Order'
GROUP BY 1,2,3,4,5,6,7,8,9"	READY
244	2015-04-24 18:19:32	"1112787734"	true	2015-04-24 18:19:32	bi.purchase_order_articles		"CREATE view bi.purchase_order_articles AS

WITH 
scan AS
( 
  SELECT
    purchase_order_id,
    article_ean,
    COUNT(*) stock_scanned,
    MIN(date_stock_delivered) 		AS date_stock_delivered_min,
    MAX(date_stock_delivered) 		AS date_stock_delivered_max,
    MIN(date_stock_scanned)  		AS date_stock_scanned_min,
    MAX(date_stock_scanned)  		AS date_stock_scanned_max,
    MIN(date_stock_handedover) 		AS date_stock_handedover_min,
    MAX(date_stock_handedover) 		AS date_stock_handedover_max,
    MIN(date_stock_uploaded) 		AS date_stock_uploaded_min,
    MAX(date_stock_uploaded) 		AS date_stock_uploaded_max,
	SUM(CASE WHEN scan_ean_unknown = 'ean unknown' 										THEN 1 END) AS stock_scanned_ean_unknown_articles,
	SUM(CASE WHEN scan_article_overdelivered = 'article overdelivered' 					THEN 1 END) AS stock_scanned_overdelivered_articles,
	SUM(CASE WHEN scan_photo_article = 'photo article selected' 						THEN 1 END) AS stock_scanned_photo_articles,
	SUM(CASE WHEN scan_clarification_case IN ('ean unknown', 'article overdelivered') 	THEN 1 END) AS stock_scanned_clarification_cases
  FROM
    raw.stock_scanned scan
  GROUP BY 1,2
),

bk AS 
(
  SELECT
    purchase_order_id,
    article_id,
    MIN(date_stock_booked) AS date_stock_booked_min,
    MAX(date_stock_booked) AS date_stock_booked_max,
    MIN(supplier_id) AS supplier_id, /* RARELY DUPLICATES */
    SUM(po_bookings) AS stock_booked
  FROM
    bi.stock_booked
  WHERE
  	po_bookings IS NOT NULL
  GROUP BY 1,2
),

au AS
(
  SELECT
    po AS purchase_order_id,
    ean AS article_ean,
    SUM(CAST(invoice_quantity AS INTEGER)) AS stock_invoiced,
    SUM(CAST(delivery_note_quantity_sup AS INTEGER)) AS stock_delivery_note_qty
    /*delivery_note AS poa_stock_delivery_note,
    CAST(delivery_note_quantity_sup AS integer) AS poa_delivery_note_quantity_supplier,
    invoice_number AS poa_invoice_number,
    CAST(parseTimestamp(accounting_date, 'yyyy-MM-dd HH:mm:ss.S') AS DATE) AS poa_date_accounting */
  FROM dwh.accountingupload
  WHERE po IS NOT NULL
  GROUP BY 1,2
),

sla AS
(
  SELECT purchase_order_id, article_id, 
  /* THERE ARE MANY ORDER THAT HAVE A SMALL NEGATIVE TIME, SO INCLUDING IN 1ST DAY */
  SUM(CASE WHEN stock_sla_hours_handover_to_booking >-1 AND stock_sla_hours_handover_to_booking <=24  THEN 1 ELSE 0 END) AS stock_sla_booked_1st_day,
  SUM(CASE WHEN stock_sla_hours_handover_to_booking >24 AND stock_sla_hours_handover_to_booking <=48  THEN 1 ELSE 0 END) AS stock_sla_booked_2nd_day,
  SUM(CASE WHEN stock_sla_hours_handover_to_booking >48 AND stock_sla_hours_handover_to_booking <=72  THEN 1 ELSE 0 END) AS stock_sla_booked_3rd_day,
  SUM(CASE WHEN stock_sla_hours_handover_to_booking >72                         					  THEN 1 ELSE 0 END) AS stock_sla_booked_after_3_days,
  ROUND(AVG(stock_sla_hours_handover_to_booking), 1) AS stock_sla_avg_hours_handover_to_booking
  FROM
  (
    SELECT 
      scan.purchase_order_id,
      scan.article_id,
      (CAST(TIMESTAMPDIFF(SQL_TSI_MINUTE, scan.date_stock_handedover, bk.date_stock_booked) AS DECIMAL) -
       CAST(TIMESTAMPDIFF(SQL_TSI_WEEK, scan.date_stock_handedover, bk.date_stock_booked) * 48*60 AS DECIMAL) ) /60
      AS stock_sla_hours_handover_to_booking
    FROM
    (
      SELECT
        ROW_NUMBER() OVER (PARTITION BY scan.purchase_order_id, scan.article_ean ORDER BY scan.date_stock_scanned ASC) AS rnum_scan,
        scan.purchase_order_id,
        a.article_id,
        scan.date_stock_handedover
      FROM raw.stock_scanned scan
      JOIN raw.article a ON scan.article_ean = a.article_ean
    ) AS scan 
    LEFT JOIN
    (
      SELECT 
        ROW_NUMBER() OVER (PARTITION BY purchase_order_id, article_id ORDER BY date_stock_booked ASC) AS rnum_sm,
        purchase_order_id,
        article_id,
        date_stock_booked
      FROM bi.stock_booked
      WHERE
  		po_bookings IS NOT NULL
    ) AS bk 
       ON bk.article_id       	= scan.article_id 
      AND bk.purchase_order_id  = scan.purchase_order_id 
      AND bk.rnum_sm        	= scan.rnum_scan
  ) z
  GROUP BY 1,2
),

dn AS
(
	SELECT
		purchase_order_id,
		article_ean,
		MAX(CASE WHEN rnum=1   THEN 	  stock_delivery_note    	  END) ||
		MAX(CASE WHEN rnum=2   THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=3   THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=4   THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=5   THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=6   THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=7   THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=8   THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=9   THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=10  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=11  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=12  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=13  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=14  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=15  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=16  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=17  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=18  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=19  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=20  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=21  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=22  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=23  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=24  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=25  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=26  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=27  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=28  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=29  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=30  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=31  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=32  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=33  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=34  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=35  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=36  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=37  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=38  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=39  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=40  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=41  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=42  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=43  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=44  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=45  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=46  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=47  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=48  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=49  THEN ', '||stock_delivery_note ELSE '' END) ||
		MAX(CASE WHEN rnum=50  THEN ', '||stock_delivery_note ELSE '' END)
		AS stock_delivery_notes
	FROM
	(
		SELECT 
		        ROW_NUMBER() OVER (PARTITION BY purchase_order_id, article_ean ORDER BY stock_delivery_note ASC) AS rnum,
		   		purchase_order_id,
				article_ean,
				stock_delivery_note
		FROM
			(
			SELECT DISTINCT
				purchase_order_id,
				article_ean,
				stock_delivery_note
			FROM
				raw.stock_scanned scan
			WHERE
				stock_delivery_note IS NOT NULL
			) z
	) zz
	GROUP BY 1,2
),

poa_dup AS
(
	SELECT 
	    purchase_order_id, 
	    article_id
	FROM 
	  raw.purchase_order_articles
	GROUP BY 1,2
	HAVING COUNT(*)>1
)  


/* MAIN BODY */

SELECT 
/* IDENTIFIERS */
  CASE
    WHEN poa.purchase_order_id  IS NOT NULL THEN 'poa'
    ELSE NULL
  END AS driving_tbl_poa,
  CASE
    WHEN scan.purchase_order_id IS NOT NULL THEN 'scan'
    ELSE NULL
  END AS driving_tbl_scan,
  poa.poa_id,
  CAST(COALESCE(poa.purchase_order_id, scan.purchase_order_id) AS LONG) AS purchase_order_id,
  poa.poa_position_number,
  poa.poa_supplier_order_number,
  poa.article_id,
  COALESCE(poa.article_ean, scan.article_ean) AS article_ean,
  poa.order_position_id,
  coa.order_id,
  poa.poa_state_number,

  /* DATA QUALITY CHECKS, STATUS IDENTIFIERS, ETC */
  /*
  CASE
    WHEN poa.poa_state_number = 2048                                                             							THEN 'poa cancelled'
    WHEN poa.poa_state_number = 4 AND poa.stock_fulfilled + COALESCE(scan.stock_scanned,0) + COALESCE(bk.stock_booked,0) =0 THEN 'poa created'
    WHEN poa.poa_state_number = 8 AND poa.stock_fulfilled + COALESCE(scan.stock_scanned,0) + COALESCE(bk.stock_booked,0) =0 THEN 'poa issued to supplier'
    WHEN 						 	  poa.stock_fulfilled + COALESCE(scan.stock_scanned,0) + COALESCE(bk.stock_booked,0) >0 THEN 'poa stock received'
    ELSE 'Ask BI'
  END AS poa_state,
  */
  CASE
    WHEN poa.poa_state_number = 2048 		THEN 'cancelled'
    WHEN poa.stock_ordered_revised =0    	THEN 'revised qty 0'
    WHEN poa.poa_state_number = 4 AND COALESCE(scan.stock_scanned,0) + COALESCE(bk.stock_booked,0) =0 THEN 'created'
    WHEN poa.poa_state_number = 8 AND COALESCE(scan.stock_scanned,0) + COALESCE(bk.stock_booked,0) =0 THEN 'waiting on supplier'
    WHEN COALESCE(bk.stock_booked, scan.stock_scanned) - poa.stock_ordered_revised < 0 THEN 'under filled'
    WHEN COALESCE(bk.stock_booked, scan.stock_scanned) - poa.stock_ordered_revised > 0 THEN 'over filled'
    WHEN COALESCE(bk.stock_booked, scan.stock_scanned) - poa.stock_ordered_revised = 0 THEN 'correctly filled'
    WHEN poa.purchase_order_id IS NULL AND scan.purchase_order_id IS NOT NULL THEN 'scan without matching poa'
  END AS poa_status,
  CASE
    WHEN poa_dup.article_id IS NOT NULL THEN 'duplicate article id' 
    ELSE NULL
  END AS poa_duplicate_articles,
  /*
  CASE
    WHEN scan.article_ean IS NULL AND bk.stock_bookings IS NULL THEN 'no scan or booking'
    WHEN scan.article_ean IS NULL 								THEN 'no scan'
    WHEN bk.stock_bookings IS NULL 								THEN 'no booking'
    ELSE ''
  END AS poa_booking_check,
  */   
  CASE
    WHEN scan.stock_scanned = 0             		THEN -poa.stock_fulfilled
    WHEN scan.stock_scanned >= au.stock_invoiced 	THEN scan.stock_scanned - cn.stock_credit_note_qty - poa.stock_fulfilled
    WHEN scan.stock_scanned <  au.stock_invoiced 	THEN scan.stock_scanned - poa.stock_fulfilled
    ELSE NULL
  END AS stock_booking_control,
  scan.stock_scanned_ean_unknown_articles,
  scan.stock_scanned_overdelivered_articles,
  scan.stock_scanned_photo_articles,
  scan.stock_scanned_clarification_cases,

/* QUANTITIES */
  poa.stock_ordered_initially,
  poa.stock_ordered_revised,
  /* poa.stock_fulfilled, */
  scan.stock_scanned,
  COALESCE(poa.stock_fulfilled, bk.stock_booked) AS stock_booked,
  sla.stock_sla_booked_1st_day,
  sla.stock_sla_booked_2nd_day,
  sla.stock_sla_booked_3rd_day,
  sla.stock_sla_booked_after_3_days,
  sla.stock_sla_avg_hours_handover_to_booking,
  au.stock_invoiced,
  au.stock_delivery_note_qty,
  cn.stock_credit_note_qty,

/* DATES */
  poa.date_poa_created,
  poa.date_poa_cancelled,
  poa.date_poa_fulfilled,
  poa.date_poa_updated,
  poa.date_poa_delivery_earliest,
  poa.date_poa_delivery_latest,
  scan.date_stock_delivered_min,
  scan.date_stock_delivered_max,
  scan.date_stock_scanned_min,
  scan.date_stock_scanned_max,
  scan.date_stock_handedover_min,
  scan.date_stock_handedover_max,
  scan.date_stock_uploaded_min,
  scan.date_stock_uploaded_max,
  bk.date_stock_booked_min,
  bk.date_stock_booked_max,
  CASE 
    WHEN CAST(scan.date_stock_delivered_max AS DATE) < CAST(poa.date_poa_delivery_earliest AS DATE) AND CAST(scan.date_stock_delivered_max AS DATE) < CAST(poa.date_poa_delivery_latest AS DATE) THEN 'early'
    WHEN CAST(scan.date_stock_delivered_max AS DATE) > CAST(poa.date_poa_delivery_earliest AS DATE) AND CAST(scan.date_stock_delivered_max AS DATE) < CAST(poa.date_poa_delivery_latest AS DATE) THEN 'on time'
    WHEN CAST(scan.date_stock_delivered_max AS DATE) > CAST(poa.date_poa_delivery_earliest AS DATE) AND CAST(scan.date_stock_delivered_max AS DATE) > CAST(poa.date_poa_delivery_latest AS DATE) THEN 'late'
    ELSE NULL
  END AS delivery_performance,
  
/* VARIOUS ARTICLE INFO */
  poa.article_sales_price,
  poa.article_cost,
  dn.stock_delivery_notes
  
FROM
  raw.purchase_order_articles poa
  FULL JOIN
  scan
     ON poa.article_ean     	= scan.article_ean
    AND poa.purchase_order_id 	= scan.purchase_order_id
  LEFT JOIN
  bi.customer_order_articles coa
     ON coa.order_position_id 	= poa.order_position_id
  LEFT JOIN
  sla
     ON poa.article_id      	= sla.article_id
    AND poa.purchase_order_id   = sla.purchase_order_id
  LEFT JOIN
  bk
     ON poa.article_id      	= bk.article_id
    AND poa.purchase_order_id   = bk.purchase_order_id    
  LEFT JOIN
  au
     ON poa.purchase_order_id 	= au.purchase_order_id
    AND poa.article_ean     	= au.article_ean
  LEFT JOIN
  raw.stock_credit_note AS cn
     ON poa.purchase_order_id 	= cn.purchase_order_id
    AND poa.article_ean     	= cn.article_ean  
  LEFT JOIN
  dn
     ON scan.article_ean     	= dn.article_ean
    AND scan.purchase_order_id 	= dn.purchase_order_id
  LEFT JOIN
  poa_dup 
     ON poa.purchase_order_id   = poa_dup.purchase_order_id 
    AND poa.article_id      	= poa_dup.article_id"	READY
131,100	2015-05-20 16:34:44	"1228867702"	true	2015-08-28 17:28:22	tableau.snowplow_sanity_check		"CREATE VIEW tableau.snowplow_sanity_check
AS
SELECT
	ca.""date"",
	im.imported_rows,
	ga.ga_visits,
	sp.sp_visits			
FROM dwh.calendar ca
LEFT JOIN
(
	SELECT 
		CAST(etl_tstamp as date) AS ""date"",
		COUNT(event_id) as imported_rows
	FROM snowplow.events
	GROUP BY 1
) im on ca.""date"" = im.""date""
LEFT JOIN
(
	SELECT
		date_created,
		SUM(visits) as ga_visits
	FROM dwh.ga_visits
	WHERE country != 'ALL'
	GROUP BY 1
) ga ON ga.date_created = ca.""date""
LEFT JOIN
(
	SELECT
		CAST(MODIFYTIMEZONE(collector_tstamp,'GMT','GMT-2') as date) as date_created,
		COUNT(DISTINCT (domain_userid || domain_sessionidx)) as sp_visits
	FROM raw.snowplow_events 
	GROUP BY 1
) sp ON sp.date_created = ca.""date""
WHERE ca.""date"" < CURDATE()
AND ca.""date"" >= '2015-04-01'"	READY
249	2015-04-24 18:19:34	"1330319964"	true	2015-09-18 17:44:18	bi.customer_order		"CREATE view bi.customer_order
as

WITH rev AS
( 
  /* At this top-level we apply forecast return rates to estimate revenue for non-completed orders */ 
  SELECT 
    x.order_id, 
 
    /* If all articles on an order are cancelled, then set the order_state as 'Cancelled' */ 
    CASE WHEN x.article_cancellation_state = 1 THEN null ELSE x.revenue_state END as revenue_state, 
    CASE  
      WHEN x.revenue_state = 'Final' AND x.articles_sent = x.articles_kept THEN 'All Kept' 
      WHEN x.revenue_state = 'Final' AND x.articles_sent = x.articles_returned THEN 'All Returned' 
      WHEN x.revenue_state = 'Estimated' THEN 'Open' 
      WHEN x.revenue_state = 'Final' AND x.articles_returned > 0 THEN 'Returned' 
      ELSE null 
    END as kept_state, 

    CASE  
      WHEN x.article_cancellation_state = 1 THEN 'Cancelled'  
      WHEN x.revenue_state is null THEN 'Cancelled' 
      ELSE null  
    END as order_state, 

    CASE  
      WHEN x.article_cancellation_state = 1 THEN 2048  
      WHEN x.revenue_state is null THEN 2048 
      ELSE null  
    END as order_state_number,

    x.exchange_rate, 
    x.articles_picked, 
    x.articles_sent, 
    CASE WHEN x.revenue_state = 'Final' THEN COALESCE(x.articles_kept, 0) ELSE x.articles_kept END as articles_kept, 
    CASE WHEN x.revenue_state = 'Final' THEN COALESCE(x.articles_returned, 0) ELSE x.articles_returned END as articles_returned, 
    x.sales_picked, 
    x.sales_sent, 
    /* If the order is finalised, then simply take the current state. Otherwise use the forecast return rate to calculated kept & returned 
       NOTE: once we have good billing information, we can build that into this logic, but for now it's commented out. 
     */ 
    CASE 
      WHEN x.revenue_state = 'Final' then x.sales_sent - COALESCE(x.sales_returned, 0)
      ELSE x.sales_kept_est 
    END AS sales_kept,
    CASE 
      WHEN x.revenue_state = 'Final' then x.sales_returned
      ELSE x.sales_returned_est
    END AS sales_returned,

    x.cost_picked, 
    x.cost_sent, 
    CASE 
      WHEN x.revenue_state = 'Final' then x.cost_kept
      ELSE x.cost_kept_est 
    END AS cost_kept,
    CASE 
      WHEN x.revenue_state = 'Final' then x.cost_returned
      ELSE x.cost_returned_est
    END AS cost_returned,

    x.own_stock_articles_sent,

    CASE WHEN x.revenue_state = 'Final' AND x.own_stock_articles_sent > 0 THEN COALESCE(x.own_stock_articles_kept, 0) ELSE x.own_stock_articles_kept END as own_stock_articles_kept, 
    
    CASE WHEN x.revenue_state = 'Final' AND x.own_stock_articles_sent > 0 THEN COALESCE(x.own_stock_articles_returned, 0) ELSE x.own_stock_articles_returned END as own_stock_articles_returned, 
    
    COALESCE(x.own_stock_sales_sent,x.own_stock_sales_picked) as own_stock_sales_sent, 

    x.own_stock_sales_kept_est as own_stock_sales_kept,
    
    CASE WHEN x.revenue_state = 'Final' AND x.own_stock_sales_sent > 0 
      THEN COALESCE(x.own_stock_sales_returned, 0)  
      ELSE x.own_stock_sales_returned_est
    END as own_stock_sales_returned, 
    
    COALESCE(x.own_stock_cost_sent,x.own_stock_cost_picked) as own_stock_cost_sent, 
    
    CASE WHEN x.revenue_state = 'Final' THEN x.own_stock_cost_kept
      ELSE x.own_stock_cost_kept_est 
    END as own_stock_cost_kept, 
    
    CASE WHEN x.revenue_state = 'Final' AND x.own_stock_cost_sent > 0 
      THEN COALESCE(x.own_stock_cost_returned, 0)  
      ELSE x.own_stock_cost_returned_est
    END as own_stock_cost_returned,
    x.partner_articles_sent,
    
    CASE WHEN x.revenue_state = 'Final' AND x.partner_articles_sent > 0 THEN COALESCE(x.partner_articles_kept, 0) ELSE x.partner_articles_kept END as partner_articles_kept, 
    
    CASE WHEN x.revenue_state = 'Final' AND x.partner_articles_sent > 0 THEN COALESCE(x.partner_articles_returned, 0) ELSE x.partner_articles_returned END as partner_articles_returned, 
    
    COALESCE(x.partner_sales_sent,x.partner_sales_picked) as partner_sales_sent, 
    
    CASE WHEN x.revenue_state = 'Final' THEN x.partner_sales_sent - COALESCE(x.partner_sales_returned, 0)
      else x.partner_stock_sales_kept_est 
    end as partner_sales_kept, 
    
    CASE WHEN x.revenue_state = 'Final' AND x.partner_sales_sent > 0 
      THEN COALESCE(x.partner_sales_returned, 0) 
      ELSE x.partner_stock_sales_returned_est 
    END as partner_sales_returned, 
    
    COALESCE(x.partner_cost_sent,x.partner_cost_picked) as partner_cost_sent, 
    
    CASE WHEN x.revenue_state = 'Final' THEN x.partner_cost_kept
      ELSE x.partner_stock_cost_kept_est 
    END as partner_cost_kept, 
    
    CASE WHEN x.revenue_state = 'Final' AND x.partner_cost_sent > 0 
      THEN COALESCE(x.partner_cost_returned, 0) 
      ELSE x.partner_stock_cost_returned_est 
    END as partner_cost_returned,

    CASE 
      WHEN x.revenue_state = 'Final' then x.own_stock_sales_sent_wo_ph - COALESCE(x.own_stock_sales_returned_wo_ph, 0)
      ELSE x.own_stock_sales_kept_wo_ph_est
    END as own_stock_sales_kept_wo_ph,

    CASE 
      WHEN x.revenue_state = 'Final' then x.own_stock_cost_kept_wo_ph
    ELSE x.own_stock_cost_kept_wo_ph_est 
    end as own_stock_cost_kept_wo_ph, 

    CASE 
      WHEN x.revenue_state = 'Final' then x.paul_hunter_sales_sent - COALESCE(x.paul_hunter_sales_returned, 0)
      ELSE x.paul_hunter_sales_kept_est 
    end as paul_hunter_sales_kept, 

    CASE 
      WHEN x.revenue_state = 'Final' then x.paul_hunter_cost_kept
      ELSE x.paul_hunter_cost_kept_est 
    END as paul_hunter_cost_kept, 
    
    x.discount_total, 
    x.discount_goodwill, 
    x.discount_marketing, 
    x.discount_paid_voucher, 
    x.billing_received, 
    x.date_paid
  FROM  
  ( 
    SELECT  
    /* Use the customer_order_articles subquery as the base, but we need to add a few things in from customer_order here */ 
      coa.*,  
      co.order_state, 
      co.order_state_number,
      co.sales_channel,
      cu.phone_number,
      co.date_preview_created,
      
    /* Calculate the revenue state. If Estimated, then we will create a forecasted revenue */ 
      CASE  
        WHEN co.order_state = 'Completed'  
          AND co.date_returned is null  
          AND NOT COALESCE(co.billing_received_in_local_currency, arv.billing_received_arvato,0) > 1  
          AND co.date_invoiced > TIMESTAMPADD(SQL_TSI_DAY, -70, CURDATE()) 
          THEN 'Estimated' 
        WHEN co.order_state in ('Returned', 'Completed') THEN 'Final' 
        WHEN co.order_state = 'Cancelled' THEN null 
        WHEN co.order_state_number < 512 AND TIMESTAMPDIFF(SQL_TSI_DAY, co.date_invoiced, CURDATE()) > 100 THEN null 
        ELSE 'Estimated' 
      END as revenue_state,   
 
    /* Apply exchange rates where needed */ 
      CAST(e.exchange_rate as decimal) as exchange_rate, 
      co.discount_total_in_local_currency/e.exchange_rate as discount_total, 
      co.discount_goodwill_in_local_currency/e.exchange_rate as discount_goodwill, 
      co.discount_marketing_in_local_currency/e.exchange_rate as discount_marketing, 
      co.discount_paid_voucher_in_local_currency/e.exchange_rate as discount_paid_voucher, 
      COALESCE(co.billing_received_in_local_currency, arv.billing_received_arvato)/e.exchange_rate as billing_received, 
      COALESCE(co.date_paid, arv.date_arvato_paid) as date_paid 
 
    FROM raw.customer_order co 
    LEFT JOIN raw.customer cu on cu.customer_id = co.customer_id 
    LEFT JOIN dwh.historical_exchange_rates e on e.currency_code = co.currency_code AND cast(co.date_invoiced as date) = e.date 
    LEFT JOIN  
    ( 
      SELECT  
        ordernumber as order_id, 
        MIN(date_created) as date_arvato_paid, 
        SUM(amount) as billing_received_arvato 
      FROM dwh.arvato_payments ap 
      GROUP BY 1 
    ) arv on arv.order_id = co.order_id 
    JOIN  
    ( 
      /* Calculate base numbers from articles. NOTE that lost is included with returned. */ 
      SELECT 
        coa.order_id, 
        MIN(CASE WHEN coa.order_article_state != 'Cancelled' THEN 0 ELSE 1 END) as article_cancellation_state, 
        SUM(coa.articles_picked) as articles_picked, 
        SUM(coa.articles_sent) as articles_sent, 
        SUM(coa.articles_kept) as articles_kept, 
        SUM(CASE WHEN coa.articles_returned is null AND coa.articles_lost is null THEN null ELSE COALESCE(coa.articles_returned, 0) + COALESCE(coa.articles_lost, 0) END) as articles_returned, 
        SUM(coa.sales_picked) as sales_picked, 
        SUM(coa.sales_sent) as sales_sent, 

        SUM(coa.sales_kept) as sales_kept, 
        SUM(CASE WHEN coa.sales_returned is null AND coa.sales_lost is null THEN null ELSE COALESCE(coa.sales_returned, 0) + COALESCE(coa.sales_lost, 0) END) as sales_returned, 

        /*Estimation KPI's-Sales*/
        SUM(sales_returned_est) AS sales_returned_est,
        SUM(sales_kept_est) AS sales_kept_est,
        SUM(cost_returned_est) AS cost_returned_est,
        SUM(cost_kept_est) AS cost_kept_est,
        
        SUM(CASE WHEN coa.stock_location_id = 2 THEN coa.sales_kept_est ELSE 0 END) AS own_stock_sales_kept_est,
        SUM(CASE WHEN coa.stock_location_id = 2 THEN coa.cost_kept_est ELSE 0 END) AS own_stock_cost_kept_est,
        SUM(CASE WHEN coa.stock_location_id = 2 THEN COALESCE(coa.sales_returned_est, 0) ELSE 0 END) AS own_stock_sales_returned_est,
        SUM(CASE WHEN coa.stock_location_id = 2 THEN COALESCE(coa.cost_returned_est, 0) ELSE 0 END) AS own_stock_cost_returned_est,

        SUM(CASE WHEN coa.stock_location_id != 2 THEN coa.sales_kept_est ELSE 0 END) AS partner_stock_sales_kept_est,
        SUM(CASE WHEN coa.stock_location_id != 2 THEN coa.cost_kept_est ELSE 0 END) AS partner_stock_cost_kept_est,
        SUM(CASE WHEN coa.stock_location_id != 2 THEN COALESCE(coa.sales_returned_est, 0) ELSE 0 END) AS partner_stock_sales_returned_est,
        SUM(CASE WHEN coa.stock_location_id != 2 THEN COALESCE(coa.cost_returned_est, 0) ELSE 0 END) AS partner_stock_cost_returned_est,

        /*Estimation-New KPI's for Own Stock (Withoud Paul Hunter) and Paul Hunter*/
        SUM(CASE WHEN coa.stock_location_id = 2 and brand<>'PAUL HUNTER' THEN coa.sales_kept_est ELSE 0 END) AS own_stock_sales_kept_wo_ph_est,
        SUM(CASE WHEN coa.stock_location_id = 2 and brand<>'PAUL HUNTER' THEN coa.cost_kept_est ELSE 0 END) AS own_stock_cost_kept_wo_ph_est,

        SUM(CASE WHEN brand='PAUL HUNTER' THEN coa.sales_kept_est ELSE 0 END) AS paul_hunter_sales_kept_est,
        SUM(CASE WHEN brand='PAUL HUNTER' THEN coa.cost_kept_est ELSE 0 END) AS paul_hunter_cost_kept_est,

        /*Cost*/
        SUM(coa.cost_picked) as cost_picked, 
        SUM(coa.cost_sent) as cost_sent,
        SUM(coa.cost_kept) as cost_kept,
        SUM(CASE WHEN coa.cost_returned is null AND coa.cost_lost is null THEN null ELSE COALESCE(coa.cost_returned, 0) + COALESCE(coa.cost_lost, 0) END) as cost_returned, 
        
        SUM(CASE WHEN coa.stock_location_id = 2 THEN coa.articles_sent ELSE null END) as own_stock_articles_sent, 
        SUM(CASE WHEN coa.stock_location_id != 2 THEN coa.articles_sent ELSE null END) as partner_articles_sent, 
        
        SUM(CASE WHEN coa.stock_location_id = 2 THEN CASE WHEN coa.articles_returned is null AND coa.articles_lost is null THEN null ELSE COALESCE(coa.articles_returned, 0) + COALESCE(coa.articles_lost, 0) END ELSE null END) as own_stock_articles_returned, 
        SUM(CASE WHEN coa.stock_location_id != 2 THEN CASE WHEN coa.articles_returned is null AND coa.articles_lost is null THEN null ELSE COALESCE(coa.articles_returned, 0) + COALESCE(coa.articles_lost, 0) END ELSE null END) as partner_articles_returned, 
        
        SUM(CASE WHEN coa.stock_location_id = 2 THEN coa.articles_kept ELSE null END) as own_stock_articles_kept, 
        SUM(CASE WHEN coa.stock_location_id != 2 THEN coa.articles_kept ELSE null END) as partner_articles_kept, 
        
        SUM(CASE WHEN coa.stock_location_id = 2 THEN coa.sales_picked ELSE null END) as own_stock_sales_picked, 
        SUM(CASE WHEN coa.stock_location_id != 2 THEN coa.sales_picked ELSE null END) as partner_sales_picked, 
        
        SUM(CASE WHEN coa.stock_location_id = 2 THEN coa.sales_sent ELSE null END) as own_stock_sales_sent,
        SUM(CASE WHEN coa.stock_location_id != 2 THEN coa.sales_sent ELSE null END) as partner_sales_sent,
        SUM(CASE WHEN coa.stock_location_id = 2 and brand<>'PAUL HUNTER' THEN coa.sales_sent ELSE null END) as own_stock_sales_sent_wo_ph,
        SUM(CASE WHEN brand='PAUL HUNTER' THEN coa.sales_sent ELSE null END) as paul_hunter_sales_sent,
        
        SUM(CASE WHEN coa.stock_location_id = 2 THEN CASE WHEN coa.sales_returned is null AND coa.sales_lost is null THEN null ELSE COALESCE(coa.sales_returned, 0) + COALESCE(coa.sales_lost, 0) END ELSE null END) as own_stock_sales_returned, 
        SUM(CASE WHEN coa.stock_location_id != 2 THEN CASE WHEN coa.sales_returned is null AND coa.sales_lost is null THEN null ELSE COALESCE(coa.sales_returned, 0) + COALESCE(coa.sales_lost, 0) END ELSE null END) as partner_sales_returned, 
        SUM(CASE WHEN coa.stock_location_id = 2 and brand<>'PAUL HUNTER' THEN CASE WHEN coa.sales_returned is null AND coa.sales_lost is null THEN null ELSE COALESCE(coa.sales_returned, 0) + COALESCE(coa.sales_lost, 0) END ELSE null END) as own_stock_sales_returned_wo_ph, 
        SUM(CASE WHEN brand='PAUL HUNTER' THEN CASE WHEN coa.sales_returned is null AND coa.sales_lost is null THEN null ELSE COALESCE(coa.sales_returned, 0) + COALESCE(coa.sales_lost, 0) END ELSE null END) as paul_hunter_sales_returned, 
        

        SUM(CASE WHEN coa.stock_location_id = 2 THEN coa.sales_kept ELSE null END) as own_stock_sales_kept, 
        SUM(CASE WHEN coa.stock_location_id != 2 THEN coa.sales_kept ELSE null END) as partner_sales_kept, 
        SUM(CASE WHEN coa.stock_location_id = 2 and brand<>'PAUL HUNTER' THEN coa.sales_kept ELSE null END) as own_stock_sales_kept_wo_ph,
        SUM(CASE WHEN brand='PAUL HUNTER' THEN coa.sales_kept ELSE null END) as paul_hunter_sales_kept, 

        SUM(CASE WHEN coa.stock_location_id = 2 THEN coa.cost_picked ELSE null END) as own_stock_cost_picked, 
        SUM(CASE WHEN coa.stock_location_id != 2 THEN coa.cost_picked ELSE null END) as partner_cost_picked,        
        SUM(CASE WHEN coa.stock_location_id = 2 THEN coa.cost_sent ELSE null END) as own_stock_cost_sent, 
        SUM(CASE WHEN coa.stock_location_id != 2 THEN coa.cost_sent ELSE null END) as partner_cost_sent, 
        SUM(CASE WHEN coa.stock_location_id = 2 and brand<>'PAUL HUNTER' THEN coa.cost_sent ELSE null END) as own_stock_cost_sent_wo_ph,
        SUM(CASE WHEN brand='PAUL HUNTER' THEN coa.cost_sent ELSE null END) as paul_hunter_cost_sent, 
        
        SUM(CASE WHEN coa.stock_location_id = 2 THEN CASE WHEN coa.cost_returned is null AND coa.cost_lost is null THEN null ELSE COALESCE(coa.cost_returned, 0) + COALESCE(coa.cost_lost, 0) END ELSE null END) as own_stock_cost_returned, 
        SUM(CASE WHEN coa.stock_location_id != 2 THEN CASE WHEN coa.cost_returned is null AND coa.cost_lost is null THEN null ELSE COALESCE(coa.cost_returned, 0) + COALESCE(coa.cost_lost, 0) END ELSE null END) as partner_cost_returned,         
        SUM(CASE WHEN coa.stock_location_id = 2 and brand<>'PAUL HUNTER' THEN CASE WHEN coa.cost_returned is null AND coa.cost_lost is null THEN null ELSE COALESCE(coa.cost_returned, 0) + COALESCE(coa.cost_lost, 0) END ELSE null END) as own_stock_cost_returned_wo_ph, 
        SUM(CASE WHEN brand='PAUL HUNTER' THEN CASE WHEN coa.cost_returned is null AND coa.cost_lost is null THEN null ELSE COALESCE(coa.cost_returned, 0) + COALESCE(coa.cost_lost, 0) END ELSE null END) as paul_hunter_cost_returned, 

        SUM(CASE WHEN coa.stock_location_id = 2 THEN coa.cost_kept ELSE null END) as own_stock_cost_kept,
        SUM(CASE WHEN coa.stock_location_id = 2 and brand<>'PAUL HUNTER' THEN coa.cost_kept ELSE null END) as own_stock_cost_kept_wo_ph,
        SUM(CASE WHEN coa.stock_location_id != 2 THEN coa.cost_kept ELSE null END) as partner_cost_kept,
        SUM(CASE WHEN brand='PAUL HUNTER' THEN coa.cost_kept ELSE null END) as paul_hunter_cost_kept
      FROM bi.customer_order_articles coa  
      GROUP BY coa.order_id
    ) coa on coa.order_id = co.order_id 
    WHERE co.order_state_number >= 16 AND co.order_state_number < 2048  /* There should be no revenue estimations for Cancelled or not-yet-sent orders */ 
  ) x 
) 
 
SELECT 
  co.order_id, 
  co.parent_order_id, 
  co.customer_id, 
  co.preview_id, 
  co.customer_preview_id, 
  co.campaign_id, 
  co.stylist_id, 
  co.invoice_number, 
  co.sales_channel, 
  cos.saleschannel_special as sales_channel_special, 
/* The definition of 'Call Box' is that the order has had a valid phone date OR that it comes from the sales_channel = 'clubWithCall'.  
   The inclusion of clubWithCall is due to these orders being automatically generated by a script. It doesn't create phone dates, but these orders must be called.  
*/  
  CASE  
    WHEN co.date_phone_call > '2012-05-10'  
      AND co.date_phone_call < TIMESTAMPADD(SQL_TSI_MONTH, 2, curdate())  
      AND co.date_phone_call >= co.date_created 
      THEN 'Call Box' 
    WHEN cod.original_phone_date > '2012-05-10'  
      AND cod.original_phone_date < TIMESTAMPADD(SQL_TSI_MONTH, 2, curdate())  
      AND cod.original_phone_date >= co.date_created 
      THEN 'Call Box'  
    WHEN co.sales_channel = 'clubWithCall' THEN 'Call Box' 
    ELSE 'No Call Box' 
  END as box_type, 
  co.order_type, 
  co.order_type_completed, 
 
/* When sales_channel = 'website' then it's highly likely to not be a 'real order'. In such cases we set the state to 'Initiated'. */   
  CASE WHEN co.sales_channel = 'website' AND co.order_state ='Incoming' AND NOT (co.date_preview_created is not null OR cu.phone_number is not null) THEN 'Initiated' ELSE COALESCE(rev.order_state, co.order_state) END as order_state, 
  CASE WHEN co.sales_channel = 'website' AND co.order_state ='Incoming' AND NOT (co.date_preview_created is not null OR cu.phone_number is not null) THEN 4 ELSE COALESCE(rev.order_state_number, co.order_state_number) END as order_state_number, 
  rev.revenue_state,
  rev.kept_state,
  CASE
    WHEN cos.salesforce_order_stage = 'Datum vorschlagen' THEN 'Suggest date'
    WHEN cos.salesforce_order_stage in ('Artikel bestellen', 'order articles') THEN 'Order articles'
    WHEN cos.salesforce_order_stage in ('Feedback zur Bestellung einholen', 'get feedback') THEN 'Get feedback'
    WHEN cos.salesforce_order_stage in ('Termin ausmachen', 'arrange a date') THEN 'Arrange a date'
    WHEN cos.salesforce_order_stage in ('Inaktiv', 'inactive') THEN 'Inactive'
    WHEN cos.salesforce_order_stage = 'on hold' THEN 'On hold'
    WHEN cos.salesforce_order_stage in ('Packen', 'packing') THEN 'Packing'
    WHEN cos.salesforce_order_stage in ('Informationen vervollstndigen', 'complete information') THEN 'Complete information' 
    WHEN cos.salesforce_order_stage in ('abgeschloen & Nachbereitung', 'completed & postprocessing') THEN 'Completed & Follow-up'
    WHEN cos.salesforce_order_stage = 'Vorschau erstellen' THEN 'Create preview'
    WHEN cos.salesforce_order_stage is null THEN 'Order not synced'
    ELSE 'Ask BI' 
  END as order_sales_stage, 
 
/* The definitions of the different customer types is within the view raw.customer */   
  CASE  
    WHEN cu.user_type = 'Test User' THEN 'Test Order' 
    WHEN cu.user_type = 'Outfittery Showroom' THEN 'Outfittery Order' 
    WHEN cu.user_type = 'Real User' THEN 'Real Order' 
    ELSE 'Ask BI' 
  END as is_real_order, 
  co.payment_type, 
  co.payment_state, 
  co.cancellation_reason,
 
/* If the order is or has ever been set to 'Pre-pay' as its payment method, then set this to 1 */   
  CASE  
    WHEN co.payment_type = 'Pre-pay' THEN 1 
    WHEN cod.pre_pay is not null THEN cod.pre_pay  
    ELSE 0 
  END as pre_pay, 
  fr.arvato_result, 
  ft.arvato_score, 
  co.sales_maximum_type, 
  co.sales_maximum_in_local_currency/rev.exchange_rate as sales_maximum, 
  cos.ops_check, 
  cos.debt_collection_set as given_to_debt_collection, 
 
  co.currency_code, 
  v.vat_rate*100 as vat_percentage, 
  rev.exchange_rate, 
 
/* Discount data */ 
  co.discount_type, 
  rev.discount_total, 
  rev.discount_goodwill, 
  rev.discount_marketing, 
  rev.discount_paid_voucher, 
 
/* Top-level Revenue */   
  rev.articles_picked, 
  rev.articles_sent, 
  rev.articles_kept, 
  rev.articles_returned, 
  rev.sales_picked, 
  rev.sales_sent, 
  rev.sales_kept,  
  rev.sales_returned, 
  CASE  
    WHEN rev.sales_kept - rev.discount_total < 0 THEN 0 
    ELSE rev.sales_kept - rev.discount_total 
  END as billing_total, 
  rev.billing_received,  
  CASE  
    WHEN rev.sales_kept - rev.discount_total < 0 THEN 0 
    ELSE rev.sales_kept - rev.discount_total 
  END - rev.billing_received as billing_open, 
  CASE  
    WHEN rev.sales_kept - rev.discount_total < 0 THEN 0 
    ELSE rev.sales_kept - rev.discount_total 
  END * (v.vat_rate/(1 + v.vat_rate)) as billing_vat, 
  CASE  
    WHEN rev.sales_kept - rev.discount_total < 0 THEN 0 
    ELSE rev.sales_kept - rev.discount_total 
  END / (1 + v.vat_rate) as billing_net_sales, 
  rev.cost_picked, 
  rev.cost_sent, 
  rev.cost_returned, 
  rev.cost_kept, 
 
/* Own stock numbers */ 
  rev.own_stock_articles_sent, 
  rev.own_stock_articles_returned, 
  rev.own_stock_articles_kept, 
  rev.own_stock_sales_sent, 
  rev.own_stock_sales_returned, 
  rev.own_stock_sales_kept, 
  rev.own_stock_cost_sent, 
  rev.own_stock_cost_returned, 
  rev.own_stock_cost_kept, 
 
/* Partner stock numbers */ 
  rev.partner_articles_sent, 
  rev.partner_articles_returned, 
  rev.partner_articles_kept, 
  rev.partner_sales_sent, 
  rev.partner_sales_returned, 
  rev.partner_sales_kept, 
  rev.partner_cost_sent, 
  rev.partner_cost_returned, 
  rev.partner_cost_kept, 
 
  rev.own_stock_sales_kept_wo_ph,
  rev.own_stock_cost_kept_wo_ph,
  rev.paul_hunter_sales_kept,
  rev.paul_hunter_cost_kept,
 
/* Dates */  
  co.date_created, 
  co.date_preview_created, 
 
  CASE
  /* Orders with sales_channel = 'website' and websiteWithoutDateAndPendingConfirmation are not real orders, hence exclude date_created should be set to null */ 
    WHEN (co.sales_channel = 'website' AND co.order_state in ('Incoming', 'Cancelled') AND NOT (co.date_preview_created is not null OR cu.phone_number is not   null))
    OR (co.sales_channel = 'websiteWithoutDateAndPendingConfirmation' and co.date_stylist_picked is not null) THEN null
    WHEN co.sales_channel = 'website' AND co.date_preview_created > co.date_created THEN co.date_preview_created
    WHEN CAST(co.date_created as date)<'2015-07-21' THEN COALESCE(cod.date_incoming, co.date_created)
    /*Because of task manager job all old orders in state 4 is changed to 8*/
    WHEN CAST(co.date_created as date)>='2015-07-21' THEN co.date_created
  END date_incoming,
  
  COALESCE(cod.date_cancelled,co.date_cancelled) as date_cancelled,  /* Data from audit_log is more complete than customer_order */ 
  cod.date_prepay_to_credit_card,  
  CASE  
    WHEN co.date_phone_call > '2012-05-10'  
      AND co.date_phone_call < TIMESTAMPADD(SQL_TSI_MONTH, 2, curdate())  
      AND co.date_phone_call >= co.date_created 
      THEN co.date_phone_call  
    WHEN cod.original_phone_date > '2012-05-10'  
      AND cod.original_phone_date < TIMESTAMPADD(SQL_TSI_MONTH, 2, curdate())  
      AND cod.original_phone_date >= co.date_created 
      THEN cod.original_phone_date  
    ELSE null 
  END as date_phone_call, 
  CASE  
    WHEN co.date_phone_call > '2012-05-10'  
      AND co.date_phone_call < TIMESTAMPADD(SQL_TSI_MONTH, 2, curdate())  
      AND co.date_phone_call >= co.date_created 
      THEN co.date_phone_call 
    ELSE null 
  END as date_phone_call_current, 
  CASE 
    WHEN cod.original_phone_date > '2012-05-10'  
      AND cod.original_phone_date < TIMESTAMPADD(SQL_TSI_MONTH, 2, curdate())  
      AND cod.original_phone_date >= co.date_created 
      THEN cod.original_phone_date  
    ELSE null 
  END as date_phone_call_original, 
  cos.date_next_contact, 
  co.date_stylist_picked, 
  cod.date_arvato_accepted, 
  co.date_submitted, 
  co.date_invoiced,
  COALESCE(dd.date_shipped, co.date_shipped_internal) as date_shipped, 
  co.date_shipped_internal, 
  co.date_return_reminder, 
  co.date_returned_online,
  co.date_return_registration,
  COALESCE(cod.date_returned,co.date_returned) as date_returned,
  CASE
    WHEN CAST(co.date_shipped_internal as date)<'2015-07-15' THEN COALESCE(cod.date_completed,co.date_completed) 
    /*this case statment corrects the date_completed for arvato customers (starting from 15th july) if the customer has date_returned then date_completed is 
    date_retuend if it date_returned is null then it adds 21 days to date_shipped*/
    WHEN CAST(co.date_shipped_internal as date)>='2015-07-15' AND co.date_returned IS NOT NULL THEN  COALESCE(cod.date_returned,co.date_returned)
    WHEN CAST(co.date_shipped_internal as date)>='2015-07-15' AND co.date_returned IS NULL
    AND CAST(TIMESTAMPADD(SQL_TSI_DAY,21,co.date_shipped_internal) AS DATE)<CURDATE() THEN TIMESTAMPADD(SQL_TSI_DAY,21,co.date_shipped_internal)
  END AS date_completed,
  co.date_first_reminder, 
  co.date_first_warning,
  co.date_second_warning,
  co.date_third_warning, 
  co.date_given_to_debt_collection,  
  rev.date_paid, 
  nps.date_submitted as date_nps_submitted,
  /*date return registration is set for physical Return registration
   when customer returns the box at postoffice and status in aftership changes to InTransit*/
  CASE 
  WHEN cod.date_returned_online IS NOT NULL AND date_return_registration IS NOT NULL THEN 'Y'
  ELSE 'N'
  END AS aftership_return_confirmation,
  /* Address details */  
  /*If shipping address is same billing address then it is set 'Y',
  column from postgres is wrong*/
  CASE
  WHEN  
    shipping_first_name=billing_first_name
    AND shipping_last_name=billing_last_name
    AND shipping_street=billing_street
    AND shipping_street_number=billing_street_number
    AND shipping_zip=billing_zip
    AND shipping_city=billing_city
    AND shipping_co=billing_co
  THEN 'Y'
  ELSE 'N'
  END AS shipping_address_meets_billing_address,
  co.shipping_city,
  co.shipping_country, 
  co.shipping_street, 
  co.shipping_street_number, 
  co.shipping_zip, 
  co.shipping_first_name, 
  co.shipping_last_name, 
  co.shipping_co, 
  co.billing_city, 
  co.billing_country, 
  co.billing_street, 
  co.billing_street_number, 
  co.billing_zip, 
  co.billing_first_name, 
  co.billing_last_name, 
  co.billing_co, 
 
/* Position of the order within the customer's order history */    
  co.all_order_count, 
  co.real_order_count, 
  co.follow_on_count, 
  co.all_order_count_completed,  
  co.real_order_count_completed, 
   
  co.customer_message_content, 
  cos.inactive_reasons, 
  cos.not_reached, 
  cos.wrong_phone_number, 
  cos.call_cancelled, 
  cos.call_confirmed, 
  cos.new_phone_appointment, 
  cos.calender_full as calendar_full,
  nps.nps_score,
  nps.customer_comment as nps_customer_comment
  
FROM raw.customer_order co 
LEFT JOIN raw.customer cu on cu.customer_id = co.customer_id 
LEFT JOIN rev on rev.order_id = co.order_id 
LEFT JOIN raw.customer_order_salesforce cos on cos.order_id = co.order_id 
LEFT JOIN raw.customer_order_details__audit_log cod on cod.order_id = co.order_id 
LEFT JOIN dwh.calendar c on c.date = cast(co.date_invoiced as date) 
LEFT JOIN dwh.vat_rates v on v.year_month = c.year_month AND co.shipping_country = v.country_code_iso
LEFT JOIN dwh.nps_score nps on nps.order_id=co.order_id
LEFT JOIN  
(
  SELECT 
    ss.order_id, 
    parsedate(min(ss.shipping_date), 'yyyyMMdd') as date_shipped 
  FROM raw.stock_shipped ss
  GROUP BY 1
) dd on dd.order_id = co.order_id 
LEFT JOIN  
( 
  SELECT  
    f.order_id, 
    f.arvato_score, 
    row_number() OVER (PARTITION BY f.order_id ORDER BY f.date_created DESC) as rnum 
  FROM raw.financial_transactions f 
  WHERE f.arvato_score is not null 
) ft on ft.order_id = co.order_id AND ft.rnum = 1 
LEFT JOIN  
( 
  SELECT  
    f.order_id, 
    f.arvato_result, 
    row_number() OVER (PARTITION BY f.order_id ORDER BY f.date_created DESC) as rnum 
  FROM raw.financial_transactions f 
  WHERE f.arvato_result is not null 
  AND f.arvato_result != 'ERROR' 
) fr on fr.order_id = co.order_id AND fr.rnum = 1"	READY
325	2015-04-24 18:20:50	"1112787804"	true	2015-04-24 18:20:50	tableau.ops_999998_bookings		"CREATE view tableau.ops_999998_bookings
as 
select
sm.article_id,
a.article_ean,
sm.date_stock_booked,
sm.stock_booked,
sm.stock_booking_packing_slip_number,
min(a.article_sales_price_de) as article_sales_price_de,
min(a.article_cost) as article_cost
FROM bi.stock_booked sm
join bi.article a
on a.article_id = sm.article_id
WHERE supplier_id = '999998'
group by 1,2,3,4,5"	READY
326	2015-04-24 18:20:51	"1112787805"	true	2015-04-24 18:20:51	tableau.ops_inbound_SLA_dates		"CREATE view tableau.ops_inbound_SLA_dates
as 
select
    scan.rnum_scan,
    scan.article_ean as ean,
    scan.photo_article,
    scan.overdelivered, 
    scan.hanging,
    scan.article_id,
    scan.date_stock_delivered as date_delivered,
    scan.date_stock_uploaded as date_uploaded,
    scan.date_stock_scanned as date_scanned,
    scan.date_stock_handedover as date_given_to_serviceprovi,
    scan.purchase_order_id as po,
    sm.rnum_sm, 
    pim.brand,
    sm.date_stock_booked as date_created
FROM 
(
    SELECT 
        row_number() over (partition by sc.purchase_order_id, sc.article_ean order by date_stock_scanned asc) AS ""rnum_scan"",
        sc.purchase_order_id, 
        sc.article_ean, 
        CASE 
            WHEN sc.scan_photo_article = 'JA' then 1 
            ELSE 0 
        end AS photo_article,
        CASE 
            WHEN sc.scan_article_overdelivered = 'JA' then 1 
            ELSE 0 
        end AS overdelivered,
        CASE 
            WHEN sc.scan_garment = 'JA' then 1 
            ELSE 0 
        end AS hanging, 
        sc.date_stock_delivered,
        sc.date_stock_uploaded,
        sc.date_stock_scanned,
        sc.date_stock_handedover,
        poa.article_id
    FROM raw.stock_scanned sc
    INNER JOIN bi.purchase_order_articles poa ON poa.article_ean = sc.article_ean and sc.purchase_order_id = poa.purchase_order_id
    WHERE CAST(sc.date_stock_delivered AS date) > '2014-08-13'
) AS scan 
LEFT JOIN
(
    SELECT 
        row_number() over (partition by purchase_order_id, article_id order by date_stock_booked asc) AS ""rnum_sm"",
        purchase_order_id,
        article_id,
        date_stock_booked 
    FROM bi.stock_booked
    WHERE purchase_order_id <> '' and CAST(date_stock_booked AS date) > '2014-08-13'
) AS sm ON sm.article_id = scan.article_id and sm.purchase_order_id = scan.purchase_order_id and scan.rnum_scan = sm.rnum_sm
LEFT JOIN 
(
    SELECT 
        ean,
        brand 
    FROM raw.article_detail_pim
) AS pim ON pim.ean = scan.article_ean"	READY
327	2015-04-24 18:20:51	"1112787806"	true	2015-04-24 18:20:51	tableau.ops_inbound_SLA_quantities		"CREATE view tableau.ops_inbound_SLA_quantities
as 
SELECT 
  cast(poa.date_poa_created AS date) AS purchase_order_date_created, 
  poa.purchase_order_id, 
  poa.article_ean as ean, 
  poa.article_id,
  poa.stock_ordered_revised AS updated_quantity,
  poa.stock_ordered_initially as initial_quantity, 
  poa.stock_booked as fulfilled_quantity, 
  poa.date_stock_handedover_max as max_date_given_to_serviceprovider,
  poa.stock_scanned as count_scans,
  poa.stock_scanned_ean_unknown_articles as count_ean_unknown,
  poa.stock_scanned_photo_articles as count_photo_article,
  poa.stock_scanned_overdelivered_articles as count_overdelivered,
  sm.supplier_id as supplier_code,
  sm.max_booking_date,
  sm.booking_count
FROM bi.purchase_order_articles poa
LEFT JOIN 
(
  SELECT
      purchase_order_id, 
      article_id,
      supplier_id,
      MAX(date_stock_booked) AS max_booking_date,
      sum(stock_booked) as booking_count
    FROM bi.stock_booked 
    WHERE purchase_order_id <> '' AND supplier_id <> '10'
    GROUP BY 1,2,3
) AS sm
on sm.purchase_order_id = poa.purchase_order_id AND sm.article_id = poa.article_id
WHERE cast(poa.date_poa_created AS date) > '2014-04-01'
and driving_tbl_poa IS NOT NULL"	READY
196,687	2015-06-18 16:27:12	"901272448"	true	2015-06-18 16:27:12	raw.nav_purchase_order		"CREATE VIEW raw.nav_purchase_order AS
/* 	""nav_test.Outfittery GmbH$Purch_ Rcpt_ Header"" h; for active POs */

WITH initial AS
(
SELECT
	h.""document type"",
	h.""no_"",
	h.""doc_ no_ occurrence"",
	h.""Document Date"",
	h.""Order Date"",
	h.""Buy-from Vendor Name"",
	h.""Buy-from Vendor No_"",
	h.""Due Date""
FROM
	/* active purchase order */
	/* document type 0 = quote; 1 = order; 2 = manual invoice; 3 = credit note; 4 = blanket order; 5 = return po */
	""nav_test.Outfittery GmbH$Purchase Header Archive"" h
WHERE h.""version no_"" = 1
),

revised AS
( /* not sure revised header info is needed */
SELECT
/* document no_ = purchase_order_id */
	max_version.""document type"", max_version.""no_"", max_version.""doc_ no_ occurrence"", max_version.""version no_"", h.""Due Date""
	/*, h.""Document Date"", h.""Order Date"" */
FROM
	/* active purchase order */
	/* document type 0 = quote; 1 = order; 2 = manual invoice; 3 = credit note; 4 = blanket order; 5 = return po */
	(SELECT
		""document type"", ""no_"", ""doc_ no_ occurrence"", MAX(""version no_"") ""version no_""
	FROM
		""nav_test.Outfittery GmbH$Purchase Header Archive""
	GROUP BY 1,2,3
	) max_version
	INNER JOIN
	""nav_test.Outfittery GmbH$Purchase Header Archive"" h
 		 ON h.""document type"" = max_version.""document type""
		AND h.no_ = max_version.no_
		AND	h.""doc_ no_ occurrence"" = max_version.""doc_ no_ occurrence""
		AND h.""version no_"" = max_version.""version no_""
),

received AS
(
SELECT
/* ""order no_"" = purchase_order_id */
	h.""order no_"",
	MIN(h.""posting date"") date_received_min,
	MAX(h.""posting date"") date_received_max
FROM
	""nav_test.Outfittery GmbH$Purch_ Rcpt_ Header"" h
GROUP BY 1
),

invoiced AS
(
SELECT
/* ""order no_"" = purchase_order_id */
	h.""order no_"",
	MIN(h.""posting date"") date_invoiced_min,
	MAX(h.""posting date"") date_invoiced_max
FROM
	""nav_test.Outfittery GmbH$Purch_ Inv_ Header"" h
GROUP BY 1
),

returned AS
(
SELECT
/* ""order no_"" = purchase_order_id */
	h.""return order no_"",
	MIN(h.""posting date"") date_returned_min,
	MAX(h.""posting date"") date_returned_max
FROM
	""nav_test.Outfittery GmbH$return shipment Header"" h
GROUP BY 1
),

credit AS
(
SELECT
/* ""order no_"" = purchase_order_id */
	h.""return order no_"",
	MIN(h.""posting date"") date_credit_min,
	MAX(h.""posting date"") date_credit_max
FROM
	""nav_test.Outfittery GmbH$Purch_ cr_ memo Hdr_"" h
GROUP BY 1
)




/* MAIN BODY */

SELECT
	initial.""no_"" AS order_no,
	/* is the following correct: ? */
	initial.""Document Date"" AS document_date,
	initial.""Order Date"" AS order_date,
	initial.""Buy-from Vendor No_"" AS vendor_no,
	initial.""Buy-from Vendor Name"" AS vendor_name,
	initial.""Due Date"" AS date_due_initial,
	revised.""Due Date"" AS date_due_revised,
	received.date_received_min,
	received.date_received_max,	
	invoiced.date_invoiced_min,
	invoiced.date_invoiced_max,
	returned.date_returned_min,
	returned.date_returned_max,	
	credit.date_credit_min,
	credit.date_credit_max
	/*
	date fulfilled
	date cancelled
	date due
	date updated
	*/
FROM
	initial
	LEFT JOIN
	revised
		 ON initial.""document type"" 		= revised.""document type""
		AND initial.""no_""					= revised.""no_""
		AND initial.""doc_ no_ occurrence"" 	= revised.""doc_ no_ occurrence""
	LEFT JOIN
	received
		 ON initial.""no_""					= received.""order no_""
	LEFT JOIN
	invoiced
		 ON initial.""no_""					= invoiced.""order no_""
	LEFT JOIN
	returned
		 ON initial.""no_""					= returned.""return order no_""
	LEFT JOIN
	credit
		 ON initial.""no_""					= credit.""return order no_""		
	
	
/* possible good stuff in ""nav_test.Outfittery GmbH$Vendor"" 
""nav_test.Outfittery TEST$Country_Region"" */
		
/*
SELECT
	""document type"" , ""no_""
FROM
	active purchase order
	""nav_test.Outfittery GmbH$Purchase Header"" h

just link the two above to the archive header

*/"	READY
258	2015-04-24 18:19:37	"1112787745"	true	2015-04-24 18:19:37	tableau.logistics_overview		"CREATE view tableau.logistics_overview
AS
SELECT 
distinct co.id as order_id, 
co.country, 
co.date_picked, 
ddsoir.order_on_error, 
ddsoh.transmitted_pending_shipment, 
bo.backorder_orderid, 
bo.picklist_created_pending_shipment, 
ddsc.packed_order, 
ddms.shipped_order, 
st.awaiting_stylist_pick,
ddr.returned_order
from  
( 
  SELECT 
  co.id,
  co.state,
  co.date_picked,
  co.shipping_address_id,
  ad.country
  from
  (select 
    id,
    state,
    cast((case when date_picked is null then current_date else date_picked end) as date)as ""date_picked"",
    shipping_address_id
    FROM postgres.customer_order
    where cast(date_created as date) > '2014-01-01'
    and cast(date_picked as date) > timestampadd(sql_tsi_month,-2,curdate())
    and state < 1536
  ) co
  left join 
  (
    SELECT
    order_id as canceled_order,
    state_agg
    FROM (select
          order_id,
            sum(state)/sum(quantity) as state_agg
            FROM postgres.order_position
            group by 1
          ) op 
    where state_agg = 2048
    ) op
  on op.canceled_order = co.id
  inner join 
  (
    SELECT 
    id, 
    country 
    FROM postgres.address
  ) ad 
  on ad.id = co.shipping_address_id
  where op.canceled_order is null
) co
left join 
/* ----order status---- */
(
    SELECT
  sosc.orderid,
  case when message<> 'PICKLIST CREATED' then sosc.orderid  else null end as backorder_orderid,
  case when message = 'PICKLIST CREATED' then sosc.orderid  else null end as picklist_created_pending_shipment
  FROM
  (
   SELECT 
    row_number() over (partition by a.orderid order by a.date_created desc) as rnum, 
    a.orderid, 
    a.message 
    from postgres.doc_data_sales_order_status_change a
    left join (SELECT orderid from postgres.doc_data_shipment_confirmation) b on a.orderid = b.orderid
    where b.orderid is null
  ) sosc
  where rnum = 1 
) bo  on bo.orderid = co.id
left join
/* ----all orders on error: these errors appear in the message field in the sales order import result and usually require some type of action---- */
(
  SELECT 
  ddsoir.orderid as order_on_error 
  FROM 
  (
    SELECT 
    orderid, 
    message from postgres.doc_data_sales_order_import_result group by 1,2
  ) ddsoir 
  left join 
  (
    SELECT 
    orderid from postgres.doc_data_sales_order_status_change
  ) ddsosc 
  on ddsosc.orderid = ddsoir.orderid 
  where ddsosc.orderid is null 
  and message <> ''
) ddsoir
on ddsoir.order_on_error = co.id
left join 
/* ----all orders that have been transmitted to doc data (verified by the receipt of the sales order header) and have made it to the picklist creation (which happens at 7am and 2pm)---- */
(
  SELECT 
  a.orderid as transmitted_pending_shipment
  FROM 
  (
    SELECT 
    ddsoh.orderid from postgres.doc_data_sales_order_header ddsoh 
    left join 
    (
      SELECT 
      orderid from postgres.doc_data_sales_order_status_change
    ) ddsosc on ddsosc.orderid = ddsoh.orderid
    where ddsosc.orderid is null
    group by 1
  ) a
) ddsoh
on ddsoh.transmitted_pending_shipment = co.id
left join 
/* ----all orders that have been added to the shipment confirmation, i.e. all items have been pulled for packing (packing takes about 10 minutes), but are not on the shipment manifest (transmitted 1x per day at 22:30)---- */
(
  SELECT 
  ddsc.orderid as packed_order 
  FROM postgres.doc_data_shipment_confirmation ddsc 
  left join postgres.doc_data_manifest_shipping ddms 
  on ddsc.orderid = ddms.orderid 
  where ddms.orderid is null
  group by 1
) ddsc
on ddsc.packed_order = co.id
left join 
/* ----all orders on the shipment manifest---- */
(
  SELECT 
  orderid as shipped_order, 
  cast(shipping_date as date) as shipping_date from postgres.doc_data_manifest_shipping
) ddms
on ddms.shipped_order = co.id
left join
/* ----all orders awaiting to be picked---- */
(
SELECT 
 co.id AS awaiting_stylist_pick, 
 co.stylelist_id AS stylist_id,
 current_date AS date_picked
FROM postgres.customer_order co
 	JOIN 
 	bi.customer_order_salesforce sfo 
		ON sfo.order_id = co.id
 	LEFT JOIN 
 	bi.stylist st
 		 ON co.stylelist_id = st.stylist_id
 		AND st.stylist NOT IN ('Eve Rosenthal','Doreen Jansen','Ria Herzog','Lea Maler','Katrin Svensson','Nicole Eden','Lisa Fuchs','Mandy Brunnecker')
WHERE 
	sfo.ops_check = 'OK' 
AND sfo.salesforce_order_stage = 'Artikel bestellen'
AND co.state < 128
) st 
on st.awaiting_stylist_pick = co.id
left join
/* ----all orders that have been returned---- */
(select
ddr.original_orderid as returned_order
FROM postgres.doc_data_return ddr
) ddr
on ddr.returned_order = co.id"	READY
328	2015-04-24 18:20:52	"1112787807"	true	2015-06-12 11:05:57	tableau.ops_999997_bookings		"CREATE view tableau.ops_999997_bookings
as 
select
sm.article_id,
a.article_ean,
sm.date_stock_booked,
sm.stock_booked,
sm.supplier_id,
sm.stock_booking_packing_slip_number,
min(a.article_sales_price_de) as article_sales_price_de,
min(a.article_cost) as article_cost
FROM bi.stock_booked sm
join bi.article a
on a.article_id = sm.article_id
WHERE supplier_id = '999997' 
/* or supplier_id = '999987' 
or supplier_id = '25' */
group by 1,2,3,4,5,6"	READY
329	2015-04-24 18:20:52	"1112787808"	true	2015-04-24 18:20:52	tableau.ops_return_file		"CREATE view tableau.ops_return_file
AS
SELECT 
    r.original_orderid,
	r.outfittery_article_number,
	a.article_ean,
	r.date_created as return_date,
	cast(r.number_of_articles_return as integer) as number_of_articles_return,
	ad.country
FROM postgres.doc_data_return r
JOIN postgres.customer_order co on co.id=r.original_orderid
JOIN postgres.address ad on ad.id=co.shipping_address_id
JOIN bi.article a on a.article_id = r.outfittery_article_number"	READY
688,131	2015-09-08 17:32:03	"1283793519"	true	2015-09-08 17:40:48	raw.desk_user_case_details		"CREATE VIEW raw.desk_user_case_details
AS
SELECT 
	vv.""name"" as ""user_name"", 
	vv.""email"" as ""user_email"",	
	drc.""id"" as ""case_id"", 
	drc.""priority"" as ""case_priority"",
	drc.""label_ids"" as ""label_ids"",
	drc.""changed_at"", drc.""created_at"", drc.""updated_at"", drc.""first_opened_at"",
	drc.""opened_at"",drc.""first_resolved_at"",drc.""resolved_at"", drc.""status"",
	drc.""has_pending_interactions"", drc.""description"",
	drc.""type"",drc.""labels"",drc.""subject"", drc.""customer_href"", drc.""replies_count"", drc.""notes_count""
from ""dwh.desk_raw_cases"" drc LEFT OUTER JOIN
(
	call ""desk_com_connector.get_list_users"" ()
) vv ON drc.userid=vv.id
where drc.userid <> 0;"	READY
491,596	2015-08-10 19:36:37	"1209197723"	true	2015-08-24 16:07:57	tableau.finance_arvato_acceptance		"CREATE VIEW tableau.finance_arvato_acceptance
AS

SELECT
  cal.""date"",
  cal.country,
  cal.order_type,
  COALESCE(co_1.nb_orders,0) AS nb_orders,
  COALESCE(co_1.nb_orders_green_dark,0) AS nb_orders_green_dark,
  COALESCE(co_1.nb_orders_address_issues,0) AS nb_orders_address_issues,
  COALESCE(co_1.nb_orders_green_dark_2,0) AS nb_orders_green_dark_2,
  COALESCE(arv_1.nb_orders_red_dark,0) AS nb_orders_red_dark
FROM
(
  SELECT 
    ""date"",
    a.default_domain as country,
    b.order_type 
  FROM ""dwh.calendar"" 
  CROSS JOIN (SELECT DISTINCT default_domain FROM bi.customer)a
  CROSS JOIN (SELECT DISTINCT order_type FROM bi.customer_order)b
)cal
LEFT JOIN
(
  SELECT
    CAST(co.date_created AS DATE) AS date_created,
    co.shipping_country,
    co.order_type,
       COUNT(DISTINCT CASE WHEN arv.arvatoresult_1 IS NOT NULL THEN co.order_id ELSE NULL END) as nb_orders,
    COUNT(DISTINCT CASE WHEN arv.arvatoresult_1 IS NOT NULL AND arv.arvatoresult_1='GREEN_DARK' THEN co.order_id ELSE NULL END) as nb_orders_green_dark,
    COUNT(DISTINCT CASE WHEN arv.arvatoresult_1 IS NOT NULL AND arv.arvatoresult_1<>'GREEN_DARK' AND arv.arvatoresult_2='GREEN_DARK' THEN co.order_id ELSE NULL END) as nb_orders_green_dark_2,
    COUNT(DISTINCT CASE WHEN arv.responseCode_1 IN ('AVD100','AVD101','AVD998','AVD999') THEN co.order_id ELSE NULL END) as nb_orders_address_issues
  FROM bi.customer_order co
  LEFT JOIN ""raw.arvato_first_address_risk_check"" arv on arv.order_id=co.order_id
  GROUP BY 1,2,3
)co_1 on co_1.date_created=cal.""date"" and co_1.shipping_country=cal.country and co_1.order_type=cal.order_type
/*Orders with RED DARK*/
LEFT JOIN
(
  SELECT
    cast(a1.arv_date_created as date) as date_created,
    a1.default_domain as country,
    a1.order_type,
    COUNT(DISTINCT order_id) as nb_orders_red_dark
  FROM raw.arvato_first_address_risk_check a1
  WHERE arvatoresult_1='RED_DARK'
  GROUP BY 1,2,3
)arv_1 on arv_1.date_created=cal.""date"" and arv_1.country=cal.country and arv_1.order_type=cal.order_type
WHERE ""date""<=TIMESTAMPADD(SQL_TSI_DAY,-1,curdate())"	READY
688,129	2015-09-08 11:06:30	"1283793688"	true	2015-09-08 18:45:11	sandbox.marketing_untracked_attribution		"CREATE VIEW sandbox.marketing_untracked_attribution
AS

SELECT
	ca.""date"",
	ca.reporting_type,
	ca.domain,
	ca.marketing_channel,


	SUM(
		CASE 
		WHEN COALESCE(ab.incoming_orders_not_untracked, 0) = 0 AND COALESCE(ab.incoming_orders_untracked, 0) != 0 THEN mo.monthly_incoming_first_orders_share * ab.incoming_orders_untracked
		WHEN COALESCE(ab.incoming_orders_not_untracked, 0) = 0 THEN 0
		WHEN ab.incoming_orders_untracked is null THEN at.incoming_orders
		ELSE at.incoming_orders + (at.incoming_orders / ab.incoming_orders_not_untracked) * ab.incoming_orders_untracked
	END) AS incoming_orders_adjusted,

	SUM(
		CASE 
		WHEN COALESCE(ab.invoiced_orders_not_untracked, 0) = 0 AND COALESCE(ab.invoiced_orders_untracked, 0) != 0 THEN mo.monthly_invoiced_first_orders_share * ab.invoiced_orders_untracked
		WHEN COALESCE(ab.invoiced_orders_not_untracked, 0) = 0 THEN 0
		WHEN ab.invoiced_orders_untracked is null THEN at.invoiced_orders
		ELSE at.invoiced_orders + (at.invoiced_orders / ab.invoiced_orders_not_untracked) * ab.invoiced_orders_untracked
	END) AS invoiced_orders_adjusted,
	
	SUM(
		CASE 
		WHEN COALESCE(ab.sales_kept_not_untracked, 0) = 0 AND COALESCE(ab.sales_kept_untracked, 0) != 0 THEN mo.monthly_sales_kept_share * ab.sales_kept_untracked
		WHEN COALESCE(ab.sales_kept_not_untracked, 0) = 0 THEN 0
		WHEN ab.sales_kept_untracked is null THEN at.sales_kept
		ELSE at.sales_kept + (at.sales_kept / ab.sales_kept_not_untracked) * ab.sales_kept_untracked
	END) AS sales_kept_adjusted,

	SUM(
		CASE 
		WHEN COALESCE(ab.sales_sent_not_untracked, 0) = 0 AND COALESCE(ab.sales_sent_untracked, 0) != 0 THEN mo.monthly_sales_sent_share * ab.sales_sent_untracked
		WHEN COALESCE(ab.sales_sent_not_untracked, 0) = 0 THEN 0
		WHEN ab.sales_sent_untracked is null THEN at.sales_sent
		ELSE at.sales_sent + (at.sales_sent / ab.sales_sent_not_untracked) * ab.sales_sent_untracked
	END) AS sales_sent_adjusted,

	SUM(
		CASE 
		WHEN COALESCE(ab.billing_total_not_untracked, 0) = 0 AND COALESCE(ab.billing_total_untracked, 0) != 0 THEN mo.monthly_billing_total_share * ab.billing_total_untracked
		WHEN COALESCE(ab.billing_total_not_untracked, 0) = 0 THEN 0
		WHEN ab.billing_total_untracked is null THEN at.billing_total
		ELSE at.billing_total + (at.billing_total / ab.billing_total_not_untracked) * ab.billing_total_untracked
	END) AS billing_total_adjusted,

	SUM(
		CASE 
		WHEN COALESCE(ab.billing_net_sales_not_untracked, 0) = 0 AND COALESCE(ab.billing_net_sales_untracked, 0) != 0 THEN mo.monthly_billing_net_sales_share * ab.billing_net_sales_untracked
		WHEN COALESCE(ab.billing_net_sales_not_untracked, 0) = 0 THEN 0
		WHEN ab.billing_net_sales_untracked is null THEN at.billing_net_sales
		ELSE at.billing_net_sales + (at.billing_net_sales / ab.billing_net_sales_not_untracked) * ab.billing_net_sales_untracked
	END) AS billing_net_sales_adjusted

FROM
(
SELECT
		rt.reporting_type,
	 	c.date,
	 	c.year_month,
	 	x.domain,
	 	x.marketing_channel
  	FROM dwh.calendar c 
  	CROSS JOIN (SELECT domain, marketing_channel FROM bi.marketing_order_attribution_aggregated GROUP BY 1,2) x
  	CROSS JOIN (SELECT 'date_incoming' as reporting_type UNION SELECT 'date_invoiced' as reporting_type) rt
  	WHERE c.date > '2012'
  	AND c.date < CURDATE()
) ca

/* These are the tracked orders and will serve as the starting point for the calculation  */ 
LEFT JOIN
(
	SELECT
		ag.reporting_type,
		ag.""date"",
		ag.domain,
		ag.marketing_channel,
		SUM(incoming_first_orders) as incoming_orders,
		SUM(invoiced_first_orders) as invoiced_orders,
		SUM(sales_sent) as sales_sent,
		SUM(sales_kept) as sales_kept,
		SUM(billing_total) as billing_total,
		SUM(billing_net_sales) as billing_net_sales
	FROM bi.marketing_order_attribution_aggregated ag
	WHERE marketing_channel != 'Untracked'
	GROUP BY 1,2,3,4
) at ON ca.date = at.date AND ca.domain = at.domain AND ca.reporting_type = at.reporting_type AND at.marketing_channel = ca.marketing_channel


/* daily totals for calculation */
LEFT JOIN
(
	SELECT
		ag.reporting_type,
		ag.""date"",
		ag.domain,
		SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN incoming_first_orders ELSE null END) as incoming_orders_untracked,
		SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN invoiced_first_orders ELSE null END) as invoiced_orders_untracked,
		SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN incoming_first_orders ELSE null END) as incoming_orders_not_untracked,
		SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN invoiced_first_orders ELSE null END) as invoiced_orders_not_untracked,
		SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN sales_kept ELSE null END) as sales_kept_untracked,
		SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN sales_kept ELSE null END) as sales_kept_not_untracked,
		SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN sales_sent ELSE null END) as sales_sent_untracked,
		SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN sales_sent ELSE null END) as sales_sent_not_untracked,
		SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN billing_total ELSE null END) as billing_total_untracked,
		SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN billing_total ELSE null END) as billing_total_not_untracked,
		SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN billing_net_sales ELSE null END) as billing_net_sales_untracked,
		SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN billing_net_sales ELSE null END) as billing_net_sales_not_untracked
	FROM 
	(
		SELECT 
			reporting_type,
			""date"",
			domain,
			marketing_channel,
			SUM(incoming_first_orders) as incoming_first_orders,
			SUM(invoiced_first_orders) as invoiced_first_orders,
			SUM(sales_sent) as sales_sent,
			SUM(sales_kept) as sales_kept,
			SUM(billing_net_sales) as billing_net_sales,
			SUM(billing_total) as billing_total
		FROM bi.marketing_order_attribution_aggregated
		GROUP BY 1,2,3,4
	) ag
	LEFT JOIN dwh.marketing_investor_reporting_brand_factors mi ON mi.marketing_channel = ag.marketing_channel AND mi.domain = ag.domain
	GROUP BY 1,2,3
) ab ON ca.date = ab.date AND ca.domain = ab.domain AND ca.reporting_type = ab.reporting_type

LEFT JOIN
(
/* When there are only untracked orders on a certain day, these orders can't be distributed by daily share and will be distributed by monthly share */
	SELECT
		mc.reporting_type,
		mc.year_month,
		mc.domain,
		mc.marketing_channel,
		CASE WHEN COALESCE(mt.invoiced_first_orders_monthly, 0) = 0 THEN 0 ELSE mc.invoiced_first_orders_monthly / mt.invoiced_first_orders_monthly END as monthly_invoiced_first_orders_share,
		CASE WHEN COALESCE(mt.incoming_first_orders_monthly, 0) = 0 THEN 0 ELSE mc.incoming_first_orders_monthly / mt.incoming_first_orders_monthly END as monthly_incoming_first_orders_share,
		CASE WHEN COALESCE(mt.sales_sent_monthly, 0) = 0 THEN 0 ELSE mc.sales_sent_monthly / mt.sales_sent_monthly END as monthly_sales_sent_share,
		CASE WHEN COALESCE(mt.sales_kept_monthly, 0) = 0 THEN 0 ELSE mc.sales_kept_monthly / mt.sales_kept_monthly END as monthly_sales_kept_share,
		CASE WHEN COALESCE(mt.billing_net_sales_monthly, 0) = 0 THEN 0 ELSE mc.billing_net_sales_monthly / mt.billing_net_sales_monthly END as monthly_billing_net_sales_share,
		CASE WHEN COALESCE(mt.billing_total_monthly, 0) = 0 THEN 0 ELSE  mc.billing_total_monthly / mt.billing_total_monthly END as monthly_billing_total_share
	FROM
	(
		SELECT 
			reporting_type,
			c.year_month,
			domain,
			marketing_channel,
			SUM(incoming_first_orders) as incoming_first_orders_monthly,
			SUM(invoiced_first_orders) as invoiced_first_orders_monthly,
			SUM(sales_sent) as sales_sent_monthly,
			SUM(sales_kept) as sales_kept_monthly,
			SUM(billing_net_sales) as billing_net_sales_monthly,
			SUM(billing_total) as billing_total_monthly
		FROM bi.marketing_order_attribution_aggregated ag
		LEFT JOIN dwh.calendar c ON c.""date"" = ag.""date""
		WHERE marketing_channel != 'Untracked'
		GROUP BY 1,2,3,4
	) mc
	LEFT JOIN
	(
		SELECT 
			reporting_type,
			c.year_month,
			domain,
			SUM(incoming_first_orders) as incoming_first_orders_monthly,
			SUM(invoiced_first_orders) as invoiced_first_orders_monthly,
			SUM(sales_sent) as sales_sent_monthly,
			SUM(sales_kept) as sales_kept_monthly,
			SUM(billing_net_sales) as billing_net_sales_monthly,
			SUM(billing_total) as billing_total_monthly
		FROM bi.marketing_order_attribution_aggregated ag
		LEFT JOIN dwh.calendar c ON c.""date"" = ag.""date""
		WHERE marketing_channel != 'Untracked'
		GROUP BY 1,2,3
	) mt ON mt.reporting_type = mc.reporting_type AND mt.year_month = mc.year_month AND mt.domain = mc.domain
) mo ON mo.reporting_type = ca.reporting_type AND mo.year_month = ca.year_month AND mo.domain = ca.domain AND mo.marketing_channel = ca.marketing_channel
GROUP BY 1,2,3,4"	READY
262	2015-04-24 18:19:38	"1112787750"	true	2015-04-24 18:19:38	raw.awaiting_stylist_pick		"CREATE VIEW raw.awaiting_stylist_pick AS

SELECT DISTINCT
 co.id AS order_id, 
 co.stylelist_id AS stylist_id,
 current_date AS date_awaiting_stylist_pick
FROM 
	postgres.customer_order co
 	JOIN 
 	bi.customer_order_salesforce sfo 
		ON sfo.order_id = co.id
 	LEFT JOIN 
 	bi.stylist st
 		 ON co.stylelist_id = st.stylist_id
 		AND st.stylist NOT IN ('Eve Rosenthal','Doreen Jansen','Ria Herzog','Lea Maler','Katrin Svensson','Nicole Eden','Lisa Fuchs','Mandy Brunnecker')
WHERE 
	sfo.ops_check = 'OK' 
AND sfo.salesforce_order_stage = 'Artikel bestellen'
AND co.state < 16
/* 128 */"	READY
387	2015-04-24 18:24:12	"1283793629"	true	2015-09-08 18:13:11	tableau.management_management_report_main		"CREATE view tableau.management_management_report_main
as

SELECT
  a.date,
  a.country,
  a.revenue_state,
  a.order_type,
  a.working_days,
  inc.orders_incoming,
  inv.orders_invoiced,
  inc.orders_incoming_repeat,
  prc.orders_processed,
  inv.sales_sent,
  inv.sales_kept,
  inv.sales_returned,
  inv.billing_total,
  inv.billing_net_sales,
  inv.cost_kept * -1 as cost_kept,
  inv.cost_underway_at_month_end,
  inv.own_stock_sales_kept,
  inv.own_stock_cost_kept,
  inv.partner_sales_kept,
  inv.partner_cost_kept,
  inv.own_stock_sales_kept_wo_ph,
  inv.own_stock_cost_kept_wo_ph,
  inv.paul_hunter_sales_kept,
  inv.paul_hunter_cost_kept,
  inv.orders_invoiced * dir.cost_per_order as cost_direct,
  inv.orders_invoiced * dir.payment_cost as payment_cost,
  inv.orders_invoiced * dir.logistics_cost as logistics_cost,
  inv.orders_invoiced * dir.service_cost as service_cost,
  inv.orders_invoiced * mar.cost_per_order as cost_marketing,
  sty.stylists,
  vi.visits,
  ph.nb_of_calls,
  ph.call_orders_invoiced
FROM 
(
  SELECT
    c.date,
    c.working_days,
    x.country,
    x.revenue_state,
    x.order_type
  FROM dwh.calendar c 
  CROSS JOIN (SELECT shipping_country as country, revenue_state, order_type FROM bi.customer_order WHERE sales_kept > 0 GROUP BY 1,2,3) x
  WHERE c.date > '2014'
  AND c.date < CURDATE()
) a
LEFT JOIN 
(
  SELECT
    CAST(co.date_invoiced as date) as ""date"",
    co.shipping_country as country,
    co.order_type,
    COALESCE(co.revenue_state, 'Final') as revenue_state,
    COUNT(*) as orders_invoiced,
    SUM(COALESCE(co.sales_sent, co.sales_picked)) as sales_sent,
    SUM(co.sales_kept) as sales_kept,
    SUM(co.sales_returned) as sales_returned,
    SUM(co.billing_total) as billing_total,
    SUM(co.billing_net_sales) as billing_net_sales,
    SUM(co.cost_kept) as cost_kept,
    SUM(
      CASE 
        WHEN (
          (LEFT(co.date_returned,7) != LEFT(co.date_invoiced,7) AND co.date_returned > co.date_invoiced)
          OR co.date_returned is null) and co.order_state_number<1024
          THEN co.cost_sent
        ELSE 0
      END
    ) as cost_underway_at_month_end,
    SUM(co.own_stock_sales_kept) as own_stock_sales_kept,
    SUM(co.own_stock_cost_kept) as own_stock_cost_kept,
    SUM(co.partner_sales_kept) as partner_sales_kept,
    SUM(co.partner_cost_kept) as partner_cost_kept,
    SUM(own_stock_sales_kept_wo_ph) as own_stock_sales_kept_wo_ph,
    SUM(own_stock_cost_kept_wo_ph) as own_stock_cost_kept_wo_ph,
    SUM(co.paul_hunter_sales_kept) as paul_hunter_sales_kept,
    SUM(co.paul_hunter_cost_kept) as paul_hunter_cost_kept
  FROM bi.customer_order co
  WHERE co.is_real_order = 'Real Order'
  AND co.date_invoiced is not null
  AND co.date_invoiced > '2014'
  AND co.order_state_number >= 16 
  AND co.order_state_number < 2048
  GROUP BY 1,2,3,4
) inv on inv.date = a.date AND inv.country = a.country AND inv.revenue_state = a.revenue_state AND inv.order_type = a.order_type
LEFT JOIN 
(
  SELECT
    CAST(co.date_stylist_picked as date) as ""date"",
    co.shipping_country as country,
    co.order_type,
    COUNT(*) as orders_processed
  FROM bi.customer_order co
  WHERE co.is_real_order = 'Real Order'
  AND co.date_stylist_picked is not null
  AND co.date_stylist_picked > '2014'
  AND co.order_state_number >= 16
  AND co.order_state_number < 2048 
  GROUP BY 1,2,3
) prc on prc.date = a.date AND prc.country = a.country AND a.revenue_state = 'Final' AND prc.order_type = a.order_type
LEFT JOIN
(
  SELECT  
    CAST(co.date_incoming as date) as ""date"", 
    co.shipping_country as country, 
    COUNT(case when co.order_type = 'First Order' then order_id else null end) as orders_incoming, 
    COUNT(case when co.order_type in ('Repeat Order','Outfittery Club Order') then order_id else null end) as orders_incoming_repeat 
  FROM bi.customer_order co 
  WHERE co.is_real_order = 'Real Order' 
  AND co.date_created > '2014'
  GROUP BY 1,2
) inc on inc.date = a.date AND inc.country = a.country AND a.revenue_state = 'Final' AND a.order_type = 'First Order'
LEFT JOIN
(
  SELECT
    ccd.date_invoiced as ""date"",
    ccd.country,
    SUM(CASE WHEN ccd.cost_type='payment' then ccd.cost_per_order ELSE NULL END) AS payment_cost,
    SUM(CASE WHEN ccd.cost_type='service' then ccd.cost_per_order ELSE NULL END) AS service_cost,
    SUM(CASE WHEN ccd.cost_type='logistics' then ccd.cost_per_order ELSE NULL END) AS logistics_cost,
    SUM(ccd.cost_per_order) as cost_per_order
  FROM bi.company_costs_direct ccd 
  GROUP BY 1,2
) dir on dir.date = a.date AND dir.country = a.country
LEFT JOIN bi.company_costs_marketing mar on mar.date_invoiced = a.date AND mar.country = a.country
LEFT JOIN 
(
  SELECT
    swa.date_invoiced as ""date"",
    swa.country,
    sum(stylist_weighted_activity) as stylists
  FROM bi.stylist_weighted_activity swa
  JOIN raw.stylist s on s.stylist_id = swa.stylist_id
  WHERE s.real_stylist = true
  AND s.role = 'Stylist' 
  GROUP BY 1,2
) sty on sty.date = a.date AND sty.country = a.country AND a.revenue_state = 'Final' AND a.order_type = 'First Order'
LEFT JOIN
(
  SELECT 
    date_created  as ""date"",
    domain as country,
    sum(visits) as visits 
  FROM ""bi.marketing_funnel_by_date_domain_channel_device""
  group by 1,2
) vi on vi.""date"" = a.""date"" AND vi.country = a.country AND a.revenue_state = 'Final' AND a.order_type = 'First Order'
LEFT JOIN
(
  SELECT 
      cast(date_phone_call_current as date) as ""date"",
      shipping_country as country,
      count(distinct order_id) as nb_of_calls,
      count(case when date_invoiced is not null then order_id else null end) as call_orders_invoiced
    FROM bi.customer_order
    group by 1,2
)ph on ph.""date"" = a.""date"" AND ph.country = a.country AND a.revenue_state = 'Final' AND a.order_type = 'First Order'"	READY
332	2015-04-24 18:20:56	"1112787811"	true	2015-04-24 18:20:56	bi.company_costs_marketing		"/* Past costs from the marketing team are entered via Deathstar and then here 
are converted into a cost per order for the current number of real orders in each month */

CREATE VIEW bi.company_costs_marketing
AS
SELECT
	od.date_invoiced,
	m.country,
	m.cost*-1/ow.num_orders_weekly*od.num_orders_daily as cost,
	m.cost*-1/ow.num_orders_weekly as cost_per_order
FROM
(
	SELECT
		c.year_week,
		mc.country,
		SUM(mc.cost) as cost
	FROM raw.marketing_costs mc
	JOIN dwh.calendar c on c.date = mc.date_created
	GROUP BY 1,2
) m
JOIN
(
	SELECT 
		c.year_week,
		co.shipping_country as country,
		COUNT(*) as num_orders_weekly
	FROM bi.customer_order co
	JOIN dwh.calendar c on c.date = CAST(co.date_invoiced as date)
	WHERE co.is_real_order = 'Real Order'
	AND co.order_state_number >= 16
	GROUP BY 1,2
) ow on m.year_week = ow.year_week AND ow.country = m.country
JOIN
(
	SELECT 
		c.year_week,
		c.date as date_invoiced,
		co.shipping_country as country,
		COUNT(*) as num_orders_daily
	FROM bi.customer_order co
	JOIN dwh.calendar c on c.date = CAST(co.date_invoiced as date)
	WHERE co.is_real_order = 'Real Order'
	AND co.order_state_number >= 16
	GROUP BY 1,2,3
) od on m.year_week = od.year_week AND m.country = od.country"	READY
196,688	2015-06-18 16:27:45	"901272454"	true	2015-06-18 16:27:45	raw.nav_purchase_order_articles		"CREATE VIEW raw.nav_purchase_order_articles AS
/* 	""nav_test.Outfittery GmbH$Purch_ Rcpt_ Header"" h; for active POs */

WITH initial AS
(
SELECT
	l.""document type"",
	l.""document no_"",
	l.""doc_ no_ occurrence"",
	l.""line no_"",
	l.no_ AS item_no,
	l.""Variant Code"",
	l.""Order Date"",
	l.""Expected Receipt Date"",
	l.""Requested Receipt Date"", 
	l.""Promised Receipt Date"", 
	l.""Planned Receipt Date"",
	l.quantity AS quantity_initial,
	l.""Direct Unit Cost"" AS direct_unit_cost

FROM
	/* active purchase order */
	/* document type 0 = quote; 1 = order; 2 = manual invoice; 3 = credit note; 4 = blanket order; 5 = return po */
	""nav_test.Outfittery GmbH$Purchase Line Archive"" l
WHERE l.""version no_"" = 1
),

revised AS
(
SELECT
/* document no_ = purchase_order_id */
	max_version.""document type"", max_version.""document no_"", max_version.""doc_ no_ occurrence"", max_version.""version no_"", l.""line no_"", l.quantity AS quantity_revised,
	l.""Expected Receipt Date"", l.""Requested Receipt Date"", l.""Promised Receipt Date"", l.""Planned Receipt Date"", l.Description, l.""Outstanding Quantity""
FROM
	/* active purchase order */
	/* document type 0 = quote; 1 = order; 2 = manual invoice; 3 = credit note; 4 = blanket order; 5 = return po */
	(SELECT
		""document type"", ""document no_"", ""doc_ no_ occurrence"", MAX(""version no_"") ""version no_""
	FROM
		""nav_test.Outfittery GmbH$Purchase Line Archive"" l
	GROUP BY 1,2,3
	) max_version
	JOIN
	""nav_test.Outfittery GmbH$Purchase Line Archive"" l
		 ON max_version.""document type"" 		= l.""document type""
		AND max_version.""document no_"" 			= l.""document no_""
		AND	max_version.""doc_ no_ occurrence"" 	= l.""doc_ no_ occurrence""
		AND max_version.""version no_"" 			= l.""version no_""
),

received AS
(
SELECT
/* ""order no_"" = purchase_order_id */
	l.""document no_"",
	l.""line no_"",
	MIN(l.""posting date"") date_received_min,
	MAX(l.""posting date"") date_received_max,
	SUM(l.quantity) quantity_received
FROM
	""nav_test.Outfittery GmbH$Purch_ Rcpt_ Line"" l
GROUP BY 1,2
),

invoiced AS
(
SELECT
/* ""order no_"" = purchase_order_id */
	l.""document no_"",
	l.""line no_"",
	/* l.""unit cost (lcy)"", */
	MIN(l.""posting date"") date_invoiced_min,
	MAX(l.""posting date"") date_invoiced_max,
	SUM(l.quantity) quantity_invoiced
FROM
	""nav_test.Outfittery GmbH$Purch_ Inv_ Line"" l
GROUP BY 1,2
),

returned AS
(
SELECT
	/* h.""return order no_"", */
	l.""document no_"",
	l.""line no_"",
	MIN(l.""posting date"") date_returned_min,
	MAX(l.""posting date"") date_returned_max,
	SUM(l.quantity) quantity_returned
FROM
	""nav_test.Outfittery GmbH$return shipment Line"" l
GROUP BY 1,2
),

credit AS
(
SELECT
	/* h.""return order no_"", */
	l.""document no_"",
	l.""line no_"",
	MIN(l.""posting date"") date_credit_min,
	MAX(l.""posting date"") date_credit_max,
	SUM(l.quantity) quantity_credit
FROM
	""nav_test.Outfittery GmbH$Purch_ cr_ memo Line"" l
GROUP BY 1,2
)




/* MAIN BODY */

SELECT
	initial.""document no_"" AS order_no,
	initial.""line no_"" AS line_no,
	initial.item_no,
	initial.""Variant Code"" AS variant_code,
	initial.""Order Date"" AS order_date,	
	initial.direct_unit_cost,
	initial.""Expected Receipt Date"",
	initial.""Requested Receipt Date"", 
	initial.""Promised Receipt Date"", 
	initial.""Planned Receipt Date"",
	received.date_received_min,
	received.date_received_max,
	invoiced.date_invoiced_min,
	invoiced.date_invoiced_max,
	returned.date_returned_min,
	returned.date_returned_max,
	credit.date_credit_min,
	credit.date_credit_max,
	CAST(initial.quantity_initial AS SHORT) AS quantity_initial,
	CAST(revised.quantity_revised AS SHORT) AS quantity_revised,
	CAST(received.quantity_received AS SHORT) AS quantity_received,	
	CAST(invoiced.quantity_invoiced AS SHORT) AS quantity_invoiced,
	CAST(returned.quantity_returned AS SHORT) AS quantity_returned,
	CAST(credit.quantity_credit AS SHORT) AS quantity_credit	
FROM
	initial
	LEFT JOIN
	revised
		 ON initial.""document type"" 		= revised.""document type""
		AND initial.""document no_""			= revised.""document no_""
		AND initial.""doc_ no_ occurrence"" 	= revised.""doc_ no_ occurrence""
		AND initial.""line no_""				= revised.""line no_""
	LEFT JOIN
	received
		 ON initial.""document no_""			= received.""document no_""
		AND initial.""line no_""				= received.""line no_""
	LEFT JOIN
	invoiced
		 ON initial.""document no_""			= invoiced.""document no_""
		AND initial.""line no_""				= invoiced.""line no_""
	LEFT JOIN
	returned
		 ON initial.""document no_""			= returned.""document no_""
		AND initial.""line no_""				= returned.""line no_""
	LEFT JOIN
	credit
		 ON initial.""document no_""			= credit.""document no_""
		AND initial.""line no_""				= credit.""line no_""
		
		
		
/*
SELECT
	""document type"" , ""no_""
FROM
	active purchase order
	""nav_test.Outfittery GmbH$Purchase Header"" h

just link the two above to the archive header

*/"	READY
266	2015-04-24 18:19:39	"1126921235"	true	2015-08-07 10:51:24	views.customer_order		"CREATE VIEW views.customer_order
AS
SELECT
	co.order_id as id,
	co.customer_id,
	co.date_created,
	null as last_updated,  /* Set to null as it's pointless data */
	co.order_state_number as state,
	CASE 
		WHEN co.payment_type = 'Invoice' THEN 1 
		WHEN co.payment_type = 'Credit Card' THEN 2
		WHEN co.payment_type = 'Pre-pay' THEN 4 
		WHEN co.payment_type = 'Arvato' THEN 6
	END as payment_method,
	CASE 
		WHEN co.payment_state = 'Pending' THEN 8
		WHEN co.payment_state = 'Authorised' THEN 16
		WHEN co.payment_state = 'Captured' THEN 32
		WHEN co.payment_state = 'Factored' THEN 48
		WHEN co.payment_state = 'Paid' THEN 64
		WHEN co.payment_state = 'Cancelled' THEN 2048
	END as payment_state,
	co.cost_sent as total_amount_basket_purchase_gross,
	co.sales_sent*co.exchange_rate as total_amount_basket_retail_gross,
	co.discount_marketing*co.exchange_rate as total_amount_billed_discount,
	co.cost_kept as total_amount_billed_purchase_gross,
	co.billing_total*co.exchange_rate as total_amount_billed_retail_gross,
	'0' as total_amount_net,  /* Always zero in production database */
	co.parent_order_id,
	co.date_invoiced as date_billed,
	co.date_paid as date_payed,
	co.date_returned,
	co.date_shipped,
	'1' as total_amount_reserved,  /* Not sure what the data here means. Set to 1 as 99.9% of rows show 1 */
	co.sales_channel,
	co.box_type,
	co.date_phone_call as phone_date,
	co.stylist_id as stylelist_id,
	co.discount_type,
	'0' as discount_content,  /* Always zero in production database */
	'0' as total_amount_billed_discount_percentage,  /* Set this to zero as everything is covered in the absolute column */
	co.discount_marketing*co.exchange_rate as total_amount_billed_discount_absolute,
	co.date_completed,
	co.campaign_id,
	co.date_first_reminder,
	co.date_first_warning as date_first_dunning,
	co.billing_received*co.exchange_rate as total_amount_payed,
	co.date_given_to_debt_collection as date_encashment,
	co.date_returned_online,
	co.currency_code,
	co.date_cancelled as date_canceled,
	co.vat_percentage,
	co.date_stylist_picked as date_picked,
	co.customer_message_content,
	co.date_second_warning as date_second_dunning,
	null as date_earliest_delivery,
	co.date_submitted,
	co.discount_goodwill*co.exchange_rate as total_goodwill_credit,
	co.shipping_address_meets_billing_address,
	co.discount_marketing as total_amount_billed_discount_euro,
	co.discount_goodwill as total_goodwill_credit_euro,
	co.billing_received as total_amount_paid_euro,
	cust_sales_channel.sales_channel as first_saleschannel_completed,
	cust_sales_channel.box_type as first_box_type,
	co.shipping_city,
	co.shipping_country,
	co.shipping_street,
	co.shipping_street_number,
	co.shipping_zip,
	co.shipping_first_name,
	co.shipping_last_name,
	co.shipping_co,
	co.billing_city,
	co.billing_country,
	co.billing_street,
	co.billing_street_number,
	co.billing_zip,
	co.billing_first_name,
	co.billing_last_name,
	co.billing_co,
	c.date_of_birth as customer_date_of_birth,
	c.customer_age,
	co.date_invoiced as invoice_date_created,
	co.invoice_number,
	co.real_order_count as real_repeat_order_count,
	co.follow_on_count,
	co.all_order_count as total_order_count,
	co.all_order_count as all_orders_count,
	co.real_order_count_completed,
	co.all_order_count_completed,
	CASE
		WHEN co.order_type = 'First Order' THEN 'first order'
		WHEN co.order_type in ('Repeat Order', 'Outfittery Club Order') THEN 'real repeat order'
		WHEN co.order_type in ('First Order Follow-on', 'Repeat Order Follow-on') THEN 'follow on order'
		ELSE 'Ask BI'
	END as order_type,
	CASE
		WHEN co.order_type_completed = 'First Order' THEN 'first order'
		WHEN co.order_type_completed in ('Repeat Order', 'Outfittery Club Order') THEN 'real repeat order'
		WHEN co.order_type_completed in ('First Order Follow-on', 'Repeat Order Follow-on') THEN 'follow on order'
		WHEN co.order_type_completed = 'Not Completed' THEN 'not completed'
		ELSE 'Ask BI'
	END as order_type_completed,
	cam.campaign_type,
	cam.discount_code as code,
	cam.campaign_title,
	null as info_pictypicalstyle,
	null as info_quantityshoes,
	null as info_quantitysakkos,
	null as info_selectedprdsportive,
	null as info_picarticlecloset,
	null as info_picclothwork,
	null as info_pictypicalcar,
	null as info_piclanguage,
	null as info_question6,
	null as info_picgoodcolor,
	null as info_quantitytshirts,
	null as info_question7,
	null as info_pictypicalsupermarket,
	null as info_picagerange,
	null as info_quantitytrousers,
	null as info_quantitypullover,
	null as info_selectedprdfashion,
	null as info_quantityshirts,
	null as info_picbrandok,
	null as info_selectedprdclassic,
	null as info_picarticleneeded,
	null as info_haircolor,
	null as info_quantityjackets,
	null as info_pictypicalshoes,
	null as info_undefined,
	co.is_real_order as order_state
FROM bi.customer_order co
JOIN bi.customer c on c.customer_id = co.customer_id 
LEFT JOIN raw.discount_campaigns as cam on co.campaign_id = cam.campaign_id
LEFT JOIN (
	SELECT
  		fsc.customer_id,
  		fsc.sales_channel,
  		fsc.box_type
 	FROM 
 	(
 		SELECT
			row_number() over (partition by customer_id order by date_created asc) as ""rnum"",
			customer_id,
			order_id as id,
			sales_channel,
			box_type
		FROM bi.customer_order
		WHERE order_state_number = '1024'
	) fsc
 	where fsc.rnum = '1'
) cust_sales_channel on cust_sales_channel.customer_id = co.customer_id"	READY
274	2015-04-24 18:19:49	"1112787760"	true	2015-04-24 18:19:49	ml.customer_order_id_billed_before		"CREATE VIEW ml.customer_order_id_billed_before AS
SELECT
	co1.order_id AS order_id,
	SUM(co2.billing_total) AS billing_total
FROM bi.customer_order AS co1
INNER JOIN bi.customer_order AS co2
	ON co1.customer_id = co2.customer_id AND co1.date_stylist_picked > co2.date_stylist_picked
GROUP BY co1.order_id"	READY
32,817	2015-04-28 19:01:10	"770347151"	true	2015-05-20 18:50:51	am.base_pre		"CREATE VIEW ""am.base_pre"" AS
SELECT
o.o_id AS ""pim_model_id"",
o.article_name AS ""article_name"",
o.brand AS ""brand_pim"",
brand.""brand_erp"" AS ""brand_erp"",
o.commodity_group4 AS ""commodity_group4"",
o.commodity_group5 AS ""commodity_group5"",
cga.""article_category"" AS ""article_category"",
cga.""product_group"" AS ""product_group"",
'MEN' AS ""gender"",
'STANDARD' AS ""color_group_code"",
CASE WHEN piece.pieces_erp IS NOT NULL THEN piece.pieces_erp
ELSE 'PC' END ""pieces"",
ptn.tariff_number,
ptn.tariff_is_constant,
bbc.blacklisted_countries,
o_smallest_size.country_of_production ""country_of_production"",
bpc.creditor ""creditor"",
o.supplier_sku ""supplier_sku"",
CASE
WHEN o.age = 'all' THEN 'ALL'
WHEN o.age = 'over_40' THEN 'OVER40'
WHEN o.age = 'under_40' THEN 'UNDER40'
ELSE NULL
END AS ""age""
FROM ""am.pim_model"" pm
LEFT JOIN ""am.object_17"" o ON o.o_id = pm.pim_model_id
LEFT JOIN ""am.brand_pim__brand_erp"" brand ON brand.""brand_pim"" = o.brand
LEFT JOIN ""am.cg5__article_group"" cga ON cga.commodity_group5 = o.commodity_group5
LEFT JOIN ""am.unit_pim__pieces_erp"" piece ON piece.unit_pim = o.basic_unit
LEFT JOIN ""am.pim_article__tariff_number_indexed"" ptn ON ptn.pim_model_id = o.o_id
LEFT JOIN ""am.brand_pim__blacklisted_countries"" bbc ON bbc.brand_pim = o.brand
LEFT JOIN ""am.pim_model__size_variation__smallest"" pmsv ON pmsv.pim_model_id = pm.pim_model_id
LEFT JOIN ""am.object_17"" o_smallest_size ON o_smallest_size.o_id = pmsv.pim_size_variation_id
LEFT JOIN ""am.brand_pim__creditor"" bpc ON bpc.brand_pim = o.brand
WHERE o.brand != 'outfittery'
AND o.brand != 'nudie_jeans'
AND o.brand != 'vip'"	READY
688,132	2015-09-08 18:10:49	"1283793627"	true	2015-09-08 18:11:53	tableau.bisdev_country_mismatch		"CREATE view tableau.bisdev_country_mismatch
as

select 
	co.order_id,
	co.customer_id,
	cu.first_name,
	cu.last_name,
	cu.email,
	cu.phone_number,
    billing_first_name, 
    billing_last_name, 
    billing_co
    billing_street, 
    billing_street_number, 
    billing_zip, 	
	billing_city,
    billing_country, 
	shipping_first_name, 
	shipping_last_name, 
	shipping_co,
	shipping_street, 
	shipping_street_number, 
	shipping_zip, 
	shipping_city,
	shipping_country, 
	cu.default_domain
from bi.customer_order co
left join bi.customer cu on cu.customer_id=co.customer_id
where cu.default_domain<>'COM'
and cu.default_domain<>co.shipping_country"	READY
337	2015-04-24 18:22:07	"1112787816"	true	2015-04-24 18:22:07	ml.project_outfit_candidate		"CREATE VIEW ml.project_outfit_candidate AS
SELECT DISTINCT
	'order_group__' || coa.outfit_id AS ""outfit_candidate_id"",
	'order_group' AS ""origin"",
	coa.outfit_id AS ""origin_candidate_id"",
	co.stylist_id,
	co.customer_id
FROM ""bi.customer_order"" co
LEFT JOIN ""bi.customer_order_articles"" coa ON coa.order_id = co.order_id
WHERE co.date_stylist_picked > '2014-01-01'
AND coa.outfit_id IS NOT NULL
AND coa.outfit_id IS NOT NULL"	READY
524,291	2015-08-12 16:35:11	"1151096366"	true	2015-08-12 17:59:47	tableau.callcenter_call_list		"CREATE VIEW tableau.callcenter_call_list
AS


SELECT
   cu.customer_id,
   cu.first_name,
   cu.last_name,
   cu.email,
   cu.phone_number,
   cu.date_created as account_creation_date,
   st.stylist,
   co.billing_total,
   co.shipping_city,
   co.shipping_country,
   co.shipping_street,
   bc.last_date_incoming,
   bc.last_date_invoiced,
   bc.last_date_phone_call,
   sf.date_last_contacted,
   CASE 
         WHEN bc.last_date_invoiced < '2014-07-31' THEN 1
         ELSE 0
   END AS no_order_after_08_14,
   CASE 
         WHEN co.not_reached = 'true' AND co.order_type_completed = 'Not Completed' THEN 1
         ELSE 0
      END AS not_reached
FROM bi.customer cu
LEFT JOIN raw.stylist st ON st.stylist_id = cu.new_stylist_id
LEFT JOIN raw.customer_salesforce sf ON sf.customer_id = cu.customer_id
LEFT JOIN
(
   SELECT
      customer_id,
      billing_total,
      shipping_city,
      shipping_country,
      shipping_street,
      not_reached,
      order_type_completed
   FROM
   (
      SELECT
         customer_id,
         billing_total,
         shipping_city,
         shipping_country,
         shipping_street,
         not_reached,
         order_type_completed,
         RANK() OVER (PARTITION BY customer_id ORDER BY date_incoming DESC) as order_count
      FROM bi.customer_order
      WHERE date_incoming is not null
      AND is_real_order = 'Real Order'
   ) ab
   WHERE ab.order_count = 1
) co ON co.customer_id = cu.customer_id
LEFT JOIN
(
SELECT
   customer_id,
   CAST(max(date_incoming) as date) as last_date_incoming,
   CAST(max(date_invoiced) as date) as last_date_invoiced,
   max(date_phone_call) as last_date_phone_call
FROM bi.customer_order
WHERE is_real_order = 'Real Order'
GROUP BY 1
) bc ON bc.customer_id = cu.customer_id
AND user_type = 'Real User'"	READY
851,984	2015-09-22 14:35:25	"1351631545"	true	2015-09-22 14:35:25	raw.dim_customer_order		"/*******************************************************************
-- Author       Hemanth
-- Created      2015-07-01
-- Purpose      This view Gets the raw data from POSTGRES tables. This table has  
--              order information of customer 
--Tables        customer_order,address,voucher,order_position,doc_data_shipment_confirmation,
                preview,doc_data_manifest_shipping,order_cancellation,order_cancellation_reason
-------------------------------------------------------------------------------
-- Modification History
--Date          Author      Description
--2015-09-16    Hemanth     Added Comments to sub-queries
--2015-09-22    Hemanth     Added Billing address
*******************************************************************/

CREATE VIEW raw.dim_customer_order
AS

SELECT
  co.id as order_id,
  co.customer_id,
  co.parent_order_id,
  co.shipping_address_id,
  co.stylelist_id as stylist_id,
  CASE 
    WHEN co.payment_method = 1 THEN 'Invoice'
      WHEN co.payment_method = 2 THEN 'Credit Card'
      WHEN co.payment_method = 4 THEN 'Pre-pay'
      WHEN co.payment_method = 6 THEN 'Arvato'
      ELSE 'Ask BI'
  END as payment_type,
  co.sales_channel,
  co.state as order_state,

  co.date_created,
  pr.date_preview_created,
  co.phone_date as date_phone_call,
  /*Date Picked from amidala when stylist picks the articles, date_picked in customer_order when order is submitted to warehouse
  and invoice is printed*/
  COALESCE(op.date_stylist_picked,co.date_picked,dd_ms.date_shipped,co.date_shipped) as date_stylist_picked,
  /*date_invoiced is when invoice is printed and kept in the box which we get form shippiment comfirmation, it takes invoice date
  created if date in manifest shipping is null*/
  COALESCE(dd_sc.date_invoiced,inv.date_created) as date_invoiced,
  co.date_returned,
  /*date_shipped from doc_data is when label is printed, will be changed to aftership table when dhl scans the label*/
  COALESCE(dd_ms.date_shipped,co.date_shipped) as date_shipped,
  co.date_payed AS date_paid, /*date_paid for arvato customers can be get from dwh.arvato payments*/
  COALESCE(can.date_cancelled,co.date_canceled) as date_cancelled,
  can.cancellation_reason,

  co.marketing_campaign,
  co.discount_type,
  /* Be very careful here as the code for discounts is duplicated for the discount_total column */
  CASE 
    WHEN co.total_goodwill_credit IS NOT NULL THEN co.total_goodwill_credit ELSE 0 END
    +CASE WHEN co.total_amount_billed_discount IS NOT NULL THEN co.total_amount_billed_discount ELSE 0 END
    +CASE WHEN NOT (vou.credit_note = vou.credit_goodwill OR vou.credit_note = vou.credit_campaign) AND vou.credit_note IS NOT NULL THEN vou.credit_note ELSE 0 
  END as discount_total,

  CASE WHEN co.total_goodwill_credit IS NOT NULL THEN co.total_goodwill_credit ELSE 0 END as discount_goodwill,
  CASE WHEN co.total_amount_billed_discount IS NOT NULL THEN co.total_amount_billed_discount ELSE 0 END as discount_marketing,
  CASE WHEN (vou.credit_note <> vou.credit_goodwill OR vou.credit_note <> vou.credit_campaign) AND vou.credit_note IS NOT NULL THEN vou.credit_note ELSE 0 
  END as discount_paid_voucher,

  co.total_amount_payed,
  
  co.currency_code as country_code_iso,
  
  CASE 
    WHEN ship_add.country IN ('DE','AT','CH') THEN 'DACH'
    WHEN ship_add.country IN ('BE','NL','LU') THEN 'BENELUX'
    WHEN ship_add.country IN ('DK','SE') THEN 'Nordic'
  ELSE 'ASK BI'
  END AS shipping_region,
  INITCAP(ship_add.city) as shipping_city,
  ship_add.zip as shipping_zip,
  CASE 
    WHEN ship_add.country='A' THEN 'AT'
    WHEN ship_add.country='' THEN null
    ELSE ship_add.country 
  END as shipping_country,
  
  CASE 
    WHEN bill_add.country IN ('DE','AT','CH') THEN 'DACH'
    WHEN bill_add.country IN ('BE','NL','LU') THEN 'BENELUX'
    WHEN bill_add.country IN ('DK','SE') THEN 'Nordic'
  ELSE 'ASK BI'
  END AS billing_region,
  INITCAP(bill_add.city) as billing_city,
  bill_add.zip as billing_zip,
  CASE 
    WHEN bill_add.country='A' THEN 'AT'
    WHEN bill_add.country='' THEN null
    ELSE bill_add.country 
  END as billing_country,
  
  /*Call Box is set when order has phone date or else its is No Call box
    with TM, the definition will be changed Call Box (state change 4-8) and NoCall Box (4-12)*/
  CASE
    WHEN co.phone_date > '2012-05-10'
    AND co.phone_date < TIMESTAMPADD(SQL_TSI_MONTH, 2, curdate())
    AND co.phone_date >= co.date_created
    THEN 'Call Box'
    WHEN co.sales_channel = 'clubWithCall' THEN 'Call Box'
    ELSE 'No Call Box'
  END as box_type,

  CASE
    WHEN real_order.real_order_count = 1 AND co.parent_order_id is null THEN 'First Order'
    WHEN all_order.all_order_count = 2 AND co.parent_order_id is not null THEN 'First Order Follow-on'
    WHEN co.sales_channel like 'club%' THEN 'Outfittery Club Order'
    WHEN real_order.real_order_count > 1 AND co.parent_order_id is null THEN 'Repeat Order'
    WHEN all_order.all_order_count > 2 AND co.parent_order_id is not null THEN 'Repeat Order Follow-on'
    WHEN real_order.real_order_count = 1 AND co.id = co.parent_order_id THEN 'First Order'            /* to deal with bad data where order_id=parent_id */
  END as order_type
    
FROM postgres.customer_order co
LEFT JOIN postgres.address as ship_add on ship_add.id = co.shipping_address_id
LEFT JOIN postgres.address as bill_add on bill_add.id = co.shipping_address_id
LEFT JOIN postgres.voucher inv on inv.order_id = co.id AND inv.voucher_type = 'INVOICE'
LEFT JOIN
(
  SELECT
    order_id,
    MAX(date_picked) as date_stylist_picked
  FROM postgres.order_position
  GROUP BY 1
)op on op.order_id=co.id
/*date_invoiced is when invoice is kept in box i.e., shipment confirmation*/
LEFT JOIN  
(
  SELECT 
    ss.orderid as order_id, 
    parsedate(min(ss.shipping_date), 'yyyyMMdd') as date_invoiced 
  FROM postgres.doc_data_shipment_confirmation ss
  GROUP BY 1
) dd_sc on dd_sc.order_id = co.id

/* Get the last clicked on showroom / preview / topic box (and its parent) by ordering by date_created */
LEFT JOIN 
(
  SELECT 
    pd.order_id,
    pd.preview_id,
    pd.customer_preview_id,
    pd.date_preview_created
  FROM
  (
    SELECT 
      pr1.preview_id,
      pr1.id as customer_preview_id,
      pr1.date_created as date_preview_created,
      pr1.order_id,
      row_number() over (partition by pr1.order_id order by pr1.date_created desc) as ""rnum""
    FROM postgres.preview pr1
  ) pd
  WHERE pd.rnum = '1'
) pr on pr.order_id = co.id

/*get the date shipped from doc_data_manifest_shipping*/
LEFT JOIN  
(
  SELECT 
    ss.orderid as order_id,
    parsedate(min(ss.shipping_date), 'yyyyMMdd') as date_shipped
  FROM postgres.doc_data_manifest_shipping ss
  GROUP BY 1
) dd_ms on dd_ms.order_id = co.id

/*Get vouchers Information*/
LEFT JOIN 
(
  SELECT
    v.order_id, 
    sum(CASE WHEN v.voucher_type = 'CREDIT_GOODWILL' THEN -v.amount ELSE 0 END) as credit_goodwill,
    sum(CASE WHEN v.voucher_type = 'CREDIT_CAMPAIGN' THEN -v.amount ELSE 0 END) as credit_campaign,
    sum(CASE WHEN v.voucher_type = 'CREDIT_NOTE' THEN -v.amount ELSE 0 END) as credit_note
  FROM postgres.voucher v 
  GROUP BY 1
) vou on vou.order_id = co.id

/* Rank of order within all non-follow-on orders by this customer */
LEFT JOIN 
(
  SELECT 
    c_2.id,
    rank() OVER(PARTITION BY c_2.customer_id ORDER BY c_2.id) as ""real_order_count""
  FROM postgres.customer_order as c_2
  WHERE c_2.parent_order_id IS NULL
  OR c_2.id=c_2.parent_order_id       /* to deal with bad data where id=parent_order_id */
) as real_order on real_order.id = co.id

/* Rank of order within all orders by this customer */
LEFT JOIN
(
  SELECT
    c_3.id,
    rank() OVER(PARTITION BY c_3.customer_id ORDER BY c_3.id) as ""all_order_count""
  FROM postgres.customer_order as c_3
) as all_order on all_order.id = co.id
/*This table has cancellation information if order is cancelled by customer support or by 
script if there is no state in 60 days and last_updated date <10 days*/
LEFT JOIN
(
  SELECT  
    oc.order_id,
    oc.date_created AS date_cancelled,
    ocr.reason AS cancellation_reason
  FROM postgres.order_cancellation oc
  LEFT JOIN postgres.order_cancellation_reason ocr ON oc.order_cancellation_reason_id=ocr.id
)can on can.order_id=co.id"	READY
282	2015-04-24 18:19:53	"1112787763"	true	2015-04-24 18:19:53	ml.customer_orders		"CREATE VIEW ml.customer_orders AS
SELECT
	order_agg.customer_id,
 	CAST(trim(trailing ',' from replace(to_chars(order_agg.order_blob, 'UTF-8'), unescape('\n'), ',')) AS STRING) AS order_ids
FROM
(SELECT
	co.customer_id,
	textagg(co.order_id QUOTE '') AS order_blob
FROM bi.customer_order AS co
GROUP BY co.customer_id) AS order_agg
ORDER BY customer_id ASC"	READY
283	2015-04-24 18:19:53	"1112787764"	true	2015-04-24 18:19:53	ml.project_outfit_article_info		"CREATE VIEW ml.project_outfit_article_info AS
SELECT
	a.article_id,
	a.article_brand AS brand,
	a.article_sales_price_de AS price,
	a.article_image_url
FROM bi.article AS a
WHERE a.article_image_url IS NOT NULL"	READY
341	2015-04-24 18:22:21	"1112787820"	true	2015-04-28 14:50:57	raw.company_cost		"CREATE VIEW raw.company_cost
AS

WITH c_order AS
(
  SELECT
    c.year_month,
    co.shipping_country as country,
    SUM(co.billing_net_sales) as billing_net_sales
  FROM bi.customer_order co
  JOIN dwh.calendar c on c.date = CAST(co.date_invoiced as date)
  WHERE co.is_real_order = 'Real Order'
  AND co.date_invoiced is not null
  AND co.date_invoiced > '2014'
  AND co.order_state_number >= 16 
  AND co.order_state_number < 2048
  GROUP BY 1,2
),
c_cost as
(
  SELECT 
    * 
  FROM dwh.company_costs_direct_monthly
)

SELECT
  c1.year_month,
  c1.country_code,
  c1.cost_type,
  case 
      when c1.year_month>='2015-03' and c1.cost_type='payment' then -(co1.billing_net_sales*c1.cost)
      else c1.cost
  end as cost
FROM c_cost c1 
LEFT JOIN c_order co1 on c1.year_month = co1.year_month AND co1.country = c1.country_code

/*Future payment costs should be calculated based on the billing net sales*/

UNION ALL
SELECT
  co2.year_month,
  co2.country as country_code,
  a2.cost_type,
  -(co2.billing_net_sales*a2.cost) as cost
FROM c_order co2
LEFT JOIN
(
  /*This join gets the last payment cost percentage*/
  SELECT
    cp.year_month,
    cp.country_code,
    cp.cost_type,
    cp.cost
  FROM c_cost cp
  WHERE cp.year_month=(SELECT max(year_month) FROM dwh.company_costs_direct_monthly)
  and cp.cost_type='payment'
)a2 on a2.country_code=co2.country
WHERE co2.year_month=(SELECT max(year_month) FROM c_order)"	READY
343	2015-04-24 18:22:41	"1112787821"	true	2015-04-24 18:22:41	tableau.busdev_orders_inactive_onhold_reasons		"create view tableau.busdev_orders_inactive_onhold_reasons
AS

SELECT 
co.order_id,
co.shipping_first_name,
co.shipping_last_name,
co.customer_id,
co.date_created,
co.date_cancelled,
co.order_type,
co.order_state,
co.sales_channel,
co.box_type,
cso.inactive_reasons,
cso.salesforce_order_stage,
cso.salesforce_order_type
FROM bi.customer_order co
LEFT JOIN bi.customer_order_salesforce cso on cso.order_id=co.order_id"	READY
99	2015-04-24 18:17:49	"863698985"	true	2015-06-09 15:30:38	raw.ga_channel_logic		"CREATE VIEW raw.ga_channel_logic
AS
SELECT
ga2.source_medium_campaign,
CASE
	WHEN ga2.marketing_channel = 'Direct' AND ga2.source_medium_campaign = '(direct) / (none) / (not set)' THEN 'Direct Type-in'
 	WHEN ga2.marketing_channel = 'Direct' AND ga2.source_medium_campaign != '(direct) / (none) / (not set)' THEN 'Organic referral'
 	WHEN ga2.marketing_channel = 'Remarketing' THEN 'Remarketing'
 	WHEN ga2.marketing_channel = 'SEM Brand' THEN 'Google'
 	WHEN ga2.marketing_channel = 'Facebook' THEN 'CPC'
 	WHEN ga2.marketing_channel = 'Cooperations' THEN 'Web-contact'
 	WHEN ga2.marketing_channel = 'Referral Program' THEN 'Online'
 	/*	Affiliate sub-channels */
 	WHEN ga2.marketing_channel = 'Affiliate' AND (ga2.source_medium_campaign LIKE '%affilinet%' OR ga2.source_medium_campaign LIKE '%affili.net%') THEN 'Affilinet'
 	WHEN ga2.marketing_channel = 'Affiliate' AND ga2.source_medium_campaign LIKE '%daisycon%' THEN 'Daisycon'
 	WHEN ga2.marketing_channel = 'Affiliate' AND ga2.source_medium_campaign LIKE '%mitarbeiterangebote%' THEN 'Corporate Benefit Program'
 	WHEN ga2.marketing_channel = 'Affiliate' AND ga2.source_medium_campaign NOT LIKE '%daisycon%' AND ga2.source_medium_campaign NOT LIKE '%affilinet%' AND ga2.source_medium_campaign NOT LIKE '%affili.net%' AND ga2.source_medium_campaign NOT LIKE '%mitarbeiterangebote%' THEN 'Other Platform'
	/*	SEO sub-channels */
	WHEN ga2.marketing_channel = 'SEO' AND ga2.source_medium_campaign LIKE '%google%' THEN 'Google'
	WHEN ga2.marketing_channel = 'SEO' AND ga2.source_medium_campaign LIKE '%bing%' THEN 'Bing'
	WHEN ga2.marketing_channel = 'SEO' AND ga2.source_medium_campaign LIKE '%yahoo%' THEN 'Yahoo'
	WHEN ga2.marketing_channel = 'SEO' AND ga2.source_medium_campaign NOT LIKE '%yahoo%' AND ga2.source_medium_campaign NOT LIKE '%google%' AND ga2.source_medium_campaign NOT LIKE '%bing%' THEN 'Blog'
	/*	SEM Non-brand sub-channels */
	WHEN ga2.marketing_channel = 'SEM Non-brand' AND ga2.source_medium_campaign LIKE '%google%' THEN 'Google'
	WHEN ga2.marketing_channel = 'SEM Non-brand' AND ga2.source_medium_campaign LIKE '%bing%' THEN 'Bing'
	WHEN ga2.marketing_channel = 'SEM Non-brand' AND ga2.source_medium_campaign LIKE '%yahoo%' THEN 'Yahoo'
	WHEN ga2.marketing_channel = 'SEM Non-brand' AND ga2.source_medium_campaign NOT LIKE '%yahoo%' AND ga2.source_medium_campaign NOT LIKE '%google%' AND ga2.source_medium_campaign NOT LIKE '%bing%' THEN 'Blog'
	/*	Display */
	WHEN ga2.marketing_channel = 'Display' AND ga2.source_medium_campaign LIKE '%gdn%' THEN 'GDN'
	WHEN ga2.marketing_channel = 'Display' AND ga2.source_medium_campaign NOT LIKE '%gdn%'THEN 'Other'
	/*	Social Media */
	WHEN ga2.marketing_channel = 'Social Media' AND ga2.source_medium_campaign LIKE '%twitter%' THEN 'Twitter'
	WHEN ga2.marketing_channel = 'Social Media' AND ga2.source_medium_campaign LIKE '%youtube%' THEN 'Youtube'
	WHEN ga2.marketing_channel = 'Social Media' AND ga2.source_medium_campaign LIKE '%facebook%' THEN 'Facebook'
	WHEN ga2.marketing_channel = 'Social Media' AND ga2.source_medium_campaign LIKE '%linkedin.com%' THEN 'LinkedIn'
	WHEN ga2.marketing_channel = 'Social Media' AND ga2.source_medium_campaign LIKE '%xing.com%' THEN 'Xing'
	/*	CRM */
	WHEN ga2.marketing_channel = 'CRM' AND ga2.source_medium_campaign LIKE '%remarketing%' THEN 'Remarketing'
	WHEN ga2.marketing_channel = 'CRM' AND ga2.source_medium_campaign NOT LIKE '%remarketing%' THEN 'Email'
	ELSE 'Other'
	END AS marketing_subchannel,
	ga2.marketing_channel
FROM
(
	SELECT 
		DISTINCT
		ga.source_medium_campaign,
		CASE
			WHEN LOWER(ga.source) like '%linkedin.com%' THEN 'Social Media'
		 	WHEN LOWER(ga.source) like '%xing.com%' THEN 'Social Media'
			WHEN chan.channel ='remarketing' OR LOWER(ga.cam_bit_1) = 'rem' OR LOWER(ga.cam_bit_2) = 'rem' OR LOWER(ga.cam_bit_2) = 'remarketing'THEN 'Remarketing'
			WHEN chan.channel ='display' OR ga.source = 'display' OR LOWER(ga.cam_bit_1)='gdn' OR LOWER(ga.cam_bit_2)='gdn' THEN 'Display'
			WHEN chan.channel = 'affiliate' OR ga.source like '%affili%' OR ga.medium like '%mitarbeiterangebote%' THEN 'Affiliate'
			WHEN chan.channel = 'facebook' OR ga.source like '%facebook%' THEN 'Facebook'
		 	WHEN (ga.source like 'google%' AND ga.medium = 'cpc' AND (LOWER(ga.cam_bit_3) != 'brand' OR ga.cam_bit_3 is null) OR ga.source like 'bing%' AND ga.medium = 'cpc' AND (ga.cam_bit_3 != 'brand' OR ga.cam_bit_3 is null) OR ga.source like 'Bing%' AND ga.medium = 'cpc' AND (ga.cam_bit_3 != 'brand' OR ga.cam_bit_3 is null) ) THEN 'SEM Non-brand'
			WHEN (ga.source like 'google%' AND ga.medium = 'cpc' AND LOWER(ga.cam_bit_3) = 'brand' ) THEN 'SEM Brand'
		 	WHEN chan.channel = 'organic' OR ga.medium = 'organic' OR (ga.source like '%google%' AND ga.medium = 'referral') THEN 'SEO'
		 	WHEN chan.channel = 'crm' OR ga.medium = 'email' THEN 'CRM'
		 	WHEN chan.channel = 'kooperation' OR ga.source like 'coop%' THEN 'Cooperations'
		 	WHEN chan.channel = 'twitter' OR chan.channel = 'youtube' OR ga.source like '%twitter%' OR ga.medium like '%twitter%' OR ga.source = '%youtube%' OR ga.medium like '%youtube%' THEN 'Social Media'
		 	WHEN chan.channel = 'praemienprogramm' OR ga.medium = 'referralpage' OR ga.source = 'praemienprogramm' then 'Referral Program'
		 	WHEN chan.channel = 'direct' OR ga.source = '(direct)' OR ga.source like '%.outfittery.%' OR chan.channel ='referral' OR (ga.source like 'outfittery.%' AND ga.medium='referral') THEN 'Direct'
		 	ELSE 'Direct'
		END as marketing_channel
	FROM
	(
		SELECT 
			vi.source, 
			vi.medium, 
			vi.campaign, 
			cam.cam_bit_1,
			cam.cam_bit_2,
			cam.cam_bit_3,
			cam.cam_bit_4,
			cam.cam_bit_5,
			cam.cam_bit_6,
			cam.cam_bit_7,
			cam.cam_bit_8,
			cam.cam_bit_9,
			cam.cam_bit_10,
			cam.cam_bit_11,
			cam.cam_bit_12,
			cam.cam_bit_13,
			cam.cam_bit_14,
			cam.cam_bit_15,
			cam.cam_bit_16,
			cam.cam_bit_17,
			cam.cam_bit_18,
			cam.cam_bit_19,
			cam.cam_bit_20,
			LOWER(vi.source)|| ' / ' || LOWER(vi.medium) || ' / ' || LOWER(vi.campaign) AS source_medium_campaign 
		FROM dwh.ga_visits vi,
		TEXTTABLE (vi.campaign columns
				cam_bit_1 string,
				cam_bit_2 string,
				cam_bit_3 string,
				cam_bit_4 string,
				cam_bit_5 string,
				cam_bit_6 string,
				cam_bit_7 string,
				cam_bit_8 string,
				cam_bit_9 string,
				cam_bit_10 string,
				cam_bit_11 string,
				cam_bit_12 string,
				cam_bit_13 string,
				cam_bit_14 string,
				cam_bit_15 string,
				cam_bit_16 string,
				cam_bit_17 string,
				cam_bit_18 string,
				cam_bit_19 string,
				cam_bit_20 string
				delimiter '_' ) cam
		GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24
		UNION SELECT
			utm.source, 
			utm.medium, 
			utm.campaign, 
			cam.cam_bit_1,
			cam.cam_bit_2,
			cam.cam_bit_3,
			cam.cam_bit_4,
			cam.cam_bit_5,
			cam.cam_bit_6,
			cam.cam_bit_7,
			cam.cam_bit_8,
			cam.cam_bit_9,
			cam.cam_bit_10,
			cam.cam_bit_11,
			cam.cam_bit_12,
			cam.cam_bit_13,
			cam.cam_bit_14,
			cam.cam_bit_15,
			cam.cam_bit_16,
			cam.cam_bit_17,
			cam.cam_bit_18,
			cam.cam_bit_19,
			cam.cam_bit_20,
			lower(utm.source)|| ' / ' || lower(utm.medium) || ' / ' || lower(utm.campaign) AS source_medium_campaign 
			FROM dwh.ga_information_utm utm,
			TEXTTABLE (utm.campaign columns
				cam_bit_1 string,
				cam_bit_2 string,
				cam_bit_3 string,
				cam_bit_4 string,
				cam_bit_5 string,
				cam_bit_6 string,
				cam_bit_7 string,
				cam_bit_8 string,
				cam_bit_9 string,
				cam_bit_10 string,
				cam_bit_11 string,
				cam_bit_12 string,
				cam_bit_13 string,
				cam_bit_14 string,
				cam_bit_15 string,
				cam_bit_16 string,
				cam_bit_17 string,
				cam_bit_18 string,
				cam_bit_19 string,
				cam_bit_20 string
				delimiter '_' ) cam
			GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24
	) ga
LEFT JOIN dwh.ga_channel_translation chan on lower(ga.source)|| ' / ' || lower(ga.medium) = lower(chan.source_medium)
) ga2"	READY
344	2015-04-24 18:22:42	"1112787822"	true	2015-04-24 18:22:42	ml.project_cnc		"CREATE VIEW ml.project_cnc AS
SELECT
    co.order_id,
    co.parent_order_id,
    co.box_type,
    co.payment_type,
    co.order_type,
    co.shipping_country,
    co.billing_country,
    co.customer_id,
    co.date_phone_call,
    co.date_created AS customer_date_created,
    co.billing_total,
    CAST((co.date_stylist_picked IS NOT NULL AND co.order_state_number >= 16 AND co.order_state_number != 2048) AS FLOAT) processed,
    CAST(so.notReached__c AS INTEGER) AS not_reached,
    CAST(so.Telefonnummer_Falsch__c AS INTEGER) phone_number_incorrect,
    CAST(so.OpsCheck__c = 'OK' AS INTEGER) AS ""ops_check_ok"",
    CEILING(CAST(TIMESTAMPDIFF(SQL_TSI_HOUR, co.date_created, co.date_phone_call) AS FLOAT) / 24.0) AS days_until_phone_call,
    co.sales_channel,
    CASE WHEN co.sales_channel IN ('website', 'websiteWithDate') THEN 1
    ELSE 0 END AS call_possible,
    CASE WHEN co.sales_channel IN ('website', 'websiteWithoutCall') THEN 1
    ELSE 0 END AS nocall_possible
FROM
    bi.customer_order co
LEFT JOIN views.salesforce_opportunity so ON co.order_id = so.ExternalOrderId__c
WHERE co.date_created >= '2015-01-01'"	READY
345	2015-04-24 18:22:43	"1112787823"	true	2015-04-24 18:22:43	tableau.buying_incoming_purchase_orders		"CREATE VIEW tableau.buying_incoming_purchase_orders AS

select 
	pop.id, 
	pop.article_id, 
	pop.purchase_order_id, 
	pop.date_created, 
	pop.fulfilled_quantity, 
	pop.quantity, 
	pop.supplier_order_number, 
	pop.date_canceled, 
	pop.date_fulfilled, 
	pop.order_position_id, 
	pop.state, 
	pop.initial_quantity, 
	pop.retail_price, 
	pop.purchase_price,
	pop.purchase_order_positions_idx, 
	pop.earliest_delivery_date, 
	pop.latest_delivery_date, 
	pop.ean, 
	pop.article_name, 
	pop.eu_size,
	pop.eu_length, 
	pop.pic1, 
	osa.supplier_color_code,
	osa.supplier_color_name,
	osa.brand, 
	osa.commodity_group4,
	osa.commodity_group5,
	osa.supplier_sku, 
	osa.alternative_supplier_sku, 
	osa.o_parentid,
	osa.nos,
	osa.article_size,
	po.season as ""purchase_order_season"",
	po.order_typ,
	pim.buyer, 
	pim.country_of_origin, 
	pim.season, 	
	poa.stock_scanned
FROM views.purchase_order_position pop
LEFT JOIN views.purchase_order po on po.id = pop.purchase_order_id
INNER JOIN views.ownstock_article osa on pop.ean = osa.ean
LEFT JOIN views.pim_article pim on pim.ean=pop.ean
LEFT JOIN
	bi.purchase_order_articles poa
		 ON pop.id = poa.poa_id
		AND poa.driving_tbl_poa IS NOT NULL



/* THIS WAS REPLACEMENT CODE (THOUGH STILL ISSUES DUE TO INNER JOIN TO OWNSTOCK_ARTICLE)
PLUS ISSUES WITH DATA EXTRACT IN TABLEAU FOR o_parentid; SINCE THIS WILL BE REPLACED
WITH ERP, DECIDED JUST DOING SIMPLE MODIFICATION TO EXISTING QUERY MUCH EASIER AND FASTER*/

/*
SELECT 
	poa.poa_id AS id, 
	poa.article_id, 
	poa.purchase_order_id, 
	poa.date_poa_created AS date_created,
	poa.stock_ordered_initially AS initial_quantity,
	poa.stock_ordered_revised AS quantity, 
	poa.stock_booked AS fulfilled_quantity,
	poa.stock_scanned,
	poa.poa_supplier_order_number AS supplier_order_number, 
	poa.date_poa_cancelled AS date_canceled, 
	poa.date_poa_fulfilled AS date_fulfilled,
	poa.order_position_id, 
	poa.poa_state_number AS state, 
	poa.article_sales_price AS retail_price, 
	poa.article_cost AS purchase_price,
	poa.poa_position_number AS purchase_order_positions_idx, 
	poa.date_poa_delivery_earliest AS earliest_delivery_date, 
	poa.date_poa_delivery_latest AS latest_delivery_date,
	po.po_season as ""purchase_order_season"",
	po.po_order_type AS order_typ,
	a.article_ean AS ean,
	a.article_name,
	a.article_eu_size AS eu_size,
	a.article_eu_length AS eu_length,
	a.article_pic1 AS pic1,
	a.article_buyer AS buyer,
	a.article_country_of_origin AS country_of_origin,
	a.article_season AS season,
	a.article_supplier_color_code AS supplier_color_code,
	a.article_supplier_color_name AS supplier_color_name,
	a.article_brand AS brand, 
	a.article_commodity_group4 AS commodity_group4,
	a.article_commodity_group5 AS commodity_group5,
	a.article_supplier_sku AS supplier_sku, 
	a.article_supplier_alternative_sku AS alternative_supplier_sku, 
	a.article_o_parent_id AS o_parentid,
	a.article_nos AS nos,
	a.article_size
FROM
	bi.purchase_order AS po
	JOIN
	bi.purchase_order_articles AS poa
		ON po.purchase_order_id = poa.purchase_order_id
	LEFT JOIN
	bi.article a
		ON poa.article_id = a.article_id
WHERE
	driving_tbl_poa IS NOT NULL
*/"	READY
360	2015-04-24 18:23:07	"1112787837"	true	2015-07-30 17:58:41	tableau.billing_all_order_paid_creditcard_entry		"CREATE view tableau.billing_all_order_paid_creditcard_entry
AS
SELECT
  co.id,
  co.customer_id,
  co.date_created,
  co.shipping_country,
  co.order_type,
  co.payment_method,
  co.state,
  a.date_credit_card_entered,
  op.date_amidala_checkout
FROM
(
  /*This join is to get all customers who has entered cc details*/
  SELECT 
    distinct bd.customer_id,
    bd.date_credit_card_entered
  FROM views.billing_data bd
  WHERE customer_id is not null
  GROUP BY 1,2
)a
LEFT JOIN views.customer_order co on co.customer_id=a.customer_id
LEFT JOIN
(
    /*this join gets date_created for last orderline created in order_position table*/
    SELECT 
  order_id,
  max(date_created) as date_amidala_checkout
FROM views.order_position
GROUP BY 1
)op on op.order_id=co.id
WHERE co.state between 16 and 1024"	READY
364	2015-04-24 18:23:15	"1112787841"	true	2015-07-30 17:59:33	tableau.finance_credit_card_analysis		"CREATE view tableau.finance_credit_card_analysis
AS
WITH cust_pay AS
(
	SELECT 
		c1.customer_id,
		c1.payment_method,
		row_number() over(partition by c1.customer_id ORDER BY c1.date_created DESC,c1.payment_method) AS r_pay
	FROM views.customer_order c1
	WHERE state=1024
)
SELECT 
co.customer_id,
co.first_order_date,
co.last_order_date,
cur_pay.current_payment_method,
cust_inv.cust_with_invoice,
bill.credit_card_expires,
bill.credit_card_entries,
bill.cc_expired
FROM
(
	SELECT 
		customer_id,
		min(co.date_created) as first_order_date,
		max(co.date_created) as last_order_date
	FROM views.customer_order co
	WHERE co.state=1024
	GROUP BY 1
)co
LEFT JOIN 
(
	SELECT
		customer_id,
		payment_method as cust_with_invoice
	FROM cust_pay c
	WHERE c.r_pay=1 AND c.payment_method=1
)cust_inv on cust_inv.customer_id=co.customer_id 
LEFT JOIN 
(
	SELECT
		customer_id,
		payment_method as current_payment_method
	FROM cust_pay
	WHERE r_pay=1
)cur_pay on cur_pay.customer_id=co.customer_id
LEFT JOIN
(
	SELECT 
		b.customer_id,
		CAST(b.credit_card_expires AS date) AS credit_card_expires,
		case 
			when CAST(b.credit_card_expires AS date)<=curdate() then 'Y'
			else 'N'
		end as cc_expired,
		row_number() over(partition by b.customer_id ORDER BY b.id DESC) AS rnum_expires,
		COUNT(DISTINCT b.credit_card_number) OVER (PARTITION BY b.customer_id) AS credit_card_entries
	FROM views.billing_data b
) bill on bill.customer_id=co.customer_id AND bill.rnum_expires=1"	READY
365	2015-04-24 18:23:18	"1112787842"	true	2015-04-24 18:23:18	tableau.finance_orders_csv_export		"CREATE view tableau.finance_orders_csv_export
AS
SELECT
	co.id,
	co.customer_id,
	co.state,
	co.invoice_number,
	co.total_amount_billed_discount,
	co.date_returned,
	co.date_shipped,
	co.invoice_date_created,
	co.shipping_first_name as first_name,
	co.shipping_last_name as last_name,
	co.shipping_country as country,
	op.total_amount_basket_retail_gross,
	op.total_amount_basket_purchse_gross,
	op.total_amount_billed_retail_gross,
	op.total_amount_billed_purchase_gross
FROM views.customer_order co 
JOIN
(
	SELECT 
		op.order_id, 
		sum(case when op.state>=16 and op.state<2048 then op.quantity*op.purchase_price else 0 end) total_amount_basket_purchse_gross,
		sum(case when op.state>=16 and op.state<2048 then op.quantity*op.retail_price_euro else 0 end) total_amount_basket_retail_gross,
		sum(case when op.state=1024 then op.quantity*op.purchase_price else 0 end) total_amount_billed_purchase_gross,
		sum(case when op.state=1024 then op.quantity*op.retail_price_euro else 0 end) total_amount_billed_retail_gross
	FROM views.order_position op
	GROUP BY 1
) op on op.order_id=co.id"	READY
367	2015-04-24 18:23:22	"1112787844"	true	2015-04-24 18:23:22	tableau.treasury_total_incoming_orders		"CREATE view tableau.treasury_total_incoming_orders
AS
SELECT 
  cast(co.date_created as date) as ""datecreated"",
  'Week'||' '||f.""week"" AS week_of_date_created,
  co.shipping_country as ""addr_country"",
  count(distinct(co.id)) as ""aggorders"",
  count(distinct(case when  sfo.OpsCheck__c not like 'OK' then co.id else null end)) as ""ops-check-Not OK"",
  count(distinct(case when sfo.StageName like '%Inaktiv%' then co.id else null end)) as ""stage-inaktiv"",
  count(distinct(case when sfo.StageName like '%Datum vorschlagen%' then co.id else null end)) as ""stage-Datum vorschlagen"",
  count(distinct(case when sfo.StageName like '%on hold%' then co.id else null end)) as ""stage-on hold"",
  count(distinct(case when sfo.StageName like '%Termin ausmachen%' then co.id else null end)) as ""stage-Termin ausmachen"",
  count(distinct(case when sfo.OpsCheck__c='OK' and sfo.StageName like '%Vorschau erstellen%' then co.id else null end))*0.50 as ""stage-Vorschau erstellen"",
  count(distinct(case when sfo.OpsCheck__c='OK' and co.sales_channel<>'websiteWithDate' and StageName like 'Informationen vervoll%' then co.id else null end)) as ""Informationen vervollstndigen-No Phonedate"",
  count(distinct(case when sfo.OpsCheck__c='OK' and StageName like 'Informationen vervoll%' and co.sales_channel='websiteWithDate' then co.id else null end)) as ""Informationen vervollstndigen-before PhoneDate"",
  count(distinct(case when sfo.OpsCheck__c='OK' and cast(co.phone_date as date)>=curdate() and StageName like 'Informationen vervoll%' and co.sales_channel='websiteWithDate' then co.id else null end))*0.35 as ""Informationen vervollstndigen-PhoneDate"",
  count(distinct(case when sfo.OpsCheck__c='OK' and cast(co.phone_date as date)<curdate() and StageName like 'Informationen vervoll%' and co.sales_channel='websiteWithDate' then co.id else null end)) as ""Informationen vervollstndigen-PhoneDate(<)"",
  count(distinct(case when sfo.OpsCheck__c<>'OK' and (sfo.StageName in ('abgeschloen & Nachbereitung','Artikel bestellen','Feedback zur Bestellung einholen','Packen') or sfo.StageName like '%Vorschau erstellen%' or StageName like 'Informationen vervoll%')  then co.id else null end)) as ""7_totalincomingstage_not_ok""
FROM views.customer_order co
INNER JOIN views.salesforce_opportunity sfo on sfo.ExternalOrderId__c = co.id
LEFT JOIN views.futuredate f on f.date_created=cast(co.date_created as date)
WHERE co.state>= '8' 
AND co.state<'2048'
GROUP BY 1,2,3"	READY
26	2015-04-24 18:17:16	"1383765292"	true	2015-09-28 18:20:17	raw.customer_order		"CREATE VIEW raw.customer_order 
AS 

SELECT
  co.id as order_id,
  co.parent_order_id,
  co.customer_id,
  pr.preview_id,
  pr.customer_preview_id,
  co.campaign_id,
  co.stylelist_id as stylist_id,
  inv.reference_number as invoice_number, 
  co.sales_channel,  /* sales_channel data is a mess, we should probably put a fix in sometime to clean it up */
  CASE
    WHEN real_order.real_order_count = 1 AND co.parent_order_id is null THEN 'First Order'
    WHEN all_order.all_order_count = 2 AND co.parent_order_id is not null THEN 'First Order Follow-on'
    WHEN co.sales_channel like 'club%' THEN 'Outfittery Club Order'
    WHEN real_order.real_order_count > 1 AND co.parent_order_id is null THEN 'Repeat Order'
    WHEN all_order.all_order_count > 2 AND co.parent_order_id is not null THEN 'Repeat Order Follow-on'
    WHEN real_order.real_order_count = 1 AND co.id = co.parent_order_id THEN 'First Order'            /* to deal with bad data where order_id=parent_id */
  END as ""order_type"",
  CASE
    WHEN real_order_completed.real_order_count_completed is null THEN 'Not Completed'
    WHEN real_order_completed.real_order_count_completed = 1 AND co.parent_order_id is null THEN 'First Order'
    WHEN all_order_completed.all_order_count_completed = 2 AND co.parent_order_id is not null THEN 'First Order Follow-on'
    WHEN co.sales_channel like 'club%' THEN 'Outfittery Club Order'
    WHEN real_order_completed.real_order_count_completed > 1 AND co.parent_order_id is null THEN 'Repeat Order'
    WHEN all_order_completed.all_order_count_completed > 2 AND co.parent_order_id is not null THEN 'Repeat Order Follow-on'
    WHEN real_order_completed.real_order_count_completed = 1 AND co.id = co.parent_order_id THEN 'First Order'  /* to deal with bad data where order_id=parent_id */
  END as ""order_type_completed"",
  CASE 
    WHEN co.state = 4  THEN 'Initiated'
    WHEN co.state = 8  THEN 'Incoming'
    WHEN co.state = 12 THEN 'Checkout Enabled'
    WHEN co.state = 16 THEN 'Stylist Picked'
    WHEN co.state = 20 THEN 'Purchase Order Created'
    WHEN co.state = 24 THEN 'Sales Order Submitted'
    WHEN co.state = 32 THEN 'Stocked'
    WHEN co.state = 64 THEN 'Placed'
    WHEN co.state = 128 THEN 'Sent'
    WHEN co.state = 256 THEN 'Arrived'
    WHEN co.state = 384 THEN 'Returned Online'
    WHEN co.state = 512 THEN 'Returned'
    WHEN co.state = 1024 THEN 'Completed'
    WHEN co.state = 2048 THEN 'Cancelled'
    ELSE 'Ask BI'
  END as order_state,
  co.state as order_state_number,

/* Currency, Payment and Discount data. Note: Final prices are calculated from articles, so are not in this view. */
  co.currency_code, 
  CASE 
    WHEN co.payment_method = 1 THEN 'Invoice'
    WHEN co.payment_method = 2 THEN 'Credit Card'
    WHEN co.payment_method = 4 THEN 'Pre-pay'
    WHEN co.payment_method = 6 THEN 'Arvato'
    ELSE 'Ask BI'
  END as payment_type,
  CASE 
    WHEN co.payment_state = 8 THEN 'Pending'
    WHEN co.payment_state = 16 THEN 'Authorised'
    WHEN co.payment_state = 32 THEN 'Captured'
    WHEN co.payment_state = 48 THEN 'Factored'
    WHEN co.payment_state = 64 THEN 'Paid'
    WHEN co.payment_state = 2048 THEN 'Cancelled'
    ELSE 'Ask BI' 
  END as payment_state,
  co.discount_type,  /* Need to create a CASE statement lookup for this sometime */
  can.cancellation_reason, /*This information is filled by CS /warehouse when order is cancelled manually*/

/* Be very careful here as the code for discounts is duplicated for the discount_total column */
  CASE WHEN co.total_goodwill_credit is not null THEN co.total_goodwill_credit ELSE 0 END
    +CASE WHEN co.total_amount_billed_discount is not null THEN co.total_amount_billed_discount ELSE 0 END
    +CASE WHEN NOT (vou.credit_note = vou.credit_goodwill OR vou.credit_note = vou.credit_campaign) AND vou.credit_note is not null THEN vou.credit_note ELSE 0 END as discount_total_in_local_currency,
  CASE WHEN co.total_goodwill_credit is not null THEN co.total_goodwill_credit ELSE 0 END as discount_goodwill_in_local_currency,
  CASE WHEN co.total_amount_billed_discount is not null THEN co.total_amount_billed_discount ELSE 0 END as discount_marketing_in_local_currency,
  CASE WHEN NOT (vou.credit_note = vou.credit_goodwill OR vou.credit_note = vou.credit_campaign) AND vou.credit_note is not null THEN vou.credit_note ELSE 0 END as discount_paid_voucher_in_local_currency,

  co.max_total_amount_billed_retail_gross as sales_maximum_in_local_currency,
  co.max_total_amount_billed_retail_gross_origin as sales_maximum_type, 
  CASE WHEN co.payment_method != 6 THEN co.total_amount_payed ELSE null END as billing_received_in_local_currency,  /* Data for Arvato orders is incorrect, so set it to null */
  
/* All dates */
  co.date_created,
  pr.date_preview_created,
  co.date_canceled as date_cancelled,
  co.phone_date as date_phone_call,
  /* As most financial reporting is based on date_invoiced and we want to do historical reporting, we need to fill in the gaps from 2012/2013, hence this CASE statement */
  CASE 
    WHEN inv.date_created is not null THEN inv.date_created
    WHEN co.date_billed is not null THEN co.date_billed
    WHEN co.state >=16 AND co.state <=1024 THEN COALESCE(co.date_picked, co.date_shipped, co.date_created)   
  END as date_invoiced,
  COALESCE(co.date_picked,co.date_shipped) as date_stylist_picked,
  co.date_submitted,
  CASE
    WHEN co.date_shipped is not null THEN co.date_shipped
    WHEN co.state >=128 AND co.state <=1024 THEN COALESCE(inv.date_created, co.date_billed, co.date_submitted, co.date_picked, co.date_created)        
  END as date_shipped_internal,
  co.date_return_reminder,
  co.date_returned_online,
  co.date_return_registration,
  COALESCE(co.date_returned, op.date_returned) as date_returned,
  co.date_completed,
  co.date_first_reminder,
  co.date_first_dunning as date_first_warning,
  co.date_second_dunning as date_second_warning,
  co.date_third_dunning as date_third_warning,
  co.date_encashment as date_given_to_debt_collection,
  CASE WHEN co.state = 2048 THEN NULL ELSE co.date_payed END as date_paid,  /* There should be nothing paid if the order was cancelled */

/* Address details */ 
  co.shipping_address_meets_billing_address,
  INITCAP(ship_add.city) as shipping_city,
  CASE 
    WHEN ship_add.country='A' THEN 'AT'
    WHEN ship_add.country='' THEN null
    ELSE ship_add.country 
  END as shipping_country,
  INITCAP(ship_add.street) as shipping_street,
  ship_add.street_number as shipping_street_number,
  ship_add.zip as shipping_zip,
  INITCAP(ship_add.first_name) as shipping_first_name,
  INITCAP(ship_add.last_name) as shipping_last_name,
  INITCAP(ship_add.co) as shipping_co,
  INITCAP(bill_add.city) as billing_city,
  CASE
    WHEN bill_add.country='A' then 'AT'
    WHEN bill_add.country='' THEN null
    ELSE bill_add.country 
  END as billing_country,
  INITCAP(bill_add.street) as billing_street,
  bill_add.street_number as billing_street_number,
  bill_add.zip as billing_zip,
  INITCAP(bill_add.first_name) as billing_first_name,
  INITCAP(bill_add.last_name) as billing_last_name,
  INITCAP(bill_add.co) as billing_co,

  co.marketing_campaign, /*this field is used by stylist to add direct feedback call if customer is reached*/
/* Position of the order within the customer's order history */  
  all_order.all_order_count,
  real_order.real_order_count,
  follow_on.follow_on_count,
  real_order_completed.real_order_count_completed,
  all_order_completed.all_order_count_completed,

  co.customer_message_content

FROM postgres.customer_order as co
JOIN postgres.address as ship_add on ship_add.id = co.shipping_address_id
LEFT JOIN postgres.address as bill_add on bill_add.id = co.billing_address_id
LEFT JOIN postgres.voucher as inv on inv.order_id = co.id AND inv.voucher_type = 'INVOICE'

LEFT JOIN 
(
  SELECT
    op.order_id,
    MIN(op.date_returned) as date_returned
  FROM postgres.order_position op 
  GROUP BY 1
) as op on op.order_id = co.id

/* Rank of order within all orders by this customer */
LEFT JOIN 
(
  SELECT 
    co3.id,
    rank() OVER(PARTITION BY co3.customer_id ORDER BY co3.id) as ""all_order_count""
  FROM postgres.customer_order as co3
) as all_order on all_order.id = co.id

/* Rank of order within all non-follow-on orders by this customer */
LEFT JOIN 
(
  SELECT 
    co1.id,
    rank() OVER(PARTITION BY co1.customer_id ORDER BY co1.id) as ""real_order_count""
  FROM postgres.customer_order as co1
  WHERE co1.parent_order_id is null
  OR id=parent_order_id                   /* to deal with bad data where order_id=parent_id */
) as real_order on real_order.id = co.id

/* Rank of order within all follow-on orders by this customer */
LEFT JOIN 
(
  SELECT 
    co2.id,
    rank() OVER(PARTITION BY co2.customer_id ORDER BY co2.id) as ""follow_on_count""
  FROM postgres.customer_order as co2
  WHERE co2.parent_order_id is not null
) as follow_on on follow_on.id = co.id

/* Rank of order within all completed non-follow-on orders by this customer */
LEFT JOIN 
(
  SELECT 
    co5.id,
    rank() OVER(PARTITION BY co5.customer_id ORDER BY co5.id) as ""real_order_count_completed""
  FROM postgres.customer_order as co5
  WHERE (co5.parent_order_id is null AND co5.state = 1024)
  OR (id=parent_order_id AND co5.state = 1024 )       /* to deal with bad data where order_id=parent_id */
) as real_order_completed on real_order_completed.id = co.id

/* Rank of order within all completed orders by this customer */
LEFT JOIN 
(
  SELECT 
    co6.id,
    rank() OVER(PARTITION BY co6.customer_id ORDER BY co6.id) as ""all_order_count_completed""
  FROM postgres.customer_order as co6
  WHERE co6.state = 1024
) as all_order_completed on all_order_completed.id = co.id

/* Get the last clicked on showroom / preview / topic box (and its parent) by ordering by date_created */
LEFT JOIN 
(
  SELECT 
    pd.order_id,
    pd.preview_id,
    pd.customer_preview_id,
    pd.date_preview_created
  FROM
  (
    SELECT 
      pr1.preview_id,
      pr1.id as customer_preview_id,
      pr1.date_created as date_preview_created,
      pr1.order_id,
      row_number() over (partition by pr1.order_id order by pr1.date_created desc) as ""rnum""
    FROM postgres.preview pr1
  ) pd
  WHERE pd.rnum = '1'
) pr on pr.order_id = co.id

/* Get vouchers */
LEFT JOIN 
(
  SELECT
  v.order_id, 
  sum(CASE WHEN v.voucher_type = 'CREDIT_GOODWILL' THEN -v.amount ELSE 0 END) as credit_goodwill,
  sum(CASE WHEN v.voucher_type = 'CREDIT_CAMPAIGN' THEN -v.amount ELSE 0 END) as credit_campaign,
  sum(CASE WHEN v.voucher_type = 'CREDIT_NOTE' THEN -v.amount ELSE 0 END) as credit_note
  FROM postgres.voucher v 
  GROUP BY v.order_id
) vou on vou.order_id = co.id

/*Get Cancellation reason*/
LEFT JOIN
(
select 
  oc.order_id,
  ocr.reason as cancellation_reason
 from ""postgres.order_cancellation"" oc
 LEFT JOIN ""postgres.order_cancellation_reason"" ocr ON oc.order_cancellation_reason_id=ocr.id
) can on can.order_id=co.id"	READY
210	2015-04-24 18:19:18	"1288893647"	true	2015-09-09 12:36:34	bi.delivery_tracking		"CREATE VIEW bi.delivery_tracking
as

SELECT 
	row_number() over(partition by order_id,tracking_number order by date_created desc) as rank,
	id,
	date_created,
	tag,
	slug,
	active,
	order_id,
	parseTimestamp( created_at, 'yyyy-MM-dd HH:mm:ss.S' ) created_at,
	parseTimestamp( updated_at, 'yyyy-MM-dd HH:mm:ss.S' ) updated_at,
	delivery_time,
	shipment_type,
	tracked_count,
	tracking_number,
	origin_country_iso3,
	shipment_package_count
FROM raw.delivery_tracking"	READY
298	2015-04-24 18:20:03	"1112787778"	true	2015-04-24 18:20:03	tableau.ops_999996_bookings		"CREATE view tableau.ops_999996_bookings
as 
select
sm.article_id,
a.article_ean,
sm.date_stock_booked,
sm.stock_booked,
sm.stock_booking_packing_slip_number,
min(a.article_sales_price_de) as article_sales_price_de,
min(a.article_cost) as article_cost
FROM bi.stock_booked sm
join bi.article a
on a.article_id = sm.article_id
WHERE supplier_id = '999996'
group by 1,2,3,4,5"	READY
303	2015-04-24 18:20:07	"1112787783"	true	2015-04-24 18:20:07	ml.project_outfit_customers_brands		"CREATE VIEW ml.project_outfit_customers_brands AS
SELECT 
	co.customer_id,
	coa.article_id,
	a.article_brand
FROM bi.customer_order AS co
INNER JOIN bi.customer_order_articles AS coa
	ON co.order_id = coa.order_id
INNER JOIN bi.article AS a
	ON coa.article_id = a.article_id
WHERE order_article_state = 'Kept'"	READY
196,625	2015-06-01 15:26:13	"1288891705"	true	2015-09-09 12:22:22	tableau.mkt_crm_club_customers		"CREATE VIEW tableau.mkt_crm_club_customers 
AS

SELECT
  cu.customer_id,
  cu.new_stylist_id as stylist_id,
  cu.first_name,
  cu.last_name,
  cu.phone_number,
  cu.email,
  cu.token,
  cu.default_domain,
  cu.subscribe_status,
  cu.subscribed_to_sms,
  CASE WHEN cu.gender = 'Male' THEN 'Herr' ELSE 'Frau' END as anrede,
  cu.formal as du_sie,
  case
    when cu.gender= 'Male' THEN 'Lieber'
    when cu.gender= 'Female' THEN 'Liebe'
  end AS ""begruessung"",
  co.articles_kept,
  co.completed_orders,
  co.billing_total,
  co.billing_recieved_total,
  co.first_order_date,
  co.last_order_date,
  co.avg_billing_total,
  co.last_delivery_date,
  co.nb_orders,
  clo.articles_kept_club,
  clo.nb_club_orders,
  clo.completed_orders_club,
  clo.billing_total_club,
  clo.billing_recieved_total_club,
  clo.avg_billing_total_club,
  clo.first_order_date_club,
  clo.last_order_date_club,
  clo.last_delivery_date_club,
  cu.club_membership_type,
  cu.club_customer_feedback,
  cu.date_first_club_box,
  cu.club_member_offer,
  sal.debt_collection,
  st.stylist,
  ci.city,
  ci.zip,
  ci.shipping_country,
  co.non_club_orders_picked,
  co.date_last_non_club_order,
  co.avg_basket_kept,
  CASE WHEN co.sales_sent=0 then 0 else co.sales_returned/co.sales_sent end as return_rate,
  CASE
        WHEN TIMESTAMPDIFF (SQL_TSI_DAY, co.last_order_date, CURDATE ()) <= 75 THEN 0
        ELSE 1
    END AS wo_order_last_75_days
    
FROM bi.customer cu
JOIN 
(
  SELECT
    customer_id,
    sum(articles_kept) articles_kept,
    COUNT(DISTINCT order_id) as nb_orders,
    COUNT(DISTINCT CASE WHEN sales_channel NOT LIKE 'club%' then order_id end) as non_club_orders_picked,
    max(DISTINCT CASE WHEN sales_channel NOT LIKE 'club%' then date_created end) as date_last_non_club_order,
    COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as completed_orders,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_total ELSE NULL END) as billing_total,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_received ELSE NULL END) as billing_recieved_total,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_total ELSE NULL END) /COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as avg_billing_total,
    SUM(CASE WHEN order_state= 'Completed' THEN sales_kept ELSE NULL END) /COUNT(DISTINCT order_id) as avg_basket_kept,
    SUM(CASE WHEN order_state= 'Completed' THEN sales_returned ELSE NULL END) as sales_returned,
    SUM(CASE WHEN order_state= 'Completed' THEN sales_sent ELSE NULL END) as sales_sent,
    min(date_created) as first_order_date,
    max(date_created) as last_order_date,
    max(date_shipped) as last_delivery_date
  FROM bi.customer_order
  GROUP BY 1
) co on cu.customer_id=co.customer_id
LEFT JOIN raw.customer_salesforce sal on sal.customer_id=cu.customer_id
LEFT JOIN bi.stylist st on st.stylist_id=cu.new_stylist_id
LEFT JOIN
(
  SELECT
    ab.customer_id,
    ab.shipping_city as city,
    ab.shipping_zip as zip,
    ab.shipping_country as shipping_country
  FROM
  (
    SELECT 
      co.customer_id,
      co.shipping_city,
      co.shipping_zip,
      co.shipping_country,
      rank() OVER (PARTITION BY co.customer_id ORDER BY co.date_created DESC) as rank
    FROM bi.customer_order co
    WHERE date_invoiced is not null
  ) ab
  WHERE rank = 1
) ci ON ci.customer_id = cu.customer_id
LEFT JOIN 
(
  SELECT
    customer_id,
    sum(articles_kept) articles_kept_club,
    COUNT(DISTINCT order_id) as nb_club_orders,
    COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as completed_orders_club,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_total ELSE NULL END) as billing_total_club,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_received ELSE NULL END) as billing_recieved_total_club,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_total ELSE NULL END) /COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as avg_billing_total_club,
    min(date_created) as first_order_date_club,
    max(date_created) as last_order_date_club,
    max(date_shipped) as last_delivery_date_club
  FROM bi.customer_order
  WHERE order_type = 'Outfittery Club Order'
  GROUP BY 1
) clo on cu.customer_id=clo.customer_id
WHERE cu.club_member= 'true'
AND cu.user_type != 'Test User'"	READY
851,986	2015-09-22 14:46:10	"1351631572"	true	2015-09-22 14:46:10	datamart.dim_opportunity		"/********************************************************************************
-- Author       Hemanth
-- Created      2015-07-01
-- Purpose      This view joins tables from raw schema, this view has information
                opportunities before it is converted.
-- Tables       raw.dim_customer_order, raw.dim_case,raw.customer_order_salesforce,
                raw.customer_order_details__audit_log
-------------------------------------------------------------------------------
-- Modification History

-- Date          Author      Description
-- 2015-09-16    Hemanth     Corrected the defintion for date_incoming, since task
                             manager has running with no problems
-- 2015-09-21    Hemanth     Renamed column names according to KPI bilble                             
**********************************************************************************/

CREATE VIEW ""datamart"".""dim_opportunity""
AS

SELECT 

  co.order_id as opp_id,
  dc.case_id,
  co.customer_id,
  
  co.order_type as opp_type,
  
  /*Address Details*/
  co.shipping_region as opp_shipping_region,
  co.shipping_city as opp_shipping_city,
  co.shipping_country as opp_shipping_country,
  co.shipping_zip as opp_shipping_zip,
  
  co.billing_region as opp_billing_region,
  co.billing_city as opp_billing_city,
  co.billing_country as opp_billing_country,
  co.billing_zip as opp_billing_zip,

  CASE WHEN co.date_stylist_picked IS NULL THEN co.cancellation_reason END AS opp_cancellation_reason,
  cos.ops_check as ops_check_status,
  CASE 
    WHEN co.date_stylist_picked IS NOT NULL THEN 'Converted'
    WHEN co.order_state=2048 OR co.date_cancelled IS NOT NULL THEN 'Cancelled'
    ELSE 'Open'
  END as opp_conversion_status,
  co.payment_type as opp_payment_type,
  co.box_type as opp_sales_channel_1,
  REPLACE(REPLACE(REPLACE(REPLACE(co.sales_channel,'WithoutDate',''),'WithDate',''),'WithCall',''),'WithoutCall','') as opp_sales_channel_2,
  
  /*All Dates related to opportunity*/
  co.date_created as date_opp_created,
  CASE
  	/* Orders with sales_channel = 'website' and websiteWithoutDateAndPendingConfirmation are not real orders, hence exclude date_created should be set to null */ 
    WHEN (co.sales_channel = 'website' AND co.order_state in ('Incoming', 'Cancelled') AND NOT (co.date_preview_created is not null OR cu.phone_number is not   null))
    OR co.sales_channel = 'websiteWithoutDateAndPendingConfirmation' THEN null
    WHEN co.sales_channel = 'website' AND co.date_preview_created > co.date_created THEN co.date_preview_created
    WHEN CAST(co.date_created as date)<'2015-07-21' THEN COALESCE(cod.date_incoming, co.date_created)
    /*Because of task manager job all old orders in state 4 is changed to 8*/
   	WHEN CAST(co.date_created as date)>='2015-07-21' THEN COALESCE(cod.date_incoming,date_incoming_no_call)
  END date_opp_confirmed,
  CASE WHEN co.date_stylist_picked IS NOT NULL THEN co.date_stylist_picked END AS date_opp_closed,
  co.date_cancelled as date_opp_cancelled,
  CASE WHEN cod.date_incoming IS NOT NULL OR cod.date_incoming_no_call IS NOT NULL THEN 1 ELSE 0 END AS opp_confirmation_status

FROM raw.dim_customer_order co
LEFT JOIN raw.dim_customer cu on cu.customer_id=co.customer_id
LEFT JOIN raw.dim_case dc on dc.order_id=co.order_id
LEFT JOIN raw.customer_order_salesforce cos ON cos.order_id=co.order_id
LEFT JOIN raw.customer_order_details__audit_log cod on cod.order_id = co.order_id"	READY
177	2015-04-24 18:18:04	"888646191"	true	2015-06-15 09:14:48	views.salesforce_account		"CREATE view views.salesforce_account
as
SELECT
	customer_id as ExternalCustomerid__c,
	salesforce_customer_id as Id,
	last_call_reactivation as Letzter_Anrufversuch_f_r_Reaktivierung__c,
	stylist_lead as Stylist_Lead__c,
	last_reactivation_result as Ergebnis_letzte_Reaktivierung_2__c,
	unsubscribe_sms as SMS_Unsubscribe__c,
	jeans_width as JeansWidth__c,
	customer_status as CustomerStatus__c,
	formal_or_informal as DuSie__c,
	unsubscribe_newsletter as UnsubscribedNL__c,
	'' as ReferralLink__c,
	bmi as BMI__c,
	club_membership_type as Outfittery_Club_Typ_der_Mitgliedschaft__c,
	club_member as Outfittery_Club_Mitglied__c,
	club_customer_feedback as Outfittery_Club_Kundenfeedback__c,
	club_member_offer as Outfittery_Club_Mitgliedschaft_angebot__c,
	last_updated_date as SystemModstamp
FROM raw.customer_salesforce"	READY
360,451	2015-07-21 17:34:48	"1214090201"	true	2015-08-25 16:17:56	ml.order_position_return_probability_estimation		"CREATE VIEW ml.order_position_return_probability_estimation
AS

WITH o_position AS
(
    SELECT
      coa_1.order_id,
      coa_1.order_position_id,
      coa_1.date_picked,
      coa_1.date_returned,
      coa_1.date_returned_online,
      coa_1.article_id,
      coa_1.articles_picked,
      coa_1.articles_returned,
      coa_1.articles_lost,
      coa_1.order_article_state_number,
      coa_1.articles_picked*coa_1.sales_in_local_currency/e.exchange_rate as sales_picked
    FROM raw.customer_order_articles coa_1
    LEFT JOIN raw.customer_order co on co.order_id=coa_1.order_id
    LEFT JOIN dwh.historical_exchange_rates e on e.currency_code = co.currency_code 
    AND COALESCE(cast(coa_1.date_picked as date),cast(co.date_invoiced as date)) = e.date
)

  SELECT 
  co.order_id, 
  co.shipping_country, 
  TIMESTAMPDIFF(SQL_TSI_YEAR, cast(cu.date_of_birth as date),co.date_created) as age_at_order_time,
  CASE  
    WHEN co.date_phone_call > '2012-05-10'  
      AND co.date_phone_call < TIMESTAMPADD(SQL_TSI_MONTH, 2, curdate())
      AND co.date_phone_call >= co.date_created 
      THEN 'Call Box'  
    WHEN co.sales_channel = 'clubWithCall' THEN 'Call Box' 
    ELSE 'No Call Box' 
  END as box_type,
  co.order_type,

  coa.date_picked, /*stylist picked date in amidala*/
  COALESCE(dd.date_shipped,co.date_shipped_internal) as date_shipped, /*date shipped is from doc_data*/
  coa.date_returned_online,
  COALESCE(cod.date_returned,co.date_returned) as date_returned,
  coa.date_returned as op_date_returned,
  COALESCE(cod.date_completed,co.date_completed) as date_completed,
  co.date_invoiced,
  coa.order_position_id,
  coa.sales_picked as item_value,
  op.articles_picked_sum as no_items_per_box,
  op.sales_picked_sum as box_value,
  CASE WHEN op.sales_picked_sum=0 THEN 0 ELSE sales_picked/sales_picked_sum END AS item_value_per_box,
  COALESCE(coa.articles_returned,coa.articles_lost,0) AS returned,
  it.category,
  it.product_group,
  /* Calculate the revenue state. If Estimated, then we will create a forecasted revenue */ 
  CASE
  	WHEN co.order_state = 'Completed'  
    	AND co.date_returned is null  
    	AND NOT COALESCE(co.billing_received_in_local_currency, arv.billing_received_arvato,0) > 1  
    	AND co.date_invoiced > TIMESTAMPADD(SQL_TSI_DAY, -70, CURDATE()) 
    THEN 1
    WHEN co.order_state in ('Returned', 'Completed') THEN 0 
    WHEN co.order_state = 'Cancelled' THEN 0 
    WHEN co.order_state_number < 512 AND TIMESTAMPDIFF(SQL_TSI_DAY, co.date_invoiced, CURDATE()) > 100 THEN 0 
    ELSE 1
  END as estimation_needed,
  
  CASE 
	WHEN preview_id IS NOT NULL THEN 1
	ELSE 0
  END AS has_preview,
  arv_2.billing_recieved,
  arv_2.date_paid

FROM o_position coa
LEFT JOIN raw.customer_order co ON Coa.order_id=co.order_id
LEFT JOIN raw.customer_order_details__audit_log cod on cod.order_id = co.order_id 
LEFT JOIN  
(
  SELECT 
    ss.order_id, 
    parsedate(min(ss.shipping_date), 'yyyyMMdd') as date_shipped 
  FROM raw.stock_shipped ss
  GROUP BY 1
) dd on dd.order_id = coa.order_id 
LEFT JOIN  
( 
  SELECT  
    ordernumber as order_id, 
    MIN(date_created) as date_arvato_paid, 
    SUM(amount) as billing_received_arvato 
  FROM dwh.arvato_payments ap 
  GROUP BY 1 
)arv on arv.order_id = co.order_id
LEFT JOIN  
(
    SELECT 
        co.order_id,
        min(coa.article_id) as min_article_id,
       /*takes arvato amount from dwh if payment type is arvato, for historical arvato customers billing recieved will be null*/
        avg(case when co.payment_type='Arvato' THEN arv_1.billing_received_arvato else co.billing_received_in_local_currency end) as billing_recieved,
        min(case when co.payment_type='Arvato' THEN arv_1.date_arvato_paid else co.date_paid end) as date_paid
    FROM raw.customer_order co 
    LEFT JOIN raw.customer_order_articles coa on coa.order_id=co.order_id
    LEFT JOIN  
    ( 
      SELECT  
        ordernumber as order_id, 
        MIN(date_created) as date_arvato_paid, 
        SUM(amount) as billing_received_arvato 
      FROM dwh.arvato_payments ap 
      GROUP BY 1 
   )arv_1 on arv_1.order_id = co.order_id 
   GROUP BY 1
) arv_2 on arv_2.order_id = co.order_id AND arv_2.min_article_id=coa.article_id
LEFT JOIN raw.customer cu on cu.customer_id = co.customer_id 
LEFT JOIN bi.item it on it.article_id=coa.article_id
LEFT JOIN 
(
  SELECT
    o_1.order_id,
    MIN(o_1.article_id) AS min_article_id,
    SUM(o_1.articles_picked) as articles_picked_sum,
    SUM(COALESCE(o_1.sales_picked,0)) as sales_picked_sum
  FROM o_position o_1
  GROUP BY 1
)op on op.order_id=coa.order_id
WHERE coa.order_article_state_number>=16 and coa.order_article_state_number<2048"	READY
306	2015-04-24 18:20:09	"1112787785"	true	2015-06-05 15:59:54	tableau.mkt_incoming_and_invoiced_orders_orders		"CREATE VIEW tableau.mkt_incoming_and_invoiced_orders_orders
AS
SELECT
co.order_id,
co.date_invoiced,
co.date_incoming,
co.customer_id,
CASE 
	WHEN co.order_type in ('Outfittery Club Order', 'First Order Follow-on', 'Repeat Order Follow-on') THEN '(not set)'
	WHEN mo.marketing_channel is null THEN '(not set)' ELSE mo.marketing_channel 
END as marketing_channel,
co.shipping_country,
co.sales_channel,
c.default_domain as domain,
COALESCE(co.order_type, 'First Order') as order_type,
co.box_type,
CASE 
	WHEN co.pre_pay = 1 AND co.payment_type = 'Pre-pay' THEN 'Pre-pay (Now)' 
	WHEN co.pre_pay = 1 THEN 'Pre-pay (Past)' 
	ELSE 'Never Pre-pay' 
END as pre_pay,
co.order_state,
co.revenue_state,
CASE 
	WHEN co.sales_channel_special = 'Outfit' AND CAST(co.date_incoming as date) < '2015-04-26' THEN 'Ready Outfit'
	ELSE 'No Ready Outfit'
END as ready_outfit,
CASE WHEN co.date_stylist_picked is not null THEN 1 ELSE 0 END as picked_by_stylist,
co.articles_sent,
co.articles_kept,
co.articles_picked,
co.sales_sent,
co.sales_kept,
co.sales_picked,
co.discount_total,
co.billing_total,
co.billing_vat,
co.billing_net_sales
FROM bi.customer_order co
JOIN bi.customer c on c.customer_id = co.customer_id
LEFT JOIN views.marketing_order mo on mo.order_id = co.order_id
WHERE co.is_real_order = 'Real Order'
AND co.date_incoming IS NOT NULL"	READY
308	2015-04-24 18:20:11	"1112787787"	true	2015-04-24 18:20:11	tableau.mkt_affiliate_report		"CREATE VIEW tableau.mkt_affiliate_report
AS
SELECT
	co.order_id,
	co.date_invoiced,
	CASE
		  WHEN co.date_invoiced is not null then 1
          ELSE 0
	END as count_invoiced,
	co.date_incoming,
	co.shipping_country,
	co.box_type,
	co.order_type,
	co.order_state,
	co.articles_sent,
	co.articles_kept,
	co.sales_sent,
	co.sales_kept,
	co.discount_total,
	co.billing_total,
	co.billing_vat,
	co.billing_net_sales,
	mo.marketing_channel
FROM ""bi.customer_order"" co
LEFT JOIN views.marketing_order mo ON mo.order_id = co.order_id
WHERE co.is_real_order = 'Real Order'
AND co.date_incoming IS NOT NULL
AND marketing_channel = 'affiliate'"	READY
688,135	2015-09-09 14:51:22	"1288907372"	true	2015-09-09 14:53:01	tableau.ops_address_check		"CREATE VIEW tableau.ops_address_check
as

SELECT 
  ca_1.*,
  co.order_id,
  co.shipping_first_name, 
  co.shipping_last_name, 
  co.shipping_co,
  co.shipping_street, 
  co.shipping_street_number, 
  co.shipping_zip,
  co.shipping_city,
  co.shipping_country,
  co.order_state
FROM raw.customer_address ca_1 
LEFT JOIN
(
    SELECT * FROM
  (
  SELECT
    rank() over(partition by customer_id order by date_created desc) as rank,
    order_id,
    customer_id,
    order_state,
    order_state_number,  
    shipping_first_name, 
    shipping_last_name, 
    shipping_co,
    shipping_street, 
    shipping_street_number, 
    shipping_zip,
    shipping_city,
    shipping_country
  FROM bi.customer_order
  )a WHERE rank=1
)co on co.customer_id=ca_1.customer_id
WHERE order_state_number> 16 and order_state_number<1024"	READY
720,896	2015-09-10 09:59:58	"1351409075"	true	2015-09-22 10:17:27	raw.desk_case_rep_view		"CREATE view raw.desk_case_rep_view
as
select  a.ndate,
		a.finance,
		a.datenschutz, 
		a.Lieferung_Ruckversand,
		a.Reklamation,
		a.Service,
		a.Storno_Adresanderung,
		a.Emarsys,
		a.new_cases,
		a.reopened_case,
		a.closed_case,
		formatDouble(cast(a.reopened_case as float)/cast (a.closed_case as float),'#,##0.00;(#,##0.00)') ||'%'
					 as	quote_reopened_closed_cases,
		t1_response,
		t1_resolve
from ""dwh.desk_case_report"" a;"	READY
851,987	2015-09-22 15:00:39	"1351631615"	true	2015-09-22 15:00:39	datamart.dim_order		"/**********************************************************************************************
-- Author       Hemanth
-- Created      2015-07-01
-- Purpose      This view joins tables from raw and datamartschema, this view has information
                when opportunities is converted by Stylist
-- Tables       raw.dim_customer_order,raw.dim_case,datamart.dim_opportunity,datamart.fact_order
--------------------------------------------------------------------------------------------------
-- Modification History

-- Date          Author      Description
-- 2015-09-16    Hemanth     Corrected the defintion for date_incoming, since task
                             manager has running with no problems
-- 2015-09-21    Hemanth     Renamed column names according to KPI bilble  
**************************************************************************************************/

CREATE VIEW datamart.dim_order
AS

SELECT

    co.order_id,
    dc_1.case_id,
    co.customer_id,
    co.parent_order_id,

    co.order_type,
    co.payment_type as payment_method,

    co.shipping_region AS order_shipping_region,
    co.shipping_city AS order_shipping_city,
    co.shipping_country AS order_shipping_country,
    co.shipping_zip AS order_shipping_zip,

    /*Address Details*/
    co.billing_region as order_billing_region,
    co.billing_city as order_billing_city,
    co.billing_country as order_billing_country,
    co.billing_zip as order_billing_zip,

    /*Order Process/Status*/
    CASE 
        WHEN fo.billing_total<=fo.billing_received THEN 'Closed'
        WHEN co.order_state=2048 THEN 'Cancelled'
        ELSE 'Open'
    END AS order_status,

    CASE
        WHEN fo.itb4ret=fo.itret THEN 'Fully'
        WHEN fo.itb4ret<>fo.itret AND fo.itret > 0 THEN 'Partly'
        WHEN fo.itb4ret = fo.itexp  THEN 'Not Cancelled'
    END AS order_return_status,

    CASE
        WHEN fo.itb4canc=fo.itcan THEN 'Fully'
        WHEN fo.itcan>=1 THEN 'Partly'
        ELSE 'No Returns yet'
    END AS order_cancellation_status,

    CASE 
        WHEN fo.billing_total<=fo.billing_received THEN 'Settled'
        ELSE 'Open'
    END AS status_balance,
  
    co.date_stylist_picked as date_order_created,
    co.date_invoiced as date_order_invoiced,
    dc.date_completed as date_order_completed,
    co.date_cancelled as date_order_cancelled,
    co.date_shipped as date_order_shipped,
    co.date_returned as date_order_returned,

    co.box_type as order_sales_channel_1,
    REPLACE(REPLACE(REPLACE(REPLACE(sales_channel,'WithoutDate',''),'WithDate',''),'WithCall',''),'WithoutCall','') as order_sales_channel_2,

    co.marketing_campaign as after_order_sales_channel

FROM raw.dim_customer_order co
LEFT JOIN datamart.fact_order fo on fo.order_id=co.order_id
LEFT JOIN raw.dim_case dc_1 on dc_1.order_id=co.order_id
LEFT JOIN 
(
    SELECT 
        fo_1.order_id,
            CASE
                WHEN fo_1.billing_total<=fo_1.billing_received AND co_1.date_returned<=date_amount_paid THEN date_amount_paid
                WHEN fo_1.billing_total<=fo_1.billing_received AND co_1.date_returned>=date_amount_paid THEN co_1.date_returned
                WHEN fo_1.itb4ret=fo_1.itret THEN co_1.date_returned
                ELSE NULL
            END
        AS date_completed
    FROM datamart.fact_order fo_1
    JOIN raw.dim_customer_order co_1 on co_1.order_id=fo_1.order_id
)dc on dc.order_id=co.order_id
WHERE co.date_stylist_picked IS NOT NULL"	READY
309	2015-04-24 18:20:12	"1112787788"	true	2015-04-24 18:20:12	tableau.ops_daily_shipped_and_returned_coa		"CREATE view tableau.ops_daily_shipped_and_returned_coa
as 
SELECT 
coa.order_id,
coa.article_id,
coa.date_shipped,
coa.date_returned,
co.shipping_country,
coa.stock_location_id,
coa.supplier_article_id
FROM bi.customer_order_articles coa
left join bi.customer_order co on coa.order_id = co.order_id"	READY
196,672	2015-06-11 18:08:32	"1293496307"	true	2015-09-10 15:16:40	bi.marketing_referral_brand_effect_attribution		"CREATE VIEW bi.marketing_referral_brand_effect_attribution
AS



SELECT 
	at.reporting_type,
   	at.""date"", 
   	at.domain,
	at.marketing_channel,

	SUM(CASE
		WHEN bf.marketing_channel_group = 'Paid' AND COALESCE(ab.incoming_orders_brand, 0) = 0 THEN at.incoming_orders_adjusted
		WHEN bf.marketing_channel_group = 'Paid' THEN at.incoming_orders_adjusted * bf.referral_factor * bf.brand_factor
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.incoming_orders_brand, 0) = 0 THEN 0
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.incoming_orders_paid, 0) = 0 THEN at.incoming_orders_adjusted
		WHEN bf.marketing_channel_group = 'Brand' THEN at.incoming_orders_adjusted-((ab.incoming_orders_paid_adjusted-ab.incoming_orders_paid)*(at.incoming_orders_adjusted/ab.incoming_orders_brand)) END) 
    as incoming_orders_adjusted,

	SUM(CASE
		WHEN bf.marketing_channel_group = 'Paid' AND COALESCE(ab.invoiced_orders_brand, 0) = 0 THEN at.invoiced_orders_adjusted
		WHEN bf.marketing_channel_group = 'Paid' THEN at.invoiced_orders_adjusted * bf.referral_factor * bf.brand_factor
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.invoiced_orders_brand, 0) = 0 THEN 0
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.invoiced_orders_paid, 0) = 0 THEN at.invoiced_orders_adjusted
		WHEN bf.marketing_channel_group = 'Brand' THEN at.invoiced_orders_adjusted-((ab.invoiced_orders_paid_adjusted-ab.invoiced_orders_paid)*(at.invoiced_orders_adjusted/ab.invoiced_orders_brand)) END) 
	as invoiced_orders_adjusted,

	SUM(CASE
		WHEN bf.marketing_channel_group = 'Paid' AND COALESCE(ab.sales_sent_brand, 0) = 0 THEN at.sales_sent_adjusted
		WHEN bf.marketing_channel_group = 'Paid' THEN at.sales_sent_adjusted * bf.referral_factor * bf.brand_factor
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.sales_sent_brand, 0) = 0 THEN 0
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.sales_sent_paid, 0) = 0 THEN at.sales_sent_adjusted
		WHEN bf.marketing_channel_group = 'Brand' THEN at.sales_sent_adjusted-((ab.sales_sent_paid_adjusted-ab.sales_sent_paid)*(at.sales_sent_adjusted/ab.sales_sent_brand)) END) 
	as sales_sent_adjusted,

	SUM(CASE
		WHEN bf.marketing_channel_group = 'Paid' AND COALESCE(ab.sales_kept_brand, 0) = 0 THEN at.sales_kept_adjusted
		WHEN bf.marketing_channel_group = 'Paid' THEN at.sales_kept_adjusted * bf.referral_factor * bf.brand_factor
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.sales_kept_brand, 0) = 0 THEN 0
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.sales_kept_paid, 0) = 0 THEN at.sales_kept_adjusted
		WHEN bf.marketing_channel_group = 'Brand' THEN at.sales_kept_adjusted-((ab.sales_kept_paid_adjusted-ab.sales_kept_paid)*(at.sales_kept_adjusted/ab.sales_kept_brand)) END) 
	as sales_kept_adjusted,

	SUM(CASE
		WHEN bf.marketing_channel_group = 'Paid' AND COALESCE(ab.billing_total_brand, 0) = 0 THEN at.billing_total_adjusted
		WHEN bf.marketing_channel_group = 'Paid' THEN at.billing_total_adjusted * bf.referral_factor * bf.brand_factor
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.billing_total_brand, 0) = 0 THEN 0
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.billing_total_paid, 0) = 0 THEN at.billing_total_adjusted
		WHEN bf.marketing_channel_group = 'Brand' THEN at.billing_total_adjusted-((ab.billing_total_paid_adjusted-ab.billing_total_paid)*(at.billing_total_adjusted/ab.billing_total_brand)) END) 
	as billing_total_adjusted,

	SUM(CASE
		WHEN bf.marketing_channel_group = 'Paid' AND COALESCE(ab.billing_net_sales_brand, 0) = 0 THEN at.billing_net_sales_adjusted
		WHEN bf.marketing_channel_group = 'Paid' THEN at.billing_net_sales_adjusted * bf.referral_factor * bf.brand_factor
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.billing_net_sales_brand, 0) = 0 THEN 0
		WHEN bf.marketing_channel_group = 'Brand' AND COALESCE(ab.billing_net_sales_paid, 0) = 0 THEN at.billing_net_sales_adjusted
		WHEN bf.marketing_channel_group = 'Brand' THEN at.billing_net_sales_adjusted-((ab.billing_net_sales_paid_adjusted-ab.billing_net_sales_paid)*(at.billing_net_sales_adjusted/ab.billing_net_sales_brand)) END) 
	as billing_net_sales_adjusted

FROM bi.marketing_crm_attribution at
LEFT JOIN dwh.marketing_investor_reporting_brand_factors bf ON bf.domain=at.domain AND bf.marketing_channel=at.marketing_channel
LEFT JOIN
(
  SELECT 
	at.reporting_type,
	at.""date"", 
	at.domain, 

	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.incoming_orders_adjusted * bf.referral_factor * bf.brand_factor ELSE null END) as incoming_orders_paid_adjusted,
	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.incoming_orders_adjusted ELSE null END) as incoming_orders_paid,
	SUM(CASE WHEN bf.marketing_channel_group = 'Brand' THEN at.incoming_orders_adjusted ELSE null END) as incoming_orders_brand,
	SUM(at.incoming_orders_adjusted) as incoming_orders_total,

	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.invoiced_orders_adjusted * bf.referral_factor * bf.brand_factor ELSE null END) as invoiced_orders_paid_adjusted,
	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.invoiced_orders_adjusted ELSE null END) as invoiced_orders_paid,
	SUM(CASE WHEN bf.marketing_channel_group = 'Brand' THEN at.invoiced_orders_adjusted ELSE null END) as invoiced_orders_brand,
	SUM(at.invoiced_orders_adjusted) as invoiced_orders_total,

	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.sales_sent_adjusted * bf.referral_factor * bf.brand_factor ELSE null END) as sales_sent_paid_adjusted,
	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.sales_sent_adjusted ELSE null END) as sales_sent_paid,
	SUM(CASE WHEN bf.marketing_channel_group = 'Brand' THEN at.sales_sent_adjusted ELSE null END) as sales_sent_brand,
	SUM(at.sales_sent_adjusted) as sales_sent_total,

	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.sales_kept_adjusted * bf.referral_factor * bf.brand_factor ELSE null END) as sales_kept_paid_adjusted,
	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.sales_kept_adjusted ELSE null END) as sales_kept_paid,
	SUM(CASE WHEN bf.marketing_channel_group = 'Brand' THEN at.sales_kept_adjusted ELSE null END) as sales_kept_brand,
	SUM(at.sales_kept_adjusted) as sales_kept_total,

	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.billing_total_adjusted * bf.referral_factor * bf.brand_factor ELSE null END) as billing_total_paid_adjusted,
	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.billing_total_adjusted ELSE null END) as billing_total_paid,
	SUM(CASE WHEN bf.marketing_channel_group = 'Brand' THEN at.billing_total_adjusted ELSE null END) as billing_total_brand,
	SUM(at.billing_total_adjusted) as billing_total_total,

	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.billing_net_sales_adjusted * bf.referral_factor * bf.brand_factor ELSE null END) as billing_net_sales_paid_adjusted,
	SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.billing_net_sales_adjusted ELSE null END) as billing_net_sales_paid,
	SUM(CASE WHEN bf.marketing_channel_group = 'Brand' THEN at.billing_net_sales_adjusted ELSE null END) as billing_net_sales_brand,
	SUM(at.billing_net_sales_adjusted) as billing_net_sales_total

  FROM bi.marketing_crm_attribution at
  LEFT JOIN dwh.marketing_investor_reporting_brand_factors bf ON bf.domain=at.domain AND bf.marketing_channel=at.marketing_channel
  GROUP BY 1,2,3
) ab on ab.""date""=at.""date"" AND ab.domain=at.domain AND ab.reporting_type=at.reporting_type
GROUP BY 1,2,3,4"	READY
688,134	2015-09-09 14:18:26	"1288906861"	true	2015-09-09 14:18:26	raw.customer_address		"create view raw.customer_address
as

select 
	ca.customer_addresses_id as customer_id,
	ca.address_id,
	ad.first_name,
	ad.last_name,
	ad.co,
	ad.street,
	ad.street_number,
	ad.city,
	ad.zip,
	ad.country,
	ad.active,
	ad.default_address
from ""postgres.customer_address"" ca
LEFT JOIN ""postgres.address"" ad on ca.address_id=ad.id"	READY
374	2015-04-24 18:23:47	"1112787850"	true	2015-04-24 18:23:47	ml.article_age_distribution		"CREATE VIEW ml.article_age_distribution AS
SELECT 
	am.article_id,
    f.molor_mean_age,
    f.molor_stddev_age,
    f.model_mean_age,
    f.model_stddev_age,
    f.brand_mean_age,
    f.brand_stddev_age
FROM
(SELECT
    p.molor_id,
    AVG(p.customer_age) OVER (PARTITION BY p.molor_id) AS molor_mean_age,
    STDDEV_SAMP(p.customer_age) OVER (PARTITION BY p.molor_id) AS molor_stddev_age,
    AVG(p.customer_age) OVER (PARTITION BY p.model_id) AS model_mean_age,
    STDDEV_SAMP(p.customer_age) OVER (PARTITION BY p.model_id) AS model_stddev_age,
    AVG(p.customer_age) OVER (PARTITION BY p.brand) AS brand_mean_age,
    STDDEV_SAMP(p.customer_age) OVER (PARTITION BY p.brand) AS brand_stddev_age,
	ROW_NUMBER() OVER (PARTITION BY p.molor_id ORDER BY p.molor_id DESC) AS rn
FROM
(SELECT
	a.article_id,
    m.molor_id,
    c.customer_age,
    a.article_brand AS brand,
    a.article_model_id AS model_id
FROM bi.article AS a
LEFT JOIN bi.customer_order_articles AS coa
	ON a.article_id = coa.article_id
LEFT JOIN bi.customer_order AS co
	ON coa.order_id = co.order_id
LEFT JOIN bi.customer AS c
	ON co.customer_id = c.customer_id
LEFT JOIN ml.article_molor AS m
	ON m.article_id = a.article_id
WHERE coa.articles_kept > 0) AS p) AS f
JOIN ml.article_molor AS am
	ON am.molor_id = f.molor_id
WHERE f.rn = 1"	READY
851,988	2015-09-22 15:01:39	"1351631645"	true	2015-09-22 15:01:39	datamart.dim_case		"/**********************************************************************************************
-- Author       Hemanth
-- Created      2015-07-01
-- Purpose      This view joins tables from raw and datamartschema, this view has information
                about every case created by customer.
-- Tables       datamart.dim_opportunity,datamart.dim_order,raw.customer,raw.dim_case
--------------------------------------------------------------------------------------------------
-- Modification History

-- Date          Author      Description
-- 2015-09-16    Hemanth     Added Headers to view
-- 2015-09-21    Hemanth     Renamed column names according to KPI bilble  
**************************************************************************************************/

CREATE VIEW datamart.dim_case
AS

WITH c_order AS 
(
    SELECT 
    RANK() OVER(PARTITION BY op.customer_id ORDER BY op.date_opp_created DESC) AS ""opportunity_rank"", 
    op.opp_id,
    op.case_id,
    op.customer_id, 
    co.parent_order_id, 
    op.opp_sales_channel_1,
    op.opp_sales_channel_2,
    op.date_opp_created, 
    co.date_order_created, 
    op.date_opp_cancelled, 
    co.date_order_completed,
    cu.date_of_birth,
    op.opp_shipping_region, 
    op.opp_shipping_city, 
    op.opp_shipping_zip,
    op.opp_shipping_country,
    op.opp_billing_region, 
    op.opp_billing_city, 
    op.opp_billing_zip,
    op.opp_billing_country
  FROM datamart.dim_opportunity op 
  LEFT JOIN datamart.dim_order co on co.order_id=op.opp_id
  LEFT JOIN raw.customer cu on cu.customer_id=op.customer_id  
  )

SELECT

  ac.case_id,
  a.customer_id,
  
  ac.case_no,
  CASE 
    WHEN ac.case_no=1 then 'First Case'  
    ELSE 'Repeat Case'  
  END AS case_type,
   
  d.opp_shipping_region as case_shipping_region,
  d.opp_shipping_city as case_shipping_city,  
  d.opp_shipping_zip as case_shipping_zip,
  d.opp_shipping_country as case_shipping_country,

  d.opp_billing_region as case_billing_region,
  d.opp_billing_city as case_billing_city,  
  d.opp_billing_zip as case_billing_zip,
  d.opp_billing_country as case_billing_country,
  
  d.opp_sales_channel_1 as case_sales_channel_1,
  d.opp_sales_channel_2 as case_sales_channel_2,

  CASE   
    WHEN c.nb_orders=c.nb_cancel_orders THEN '1'  
    ELSE '0'  
  END AS case_cancellation_status,
  CASE
    WHEN d.date_order_completed IS NOT NULL THEN 'Closed'
    WHEN d.date_opp_cancelled IS NULL AND d.date_order_created IS NULL THEN 'Open Opportunity'
    WHEN (d.date_order_completed IS NULL OR d.date_opp_cancelled IS NULL) AND d.date_order_created IS NOT NULL THEN 'Open Order' 
    WHEN c.nb_orders=c.nb_cancel_orders OR d.date_opp_cancelled IS NOT NULL THEN 'Cancelled'
  END AS case_status,
  
  ac.case_date_created as date_case_created,
  TIMESTAMPDIFF(SQL_TSI_YEAR, cast(a.date_of_birth as date),cast(ac.case_date_created as date)) as case_customer_age,  
   
  CASE 
    WHEN e.parent_order_id IS NOT NULL or a.parent_order_id IS NOT NULL THEN 'True'
    ELSE 'False' 
  END AS has_follow_on
  
FROM 
(
	SELECT 
		case_id,
		case_date_created,
		case_no
	FROM raw.dim_case
	WHERE case_id=89796654
	GROUP BY 1,2,3
)ac 
LEFT JOIN c_order a on ac.case_id=a.case_id
/*This join gets number of orders created and cancelled*/  
LEFT JOIN   
(  
 SELECT   
  customer_id,  
  count(*) AS nb_orders,  
  COUNT(DISTINCT case when date_opp_cancelled IS NULL then opp_id else null end) nb_cancel_orders 
 FROM c_order  
 GROUP BY 1
)c on c.customer_id=a.customer_id 
  
LEFT JOIN  
(  
 SELECT  
  customer_id,
  MAX(CASE WHEN opportunity_rank=1 THEN opp_sales_channel_1 END) AS opp_sales_channel_1,
  MAX(CASE WHEN opportunity_rank=1 THEN opp_sales_channel_2 END) AS opp_sales_channel_2,
  MAX(CASE WHEN opportunity_rank=1 THEN opp_shipping_region END) AS opp_shipping_region, 
  MAX(CASE WHEN opportunity_rank=1 THEN opp_shipping_city END) AS opp_shipping_city, 
  MAX(CASE WHEN opportunity_rank=1 THEN opp_shipping_country END) AS opp_shipping_country, 
  MAX(CASE WHEN opportunity_rank=1 THEN opp_shipping_zip END) AS opp_shipping_zip,
  MAX(CASE WHEN opportunity_rank=1 THEN opp_billing_region END) AS opp_billing_region, 
  MAX(CASE WHEN opportunity_rank=1 THEN opp_billing_city END) AS opp_billing_city, 
  MAX(CASE WHEN opportunity_rank=1 THEN opp_billing_country END) AS opp_billing_country, 
  MAX(CASE WHEN opportunity_rank=1 THEN opp_billing_zip END) AS opp_billing_zip,
  MAX(CASE WHEN opportunity_rank=1 THEN date_order_created END) AS date_order_created,
  MAX(CASE WHEN opportunity_rank=1 THEN date_order_completed END) AS date_order_completed,
  MAX(CASE WHEN opportunity_rank=1 THEN date_opp_cancelled END) AS date_opp_cancelled
 FROM c_order
 GROUP BY 1
)d on d.customer_id=a.customer_id

LEFT JOIN  
(  
  SELECT   
    distinct c_2.parent_order_id  
  FROM c_order c_2 
  GROUP BY 1
)e ON e.parent_order_id=a.opp_id
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19"	READY
248	2015-04-24 18:19:33	"1367726810"	true	2015-04-24 18:19:33	affilinet_adv.GetStatisticsPerPublisherQueryLastMonth		"create view affilinet_adv.GetStatisticsPerPublisherQueryLastMonth as
select * from ( call ""affilinet_adv.GetStatisticsPerPublisherQuery""(
    ""program_id"" => 5245,
    ""start_date"" => TIMESTAMPADD( SQL_TSI_MONTH, -1, curdate() ),
    ""end_date"" => curdate()
) )a"	READY
321	2015-04-24 18:20:45	"1112787800"	true	2015-04-24 18:20:45	tableau.ops_monthly_returns_swiss_shipment		"CREATE view tableau.ops_monthly_returns_swiss_shipment
as
SELECT 
	co.order_id,
	co.customer_id,
	co.date_shipped,
	co.order_state_number,
	log.track_and_trace_number,
	log.shipment_confirmation_date,
	log.return_date
FROM bi.customer_order co
LEFT JOIN 
(SELECT 
	order_id,
	cast(shipment_confirmation_date as date) as shipment_confirmation_date,
	cast(return_date as date) as return_date,
	track_and_trace_number
FROM raw.customer_order_articles_logistics log
) log on log.order_id = co.order_id
where 
co.order_state_number >=24
and co.shipping_country = 'CH'
and log.track_and_trace_number is not null"	READY
379	2015-04-24 18:24:00	"1228861719"	true	2015-08-28 11:41:18	tableau.finance_investor_report		"CREATE VIEW tableau.finance_investor_report
AS

SELECT 
 co.order_id,
 co.customer_id,
 co.date_invoiced as invoice_date_created,
 co.date_shipped,
 co.date_created,
 cu.date_created as customer_date_created,
 co.shipping_country,
 co.vat_percentage,
 co.currency_code,
 co.box_type,
 vco.total_amount_billed_discount_euro,
 vco.total_goodwill_credit_euro,
 vco.total_amount_paid_euro,
 co.order_type,
 co.date_paid as date_payed,
 vco.payment_method,
 co.date_returned,
 vco.first_saleschannel_completed,
 co.articles_sent,
 co.own_stock_articles_sent as articles_sent_os,
 co.partner_articles_sent as articles_sent_ps,
 co.articles_kept,
 co.own_stock_articles_kept as articles_kept_os,
 co.partner_articles_kept as articles_kept_ps,
 co.cost_sent as total_basket_purchase_price,
 co.partner_cost_sent as total_amount_basket_purchase_gross_partner,
 co.own_stock_cost_sent as total_amount_basket_purchase_gross_own,
 co.sales_sent as total_basket_retail_price,
 co.partner_sales_sent as total_amount_basket_retail_gross_partner,
 co.own_stock_sales_sent as total_amount_basket_retail_gross_own,
 op.retoure_value_purchase_price,
 op.return_purchase_gross_partner,
 op.return_purchase_gross_own,
 op.retoure_value,
 op.return_retail_gross_partner,
 op.return_retail_gross_own,
 op.gross_lost_purchase,
 op.gross_lost_purchase_partner,
 op.gross_lost_purchase_own,
 op.gross_lost_retail,
 op.gross_lost_retail_partner,
 op.gross_lost_retail_own,
 arv.paid_to_arvato,
 arv.arvato_paid_date,
 ca.discount_code as campaign_code,
 ca.campaign_title,
 ca.discount_currency as campaign_currency
FROM bi.customer_order co
JOIN views.customer_order vco on vco.id = co.order_id
JOIN bi.customer cu on cu.customer_id = co.customer_id
JOIN 
(
 SELECT
  op.order_id,
  SUM(op.cost_returned) retoure_value_purchase_price,
  SUM(CASE WHEN op.stock_location_id <> 2 THEN op.cost_returned ELSE 0 END)  as return_purchase_gross_partner,
  SUM(CASE WHEN op.stock_location_id = 2 THEN op.cost_returned ELSE 0 END) as return_purchase_gross_own,
  SUM(op.sales_returned) retoure_value,
  SUM(CASE WHEN op.stock_location_id <> 2 THEN op.sales_returned ELSE 0 END) as return_retail_gross_partner,
  SUM(CASE WHEN op.stock_location_id = 2 THEN op.sales_returned ELSE 0 END) as return_retail_gross_own,
  SUM(op.cost_lost) gross_lost_purchase,
  SUM(CASE WHEN op.stock_location_id <> 2 THEN op.cost_lost ELSE 0 END)  as gross_lost_purchase_partner,
  SUM(CASE WHEN op.stock_location_id = 2 THEN op.cost_lost ELSE 0 END) as gross_lost_purchase_own,
  SUM(op.sales_lost) gross_lost_retail,
  SUM(CASE WHEN stock_location_id <> 2 THEN op.sales_lost ELSE 0 END) as gross_lost_retail_partner,
  SUM(CASE WHEN stock_location_id = 2 THEN op.sales_lost ELSE 0 END) as gross_lost_retail_own
 FROM bi.customer_order_articles op
 GROUP BY 1
) op on op.order_id=co.order_id
LEFT JOIN raw.discount_campaigns ca on ca.campaign_id = co.campaign_id
LEFT JOIN
(
 SELECT 
  ordernumber,
  sum(amount) as paid_to_arvato,
  max(cast(date_created as date)) as arvato_paid_date
 FROM views.arvatopayments
 group by 1
) arv on arv.ordernumber = co.order_id
WHERE co.date_invoiced >= '2013-01-01'
AND co.is_real_order = 'Real Order'
AND co.order_state_number <= 1024"	READY
376	2015-04-24 18:23:51	"1112787852"	true	2015-07-31 14:49:56	tableau.mkt_2nd_step_conversion_report		"CREATE VIEW tableau.mkt_2nd_step_conversion_report
AS

SELECT
	co.order_id,
	CASE 
		WHEN co.date_stylist_picked is not null 
			AND co.order_state_number >= 16
			AND co.order_state_number < 2048
		THEN 1
		ELSE COALESCE(ssf.conversion_rate, 0)
	END as processed_order,
	CASE 
		WHEN co.date_stylist_picked is not null 
			AND co.order_state_number >= 16
			AND co.order_state_number < 2048
		THEN co.order_id
		ELSE null
	END as processed_order_id,
	co.order_state,
	co.shipping_country,
	co.order_type,
	co.payment_type,
	co.box_type || CASE WHEN co.pre_pay = 1 THEN ' Pre-pay' ELSE '' END as box_type,
	CASE 
		WHEN co.order_type in ('Outfittery Club Order', 'First Order Follow-on', 'Repeat Order Follow-on') THEN '(not set)'
		WHEN mo.marketing_channel is null THEN '(not set)' ELSE mo.marketing_channel 
	END as marketing_channel,
	co.sales_channel,
	co.date_incoming,
	co.date_phone_call,
	cu.age_group,
	cu.customer_age
FROM bi.customer_order co
LEFT JOIN bi.customer_order_2nd_step_conversion_forecast ssf on ssf.box_type = co.box_type AND ssf.pre_pay = co.pre_pay AND ssf.days_from_incoming = TIMESTAMPDIFF(SQL_TSI_DAY, date_incoming, CURDATE())
LEFT JOIN 
(
	SELECT 
		order_id, 
		marketing_channel
	FROM bi.marketing_contacts
	WHERE contact_count_desc = 1
) mo ON mo.order_id = co.order_id
LEFT JOIN bi.customer cu on cu.customer_id = co.customer_id
WHERE co.is_real_order = 'Real Order'
AND co.date_incoming > '2014'
AND co.shipping_country is not null"	READY
378	2015-04-24 18:23:56	"1112787854"	true	2015-04-24 18:23:56	tableau.bisdev_big_size_analysis		"CREATE view tableau.bisdev_big_size_analysis
AS
WITH cal AS
(
	SELECT
 		c.date,
 		a.shirt_size
 	FROM dwh.calendar c 
 	CROSS JOIN (SELECT DISTINCT shirt_size from views.customer WHERE shirt_size in ('XXL','3XL','4XL'))a
 	WHERE c.date>'2014' and c.date < CURDATE()
),
cust AS
(
	SELECT 
		c.customer_id,
		cast(c.date_created as date) as ""date"",
		c.shirt_size
	FROM views.customer c
	WHERE c.shirt_size in ('XXL','3XL','4XL')
	and user_type='Real User'
),
c_order as
(
	select
		co.id,
		co.customer_id,
		cu.shirt_size,
		cast(co.date_created as date) as date_created,
		cast(co.invoice_date_created as date) as ""date"",
		co.order_type,
		opk.order_value_sent_re,
		opk.order_value_kept_re,
		opk.order_value_returned_re
	FROM views.customer_order co
	LEFT JOIN views.customer cu on cu.customer_id=co.customer_id
	LEFT JOIN views.order_position_kpis opk on opk.order_id=co.id
	WHERE
	co.invoice_date_created is not null
	AND co.state >= 16
	                                            ),
op_feedback_shirts as
(
	SELECT 
		op.order_id,
		sum(case when op.feedback_Zu_Klein=1 then 1 else null end) as zu_klein,
		sum(case when op.feedback_Zu_Gross=1 then 1 else null end) as zu_gross
	FROM views.order_position op
	LEFT JOIN views.supplier_article_categories a on a.supplier_article_id=op.supplier_article_id
	AND a.cat2 in ('Shirts','Hemden')
	GROUP BY 1
)	
SELECT
	ca.""date"",
	ca.""shirt_size"",
	cu.new_customers,
	cu.nb_of_orders,
	/*customer orders with big sizes*/
	cart.orders_invoiced,
	cart.cart_value_first,
	cart.cart_value_repeat,
	cart.cart_value_follown,
	cart.order_value_sent_re,
	cart.order_value_kept_re,
	cart.order_value_returned_re,
	cart.rr_return,
	/*All Customer Order details without big sizes*/
	cn_no_big.new_customers_no_big,
	cn_no_big.nb_of_orders_no_big,
	cust_no_big.orders_invoiced_no_big_size,
	cust_no_big.cart_value_first_no_big_size,
	cust_no_big.cart_value_repeat_no_big_size,
	cust_no_big.cart_value_first_order_followon_no_big_size,
	cust_no_big.order_value_sent_re_no_big_size,
	cust_no_big.order_value_kept_re_no_big_size,
	cust_no_big.order_value_returned_re_no_big_size,
	rr_reason.zu_klein,
	rr_reason.zu_gross
FROM cal ca
/*number of new customers signed up / created*/
LEFT JOIN
(
	SELECT 
		c1.""date"",
		c1.shirt_size,
		count(distinct c1.customer_id) as new_customers,
		count(distinct co.id) as nb_of_orders
	FROM cust c1
	LEFT JOIN c_order co on co.customer_id=c1.customer_id
	GROUP BY 1,2
)cu ON cu.""date""=ca.""date"" and ca.shirt_size=cu.shirt_size
/*Cart Value of first,real repeat and follow on orders*/
LEFT JOIN
(
	SELECT
		co.""date"",
		co.shirt_size,
		COUNT(*) as orders_invoiced,
		COUNT(CASE WHEN co.order_type = 'first order' THEN co.id ELSE 0 END) as nb_of_first_orders,
		COUNT(CASE WHEN co.order_type = 'real repeat order' THEN co.id ELSE 0 END) as nb_of_repeat_orders,
		COUNT(CASE WHEN co.order_type = 'follow on order' THEN co.id ELSE 0 END) as nb_of_followon_orders,
		AVG(CASE WHEN co.order_type = 'first order' THEN order_value_kept_re ELSE 0 END) as cart_value_first,
		AVG(CASE WHEN co.order_type = 'real repeat order' THEN order_value_kept_re ELSE 0 END) as cart_value_repeat,
		AVG(CASE WHEN co.order_type = 'follow on order' THEN order_value_kept_re ELSE 0 END) as cart_value_follown,
		SUM(co.order_value_sent_re) as order_value_sent_re,
		SUM(co.order_value_kept_re) as order_value_kept_re,
		SUM(co.order_value_returned_re) as order_value_returned_re,
		AVG(case
			when co.order_value_sent_re=0 then 0 
			else co.order_value_returned_re/co.order_value_sent_re
		end) as rr_return
	FROM c_order co
	JOIN cust c on c.customer_id=co.customer_id
	GROUP BY 1,2
)cart on cart.""date""=ca.""date"" AND cart.shirt_size=cu.shirt_size
LEFT JOIN
(
	SELECT 
		cast(c1.""date_created"" as date) as datec,
		count(distinct c1.customer_id) as new_customers_no_big,
		count(distinct co.id) as nb_of_orders_no_big
	FROM views.customer c1
	LEFT JOIN views.customer_order co on co.customer_id=c1.customer_id
	WHERE c1.shirt_size not in ('XXL','3XL','4XL')
	GROUP BY 1
)cn_no_big on cn_no_big.""datec""=ca.""date""
/*customers with no big sizes-first,real repeat and follow on orders*/
LEFT JOIN
(
	SELECT
		co.""date"",
		COUNT(*) as orders_invoiced_no_big_size,
		COUNT(CASE WHEN co.order_type = 'first order' THEN co.id ELSE 0 END) as nb_of_first_orders_no_big_size,
		COUNT(CASE WHEN co.order_type = 'real repeat order' THEN co.id ELSE 0 END) as nb_of_repeat_orders_no_big_size,
		COUNT(CASE WHEN co.order_type = 'follow on order' THEN co.id ELSE 0 END) as nb_of_followon_orders_no_big_size,
		AVG(CASE WHEN co.order_type = 'first order' THEN order_value_kept_re ELSE 0 END) as cart_value_first_no_big_size,
		AVG(CASE WHEN co.order_type = 'real repeat order' THEN order_value_kept_re ELSE 0 END) as cart_value_repeat_no_big_size,
		AVG(CASE WHEN co.order_type = 'follow on order' THEN order_value_kept_re ELSE 0 END) as cart_value_first_order_followon_no_big_size,
		SUM(co.order_value_sent_re) as order_value_sent_re_no_big_size,
		SUM(co.order_value_kept_re) as order_value_kept_re_no_big_size,
		SUM(co.order_value_returned_re) as order_value_returned_re_no_big_size
	FROM c_order co
	WHERE co.shirt_size not in ('XXL','3XL','4XL')
	GROUP BY 1
)cust_no_big on cust_no_big.""date""=ca.""date""
/*share of return reason ""zu klein"" (too small) and ""zu gro"" (too big)*/
LEFT JOIN
(
	SELECT
		co.""date"",
		co.shirt_size,
		sum(zu_klein) as zu_klein,
		sum(zu_gross) as zu_gross
	FROM op_feedback_shirts ofd
	JOIN c_order co on co.id=ofd.order_id
	GROUP BY 1,2
)rr_reason on rr_reason.""date""=ca.""date"" AND rr_reason.shirt_size=cu.shirt_size
order by ca.date desc"	READY
380	2015-04-24 18:24:02	"1112787856"	true	2015-04-24 18:24:02	tableau.data_source_investor_report_ds		"CREATE VIEW tableau.data_source_investor_report_ds
AS
SELECT 
	co.order_id,
	co.customer_id,
	co.date_invoiced as invoice_date_created,
	co.date_shipped,
	co.date_created,
	cu.date_created as customer_date_created,
	co.shipping_country,
	co.vat_percentage,
	co.currency_code,
	co.box_type,
	vco.total_amount_billed_discount_euro,
	vco.total_goodwill_credit_euro,
	vco.total_amount_paid_euro,
	co.order_type,
	co.date_paid as date_payed,
	vco.payment_method,
	co.date_returned,
	vco.first_saleschannel_completed,
	CASE WHEN co.sales_sent > 0 THEN co.sales_returned / co.sales_sent ELSE 0 END as return_rate_3_weeks,
	co.articles_sent,
	co.own_stock_articles_sent as articles_sent_os,
	co.partner_articles_sent as articles_sent_ps,
	co.articles_kept,
	co.own_stock_articles_kept as articles_kept_os,
	co.partner_articles_kept as articles_kept_ps,
	co.cost_sent as total_basket_purchase_price,
	co.partner_cost_sent as total_amount_basket_purchase_gross_patner,
	co.own_stock_cost_sent as total_amount_basket_purchase_gross_own,
	co.sales_sent as total_basket_retail_price,
	co.partner_sales_sent as total_amount_basket_retail_gross_patner,
	co.own_stock_sales_sent as total_amount_basket_retail_gross_own,
	op.retoure_value_purchase_price,
	op.return_purchase_gross_patner,
	op.return_purchase_gross_own,
	op.retoure_value,
	op.return_retail_gross_patner,
	op.return_retail_gross_own,
	op.gross_lost_purchase,
	op.gross_lost_purchase_patner,
	op.gross_lost_purchase_own,
	op.gross_lost_retail,
	op.gross_lost_retail_patner,
	op.gross_lost_retail_own,
	arv.paid_to_arvato,
	arv.arvato_paid_date,
/*Campaign Details*/
	ca.discount_code as campaign_code,
	ca.campaign_title,
	ca.discount_currency as campaign_currency
FROM bi.customer_order co
JOIN views.customer_order vco on vco.id = co.order_id
JOIN views.customer cu on cu.customer_id = co.customer_id
/*Lost items are not broken out at a customer_order level so must get them from customer_order_articles*/
JOIN 
(
	SELECT 
		op.order_id,
		/*Return Purchase Price*/
		SUM(op.cost_returned) retoure_value_purchase_price,
		SUM(CASE WHEN op.stock_location_id <> 2 THEN op.cost_returned ELSE 0 END)  as return_purchase_gross_patner,
		SUM(CASE WHEN op.stock_location_id = 2 THEN op.cost_returned ELSE 0 END) as return_purchase_gross_own,
		/*Return Retail Price*/
		SUM(op.sales_returned) retoure_value,
		SUM(CASE WHEN op.stock_location_id <> 2 THEN op.sales_returned ELSE 0 END) as return_retail_gross_patner,
		SUM(CASE WHEN op.stock_location_id = 2 THEN op.sales_returned ELSE 0 END) as return_retail_gross_own,
		/*Lost Purchase Price*/
		SUM(op.cost_lost) gross_lost_purchase,
		SUM(CASE WHEN op.stock_location_id <> 2 THEN op.cost_lost ELSE 0 END)  as gross_lost_purchase_patner,
		SUM(CASE WHEN op.stock_location_id = 2 THEN op.cost_lost ELSE 0 END) as gross_lost_purchase_own,
		/*Lost Retail Price*/
		SUM(op.sales_lost) gross_lost_retail,
		SUM(CASE WHEN stock_location_id <> 2 THEN op.sales_lost ELSE 0 END) as gross_lost_retail_patner,
		SUM(CASE WHEN stock_location_id = 2 THEN op.sales_lost ELSE 0 END) as gross_lost_retail_own
	FROM bi.customer_order_articles op
	GROUP BY 1
) op on op.order_id=co.order_id
LEFT JOIN raw.discount_campaigns ca on ca.campaign_id = co.campaign_id
LEFT JOIN
(
	SELECT 
		ordernumber,
		sum(amount) as paid_to_arvato,
		max(cast(date_created as date)) as arvato_paid_date
	FROM views.arvatopayments
	group by 1
) arv on arv.ordernumber = co.order_id
WHERE co.date_invoiced >= '2013-01-01' 
AND co.is_real_order = 'Real Order' 
AND co.order_state_number <= 1024"	READY
851,989	2015-09-22 17:08:25	"1351806183"	true	2015-09-22 17:08:25	raw.fact_order_position		"/*******************************************************************
-- Author       Hemanth
-- Created      2015-07-01
-- Purpose      This view Gets the raw data from POSTGRES tables. This table hAS all  
--              articles picked in amidala
--Tables        order_position,supplier_article
-------------------------------------------------------------------------------
-- Modification History
--Date          Author      Description
--2015-09-16    Hemanth     Added Header to query
*******************************************************************/

CREATE VIEW raw.fact_order_position
AS

SELECT
  op.id AS order_position_id,
  op.order_id,
  op.state,
  op.quantity,
  op.article_id,
  op.stock_location_id,
  CASE WHEN op.state >= 16 AND op.state <= 2048 THEN op.quantity ELSE NULL END AS items_picked_wt_can,
  CASE WHEN op.state >= 16 AND op.state < 2048 THEN op.quantity ELSE NULL END AS items_picked,
  CASE WHEN op.state >= 128 AND op.state < 2048 THEN op.quantity ELSE NULL END AS items_sent,
  CASE WHEN op.state = 1024 THEN op.quantity ELSE NULL END AS items_kept,
  CASE WHEN op.state = 512  THEN op.quantity ELSE NULL END AS items_returned,
  CASE WHEN op.state = 1536 THEN op.quantity ELSE NULL END AS items_lost,
  CASE WHEN op.state = 2048 THEN op.quantity ELSE NULL END AS items_cancelled,
  ROUND(CAST(op.purchase_price AS DECIMAL),2) AS cost_in_eur,
  ROUND(CAST(op.retail_price AS DECIMAL),2) AS sales_in_local_currency
FROM postgres.order_position op
/* Need to join to supplier article to check if items are gifts. It needs to be a subselect due to duplicates in the table */
LEFT JOIN 
(
  SELECT
    sa.article_id
  FROM postgres.supplier_article sa 
  WHERE sa.supplier_id = 15
  GROUP BY sa.article_id
) sa on sa.article_id = op.article_id"	READY
382	2015-04-24 18:24:08	"1112787858"	true	2015-04-24 18:24:08	tableau.ops_orders_with_potential_returns_problems		"CREATE view tableau.ops_orders_with_potential_returns_problems
as
SELECT  
co.order_id,
co.customer_id,
co.articles_sent as total_articles,
co.order_state,
co.date_created,
co.date_invoiced,
co.shipping_country,
CASE WHEN co.articles_kept = co.articles_sent THEN 'Potential Issue' ELSE 'OK' END as problem_rating,
x.return_track_and_trace_number
FROM bi.customer_order co
LEFT JOIN 
(
	SELECT 
	dd.order_id,
	dd.return_track_and_trace_number
	FROM bi.customer_order_logistics dd
	GROUP BY 1,2
) x on x.order_id = co.order_id
WHERE co.date_invoiced > '2014-09%'
AND co.order_state_number > 24
AND co.articles_sent > 0"	READY
384	2015-04-24 18:24:11	"1112787859"	true	2015-04-24 18:24:11	tableau.ops_logistics_overview_order		"CREATE VIEW tableau.ops_logistics_overview_order AS

SELECT
	col.*
	/* CAST(COALESCE(date_stylist_picked, date_header_created, date_created) AS DATE) AS date_stylist_picked_or_created
	 COALESCE(orders_returned, orders_shipped) orders_shipped_and_returned	*/
FROM 
	bi.customer_order_logistics col
WHERE 
	CAST(COALESCE(date_stylist_picked, date_header_created, date_created) AS DATE) > TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE())"	READY
389	2015-04-24 18:24:18	"1112787863"	true	2015-04-24 18:24:18	sandbox.logistics_orders_by_day		"CREATE VIEW sandbox.logistics_orders_by_day AS

SELECT
	cal.date,
	data.logistics_order_processing_state,
	COUNT(*) orders
FROM
	dwh.calendar cal
	JOIN
	(
		SELECT
			col.order_id,
			CAST(col.date_created AS DATE) AS cal_date,
			'created' AS logistics_order_processing_state
		FROM 
			bi.customer_order_logistics col
		WHERE 
			CAST(col.date_created AS DATE) BETWEEN TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE()) AND CURDATE()
		
		UNION
		
		SELECT
			col.order_id,
			CAST(col.date_stylist_picked AS DATE),
			'stylist picked' 
		FROM 
			bi.customer_order_logistics col
		WHERE 
			CAST(col.date_stylist_picked AS DATE) BETWEEN TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE()) AND CURDATE()
		
		UNION
		
		SELECT
			col.order_id,
			CAST(col.date_header_created AS DATE),
			'header created' 
		FROM 
			bi.customer_order_logistics col
		WHERE 
			CAST(col.date_header_created AS DATE) BETWEEN TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE()) AND CURDATE()
		
		UNION
		
		SELECT
			col.order_id,
			CAST(col.date_imported AS DATE),
			'imported successfully' 
		FROM 
			bi.customer_order_logistics col
		WHERE 
			CAST(col.date_imported AS DATE) BETWEEN TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE()) AND CURDATE()
		
		UNION
		
		SELECT
			col.order_id,
			CAST(col.date_backordered AS DATE),
			'backordered' 
		FROM 
			bi.customer_order_logistics col
		WHERE 
			CAST(col.date_backordered AS DATE) BETWEEN TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE()) AND CURDATE()
		
		UNION
		
		SELECT
			col.order_id,
			CAST(col.date_picklist_created AS DATE),
			'picklist created' 
		FROM
			bi.customer_order_logistics col
		WHERE 
			CAST(col.date_picklist_created AS DATE) BETWEEN TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE()) AND CURDATE()
		
		UNION
		
		SELECT
			col.order_id,
			CAST(col.date_packed AS DATE),
			'packed' 
		FROM
			bi.customer_order_logistics col
		WHERE 
			CAST(col.date_packed AS DATE) BETWEEN TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE()) AND CURDATE()
		
		UNION
		
		SELECT
			col.order_id,
			CAST(col.date_shipped AS DATE),
			'shipped' 
		FROM
			bi.customer_order_logistics col
		WHERE 
			CAST(col.date_shipped AS DATE) BETWEEN TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE()) AND CURDATE()
		
		UNION
		
		SELECT
			col.order_id,
			CAST(col.date_returned AS DATE),
			'returned' 
		FROM
			bi.customer_order_logistics col
		WHERE 
			CAST(col.date_returned AS DATE) BETWEEN TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE()) AND CURDATE()
	) data
		ON cal.date = data.cal_date
/* 	WHERE cal.date BETWEEN TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE()) AND CURDATE()
	throws a DV error, so the date has to go into each part of UNION queries */
GROUP BY 1,2"	READY
390	2015-04-24 18:24:18	"1112787864"	true	2015-04-24 18:24:18	ml.project_outfit_candidate_molor		"CREATE VIEW ml.project_outfit_candidate_molor AS
SELECT
oc.outfit_candidate_id,
am.molor_id
FROM
""bi.customer_order"" co
LEFT JOIN ""bi.customer_order_articles"" coa ON coa.order_id = co.order_id
LEFT JOIN ""ml.project_outfit_candidate"" oc ON oc.origin_candidate_id = coa.outfit_id
LEFT JOIN ""ml.article_molor"" am ON am.article_id = coa.article_id
WHERE co.date_stylist_picked > '2014-01-01'
AND coa.outfit_id IS NOT NULL
AND coa.outfit_id IS NOT NULL
AND am.molor_id IS NOT NULL"	READY
391	2015-04-24 18:24:20	"1112787865"	true	2015-04-24 18:24:20	tableau.mkt_magazine_performance		"CREATE VIEW tableau.mkt_magazine_performance
AS
SELECT
	CAST(co.date_incoming as date) ""date"",
	co.customer_id,
	co.order_id,
	dc2.campaign_id,
	dc2.discount_code,
	dc2.campaign_title, 
	co.order_type,
	co.box_type,
	co.shipping_country,
	co.shipping_city,
	CASE WHEN co.date_incoming is not null THEN 1 ELSE 0 END as incoming_orders,
	CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 THEN 1 ELSE 0 END as invoiced_orders,
	co.sales_sent,
	co.sales_kept,
	co.billing_total,
	cl.marketing_cluster,
	cu.age_group,
	CASE WHEN cu.club_member = 'true' THEN 1 ELSE 0 END as club_member	
FROM bi.customer_order co 
RIGHT JOIN 
(
	SELECT 
		dc.campaign_id,
		dc.discount_code,
		dc.campaign_title 
	FROM ""raw.discount_campaigns"" dc
	WHERE dc.discount_code = 'MG15AA'
	OR dc.discount_code = 'MG15AAO'	
	OR dc.discount_code = 'MG15CL'	
	OR dc.discount_code = 'MG15CLP'
	OR dc.discount_code = 'MGL36'
	OR dc.discount_code = 'KTL34'
) dc2 ON dc2.campaign_id = co.campaign_id
LEFT JOIN bi.customer cu on cu.customer_id = co.customer_id
LEFT JOIN raw.customer_brand_cluster cl on cl.customer_id = co.customer_id
WHERE co.is_real_order = 'Real Order'
AND co.date_incoming is not null"	READY
72	2015-04-24 18:17:44	"1112787657"	true	2015-04-24 18:17:44	raw.customer_preview_articles		"CREATE VIEW raw.customer_preview_articles
AS
SELECT
	p.id as customer_preview_id,
	p.preview_id,
	p.customer_id,
	p.order_id,
	p.created_by_id as created_by_id,
	pp.id as customer_preview_position_id,
	pp.article_id,
	a.model_id as article_model_id,
	pp.group_id as outfit_id,
	p.date_created as date_created,
	pp.preview_positions_idx as article_count,
	CASE 
		WHEN p.state = 8 THEN 'Sent to Customer'
		WHEN p.state = 16 THEN 'Feedback from Customer'
		ELSE 'Unknown'
	END	as state,
	CASE 
		WHEN pp.variant = 1 THEN 'Positive'
		WHEN pp.variant = 0 THEN 'Neutral'
		WHEN pp.variant = -1 THEN 'Negative'
		ELSE 'Unknown'
	END as main_feedback,
	feedback.feedback_dont_like_the_brand,
	feedback.feedback_too_expensive,
	feedback.feedback_not_needed,
	feedback.feedback_too_simple,
	feedback.feedback_too_outrageous,
	feedback.feedback_dont_like_style,
	feedback.feedback_dont_like_the_colour,
	feedback.feedback_dont_like_the_pattern
FROM postgres.preview p 
JOIN postgres.preview_position pp on pp.preview_id = p.id
JOIN postgres.article a on a.id = pp.article_id
LEFT JOIN (
	SELECT
		fd.preview_position_id,
		/* NOTE: Feedback reasons are ordered by feedback_reason_id here to make it easier to compare to postgres.feedback_reason */
		sum(case when fd.feedback_reason_id = '380476' then 1 else null end)  as feedback_dont_like_the_brand,
		sum(case when fd.feedback_reason_id = '380479' then 1 else null end)  as feedback_too_expensive,
		sum(case when fd.feedback_reason_id = '380482' then 1 else null end)  as feedback_not_needed,
		sum(case when fd.feedback_reason_id = '539682' then 1 else null end)  as feedback_too_simple,
		sum(case when fd.feedback_reason_id = '1296049' then 1 else null end) as feedback_too_outrageous,
		sum(case when fd.feedback_reason_id = '1361878' then 1 else null end) as feedback_dont_like_style,
		sum(case when fd.feedback_reason_id = '1427266' then 1 else null end) as feedback_dont_like_the_colour,
		sum(case when fd.feedback_reason_id = '1539154' then 1 else null end) as feedback_dont_like_the_pattern
	FROM postgres.feedback fd
	WHERE fd.preview_position_id is not null
	GROUP BY fd.preview_position_id 
) feedback on feedback.preview_position_id = pp.id
WHERE p.class = 'com.ps.customer.preview.CustomerPreview'"	READY
73	2015-04-24 18:17:44	"1112787658"	true	2015-04-24 18:17:44	raw.previews		"CREATE VIEW raw.previews
AS
SELECT
	p.id as preview_id,
	p.name as preview_name,
	CASE WHEN p.name is not null THEN 'Topic Box' ELSE 'Showroom' END as preview_type,
	p.date_created as date_created
FROM postgres.preview p 
WHERE p.class = 'com.ps.customer.preview.Preview'"	READY
80	2015-04-24 18:17:46	"1112787661"	true	2015-04-24 18:17:46	ml.amidala_attributes		"CREATE VIEW ml.amidala_attributes AS
SELECT
att.id attribute_id,
att.identifier attribute_identifier,
prop.id property_id,
prop.identifier property_identifier,
att.name attribute_name
FROM
postgres.attribute att
JOIN postgres.property prop ON att.property_id = prop.id
WHERE att.active = 'true'"	READY
340	2015-04-24 18:22:21	"638185190"	true	2015-04-24 18:22:21	am.bad_apples_base		"CREATE VIEW am.bad_apples_base AS
SELECT * FROM ""am.base""
WHERE
product_group IS NULL
OR
article_category IS NULL
or
brand_erp IS NULL
or
pieces IS NULL
or
article_name IS NULL"	READY
84	2015-04-24 18:17:46	"1112787662"	true	2015-05-04 09:46:50	raw.customer_order_phone_dates		"CREATE VIEW raw.customer_order_phone_dates
AS
SELECT
	order_id,
	date_phone_call,
	date_created,
	rank() OVER(PARTITION BY order_id ORDER BY date_created) as phone_date_count,
	rank() OVER(PARTITION BY order_id ORDER BY date_created desc) as phone_date_count_desc
FROM
(
SELECT 
	CAST(al.persisted_object_id as long) as order_id,
	/*can be replaced once parsetimestamp problem is solved
	--PARSETIMESTAMP(SUBSTRING(al.new_value, 5, 30), 'MMM dd HH:mm:ss z yyyy') as date_phone_call,*/
	PARSETIMESTAMP(SUBSTRING(al.new_value, 5, 30), 'MMM dd HH:mm:ss ''CEST'' yyyy') as date_phone_call,
	MIN(al.date_created) as date_created
FROM postgres.audit_log al
WHERE al.property_name = 'phoneDate'
GROUP BY al.persisted_object_id, al.new_value
) x"	READY
753,664	2015-09-10 16:48:40	"1298625869"	true	2015-09-11 15:01:40	raw.desk_case_rep_KW_view		"CREATE view raw.desk_case_rep_KW_view
as
select  
		week(ndate) Week_no,	
		sum(a.finance) as Finance,
		sum(a.datenschutz) as datenschutz, 
		sum(a.Lieferung_Ruckversand) as Lieferung_Ruckversand,
		sum(a.Reklamation) as Reklamation,
		sum(a.Service) as Service,
		sum(a.Storno_Adresanderung) as Storno_Adresanderung,
		sum(a.Emarsys) as Emarsys,
		sum(a.new_cases) as new_cases,
		sum(a.reopened_case) as reopened_case,
		sum(a.closed_case) as closed_case
from ""dwh.desk_case_report"" a
group by week(ndate);"	READY
426,075	2015-08-06 09:36:13	"1122281137"	true	2015-08-06 09:44:40	sandbox.mkt_rt_performance_vs_plan		"CREATE VIEW sandbox.mkt_rt_performance_vs_plan
AS


/*This report only concerns invoiced orders*/
WITH act AS(
SELECT
	CAST(date_invoiced AS date) AS date_invoiced,
	CASE
		WHEN CAST(date_invoiced AS date) <= CURDATE() THEN 'Actual' 
		ELSE 'Forecast'
	END AS order_state,
	shipping_country,
	SUBSTRING(date_invoiced,1,4)||'-'||SUBSTRING(date_invoiced,6,2) as year_month, 
	COUNT(order_id) as invoiced_orders,
	SUM(CASE WHEN order_type = 'Outfittery Club Order' THEN 1 ELSE 0 END) as actual_invoiced_club_orders,
	SUM(CASE WHEN order_type = 'Repeat Order' THEN 1 ELSE 0 END) as actual_invoiced_repeat_orders,
	SUM(CASE WHEN order_type = 'Repeat Order' AND LOWER(sales_channel) not like '%app%' AND (LOWER(campaign_title) not like '%crm-magazin%' AND LOWER(campaign_title) not like '%crm magazin%' AND LOWER(campaign_title) not like '%magazin sommer%' OR campaign_title is null) THEN 1 ELSE 0 END)  as actual_invoiced_repeat_orders_other,
	SUM(CASE WHEN LOWER(sales_channel) like '%app%' THEN 1 ELSE 0 END) as actual_invoiced_app_orders,
	SUM(CASE WHEN LOWER(campaign_title) like '%crm-magazin%' OR LOWER(campaign_title) like '%crm magazin%' OR LOWER(campaign_title) like '%magazin sommer%' THEN 1 ELSE 0 END) as actual_invoiced_magazine_orders
FROM ""bi.customer_order"" cu
LEFT JOIN raw.discount_campaigns dc ON dc.campaign_id = cu.campaign_id
WHERE order_type IN ('Outfittery Club Order', 'Repeat Order')
AND is_real_order = 'Real Order'
AND date_invoiced is not null
AND order_state_number >= 16 
AND order_state_number < 2048
GROUP BY 1,2,3,4
)


SELECT
	fc.date_created,
	fc.country as country,
	SUM(CASE 
		WHEN fc.days_month_passed = 0 THEN null
		WHEN fc.days_month_passed < fc.month_days THEN CAST(mo.actual_invoiced_repeat_orders_month/fc.days_month_passed as decimal)
		ELSE act.actual_invoiced_repeat_orders_other
	END) AS real_repeat_orders,
	SUM(CASE 
		WHEN fc.days_month_passed = 0 THEN null
		ELSE act.actual_invoiced_club_orders
	END) AS club_orders,
	SUM(fc.daily_orders) as invoiced_order_goal,
	SUM(act.actual_invoiced_club_orders) as actual_club_repeat_orders,
	SUM(act.actual_invoiced_repeat_orders_other) as actual_invoiced_repeat_orders_other,
	SUM(actual_invoiced_magazine_orders) as actual_magazine_orders,
	SUM(actual_invoiced_app_orders) as 	actual_app_orders
FROM
(
	SELECT
		CAST(c.""date"" as date) as date_created,
		c.year_month,
		ab.month_days,
		ab.days_month_passed,
		ab.country,
		ab.daily_orders	
	FROM dwh.calendar c
	LEFT JOIN
	(
		SELECT
			go.year_month,
			go.country,
			ca.month_days,
			ca.days_month_passed,
			CAST(go.invoiced_order_forecast as decimal) / ca.month_days as daily_orders
		FROM dwh.retention_marketing_order_goals go
		LEFT JOIN
		(
			SELECT
				year_month,
				COUNT(day_of_month) as month_days,
				SUM(CASE WHEN ""date"" <= CURDATE() THEN 1 ELSE 0 END) AS days_month_passed
			FROM dwh.calendar
			GROUP BY 1 
		) ca ON go.year_month = ca.year_month
	) ab ON c.year_month = ab.year_month
	WHERE ""date"" >= '2015-01-01'
	AND daily_orders is not null
) fc 
LEFT JOIN act ON fc.date_created = act.date_invoiced AND fc.country = act.shipping_country
LEFT JOIN
(
	SELECT
		year_month,
		shipping_country,
		SUM(CASE WHEN order_state = 'Actual' THEN 1 ELSE 0 END) AS month_day_passed,
		SUM(actual_invoiced_club_orders) as actual_invoiced_club_orders_month,
		SUM(actual_invoiced_repeat_orders) as actual_invoiced_repeat_orders_month
	FROM act
	GROUP BY 1,2
) mo ON mo.year_month = fc.year_month AND fc.country = mo.shipping_country
GROUP BY 1,2"	READY
339	2015-04-24 18:22:17	"1389130336"	true	2015-09-29 12:35:37	tableau.sales_datasource		"CREATE VIEW ""tableau.sales_datasource"" 
AS

SELECT

  co.order_id,
  co.customer_id,
  co.parent_order_id,
  co.sales_channel,
  co.customer_message_content,
  co.sales_channel_special as saleschannel_special__c,
  co.order_state_number as customer_order_state,
  co.shipping_first_name,
  co.shipping_last_name,
  co.shipping_city,
  co.shipping_country,
  co.currency_code,
  co.date_created,
  co.date_incoming,
  co.date_phone_call as phone_date,
  co.date_invoiced,
  co.date_completed,
  co.date_paid,
  co.date_nps_submitted,
  co.nps_score,
  co.nps_customer_comment,
  co.order_type,
  co.box_type,
  co.order_state,
  co.kept_state,
  co.payment_type,
  co.revenue_state,
  co.is_real_order,
  co.cancellation_reason,
  
  fc.sales_kept_forecast,
  fc.sales_returned_forecast,
  fc.billing_total,
  fc.billing_net_sales,
  fc.billing_received,
  fc.discount_total,
  fc.discount_goodwill,
  fc.discount_marketing,
  fc.newcardrecommendation__c,
  fc.discount_paid_voucher,
  /*Arvato Results*/
  ar.responseCode_1 as arvato_response_code,
  ar.arvatoresult_1 as arvato_result,
  
  /*Customer Fields*/
  cu.phone_number,
  CASE WHEN cu.phone_number is null THEN false ELSE true END as has_phone_number,
  cu.vip_customer,
  cu.customer_age,
  cu.default_domain as default_page,
  cu.age_group_felt as perceived_customer_age,
  COALESCE(cu.age_group_felt,cu.age_group) as perceived_customer_age_2,
  cu.shirt_size,
  cu.trousers_size_width,
  cu.trousers_size_length,
  cu.club_member,
  cu.club_membership_type,
  cu.date_club_activated,
  cu.date_club_cancelled,
  fo.first_order_date,
  fo.first_order_date_completed,

  /*Stylist Information-Information is from salesforce (Will be replaced with postgres or dwh table)*/
  s.stylist as Name,
  s.role as stylist_role,
  s.team as user_role,
  s.stylist_original,
  s.balancer_enabled,
  s.call_group,
  s.stylist_group,
  
  /*Order Position Fields*/
  coa.article_id,
  coa.order_article_state_number as state,
  coa.stock_location_id,
  coa.date_picked,
  coa.date_shipped as op_date_shipped,
  coa.date_returned,
  coa.sales_picked,
  coa.sales_sent,
  coa.sales_kept,
  coa.sales_kept_est,
  coa.sales_returned,
  coa.sales_lost,
  coa.articles_picked,
  coa.articles_sent,
  coa.articles_kept,
  coa.articles_returned,
  coa.articles_lost,
  
  /*Feedback reasons based on warehouse or customer_feedback when returned online*/
  coa.feedback_dont_like_the_colour,
  coa.feedback_dont_like_the_brand,
  coa.feedback_dont_like_the_pattern,
  coa.feedback_too_outrageous,
  coa.feedback_too_simple,
  coa.feedback_not_needed,
  coa.feedback_too_tight,
  coa.feedback_too_big,
  coa.feedback_too_small,
  coa.feedback_too_short,
  coa.feedback_too_long,
  coa.feedback_too_wide,
  coa.feedback_too_expensive,
  coa.feedback_too_cheap,
  coa.feedback_too_low_quality,
  coa.feedback_comment as comment, /*this comment is from doc data returns files*/
  TIMESTAMPDIFF(SQL_TSI_DAY,cast(fc.last_date_incoming as date), cast(fc.last_date_completed as date)) as days_inc_comp,
  TIMESTAMPDIFF(SQL_TSI_DAY,cast(fc.last_date_incoming as date), cast(fc.last_date_picked as date))  as days_inc_pic,
  TIMESTAMPDIFF(SQL_TSI_DAY,cast(fc.last_date_picked as date), cast(fc.last_date_completed as date))  as days_pic_comp,

    /*Article Information (Zalando article info is missing for many articles)*/
  i.brand,
  i.item_no,
  i.ean,
  i.item_description,
  i.color,
  i.size,
  i.season,
  i.item_status,
  i.category,
  i.product_group,
  
  /*Salesforce Fields (Will be replaced soon to task_manager)*/
  co.not_reached as notReached__c,
  co.wrong_phone_number as Telefonnummer_Falsch__c,
  CASE 
    WHEN co.ops_check='DC' THEN 'Debt Collection'
    WHEN co.ops_check='CX' THEN 'Cancelled'
    WHEN co.ops_check='LD' THEN 'Late Delivery'
    WHEN co.ops_check='AP' THEN 'Advance Payment'
    WHEN co.ops_check='SF' THEN 'Suspended Fraud'
    WHEN co.ops_check IN ('Not Scored','NS') THEN 'Not Scored'
    WHEN co.ops_check='CA' THEN 'Critical Attribute'
    WHEN co.ops_check='BV > MV' THEN 'Basket Value>Maximum Value'
    ELSE co.ops_check 
  END AS ops_check,
  co.date_preview_created,
  co.given_to_debt_collection,
  co.new_phone_appointment,
  co.date_phone_call as date_phone_call_current,
  co.call_cancelled,
  co.inactive_reasons as inactivereason__c,
  
  /*SF Opportunity*/
  co.order_sales_stage,
  cos.dhl_return_next_steps as dhlreturnnextsteps__c,
  cos.refusual_comment as refusals_comment__c,
  cos.date_feedback_call,
  cos.feedback_status,
  cos.feedback_caller_id,
  cos.preview_not_liked,
  cos.date_last_reactivation_call_order,
  cos.nb_of_reactivation_calls_made,
  
  /*SF Account fields(will be replaced with task_manager*/
  cs.last_call_reactivation,
  cs.last_reactivation_result,
  cs.date_last_contacted,
  cs.stylist_lead,
  ta.nb_survey_sent,
  sac.category2, /*Will be replaced soon with ERP article model*/

  CASE
    WHEN co.shipping_country='CH' AND CAST(co.date_invoiced as date) BETWEEN '2014-11-01' AND '2015-03-30' AND art_a.articles_sent=art_a.articles_kept THEN 'Open CH Orders'
    ELSE NULL
  END AS open_ch_order

FROM bi.customer_order co
LEFT JOIN bi.customer cu on cu.customer_id=co.customer_id
LEFT JOIN 
(
	SELECT
	ROW_NUMBER() OVER(PARTITION BY order_id ORDER BY date_created DESC) as r_num,
	a.*
	FROM bi.customer_order_articles a
) coa on coa.order_id=co.order_id
LEFT JOIN bi.stylist s ON co.stylist_id = s.stylist_id
LEFT JOIN bi.item i on coa.article_id = i.article_id
LEFT JOIN bi.customer_order_salesforce cos on cos.order_id=co.order_id
LEFT JOIN raw.customer_salesforce cs on cs.customer_id=co.customer_id
LEFT JOIN views.supplier_article_categories sac ON sac.supplier_article_id = coa.supplier_article_id
LEFT JOIN views.arvatoresults ar on ar.order_id=co.order_id
LEFT JOIN
(
  SELECT 
    co.customer_id,
    min(co.date_created) as first_order_date,
    min(CASE WHEN co.order_state = 'Completed' THEN co.date_created ELSE null END) as first_order_date_completed
  FROM bi.customer_order co 
  GROUP BY co.customer_id
)fo on fo.customer_id = co.customer_id
LEFT JOIN
(
  SELECT 
    order_id,
    SUM(articles_sent) as articles_sent,
    SUM(articles_kept) as articles_kept
  FROM bi.customer_order_articles
  GROUP BY 1
)art_a on art_a.order_id=co.order_id
/*Join is on customer_order_articles, it created duplicates for each row*/
LEFT JOIN
(
    SELECT 
        co.order_id,
        CAST('1' AS integer) as row_num,
        min(coa.article_id) as min_article_id,
        avg(co.sales_kept) as sales_kept_forecast,
        avg(co.sales_returned) as sales_returned_forecast,
        avg(co.billing_total) as billing_total,
        avg(co.billing_net_sales) as billing_net_sales,
        max(co.date_incoming) as last_date_incoming, 
        max(co.date_completed) as last_date_completed,
        max(coa.date_picked) as last_date_picked,
        avg(co.billing_received) as billing_received,
        avg(discount_total) as discount_total,
        avg(discount_goodwill) as discount_goodwill,
        avg(discount_marketing) as discount_marketing,
        avg(discount_paid_voucher) as discount_paid_voucher,
        avg(cos_1.newcardrecommendation) as newcardrecommendation__c
    FROM bi.customer_order co 
    LEFT JOIN bi.customer_order_articles coa on coa.order_id=co.order_id
    LEFT JOIN raw.customer_order_salesforce cos_1 on cos_1.order_id=co.order_id
    GROUP BY 1
)fc on fc.order_id=co.order_id and fc.row_num=coa.r_num
/*Number of feedback mails sent*/
LEFT JOIN
(
    SELECT 
        opportunity_id,
        count(distinct opportunity_id) as nb_survey_sent
    FROM views.salesforce_task
    GROUP BY 1
) ta on ta.opportunity_id=cos.salesforce_order_id"	READY
851,979	2015-09-22 10:56:54	"1383765129"	true	2015-09-28 16:57:29	tableau.datamart_datasource		"CREATE VIEW tableau.datamart_datasource
AS

SELECT
  op.opp_id,
  op.case_id,
  op.customer_id,
  op.opp_type,
  op.opp_shipping_region,
  op.opp_shipping_city,
  op.opp_shipping_country,
  op.opp_shipping_zip,
  op.opp_billing_region,
  op.opp_billing_city,
  op.opp_billing_country,
  op.opp_billing_zip,
  op.opp_cancellation_reason,
  op.ops_check_status,
  op.opp_conversion_status,
  op.opp_payment_type,
  op.opp_sales_channel_1,
  op.opp_sales_channel_2,
  op.date_opp_created,
  op.date_opp_confirmed,
  op.date_opp_closed,
  op.date_opp_cancelled,
  op.opp_confirmation_status,

  ord.order_id,
  ord.parent_order_id,
  ord.order_type,
  ord.payment_method,
  ord.order_shipping_region,
  ord.order_shipping_city,
  ord.order_shipping_country,
  ord.order_shipping_zip,
  ord.order_billing_region,
  ord.order_billing_city,
  ord.order_billing_country,
  ord.order_billing_zip,
  ord.order_status,
  ord.order_return_status,
  ord.order_cancellation_status,
  ord.status_balance,
  ord.date_order_created,
  ord.date_order_invoiced,
  ord.date_order_completed,
  ord.date_order_cancelled,
  ord.date_order_shipped,
  ord.date_order_returned,
  ord.order_sales_channel_1,
  ord.order_sales_channel_2,
  ord.after_order_sales_channel,

  cu.customer_acquisition_channel_1,
  cu.customer_acquisition_channel_2,
  cu.customer_segment,
  cu.date_account_created,
  cu.customer_age,
  cu.customer_status,
  cu.has_phone_number,
  cu.has_email,
  cu.has_facebook,
  cu.has_linkedin,
  cu.has_xing,
  cu.is_club_customer,
  cu.domain_page,
  cu.user_type,
  
  ca.case_no,
  ca.case_type,
  ca.case_shipping_region,
  ca.case_shipping_city,
  ca.case_shipping_zip,
  ca.case_shipping_country,
  ca.case_billing_region,
  ca.case_billing_city,
  ca.case_billing_zip,
  ca.case_billing_country,
  ca.case_status,
  ca.case_sales_channel_1,
  ca.case_sales_channel_2,
  ca.case_cancellation_status,
  ca.date_case_created,
  ca.case_customer_age,
  ca.has_follow_on,

  fo.itb4canc,
  fo.itcan,
  fo.itb4ret,
  fo.itret,
  fo.estitret,
  fo.itexp,

  fo.gsb4canc_in_eur,
  fo.gscanc_in_eur,
  fo.gsb4ret_in_eur,
  fo.gret_in_eur,
  fo.ggood_in_eur,
  fo.estgret_in_eur,
  fo.est_goodwill_in_eur,
  fo.gsexp_in_eur,

  fo.nsb4canc_in_eur,
  fo.nscanc_in_eur,
  fo.nsb4ret_in_eur,
  fo.nret_in_eur,
  fo.ngood_in_eur,
  fo.estnret_in_eur,
  fo.estngood_in_eur,
  fo.nsexp_in_eur,

  fo.gsb4canc_in_local_currency,
  fo.gscanc_in_local_currency,
  fo.gsb4ret_in_local_currency,
  fo.gret_in_local_currency,
  fo.ggood_in_local_currency,
  fo.estgret_in_local_currency,
  fo.estggood_in_local_currency,
  fo.gsexp_in_local_currency,

  fo.nsb4canc_in_local_currency,
  fo.nscanc_in_local_currency,
  fo.nsb4ret_in_local_currency,
  fo.nret_in_local_currency,
  fo.ngood_in_local_currency,
  fo.estnret_in_local_currency,
  fo.estngood_in_local_currency,
  fo.nsexp_in_local_currency,

  fo.cogb4canc,
  fo.cogcanc,
  fo.cogb4ret,
  fo.cogret,
  fo.estcogret,
  fo.cogexp,

  fo.netdisc_in_local_currency,
  fo.netdisc_in_eur,
  fo.estnetdisc_in_local_currency,
  fo.estnetdisc_in_eur,

  fo.date_amount_paid,
  fo.billing_total,
  fo.billing_received,
  fo.billing_open,
  fo.billing_vat,
  fo.billing_net_sales
  
FROM datamart.dim_opportunity op
LEFT JOIN datamart.dim_order ord on ord.order_id=op.opp_id
LEFT JOIN datamart.dim_customer cu on cu.customer_id=op.customer_id
LEFT JOIN datamart.dim_case ca ON ca.case_id=op.case_id 
LEFT JOIN datamart.fact_order fo on fo.order_id=ord.order_id"	READY
358	2015-04-24 18:23:05	"1112787835"	true	2015-04-24 18:23:05	ml.molor_raw		"CREATE VIEW ml.molor_raw AS
SELECT
m.molor_id AS ""molor_id"",
MAX(m.article_id) AS ""article_id_arbitrary""
FROM ""ml.article_molor"" m
WHERE m.molor_id IS NOT NULL
GROUP BY m.molor_id"	READY
359	2015-04-24 18:23:06	"1112787836"	true	2015-04-24 18:23:06	ml.project_outfit_order_group		"CREATE VIEW ml.project_outfit_order_group AS
SELECT
coa.outfit_id AS ""order_group_id"",
am.molor_id
FROM
""bi.customer_order"" co
LEFT JOIN ""bi.customer_order_articles"" coa ON coa.order_id = co.order_id
LEFT JOIN ""ml.article_molor"" am ON am.article_id = coa.article_id
WHERE co.date_stylist_picked > '2014-01-01'
AND coa.outfit_id IS NOT NULL
AND coa.outfit_id IS NOT NULL
AND am.molor_id IS NOT NULL"	READY
400	2015-04-24 18:24:33	"1112787869"	true	2015-04-24 18:24:33	views.marketing_apptracking		"CREATE view views.marketing_apptracking
AS
SELECT 
	app.order_id,
	app.customer_id,
	app.country,
	app.campaign,
	app.trackingname,
	app.date_created,
	app.marketing_channel,
	app.first_channel,
	app.nb_of_installs,
	cc.costs
FROM
(
	SELECT 
		app.order_id,
		app.customer_id,
		app.country,
		app.network as campaign,
		app.trackingname,
		app.date_created,
		CASE 
			WHEN app.marketing_channel IS NULL and app.network='Organic' THEN 'app organic'
			WHEN app.marketing_channel IS NULL then 'app download campaign'
			ELSE app.marketing_channel
		END AS marketing_channel,
		app.first_channel,
	    app.nb_of_installs
	FROM
	(
		SELECT 
			ap.order_id,
			ac.customer_id,
			ac.network,
			ac.trackingname,
			cast(co.date_created AS date) AS date_created,
			mo.marketing_channel,
			mc.first_channel,
	    	app_installs.nb_of_installs,
	    	co.shipping_country as country,
			row_number() over (partition by ac.customer_id order by co.date_created desc) AS rank
		FROM dwh.apptracking ap
		LEFT JOIN dwh.apptracking_customer ac ON ac.customer_id=ap.customer_id
		LEFT JOIN views.customer_order co ON co.id=ap.order_id
		LEFT JOIN 
		(
			select
				case
				    when ga.transaction_id is null and tv.order_id is not null then tv.order_id
				    when ga.transaction_id is not null and tv.order_id is null then ga.transaction_id
				    when ga.transaction_id is not null and tv.order_id is not null then ga.transaction_id
				end as ""order_id"",
				case
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'affiliate'      then 'affiliate'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'crm'        then 'crm'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'display'      then 'display'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'facebook'       then 'facebook'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'google gdn'     then 'google gdn'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'kooperation'    then 'kooperation'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'praemienprogramm'   then 'praemienprogramm'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'remarketing'    then 'remarketing'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'twitter'      then 'twitter'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'youtube'      then 'youtube'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_3!=  'brand' then 'google sem nobrand'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_3= 'brand' then 'tv'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_1= 'bing' and ga.cam_bit_1= '0' then 'google sem nobrand'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_1= 'bing' and ga.cam_bit_1= '1' then 'tv'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'direct'       then 'tv'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'organic'      then 'tv'
				    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= '(not set)'      then 'tv'
				    when tv.order_id is not null and ga.cam_bit_1= 'rem'  then 'remarketing'
				    else '(not set)'
			 	end as ""marketing_channel""
				from views.ga_information ga
				full join views.marketingtv tv on ga.transaction_id = tv.order_id
		) mo ON mo.order_id=co.id
		LEFT JOIN views.marketing_customer mc ON mc.customer_id=ap.customer_id
		LEFT JOIN
		(
			SELECT 
				network,
				upper(country) AS country,
				cast(date_created AS date) AS date_created,
				sum(installs) AS nb_of_installs
			FROM dwh.appdownloads
			GROUP BY 1,2,3
		)app_installs ON app_installs.network=ac.network and app_installs.date_created=cast(co.date_created AS date) and app_installs.country=co.shipping_country
		WHERE co.sales_channel in ('app','appWithDate','miniApp','miniAppWithDate')
	)app
	WHERE app.rank=1
)app
LEFT JOIN
(
	SELECT
		datecreated as date_created,
		LEFT(campaign,2) as country,
		campaign,
		sum(cast(costs as double)) as ""costs""
	FROM ""dwh.campaigncost"" 
	GROUP BY 1,2,3
) cc on cc.date_created=app.date_created and cc.country=app.country and cc.campaign=app.campaign"	READY
404	2015-04-24 18:24:52	"1112787872"	true	2015-07-30 17:59:04	tableau.billing_arvato_checklist_red_dark		"CREATE view tableau.billing_arvato_checklist_red_dark
AS
SELECT 
	fd.order_id,
	fd.customer_id,
	fd.fd_date_created,
	fd.customer_order_date_created,
	fd.arvatoresult_1,
	fd.provider_transaction_id1,
	cu.default_page
FROM views.financial_data fd
JOIN views.customer cu on cu.customer_id=fd.customer_id
WHERE arvatoresult_1='RED_DARK'"	READY
405	2015-04-24 18:24:54	"1112787873"	true	2015-04-24 18:24:54	tableau.treasury_arvato_orders_retail_price_to_cc		"CREATE view tableau.treasury_arvato_orders_retail_price_to_cc
AS
SELECT
	co.id,
	co.payment_method,
	co.date_created,
	co.date_shipped,
	co.date_returned,
	co.invoice_date_created,
	a.date_created as arvato_date_updated,
	co.total_goodwill_credit,
	co.total_amount_billed_discount,
	co.total_amount_basket_retail_gross,
	ret.value_of_returns,
	co.total_amount_billed_retail_gross,
	coalesce(a.amount,0) as Paid_to_Arvato__c,
	co.total_amount_billed_retail_gross-coalesce(a.open_amount,0) as Open_Ammount_Arvato__c,
	co.shipping_first_name,
	co.shipping_last_name,
	co.shipping_street,
	co.shipping_street_number,
	co.shipping_zip,
	co.shipping_city,
	co.shipping_country,
	co.shipping_co,
	co.order_type,
	fd.arvatotype,
	fd.arvatoorderlimit,
	fd.arvatoresult,
	fd.arvatoscore,
	sfo.ArvatoYorN__c,
	au.date_prepay_to_credit_card as pay_changed_date_created,
	cast(co.date_created as date)=cast(au.date_prepay_to_credit_card as date) as ""vk_cc_y_n""
FROM views.customer_order co
/*Arvato Payment*/
LEFT JOIN 
(
	SELECT 
		id,
		ordernumber,
		date_created,
		amount,
		sum(amount) over(partition by ordernumber ORDER BY date_created) as open_amount 
		FROM views.arvatopayments 
)a on co.id=a.ordernumber
/*Value of Returns*/
LEFT JOIN 
(
	SELECT 
		order_id,
		sum(quantity*retail_price) as value_of_returns 
		FROM views.order_position 
		WHERE state=512
		GROUP BY 1
)ret on ret.order_id=co.id
LEFT JOIN views.financial_data fd on fd.order_id=co.id
LEFT JOIN views.salesforce_opportunity sfo on sfo.ExternalOrderId__c=co.id
LEFT JOIN raw.customer_order_details__audit_log au on au.order_id=co.id"	READY
884,737	2015-09-23 12:18:46	"1357078297"	true	2015-09-23 12:23:44	sandbox.repeat_behaviour		"CREATE VIEW sandbox.repeat_behaviour
as

SELECT
CAST(date_incoming as date) as date_incoming,
shipping_country,
CASE 
	WHEN discount_marketing=25 then '25'
	WHEN discount_marketing=50 THEN '50'
	ELSE 'No Discount'
END AS discount_type,
order_type,
count(*) as incoming_order,
count(distinct case when date_invoiced is not null then order_id end) as invoiced_orders,
avg(sales_kept) as avg_sales_kept
FROM bi.customer_order
GROUP BY 1,2,3,4"	READY
884,738	2015-09-23 14:13:09	"1357078447"	true	2015-09-23 14:25:19	tableau.repeat_behaviour		"CREATE VIEW tableau.repeat_behaviour
AS

SELECT
CAST(date_incoming as date) as date_incoming,
shipping_country,
CASE 
	WHEN discount_marketing=25 then '25'
	WHEN discount_marketing=50 THEN '50'
	ELSE 'No Discount'
END AS discount_type,
count(distinct case when order_type='First Order' then order_id else null end) as first_incoming_order,
count(distinct case when order_type<>'First Order' then order_id else null end) as repeat_incoming_order,
count(distinct case when order_type='First Order' and date_invoiced is not null then order_id end) as first_invoiced_orders,
count(distinct case when order_type<>'First Order' and date_invoiced is not null then order_id end) as repeat_invoiced_orders,
avg(case when order_type='First Order' then sales_kept end) as avg_first_sales_kept,
avg(case when order_type<>'First Order' then sales_kept end) as avg_repeat_sales_kept
FROM bi.customer_order
GROUP BY 1,2,3"	READY
196,652	2015-06-09 17:47:51	"863699775"	true	2015-06-09 17:47:51	ml.orders_with_cs_reason_irrt_best		"CREATE VIEW ml.orders_with_cs_reason_irrt_best AS
SELECT
""csv_table.EXTERNALORDERID__C"" AS ""order_id""
FROM
(call ""file"".getFiles('20150609_orders_with_cs_reason_irrt_best.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""ID"" STRING ,
		""EXTERNALORDERID__C"" STRING ,
		""CS_REASON__C"" STRING 
		DELIMITER ',' 
		QUOTE '""' 
		HEADER 1 
	)
""csv_table"""	READY
92	2015-04-24 18:17:48	"1112787665"	true	2015-04-24 18:17:48	tableau.ops_monthly_doc_data_bookings_returns		"CREATE view tableau.ops_monthly_doc_data_bookings_returns
as
SELECT 
	cast(ddr.date_created AS DATE) AS doc_data_date_returned, 
	sum(case when op.stock_location_id = 1 then cast(ddr.number_of_articles_return as integer) end) as quantity_stock_location_1,
	sum(case when op.stock_location_id = 2 then cast(ddr.number_of_articles_return as integer) end) as quantity_stock_location_2,
	sum(case when op.stock_location_id = 4 then cast(ddr.number_of_articles_return as integer) end) as quantity_stock_location_4
FROM postgres.doc_data_return ddr 
join postgres.order_position op on op.order_id = ddr.original_orderid and op.article_id = ddr.outfittery_article_number
WHERE  processing_reason IS NULL
group by 1"	READY
884,739	2015-09-23 15:26:13	"1357078619"	true	2015-09-23 15:26:13	datamart.dim_order_position		"CREATE VIEW datamart.dim_order_position
AS

SELECT 
	fop.order_id, 
	fop.article_id,
	it.category, 
	it.product_group, 
	COALESCE(it.brand,art.article_brand) as brand,
	COALESCE(it.season,art.article_season) AS season,
	COALESCE(it.color,art.article_color) AS color,
	COALESCE(it.size,art.article_size) AS size,
	CASE
		WHEN brand='PAUL HUNTER' THEN '1'
		ELSE '0'
	END AS is_private_label,
	CASE
		WHEN stock_location_id=2 THEN '1'
		ELSE '0'
	END AS is_patner_stock,
	CASE
		WHEN COALESCE(it.ean,article_ean) in ('2009876543503','2009876543510','2009876543527','2009876636489','2009876543534','2009876543497') THEN '1'
		ELSE '0'
	END AS is_gift,
	CASE 
		WHEN it.item_status='Push' THEN 'Push'
		WHEN it.item_status='Stop Amidala' THEN 'Stop Amidala'
		WHEN it.item_status='Free' THEN 'Free'
	END AS item_status,
	CASE 
		WHEN it.item_status_purchase_description='Core' THEN 'Core'
		WHEN it.item_status_purchase_description='Promotion' THEN 'Promotion'
		WHEN it.item_status_purchase_description='Stop NOS' THEN 'Stop NOS'
	END AS item_status_purchase,
	it.item_status_internal,
	it.unit_price_de,
	it.unit_price_ch,
	it.unit_price_se,
	it.unit_price_nl,
	it.unit_price_lu,
	it.unit_price_be,
	it.unit_price_dk
	
FROM ""raw.fact_order_position"" fop 
LEFT JOIN ""bi.item"" it on it.article_id=fop.article_id
LEFT JOIN bi.article art on art.article_id=fop.article_id"	READY
420	2015-04-24 18:26:51	"638185418"	true	2015-04-24 18:26:51	am.variant_pre_3		"CREATE VIEW ""am.variant_pre_3"" AS
SELECT
COALESCE(size_group_code_smcsl, size_group_code_smcbs, size_group_code_smcs ) AS ""size_group_code"",
COALESCE(size_erp_smcsl,size_erp_smcbs, size_erp_smcs) AS ""size_erp"",
v.*
FROM ""am.variant_pre_2"" v"	READY
349	2015-04-24 18:22:46	"1112787826"	true	2015-07-02 17:24:40	views.marketingoverview		"CREATE view views.marketingoverview
as
select
      cast(mc.datecreated as date) as ""datecreated"",
      mc.channel as ""channel"",
      mc.country as ""country"",
      ifnull(mco.costs,0) as ""costs"",
      ifnull(vi.visits,0) as ""visits"",
      o1.all_orders_in_database,
      o1.prepayment_orders_in_database,
      o1.all_first_orders,
      o1.all_repeat_orders,
      o1.all_followon_orders,
      o1.processed_first_orders,
      o1.processed_repeat_orders,
      o1.processed_followon_orders,
      o1.sent_first_orders,
      o1.sent_repeat_orders,
      o1.sent_followon_orders,
      o1.completed_first_orders,
      o1.completed_repeat_orders,
      o1.completed_followon_orders,
      o1.cancelled_first_orders,
      o1.cancelled_repeat_orders,
      o1.cancelled_followon_orders,
      o1.incoming_first_orders,
      o1.incoming_repeat_orders,
      o1.incoming_followon_orders,
      o1.totalbasket,
      o1.totalbilled,
      o1.incoming_first_orders_basket,
      o1.incoming_repeat_orders_basket,
      o1.incoming_followon_orders_basket
from views.marketingconstruct mc
left join (
      select
            mc.date_created as datecreated,
            CASE
                  WHEN mc.channel = 'LinkedIn' THEN 'social media'
                  WHEN mc.channel = 'Xing'  THEN 'social media'
                  WHEN mc.channel = 'Offline_Promotions' THEN 'offline promotions'
                  WHEN mc.channel = 'Insert' THEN 'inserts'
                  ELSE mc.channel 
            END AS channel,
            mc.country,
            SUM(mc.cost) as costs
      from raw.marketing_costs mc
      group by 1,2,3) mco
on mc.datecreated = mco.datecreated and lower(replace(mc.channel,' ','')) = lower(replace(mco.channel,' ','')) and lower(mc.country) = lower(mco.country) 
left join (
            select
            cast(co.date_created as date) as ""datecreated"",
            case
                  when mo.marketing_channel is null then '(not set)'
                  else mo.marketing_channel
            end as ""channel"",
            co.shipping_country as ""country"",
            /* COUNTS ALL ORDERS IN DATABASE */
            count(distinct(co.id)) as ""all_orders_in_database"",
            /* COUNTS ALL PREPAYMENT ORDERS IN DATABASE */
            count(distinct(case when co.payment_method= '4' then co.id else null end)) as ""prepayment_orders_in_database"",
            /* COUNTS ALL ORDERS GROUPED BY ORDER TYPE */
            count(distinct(case when co.order_type= 'first order' and co.state!= '2048' and sfo.StageName!= 'Datum vorschlagen' 
                  and sfo.StageName!= 'Termin ausmachen' and sfo.StageName!= 'Inaktiv' then co.id else null end)) as ""all_first_orders"",
            count(distinct(case when co.order_type= 'real repeat order' and co.state!= '2048' and sfo.StageName!= 'Datum vorschlagen' 
                  and sfo.StageName!= 'Termin ausmachen' and sfo.StageName!= 'Inaktiv' then co.id else null end)) as ""all_repeat_orders"",
            count(distinct(case when co.order_type= 'follow on order' and co.state!= '2048' and sfo.StageName!= 'Datum vorschlagen' 
                  and sfo.StageName!= 'Termin ausmachen' and sfo.StageName!= 'Inaktiv' then co.id else null end)) as ""all_followon_orders"",
            /* COUNTS ALL ORDERS THAT ARE BEING PROCESSED GROUPED BY ORDER TYPE */
            count(distinct(case when ifnull(date_picked,0)!= '0' and co.state>= '16' and co.state!= '2048' and co.order_type= 'first order' then co.id else null end)) as ""processed_first_orders"",
            count(distinct(case when ifnull(date_picked,0)!= '0' and co.state>= '16' and co.state!= '2048' and co.order_type= 'real repeat order' then co.id else null end)) as ""processed_repeat_orders"",
            count(distinct(case when ifnull(date_picked,0)!= '0' and co.state>= '16' and co.state!= '2048' and co.order_type= 'follow on order' then co.id else null end)) as ""processed_followon_orders"",
            /* COUNTS ALL ORDERS THAT HAVE BEEN SENT GROUPED BY ORDER TYPE */
            count(distinct(case when co.state>= '128' and co.state!= '2048' and co.order_type= 'first order' then co.id else null end)) as ""sent_first_orders"",
            count(distinct(case when co.state>= '128' and co.state!= '2048' and co.order_type= 'real repeat order' then co.id else null end)) as ""sent_repeat_orders"",
            count(distinct(case when co.state>= '128' and co.state!= '2048' and co.order_type= 'follow on order' then co.id else null end)) as ""sent_followon_orders"",
            /* COUNTS ALL ORDERS THAT HAVE BEEN COMPLETED GROUPED BY ORDER TYPE */
            count(distinct(case when co.state= '1024' and co.order_type= 'first order' then co.id else null end)) as ""completed_first_orders"",
            count(distinct(case when co.state= '1024' and co.order_type= 'real repeat order' then co.id else null end)) as ""completed_repeat_orders"",
            count(distinct(case when co.state= '1024' and co.order_type= 'follow on order' then co.id else null end)) as ""completed_followon_orders"",
            /* COUNTS ALL ORDERS THAT HAVE BEEN CANCELLED GROUPED BY ORDER TYPE */
            count(distinct(case when co.state= '2048' and co.order_type= 'first order' then co.id else null end)) as ""cancelled_first_orders"",
            count(distinct(case when co.state= '2048' and co.order_type= 'real repeat order' then co.id else null end)) as ""cancelled_repeat_orders"",
            count(distinct(case when co.state= '2048' and co.order_type= 'follow on order' then co.id else null end)) as ""cancelled_followon_orders"",
            /* COUNTS ALL INCOMING ORDERS GROUPED BY ORDER TYPE */
            count(distinct(case when co.order_type= 'first order' and (co.sales_channel like '%WithDate' or co.sales_channel like '%WithoutDate') and co.payment_method!= '4' then co.id else null end))
            as ""incoming_first_orders"",
            count(distinct(case when co.order_type= 'real repeat order' and (co.sales_channel like '%WithDate' or co.sales_channel like '%WithoutDate') and co.payment_method!= '4' then co.id else null end))
            as ""incoming_repeat_orders"",
            count(distinct(case when co.order_type= 'follow on order' and (co.sales_channel like '%WithDate' or co.sales_channel like '%WithoutDate') and co.payment_method!= '4' then co.id else null end))
            as ""incoming_followon_orders"",
            sum(opk.order_value_incl_ret_re) as totalbasket,
            sum(opk.order_value_kept_re) as totalbilled,
            /* BASKET VALUE ALL INCOMING ORDERS GROUPED BY ORDER TYPE */
            sum(distinct(case when co.order_type= 'first order' and (co.sales_channel like '%WithDate' or co.sales_channel like '%WithoutDate') and co.payment_method!= '4' then opk.order_value_kept_re else 0 end))
            as ""incoming_first_orders_basket"",
            sum(distinct(case when co.order_type= 'real repeat order' and (co.sales_channel like '%WithDate' or co.sales_channel like '%WithoutDate') and co.payment_method!= '4' then opk.order_value_kept_re else 0 end))
            as ""incoming_repeat_orders_basket"",
            sum(distinct(case when co.order_type= 'follow on order' and (co.sales_channel like '%WithDate' or co.sales_channel like '%WithoutDate') and co.payment_method!= '4' then opk.order_value_kept_re else 0 end))
            as ""incoming_followon_orders_basket""
      from views.customer_order co
      left join views.marketing_order mo on co.id = mo.order_id
      left join views.order_position_kpis opk on opk.order_id=co.id
      left join views.salesforce_opportunity sfo on co.id = sfo.ExternalOrderId__c
      where co.customer_id not in ('179899816','179886634','11804631','31281783','143553094','834667')
      group by 1,2,3) o1
on o1.datecreated = mc.datecreated and lower(o1.channel) = lower(mc.channel) and lower(o1.country) = lower(mc.country)
left join (
      select
            date_created,
            domain as country,
            channel,
            sum(ifnull(visits,0)) as visits
      from raw.daily_visits
      group by 1,2,3) vi
on mc.datecreated = vi.date_created and lower(mc.country) = lower(vi.country) and lower(mc.channel) = lower(vi.channel)
where mc.datecreated>= '2014-01-27'
and mc.datecreated<= curdate()
order by mc.datecreated desc"	READY
350	2015-04-24 18:22:48	"1112787828"	true	2015-05-06 17:29:22	views.inventory		"CREATE VIEW views.inventory
AS
SELECT
	case 
		when inv.article_id is not null then inv.article_id
		when inv.article_id is null then sales.article_id
	end as article_id,
	/*combine all date_created -> remove null which caused by full join*/ 
	case 
		when inv.date_created is not null then inv.date_created
		when inv.date_created is null then sales.date_shipped
	end as date_created,
	inv.quantity,
	inv.reserved,
	inv.quantity2,
	inv.reserved2,
	inv.quantity_ow_dlv,
	inv.quantity_z_dlv,
	inv.quantity_ow_lret,
	inv.quantity_z_lret,
	inv.pop_fulfilled_quantity,
	inv.pop_quantity,
	inv.pop_initial_quantity,
	inv.pop_retail_price_min,
	inv.pop_purchase_price_min,
	inv.pop_retail_price_max,
	inv.pop_purchase_price_max,
	inv.pop_retail_price_avg,
	inv.pop_purchase_price_avg,
	inv.pop_intial_quantity_retail,
	inv.pop_intial_quantity_purchase,
	inv.pop_quantity_retail,
	inv.pop_quantity_purchase,
	inv.pop_fulfilled_quantity_retail,
	inv.pop_fulfilled_quantity_purchase,
	inv.oo_id,
	inv.ean,
	inv.brand,
	inv.article_name,
	inv.supplier_availability,
	inv.commodity_group1,
	inv.commodity_group2,
	inv.commodity_group3,
	inv.commodity_group4,
	inv.commodity_group5,
	inv.country_of_production,
	inv.processing_code,
	inv.color1,
	inv.supplier_sku,
	inv.supplier_color_code,
	inv.supplier_color_name,
	inv.purchase_price,
	inv.pic1,
	inv.color1_shade,
	inv.nos,
	inv.season,
	inv.amidala_deactive,
	inv.amidala_categories,
	inv.supplier_size,
	inv.eu_size,
	inv.supplier_length,
	inv.eu_length,
	inv.alternative_supplier_sku,
	inv.push,
	inv.reduced,
	inv.season_start,
	inv.net_weight_gram,
	inv.gross_weight_gram,
	inv.de_customs_tarff_number,
	inv.ch_customs_tariff_number,
	inv.age,
	inv.style,
	inv.core_article,
	inv.article_o_parentId,
	inv.activation_ch,
	inv.o_published,
	inv.o_creationDate,
	inv.supplier_article_id,
	inv.supplier_article_article_id,
	inv.supplier_article_sku,
	inv.supplier_article_purchase_price,
	inv.supplier_article_ean,
	inv.supplier_article_image_url,
	inv.supplier_article_partner_shop_url,
	inv.supplier_article_manufacturer_sku,
	inv.article_article_id,
	inv.article_title,
	inv.article_color,
	inv.article_size,
	inv.article_sku,
	inv.article_model_id,
	inv.check_tariff_numbers,
	inv.price_retail_de,
	inv.date_available,
    inv.promotion_item,
    inv.production_textile,
    inv.reason_deactive,
	inv.price_retail_original,
	inv.price_retail_chf,
	inv.price_retail_original_chf,
	inv.price_retail_dkk,
	inv.price_retail_original_dkk,
	inv.price_retail_sek,
	inv.price_retail_original_sek,
	inv.price_retail_benelux,
	inv.price_retail_original_benelux,
	inv.min_date_delivery,
	inv.max_date_delivery,
	inv.final_stock,
	inv.final_reserved,
	inv.stock_type,
	/*sales data - always do retail (use retail price in euro from order_position (convert to  in order_position only!), purchase and item based*/
	avg_purchase_price_128_all,
	avg_retail_price_128_all,
	shipped_128_all,
	shipped_128_ek_all,
	shipped_128_vk_all,
	shipped_128_de,
	shipped_128_ek_de,
	shipped_128_vk_de,
	shipped_128_at,
	shipped_128_ek_at,
	shipped_128_vk_at,
	shipped_128_ch,
	shipped_128_ek_ch,
	shipped_128_vk_ch,
	shipped_128_nl,
	shipped_128_ek_nl,
	shipped_128_vk_nl,
	shipped_128_dk,
	shipped_128_ek_dk,
	shipped_128_vk_dk,
	shipped_128_se,
	shipped_128_ek_se,
	shipped_128_vk_se,
	shipped_128_lu,
	shipped_128_ek_lu,
	shipped_128_vk_lu,
	shipped_128_be,
	shipped_128_ek_be,
	shipped_128_vk_be,
	completed_1024_all,
	completed_1024_ek_all,
	completed_1024_vk_all,
	completed_1024_de,
	completed_1024_ek_de,
	completed_1024_vk_de,
	completed_1024_at,
	completed_1024_ek_at,
	completed_1024_vk_at,
	completed_1024_ch,
	completed_1024_ek_ch,
	completed_1024_vk_ch,
	completed_1024_nl,
	completed_1024_ek_nl,
	completed_1024_vk_nl,
	completed_1024_dk,
	completed_1024_ek_dk,
	completed_1024_vk_dk,
	completed_1024_se,
	completed_1024_ek_se,
	completed_1024_vk_se,
	completed_1024_lu,
	completed_1024_ek_lu,
	completed_1024_vk_lu,
	completed_1024_be,
	completed_1024_ek_be,
	completed_1024_vk_be,
	avg_retail_price_1024_all,
	avg_retail_price_1024_de,
	avg_retail_price_1024_at,
	avg_retail_price_1024_ch,
	avg_retail_price_1024_nl,
	avg_retail_price_1024_dk,
	avg_retail_price_1024_se,
	avg_retail_price_1024_lu,
	avg_retail_price_1024_be,
	returned_512_all,
	returned_512_ek_all,
	returned_512_vk_all,
	avg_purchase_price_512_all,
	avg_retail_price_512_all,
	returned_512_de,
	returned_512_ek_de,
	returned_512_vk_de,
	returned_512_at,
	returned_512_ek_at,
	returned_512_vk_at,
	returned_512_ch,
	returned_512_ek_ch,
	returned_512_vk_ch,
	returned_512_nl,
	returned_512_ek_nl,
	returned_512_vk_nl,
	returned_512_dk,
	returned_512_ek_dk,
	returned_512_vk_dk,
	returned_512_se,
	returned_512_ek_se,
	returned_512_vk_se,
	returned_512_lu,
	returned_512_ek_lu,
	returned_512_vk_lu,
	returned_512_be,
	returned_512_ek_be,
	returned_512_vk_be,
	lost_1536_all,
	lost_1536_ek_all,
	lost_1536_vk_all,
	sum_virtual_stock_quantity,
	sum_vk_stock,
	sum_ek_stock,
	avg_virtual_stock_vk,
	avg_virtual_stock_ek,
	/*partner stock*/
	avg_purchase_price_128_partner,
	avg_retail_price_128_partner,
	/*Shipped-Patner*/
	shipped_128_partner,
	shipped_128_ek_partner,
	shipped_128_vk_partner,
	/*Shipped-Partner(Country)*/
	shipped_128_de_partner,
	shipped_128_ek_de_partner,
	shipped_128_vk_de_partner,
	shipped_128_at_partner,
	shipped_128_ek_at_partner,
	shipped_128_vk_at_partner,
	shipped_128_ch_partner,
	shipped_128_ek_ch_partner,
	shipped_128_vk_ch_partner,
	shipped_128_nl_partner,
	shipped_128_ek_nl_partner,
	shipped_128_vk_nl_partner,
	shipped_128_dk_partner,
	shipped_128_ek_dk_partner,
	shipped_128_vk_dk_partner,
	shipped_128_se_partner,
	shipped_128_ek_se_partner,
	shipped_128_vk_se_partner,
	shipped_128_lu_partner,
	shipped_128_ek_lu_partner,
	shipped_128_vk_lu_partner,
	shipped_128_be_partner,
	shipped_128_ek_be_partner,
	shipped_128_vk_be_partner,
	/*Completed-Partner*/
	completed_1024_partner,
	completed_1024_ek_partner,
	completed_1024_vk_partner,
	/*Completed-Partner(Country)*/
	avg_retail_price_1024_de_partner,
	completed_1024_de_partner,
	completed_1024_ek_de_partner,
	completed_1024_vk_de_partner,
	avg_retail_price_1024_at_partner,
	completed_1024_at_partner,
	completed_1024_ek_at_partner,
	completed_1024_vk_at_partner,
	avg_retail_price_1024_ch_partner,
	completed_1024_ch_partner,
	completed_1024_ek_ch_partner,
	completed_1024_vk_ch_partner,
	avg_retail_price_1024_nl_partner,
	completed_1024_nl_partner,
	completed_1024_ek_nl_partner,
	completed_1024_vk_nl_partner,
	avg_retail_price_1024_dk_partner,
	completed_1024_dk_partner,
	completed_1024_ek_dk_partner,
	completed_1024_vk_dk_partner,
	avg_retail_price_1024_se_partner,
	completed_1024_se_partner,
	completed_1024_ek_se_partner,
	completed_1024_vk_se_partner,
	avg_retail_price_1024_lu_partner,
	completed_1024_lu_partner,
	completed_1024_ek_lu_partner,
	completed_1024_vk_lu_partner,
	avg_retail_price_1024_be_partner,
	completed_1024_be_partner,
	completed_1024_ek_be_partner,
	completed_1024_vk_be_partner,
	avg_purchase_price_1024_partner,
	avg_retail_price_1024_partner,
	/*Returned-Partner*/
	returned_512_partner,
	returned_512_ek_partner,
	returned_512_vk_partner,
	avg_purchase_price_512_partner, 
	avg_retail_price_512_partner,
	/*Virtual Stock-Partner*/
	sum_virtual_stock_quantity_partner,
	sum_vk_stock_partner,
	sum_ek_stock_partner,
	avg_virtual_stock_vk_partner,
	avg_virtual_stock_ek_partner
FROM views.inventory_1 inv
FULL JOIN
(
	SELECT
		date_shipped, 
		article_id,
		sum(avg_purchase_price_128_all) as avg_purchase_price_128_all,
		avg(avg_retail_price_128_all) as avg_retail_price_128_all,
		sum(shipped_128_all) as  shipped_128_all,
		sum(shipped_128_ek_all) as  shipped_128_ek_all,
		sum(shipped_128_vk_all) as  shipped_128_vk_all,
		sum(shipped_128_de) as  shipped_128_de,
		sum(shipped_128_ek_de) as  shipped_128_ek_de,
		sum(shipped_128_vk_de) as  shipped_128_vk_de,
		sum(shipped_128_at) as  shipped_128_at,
		sum(shipped_128_ek_at) as  shipped_128_ek_at,
		sum(shipped_128_vk_at) as  shipped_128_vk_at,
		sum(shipped_128_ch) as  shipped_128_ch,
		sum(shipped_128_ek_ch) as  shipped_128_ek_ch,
		sum(shipped_128_vk_ch) as  shipped_128_vk_ch,
		sum(shipped_128_nl) as  shipped_128_nl,
		sum(shipped_128_ek_nl) as  shipped_128_ek_nl,
		sum(shipped_128_vk_nl) as  shipped_128_vk_nl,
		sum(shipped_128_dk) as  shipped_128_dk,
		sum(shipped_128_ek_dk) as  shipped_128_ek_dk,
		sum(shipped_128_vk_dk) as  shipped_128_vk_dk,
		sum(shipped_128_se) as  shipped_128_se,
		sum(shipped_128_ek_se) as  shipped_128_ek_se,
		sum(shipped_128_vk_se) as  shipped_128_vk_se,
		sum(shipped_128_lu) as  shipped_128_lu,
		sum(shipped_128_ek_lu) as  shipped_128_ek_lu,
		sum(shipped_128_vk_lu) as  shipped_128_vk_lu,
		sum(shipped_128_be) as  shipped_128_be,
		sum(shipped_128_ek_be) as  shipped_128_ek_be,
		sum(shipped_128_vk_be) as  shipped_128_vk_be, 
		sum(completed_1024_all) as  completed_1024_all,
		sum(completed_1024_ek_all) as  completed_1024_ek_all,
		sum(completed_1024_vk_all) as  completed_1024_vk_all,
		sum(completed_1024_de) as  completed_1024_de,
		sum(completed_1024_ek_de) as  completed_1024_ek_de,
		sum(completed_1024_vk_de) as  completed_1024_vk_de,
		sum(completed_1024_at) as  completed_1024_at,
		sum(completed_1024_ek_at) as  completed_1024_ek_at,
		sum(completed_1024_vk_at) as  completed_1024_vk_at,
		sum(completed_1024_ch) as  completed_1024_ch,
		sum(completed_1024_ek_ch) as  completed_1024_ek_ch,
		sum(completed_1024_vk_ch) as  completed_1024_vk_ch,
		sum(completed_1024_nl) as  completed_1024_nl,
		sum(completed_1024_ek_nl) as  completed_1024_ek_nl,
		sum(completed_1024_vk_nl) as  completed_1024_vk_nl,
		sum(completed_1024_dk) as  completed_1024_dk,
		sum(completed_1024_ek_dk) as  completed_1024_ek_dk,
		sum(completed_1024_vk_dk) as  completed_1024_vk_dk,
		sum(completed_1024_se) as  completed_1024_se,
		sum(completed_1024_ek_se) as  completed_1024_ek_se,
		sum(completed_1024_vk_se) as  completed_1024_vk_se,
		sum(completed_1024_lu) as  completed_1024_lu,
		sum(completed_1024_ek_lu) as  completed_1024_ek_lu,
		sum(completed_1024_vk_lu) as  completed_1024_vk_lu,
		sum(completed_1024_be) as  completed_1024_be,
		sum(completed_1024_ek_be) as  completed_1024_ek_be,
		sum(completed_1024_vk_be) as  completed_1024_vk_be,
		avg(avg_retail_price_1024_all) as  avg_retail_price_1024_all,
		avg(avg_retail_price_1024_de) as  avg_retail_price_1024_de,
		avg(avg_retail_price_1024_at) as  avg_retail_price_1024_at,
		avg(avg_retail_price_1024_ch) as  avg_retail_price_1024_ch,
		avg(avg_retail_price_1024_nl) as  avg_retail_price_1024_nl,
		avg(avg_retail_price_1024_dk) as  avg_retail_price_1024_dk,
		avg(avg_retail_price_1024_se) as  avg_retail_price_1024_se,
		avg(avg_retail_price_1024_lu) as  avg_retail_price_1024_lu,
		avg(avg_retail_price_1024_be) as  avg_retail_price_1024_be,
		sum(returned_512_all) as  returned_512_all,
		sum(returned_512_ek_all) as  returned_512_ek_all,
		sum(returned_512_vk_all) as  returned_512_vk_all,
		avg(avg_purchase_price_512_all ) as  avg_purchase_price_512_all, 
		avg(avg_retail_price_512_all) as  avg_retail_price_512_all,
		sum(returned_512_de) as  returned_512_de,
		sum(returned_512_ek_de) as  returned_512_ek_de,
		sum(returned_512_vk_de) as  returned_512_vk_de,
		sum(returned_512_at) as  returned_512_at, 
		sum(returned_512_ek_at) as  returned_512_ek_at,
		sum(returned_512_vk_at) as  returned_512_vk_at,
		sum(returned_512_ch) as  returned_512_ch,
		sum(returned_512_ek_ch) as  returned_512_ek_ch,
		sum(returned_512_vk_ch) as  returned_512_vk_ch,
		sum(returned_512_nl) as  returned_512_nl, 
		sum(returned_512_ek_nl) as  returned_512_ek_nl,
		sum(returned_512_vk_nl) as  returned_512_vk_nl,
		sum(returned_512_dk) as  returned_512_dk, 
		sum(returned_512_ek_dk) as  returned_512_ek_dk,
		sum(returned_512_vk_dk) as  returned_512_vk_dk,
		sum(returned_512_se) as  returned_512_se, 
		sum(returned_512_ek_se) as  returned_512_ek_se,
		sum(returned_512_vk_se) as  returned_512_vk_se,
		sum(returned_512_lu) as  returned_512_lu, 
		sum(returned_512_ek_lu) as  returned_512_ek_lu,
		sum(returned_512_vk_lu) as  returned_512_vk_lu,
		sum(returned_512_be) as  returned_512_be, 
		sum(returned_512_ek_be) as  returned_512_ek_be,
		sum(returned_512_vk_be) as  returned_512_vk_be,
		sum(lost_1536_all) as  lost_1536_all,
		sum(lost_1536_ek_all) as  lost_1536_ek_all,
		sum(lost_1536_vk_all) as  lost_1536_vk_all,
		sum(sum_virtual_stock_quantity) as sum_virtual_stock_quantity,
		sum(sum_vk_stock) as sum_vk_stock,
		sum(sum_ek_stock) as sum_ek_stock,
		avg(avg_virtual_stock_vk) as avg_virtual_stock_vk,
		avg(avg_virtual_stock_ek) as avg_virtual_stock_ek,
		sum(avg_purchase_price_128_partner) as avg_purchase_price_128_partner,
		avg(avg_retail_price_128_partner) as avg_retail_price_128_partner,
		sum(shipped_128_partner) as  shipped_128_partner,
		sum(shipped_128_ek_partner) as  shipped_128_ek_partner,
		sum(shipped_128_vk_partner) as  shipped_128_vk_partner,
		sum(completed_1024_partner) as  completed_1024_partner,
		sum(completed_1024_ek_partner) as  completed_1024_ek_partner,
		sum(completed_1024_vk_partner) as  completed_1024_vk_partner,
		avg(avg_purchase_price_1024_partner) as avg_purchase_price_1024_partner,
		avg(avg_retail_price_1024_partner) as  avg_retail_price_1024_partner,
		sum(returned_512_partner) as  returned_512_partner,
		sum(returned_512_ek_partner) as  returned_512_ek_partner,
		sum(returned_512_vk_partner) as  returned_512_vk_partner,
		avg(avg_purchase_price_512_partner ) as  avg_purchase_price_512_partner, 
		avg(avg_retail_price_512_partner) as  avg_retail_price_512_partner,
		sum(sum_virtual_stock_quantity_partner) as sum_virtual_stock_quantity_partner,
		sum(sum_vk_stock_partner) as sum_vk_stock_partner,
		sum(sum_ek_stock_partner) as sum_ek_stock_partner,
		avg(avg_virtual_stock_vk_partner) as avg_virtual_stock_vk_partner,
		avg(avg_virtual_stock_ek_partner) as avg_virtual_stock_ek_partner,
		sum(shipped_128_de_partner) as shipped_128_de_partner,
		sum(shipped_128_ek_de_partner) as shipped_128_ek_de_partner,
		sum(shipped_128_vk_de_partner) as shipped_128_vk_de_partner,
		sum(shipped_128_at_partner) as shipped_128_at_partner,
		sum(shipped_128_ek_at_partner) as shipped_128_ek_at_partner,
		sum(shipped_128_vk_at_partner) as shipped_128_vk_at_partner,
		sum(shipped_128_ch_partner) as shipped_128_ch_partner,
		sum(shipped_128_ek_ch_partner) as shipped_128_ek_ch_partner,
		sum(shipped_128_vk_ch_partner) as shipped_128_vk_ch_partner,
		sum(shipped_128_nl_partner) as shipped_128_nl_partner,
		sum(shipped_128_ek_nl_partner) as shipped_128_ek_nl_partner,
		sum(shipped_128_vk_nl_partner) as shipped_128_vk_nl_partner,
		sum(shipped_128_dk_partner) as shipped_128_dk_partner,
		sum(shipped_128_ek_dk_partner) as shipped_128_ek_dk_partner,
		sum(shipped_128_vk_dk_partner) as shipped_128_vk_dk_partner,
		sum(shipped_128_se_partner) as shipped_128_se_partner,
		sum(shipped_128_ek_se_partner) as shipped_128_ek_se_partner,
		sum(shipped_128_vk_se_partner) as shipped_128_vk_se_partner,
		sum(shipped_128_lu_partner) as shipped_128_lu_partner,
		sum(shipped_128_ek_lu_partner) as shipped_128_ek_lu_partner,
		sum(shipped_128_vk_lu_partner) as shipped_128_vk_lu_partner,
		sum(shipped_128_be_partner) as shipped_128_be_partner,
		sum(shipped_128_ek_be_partner) as shipped_128_ek_be_partner,
		sum(shipped_128_vk_be_partner) as shipped_128_vk_be_partner,
		avg(avg_retail_price_1024_de_partner) as avg_retail_price_1024_de_partner,
		sum(completed_1024_de_partner) as completed_1024_de_partner,
		sum(completed_1024_ek_de_partner) as completed_1024_ek_de_partner,
		sum(completed_1024_vk_de_partner) as completed_1024_vk_de_partner,
		avg(avg_retail_price_1024_at_partner) as avg_retail_price_1024_at_partner,
		sum(completed_1024_at_partner) as completed_1024_at_partner,
		sum(completed_1024_ek_at_partner) as completed_1024_ek_at_partner,
		sum(completed_1024_vk_at_partner) as completed_1024_vk_at_partner,
		avg(avg_retail_price_1024_ch_partner) as avg_retail_price_1024_ch_partner,
		sum(completed_1024_ch_partner) as completed_1024_ch_partner,
		sum(completed_1024_ek_ch_partner) as completed_1024_ek_ch_partner,
		sum(completed_1024_vk_ch_partner) as completed_1024_vk_ch_partner,
		avg(avg_retail_price_1024_nl_partner) as avg_retail_price_1024_nl_partner,
		sum(completed_1024_nl_partner) as completed_1024_nl_partner,
		sum(completed_1024_ek_nl_partner) as completed_1024_ek_nl_partner,
		sum(completed_1024_vk_nl_partner) as completed_1024_vk_nl_partner,
		avg(avg_retail_price_1024_dk_partner) as avg_retail_price_1024_dk_partner,
		sum(completed_1024_dk_partner) as completed_1024_dk_partner,
		sum(completed_1024_ek_dk_partner) as completed_1024_ek_dk_partner,
		sum(completed_1024_vk_dk_partner) as completed_1024_vk_dk_partner,
		avg(avg_retail_price_1024_se_partner) as avg_retail_price_1024_se_partner,
		sum(completed_1024_se_partner) as completed_1024_se_partner,
		sum(completed_1024_ek_se_partner) as completed_1024_ek_se_partner,
		sum(completed_1024_vk_se_partner) as completed_1024_vk_se_partner,
		avg(avg_retail_price_1024_lu_partner) as avg_retail_price_1024_lu_partner,
		sum(completed_1024_lu_partner) as completed_1024_lu_partner,
		sum(completed_1024_ek_lu_partner) as completed_1024_ek_lu_partner,
		sum(completed_1024_vk_lu_partner) as completed_1024_vk_lu_partner,
		avg(avg_retail_price_1024_be_partner) as avg_retail_price_1024_be_partner,
		sum(completed_1024_be_partner) as completed_1024_be_partner,
		sum(completed_1024_ek_be_partner) as completed_1024_ek_be_partner,
		sum(completed_1024_vk_be_partner) as completed_1024_vk_be_partner
	FROM 
	(
		SELECT 
			cast(date_shipped as date) as date_shipped,
			article_id,
			/*-----------------------------------------------------------Shipped-OW-----------------------------------------------------------*/
			sum(case when stock_location_id=2 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_all, 
			sum(case when stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double) else 0 end) as shipped_128_ek_all,
			sum(case when stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double) else 0 end)  as shipped_128_vk_all,
			avg(case when stock_location_id=2 and state !=2048 and date_shipped is not null then purchase_price else 0 end) as avg_purchase_price_128_all, 
			avg(case when stock_location_id=2 and state !=2048 and date_shipped is not null then retail_price_euro else 0 end) as avg_retail_price_128_all,
			/*------Shipped-OW(Country)------*/
			sum(case when shipping_country='DE' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_de, 
			sum(case when shipping_country='DE' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_de,
			sum(case when shipping_country='DE' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_de,
			sum(case when shipping_country='AT' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_at, 
			sum(case when shipping_country='AT' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_at,
			sum(case when shipping_country='AT' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_at,
			sum(case when shipping_country='CH' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_ch, 
			sum(case when shipping_country='CH' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_ch,
			sum(case when shipping_country='CH' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_ch,
			sum(case when shipping_country='NL' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_nl, 
			sum(case when shipping_country='NL' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_nl,
			sum(case when shipping_country='NL' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_nl,
			sum(case when shipping_country='DK' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_dk, 
			sum(case when shipping_country='DK' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_dk,
			sum(case when shipping_country='DK' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_dk,
			sum(case when shipping_country='SE' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_se, 
			sum(case when shipping_country='SE' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_se,
			sum(case when shipping_country='SE' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_se,
			sum(case when shipping_country='LU' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_lu, 
			sum(case when shipping_country='LU' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_lu,
			sum(case when shipping_country='LU' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_lu,
			sum(case when shipping_country='BE' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_be, 
			sum(case when shipping_country='BE' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_be,
			sum(case when shipping_country='BE' and stock_location_id=2 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_be,
			/*-----------------------------------------------------------Completed-OW-----------------------------------------------------------*/
			sum(case when stock_location_id=2 and state = 1024 then quantity else 0 end) as completed_1024_all, 
			sum(case when stock_location_id=2 and state = 1024 then quantity*cast(purchase_price as double) else 0 end) as completed_1024_ek_all,
			sum(case when stock_location_id=2 and state = 1024 then quantity*cast(retail_price_euro as double) else 0 end)  as completed_1024_vk_all,
			avg(case when stock_location_id=2 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_all,
			/*------Completed-OW(Country)------*/
			avg(case when shipping_country='DE' and stock_location_id=2 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_de,
			sum(case when shipping_country='DE' and stock_location_id=2 and state = 1024 then quantity else 0 end) as completed_1024_de, 
			sum(case when shipping_country='DE' and stock_location_id=2 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_de,
			sum(case when shipping_country='DE' and stock_location_id=2 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_de,
			avg(case when shipping_country='AT' and stock_location_id=2 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_at,
			sum(case when shipping_country='AT' and stock_location_id=2 and state = 1024 then quantity else 0 end) as completed_1024_at, 
			sum(case when shipping_country='AT' and stock_location_id=2 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_at,
			sum(case when shipping_country='AT' and stock_location_id=2 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_at,
			avg(case when shipping_country='CH' and stock_location_id=2 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_ch,
			sum(case when shipping_country='CH' and stock_location_id=2 and state = 1024 then quantity else 0 end) as completed_1024_ch, 
			sum(case when shipping_country='CH' and stock_location_id=2 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_ch,
			sum(case when shipping_country='CH' and stock_location_id=2 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_ch,
			avg(case when shipping_country='NL' and stock_location_id=2 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_nl,
			sum(case when shipping_country='NL' and stock_location_id=2 and state = 1024 then quantity else 0 end) as completed_1024_nl, 
			sum(case when shipping_country='NL' and stock_location_id=2 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_nl,
			sum(case when shipping_country='NL' and stock_location_id=2 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_nl,
			avg(case when shipping_country='DK' and stock_location_id=2 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_dk,
			sum(case when shipping_country='DK' and stock_location_id=2 and state = 1024 then quantity else 0 end) as completed_1024_dk, 
			sum(case when shipping_country='DK' and stock_location_id=2 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_dk,
			sum(case when shipping_country='DK' and stock_location_id=2 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_dk,
			avg(case when shipping_country='SE' and stock_location_id=2 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_se,
			sum(case when shipping_country='SE' and stock_location_id=2 and state = 1024 then quantity else 0 end) as completed_1024_se, 
			sum(case when shipping_country='SE' and stock_location_id=2 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_se,
			sum(case when shipping_country='SE' and stock_location_id=2 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_se,
			avg(case when shipping_country='LU' and stock_location_id=2 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_lu,
			sum(case when shipping_country='LU' and stock_location_id=2 and state = 1024 then quantity else 0 end) as completed_1024_lu, 
			sum(case when shipping_country='LU' and stock_location_id=2 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_lu,
			sum(case when shipping_country='LU' and stock_location_id=2 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_lu,
			avg(case when shipping_country='BE' and stock_location_id=2 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_be,
			sum(case when shipping_country='BE' and stock_location_id=2 and state = 1024 then quantity else 0 end) as completed_1024_be, 
			sum(case when shipping_country='BE' and stock_location_id=2 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_be,
			sum(case when shipping_country='BE' and stock_location_id=2 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_be,
			/*-----------------------------------------------------------Returned-OW-----------------------------------------------------------*/
			sum(case when stock_location_id=2 and state = 512 then  quantity else 0 end) as returned_512_all, 
			sum(case when stock_location_id=2 and state = 512 then quantity*cast(purchase_price as double) else 0 end) as returned_512_ek_all,
			sum(case when stock_location_id=2 and state = 512 then quantity*cast(retail_price_euro as double) else 0 end)  as returned_512_vk_all,
			avg(case when stock_location_id=2 and state = 512 then purchase_price else 0 end) as avg_purchase_price_512_all, 
			avg(case when stock_location_id=2 and state = 512 then retail_price_euro else 0 end) as avg_retail_price_512_all,
			/*---------Returned-OW(Country)------------*/
			sum(case when shipping_country='DE' and stock_location_id=2 and state = 512 then  quantity else 0 end) as returned_512_de, 
			sum(case when shipping_country='DE' and stock_location_id=2 and state = 512 then  quantity*cast(purchase_price as double)else 0 end) as returned_512_ek_de,
			sum(case when shipping_country='DE' and stock_location_id=2 and state = 512 then  quantity*cast(retail_price_euro as double)else 0 end) as returned_512_vk_de,
			sum(case when shipping_country='AT' and stock_location_id=2 and state = 512 then  quantity else 0 end) as returned_512_at, 
			sum(case when shipping_country='AT' and stock_location_id=2 and state = 512 then  quantity*cast(purchase_price as double)else 0 end) as returned_512_ek_at,
			sum(case when shipping_country='AT' and stock_location_id=2 and state = 512 then  quantity*cast(retail_price_euro as double)else 0 end) as returned_512_vk_at,
			sum(case when shipping_country='CH' and stock_location_id=2 and state = 512 then  quantity else 0 end) as returned_512_ch, 
			sum(case when shipping_country='CH' and stock_location_id=2 and state = 512 then  quantity*cast(purchase_price as double)else 0 end) as returned_512_ek_ch,
			sum(case when shipping_country='CH' and stock_location_id=2 and state = 512 then  quantity*cast(retail_price_euro as double)else 0 end) as returned_512_vk_ch,
			sum(case when shipping_country='NL' and stock_location_id=2 and state = 512 then  quantity else 0 end) as returned_512_nl, 
			sum(case when shipping_country='NL' and stock_location_id=2 and state = 512 then  quantity*cast(purchase_price as double)else 0 end) as returned_512_ek_nl,
			sum(case when shipping_country='NL' and stock_location_id=2 and state = 512 then  quantity*cast(retail_price_euro as double)else 0 end) as returned_512_vk_nl,
			sum(case when shipping_country='DK' and stock_location_id=2 and state = 512 then  quantity else 0 end) as returned_512_dk, 
			sum(case when shipping_country='DK' and stock_location_id=2 and state = 512 then  quantity*cast(purchase_price as double)else 0 end) as returned_512_ek_dk,
			sum(case when shipping_country='DK' and stock_location_id=2 and state = 512 then  quantity*cast(retail_price_euro as double)else 0 end) as returned_512_vk_dk,
			sum(case when shipping_country='SE' and stock_location_id=2 and state = 512 then  quantity else 0 end) as returned_512_se, 
			sum(case when shipping_country='SE' and stock_location_id=2 and state = 512 then  quantity*cast(purchase_price as double)else 0 end) as returned_512_ek_se,
			sum(case when shipping_country='SE' and stock_location_id=2 and state = 512 then  quantity*cast(retail_price_euro as double)else 0 end) as returned_512_vk_se,
			sum(case when shipping_country='LU' and stock_location_id=2 and state = 512 then  quantity else 0 end) as returned_512_lu, 
			sum(case when shipping_country='LU' and stock_location_id=2 and state = 512 then  quantity*cast(purchase_price as double)else 0 end) as returned_512_ek_lu,
			sum(case when shipping_country='LU' and stock_location_id=2 and state = 512 then  quantity*cast(retail_price_euro as double)else 0 end) as returned_512_vk_lu,
			sum(case when shipping_country='BE' and stock_location_id=2 and state = 512 then  quantity else 0 end) as returned_512_be, 
			sum(case when shipping_country='BE' and stock_location_id=2 and state = 512 then  quantity*cast(purchase_price as double)else 0 end) as returned_512_ek_be,
			sum(case when shipping_country='BE' and stock_location_id=2 and state = 512 then  quantity*cast(retail_price_euro as double)else 0 end) as returned_512_vk_be,
			/*-----------------------------------------------------------Lost-OW-----------------------------------------------------------*/
			sum(case when stock_location_id=2 and state = 1536 and date_shipped is not null then quantity else 0 end) as lost_1536_all,
			sum(case when stock_location_id=2 and state = 1536 and date_shipped is not null then quantity*cast(purchase_price as double) else 0 end) as lost_1536_ek_all,
			sum(case when stock_location_id=2 and state = 1536 and date_shipped is not null then quantity*cast(retail_price_euro as double) else 0 end) as lost_1536_vk_all,
			/*-----------------------------------------------------------Shipped-OW-----------------------------------------------------------*/
			sum(case when stock_location_id=2 and state in (128, 256, 384)  then quantity else 0 end) as sum_virtual_stock_quantity,
			sum(case when stock_location_id=2 and state in (128, 256, 384)  then quantity*cast(purchase_price as double) else 0 end) as sum_ek_stock,
			sum(case when stock_location_id=2 and state in (128, 256, 384)  then quantity*cast(retail_price_euro as double) else 0 end) as sum_vk_stock,
			avg(case when stock_location_id=2 and state in (128, 256, 384)  then cast(purchase_price as double) else 0 end) as avg_virtual_stock_ek,
			avg(case when stock_location_id=2 and state in (128, 256, 384)  then cast(retail_price_euro as double) else 0 end) as avg_virtual_stock_vk,
			/*-----------------------------------------------------------Shipped-Patner-------------------------------------------------------*/
			sum(case when stock_location_id=4 and state !=2048 and date_shipped is not null  then quantity else 0 end) as shipped_128_partner,
			sum(case when stock_location_id=4 and state !=2048 and date_shipped is not null  then quantity*cast(purchase_price as double) else 0 end) as shipped_128_ek_partner,
			sum(case when stock_location_id=4 and state !=2048 and date_shipped is not null  then quantity*cast(retail_price_euro as double) else 0 end) as shipped_128_vk_partner,
			avg(case when stock_location_id=4 and state !=2048 and date_shipped is not null  then cast(purchase_price as double) else 0 end) as avg_purchase_price_128_partner,
			avg(case when stock_location_id=4 and state !=2048 and date_shipped is not null  then cast(retail_price_euro as double) else 0 end) as avg_retail_price_128_partner,
			/*----Shipped-Partner(Country)-----*/
			sum(case when shipping_country='DE' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_de_partner, 
			sum(case when shipping_country='DE' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_de_partner,
			sum(case when shipping_country='DE' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_de_partner,
			sum(case when shipping_country='AT' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_at_partner, 
			sum(case when shipping_country='AT' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_at_partner,
			sum(case when shipping_country='AT' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_at_partner,
			sum(case when shipping_country='CH' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_ch_partner, 
			sum(case when shipping_country='CH' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_ch_partner,
			sum(case when shipping_country='CH' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_ch_partner,
			sum(case when shipping_country='NL' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_nl_partner, 
			sum(case when shipping_country='NL' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_nl_partner,
			sum(case when shipping_country='NL' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_nl_partner,
			sum(case when shipping_country='DK' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_dk_partner, 
			sum(case when shipping_country='DK' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_dk_partner,
			sum(case when shipping_country='DK' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_dk_partner,
			sum(case when shipping_country='SE' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_se_partner, 
			sum(case when shipping_country='SE' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_se_partner,
			sum(case when shipping_country='SE' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_se_partner,
			sum(case when shipping_country='LU' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_lu_partner, 
			sum(case when shipping_country='LU' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_lu_partner,
			sum(case when shipping_country='LU' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_lu_partner,
			sum(case when shipping_country='BE' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity else 0 end) as shipped_128_be_partner, 
			sum(case when shipping_country='BE' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(purchase_price as double)else 0 end) as shipped_128_ek_be_partner,
			sum(case when shipping_country='BE' and stock_location_id=4 and state !=2048 and date_shipped is not null then quantity*cast(retail_price_euro as double)else 0 end) as shipped_128_vk_be_partner,
			/*-----------------------------------------------------------Completed-Patner-----------------------------------------------------------*/
			sum(case when stock_location_id=4 and state = 1024 then quantity else 0 end) as completed_1024_partner,
			sum(case when stock_location_id=4 and state = 1024 then quantity*cast(purchase_price as double) else 0 end) as completed_1024_ek_partner,
			sum(case when stock_location_id=4 and state = 1024 then quantity*cast(retail_price_euro as double) else 0 end) as completed_1024_vk_partner,
			avg(case when stock_location_id=4 and state = 1024 then cast(purchase_price as double) else 0 end) as avg_purchase_price_1024_partner,
			avg(case when stock_location_id=4 and state = 1024 then cast(retail_price_euro as double) else 0 end) as avg_retail_price_1024_partner,
			/*----*Completed-Partner(Country)----*/
			avg(case when shipping_country='DE' and stock_location_id=4 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_de_partner,
			sum(case when shipping_country='DE' and stock_location_id=4 and state = 1024 then quantity else 0 end) as completed_1024_de_partner, 
			sum(case when shipping_country='DE' and stock_location_id=4 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_de_partner,
			sum(case when shipping_country='DE' and stock_location_id=4 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_de_partner,
			avg(case when shipping_country='AT' and stock_location_id=4 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_at_partner,
			sum(case when shipping_country='AT' and stock_location_id=4 and state = 1024 then quantity else 0 end) as completed_1024_at_partner, 
			sum(case when shipping_country='AT' and stock_location_id=4 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_at_partner,
			sum(case when shipping_country='AT' and stock_location_id=4 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_at_partner,
			avg(case when shipping_country='CH' and stock_location_id=4 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_ch_partner,
			sum(case when shipping_country='CH' and stock_location_id=4 and state = 1024 then quantity else 0 end) as completed_1024_ch_partner, 
			sum(case when shipping_country='CH' and stock_location_id=4 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_ch_partner,
			sum(case when shipping_country='CH' and stock_location_id=4 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_ch_partner,
			avg(case when shipping_country='NL' and stock_location_id=4 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_nl_partner,
			sum(case when shipping_country='NL' and stock_location_id=4 and state = 1024 then quantity else 0 end) as completed_1024_nl_partner, 
			sum(case when shipping_country='NL' and stock_location_id=4 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_nl_partner,
			sum(case when shipping_country='NL' and stock_location_id=4 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_nl_partner,
			avg(case when shipping_country='DK' and stock_location_id=4 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_dk_partner,
			sum(case when shipping_country='DK' and stock_location_id=4 and state = 1024 then quantity else 0 end) as completed_1024_dk_partner, 
			sum(case when shipping_country='DK' and stock_location_id=4 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_dk_partner,
			sum(case when shipping_country='DK' and stock_location_id=4 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_dk_partner,
			avg(case when shipping_country='SE' and stock_location_id=4 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_se_partner,
			sum(case when shipping_country='SE' and stock_location_id=4 and state = 1024 then quantity else 0 end) as completed_1024_se_partner, 
			sum(case when shipping_country='SE' and stock_location_id=4 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_se_partner,
			sum(case when shipping_country='SE' and stock_location_id=4 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_se_partner,
			avg(case when shipping_country='LU' and stock_location_id=4 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_lu_partner,
			sum(case when shipping_country='LU' and stock_location_id=4 and state = 1024 then quantity else 0 end) as completed_1024_lu_partner, 
			sum(case when shipping_country='LU' and stock_location_id=4 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_lu_partner,
			sum(case when shipping_country='LU' and stock_location_id=4 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_lu_partner,
			avg(case when shipping_country='BE' and stock_location_id=4 and state = 1024 then retail_price_euro else 0 end) as avg_retail_price_1024_be_partner,
			sum(case when shipping_country='BE' and stock_location_id=4 and state = 1024 then quantity else 0 end) as completed_1024_be_partner, 
			sum(case when shipping_country='BE' and stock_location_id=4 and state = 1024 then quantity*cast(purchase_price as double)else 0 end) as completed_1024_ek_be_partner,
			sum(case when shipping_country='BE' and stock_location_id=4 and state = 1024 then quantity*cast(retail_price_euro as double)else 0 end) as completed_1024_vk_be_partner,
			/*-----------------------------------------------------------Returned-Patner-----------------------------------------------------------*/
			sum(case when stock_location_id=4 and state = 512 then quantity else 0 end) as returned_512_partner,
			sum(case when stock_location_id=4 and state = 512 then quantity*cast(purchase_price as double) else 0 end) as returned_512_ek_partner,
			sum(case when stock_location_id=4 and state = 512 then quantity*cast(retail_price_euro as double) else 0 end) as returned_512_vk_partner,
			avg(case when stock_location_id=4 and state = 512 then cast(purchase_price as double) else 0 end) as avg_purchase_price_512_partner,
			avg(case when stock_location_id=4 and state = 512 then cast(retail_price_euro as double) else 0 end) as avg_retail_price_512_partner,
			/*-----------------------------------------------------------Verschickt-Patner-----------------------------------------------------------*/
			sum(case when stock_location_id=4 and state in (128, 256, 384)  then quantity else 0 end) as sum_virtual_stock_quantity_partner,
			sum(case when stock_location_id=4 and state in (128, 256, 384)  then quantity*cast(purchase_price as double) else 0 end) as sum_ek_stock_partner,
			sum(case when stock_location_id=4 and state in (128, 256, 384)  then quantity*cast(retail_price_euro as double) else 0 end) as sum_vk_stock_partner,
			avg(case when stock_location_id=4 and state in (128, 256, 384)  then cast(purchase_price as double) else 0 end) as avg_virtual_stock_ek_partner,
			avg(case when stock_location_id=4 and state in (128, 256, 384)  then cast(retail_price_euro as double) else 0 end) as avg_virtual_stock_vk_partner
		FROM views.order_position
		WHERE state <> 2048 and date_shipped is not null
		GROUP BY 1,2
	) shipped
	GROUP BY 1,2
) sales on sales.article_id = inv.article_id AND sales.date_shipped = inv.date_created

WHERE
	case 
		when inv.date_created is not null then inv.date_created
		when inv.date_created is null then sales.date_shipped
	end >='2014-01-01'"	READY
406	2015-04-24 18:24:57	"1394513279"	true	2015-09-30 11:52:52	tableau.mkt_cm2_cohort_analysis		"CREATE VIEW tableau.mkt_cm2_cohort_analysis
AS

SELECT
	con.order_id,
	con.customer_id,
	con.order_state,
	con.revenue_state,
	con.payment_state,
	con.shipping_country,
	con.order_type,
	con.sales_sent,
	con.sales_kept,
	con.discount_total,
	con.billing_total,
	con.billing_net_sales,
	con.sales_kept * cogs.percentage_cost cost_kept_calc,
	CASE 
		WHEN CAST(con.date_invoiced as date) < '2014-01-01' THEN hdirc.historical_direct_cost
		ELSE dirc.cost_direct
	END AS cost_direct,
	con.cost_kept,
	co.first_box_type,
	co.first_saleschannel_completed,
	fo.first_marketing_channel,
	fo.first_order_referral,
	c.first_order_date_completed as date_created_first_order,
	cu.customer_age,
	con.date_invoiced,
	con.date_shipped,
	con.date_created,
	TIMESTAMPDIFF(SQL_TSI_DAY, c.first_order_date_completed, con.date_created)/30 as months_since_first_order
FROM bi.customer_order con
JOIN views.customer c on c.customer_id = con.customer_id
JOIN views.customer_order co on co.id = con.order_id

/* Dimensions related to a customer's first order */ 

LEFT JOIN
(
	SELECT 
		co.customer_id,
		CASE 
		 WHEN mc.marketing_channel is null THEN 'Untracked'
		 ELSE mc.marketing_channel
		END as first_marketing_channel,
		CASE
			WHEN rp.order_id is not null AND rp.discount_total = 20 THEN '20 euros'
			WHEN rp.order_id is not null AND rp.discount_total = 50 THEN '50 euros'
			ELSE 'no'
		END AS first_order_referral
	FROM bi.customer_order co
	LEFT JOIN
	(
		SELECT 
			order_id,
			marketing_channel
		FROM bi.marketing_contacts
		WHERE contact_count_asc = 1
	) mc ON mc.order_id = co.order_id 

	/* Referral Program Orders */

	LEFT JOIN
	(
		SELECT
			order_id,
			discount_total
		FROM bi.customer_order co
		LEFT JOIN bi.customer cu ON cu.customer_id = co.customer_id
		LEFT JOIN raw.discount_campaigns ca ON co.campaign_id = ca.campaign_id
		WHERE (discount_total = 50 OR discount_total = 20)
		AND ((LOWER(campaign_title) like '%referral%' AND LOWER(campaign_title) not like '%coop%' AND LOWER(campaign_title) not like '%mitarbeiter%')
		OR  (referred_by_id is null AND co.campaign_id is null))
	) rp ON rp.order_id = co.order_id
WHERE co.order_type = 'First Order'
) fo ON fo.customer_id = con.customer_id 

LEFT JOIN bi.customer cu on cu.customer_id = co.customer_id
JOIN /* Take COGs % from last 31 days. We will apply this to all orders, so that we are not biased against old cohorts due to high partner stock usage */
(
	SELECT
	shipping_country,
	sum(cost_kept)/sum(sales_kept) as percentage_cost
	FROM bi.customer_order co
	WHERE co.date_invoiced > TIMESTAMPADD(SQL_TSI_DAY, -31, CURDATE())
	GROUP BY 1
) cogs on cogs.shipping_country = co.shipping_country
LEFT JOIN /* Direct cost per order */
(
	SELECT
		date_invoiced,
		country,
		SUM(cost_per_order) as cost_direct
	FROM bi.company_costs_direct
	GROUP BY 1,2
) dirc on dirc.date_invoiced = CAST(con.date_invoiced as date) AND dirc.country = con.shipping_country
LEFT JOIN
(
	select
	country,
	SUM(cost_per_order) as historical_direct_cost
FROM bi.company_costs_direct
WHERE date_invoiced = (SELECT min(date_invoiced) from bi.company_costs_direct WHERE cost_per_order is not null)
GROUP BY 1
) hdirc ON hdirc.country = con.shipping_country

WHERE con.order_state_number >= 128 
AND con.order_state_number < 2048
AND con.is_real_order = 'Real Order'


/* This UNION SELECT adds in dummy data so that we can draw nice cohorts charts for old cohorts that have very sparse data */
UNION SELECT
	null as order_id,
	null as customer_id,
	'Completed' as order_state,
	'Final' as revenue_state,
	null as payment_state,
	shipping_country,
	null as order_type,
	null as sales_sent,
	null as sales_kept,
	null as discount_total,
	null as billing_total,
	null as billing_net_sales,
	null as cost_kept_calc,
	null as cost_direct,
	null as cost_kept,
	first_box_type,
	null as first_saleschannel_completed,
	z.first_marketing_channel,
	w.first_order_referral,
	fo.date as date_created_first_order,
	null as customer_age,
	null as date_invoiced,
	null as date_shipped,
	o.date as date_created,
	TIMESTAMPDIFF(SQL_TSI_DAY, fo.date, curdate())/30 as months_since_first_order
FROM dwh.calendar fo
JOIN dwh.calendar o on o.date > fo.date AND o.date < curdate()
CROSS JOIN (SELECT 'Call Box' as first_box_type UNION SELECT 'No Call Box' as first_box_type) x
CROSS JOIN (SELECT distinct shipping_country FROM bi.customer_order) y
CROSS JOIN (SELECT distinct marketing_channel as first_marketing_channel FROM bi.marketing_order_attribution_aggregated) z
CROSS JOIN (SELECT 'yes' as first_order_referral UNION SELECT '20 euros' as first_order_referral UNION SELECT '50 euros' as first_order_referral) w
WHERE fo.date > '2012-02' and fo.date < curdate()
AND fo.day_of_month = 1
AND o.day_of_month = 1"	READY
98,309	2015-05-11 14:48:00	"1112787927"	true	2015-05-11 14:48:00	forecast.order__first_club_order		"CREATE VIEW forecast.order__first_club_order AS
SELECT
	fo.order_id,
	CASE WHEN fo.rank = 1 THEN true ELSE false END AS is_first_club_order,
	CASE WHEN fo.rank != 1 THEN true ELSE false END AS is_non_first_club_order
FROM
(SELECT
	co.customer_id,
	co.order_id,
	co.date_shipped,
	ROW_NUMBER() OVER ( PARTITION BY co.customer_id ORDER BY co.date_shipped ASC) AS rank
FROM ""bi.customer_order"" co
WHERE co.order_type = 'Outfittery Club Order') AS fo"	READY
353	2015-04-24 18:22:58	"1126921331"	true	2015-08-07 11:01:29	views.customer_ranked		"CREATE VIEW views.customer_ranked
AS
/*This sql replaces the views.ranked_customer_information, this is used in sub queries to get 3 clusters*/
WITH cust_cluster AS
(
	SELECT
	cast(clu2.rnum as integer) as ""rnum"",
	clu2.customerid as ""customer_id"",
	clu2.brand as ""brand"",
	clu2.marketing_cluster as ""cluster"",
	clu2.spent_per_brand as ""spent_in_cluster"",
	clu2.number_of_articles as ""articles_in_cluster"",
	foo2.category1,
	foo2.category2,
	foo2.category3,
	foo2.category4,
	foo2.category5,
	foo2.number_of_articles as ""articles_in_category""
	FROM 
	(
		SELECT
			row_number() over (partition by clu.customerid order by clu.spent_per_brand desc, clu.number_of_articles desc) as ""rnum"",
			clu.customerid as ""customerid"",
			clu.brand as ""brand"",
			clu.marketing_cluster,
			clu.number_of_articles as ""number_of_articles"",
			cast(clu.spent_per_brand as decimal) as ""spent_per_brand""
		FROM 
		(
			SELECT
				co.customer_id as ""customerid"",
				foo.brand,
				foo.marketing_cluster,
				sum(foo.op_retail_price) as ""spent_per_brand"",
				count(foo.op_orderid) as ""number_of_articles""
			FROM views.customer_order co
			JOIN
			( 
				SELECT
	    			op.order_id as ""op_orderid"",
					art.article_brand as ""brand"",
					b.marketing_cluster,
					op.retail_price as ""op_retail_price""
				FROM views.order_position op
				left join views.article art on art.article_id = op.article_id
				left join dwh.brands b on b.name = art.article_brand
				WHERE op.state= '1024'
			) foo on foo.op_orderid = co.id
			WHERE co.state= '1024'
			group by 1,2 ,3
		) clu 
	) clu2
	left join 
	(
		SELECT
			foo1.rnum,
			foo1.customer_id,
			foo1.category1,
			foo1.category2,
			foo1.category3,
			foo1.category4,
			foo1.category5,
			foo1.number_of_articles
		FROM 
		(
			SELECT
				row_number() over (partition by foo.customer_id order by foo.number_of_articles desc) as ""rnum"",
				foo.customer_id,
				foo.category1,
				foo.category2,
				foo.category3,
				foo.category4,
				foo.category5,
				foo.number_of_articles
			FROM 
			(
				SELECT
					co.customer_id as ""customer_id"",
					sac.cat1 as ""category1"",
					sac.category2 as ""category2"",
					sac.category3 as ""category3"",
					sac.cat4 as ""category4"",
					sac.cat5 as ""category5"",
					count(distinct(op.id)) as ""number_of_articles""
				FROM views.customer_order co
	  			inner join views.order_position op on op.order_id = co.id
	  			inner join views.supplier_article_categories sac on sac.supplier_article_id = op.supplier_article_id
	  			WHERE op.state=	'1024'
	  			and co.state= '1024'
	  			group by 1,2,3,4,5,6 
	  		) foo
	 		WHERE foo.category2 is not null
	 	) foo1
		WHERE foo1.rnum<= '5'
	) foo2
	on foo2.rnum = clu2.rnum and clu2.customerid = foo2.customer_id
	WHERE clu2.rnum<= '5'
)
SELECT
	cu.customer_id,
	cu.email,
	cu.first_name,
	cu.last_name,
	cu.postfix,
	cu.prefix,
	cu.profile_id,
	cu.salutation,
	cu.date_created,
	cu.last_login,
	cu.token,
	cu.default_page,
	cu.facebook_page,
	cu.salesforce_id,
	cu.referred_by_id,
	cu.first_order_date,   
	cu.first_order_date_completed,
	cu.branch_working_in,
	cu.date_of_birth,
	cu.height_in_cm,
	cu.phone_number,
	cu.preferred_brand,
	cu.preferred_contact_channel,
	cu.preferred_contact_time,
	cu.shirt_size,
	cu.shoe_size,
	cu.trousers_size,
	cu.weight_in_kg,
	cu.buying_problem_other,
	cu.newsletter_accepted,
	cu.preferred_brand_other,
	cu.spending_budget_for_jeans,
	cu.spending_budget_for_shirts,
	cu.spending_budget_for_shoes,
	cu.branch_working_in_other,
	cu.trousers_size_length,
	cu.trousers_size_width,
	cu.spending_budget_for_sakkos,
	cu.profile_date_created,
	cu.profile_last_updated,
	cu.referral,
	cu.date_newsletter_confirmed,
	cu.preferred_language,
	cu.collar_size,
	cu.spending_budget_for_shirts_FROM,
	cu.spending_budget_for_shirts_to,
	cu.spending_budget_for_jeans_FROM,
	cu.spending_budget_for_jeans_to,
	cu.spending_budget_for_shoes_FROM,
	cu.spending_budget_for_shoes_to,
	cu.spending_budget_for_sakkos_FROM,
	cu.spending_budget_for_sakkos_to,
	cu.buying_problems,
	cu.piclanguage,
	cu.picusagereason,
	cu.pictypicalbag,
	cu.pictypicalshoes,
	cu.picclothwork,
	cu.picagerange,
	cu.pictypicalstyle,
	cu.customer_image_min_date_created,
	cu.customer_image_max_last_updated,
	cu.customer_image_image_count,
	cu.customer_image_facebook_image_count,
	cu.customer_image_other_image_count,
	clust.rank1_category_articles,
	clust.rank1_brand,
	clust.rank1_cluster,
	clust.rank1_cluster_spent,
	clust.rank1_cluster_articles,
	clust.rank1_category1,
	clust.rank1_category2,
	clust.rank1_category3,
	clust.rank1_category4,
	clust.rank1_category5,
	clust.rank2_category_articles,
	clust.rank2_category1,
	clust.rank2_category2,
	clust.rank2_category3,
	clust.rank2_category4,
	clust.rank2_category5,
	clust.rank2_brand,
	clust.rank2_cluster,
	clust.rank2_cluster_spent,
	clust.rank2_cluster_articles,
	clust.rank3_category_articles,
	clust.rank3_category1,
	clust.rank3_category2,
	clust.rank3_category3,
	clust.rank3_category4,
	clust.rank3_category5,
	clust.rank3_brand,
	clust.rank3_cluster,
	clust.rank3_cluster_spent,
	clust.rank3_cluster_articles,
	clust.cluster
FROM views.customer cu
LEFT JOIN
(
	SELECT 
		r1.customer_id,
		r1.articles_in_category as ""rank1_category_articles"",
		r1.brand as ""rank1_brand"",
		r1.cluster as ""rank1_cluster"",
		r1.spent_in_cluster as ""rank1_cluster_spent"",
		r1.articles_in_cluster as ""rank1_cluster_articles"",
		r1.category1 as ""rank1_category1"",
		r1.category2 as ""rank1_category2"",
		r1.category3 as ""rank1_category3"",
		r1.category4 as ""rank1_category4"",
		r1.category5 as ""rank1_category5"",
		r2.articles_in_category as ""rank2_category_articles"",
		r2.category1 as ""rank2_category1"",
		r2.category2 as ""rank2_category2"",
		r2.category3 as ""rank2_category3"",
		r2.category4 as ""rank2_category4"",
		r2.category5 as ""rank2_category5"",
		r2.brand as ""rank2_brand"",
		r2.cluster as ""rank2_cluster"",
		r2.spent_in_cluster as ""rank2_cluster_spent"",
		r2.articles_in_cluster as ""rank2_cluster_articles"",
		r3.articles_in_category as ""rank3_category_articles"",
		r3.category1 as ""rank3_category1"",
		r3.category2 as ""rank3_category2"",
		r3.category3 as ""rank3_category3"",
		r3.category4 as ""rank3_category4"",
		r3.category5 as ""rank3_category5"",
		r3.brand as ""rank3_brand"",
		r3.cluster as ""rank3_cluster"",
		r3.spent_in_cluster as ""rank3_cluster_spent"",
		r3.articles_in_cluster as ""rank3_cluster_articles"",
		s.cluster
	FROM
	(
		/*Rank-1 Cluster*/
		SELECT
			customer_id,
			category1,
			category2,
			category3,
			category4,
			category5,
			articles_in_category,
			brand,
			cluster,
			spent_in_cluster,
			articles_in_cluster
		FROM cust_cluster
		WHERE rnum= '1'
	)r1
	LEFT JOIN 
	(
		/*Rank-2 Cluster*/
		SELECT
			customer_id,
			category1,
			category2,
			category3,
			category4,
			category5,
			articles_in_category,
			brand,
			cluster,
			spent_in_cluster,
			articles_in_cluster
		FROM cust_cluster
		WHERE rnum= '2'
	)r2 on r1.customer_id=r2.customer_id
	LEFT JOIN
	(
		/*Rank-3 Cluster*/
		SELECT
			customer_id,
			category1,
			category2,
			category3,
			category4,
			category5,
			articles_in_category,
			brand,
			cluster,
			spent_in_cluster,
			articles_in_cluster
		FROM cust_cluster
		WHERE rnum= '3'
	)r3 on r1.customer_id=r3.customer_id
	LEFT JOIN
	(
		SELECT
 			a.customer_id, 
 			a.cluster
		FROM 
		(
 			SELECT 
  				rc.customer_id, 
  				rc.cluster, 
  				COUNT(*) cluster_count, 
  				SUM(rc.spent_in_cluster) cluster_spend,
   				RANK() OVER (PARTITION BY rc.customer_id ORDER BY COUNT(*) DESC) as cluster_rank,
   				ROW_NUMBER() OVER (PARTITION BY rc.customer_id, COUNT(*) ORDER BY SUM(rc.spent_in_cluster) DESC) as spend_row
 			FROM cust_cluster rc
 			WHERE rc.cluster IS NOT NULL
 			GROUP BY 1,2
  		)a
		WHERE a.cluster_rank = 1 
		AND a.spend_row = 1
	)s on s.customer_id = r1.customer_id
)clust on clust.customer_id=cu.customer_id"	READY
348	2015-04-24 18:22:44	"1127038495"	true	2015-08-07 11:06:50	views.marketing_customer		"CREATE view views.marketing_customer
as

WITH ga_channel AS
(
  SELECT
    fc.customer_id as ""customer_id"",
    fc.rnum,

    case
    /* --------------------------------------------------- case first marketing channel when tv is not flagged by rapidape ----------------------*/
      when fc.order_id is null  and fc.channel= 'affiliate' and fc.cam_bit_1!= 'rem' then 'affiliate'
      when fc.order_id is null  and fc.channel= 'crm' and fc.cam_bit_1!= 'rem' then 'crm'
      when fc.order_id is null  and fc.channel= 'display' and fc.cam_bit_1!= 'rem' then 'display'
      when fc.order_id is null  and fc.channel= 'facebook' and fc.cam_bit_1!= 'rem' then 'facebook'
      when fc.order_id is null  and fc.channel= 'google gdn' and fc.cam_bit_1!= 'rem' then 'google gdn'
      when fc.order_id is null  and fc.channel= 'kooperation' and fc.cam_bit_1!= 'rem' then 'kooperation'
      when fc.order_id is null  and fc.channel= 'praemienprogramm' and fc.cam_bit_1!= 'rem' then 'praemienprogramm'
      when fc.order_id is null  and fc.channel= 'remarketing' and fc.cam_bit_1!= 'rem' then 'remarketing'
      when fc.order_id is null  and fc.channel= 'twitter' and fc.cam_bit_1!= 'rem' then 'twitter'
      when fc.order_id is null  and fc.channel= 'youtube' and fc.cam_bit_1!= 'rem' then 'youtube'
      when fc.order_id is null  and fc.channel= 'google sem' and fc.cam_bit_1!= 'rem' and fc.cam_bit_3!= 'brand' then 'google sem nobrand'
      when fc.order_id is null  and fc.channel= 'google sem' and fc.cam_bit_1!= 'rem' and fc.cam_bit_3= 'brand' then 'google sem brand'
      when fc.order_id is null  and fc.channel= 'direct' then 'direct'
      when fc.order_id is null  and fc.channel= 'organic' and fc.cam_bit_1!= 'rem' then 'organic'
      when fc.order_id is null  and fc.channel= '(not set)' and fc.cam_bit_1!= 'rem' then '(not set)'
      when fc.order_id is null  and fc.cam_bit_1= 'rem' then 'remarketing'
    /* --------------------------------------------------- case first marketing channel when tv is flagged by rapidape ---------------------------*/
      when fc.order_id is not null  and fc.channel= 'affiliate' and fc.cam_bit_1!= 'rem' then 'affiliate'
      when fc.order_id is not null  and fc.channel= 'crm' and fc.cam_bit_1!= 'rem' then 'crm'
      when fc.order_id is not null  and fc.channel= 'display' and fc.cam_bit_1!= 'rem' then 'display'
      when fc.order_id is not null  and fc.channel= 'facebook' and fc.cam_bit_1!= 'rem' then 'facebook'
      when fc.order_id is not null  and fc.channel= 'google gdn' and fc.cam_bit_1!= 'rem' then 'google gdn'
      when fc.order_id is not null  and fc.channel= 'kooperation' and fc.cam_bit_1!= 'rem' then 'kooperation'
      when fc.order_id is not null  and fc.channel= 'praemienprogramm' and fc.cam_bit_1!= 'rem' then 'praemienprogramm'
      when fc.order_id is not null  and fc.channel= 'remarketing' and fc.cam_bit_1!= 'rem' then 'remarketing'
      when fc.order_id is not null  and fc.channel= 'twitter' and fc.cam_bit_1!= 'rem' then 'twitter'
      when fc.order_id is not null  and fc.channel= 'youtube' and fc.cam_bit_1!= 'rem'  then 'youtube'
      when fc.order_id is not null  and fc.channel= 'google sem' and fc.cam_bit_1!= 'rem' and fc.cam_bit_3!= 'brand' then 'google sem nobrand'
      when fc.order_id is not null  and fc.channel= 'google sem' and fc.cam_bit_1!= 'rem' and fc.cam_bit_3= 'brand' then 'tv'
      when fc.order_id is not null  and fc.channel= 'direct' then 'tv'
      when fc.order_id is not null  and fc.channel= 'organic' and fc.cam_bit_1!= 'rem' then 'tv'
      when fc.order_id is not null  and fc.channel= '(not set)' and fc.cam_bit_1!= 'rem' then 'tv'
      when fc.order_id is not null  and fc.cam_bit_1= 'rem' then 'remarketing'
      else '(not set)'
    end as ""first_channel"",

    /*--------------------------------------case first marketing channel excluding tv --------------------------*/
    case
      when fc.cam_bit_1!= 'rem' and fc.channel= 'affiliate'                                then 'affiliate'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'crm'                                     then 'crm'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'display'                                 then 'display'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'facebook'                                then 'facebook'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'google gdn'                              then 'google gdn'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'kooperation'                             then 'kooperation'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'praemienprogramm'                        then 'praemienprogramm'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'remarketing'                             then 'remarketing'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'twitter'                                 then 'twitter'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'youtube'                                 then 'youtube'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'google sem' and fc.cam_bit_3!= 'brand'   then 'google sem nobrand'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'google sem' and fc.cam_bit_3= 'brand'    then 'google sem brand'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'direct'                                  then 'direct'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'organic'                                 then 'organic'
      when fc.cam_bit_1!= 'rem' and fc.channel= '(not set)'                               then '(not set)'
      when fc.cam_bit_1= 'rem'                                                            then 'remarketing'
      else '(not set)'
    end as ""first_channel_excl_tv""

  FROM 
  (
    SELECT
      row_number() over (partition by co.customer_id order by co.date_created asc) as ""rnum"",
      co.customer_id,
      co.id,
      tv1.order_id,
      tsm1.channel,
      ga.cam_bit_1,
      ga.cam_bit_3
    FROM views.customer_order co
    LEFT JOIN views.ga_information ga on co.id = ga.transaction_id
    LEFT JOIN views.ga_transactions_source_medium tsm1 on lower(ga.source_medium) = lower(tsm1.sourcemedium)
    LEFT JOIN views.marketingtv tv1 on co.id = tv1.order_id
  )fc
),

ga_channel_completed AS
(
  SELECT
    fc.customer_id as ""customer_id"",
    fc.rnum,

    case
    /* --------------------------------------------------- case first marketing channel when tv is not flagged by rapidape ----------------------*/
      when fc.order_id is null  and fc.channel= 'affiliate' and fc.cam_bit_1!= 'rem' then 'affiliate'
      when fc.order_id is null  and fc.channel= 'crm' and fc.cam_bit_1!= 'rem' then 'crm'
      when fc.order_id is null  and fc.channel= 'display' and fc.cam_bit_1!= 'rem' then 'display'
      when fc.order_id is null  and fc.channel= 'facebook' and fc.cam_bit_1!= 'rem' then 'facebook'
      when fc.order_id is null  and fc.channel= 'google gdn' and fc.cam_bit_1!= 'rem' then 'google gdn'
      when fc.order_id is null  and fc.channel= 'kooperation' and fc.cam_bit_1!= 'rem' then 'kooperation'
      when fc.order_id is null  and fc.channel= 'praemienprogramm' and fc.cam_bit_1!= 'rem' then 'praemienprogramm'
      when fc.order_id is null  and fc.channel= 'remarketing' and fc.cam_bit_1!= 'rem' then 'remarketing'
      when fc.order_id is null  and fc.channel= 'twitter' and fc.cam_bit_1!= 'rem' then 'twitter'
      when fc.order_id is null  and fc.channel= 'youtube' and fc.cam_bit_1!= 'rem' then 'youtube'
      when fc.order_id is null  and fc.channel= 'google sem' and fc.cam_bit_1!= 'rem' and fc.cam_bit_3!= 'brand' then 'google sem nobrand'
      when fc.order_id is null  and fc.channel= 'google sem' and fc.cam_bit_1!= 'rem' and fc.cam_bit_3= 'brand' then 'google sem brand'
      when fc.order_id is null  and fc.channel= 'direct' then 'direct'
      when fc.order_id is null  and fc.channel= 'organic' and fc.cam_bit_1!= 'rem' then 'organic'
      when fc.order_id is null  and fc.channel= '(not set)' and fc.cam_bit_1!= 'rem' then '(not set)'
      when fc.order_id is null  and fc.cam_bit_1= 'rem' then 'remarketing'
    /* --------------------------------------------------- case first marketing channel when tv is flagged by rapidape ---------------------------*/
      when fc.order_id is not null  and fc.channel= 'affiliate' and fc.cam_bit_1!= 'rem' then 'affiliate'
      when fc.order_id is not null  and fc.channel= 'crm' and fc.cam_bit_1!= 'rem' then 'crm'
      when fc.order_id is not null  and fc.channel= 'display' and fc.cam_bit_1!= 'rem' then 'display'
      when fc.order_id is not null  and fc.channel= 'facebook' and fc.cam_bit_1!= 'rem' then 'facebook'
      when fc.order_id is not null  and fc.channel= 'google gdn' and fc.cam_bit_1!= 'rem' then 'google gdn'
      when fc.order_id is not null  and fc.channel= 'kooperation' and fc.cam_bit_1!= 'rem' then 'kooperation'
      when fc.order_id is not null  and fc.channel= 'praemienprogramm' and fc.cam_bit_1!= 'rem' then 'praemienprogramm'
      when fc.order_id is not null  and fc.channel= 'remarketing' and fc.cam_bit_1!= 'rem' then 'remarketing'
      when fc.order_id is not null  and fc.channel= 'twitter' and fc.cam_bit_1!= 'rem' then 'twitter'
      when fc.order_id is not null  and fc.channel= 'youtube' and fc.cam_bit_1!= 'rem'  then 'youtube'
      when fc.order_id is not null  and fc.channel= 'google sem' and fc.cam_bit_1!= 'rem' and fc.cam_bit_3!= 'brand' then 'google sem nobrand'
      when fc.order_id is not null  and fc.channel= 'google sem' and fc.cam_bit_1!= 'rem' and fc.cam_bit_3= 'brand' then 'tv'
      when fc.order_id is not null  and fc.channel= 'direct' then 'tv'
      when fc.order_id is not null  and fc.channel= 'organic' and fc.cam_bit_1!= 'rem' then 'tv'
      when fc.order_id is not null  and fc.channel= '(not set)' and fc.cam_bit_1!= 'rem' then 'tv'
      when fc.order_id is not null  and fc.cam_bit_1= 'rem' then 'remarketing'
      else '(not set)'
    end as ""first_channel"",

    /*--------------------------------------case first marketing channel excluding tv --------------------------*/
    case
      when fc.cam_bit_1!= 'rem' and fc.channel= 'affiliate'                               then 'affiliate'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'crm'                                     then 'crm'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'display'                                 then 'display'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'facebook'                                then 'facebook'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'google gdn'                              then 'google gdn'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'kooperation'                             then 'kooperation'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'praemienprogramm'                        then 'praemienprogramm'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'remarketing'                             then 'remarketing'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'twitter'                                 then 'twitter'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'youtube'                                 then 'youtube'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'google sem' and fc.cam_bit_3!= 'brand'   then 'google sem nobrand'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'google sem' and fc.cam_bit_3= 'brand'    then 'google sem brand'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'direct'                                  then 'direct'
      when fc.cam_bit_1!= 'rem' and fc.channel= 'organic'                                 then 'organic'
      when fc.cam_bit_1!= 'rem' and fc.channel= '(not set)'                               then '(not set)'
      when fc.cam_bit_1= 'rem'                                                            then 'remarketing'
      else '(not set)'
    end as ""first_channel_excl_tv""

  FROM 
  (
    SELECT
      row_number() over (partition by co.customer_id order by co.date_created asc) as ""rnum"",
      co.customer_id,
      co.id,
      tv1.order_id,
      tsm1.channel,
      ga.cam_bit_1,
      ga.cam_bit_3
    FROM views.customer_order co
    LEFT JOIN views.ga_information ga on co.id = ga.transaction_id
    LEFT JOIN views.ga_transactions_source_medium tsm1 on lower(ga.source_medium) = lower(tsm1.sourcemedium)
    LEFT JOIN views.marketingtv tv1 on co.id = tv1.order_id
    WHERE co.state= '1024'
  )fc
)

SELECT 
  g1.customer_id,
  
  case
  	when g1.first_channel is null then '(not set)'
    else g1.first_channel
  end as first_channel,
  
  case
  	when g2.first_channel is null then '(not set)'
    else g2.first_channel
  end as first_channel_completed,
  
  case
    when g3.first_channel_excl_tv is null then '(not set)'
  	else g3.first_channel_excl_tv
  end as first_channel_excl_tv,
  
  case
  	when g4.first_channel_excl_tv is null then '(not set)'
    else g4.first_channel_excl_tv
  end as first_channel_completed_excl_tv
  
FROM
(
  SELECT 
    g.customer_id,
    g.first_channel
  FROM ga_channel g
  WHERE g.rnum=1
)g1

LEFT JOIN
(
  SELECT 
    g.customer_id,
    g.first_channel
  FROM ga_channel_completed g
  WHERE g.rnum=1
)g2 on g2.customer_id=g1.customer_id


LEFT JOIN
(
  SELECT 
    g.customer_id,
    g.first_channel_excl_tv
  FROM ga_channel g
  WHERE g.rnum=1
)g3 on g3.customer_id=g1.customer_id


LEFT JOIN
(
  SELECT 
    g.customer_id,
    g.first_channel_excl_tv
  FROM ga_channel_completed g
  WHERE g.rnum=1
)g4 on g4.customer_id=g1.customer_id"	READY
172	2015-04-24 18:18:02	"1112787689"	true	2015-04-24 18:18:02	ml.article_attribute		"CREATE VIEW ml.article_attribute AS
SELECT
aa.article_attributes_id AS article_id,
aa.attribute_id
FROM
postgres.article_attribute AS aa
WHERE aa.attribute_id IN (
	SELECT attribute_id FROM ""ml.amidala_category_leaves""
	UNION
	SELECT attribute_id FROM ""ml.attribute_season""
	UNION
	SELECT attribute_id FROM ""ml.attribute_amidala_age""
	UNION
	SELECT attribute_id FROM ""ml.attribute_outfittery_style""
	UNION
	SELECT attribute_id FROM ""ml.attribute_push""
)"	READY
183	2015-04-24 18:18:05	"1112787695"	true	2015-04-24 18:18:05	views.stock_inventory		"CREATE view views.stock_inventory
AS
SELECT 
	s1.date_created, 
	s1.sku as sku, 
	s1.quantity as quantity, 
	s1.reserved as reserved, 
	s2.quantity as quantity2, 
	s2.reserved as reserved2 
FROM 
(
	SELECT 
		cast(now() as date) as date_created, 
		se.quantity, 
		se.reserved, 
		se.sku 
	FROM views.stock_entry se
	UNION 
	SELECT 
		cast(timestampadd(SQL_TSI_DAY, -1, seh.date_created) as date) as date_created,
		seh.quantity,
		seh.reserved,
		seh.sku 
	FROM dwh.stock_entry_history seh
) s1
JOIN 
(
	SELECT 
		cast(seh2.date_created as date) as date_created,
		seh2.quantity,
		seh2.reserved,
		seh2.sku
	FROM dwh.stock_entry_history seh2
) s2 on s1.date_created = s2.date_created AND s1.sku = s2.sku"	READY
655,360	2015-09-03 17:41:42	"1298626185"	true	2015-09-11 17:01:50	tableau.mkt_performance_dashboard		"CREATE VIEW tableau.mkt_performance_dashboard
AS


/*This report only concerns invoiced orders*/
WITH act AS
(
SELECT
  c.""date"" as date_invoiced,
  x.country,
  CASE
    WHEN c.""date"" < CURDATE() THEN 'Actual' 
    ELSE 'Forecast'
  END AS order_state,
  SUBSTRING(c.""date"",1,4)||'-'||SUBSTRING(c.""date"",6,2) as year_month,
  invoiced_orders,
  invoiced_orders_final, 
  billing_total_final, 
  billing_total,
  mc.costs  
FROM dwh.calendar c 
CROSS JOIN (SELECT shipping_country as country FROM bi.customer_order WHERE shipping_country is not null AND  shipping_country != 'GB' GROUP BY 1) x
LEFT JOIN
(
  SELECT
    CAST(date_invoiced AS date) as date_invoiced,
    shipping_country,
    COUNT(order_id) as invoiced_orders,
    SUM(billing_total) as billing_total,
    SUM(CASE WHEN revenue_state = 'Final' THEN billing_total ELSE null END) as billing_total_final, 
    SUM(CASE WHEN revenue_state = 'Final' THEN 1 ELSE null END) as invoiced_orders_final 
  FROM bi.customer_order  
  WHERE order_type = 'First Order'
  AND is_real_order = 'Real Order'
  AND date_invoiced is not null
  AND order_state_number >= 16 
  AND order_state_number < 2048
  GROUP BY 1,2
) co ON c.""date"" = co.date_invoiced AND co.shipping_country = x.country
LEFT JOIN 
  (
    SELECT 
      date_created,
      country,
      SUM(cost) as costs
      FROM raw.marketing_costs
      WHERE date_created < CURDATE()
      GROUP BY 1,2
  ) mc ON c.""date"" = mc.date_created AND mc.country = x.country
)


SELECT
  fc.date_invoiced,
  act.order_state,
  fc.country as country,
  CAST(go.invoiced_order_goal as decimal) / CAST(fc.month_days  as decimal) as invoiced_order_goal,
  go.cac_goal * CAST(go.invoiced_order_goal as decimal) / CAST(fc.month_days  as decimal) as daily_cost_goal,
  go.average_basket_value_goal * CAST(go.invoiced_order_goal as decimal) / CAST(fc.month_days  as decimal) as daily_sales_goal,
  SUM(CASE 
    WHEN fc.days_month_passed = 0 THEN null
    WHEN (act.order_state = 'Forecast' AND fc.working_days = 1) THEN CAST(mo.actual_invoiced_orders/fc.working_days_passed as decimal)
    ELSE act.invoiced_orders
  END) AS invoiced_orders,
  SUM(CASE 
    WHEN fc.days_month_passed = 0 THEN null
    WHEN (act.order_state = 'Forecast' AND fc.working_days = 1) THEN CAST(mo.actual_billing_total/fc.working_days_passed as decimal)
    ELSE act.billing_total
  END) AS billing_total,
  SUM(CASE 
    WHEN fc.days_month_passed = 0 THEN null
    WHEN act.order_state = 'Forecast' THEN CAST(mo.actual_costs/fc.days_month_passed as decimal)
    ELSE act.costs
  END) AS costs,
  SUM(act.invoiced_orders_final) as invoiced_orders_final, 
  SUM(act.billing_total_final) as billing_total_final 
FROM
(
  SELECT
    CAST(c.""date"" as date) as date_invoiced,
    c.working_days,
    c.year_month,
    ca.month_days,
    x.country,
    ca.days_month_passed,
    ca.working_days as working_days_month,
    ca.working_days_passed
  FROM dwh.calendar c
  CROSS JOIN (SELECT shipping_country as country FROM bi.customer_order WHERE shipping_country is not null AND  shipping_country != 'GB' GROUP BY 1) x
  LEFT JOIN
  (
      SELECT
        year_month,
        COUNT(day_of_month) as month_days,
        SUM(working_days) as working_days,
        SUM(CASE WHEN ""date"" < CURDATE() THEN 1 ELSE 0 END) AS days_month_passed,
        SUM(CASE WHEN ""date"" < CURDATE() THEN working_days ELSE 0 END) as working_days_passed
      FROM dwh.calendar
      GROUP BY 1 
   ) ca ON ca.year_month = c.year_month
  WHERE c.""date"" >= '2015-01-01'
  AND last_day_of_month < TIMESTAMPADD(SQL_TSI_MONTH, 1, TIMESTAMPADD(SQL_TSI_DAY, -1, CURDATE()))
) fc
LEFT JOIN act ON fc.date_invoiced = act.date_invoiced AND fc.country = act.country
LEFT JOIN
(
  SELECT
    year_month,
    country,
    SUM(CASE WHEN order_state = 'Actual' THEN 1 ELSE 0 END) AS month_day_passed,
    SUM(invoiced_orders) as actual_invoiced_orders,
    SUM(billing_total) as actual_billing_total,
    SUM(costs) as actual_costs
  FROM act
  GROUP BY 1,2
) mo ON mo.year_month = fc.year_month AND fc.country = mo.country
LEFT JOIN dwh.marketing_new_customer_order_goals  go ON go.year_month = fc.year_month AND go.country = fc.country
GROUP BY 1,2,3,4,5,6"	READY
399	2015-04-24 18:24:33	"638185354"	true	2015-04-24 18:24:33	am.variant_pre_1		"CREATE VIEW am.variant_pre_1 AS
SELECT
v.*,
norm_eu_size.eu_size_normed ""eu_size_normed"",
v.eu_size_x_length ""eu_size_x_length_normed""
FROM ""am.variant_pre"" v
LEFT JOIN ""am.size_raw__size_normalized"" norm_eu_size ON norm_eu_size.eu_size = v.eu_size"	READY
174	2015-04-24 18:18:02	"926906561"	true	2015-06-24 15:09:55	views.marketingconstruct		"CREATE view views.marketingconstruct
as
select
	fd.date_created as ""datecreated"",
	mco.country as ""country"",
	mch.channel as ""channel""
from views.futuredate fd
cross join dwh.marketingcountries mco
cross join 
(
SELECT channel 
FROM dwh.marketingchannels
UNION
SELECT 'offline promotions' as channel
UNION 
SELECT 'inserts' as channel
UNION
SELECT 'social media' as channel
) 	
mch
option $allow_cartesian always"	READY
196,681	2015-06-16 17:34:33	"892835355"	true	2015-06-16 17:34:33	meta.schema__nav		"CREATE VIEW meta.schema__nav AS 
SELECT a.* FROM (call SYSADMIN.getResourceDependencies('nav_test', 'schema')) as a"	READY
397	2015-04-24 18:24:32	"652120076"	true	2015-04-24 18:24:32	am.example_variant		"CREATE VIEW ""am.example_variant"" AS
SELECT
v.*
FROM ""am.variant"" v
INNER JOIN ""am.example_base"" eb ON eb.pim_model_id = v.pim_model_id"	FAILED
402	2015-04-24 18:24:40	"1126921265"	true	2015-08-07 10:54:15	views.marketingdata		"CREATE VIEW views.marketingdata
AS
SELECT
	cu.customer_id as ""cu_id"",
	co.id as ""co_id"",
	sfa.CustomerStatus__c as ""sfa_customerloyalty"",
	CASE
		WHEN cu.salutation= '1' then 'Herr'
		WHEN cu.salutation= '2' then 'Frau'
	END as ""cu_salutation"",
	sfa.DuSie__c as ""cu_du_sie"",
	cu.first_name as ""cu_firstname"",
	cu.last_name as ""cu_lastname"",
	cu.token as ""cu_token"",
	cu.date_created as ""cu_datecreated_timestamp"",
	co.phone_date as ""co_phonedate_timestamp"",
	co.date_created as ""co_datecreated_timestamp"",
	co.customer_age as ""co_customerage"",
	co.state as ""co_orderstate"",
	CASE
		WHEN co.state= '4' then '1. Order Initiated'
		WHEN co.state= '8' then '2. Order Created'
		WHEN co.state in ('16','20','24','32','64') then '3. Order Packed'
		WHEN co.state in ('128','256','384') then '4. Order Shipped'
		WHEN co.state in ('512','1024') then '5. Order Completed'
		WHEN co.state= '2048' then '6. Order Cancelled'
		WHEN co.state= '1536' then '7.Order Lost'
		ELSE null
	END as ""co_trueorderstate"",
	CASE
		WHEN co.phone_date IS NULL then '0'
		ELSE '1'
	END as ""co_phonedateset"",
	co.sales_channel as ""co_saleschannel"",
	CASE 
		WHEN co.parent_order_id IS NULL then '0'
		ELSE '1'
	END as ""co_followon"",
	CASE
		WHEN co.real_repeat_order_count IS NULL AND co.parent_order_id IS NULL then 'first order'
		WHEN co.real_repeat_order_count= '1' AND co.parent_order_id IS NULL then 'first order'
		WHEN co.real_repeat_order_count> '1' AND co.parent_order_id IS NULL then 'real repeat order'
		WHEN co.real_repeat_order_count IS NULL AND co.parent_order_id is not null then 'follow on order'
		WHEN co.real_repeat_order_count= '1' AND co.parent_order_id is not null then 'follow on order'
		WHEN co.real_repeat_order_count> '1' AND co.parent_order_id is not null then 'follow on order'
	END as ""co_newrepeatfollow"",
	CASE
		WHEN co.real_order_count_completed IS NULL AND co.parent_order_id IS NULL AND co.state= '1024' then 'first order'
		WHEN co.real_order_count_completed= '1' AND co.parent_order_id IS NULL AND co.state= '1024' then 'first order'
		WHEN co.real_order_count_completed> '1' AND co.parent_order_id IS NULL AND co.state= '1024' then 'real repeat order'
		WHEN co.real_order_count_completed IS NULL AND co.parent_order_id is not null then 'follow on order'
		WHEN co.real_order_count_completed= '1' AND co.parent_order_id is not null then 'follow on order'
		WHEN co.real_order_count_completed> '1' AND co.parent_order_id is not null then 'follow on order'
	ELSE 'unclear'
	END as ""co_newrepeatfollow_completed"",
	co.real_repeat_order_count as ""co_ordercount"",
	co.real_order_count_completed as ""co_ordercount_completed"",
	co.parent_order_id as ""co_parentorderid"",
	pd2.parent_preview_id as ""pd_topicboxid"",
	CAST(cu.date_created as date) as ""cu_datecreated"",
	CAST(co.date_created as date) as ""co_datecreated"",
	CAST(co.phone_date as date) as ""co_phonedate"",
	CAST(co.date_picked as date) as ""co_datepicked"",
	CAST(co.date_shipped as date) as ""co_dateshipped"",
	CAST(co.date_returned as date) as ""co_datereturned"",
	CAST(co.date_completed as date) as ""co_datecompleted"",
	CAST(co.date_payed as date) as ""co_datepaid"",
	CAST(cu.date_of_birth as date) as ""pro_dateofbirth"",
	fo.fo_datefirstorder,
	fo.fo_datefirstorder_completed,
	op.op_totalbilled,
	op.op_articlesreturned,
	op.op_articleskept,
	op.op_articlesselected,
	co.total_amount_billed_retail_gross as ""co_billed"",
	co.total_amount_billed_discount as ""co_discountgranted"",
	CAST(CASE
			WHEN co.state in ('512','1024') then (co.total_amount_billed_retail_gross + co.total_amount_billed_discount)
			ELSE null
			END as decimal
		) as ""co_totalbilled"",
	CAST(CASE
			WHEN co.state in ('512','1024') then (co.total_amount_basket_retail_gross)
			ELSE null
			END as decimal
		) as ""co_totalbasket"",
	co.total_amount_payed as ""co_totalamountpaid"",
	co.payment_state as ""co_paymentstate"",
	co.payment_method as ""co_paymentmethod"",
	CASE
		WHEN co.vat_percentage= '19' then '0.19'
		WHEN co.vat_percentage= '20' then '0.20'
		WHEN co.vat_percentage= '8' then '0.08'
		ELSE null
	END as ""co_vatpercentage"",
	CASE
		WHEN co.payment_method= '1' then 'Invoice'
		WHEN co.payment_method= '2' then 'Credit Card'
		WHEN co.payment_method= '4' then 'Prepayment'
		WHEN co.payment_method= '6' then 'Arvato'
	END as ""co_truepaymentmethod"",
	CASE
		WHEN co.payment_state= '8' then 'Pending'
		WHEN co.payment_state= '16' then 'Authorised'
		WHEN co.payment_state= '32' then 'Captured'
		WHEN co.payment_state= '48' then 'Factored'
		WHEN co.payment_state= '64' then 'Paid'
		WHEN co.payment_state= '2048' then 'Cancelled'
	END as ""co_truepaymentstate"",
	CASE
		WHEN co.date_first_dunning IS NULL then '0'
		ELSE '1'
	END as ""co_firstdunning"",
	CASE
		WHEN co.date_second_dunning IS NULL then '0'
		ELSE '1'
	END as ""co_seconddunning"",
	CASE
		WHEN co.date_encashment IS NULL then '0'
		ELSE '1'
	END as ""co_encashment"",
	CAST(co.date_first_dunning as date) as ""co_datefirstdunning"",
	CAST(co.date_second_dunning as date) as ""co_dateseconddunning"",
	CAST(co.date_encashment as date) as ""co_dateencashment"",
	ga.source as ""ga_source"",
	ga.medium as ""ga_medium"",
	ga.campaign as ""ga_campaign"",
	ga.country as ""domain_name"",
	ga.cam_bit_1 as ""ga_cam_bit_1"",
	ga.cam_bit_2 as ""ga_cam_bit_2"",
	ga.cam_bit_3 as ""ga_cam_bit_3"",
	ga.keyword as ""ga_keyword"",
	ga.optimizely_campaign as ""optimizely_campaign"",
	CASE
	
		WHEN tv.order_id IS NULL  AND ga.channel= 'affiliate' AND ga.cam_bit_1!= 'rem' then 'affiliate'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'crm' AND ga.cam_bit_1!= 'rem' then 'crm'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'display' AND ga.cam_bit_1!= 'rem' then 'display'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'facebook' AND ga.cam_bit_1!= 'rem' then 'facebook'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'google gdn' AND ga.cam_bit_1!= 'rem' then 'google gdn'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'kooperation' AND ga.cam_bit_1!= 'rem' then 'kooperation'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'praemienprogramm' AND ga.cam_bit_1!= 'rem' then 'praemienprogramm'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'remarketing' AND ga.cam_bit_1!= 'rem' then 'remarketing'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'twitter' AND ga.cam_bit_1!= 'rem' then 'twitter'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'youtube' AND ga.cam_bit_1!= 'rem' then 'youtube'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'google sem' AND ga.cam_bit_1!= 'rem' AND ga.cam_bit_3!= 'brand' then 'google sem nobrand'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'google sem' AND ga.cam_bit_1!= 'rem' AND ga.cam_bit_3= 'brand' then 'google sem brand'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'direct' then 'direct'
	 	WHEN tv.order_id IS NULL  AND ga.channel= 'organic' AND ga.cam_bit_1!= 'rem' then 'organic'
	 	WHEN tv.order_id IS NULL  AND ga.channel= '(not set)' AND ga.cam_bit_1!= 'rem' then '(not set)'
	 	WHEN tv.order_id IS NULL  AND ga.cam_bit_1= 'rem' then 'remarketing'
	 	ELSE '(not set)'
	END as ""tsm_channel"",
	CASE
	  
	 	WHEN ga.channel= 'affiliate' AND ga.cam_bit_1!= 'rem' then 'affiliate'
	 	WHEN ga.channel= 'crm' AND ga.cam_bit_1!= 'rem' then 'crm'
	 	WHEN ga.channel= 'display' AND ga.cam_bit_1!= 'rem' then 'display'
	 	WHEN ga.channel= 'facebook' AND ga.cam_bit_1!= 'rem' then 'facebook'
	 	WHEN ga.channel= 'google gdn' AND ga.cam_bit_1!= 'rem' then 'google gdn'
	 	WHEN ga.channel= 'kooperation' AND ga.cam_bit_1!= 'rem' then 'kooperation'
	 	WHEN ga.channel= 'praemienprogramm' AND ga.cam_bit_1!= 'rem' then 'praemienprogramm'
	 	WHEN ga.channel= 'remarketing' AND ga.cam_bit_1!= 'rem' then 'remarketing'
	 	WHEN ga.channel= 'twitter' AND ga.cam_bit_1!= 'rem' then 'twitter'
	 	WHEN ga.channel= 'youtube' AND ga.cam_bit_1!= 'rem' then 'youtube'
	 	WHEN ga.channel= 'google sem' AND ga.cam_bit_1!= 'rem' AND ga.cam_bit_3!= 'brand' then 'google sem nobrand'
	 	WHEN ga.channel= 'google sem' AND ga.cam_bit_1!= 'rem' AND ga.cam_bit_3= 'brand' then 'google sem brand'
	 	WHEN ga.channel= 'direct' then 'direct'
	 	WHEN ga.channel= 'organic' AND ga.cam_bit_1!= 'rem' then 'organic'
	 	WHEN ga.channel= '(not set)' AND ga.cam_bit_1!= 'rem' then '(not set)'
	 	WHEN ga.cam_bit_1= 'rem' then 'remarketing'
	 	ELSE '(not set)'
	END as ""tsm_channel_excluding_tv"",
	fc1.channel as ""fc_firstchannel"",
	fc2.channel as ""fc_firstchannel_completed"",
	co.first_saleschannel_completed,
	ga.operating_system as ""sy_operatingsystem"",
	ga.device_category as ""sy_devicecategory"",
	ga.browser as ""sy_browser"",
	CAST(ga.visits_per_transactionid as integer) as ""ga_visits_per_transactionid"",
	tv.order_id as ""tv_orderid"",
	CASE
		WHEN tv.order_id IS NULL then 'not flagged as tv'
		WHEN tv.order_id is not null then 'flagged as tv'
		ELSE 'ask BI'
	END as ""tv_spot"",
	tv.""date_spot_aired"" as ""tv_date_spot_aired"",
	tv.""timestamp_spot_aired"" as ""tv_time_spot_aired"",
	tv.tv_station as ""tv_station"",
	tv.tv_program as ""tv_program"",
	cam.id as ""cam_id"",
	cam.code as ""cam_code"",
	cam.campaign_type as ""cam_campaigntype"",
	CASE
		WHEN left(cam.campaign_title,19)= 'DriveNow Rallye Dez' then 'drivenow rallye dez'
		ELSE cam.campaign_title
	END as ""cam_campaigntitle"",
	cam.useable_amount as ""cam_usableamount"",
	CAST(cam.date_start as date) as ""cam_startdate"",
	CAST(cam.date_end as date) as ""cam_enddate"",
	cam.version as ""cam_version"",
	cam.discount_absolute as ""cam_absolutediscount"",
	cam.discount_percentage as ""cam_relativediscount"",
	sty.first_name as ""sty_firstname"",
	sty.last_name as ""sty_lastname"",
	sty.user_role as ""sty_team"",
	cu.phone_number as ""pro_phonenumber"",
	cu.email as ""cu_email"",
	cu.preferred_language as ""pro_preflanguage"",
	cu.preferred_contact_time as ""pro_prefcontacttime"",
	cu.preferred_contact_channel as ""pro_prefcontactchannel"",
	cu.branch_working_in as ""pro_branch"",
	cu.branch_working_in_other as ""pro_branchalt"",
	cu.preferred_brand as ""pro_prefbrand"",
	cu.preferred_brand_other as ""pro_prefbrandalt"",
	cu.height_in_cm as ""pro_heightcm"",
	cu.weight_in_kg as ""pro_weightkg"",
	cu.default_page,
	CASE
		WHEN cu.spending_budget_for_jeans= '7' then '60 - 80'
		WHEN cu.spending_budget_for_jeans= '8' then '80 - 120'
		WHEN cu.spending_budget_for_jeans= '9' then '120 - 180'
		WHEN cu.spending_budget_for_jeans= '10' then '> 180'
		ELSE 'not defined'
	END as ""pro_budgetjeans"",
	CASE
		WHEN cu.spending_budget_for_shirts= '4' then '40 - 60'
		WHEN cu.spending_budget_for_shirts= '5' then '60 - 80'
		WHEN cu.spending_budget_for_shirts= '6' then '80 - 100'
		WHEN cu.spending_budget_for_shirts= '7' then '> 100'
		ELSE 'not defined'
	END as ""pro_budgetshirts"",
	CASE
		WHEN cu.spending_budget_for_shoes= '4' then '60 - 100'
		WHEN cu.spending_budget_for_shoes= '5' then '100 - 200'
		WHEN cu.spending_budget_for_shoes= '6' then '> 200'
		ELSE 'not defined'
	END as ""pro_budgetshoes"",
	CASE
		WHEN cu.spending_budget_for_sakkos= '4' then '100 - 150' 
		WHEN cu.spending_budget_for_sakkos= '5' then '150 - 200' 
		WHEN cu.spending_budget_for_sakkos= '6' then '> 200' 
		ELSE 'not defined'
	END as ""pro_budgetsakkos"",
	r.rank1_cluster,
	r.rank1_cluster_spent,
	r.rank1_cluster_articles,
	r.rank1_category1,
	r.rank1_category2,
	r.rank1_category3,
	r.rank1_category4,
	r.rank1_category5,
	r.rank1_category_articles,
	r.rank1_brand,
	r.rank2_category_articles,
	r.rank2_cluster,
	r.rank2_cluster_spent,
	r.rank2_cluster_articles,
	r.rank2_category1,
	r.rank2_category2,
	r.rank2_category3,
	r.rank2_category4,
	r.rank2_category5,
	r.rank2_brand,
	r.rank3_category1,
	r.rank3_category2,
	r.rank3_category3,
	r.rank3_category4,
	r.rank3_category5,
	r.rank3_category_articles,
	r.rank3_brand,
	r.rank3_cluster,
	r.rank3_cluster_spent,
	r.rank3_cluster_articles,
	r.cluster,
	cu.newsletter_accepted as ""pro_newsletteraccepted"",
	CASE
		WHEN cu.date_newsletter_confirmed IS NULL then '0'
		WHEN cu.date_newsletter_confirmed is not null then '1'
	END as ""pro_newsletterconfirmed"",
	cu.date_newsletter_confirmed as ""pro_datenewsletterconfirmed"",
	CASE
		WHEN sfa.UnsubscribedNL__c= 'true' then '1'
		WHEN sfa.UnsubscribedNL__c= 'false' then '0'
	END as ""sfa_newsletterunsubscribed"",
	 CASE
		WHEN cu.newsletter_accepted= 'true' AND cu.date_newsletter_confirmed IS NULL AND sfa.UnsubscribedNL__c= 'false' then 'soi'
		WHEN cu.newsletter_accepted= 'true' AND cu.date_newsletter_confirmed is not null AND sfa.UnsubscribedNL__c= 'false' then 'doi'
	  	WHEN cu.newsletter_accepted= 'true' AND cu.date_newsletter_confirmed IS NULL AND sfa.UnsubscribedNL__c= 'true' then 'unsubscribed'
	  	WHEN cu.newsletter_accepted= 'true' AND cu.date_newsletter_confirmed is not null AND sfa.UnsubscribedNL__c= 'true' then 'unsubscribed'
	  	WHEN cu.newsletter_accepted= 'false' AND cu.date_newsletter_confirmed IS NULL AND sfa.UnsubscribedNL__c= 'true' then 'unsubscribed'
	  	WHEN cu.newsletter_accepted= 'false' AND cu.date_newsletter_confirmed is not null AND sfa.UnsubscribedNL__c= 'true' then 'unsubscribed'
	  	WHEN cu.newsletter_accepted= 'false' AND cu.date_newsletter_confirmed IS NULL AND sfa.UnsubscribedNL__c= 'false' then 'not accepted'
	  	WHEN cu.newsletter_accepted= 'false' AND cu.date_newsletter_confirmed is not null AND sfa.UnsubscribedNL__c= 'false' then 'not accepted'
	  	ELSE '(not set)'
	 END as ""subscribe_status"",
	sfo.SalesChannel_Special__c as ""sfo_saleschannel_special"",
	CASE
	 	WHEN sfo.Vorkasse_Email_sent__c= 'false' then '0'
	 	WHEN sfo.Vorkasse_Email_sent__c= 'true' then '1'
	END as ""sfo_prepaymentemail"",
	CASE
		WHEN sfo.notReached__c= 'false' then '0'
		WHEN sfo.notReached__c= '0' then '0'
		WHEN sfo.notReached__c= 'true' then '1'
		WHEN sfo.notReached__c= '1' then '1' 
		ELSE 'not defined'
	END as ""sfo_notreached"",
	sfo.SalesChannel__c as ""sfo_saleschannel"",
	CASE 
		WHEN sfo.CallConfirmed__c= 'true' then '1'
		WHEN sfo.CallConfirmed__c= 'false' then '0'
		ELSE 'ask BI'
	END as ""sfo_callconfirmed"",
	CASE
		WHEN sfo.NoCall_Box__c= 'true' then '1'
		WHEN sfo.NoCall_Box__c= 'false' then '0'
		ELSE 'ask BI'
	END as ""sfo_nocallbox"",
	sfo.OpsCheck__c as ""sfo_opscheck"",
	sfo.DateFirstOrder__c as ""sfo_datefirstorder"",
	sfo.StageName as ""sfo_stage"",
	sfo.InactiveReason__c as ""sfo_inactive_reason"",
	sfo.CS_Reason__c as ""sfo_cs_reason"",
	co.shipping_country as ""addr_country"",
	co.shipping_city as ""addr_city"",
	co.shipping_zip as ""addr_zip"",
	co.shipping_street as ""addr_street"",
	co.shipping_street_number as ""addr_streetnumber"",
	co.shipping_first_name as ""addr_firstname"",
	co.shipping_last_name as ""addr_lastname"",
	cu.prefix as ""cu_title"",
	co.order_state as is_real_order
FROM views.customer cu
LEFT JOIN views.customer_order co on cu.customer_id = co.customer_id
LEFT JOIN views.ga_information ga on co.id = ga.transaction_id
LEFT JOIN views.campaign cam on co.campaign_id = cam.id
LEFT JOIN views.salesforce_account sfa on cu.customer_id = sfa.ExternalCustomerid__c
LEFT JOIN views.salesforce_opportunity sfo on co.id = sfo.ExternalOrderId__c
LEFT JOIN views.stylist sty on co.stylelist_id = sty.stylist_id
LEFT JOIN views.marketingtv tv on co.id = tv.order_id
LEFT JOIN 
(
	SELECT
  		fc.customer_id as ""customer_id"",
  		CASE
		  
		   WHEN fc.order_id IS NULL  AND fc.channel= 'affiliate' AND fc.cam_bit_1!= 'rem' then 'affiliate'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'crm' AND fc.cam_bit_1!= 'rem' then 'crm'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'display' AND fc.cam_bit_1!= 'rem' then 'display'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'facebook' AND fc.cam_bit_1!= 'rem' then 'facebook'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'google gdn' AND fc.cam_bit_1!= 'rem' then 'google gdn'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'kooperation' AND fc.cam_bit_1!= 'rem' then 'kooperation'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'praemienprogramm' AND fc.cam_bit_1!= 'rem' then 'praemienprogramm'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'remarketing' AND fc.cam_bit_1!= 'rem' then 'remarketing'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'twitter' AND fc.cam_bit_1!= 'rem' then 'twitter'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'youtube' AND fc.cam_bit_1!= 'rem' then 'youtube'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'google sem' AND fc.cam_bit_1!= 'rem' AND fc.cam_bit_3!= 'brand' then 'google sem nobrand'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'google sem' AND fc.cam_bit_1!= 'rem' AND fc.cam_bit_3= 'brand' then 'google sem brand'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'direct' then 'direct'
		   WHEN fc.order_id IS NULL  AND fc.channel= 'organic' AND fc.cam_bit_1!= 'rem' then 'organic'
		   WHEN fc.order_id IS NULL  AND fc.channel= '(not set)' AND fc.cam_bit_1!= 'rem' then '(not set)'
		   WHEN fc.order_id IS NULL  AND fc.cam_bit_1= 'rem' then 'remarketing'
		   ELSE '(not set)'
		END as ""channel""
	FROM 
	(
 		SELECT
	  		row_number() over (partition by co1.customer_id order by co1.date_created asc) as ""rnum"",
	  		co1.customer_id,
	  		co1.id,
	  		tv1.order_id,
	  		ga1.channel,
	  		ga1.cam_bit_1,
	  		ga1.cam_bit_3
  		FROM views.customer_order co1
  		LEFT JOIN views.ga_information ga1 on co1.id = ga1.transaction_id
  		LEFT JOIN views.marketingtv tv1 on co1.id = tv1.order_id
  	) fc 
 	WHERE fc.rnum= '1'
) fc1 on fc1.customer_id = cu.customer_id
LEFT JOIN 
(
	SELECT
  		fc.customer_id as ""customer_id"",
		CASE
		
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'affiliate' AND fc.cam_bit_1!= 'rem' then 'affiliate'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'crm' AND fc.cam_bit_1!= 'rem' then 'crm'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'display' AND fc.cam_bit_1!= 'rem' then 'display'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'facebook' AND fc.cam_bit_1!= 'rem' then 'facebook'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'google gdn' AND fc.cam_bit_1!= 'rem' then 'google gdn'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'kooperation' AND fc.cam_bit_1!= 'rem' then 'kooperation'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'praemienprogramm' AND fc.cam_bit_1!= 'rem' then 'praemienprogramm'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'remarketing' AND fc.cam_bit_1!= 'rem' then 'remarketing'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'twitter' AND fc.cam_bit_1!= 'rem' then 'twitter'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'youtube' AND fc.cam_bit_1!= 'rem' then 'youtube'
		  	 	WHEN fc.order_id IS NULL  AND fc.channel= 'google sem' AND fc.cam_bit_1!= 'rem' AND fc.cam_bit_3!= 'brand' then 'google sem nobrand'
		  		WHEN fc.order_id IS NULL  AND fc.channel= 'google sem' AND fc.cam_bit_1!= 'rem' AND fc.cam_bit_3= 'brand' then 'google sem brand'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'direct' then 'direct'
		   		WHEN fc.order_id IS NULL  AND fc.channel= 'organic' AND fc.cam_bit_1!= 'rem' then 'organic'
		   		WHEN fc.order_id IS NULL  AND fc.channel= '(not set)' AND fc.cam_bit_1!= 'rem' then '(not set)'
		   		WHEN fc.order_id IS NULL  AND fc.cam_bit_1= 'rem' then 'remarketing'
		   		ELSE '(not set)'
			END as ""channel""
 		FROM 
 		(
			SELECT
				row_number() over (partition by co1.customer_id order by co1.date_created asc) as ""rnum"",
				co1.customer_id,
				co1.id,
				tv1.order_id,
				ga1.channel,
				ga1.cam_bit_1,
				ga1.cam_bit_3
			FROM views.customer_order co1
			LEFT JOIN views.ga_information ga1 on co1.id = ga1.transaction_id
			LEFT JOIN views.marketingtv tv1 on co1.id = tv1.order_id
			WHERE co1.state= '1024'
		) fc
		WHERE fc.rnum= '1'
) fc2 on fc2.customer_id = cu.customer_id
LEFT JOIN 
(
	SELECT
		customer_id,
		MIN(case when state=1024 then cast(date_completed as date) else null end) as fo_datefirstorder,
		MIN(cast(date_created as date)) as fo_datefirstorder_completed
	FROM views.customer_order
	GROUP BY 1
) fo on fo.customer_id = cu.customer_id
LEFT JOIN 
(
	SELECT
		order_id,
		COUNT(CASE WHEN state= '512'  THEN'1' ELSE null END) as op_articlesreturned,
  		COUNT(CASE WHEN state= '1024' THEN '1' ELSE null END) as op_articleskept,
  		COUNT(CASE WHEN state>= '128' THEN '1' ELSE null END) as op_articlesselected,
	    SUM(CASE WHEN state=1024 THEN CAST(retail_price as decimal) else 0 end) as op_totalbilled
	FROM views.order_position
	GROUP BY 1
)op on op.order_id = co.id
LEFT JOIN
(
	SELECT 
 		pd.parent_preview_id,
 		pd.order_id
	FROM
	(
		SELECT 
  			parent_preview_id,
  			order_id,
  			row_number() over (partition by order_id order by date_created desc) as ""rnum""
 		FROM views.preview_data
 	) pd
	WHERE pd.rnum= '1'
) pd2 on pd2.order_id = co.id
LEFT JOIN views.customer_ranked r on r.customer_id = cu.customer_id
WHERE cu.customer_id is not null
AND co.order_state='Real Order'"	READY
354	2015-04-24 18:23:01	"1126921287"	true	2015-08-07 10:58:59	views.article_own_stock		"CREATE view views.article_own_stock
AS
select 
	op.article_id,
	sa.pic2,
	sa.pic3,
	sa.pic4,
	sa.pic5,
	sa.amidala_check,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 4 THEN quantity ELSE 0 END) AS Int_4, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 4 THEN quantity*op.retail_price ELSE 0 END) AS Int_4_vk_wert, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 4 THEN quantity*op.retail_price_euro ELSE 0 END) AS Int_4_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 4 THEN quantity*op.purchase_price ELSE 0 END) AS Int_4_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 8 THEN quantity ELSE 0 END) AS Placed_8, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 8 THEN quantity*op.retail_price ELSE 0 END) AS Placed_8_vk_wert,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 8 THEN quantity*op.retail_price_euro ELSE 0 END) AS Placed_8_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 8 THEN quantity*op.purchase_price ELSE 0 END) AS Placed_8_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 16 and co.state != 16 THEN quantity ELSE 0 END) AS Picked_16,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 16 and co.state != 16 THEN quantity*op.retail_price ELSE 0 END) AS Picked_16_vk_wert,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 16 and co.state != 16 THEN quantity*op.retail_price_euro ELSE 0 END) AS Picked_16_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 16 and co.state != 16 THEN quantity*op.purchase_price ELSE 0 END) AS Picked_16_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state=16 and co.state = 20 THEN quantity ELSE 0 END) AS PO_20,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=16 and co.state = 20 THEN quantity*op.retail_price ELSE 0 END) AS PO_20_vk_wert,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=16 and co.state = 20 THEN quantity*op.retail_price_euro ELSE 0 END) AS PO_20_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=16 and co.state = 20 THEN quantity*op.purchase_price ELSE 0 END) AS PO_20_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state=16 and co.state = 24 THEN quantity ELSE 0 END) AS SO_24,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=16 and co.state = 24 THEN quantity*op.retail_price ELSE 0 END) AS SO_24_vk_wert,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=16 and co.state = 24 THEN quantity*op.retail_price_euro ELSE 0 END) AS SO_24_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=16 and co.state = 24 THEN quantity*op.purchase_price ELSE 0 END) AS SO_24_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state=32 and co.state = 32 THEN quantity ELSE 0 END) AS Stocked_32,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=32 and co.state = 32 THEN quantity*op.retail_price ELSE 0 END) AS Stocked_32_vk_wert,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=32 and co.state = 32 THEN quantity*op.retail_price_euro ELSE 0 END) AS Stocked_32_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=32 and co.state = 32 THEN quantity*op.purchase_price ELSE 0 END) AS Stocked_32_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state=64 and co.state = 64 THEN quantity ELSE 0 END) AS Packed_64,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=64 and co.state = 64 THEN quantity*op.retail_price ELSE 0 END) AS Packed_64_vk_wert,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=64 and co.state = 64 THEN quantity*op.retail_price_euro ELSE 0 END) AS Packed_64_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state=64 and co.state = 64 THEN quantity*op.purchase_price ELSE 0 END) AS Packed_64_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 128 THEN quantity ELSE 0 END) AS Sent_128,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 128 THEN quantity*op.retail_price ELSE 0 END) AS Sent_128_vk_wert,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 128 THEN quantity*op.retail_price_euro ELSE 0 END) AS Sent_128_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 128 THEN quantity*op.purchase_price ELSE 0 END) AS Sent_128_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 256 THEN quantity ELSE 0 END) AS Arrived_256, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 256 THEN quantity*op.retail_price ELSE 0 END) AS Arrived_256_vk_wert,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 256 THEN quantity*op.retail_price_euro ELSE 0 END) AS Arrived_256_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 256 THEN quantity*op.purchase_price ELSE 0 END) AS Arrived_256_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 384 THEN quantity ELSE 0 END) AS ReturnedOnline_384, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 384 THEN quantity*op.retail_price ELSE 0 END) AS ReturnedOnline_384_vk_wert,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 384 THEN quantity*op.retail_price_euro ELSE 0 END) AS ReturnedOnline_384_vk_wert_euro, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 384 THEN quantity*op.purchase_price ELSE 0 END) AS ReturnedOnline_384_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 512 THEN quantity ELSE 0 END) AS Returned_512, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 512 THEN quantity*op.retail_price ELSE 0 END) AS Returned_512_vk_wert, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 512 THEN quantity*op.retail_price_euro ELSE 0 END) AS Returned_512_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 512 THEN quantity*op.purchase_price ELSE 0 END) AS Returned_512_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 1024 THEN quantity ELSE 0 END) AS Completed_1024, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 1024 THEN quantity*op.retail_price ELSE 0 END) AS Completed_1024_vk_wert,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 1024 THEN quantity*op.retail_price_euro ELSE 0 END) AS Completed_1024_vk_wert_euro, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 1024 THEN quantity*op.purchase_price ELSE 0 END) AS Completed_1024_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 2048 THEN quantity ELSE 0 END) AS Canceled_2048, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 2048 THEN quantity*op.retail_price ELSE 0 END) AS Canceled_2048_vk_wert, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 2048 THEN quantity*op.retail_price_euro ELSE 0 END) AS Canceled_2048_vk_wert_euro,
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 2048 THEN quantity*op.purchase_price ELSE 0 END) AS Canceled_2048_ek_wert,
	
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 1536 THEN quantity ELSE 0 END) AS Lost_1536, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 1536 THEN quantity*op.retail_price ELSE 0 END) AS Lost_1536_vk_wert, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 1536 THEN quantity*op.retail_price_euro ELSE 0 END) AS Lost_1536_vk_wert_euro, 
	SUM(CASE WHEN op.stock_location_id=2 and op.state = 1536 THEN quantity*op.purchase_price ELSE 0 END) AS Lost_1536_ek_wert,
	
	MIN(CASE WHEN co.order_state='Outfittery Order' THEN cast(op.date_created  AS date) ELSE NULL END) AS first_order_date,
	MAX(CASE WHEN co.order_state='Outfittery Order' THEN cast(op.date_created  AS date) ELSE NULL END) AS last_order_date,
	MIN(CASE WHEN co.order_state='Outfittery Order' THEN cast(op.date_returned AS date) ELSE NULL END) AS first_date_returned, 
	MAX(CASE WHEN co.order_state='Outfittery Order' THEN cast(op.date_returned AS date) ELSE NULL END) AS last_date_returned, 
	MIN(CASE WHEN co.order_state='Outfittery Order' THEN cast(op.date_shipped  AS date) ELSE NULL END) AS first_date_shipped, 
	MAX(CASE WHEN co.order_state='Outfittery Order' THEN cast(op.date_shipped  AS date) ELSE NULL END) AS last_date_shipped,
    SUM(CASE WHEN co.order_state='Outfittery Order' THEN op.quantity ELSE 0 END) AS quantity
FROM views.order_position op
LEFT JOIN views.customer_order co on co.id=op.order_id
LEFT JOIN views.article sa on sa.article_id=op.article_id
WHERE sa.supplier_id = 15
GROUP BY 1,2,3,4,5,6"	READY
362	2015-04-24 18:23:11	"1112787839"	true	2015-04-24 18:23:11	ml.article_kept_returned		"CREATE VIEW ml.article_kept_returned AS
SELECT
	am.article_id,
	COALESCE(kept, 0) AS article_kept,
	COALESCE(returned, 0) AS article_returned,
	COALESCE(SUM(am.kept) OVER (PARTITION BY am.molor_id), 0) AS molor_kept,
	COALESCE(SUM(am.returned) OVER (PARTITION BY am.molor_id), 0) AS molor_returned,
	COALESCE(SUM(am.kept) OVER (PARTITION BY am.model_id), 0) AS model_kept,
	COALESCE(SUM(am.returned) OVER (PARTITION BY am.model_id), 0) AS model_returned,
	COALESCE(SUM(am.kept) OVER (PARTITION BY am.catbra), 0) AS catbra_kept,
	COALESCE(SUM(am.returned) OVER (PARTITION BY am.catbra), 0) AS catbra_returned,
	COALESCE(SUM(am.kept) OVER (PARTITION BY am.brand), 0) AS brand_kept,
	COALESCE(SUM(am.returned) OVER (PARTITION BY am.brand), 0) AS brand_returned,
	COALESCE(SUM(am.kept) OVER (PARTITION BY am.flat_category), 0) AS flat_category_kept,
	COALESCE(SUM(am.returned) OVER (PARTITION BY am.flat_category), 0) AS flat_category_returned
FROM
(SELECT
	akr.article_id,
	m.molor_id,
	a.article_model_id AS model_id,
	acb.catbra AS catbra,
	a.article_brand AS brand,
	ac.flat_category,
	akr.kept,
	akr.returned
FROM
(SELECT
	coa.article_id AS article_id,
	SUM(CASE
		WHEN coa.order_article_state = 'Returned' THEN 1
		WHEN coa.order_article_state = 'Kept' THEN 0 END) AS returned,
	SUM(CASE
		WHEN coa.order_article_state = 'Kept' THEN 1
		WHEN coa.order_article_state = 'Returned' THEN 0 END) AS kept
	FROM bi.customer_order_articles AS coa
GROUP BY coa.article_id) AS akr
JOIN bi.article AS a
	ON a.article_id = akr.article_id
LEFT JOIN ml.article_molor AS m
	ON akr.article_id = m.article_id
LEFT JOIN ml.articles_categories AS ac
	ON akr.article_id = ac.article_id
LEFT JOIN ml.article_catbra AS acb
	ON akr.article_id = acb.article_id) AS am
ORDER BY article_id ASC
LIMIT 2000000"	READY
753,666	2015-09-11 11:30:58	"1298626221"	true	2015-09-11 17:07:36	tableau.bisdev_gift_orders		"CREATE VIEW tableau.bisdev_gift_orders
AS

SELECT 
  co.order_id,
  co.customer_id,
  co.date_created,
  co.date_shipped,
  co.payment_type,
  co.shipping_country,
  co.shipping_city,
  co.sales_sent,
  case when revenue_state='Final' then co.sales_kept end as sales_kept,
  co.billing_received,
  cu.customer_age,
  co.follow_on_count,
  co.real_order_count,
  co.sales_channel,
  co.order_state_number,
   CASE
    WHEN co.order_type = 'First Order' THEN 'First Order'
    WHEN co.order_type in ('Repeat Order', 'Outfittery Club Order') THEN 'Real Repeat Order'
    WHEN co.order_type in ('First Order Follow-on', 'Repeat Order Follow-on') THEN 'Follow on Order'
    ELSE 'Ask BI'
  END as order_type,
  timestampdiff(SQL_TSI_DAY,co.date_shipped,co.date_returned) as days_shipped_returned,
  co.box_type,
  co.arvato_result,
  co.arvato_score,
  cu.club_member,
  sfo.newcardrecommendation,
  sty.stylist,
  cast(f.first_order_date as date) as first_order_date,
  sfa.customer_status,
  sfa.bmi,
  co.articles_sent,
  co.articles_kept,
  CASE WHEN co.articles_sent=0 then 0 else (case when revenue_state='Final' then co.sales_returned end)/co.articles_sent END AS rq_item,
  CASE WHEN co.sales_sent=0 then 0 else (case when revenue_state='Final' then co.sales_returned end)/co.sales_sent END AS rq_value,
  op.gift_box,
  op.gift_retourniert,
  op.gift_box_2009876543503,
  op.gift_box_2009876636489,
  op.gift_box_2009876543527,
  op.gift_box_2009876543534,
  op.gift_box_2009876543510,
  op.gift_box_2009876543497

FROM bi.customer_order co
LEFT JOIN bi.customer cu on cu.customer_id = co.customer_id
LEFT JOIN bi.stylist sty on sty.stylist_id=co.stylist_id
LEFT JOIN raw.customer_order_salesforce sfo on sfo.order_id=co.order_id
LEFT JOIN raw.customer_salesforce sfa on sfa.customer_id = co.customer_id
LEFT JOIN 
(
  SELECT 
    co.customer_id,
    min(co.date_created) as first_order_date
  FROM bi.customer_order co 
  GROUP BY co.customer_id
) f on f.customer_id = cu.customer_id
LEFT JOIN
(
  SELECT 
    a.order_id,
    COUNT(CASE 
      WHEN a.article_ean IN ('2009876543503','2009876543510','2009876543527','2009876636489','2009876543534','2009876543497') then '1' 
      else Null end) as gift_box,
    COUNT(CASE WHEN a.article_ean ='2009876543503' then 1 else Null end) as gift_box_2009876543503, 
    COUNT(CASE WHEN a.article_ean ='2009876636489' then 1 else Null end) as gift_box_2009876636489, 
    COUNT(CASE WHEN a.article_ean ='2009876543527' then 1 else Null end) as gift_box_2009876543527, 
    COUNT(CASE WHEN a.article_ean ='2009876543534' then 1 else Null end) as gift_box_2009876543534, 
    COUNT(CASE WHEN a.article_ean ='2009876543510' then 1 else Null end) as gift_box_2009876543510,
    COUNT(CASE WHEN a.article_ean ='2009876543497' then 1 else Null end) as gift_box_2009876543497,
    COUNT(CASE 
        WHEN a.article_ean IN ('2009876543503','2009876543510','2009876543527','2009876636489','2009876543534','2009876543497')
        AND a.order_article_state_number = 512 then 1 
        else Null end) as gift_retourniert
  FROM
  (
    SELECT
      coa.order_id, 
      COALESCE(a.article_ean,i.ean) as article_ean,
      coa.order_article_state_number
    FROM bi.customer_order_articles coa
    LEFT JOIN bi.article a on a.article_id=coa.article_id 
    LEFT JOIN bi.item i on i.article_id=a.article_id
  )a 
  GROUP BY order_id
)op ON op.order_id=co.order_id"	READY
407	2015-04-24 18:25:03	"1112787875"	true	2015-04-24 18:25:03	ml.project_outfit_molor		"CREATE VIEW ""ml.project_outfit_molor"" AS
SELECT
mr.molor_id,
mr.article_id_arbitrary,
ac.flat_category,
ac.outfit_slot__belt,
ac.outfit_slot__headwear,
ac.outfit_slot__jacket,
ac.outfit_slot__neckwear,
ac.outfit_slot__over_shirt,
ac.outfit_slot__shirt,
ac.outfit_slot__shoes,
ac.outfit_slot__socks,
ac.outfit_slot__suit,
ac.outfit_slot__tie,
ac.outfit_slot__trousers,
ac.outfit_slot__underwear,
aad.molor_mean_age,
aad.molor_stddev_age,
aad.model_mean_age,
aad.model_stddev_age,
aad.brand_mean_age,
aad.brand_stddev_age,
aaa.all_ages ""amidala_age_all_ages"",
aaa.under_40 ""amidala_age_under_40"",
aaa.over_40 ""amidala_age_over_40"",
abp.brand_over_40,
abp.brand_under_40,
abp.price_high ""brand_price_high"",
abp.price_medium ""brand_price_medium"",
abp.price_low ""brand_price_low"",
ars.year_2015,
ars.year_2014,
ars.year_2013,
ars.year_2012,
ars.year_2011,
ars.year_2010,
ars.year_2009,
ars.season_autumn_winter,
ars.season_spring_summer,
ars.basic_article,
akr.molor_kept,
akr.molor_returned,
akr.model_kept,
akr.model_returned,
akr.catbra_kept,
akr.catbra_returned,
akr.brand_kept,
akr.brand_returned,
akr.flat_category_kept,
akr.flat_category_returned,
a.article_sales_price_de AS sales_price_de,
a.article_brand AS brand
FROM
""ml.molor_raw"" mr
LEFT JOIN ""ml.articles_categories"" ac ON ac.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_age_distribution"" aad ON aad.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_amidala_age"" aaa ON aaa.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_brand_properties"" abp ON abp.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_season"" ars ON ars.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_kept_returned"" akr ON akr.article_id = mr.article_id_arbitrary
LEFT JOIN ""bi.article"" a ON a.article_id = mr.article_id_arbitrary"	READY
410	2015-04-24 18:25:16	"1112787877"	true	2015-04-24 18:25:16	tableau.mkt_cm2_cohort_analysis_new		"CREATE VIEW tableau.mkt_cm2_cohort_analysis_new
AS
SELECT
  con.order_id,
  con.customer_id,
  con.order_state,
  con.revenue_state,
  con.payment_state,
  con.shipping_country,
  con.order_type,
  con.sales_sent,
  con.sales_kept,
  con.discount_total,
  con.billing_total,
  con.billing_net_sales,
  con.sales_kept * cogs.percentage_cost cost_kept_calc,
  dirc.cost_direct,
  con.cost_kept,
  co.first_box_type,
  co.first_saleschannel_completed,
  mc.first_channel as first_marketing_channel,
  c.first_order_date_completed as date_created_first_order,
  cu.customer_age,
  con.date_invoiced,
  con.date_shipped,
  con.date_created,
  TIMESTAMPDIFF(SQL_TSI_DAY, c.first_order_date_completed, con.date_created)/30 as months_since_first_order
FROM bi.customer_order con
JOIN views.customer c on c.customer_id = con.customer_id
JOIN views.customer_order co on co.id = con.order_id
LEFT JOIN views.marketing_customer mc on mc.customer_id = co.customer_id
LEFT JOIN bi.customer cu on cu.customer_id = co.customer_id
JOIN /* Take COGs % from last 31 days. We will apply this to all orders, so that we are not biased against old cohorts due to high partner stock usage */
(
  SELECT
  shipping_country,
  sum(cost_kept)/sum(sales_kept) as percentage_cost
  FROM bi.customer_order co
  WHERE co.date_invoiced > TIMESTAMPADD(SQL_TSI_DAY, -31, CURDATE())
  GROUP BY 1
) cogs on cogs.shipping_country = co.shipping_country
JOIN /* Take just the most current Direct costs and apply to all time */
(
  SELECT
    a.country,
    a.cost_per_order + b.cost_per_order as cost_direct
  FROM
  (
    /* First figure out the current cost per order by country for logistics and payment */
    SELECT
    c.country_code as country,
    SUM(c.cost)/AVG(o.num_orders) as cost_per_order
    FROM 
    (
      SELECT 
        c.year_month,
        co.shipping_country,
        COUNT(*) as num_orders
      FROM bi.customer_order co
      JOIN dwh.calendar c on c.date = CAST(co.date_invoiced as date)
      WHERE co.is_real_order = 'Real Order'
      AND co.order_state_number >= 16
      GROUP BY 1,2
    ) o
    JOIN dwh.company_costs_direct_monthly c on c.year_month = o.year_month AND o.shipping_country = c.country_code
    WHERE c.year_month = (SELECT MAX(year_month) FROM dwh.company_costs_direct_monthly)  /* Select the last month with known costs */
    AND c.cost_type != 'service'
    GROUP BY 1
  ) a
  CROSS JOIN 
  (
    /* Now figure out the current cost per order for service costs across all markets as Stylist work isn't even, but we want costs to be */
    SELECT
      c.cost_type,
      SUM(c.cost)/AVG(o.num_orders) as cost_per_order
    FROM 
    (
      SELECT 
        c.year_month,
        COUNT(*) as num_orders
      FROM bi.customer_order co
      JOIN dwh.calendar c on c.date = CAST(co.date_invoiced as date)
      WHERE co.is_real_order = 'Real Order'
      AND co.order_state_number >= 16
      GROUP BY 1
    ) o
    JOIN dwh.company_costs_direct_monthly c on c.year_month = o.year_month AND c.cost_type = 'service'
    WHERE c.year_month = (SELECT MAX(year_month) FROM dwh.company_costs_direct_monthly)  /* Select the last month with known costs */
    GROUP BY 1
  ) b 
) dirc on dirc.country=co.shipping_country
WHERE con.order_state_number >= 128 
AND con.order_state_number < 2048
AND con.is_real_order = 'Real Order'

/* This UNION SELECT adds in dummy data so that we can draw nice cohorts charts for old cohorts that have very sparse data */
UNION SELECT
  null as order_id,
  null as customer_id,
  'Completed' as order_state,
  'Final' as revenue_state,
  null as payment_state,
  shipping_country,
  null as order_type,
  null as sales_sent,
  null as sales_kept,
  null as discount_total,
  null as billing_total,
  null as billing_net_sales,
  null as cost_kept_calc,
  null as cost_direct,
  null as cost_kept,
  first_box_type,
  null as first_saleschannel_completed,
  first_marketing_channel,
  fo.date as date_created_first_order,
  null as customer_age,
  null as date_invoiced,
  null as date_shipped,
  o.date as date_created,
  TIMESTAMPDIFF(SQL_TSI_DAY, fo.date, curdate())/30 as months_since_first_order
FROM dwh.calendar fo
JOIN dwh.calendar o on o.date > fo.date AND o.date < curdate()
CROSS JOIN (SELECT 'Call Box' as first_box_type UNION SELECT 'No Call Box' as first_box_type) x
CROSS JOIN (SELECT distinct shipping_country FROM bi.customer_order) y
CROSS JOIN (SELECT distinct first_channel as first_marketing_channel FROM views.marketing_customer) z
WHERE fo.date > '2012-02' and fo.date < curdate()
AND fo.day_of_month = 1
AND o.day_of_month = 1"	READY
411	2015-04-24 18:25:22	"1112787878"	true	2015-04-24 18:25:22	ml.project_outfit_ranking_molor		"CREATE VIEW ml.project_outfit_ranking_molor AS
SELECT
mr.molor_id,
mr.article_id_arbitrary,
ac.flat_category,
ac.outfit_slot__belt,
ac.outfit_slot__headwear,
ac.outfit_slot__jacket,
ac.outfit_slot__neckwear,
ac.outfit_slot__over_shirt,
ac.outfit_slot__shirt,
ac.outfit_slot__shoes,
ac.outfit_slot__socks,
ac.outfit_slot__suit,
ac.outfit_slot__tie,
ac.outfit_slot__trousers,
ac.outfit_slot__underwear,
aad.molor_mean_age,
aad.molor_stddev_age,
aad.model_mean_age,
aad.model_stddev_age,
aad.brand_mean_age,
aad.brand_stddev_age,
aaa.all_ages ""amidala_age_all_ages"",
aaa.under_40 ""amidala_age_under_40"",
aaa.over_40 ""amidala_age_over_40"",
abp.brand_over_40,
abp.brand_under_40,
abp.price_high ""brand_price_high"",
abp.price_medium ""brand_price_medium"",
abp.price_low ""brand_price_low"",
ars.year_2015,
ars.year_2014,
ars.year_2013,
ars.year_2012,
ars.year_2011,
ars.year_2010,
ars.year_2009,
ars.season_autumn_winter,
ars.season_spring_summer,
ars.basic_article,
akr.molor_kept,
akr.molor_returned,
akr.model_kept,
akr.model_returned,
akr.catbra_kept,
akr.catbra_returned,
akr.brand_kept,
akr.brand_returned,
akr.flat_category_kept,
akr.flat_category_returned,
a.article_sales_price_de AS sales_price_de,
a.article_brand AS brand,
ap.push_item
FROM
""ml.molor_raw"" mr
LEFT JOIN ""ml.articles_categories"" ac ON ac.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_age_distribution"" aad ON aad.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_amidala_age"" aaa ON aaa.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_brand_properties"" abp ON abp.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_season"" ars ON ars.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_kept_returned"" akr ON akr.article_id = mr.article_id_arbitrary
LEFT JOIN ""ml.article_push"" ap ON ap.article_id = mr.article_id_arbitrary
LEFT JOIN ""bi.article"" a ON a.article_id = mr.article_id_arbitrary"	READY
414	2015-04-24 18:25:31	"1112787879"	true	2015-07-02 17:46:30	views.marketingcheck		"CREATE view views.marketingcheck
as
select 
 mc.datecreated as ""datecreated"", 
 mc.country as ""country"", 
 vi.visits as ""visits"",
 avg(mco.costs) as ""costs"", 
 count(distinct(md.co_id)) as ""all_orders"", 
 count(distinct(case when md.co_saleschannel in ('websiteWithDate','websiteWithoutDate') and md.co_paymentmethod!= '4' and md.co_newrepeatfollow= 'first order' then md.co_id else null end)) as ""incoming_orders"", 
 count(distinct(ga.transaction_id)) as ""transaction_ids""
from views.marketingconstruct mc 
left join views.marketingdata md on md.co_datecreated = mc.datecreated and md.addr_country = mc.country 
left join views.ga_information ga on md.co_id = ga.transaction_id
left join ( 
 select 
  datecreated, 
  country, 
  sum(case 
      when currency= 'chf' then costs*0.8
      else costs 
     end) as ""costs"" 
 from views.marketingcosts 
 group by 1,2) mco 
on mco.datecreated = mc.datecreated and mco.country = mc.country 
left join (
  select
    date_created,
    domain as country,
    sum(ifnull(visits,0)) as visits
  from raw.daily_visits
  group by 1,2) vi
on mc.datecreated = vi.date_created and lower(mc.country) = lower(vi.country)
where mc.datecreated>= '2014-01-27'
and mc.datecreated<= curdate()
group by 1,2,3"	READY
415	2015-04-24 18:25:39	"1112787880"	true	2015-05-13 17:57:28	views.additional_order_information		"CREATE view views.additional_order_information
as

SELECT 
	co.order_id,
	co.date_created as customer_order_date_created,
	co.customer_id,
	/*Financial Transaction*/
	fd.fd_date_created as date_created,
	fd.response_code,
	fd.valuation,
	fd.""status"",
	/*Financial Transaction Details*/
	fd.arvatotype,
	fd.arvatoorderlimit,
	fd.arvatoresult,
	fd.arvatoscore,
	fd.max_valuation,
	/*Arvato result*/
	ar.arvatoresult_1,
	ar.arvatoresult_2,
	ar.arvatoresult_3,
	/*Response Code*/
	ar.responseCode_1,
	ar.responseCode_2,
	ar.responseCode_3,
	/*Request Code*/
	ar.requestbody_1,
	ar.requestbody_2,
	ar.requestbody_3,
	/*Order Limit*/
	ar.arvatoorderlimit1,
	ar.arvatoorderlimit2,
	ar.arvatoorderlimit3,
	/*Provider Transaction ID*/
	ar.provider_transaction_id1,
	ar.provider_transaction_id2,
	ar.provider_transaction_id3,
	/*Valuation*/
	ar.valuation1,
	ar.valuation2,
	ar.valuation3,
	ar.avg_arvatoorderlimit,
	/*NPS Score*/
	co.nps_score as nps__c,
	co.nps_customer_comment as nps_weitere_infos__c,
	co.date_nps_submitted as date_submitted,
	stask.feedback_count,
	/*Marketing App Details*/
	ma.campaign as app_campaign,
	ma.marketing_channel as app_marketing_channel,
	ma.first_channel as app_first_channel,
	ma.nb_of_installs as nb_of_app_installs,
	ma.costs as app_campaign_costs
FROM bi.customer_order co
LEFT JOIN views.arvatoresults ar ON ar.order_id=co.order_id
LEFT JOIN views.financial_data fd on fd.order_id=co.order_id
/*Nb of Answers Recieved*/
LEFT JOIN
(
	SELECT 
		ExternalOrderId__c,
		feedback_count 
	FROM views.salesforce_opportunity soppo 
	INNER JOIN
	(
		SELECT 
			opportunity_id,
			count(distinct opportunity_id) as feedback_count 
		FROM views.salesforce_task
		GROUP BY 1
	)stask ON stask.opportunity_id=soppo.Id
)stask ON stask.ExternalOrderId__c=co.order_id
LEFT JOIN views.marketing_apptracking ma on ma.order_id=co.order_id"	READY
753,667	2015-09-11 17:16:37	"1298626276"	true	2015-09-11 17:33:29	raw.customer_order_fo_issue		"CREATE view raw.customer_order_fo_issue as
select * from dwh.customer_order_apr_aug a
where cast(date_created as date) between '2015-05-01' and '2015-08-31'
and order_type = 'Repeat Order'
and exists (select 1 from dwh.customer_order_apr_aug b
		where a.customer_id = b.customer_id
		and cast(date_created as date) between cast (TIMESTAMPADD (SQL_TSI_DAY,-30,date_created) as date)
									   and cast(date_created as date));"	READY
417	2015-04-24 18:25:50	"1112787882"	true	2015-04-24 18:25:50	sandbox.marketing_overview		"CREATE VIEW sandbox.marketing_overview
AS
SELECT
  pl.date as date_created,
  pl.domain,
  pl.marketing_channel,
  ab.incoming_first_orders,
  ab.invoiced_first_orders,
  inc.actual_invoiced_first_orders,
  ab.sales_sent,
  ab.sales_kept,
  ab.billing_net_sales,
  mc3.cost,
  CAST(cd.visits as BIGINT) as visits,
  amc.actual_costs_total
                               FROM
(
    SELECT
    c.date,
        x.domain,
        y.marketing_channel
    FROM dwh.calendar c 
    CROSS JOIN (SELECT domain FROM raw.ga_visits WHERE domain != 'ALL' GROUP BY 1) x
    CROSS JOIN 
    (
  SELECT marketing_channel FROM dwh.marketing_sub_channels GROUP BY 1
  ) y
    WHERE c.date > '2012'
    AND c.date < CURDATE()
    ) pl
    LEFT JOIN
    (
    SELECT 
      cast(co.date_incoming as date) as date_incoming,
      cu.default_domain,
      CASE
        WHEN oa.marketing_channel is null AND co.sales_channel like '%website%' THEN 'Website not tracked'
        WHEN oa.marketing_channel is null AND co.sales_channel not like '%website%' THEN 'Other not tracked'
        ELSE oa.marketing_channel
      END as marketing_channel,
      SUM(ROUND(oa.contact_weight,2)) as incoming_first_orders,
      SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 THEN ROUND(oa.contact_weight,2) ELSE 0 END) as invoiced_first_orders,
      ROUND(SUM(oa.contact_weight*co.sales_sent),2) as sales_sent,
      ROUND(SUM(oa.contact_weight*co.sales_kept),2) as sales_kept,
      ROUND(SUM(oa.contact_weight*co.billing_net_sales),2) as billing_net_sales 
    FROM bi.customer_order co
    LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
    LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
    WHERE co.date_incoming is not null
    AND co.is_real_order = 'Real Order'
    AND order_type = 'First Order'
    GROUP BY 1,2,3
) ab ON pl.date = ab.date_incoming AND ab.default_domain = pl.domain AND pl.marketing_channel = ab.marketing_channel
LEFT JOIN 
( 
      SELECT 
      cast(co.date_invoiced as date) as ""date"",
      cu.default_domain,
      CASE
        WHEN oa.marketing_channel is null AND co.sales_channel like '%website%' THEN 'Website not tracked'
        WHEN oa.marketing_channel is null AND co.sales_channel not like '%website%' THEN 'Other not tracked'
        ELSE oa.marketing_channel
      END as marketing_channel,
      SUM(ROUND(oa.contact_weight,2)) as actual_invoiced_first_orders
    FROM bi.customer_order co
    LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
    LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
    WHERE co.date_invoiced is not null
    AND co.is_real_order = 'Real Order'
    AND order_type = 'First Order'
    AND co.order_state_number >= 16
    AND co.order_state_number < 2048 
    GROUP BY 1,2,3
) inc ON pl.date = inc.date AND inc.default_domain = pl.domain AND pl.marketing_channel = inc.marketing_channel
LEFT JOIN
(
     SELECT 
        date_created,
        domain,
        marketing_channel,
        SUM(visits) as visits
      FROM raw.ga_visits
      WHERE domain != 'ALL'
      GROUP BY 1,2,3
) cd ON cd.date_created = pl.date AND cd.domain = pl.domain AND cd.marketing_channel = pl.marketing_channel
LEFT JOIN
(
        SELECT
            mc2.date_created,
            mc2.country,
            mc2.marketing_channel,
            SUM(mc2.cost) as cost
        FROM
        (
            SELECT 
                mc.date_created,
                mc.country,
                CASE 
                  WHEN mc.channel = 'google gdn' THEN 'Display'
                  WHEN mc.channel = 'google sem' THEN 'SEM Non-brand'
                  WHEN mc.channel = 'display' THEN 'Display'
                  WHEN mc.channel = 'facebook' THEN 'Facebook'
                  WHEN mc.channel = 'affiliate' THEN 'Affiliate'
                  WHEN mc.channel = 'crm' THEN 'CRM'
                  WHEN mc.channel = 'kooperation' THEN 'Cooperations'
                  WHEN mc.channel = 'praemienprogramm' THEN 'Cooperations'
                  WHEN mc.channel = 'remarketing' THEN 'Remarketing'
                  WHEN mc.channel = 'seo/direct' THEN 'SEO'
                  WHEN mc.channel = 'tv' THEN 'TV'
                  WHEN mc.channel = 'twitter' THEN 'Social Media' 
                  WHEN mc.channel = 'youtube' THEN 'Social Media'
                  WHEN mc.channel = 'google sem brand' THEN 'SEM Brand'
                  WHEN mc.channel = 'google sem nobrand' THEN 'SEM Non-brand'
                  WHEN mc.channel = 'app download campaign' THEN 'App campaign'
                END as marketing_channel, 
                  mc.cost
            FROM raw.marketing_costs mc
      ) mc2
      GROUP BY 1,2,3
) mc3 ON pl.date = mc3.date_created AND mc3.country = pl.domain AND mc3.marketing_channel = pl.marketing_channel
/* LEFT JOIN
(
 SELECT 
	  date_invoiced as ""date"",
	  country,
	  SUM(cost*-1) as attributed_costs_total
  FROM bi.company_costs_marketing 
  GROUP BY 1,2
) cmc ON pl.date = cmc.date AND pl.domain = cmc.country */
 LEFT JOIN
  (
    SELECT  
	    date_created as ""date"",
    	country,
    	SUM(cost) as actual_costs_total
  FROM raw.marketing_costs
  GROUP BY 1,2  
) amc ON pl.date = amc.date AND pl.domain = amc.country"	READY
753,668	2015-09-11 17:49:12	"1298626298"	true	2015-09-11 17:49:12	raw.customer_order_issue_onlyfo		"create view raw.customer_order_issue_onlyfo as
select cast(date_created as date) as date_created, count(*) as vol 
from dwh.customer_order_apr_aug
where cast(date_created as date) between '2015-05-01' and '2015-08-31'
and order_type in ('Repeat Order Follow-on', 'First Order Follow-on')
group by cast(date_created as date)
order by date_created asc;"	READY
336	2015-04-24 18:21:34	"1112787815"	true	2015-05-11 17:09:07	raw.customer_brand_cluster		"CREATE view raw.customer_brand_cluster
AS

WITH cust_cluster AS
(
 	SELECT
		clu.customer_id,
		clu.brand,
		clu.marketing_cluster,
		clu.articles_kept,
		cast(clu.sales_per_brand as decimal) as ""sales_per_brand""
	FROM
	(
		SELECT
			co.customer_id,
			COALESCE(b.name, art.article_brand) as ""brand"",
			b.marketing_cluster,
			sum(op.articles_kept) as articles_kept,
			sum(op.articles_kept*op.sales_in_local_currency/e.exchange_rate/e.exchange_rate) as ""sales_per_brand"",
			count(op.order_id) as ""number_of_orders""
		FROM raw.customer_order_articles op
		LEFT JOIN raw.customer_order co on co.order_id=op.order_id
		LEFT JOIN raw.article art on art.article_id = op.article_id
		LEFT JOIN dwh.brands b ON b.name_db = art.article_brand
		LEFT JOIN dwh.historical_exchange_rates e on e.currency_code = co.currency_code AND cast(co.date_invoiced as date) = e.date
		WHERE op.order_article_state_number= '1024' AND co.order_state_number= '1024'
		GROUP BY 1,2,3
	)clu
)
SELECT
 	a.customer_id, 
 	a.marketing_cluster
FROM
(
SELECT 
	rc.customer_id, 
	rc.marketing_cluster, 
	COUNT(*) cluster_count, 
	SUM(rc.sales_per_brand) cluster_spend,
	RANK() OVER (PARTITION BY rc.customer_id ORDER BY COUNT(*) DESC) as cluster_rank,
	ROW_NUMBER() OVER (PARTITION BY rc.customer_id, COUNT(*) ORDER BY SUM(rc.sales_per_brand) DESC) as spend_row
FROM cust_cluster rc
WHERE rc.marketing_cluster IS NOT NULL
GROUP BY 1,2
)a
WHERE a.cluster_rank = 1
AND a.spend_row = 1"	READY
377	2015-04-24 18:23:53	"1112787853"	true	2015-04-24 18:23:53	tableau.days_returned_shipped		"create view tableau.days_returned_shipped
as
SELECT 
co.customer_id, 
co.id, 
co.parent_order_id,
co.order_type, 
co.date_returned, 
a.original_return_date,
co.date_shipped
FROM views.customer_order co
left join
(select
id,
date_returned as original_return_date
from
views.customer_order) a
on a.id = parent_order_id
where co.parent_order_id is not null"	READY
421	2015-04-24 18:26:52	"1141409517"	true	2015-08-10 19:02:25	tableau.billing_arvato_address_check		"CREATE view tableau.billing_arvato_address_check
AS

SELECT
	order_id,
	customer_order_date_created,
	requestbody_1,
	left(substring(requestbody_1, LOCATE('firstName',requestbody_1)+12), (LOCATE('""', substring(requestbody_1, LOCATE('firstName',requestbody_1)+13)))) as ""first_name"", 
	left(substring(requestbody_1, LOCATE('lastName',requestbody_1)+11), (LOCATE('""', substring(requestbody_1, LOCATE('lastName',requestbody_1)+13)))) as ""last_name"",
	left(substring(requestbody_1, LOCATE('careOf',requestbody_1)+9), (LOCATE('""', substring(requestbody_1, LOCATE('careOf',requestbody_1)+10)))) as careOf,
	left(substring(requestbody_1, LOCATE('street',requestbody_1)+9), (LOCATE('""', substring(requestbody_1, LOCATE('street',requestbody_1)+10)))) as street,
	left(substring(requestbody_1, LOCATE('streetNumber',requestbody_1)+15), (LOCATE('""', substring(requestbody_1, LOCATE('streetNumber',requestbody_1)+16)))) as streetNumber,
	left(substring(requestbody_1, LOCATE('zipCode',requestbody_1)+10), (LOCATE('""', substring(requestbody_1, LOCATE('zipCode',requestbody_1)+11)))) as zipCode,
	left(substring(requestbody_1, LOCATE('city',requestbody_1)+7), (LOCATE('""', substring(requestbody_1, LOCATE('city',requestbody_1)+8)))) as city,
	replace(left(left(substring(requestbody_1, LOCATE('country',requestbody_1)+9), (LOCATE('}', substring(requestbody_1, LOCATE('city',requestbody_1)+10)))),3),'','}') as country,
	left(substring(requestbody_1, LOCATE('email',requestbody_1)+8), (LOCATE('""', substring(requestbody_1, LOCATE('email',requestbody_1)+9)))) as email
FROM views.additional_order_information"	READY
418	2015-04-24 18:26:36	"1126921206"	true	2015-08-07 10:48:28	tableau.mkt_tv_overview_new		"CREATE VIEW tableau.mkt_tv_overview_new
AS
SELECT
    c.date,
    x.country,
	ab.incoming_orders_attributed,
	ab.invoiced_orders_attributed,
	ab.biling_total_attributed,
	ab.sales_sent_attributed,
	ab.sales_kept_attributed,
    ab.incoming_orders_total,
    ab.invoiced_orders_total,
	ab.sales_sent_total,
	ab.sales_kept_total,
	ab.billing_total,
    mc.costs
FROM dwh.calendar c 
CROSS JOIN (SELECT country FROM dwh.marketingcost GROUP BY 1) x
LEFT JOIN
(
	SELECT 
		cast(datecreated as date) as ""date"", 
		country, 
		sum(cast(costs as decimal))  as costs
	FROM ""dwh.marketingcost""
	WHERE channel like 'TV%'
	GROUP BY 1,2
) mc ON cast(mc.date as date) = c.date AND mc.country = x.country
LEFT JOIN
(
		SELECT 
		cast(co.date_incoming as date) as ""date"",
		co.shipping_country,
		SUM(at.contact_weight) as incoming_orders_attributed,
		SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 THEN ROUND(at.contact_weight,2) ELSE 0 END) as invoiced_orders_attributed,
		ROUND(SUM(at.contact_weight*co.sales_sent),2) as sales_sent_attributed,
      	ROUND(SUM(at.contact_weight*co.sales_kept),2) as sales_kept_attributed,
      	ROUND(SUM(at.contact_weight*co.billing_total),2) as biling_total_attributed,
		COUNT(co.order_id) as incoming_orders_total,
		SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 THEN 1 ELSE 0 END) as invoiced_orders_total,
		SUM(co.sales_sent) as sales_sent_total,
		SUM(co.sales_kept) as sales_kept_total,
		SUM(co.billing_total) as billing_total
	FROM bi.customer_order co
	RIGHT JOIN
	(
		SELECT
		cast(cd.contact_timestamp as date) as ""date"",
		cd.order_id,
		cd.contact_weight
		FROM bi.marketing_order_attribution cd 
		WHERE cd.marketing_channel = 'TV'	
	) at ON at.order_id = co.order_id
	WHERE date_incoming is not null
	GROUP BY 1,2
) ab ON ab.shipping_country = x.country AND c.date=ab.date
WHERE c.date > '2014'
AND c.date < CURDATE()"	READY
43	2015-04-24 18:17:20	"1389130172"	true	2015-09-29 12:20:06	raw.customer		"CREATE VIEW raw.customer
AS

SELECT
  p.id as ""customer_id"",
  p.profile_id,
  p.referred_by_id,
  p.email,
  REPLACE(REPLACE(REPLACE(REPLACE(phone_number, '-', ''), '(0)', ''), ' ', ''), '/', '') as phone_number,
  INITCAP(p.first_name) as first_name,
  INITCAP(p.last_name) as last_name,
  CASE WHEN length(p.prefix) < 10 THEN p.prefix ELSE null END as prefix,
  CASE 
    WHEN
      p.first_name = 'test' 
      OR p.first_name = 'Test' 
      OR p.first_name = 'tester' 
      OR p.first_name = 'Tester'
      OR p.first_name like '% test %' 
      OR p.first_name like '% Test %' 
      OR p.last_name = 'test' 
      OR p.last_name = 'Test'
      OR p.last_name = 'Tester' 
      OR p.last_name like '% test %' 
      OR p.last_name like '% Test %' 
      OR (p.email like '%test%' and p.email like '%@outfittery%') 
      OR (p.email like '%+%' and p.email like '%@outfittery%') 
      OR pr.phone_number in ('+493046722431', '+491736363807', '+491632930982', '+4915224292511')
      THEN 'Test User'
    WHEN p.id in ('179899816','179886634','11804631','31281783','143553094','834667','197384812',
    	'163836386','62252329','94204965','234063161','242674884','243692185') THEN 'Outfittery Showroom'
    ELSE 'Real User'
  END as user_type,
  CASE WHEN p.salutation = 1 THEN 'Male' ELSE 'Female' END as gender,
  TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) as ""customer_age"",
  CASE 
    WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) >= 18 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) <= 30 THEN '18-30'
    WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) >= 31 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) <= 35 THEN '31-35'
    WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) >= 36 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) <= 45 THEN '36-45'
    WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) >= 46 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) <= 55 THEN '46-55'
    WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) >= 56 THEN '56+'
    ELSE null
  END as age_group,   /* Note: these age groups are chosen to line-up with the survey question: How old do you feel? */
  CASE 
    WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),p.date_created) >= 18 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),p.date_created) <= 30 THEN '18-30'
    WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),p.date_created) >= 31 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),p.date_created) <= 35 THEN '31-35'
    WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),p.date_created) >= 36 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),p.date_created) <= 45 THEN '36-45'
    WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),p.date_created) >= 46 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),p.date_created) <= 55 THEN '46-55'
    WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),p.date_created) >= 56 THEN '56+'
    ELSE null
  END as age_group_on_registration,
  p.default_page as default_domain,
  p.national_id,
  p.token,
  p.stylelist_id as stylist_id,
  p.facebook_page,
  
  CASE 
  	WHEN p.formal=true THEN 'gesiezt'
	ELSE 'geduzt'
  END AS formal,
  
  /*Subscription*/
  CASE 
  	WHEN pr.newsletter_accepted=true THEN true
	ELSE false
  END AS newsletter_accepted,
  
  CASE 
  	WHEN pr.subscribed_to_newsletter=true THEN true
	ELSE false
  END AS subscribed_to_newsletter,
  
  CASE 
  	WHEN pr.subscribed_to_sms=true THEN true
	ELSE false
  END AS subscribed_to_sms,
  
  CASE 
  	WHEN pr.subscribed_to_stylist_emails=true THEN true
	ELSE false
  END AS subscribed_to_stylist_emails,
  
  /*Club Subscription*/
  CASE 
      WHEN club_status='ACTIVE' THEN 'true'
      WHEN club_status='CANCELLED' THEN 'Cancelled'
      ELSE 'false'
    END AS club_member,
  cl.club_membership_type,
  cl.club_customer_feedback,
  cl.club_member_offer,
  cl.date_club_activated,
  cl.date_club_cancelled,

  CASE 
  	WHEN p.guest_account=true THEN true
	ELSE false
  END AS guest_account,

  /*Customer Image Count*/
  ci.image_count,
  ci.facebook_image_count,
  ci.other_image_count,

/* Dates */
  p.date_created,
  cast(pr.date_of_birth as date) as date_of_birth,
  pr.date_newsletter_confirmed,
  ci.min_date_created as date_first_image_uploaded,
  ci.max_last_updated as date_last_image_uploaded,
  cl.date_first_club_box,

/* Size info */
  pr.height_in_cm,
  pr.weight_in_kg,
  pr.shirt_size,
  CAST(CASE WHEN length(pr.collar_size) > 1 THEN left(pr.collar_size,2) ELSE null END as integer) as collar_size,
  CAST(CASE WHEN length(pr.shoe_size) > 1 THEN replace(pr.shoe_size, ',', '.') ELSE null END as decimal) as shoe_size,
  CAST(CASE 
    WHEN length(pr.trousers_size_width) > 1 AND pr.trousers_size_width != 'null' THEN left(pr.trousers_size_width,2)
    ELSE left(pr.trousers_size, 2)
  END as integer) as trousers_size_width,
  CAST(CASE 
    WHEN length(pr.trousers_size_length) > 1 AND pr.trousers_size_length != 'null' THEN right(pr.trousers_size_length,2)
    ELSE right(pr.trousers_size, 2)
  END as integer) as trousers_size_length,

/* Other questions */
  pr.preferred_contact_channel,
  pr.preferred_contact_time,
  pr.branch_working_in_other as occupation,
  pr.buying_problems,
  pr.buying_problem_other,
  left(cast(p.additional_info as string),4000) as additional_info,

/* Spending Budgets - Note: 
      1) These numbers are in local currency, not always Euros, this is fixed during the transition into bi.customer 
      2) In the old definitions there was no ""to"" in the final segment, then answer was e.g. 180EUR+. In these cases
        we have put some assumed numbers in, like 250EUR
*/
  CAST(CASE 
    WHEN pr.spending_budget_for_jeans_from is not null THEN pr.spending_budget_for_jeans_from
    WHEN pr.spending_budget_for_jeans = '1' THEN '100'
    WHEN pr.spending_budget_for_jeans = '2' THEN '150'
    WHEN pr.spending_budget_for_jeans = '3' THEN '200'
    WHEN pr.spending_budget_for_jeans = '4' THEN '80'
    WHEN pr.spending_budget_for_jeans = '5' THEN '120'
    WHEN pr.spending_budget_for_jeans = '6' THEN '180'
    WHEN pr.spending_budget_for_jeans = '7' THEN '60'
    WHEN pr.spending_budget_for_jeans = '8' THEN '80'
    WHEN pr.spending_budget_for_jeans = '9' THEN '120'
    WHEN pr.spending_budget_for_jeans = '10' THEN '180'
    ELSE null
  END as integer) as spending_budget_for_jeans_from,
  CAST(CASE 
    WHEN pr.spending_budget_for_jeans_to is not null THEN pr.spending_budget_for_jeans_to
    WHEN pr.spending_budget_for_jeans = '1' THEN '150'
    WHEN pr.spending_budget_for_jeans = '2' THEN '200'
    WHEN pr.spending_budget_for_jeans = '3' THEN '250'
    WHEN pr.spending_budget_for_jeans = '4' THEN '120'
    WHEN pr.spending_budget_for_jeans = '5' THEN '180'
    WHEN pr.spending_budget_for_jeans = '6' THEN '250'
    WHEN pr.spending_budget_for_jeans = '7' THEN '80'
    WHEN pr.spending_budget_for_jeans = '8' THEN '120'
    WHEN pr.spending_budget_for_jeans = '9' THEN '180'
    WHEN pr.spending_budget_for_jeans = '10' THEN '250'
    ELSE null
  END as integer) as spending_budget_for_jeans_to,
  CAST(CASE 
    WHEN pr.spending_budget_for_shirts_from is not null THEN pr.spending_budget_for_shirts_from
    WHEN pr.spending_budget_for_shirts = '1' THEN '60'
    WHEN pr.spending_budget_for_shirts = '2' THEN '80'
    WHEN pr.spending_budget_for_shirts = '3' THEN '100'
    WHEN pr.spending_budget_for_shirts = '4' THEN '40'
    WHEN pr.spending_budget_for_shirts = '5' THEN '60'
    WHEN pr.spending_budget_for_shirts = '6' THEN '80'
    WHEN pr.spending_budget_for_shirts = '7' THEN '100'
    ELSE null
  END as integer) as spending_budget_for_shirts_from,
  CAST(CASE 
    WHEN pr.spending_budget_for_shirts_to is not null THEN pr.spending_budget_for_shirts_to
    WHEN pr.spending_budget_for_shirts = '1' THEN '80'
    WHEN pr.spending_budget_for_shirts = '2' THEN '100'
    WHEN pr.spending_budget_for_shirts = '3' THEN '120'
    WHEN pr.spending_budget_for_shirts = '4' THEN '60'
    WHEN pr.spending_budget_for_shirts = '5' THEN '80'
    WHEN pr.spending_budget_for_shirts = '6' THEN '100'
    WHEN pr.spending_budget_for_shirts = '7' THEN '120'
    ELSE null
  END as integer) as spending_budget_for_shirts_to,
  CAST(CASE 
    WHEN pr.spending_budget_for_shoes_from is not null THEN pr.spending_budget_for_shoes_from
    WHEN pr.spending_budget_for_shoes = '1' THEN '60'
    WHEN pr.spending_budget_for_shoes = '2' THEN '120'
    WHEN pr.spending_budget_for_shoes = '3' THEN '200'
    WHEN pr.spending_budget_for_shoes = '4' THEN '60'
    WHEN pr.spending_budget_for_shoes = '5' THEN '100'
    WHEN pr.spending_budget_for_shoes = '6' THEN '200'
    ELSE null
  END as integer) as spending_budget_for_shoes_from,
  CAST(CASE 
    WHEN pr.spending_budget_for_shoes_to is not null THEN pr.spending_budget_for_shoes_to
    WHEN pr.spending_budget_for_shoes = '1' THEN '120'
    WHEN pr.spending_budget_for_shoes = '2' THEN '200'
    WHEN pr.spending_budget_for_shoes = '3' THEN '250'
    WHEN pr.spending_budget_for_shoes = '4' THEN '100'
    WHEN pr.spending_budget_for_shoes = '5' THEN '200'
    WHEN pr.spending_budget_for_shoes = '6' THEN '300'
    ELSE null
  END as integer) as spending_budget_for_shoes_to,
  CAST(CASE 
    WHEN pr.spending_budget_for_sakkos_from is not null THEN pr.spending_budget_for_sakkos_from
    WHEN pr.spending_budget_for_sakkos = '1' THEN '100'
    WHEN pr.spending_budget_for_sakkos = '2' THEN '150'
    WHEN pr.spending_budget_for_sakkos = '3' THEN '200'
    ELSE null
  END as integer) as spending_budget_for_jackets_from,
  CAST(CASE 
    WHEN pr.spending_budget_for_sakkos_to is not null THEN pr.spending_budget_for_sakkos_to
    WHEN pr.spending_budget_for_sakkos = '1' THEN '150'
    WHEN pr.spending_budget_for_sakkos = '2' THEN '200'
    WHEN pr.spending_budget_for_sakkos = '3' THEN '300'
    ELSE null
  END as integer) as spending_budget_for_jackets_to
FROM postgres.principal p
LEFT JOIN postgres.profile pr on pr.id = p.profile_id
LEFT JOIN (
  SELECT 
    ci.customer_id, 
    cast(min(ci.date_created) as date) as min_date_created, 
    cast(max(ci.last_updated) as date) as max_last_updated,
    count(*) as image_count, 
    sum(case when ci.original_file_name like_regex '\d+\_\d+\_\d+\_[abgnoqstx]' then 1 else 0 end) as facebook_image_count,
    sum(case when ci.original_file_name not like_regex '\d+\_\d+\_\d+\_[abgnoqstx]' then 1 else 0 end) as other_image_count
  FROM postgres.customer_image ci
  GROUP BY ci.customer_id
) ci on ci.customer_id = p.id
/*this table have club information of customer from grails
--only Outfittery_Club_Einf_hrungskampagne__c as club_campaign_member is missing in grails*/
LEFT JOIN
(
  SELECT 
  	row_number() over(partition by customer_id order by date_created desc) AS rank, 
    customer_id,
	status as club_status,
    type as club_membership_type,
    notes as club_customer_feedback,
    offer as club_member_offer,
    CAST(start_date AS DATE) AS date_first_club_box,
    CAST(date_activated AS DATE) AS date_club_activated,
	CAST(date_cancelled AS DATE) AS date_club_cancelled
  FROM postgres.customer_subscription
)cl on cl.customer_id=p.id and cl.rank=1"	READY
201	2015-04-24 18:19:16	"1112787709"	true	2015-04-24 18:19:16	tableau.finance_pp_history		"CREATE view tableau.finance_pp_history
AS
select 
	pim.o_parentid,
	pop.purchase_order_id,
	pop.date_created,
	pop.earliest_delivery_date,
	pop.latest_delivery_date,
	pop.ean,
	pim.season as pim_season, 
	case when a.date_delivered_new is null then b.date_delivered_old else a.date_delivered_new end as ""delivery_date"",
	sum(pop.fulfilled_quantity) as fulfilled_quantity, 
	sum(pop.fulfilled_quantity*pop.purchase_price) as purchase_price_fulfilled,
	sum(pop.purchase_price) as purchase_price_per_piece
FROM views.purchase_order_position pop
left JOIN views.pim_article pim on pop.ean = pim.ean
LEFT JOIN 
(
	select
		po,
		ean,
		cast(max(date_delivered) as date) as date_delivered_new
	from views.scantemplates
	group by 1,2
)a ON a.po=pop.purchase_order_id AND a.ean = pop.ean
left join 
(
	select 
		po,
		ean,
		cast(max(date_delivered) as date) as date_delivered_old
	FROM dwh.scantemplates_old
	GROUP BY 1,2
) b  ON b.po=pop.purchase_order_id AND b.ean = pop.ean
where pop.fulfilled_quantity > 0
GROUP BY 1,2,3,4,5,6,7,8"	READY
32,821	2015-04-29 11:00:01	"1112787892"	true	2015-04-29 11:00:01	tableau.bisdev_nps_3months		"CREATE VIEW tableau.bisdev_nps_3months
AS

SELECT 
 	sty.stylist,
  	SUM(CASE WHEN co.nps_score >= 9 AND co.nps_score <= 10 THEN 1 ELSE 0 END) AS nr_of_promoters,
  	SUM(CASE WHEN co.nps_score >= 0 AND co.nps_score <= 6 THEN 1 ELSE 0 END) AS nr_of_detractors,
  	SUM(CASE WHEN co.nps_score IS NULL THEN 0 ELSE 1 END) AS nr_of_times_each_score
FROM bi.customer_order co 
left join bi.stylist sty on co.stylist_id = sty.stylist_id
WHERE cast(co.date_nps_submitted as date)>= timestampadd(SQL_TSI_MONTH,-3,curdate())
GROUP BY 1"	READY
32,822	2015-04-29 11:13:22	"1112787893"	true	2015-04-29 11:13:22	tableau.bisdev_nps_reporting		"CREATE VIEW tableau.bisdev_nps_reporting
AS

SELECT 
co.order_id,
co.nps_score,
co.customer_id,
co.date_created,
co.date_shipped,
co.date_nps_submitted,
co.order_state_number,
co.payment_type,
co.sales_channel,
co.date_phone_call_current as phone_date,
co.shipping_city,
co.shipping_country,
co.order_type,
co.articles_kept,
co.articles_returned,
co.sales_kept,
co.sales_returned,
sf.salesforce_order_stage,
cu.customer_age,
/*Stylist Info*/
sty.stylist,
sty.team as user_role,
sty.profile_name,
ta.feedback_count

FROM bi.customer_order co
LEFT JOIN bi.customer_order_salesforce sf on co.order_id=sf.order_id
LEFT JOIN bi.stylist sty on co.stylist_id = sty.stylist_id
LEFT JOIN bi.customer cu on cu.customer_id=co.customer_id
/*Number of emails sent can be found salesforce task, 
 if the subject is 'Email: Feedback mit Mail' or 'Freunde empfehlen - DU' then nps_mail is sent,
 there is no way to find exact emails sent in salesforce*/
left join
(
	SELECT 
	st.opportunity_id,
	count(distinct st.opportunity_id) as feedback_count 
	FROM views.salesforce_task st
	group by 1
) ta on ta.opportunity_id=sf.salesforce_order_id"	READY
32,823	2015-04-29 12:51:46	"1112787894"	true	2015-04-29 12:51:46	tableau.buying_delivery_performance		"CREATE view tableau.buying_delivery_performance
AS

SELECT 
	pop.article_id,
	pop.purchase_order_id,
	art.brand,
     art.season,
	sum(case when pop.quantity = scan.count_scans then 1 else 0 end) as ""MATCH"",
	sum(case when pop.quantity > scan.count_scans then 1 else 0 end) as ""UNDERDELIVERED"",
	sum(case when pop.quantity < scan.count_scans then 1 else 0 end) as ""OVERDELIVERED"",
	sum(case when cast(scan.max_date_delivered as date) < cast(pop.earliest_delivery_date as date) and cast(scan.max_date_delivered as date) < cast(pop.latest_delivery_date as date) then 1 else 0 end) as ""EARLY"",
	sum(case when cast(scan.max_date_delivered as date) > cast(pop.earliest_delivery_date as date) and cast(scan.max_date_delivered as date) < cast(pop.latest_delivery_date as date) then 1 else 0 end) as ""ON TIME"",
	sum(case when cast(scan.max_date_delivered as date) > cast(pop.earliest_delivery_date as date) and cast(scan.max_date_delivered as date) > cast(pop.latest_delivery_date as date) then 1 else 0 end) as ""LATE"" 
FROM views.purchase_order_position pop
left join views.scantemplates_agg scan on scan.po = pop.purchase_order_id and scan.ean = pop.ean 
left join 
(
	select 
		ean, 
		brand, 
		season 
	from views.ownstock_article 
	where supplier_id = 15
) art on art.ean = pop.ean
group by 1,2,3,4"	READY
32,824	2015-04-29 12:57:51	"1112787895"	true	2015-04-29 12:57:51	tableau.buying_finance		"CREATE VIEW tableau.buying_finance
AS

SELECT
	a.brand,
	a.season,
	avg(case when op.stock_location_id=2 and op.state !=2048 and op.date_shipped is not null then op.purchase_price else 0 end) as avg_purchase_price, 
	avg(case when op.stock_location_id=2 and op.state !=2048 and op.date_shipped is not null then op.retail_price_euro else 0 end) as avg_retail_price,
	sum(case when op.stock_location_id=2 and op.state !=2048 and op.date_shipped is not null then op.purchase_price else 0 end) as total_purchase_price, 
	sum(case when op.stock_location_id=2 and op.state !=2048 and op.date_shipped is not null then op.retail_price_euro else 0 end) as total_retail_price,
	sum(case when op.stock_location_id=2 and op.state >  128 and op.state !=2048 and op.date_shipped is not null then 1 else 0 end) as shipped,
	sum(case when op.stock_location_id=2 and op.state >  128 and op.state !=2048 and op.date_shipped is not null then op.purchase_price else 0 end) as shipped_EK,
	sum(case when op.stock_location_id=2 and op.state >  128 and op.state !=2048 and op.date_shipped is not null then op.retail_price_euro else 0 end) as shipped_VK,
	sum(case when op.stock_location_id=2 and op.state = 1024 and op.date_shipped is not null then 1 else 0 end) as completed,
	sum(case when op.stock_location_id=2 and op.state = 1024 and op.date_shipped is not null then op.purchase_price else 0 end) as completed_EK,
	sum(case when op.stock_location_id=2 and op.state = 1024 and op.date_shipped is not null then op.retail_price_euro else 0 end) as completed_VK,
	sum(case when op.stock_location_id=2 and op.state >= 384 and op.state <= 512 and op.date_shipped is not null then 1 else 0 end) as returned,
	sum(case when op.stock_location_id=2 and op.state >= 384 and op.state <= 512 and op.date_shipped is not null then op.purchase_price else 0 end) as returned_EK,
	sum(case when op.stock_location_id=2 and op.state >= 384 and op.state <= 512 and op.date_shipped is not null then op.retail_price_euro else 0 end) as returned_VK,
	sum(case when op.stock_location_id=2 and op.state = 1536 and date_shipped is not null then 1 else 0 end) as lost
FROM views.order_position op
left join 
(
	SELECT 
		article_id, 
		brand,
		season 
	FROM views.ownstock_article 
	WHERE supplier_id = 15
) a on op.article_id = a.article_id 
GROUP BY 1,2"	READY
385	2015-04-24 18:24:11	"1112787860"	true	2015-04-24 18:24:11	tableau.ops_logistics_overview_order_article		"CREATE VIEW tableau.ops_logistics_overview_order_article AS

SELECT
	coal.*,
	col.date_stylist_picked,
	col.logistics_order_state,
	col.date_created,
	CASE
		WHEN col.date_picklist_created < coal.date_backordered THEN 'picklist before backorder'
		WHEN col.date_picklist_created > coal.date_backordered THEN 'backorder before picklist'
	END AS picklist_or_backordered_first
	/* CAST(COALESCE(date_stylist_picked, date_header_created, date_created) AS DATE) AS date_stylist_picked_or_created
	 COALESCE(orders_returned, orders_shipped) orders_shipped_and_returned	*/
FROM 
	bi.customer_order_articles_logistics coal
	JOIN
	bi.customer_order_logistics col
		ON coal.order_id = col.order_id
WHERE 
	CAST(COALESCE(col.date_stylist_picked, col.date_header_created, col.date_created) AS DATE) > TIMESTAMPADD(SQL_TSI_MONTH,-2,CURDATE())"	READY
32,826	2015-04-29 15:30:07	"1112787896"	true	2015-05-13 11:38:00	tableau.buying_po_own_stock		"CREATE VIEW tableau.buying_po_own_stock AS

SELECT
pop.id,
pop.purchase_order_id,
pop.ean,
pop.article_id,
pop.earliest_delivery_date,
pop.fulfilled_quantity,
pop.initial_quantity,
pop.purchase_price,
pop.quantity,
pop.retail_price,

/*Purchase Order*/
po.season,
po.date_created as purchase_order_date_created,
po.stock_location_id as purchase_order_stock_location_id,
po.supplier_id as purchase_order_supplier_id,

/*Stock Booked*/
sma.min_date_created,
sma.max_date_created,
sma.dd_quantity_good,

/*Own Stock Articles*/
owa.o_parentId,
owa.season as ownstock_article_season,
owa.o_published,
owa.brand,
owa.date,
owa.article_name,
owa.article_size,
owa.supplier_sku,
owa.supplier_color_name,
owa.commodity_group1,
owa.commodity_group2,
owa.commodity_group3,
owa.commodity_group4

FROM views.purchase_order_position pop
JOIN views.purchase_order po ON pop.purchase_order_id = po.id
LEFT JOIN views.ownstock_article owa ON pop.article_id = owa.article_id
LEFT JOIN views.ownstock_article osa ON pop.article_id = osa.article_id
LEFT JOIN 
	(	SELECT
			article_id,
			purchase_order_id,
			MIN(date_stock_booked) AS min_date_created,
			MAX(date_stock_booked) AS max_date_created,
			SUM(po_bookings) AS dd_quantity_good
		FROM
			bi.stock_booked
		WHERE 
			po_bookings IS NOT NULL
		GROUP BY 1,2
	) AS sma
		ON pop.article_id = sma.article_id AND pop.purchase_order_id = sma.purchase_order_id"	READY
32,828	2015-04-29 16:20:45	"1112787897"	true	2015-05-28 12:39:33	sandbox.marketing_order_attribution_new		"CREATE VIEW sandbox.marketing_order_attribution_new
AS
SELECT
  at.date_incoming,
  'date_incoming' as reporting_type,
  at.default_domain as domain,
  at.order_type,
  at.marketing_channel,
  at.incoming_orders,
  at.invoiced_orders,
  ROUND(COALESCE(SUM(ab.incoming_orders_untracked)/SUM(ab.incoming_orders_total),0),2) as share_untracked,
  CASE 
    WHEN SUM(ab.incoming_orders_total) is null OR SUM(ab.incoming_orders_total - ab.incoming_orders_untracked) = 0 THEN 0
    WHEN SUM(ab.incoming_orders_untracked) is null THEN SUM(at.incoming_orders)
    ELSE ROUND(SUM(at.incoming_orders) / SUM(ab.incoming_orders_total - ab.incoming_orders_untracked) * SUM(ab.incoming_orders_total),2)
  END AS incoming_orders_adjusted,
  CASE
    WHEN SUM(ab.invoiced_orders_total) is null OR SUM(ab.invoiced_orders_total - ab.invoiced_orders_untracked) = 0 THEN 0
    WHEN SUM(ab.invoiced_orders_untracked) is null THEN SUM(at.invoiced_orders)
    ELSE ROUND(SUM(at.invoiced_orders) / SUM(ab.invoiced_orders_total - ab.invoiced_orders_untracked) * SUM(ab.invoiced_orders_total),2)
  END AS invoiced_orders_adjusted
FROM
(
SELECT 
      cast(co.date_incoming as date) as date_incoming,
      cu.default_domain,
      order_type,
      marketing_channel,
      SUM(ROUND(oa.contact_weight,2)) as incoming_orders,
      SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 THEN ROUND(oa.contact_weight,2) ELSE 0 END) as invoiced_orders
    FROM bi.customer_order co
    LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
    LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
    WHERE co.date_incoming >= '2014-01-01'
    AND co.is_real_order = 'Real Order'
    AND marketing_channel != 'Untracked'
    GROUP BY 1,2,3,4
) at
LEFT JOIN
(
  SELECT 
      cast(co.date_incoming as date) as date_incoming,
      cu.default_domain,
      order_type,
      SUM(ROUND(oa.contact_weight,2)) as incoming_orders_total,
      SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 THEN ROUND(oa.contact_weight,2) ELSE 0 END) as invoiced_orders_total,
      SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN (ROUND(oa.contact_weight,2)) else 0 END) as incoming_orders_untracked,
      SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' AND co.date_invoiced is not null AND co.order_state_number >= 16 THEN ROUND(oa.contact_weight,2) ELSE 0 END) as invoiced_orders_untracked          
    FROM bi.customer_order co
    LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
    LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
    LEFT JOIN dwh.marketing_investor_reporting_brand_factors mi ON  mi.marketing_channel = oa.marketing_channel AND mi.domain = cu.default_domain
    WHERE co.date_incoming >= '2014-01-01'
    AND co.is_real_order = 'Real Order'
    GROUP BY 1,2,3
) ab ON ab.date_incoming = at.date_incoming AND ab.default_domain = at.default_domain AND ab.order_type = at.order_type
GROUP BY 1,2,3,4,5,6,7
UNION ALL
SELECT
  at.date_incoming,
  'date_invoiced' as reporting_type,
  at.default_domain as domain,
  at.order_type,
  at.marketing_channel,
  null as incoming_orders,
  at.invoiced_orders,
  ROUND(COALESCE(SUM(ab.invoiced_orders_untracked)/SUM(ab.invoiced_orders_total),0),2) as share_untracked,
  null as incoming_orders_adjusted,
  CASE
    WHEN SUM(ab.invoiced_orders_total) is null OR SUM(ab.invoiced_orders_total - ab.invoiced_orders_untracked) = 0 THEN 0
    WHEN SUM(ab.invoiced_orders_untracked) is null THEN SUM(at.invoiced_orders)
    ELSE ROUND(SUM(at.invoiced_orders) / SUM(ab.invoiced_orders_total - ab.invoiced_orders_untracked) * SUM(ab.invoiced_orders_total),2)
  END AS invoiced_orders_adjusted
FROM
(
SELECT 
      cast(co.date_invoiced as date) as date_incoming,
      cu.default_domain,
      order_type,
      marketing_channel,
      SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 THEN ROUND(oa.contact_weight,2) ELSE 0 END) as invoiced_orders
    FROM bi.customer_order co
    LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
    LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
    WHERE co.date_incoming >= '2014-01-01'
    AND co.is_real_order = 'Real Order'
    AND marketing_channel != 'Untracked'
    GROUP BY 1,2,3,4
) at
LEFT JOIN
(
  SELECT 
      cast(co.date_invoiced as date) as date_incoming,
      cu.default_domain,
      order_type,
      SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 THEN ROUND(oa.contact_weight,2) ELSE 0 END) as invoiced_orders_total,
      SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' AND co.date_invoiced is not null AND co.order_state_number >= 16 THEN ROUND(oa.contact_weight,2) ELSE 0 END) as invoiced_orders_untracked          
    FROM bi.customer_order co
    LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
    LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
    LEFT JOIN dwh.marketing_investor_reporting_brand_factors mi ON  mi.marketing_channel = oa.marketing_channel AND mi.domain = cu.default_domain
    WHERE co.date_incoming >= '2014-01-01'
    AND co.is_real_order = 'Real Order'
    GROUP BY 1,2,3
) ab ON ab.date_incoming = at.date_incoming AND ab.default_domain = at.default_domain AND ab.order_type = at.order_type
GROUP BY 1,2,3,4,5,6,7"	READY
32,834	2015-04-29 18:12:12	"1112787898"	true	2015-04-29 18:12:12	tableau.ops_followon_returns		"CREATE VIEW tableau.ops_followon_returns
AS

SELECT 
	cal.date,
	ret.orders_returned,
	COUNT(DISTINCT fol.order_id) followon_orders,
	COUNT(DISTINCT
		CASE WHEN fol.working_days >=0 AND fol.working_days <= 14 THEN fol.order_id END)
	AS followon_orders_working_days_0_14,
	COUNT(DISTINCT
		CASE WHEN fol.working_days >14 THEN fol.order_id END)
	AS followon_orders_working_days_over_14

FROM 
	dwh.calendar cal
	LEFT JOIN
	(
		SELECT CAST(date_returned AS DATE) date_returned, COUNT(DISTINCT order_id) AS orders_returned
		FROM
			bi.customer_order 
		WHERE
			    order_state != 'Cancelled'
			AND date_returned IS NOT NULL
			AND articles_returned >0
		GROUP BY 1
	) AS ret 
		ON cal.date = ret.date_returned
	LEFT JOIN
	(
		SELECT 
			co.id as order_id,
			CAST(co.date_picked AS DATE) as followon_date_picked,
			sum(cal1.working_days) as working_days
		FROM 
			views.customer_order co
			join
				(select
					id,
					date_returned as original_return_date,
					state as parent_order_state
				from
					views.customer_order) a
				on a.id = parent_order_id
			join 
			dwh.calendar cal1
				on cal1.""date"" between cast(a.original_return_date as date) and cast(co.date_picked as date)
		WHERE
			co.parent_order_id is not null
		and co.state >= 16 
		and co.state <> 2048
		and a.parent_order_state >= 16
		and a.parent_order_state <> 2048
		and co.date_picked is not null
		group by 1,2
		HAVING 
			sum(cal1.working_days) IS NOT NULL
	) AS fol
		ON cal.date = fol.followon_date_picked

WHERE 
	cal.date >='2015-01-01' AND cal.date <= CURDATE()
GROUP BY 1,2"	READY
884,736	2015-09-23 11:39:04	"1357078897"	true	2015-09-23 17:57:14	tableau.ops_delivery_return_tracking		"CREATE VIEW ""tableau.ops_delivery_return_tracking""
AS

SELECT 
	a.order_id,
	a.tracking_number,
	a.date_transmission_to_carrier,
	a.date_1st_scan_by_carrier,
	COALESCE(a.date_received,a.date_delivered_to_customer,a.date_1st_scan_by_carrier) AS date_delivered_to_customer,
	col.date_returned,
	co.shipping_country
FROM
(  
  SELECT
  	order_id,
  	tracking_number,
  	MAX(CASE WHEN tag='InfoReceived' THEN updated_at ELSE NULL END) AS date_transmission_to_carrier,
    MIN(CASE WHEN tag='InTransit' THEN updated_at ELSE NULL END) AS date_1st_scan_by_carrier,
    MAX(CASE WHEN tag='Delivered' THEN updated_at ELSE NULL END) AS date_delivered_to_customer,
    MAX(CASE 
    		WHEN tag='Delivered' AND active=false THEN 
    		CASE WHEN tag='InfoReceived' THEN updated_at ELSE NULL END 
    	ELSE NULL END) as date_received
  FROM bi.delivery_tracking
  GROUP BY 1,2
)a
JOIN bi.customer_order_logistics col on col.order_id=a.order_id and col.return_track_and_trace_number=a.tracking_number
LEFT JOIN bi.customer_order co ON co.order_id=a.order_id"	READY
884,742	2015-09-24 10:36:34	"1362394703"	true	2015-09-24 10:36:34	ml.order_position_return_rate_prediction_copy		CREATE VIEW ml.order_position_return_rate_prediction_copy AS
SELECT * FROM "mlpg.order_position_return_rate_prediction"	READY
247	2015-04-24 18:19:33	"1367726809"	true	2015-04-24 18:19:33	affilinet_adv.OrdersLastMonthByRegistrationDate		"create view affilinet_adv.OrdersLastMonthByRegistrationDate as
select * from (call ""affilinet_adv.GetOrders""(
    ""program_id"" => 5245,
    ""start_date"" => TIMESTAMPADD( SQL_TSI_MONTH, -1, curdate() ),
    ""end_date"" => curdate(),
    ""valuation_type"" => 'RegistrationDate',
    ""transaction_status"" =>'All'
)) a"	READY
202	2015-04-24 18:19:16	"1112787710"	true	2015-04-24 18:19:16	tableau.mkt_incoming_and_invoiced_orders_costs		"CREATE VIEW tableau.mkt_incoming_and_invoiced_orders_costs
AS
SELECT 
date_created,
country,
CASE 
	WHEN channel = 'google sem' THEN 'google sem nobrand'
	WHEN channel = 'google gdn' THEN 'display'
	WHEN channel in ('app download campaign', 'youtube') THEN 'other'
	ELSE channel
END as marketing_channel,
cost 
FROM raw.marketing_costs mc"	READY
205	2015-04-24 18:19:17	"1112787713"	true	2015-04-24 18:19:17	bi.customer_preview_articles		"CREATE VIEW bi.customer_preview_articles
AS 
SELECT * FROM raw.customer_preview_articles"	READY
557,059	2015-08-18 10:15:46	"1179989751"	true	2015-08-18 10:15:46	tableau.mkt_insert_campaign_development		"CREATE VIEW tableau.mkt_insert_campaign_development
AS

SELECT
	mc.marketing_campaign,
	de.cluster,
	de.country,
	de.campaign_type,
	CAST(mi.date_first_order as date) as date_first_order,
	cn.total_orders,
	TIMESTAMPDIFF(SQL_TSI_DAY,mi.date_first_order,co.date_incoming) as days_since_first_order,
	COUNT(co.order_id) as order_count
	FROM raw.marketing_contacts_discounts mc
LEFT JOIN bi.customer_order co ON mc.order_id = co.order_id
LEFT JOIN raw.marketing_voucher_campaign_details de ON de.campaign_title = LTRIM(RTRIM(mc.marketing_campaign))
LEFT JOIN
(
SELECT 
	mc.marketing_campaign,
	MIN(co.date_incoming) as date_first_order
FROM raw.marketing_contacts_discounts mc
LEFT JOIN bi.customer_order co ON mc.order_id = co.order_id
GROUP BY 1
) mi ON mi.marketing_campaign = mc.marketing_campaign
LEFT JOIN
(
SELECT
marketing_campaign,
COUNT(order_id) as total_orders
FROM raw.marketing_contacts_discounts
GROUP BY 1
) cn ON cn.marketing_campaign = mc.marketing_campaign
WHERE mc.marketing_channel = 'Inserts'
GROUP BY 1,2,3,4,5,6,7"	READY
393	2015-04-24 18:24:25	"1112787867"	true	2015-05-11 10:06:57	tableau.product_funnel_signup_survey		"CREATE view tableau.product_funnel_signup_survey
AS

/*Customer Survery*/
WITH cust_first_order AS
(
SELECT 
		co.customer_id,
		co.id,
		co.shipping_country,
		co.order_type,
		rank() over (partition by customer_id order by date_created) as r_cust
	FROM views.customer_order co
)
SELECT 
	cs.*,
	cu.default_page,
	cast(cu.date_created as date) as customer_date_created,
	co.shipping_country,
	mo.device_category,
	mo.mobile_device_branding,
	mo.mobile_device_model,
	mo.mobile_device_info,
	mo.operating_system,
    c_order_type.order_type
FROM views.customer cu
LEFT JOIN raw.customer_survey cs on cs.customer_id=cu.customer_id
/*This join is to get the device used for creating first order since 
customer survery is done only for first order*/
LEFT JOIN
(
	SELECT
	*
	FROM cust_first_order 
	WHERE r_cust=1
)co on cu.customer_id=co.customer_id
LEFT JOIN views.marketing_order mo on mo.order_id=co.id
/*Get Order Type of last order created by customer*/
LEFT JOIN
(
	SELECT 
		a.customer_id,
		a.order_type
	FROM cust_first_order a
	LEFT JOIN
	(
		SELECT
			customer_id,
			max(r_cust) as last_rank
		FROM cust_first_order
	GROUP BY 1
	)b ON a.customer_id=b.customer_id 
	where a.r_cust=b.last_rank
)c_order_type on c_order_type.customer_id=cu.customer_id"	READY
32,847	2015-04-30 14:21:53	"1112787902"	true	2015-07-30 17:58:58	tableau.billing_arvato_check		"CREATE VIEW tableau.billing_arvato_check
AS

SELECT
co.order_id,
co.customer_id,
co.date_created,
co.order_type,
co.shipping_country,
co.date_shipped,
co.payment_type,
co.arvato_score as arvatoscore,
co.order_state_number as state,
co.sales_sent as total_amount_basket_retail_gross,
co.billing_total as total_amount_billed_retail_gross,
co.billing_received as total_amount_paid,

/*Arvato Results (will be replaced to bi tables*/
arv.responseCode_1,
arv.responseCode_2,
arv.responseCode_3,
arv.arvatoresult_1,
arv.arvatoresult_2,
arv.arvatoresult_3,
arv.arvatoorderlimit1,
arv.arvatoorderlimit2,
arv.arvatoorderlimit3,
arv.valuation1,

cos.newcardrecommendation as sf_NewCardrecommendation__c,
cos.max_basket_arvato as sf_Max_Warenkorbempfehlung_Arvato__c

FROM bi.customer_order co 
LEFT JOIN views.arvatoresults arv on co.order_id=arv.order_id
LEFT JOIN bi.customer_order_salesforce cos on cos.order_id=arv.order_id"	READY
208	2015-04-24 18:19:17	"1112787714"	true	2015-05-27 22:45:28	bi.customer_order_articles_logistics		"CREATE VIEW bi.customer_order_articles_logistics AS

SELECT * FROM raw.customer_order_articles_logistics_3mo 
UNION ALL
SELECT * FROM raw.customer_order_articles_logistics_before_3mo"	READY
209	2015-04-24 18:19:18	"1112787715"	true	2015-05-12 15:02:56	raw.customer_order_logists_outbound_sla		"CREATE VIEW raw.customer_order_logists_outbound_sla 
AS

WITH sla AS
(
  SELECT 
    CAST(order_id AS LONG) AS order_id,
    sla_date_start,
    sla_date_start_adjusted,
    date_shipment_confirmation_max,
    date_shipped,
    b.next_ship_day,
    /* all orders that are received before 14 on a work day, must ship same day. All orders received after 14, must ship the following day */
    case 
      when cast(sla_date_start_adjusted as date) >= cast(date_shipment_confirmation_max as date) then 'on_time'
      when hour(sla_date_start_adjusted) >= 14 and cast(timestampadd(SQL_TSI_DAY,+1,sla_date_start) as date) = cast(date_shipment_confirmation_max as date) then 'on_time'
      when hour(sla_date_start_adjusted) >= 14 and b.next_ship_day = cast(date_shipment_confirmation_max as date) then 'on_time'
      else 'late' 
    end as sla_performance,
  sum(cal2.working_days) as sla_working_days
  FROM 
  (
    SELECT
      order_id,
      sla_date_start,
      next_ship_day,
      /* sometimes the start day is on a weeked or holiday, so we need to push the start day to the next work day at 8am */
      case 
        when working_days = 1 then cast((cal.business_day)||' '||(cast(a.sla_date_start as time)) as timestamp)
        when working_days = 0 then cast((cal.business_day)||' '||(parseTime ('08:00:00', 'HH:mm:ss')) as timestamp)
        else null 
      end as ""sla_date_start_adjusted"",
      date_shipment_confirmation_max,
      date_shipped
    FROM 
    (
      SELECT
      /* for the start day, we, ideally, want to take sales order import result, bit if the order goes on backorder, that's our fault and doc data's performance should not be impacted. 
      Therefore, we take max picklist created date for orders that have had the backorder status; if it didnt go backorder/not on stock, then take the date from the sales order import results */
        ddms.order_id,
        case 
          when  plc.PLC_status_max_date < ddsoir.max_date_created then plc.PLC_status_max_date
          when bo.bo_status_max_date is null then ddsoir.max_date_created else plc.plc_status_max_date 
        end as ""sla_date_start"",
        ddsc.max_date_created as ""date_shipment_confirmation_max"",
        parsedate(min(ddms.shipping_date), 'yyyyMMdd') as date_shipped
      FROM raw.stock_shipped ddms
      
      JOIN 
      (
        SELECT 
          order_id, 
          max(date_stock_imported) as max_date_created 
        FROM raw.stock_imported 
        GROUP BY 1
      )ddsoir ON ddsoir.order_id = ddms.order_id
    
      JOIN 
      (
        SELECT 
          order_id, 
          max(date_stock_shipped) as max_date_created 
        FROM raw.stock_shipped
        GROUP BY 1
      )ddsc ON ddsc.order_id = ddms.order_id
      
      JOIN
      (
        SELECT 
          order_id,
          max(date_status_change) as plc_status_max_date
        FROM raw.stock_sales_order_status_change  
        WHERE message = 'PICKLIST CREATED' 
        GROUP BY 1
      )PLC ON ddms.order_id = PLC.order_id
      
      left join
      (
        SELECT 
          order_id,
          max(date_status_change) as bo_status_max_date
        FROM raw.stock_sales_order_status_change 
        WHERE message = 'BACKORDER' 
        OR message = 'NOT ON STOCK'
        GROUP BY 1
      ) BO ON ddms.order_id = BO.order_id
      
      WHERE shipping_date > 20130630
      /*----eliminate outlet order_ids----*/
      AND receiver_company not in ('Outfittery', 'Outfittery Outlet')
      AND receiver_name not in ('Outfittery GmbH', 'Outfittery GMBH', 'Outfittery  GmbH', 'Outfittery   GmbH', 'OUTFITTERY Stylist', 'Salesorder OUTFITTERY Einkauf')
      GROUP BY 1,2,3
    ) a
    left join dwh.calendar cal on cast(sla_date_start as date) = cal.""date""
  ) b
  left join dwh.calendar cal2 on cal2.""date"" between cast(b.sla_date_start_adjusted as date) and cast(b.date_shipment_confirmation_max as date)
  WHERE order_id NOT LIKE '% %' /* TO GET RID OF BAD ORDER ID */
  group by 1,2,3,4,5,6
)


SELECT
  sla.order_id,
  sla.sla_date_start,
  sla.sla_date_start_adjusted,
  sla.date_shipment_confirmation_max AS sla_date_shipment_confirmation,
  sla.date_shipped  AS sla_date_shipped,
  sla.next_ship_day  AS sla_next_ship_day,
  sla.sla_performance,
  sla.sla_working_days,
  CASE
    WHEN sla.sla_working_days = 1     THEN TIMESTAMPDIFF(SQL_TSI_HOUR, sla.sla_date_start_adjusted, sla.date_shipment_confirmation_max)
    WHEN sla.sla_working_days IS NULL   THEN TIMESTAMPDIFF(SQL_TSI_HOUR, sla.sla_date_start, sla.date_shipment_confirmation_max)
    WHEN sla.sla_working_days > 1     THEN ((sla.sla_working_days-2)*24) + (24 - HOUR(sla.sla_date_start_adjusted)) + HOUR(sla.date_shipment_confirmation_max)
  END AS sla_hours
FROM sla"	READY
917,505	2015-09-28 12:28:46	"1383764541"	true	2015-09-28 12:28:46	sandbox.fact_order		"/********************************************************************************************** 
-- Author       Hemanth 
-- Created      2015-07-01 
-- Purpose      This view joins tables from raw and datamart schema, this view has all kpi's aggregated 
                on customer_id 
-- Tables       datamart.dim_order,datamart.dim_case,datamart.fact_order 
-------------------------------------------------------------------------------------------------- 
-- Modification History 
 
-- Date          Author      Description 
-- 2015-09-16    Hemanth     1) Header for query 
**************************************************************************************************/ 
CREATE VIEW sandbox.fact_order 
AS 
 
SELECT 
  op_1.order_id, 
   
  op_1.items_b4_can AS itb4canc, 
  op_1.items_cancelled AS itcan, 
  op_1.items_b4_ret AS itb4ret, 
  op_1.items_returned AS itret, 
  op_1.items_returned_est AS estitret, 
  COALESCE(op_1.items_kept,op_1.items_kept_est) AS itexp, 
 
  /*Gross Sales In euros*/ 
  op_1.gross_sales_b4_can_in_eur AS gsb4canc_in_eur, 
  op_1.gross_sales_can_in_eur AS gscanc_in_eur, 
  op_1.gross_sales_b4_ret_in_eur AS gsb4ret_in_eur, 
  op_1.gross_sales_ret_in_eur AS gret_in_eur, 
  fo_1.goodwill_in_eur AS ggood_in_eur, 
  op_1.gross_sales_ret_est_in_eur AS estgret_in_eur, 
  COALESCE(op_1.sales_kept_in_eur,op_1.sales_kept_est_in_eur)-fo_1.est_goodwill_in_eur AS gsexp_in_eur, 
  /*Net Sales*/ 
  op_1.gross_sales_b4_can_in_eur/(1+v.vat_rate) AS nsb4canc_in_eur, 
  op_1.gross_sales_can_in_eur/(1+v.vat_rate) AS nscanc_in_eur, 
  op_1.gross_sales_b4_ret_in_eur/(1+v.vat_rate) AS nsb4ret_in_eur, 
  op_1.gross_sales_ret_in_eur/(1+v.vat_rate) AS nret_in_eur, 
  fo_1.goodwill_in_eur/(1+v.vat_rate) AS ngood_in_eur, 
  op_1.gross_sales_ret_est_in_eur AS estnret_in_eur,
  (COALESCE(op_1.sales_kept_in_eur,op_1.sales_kept_est_in_eur)-fo_1.est_goodwill_in_eur)/(1+v.vat_rate) AS nsexp_in_eur, 
   
  /*Gross Sales in Local Currency*/ 
  op_1.gross_sales_b4_can_in_local_currency  AS gsb4canc_in_local_currency, 
  op_1.gross_sales_can_in_local_currency AS gscanc_in_local_currency, 
  op_1.gross_sales_b4_ret_in_local_currency AS gsb4ret_in_local_currency, 
  op_1.gross_sales_ret_in_local_currency AS gret_in_local_currency, 
  fo_1.goodwill_in_local_currency AS ggood_in_local_currency, 
  op_1.gross_sales_ret_est_in_local_currency AS estgret_in_local_currency, 
  COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency)-fo_1.est_goodwill_in_local_currency AS gsexp_in_local_currency, 
  /*Net Sales in Local Currency*/ 
  op_1.gross_sales_b4_can_in_local_currency/(1+v.vat_rate) AS nsb4canc_in_local_currency, 
  op_1.gross_sales_can_in_local_currency/(1+v.vat_rate) AS nscanc_in_local_currency, 
  op_1.gross_sales_b4_ret_in_local_currency/(1+v.vat_rate) AS nsb4ret_in_local_currency, 
  op_1.gross_sales_ret_in_local_currency/(1+v.vat_rate) AS nret_in_local_currency, 
  fo_1.goodwill_in_local_currency/(1+v.vat_rate) AS ngood_in_local_currency, 
  op_1.gross_sales_ret_est_in_local_currency/(1+v.vat_rate) AS estnret_in_local_currency, 
  (COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency)-fo_1.est_goodwill_in_local_currency)/e.exchange_rate/(1+v.vat_rate) AS nsexp_in_local_currency, 
   
  op_1.cogb4canc, 
  op_1.cogcanc, 
  op_1.cogb4ret, 
  op_1.cogret, 
  op_1.Estcogret, 
  COALESCE(op_1.cogs_kept,op_1.cogs_kept_est) AS cogexp, 
 
  fo_1.discount_in_local_currency as netdisc_in_local_currency,
  fo_1.discount_in_eur as netdisc_in_eur,
  fo_1.est_discount_in_local_currency as estnetdisc_in_local_currency,
  fo_1.est_discount_in_eur as estnetdisc_in_eur,

  co_2.date_amount_paid, 
  CASE   
      WHEN COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total < 0 THEN 0  
      ELSE COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total  
    END AS billing_total, 
    co_2.billing_received, 
    CASE   
      WHEN COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total < 0 THEN 0  
      ELSE COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total 
    END - co_2.billing_received AS billing_open, 
 
    CASE   
      WHEN COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total < 0 THEN 0  
      ELSE COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total 
    END * (v.vat_rate/(1 + v.vat_rate)) AS billing_vat,  
    CASE   
     
      WHEN COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total < 0 THEN 0  
      ELSE COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total 
    END / (1 + v.vat_rate) AS billing_net_sales 
FROM raw.fact_order op_1
LEFT JOIN raw.dim_customer_order co_1 on co_1.order_id=op_1.order_id 
LEFT JOIN dwh.historical_exchange_rates e on e.currency_code = co_1.country_code_iso AND cast(co_1.date_invoiced AS date) = e.date 
LEFT JOIN dwh.calendar c on c.date = cast(co_1.date_invoiced AS date) 
LEFT JOIN dwh.vat_rates v on v.year_month = c.year_month AND co_1.shipping_country = v.country_code_iso 
LEFT JOIN
(
  SELECT
    fo.order_id,
    fo.goodwill_in_local_currency,
    fo.goodwill_in_eur,
    fo.discount_in_local_currency,
    fo.discount_in_eur,
    CASE 
      WHEN fo.items_returned=fo.items_b4_ret AND fo.goodwill_in_local_currency IS NOT NULL THEN 0 
      ELSE fo.goodwill_in_local_currency
    END AS est_goodwill_in_local_currency,
    CASE 
      WHEN fo.items_returned=fo.items_b4_ret AND fo.goodwill_in_eur IS NOT NULL THEN 0 
      ELSE fo.goodwill_in_eur
    END AS est_goodwill_in_eur,
    CASE 
      WHEN fo.items_returned=fo.items_b4_ret AND fo.discount_in_local_currency IS NOT NULL THEN 0
      ELSE fo.discount_in_local_currency
    END AS est_discount_in_local_currency,
    CASE 
      WHEN fo.items_returned=fo.items_b4_ret AND fo.discount_in_eur IS NOT NULL THEN 0
      ELSE fo.discount_in_eur
    END AS est_discount_in_eur
  FROM raw.fact_order fo
)fo_1 ON fo_1.order_id=op_1.order_id
LEFT JOIN 
( 
  SELECT 
    c.order_id, 
    /*billing recieved arvato customers is uploaded in dwh from arvato ftp server*/ 
    COALESCE(CASE  
      WHEN c.payment_type<>'Arvato' THEN c.total_amount_payed 
      ELSE arv.billing_received_arvato 
    END,0) AS billing_received, 
    CASE 
      WHEN c.payment_type<>'Arvato' THEN c.date_paid 
      ELSE arv.date_arvato_paid 
    END AS date_amount_paid 
  FROM raw.dim_customer_order c 
  LEFT JOIN 
  ( 
    SELECT   
      ordernumber AS order_id,  
      MIN(date_created) AS date_arvato_paid,  
      SUM(amount) AS billing_received_arvato  
    FROM dwh.arvato_payments ap  
    GROUP BY 1  
  )arv on arv.order_id = c.order_id 
)co_2 on co_1.order_id=co_2.order_id"	READY
32,848	2015-04-30 15:49:31	"1112787903"	true	2015-05-18 09:54:32	tableau.product_nocall_no_survey_info		"CREATE VIEW tableau.product_nocall_no_survey_info
AS

SELECT 
	co.order_id,
    co.customer_id,
    co.sales_channel,
	co.date_created,
	co.order_state,
	co.order_state_number,
	cu.date_created as customer_date_created,
	co.shipping_country,
	co.order_type,
	co.kept_state,
	co.articles_sent,
	co.articles_kept,
	co.articles_returned,
	cast(cu.additional_info as string) as additional_info,
	/*snowplow successpage*/
	ns.collector_tstamp,
	ns.user_id,
	ns.page_url,
	ns.page_urlpath,
	ns.refr_urlquery,
	substring(page_urlpath,locate('/success',page_urlpath)+1,length(page_urlpath)) as success_goal_shares,
	case when page_urlpath like '%sucess%' then 'success screen' else 'no success_screen' end as sucess_url,
	case when page_referrer like '%create%' then 'create_order'
	else null
	end page_referrer,
	mo.utm_keyword
	
FROM bi.customer_order co
LEFT JOIN bi.customer cu on co.customer_id=cu.customer_id
LEFT JOIN sandbox.snowplow_nocall_success ns on ns.tr_orderid=co.order_id
LEFT JOIN views.marketing_order mo on mo.order_id=co.order_id
WHERE cast(co.date_created as date)>='2015-04-01'
AND co.sales_channel in ('websiteWithoutDate','websiteWithoutDateAndPendingConfirmation')
AND cu.additional_info NOT LIKE '{limited-look%'"	READY
32,772	2015-04-27 15:24:23	"1080153551"	true	2015-07-28 09:19:49	raw.nav_item		"CREATE VIEW raw.nav_item 
AS

/* This is the new item model from the ERP, Navision. It was built in conjunction with Klaus. It replaces all previous article/item models */


SELECT

	/* ITEM AND VARIANT IDENTIFIERS */
	item.""No_"" AS item_no,
	variant.code AS variant_code,
	color.code AS color_code,
	size.code AS size_code,
	/* item.""No_"" || '-' || variant.code AS item_variant, */
	item.""No_ 2"" AS parent_no, /* parent_o_id from pim; will be phased out */
	variant.""PFCommon Item Variant Code"" AS ean,
	/*	item.""Vendor No_"" AS vendor_no, NOT USED BY BUYING*/
	CASE 
		WHEN item.""Vendor Item No_"" = '' THEN NULL
		ELSE item.""Vendor Item No_""
	END AS vendor_item_no,
	
	/* DESCRIPTIONS */
	item.""Description"" AS item_description,
	item.""item category code"" AS category_code,
	cat.""Description"" AS category, /* COMMODITY GROUP 4 FROM PIM */
	item.""product group code"" AS product_group_code,
	prod.""description"" as product_group, /* COMMODITY GROUP 5 FROM PIM */

	/* DATES */
	/* earliest deliv date
	latest deliv date
	look at doc data tables for pos */

	/* ITEM STATUS */
	/* pfitem status */
	status.description AS item_status,

	CASE 
		WHEN variant.""Item Status Internal""=1 THEN 'Marketing Stop'
		WHEN variant.""Item Status Internal""=2 THEN 'Return Stop'
		WHEN variant.""Item Status Internal""=3 THEN 'Sontiges'
		ELSE NULL
	END as item_status_internal,

	variant.""Item Status Purchase"" AS item_status_purchase,
	CASE
		WHEN variant.""Item Status Purchase"" = '' THEN NULL
		WHEN variant.""Item Status Purchase"" = 0  THEN NULL
		WHEN variant.""Item Status Purchase"" = 1  THEN 'Stop NOS'
		WHEN variant.""Item Status Purchase"" = 2  THEN 'Core'
		WHEN variant.""Item Status Purchase"" = 3  THEN 'Promotion'
	END AS item_status_purchase_description,
	CASE
		WHEN item.""Countries Blocked Filter"" = '' 	 THEN 'not blacklisted'
		WHEN item.""Countries Blocked Filter"" IS NULL THEN 'not blacklisted'
		ELSE item.""Countries Blocked Filter""
	END AS countries_blocked,
	
	/* UNITS, WEIGHT, SIZES */
	size.""Net Weight"" AS net_weight,
	size.""Gross Weight"" AS gross_weight,
	item.""Sales Unit of Measure"" AS unit_of_measure,
	
	/* COUNTRY, MANUFACTURER, AND SUPPLIER RELATED */
	CASE
		WHEN item.""Country_Region of Origin Code"" = '' THEN NULL
		ELSE item.""Country_Region of Origin Code""
	END AS country_region_of_origin,
	CASE
		WHEN item.""Tariff No_"" = '' THEN NULL
		ELSE item.""Tariff No_""
	END AS tariff_no,
	CASE
		WHEN tar.""No_ Switzerland"" = '' THEN NULL
		ELSE tar.""No_ Switzerland""
	END AS tariff_no_ch,
	
	/* SIZES, COLORS, BRANDS, THEMES, SEASONS */
	color.description AS color,
	CASE
		WHEN color.""External Description"" = '' THEN NULL
		ELSE color.""External Description""
	END AS supplier_color,
	size.description AS size,
	size.""Component Group Code"" AS size_component_group,
	CASE 
		WHEN color.""PFSeason"" = '' THEN NULL
		ELSE color.""PFSeason""
	END AS season,
	item.""pfbrand code"" AS brand_code,
	brand.description AS brand,
	/* imat.""Material Code"" AS material_code,
	mat.description AS material, */
/*	def.name, */

	/* pics */
	CASE
		WHEN pic.pic1 IS NOT NULL THEN 'pic'
	END AS has_picture,
	pic.pic1,
	pic.pic2,
	pic.pic3,
	pic.pic4,
	pic.pic5,
	pic.pic6,

	/* PRICING AND COST */
	COALESCE(cost.""Direct Unit Cost"",item.""Last Direct Cost"") AS unit_cost, /* costs already in euro */
	/* IN LOCAL CURRENCIES */
	MAX(CASE WHEN price.""Sales Code"" = 'BE' THEN price.""Unit Price"" END) AS unit_price_be,
	MAX(CASE WHEN price.""Sales Code"" = 'CH' THEN price.""Unit Price"" END) AS unit_price_ch,
	MAX(CASE WHEN price.""Sales Code"" = 'DE' THEN price.""Unit Price"" END) AS unit_price_de,
	MAX(CASE WHEN price.""Sales Code"" = 'DK' THEN price.""Unit Price"" END) AS unit_price_dk,
	MAX(CASE WHEN price.""Sales Code"" = 'FI' THEN price.""Unit Price"" END) AS unit_price_fi,
	MAX(CASE WHEN price.""Sales Code"" = 'GB' THEN price.""Unit Price"" END) AS unit_price_gb,
	MAX(CASE WHEN price.""Sales Code"" = 'LU' THEN price.""Unit Price"" END) AS unit_price_lu,
	MAX(CASE WHEN price.""Sales Code"" = 'NL' THEN price.""Unit Price"" END) AS unit_price_nl,
	MAX(CASE WHEN price.""Sales Code"" = 'PL' THEN price.""Unit Price"" END) AS unit_price_pl,
	MAX(CASE WHEN price.""Sales Code"" = 'SE' THEN price.""Unit Price"" END) AS unit_price_se


/* price_group.description AS price_group_description */

FROM 
	""nav_test.Outfittery GmbH$Item"" AS item
	LEFT JOIN
	""nav_test.Outfittery GmbH$Item Variant"" AS variant
		ON item.no_ = variant.""item no_""
	LEFT JOIN
	""nav_test.Outfittery GmbH$PFitem Vert Component"" AS color
		 ON variant.""pfvertical component"" 	= color.code
		AND variant.""item no_"" 				= color.""item no_""
	LEFT JOIN
	""nav_test.Outfittery GmbH$PFitem horz Component"" AS size
		 ON variant.""pfhorizontal component"" 	= size.code
		AND variant.""item no_"" 					= size.""item no_""
	LEFT JOIN
	""nav_test.Outfittery GmbH$Item Category"" AS cat
		ON item.""item category code"" = cat.""code""
	LEFT JOIN
	""nav_test.Outfittery GmbH$Product Group"" AS prod
		 ON item.""item category code"" = prod.""item category code""
		AND item.""product group code"" = prod.code
	LEFT JOIN
	""nav_test.Outfittery GmbH$PFBrand"" AS brand
		ON item.""pfbrand code"" = brand.code
	LEFT JOIN
	""nav_test.Outfittery GmbH$Item Unit of Measure"" AS unit
		 ON item.""base unit of measure"" = unit.code
		AND item.no_ 					= unit.""item no_""
	LEFT JOIN
	""nav_test.Outfittery GmbH$PFSeason"" AS season
		 ON item.""PFSeason"" = season.code
/*	LEFT JOIN
	""nav_test.Outfittery GmbH$PFDefinition"" AS def
		 ON item. = def.code */
	LEFT JOIN
	""nav_test.Outfittery GmbH$PFItem Status"" AS status
		 ON variant.""PFItem Status"" = status.code
	LEFT JOIN
	""nav_test.Outfittery GmbH$Sales Price"" AS price
		 ON variant.""item no_"" 	= price.""item no_""
		AND variant.code 		= price.""Variant Code""
		AND price.""Sales Type"" 	= 1
		/* AND price.""Currency Code"" = 'EUR'; this field won't be used */
		/* the date logic will need to be included once ERP dates are updated
		AND price.""Starting Date"" <= CURDATE()
		AND (price.""Ending Date"" >= CURDATE() OR price.""Ending Date"" = '')  */
	LEFT JOIN
	""nav_test.Outfittery GmbH$Purchase Price"" cost
		 ON variant.""item no_"" 		= cost.""item no_""
		AND variant.code 			= cost.""Variant Code""
		AND item.""Vendor No_"" 		= cost.""Vendor No_""
		AND cost.""Currency Code"" 	= ''  /*default is Euro*/
	LEFT JOIN
	(
		SELECT  
			""Source Primary Key 1"" AS item_no, 
			""Source Primary Key 2"" as color_code,
			MAX(CASE WHEN sorting = 1 THEN ""File Name"" END) AS pic1,
			MAX(CASE WHEN sorting = 2 THEN ""File Name"" END) AS pic2,
			MAX(CASE WHEN sorting = 3 THEN ""File Name"" END) AS pic3,
			MAX(CASE WHEN sorting = 4 THEN ""File Name"" END) AS pic4,
			MAX(CASE WHEN sorting = 5 THEN ""File Name"" END) AS pic5,
			MAX(CASE WHEN sorting = 6 THEN ""File Name"" END) AS pic6
		FROM 
			""nav_test.Outfittery GmbH$PFHyperlink""
		WHERE
		 	""Source Table No_"" = 11006110
		GROUP BY 1,2
	) AS pic
		 ON color.""item no_"" 	= pic.item_no
		AND color.code 			= pic.color_code
	LEFT JOIN
	""nav_test.Outfittery GmbH$Tariff Number"" AS tar
		 ON item.""Tariff No_"" = tar.""No_""
	/*
CAREFUL! ITEM MATERIALS CAUSES DUPLICATES UNLESS PUT INTO AN ARRAY
	LEFT JOIN
	""nav_test.Outfittery GmbH$Item Material"" imat
		 ON item.no_ = imat.""item no_""
	LEFT JOIN
	""nav_test.Outfittery GmbH$Material"" mat
		 ON imat.""material code"" = mat.code
	*/
	/*
	LEFT JOIN
	--item variant overwrite 
	""nav_test.Outfittery GmbH$Stockkeeping Unit"" AS iv
		 ON variant.""item no_"" 	= iv.""Item No_""
		AND variant.code 		= iv.""Variant Code""
	*/
GROUP BY
1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38
/* ORDER BY 1 */"	READY
65,545	2015-05-05 10:11:14	"1112787909"	true	2015-05-05 10:13:10	tableau.bisdev_order_data_flyer_ab_testing		"CREATE VIEW tableau.bisdev_order_data_flyer_ab_testing
AS

SELECT 
co.order_id, 
co.date_created, 
co.shipping_country, 
co.box_type,
CASE
	WHEN co.order_type = 'First Order' THEN 'First Order'
	WHEN co.order_type in ('Repeat Order', 'Outfittery Club Order') THEN 'Repeat Order'
	WHEN co.order_type in ('First Order Follow-on', 'Repeat Order Follow-on') THEN 'Follow-on'
	ELSE 'Ask BI'
END as order_type
from bi.customer_order co
where cast(co.date_created as date) > '2014-10-01'"	READY
65,546	2015-05-05 10:17:14	"1112787910"	true	2015-05-05 10:17:14	tableau.bisdev_growth_basket_size_analysis		"CREATE VIEW tableau.bisdev_growth_basket_size_analysis
AS

SELECT 
	order_id,
	cast(co.date_shipped as date) as date_shipped,
	co.campaign_id,
	co.campaign_title,
	co.campaign_type,
	co.customer_age,
	co.customer_date_of_birth,
	co.order_type,
	co.shipping_city,
	co.shipping_country,
	co.shipping_zip,
	case 
		when cast(co.date_created as date) >= '2011-09-01' and cast(co.date_created as date) < '2012-03-01' then '2011-S2'
		when cast(co.date_created as date) >= '2012-03-01' and cast(co.date_created as date) <= '2012-08-31' then '2012-S1'
		when cast(co.date_created as date) >= '2012-09-01' and cast(co.date_created as date) < '2013-03-01' then '2012-S2'
		when cast(co.date_created as date) >= '2013-03-01' and cast(co.date_created as date) <= '2013-08-31' then '2013-S1'
		when cast(co.date_created as date) >= '2013-09-01' and cast(co.date_created as date) < '2014-03-01' then '2013-S2'
		when cast(co.date_created as date) >= '2014-03-01' and cast(co.date_created as date) <= '2014-08-31' then '2014-S1'
		when cast(co.date_created as date) >= '2014-09-01' and cast(co.date_created as date) < '2015-03-01' then '2014-S2'
		else null
	end as ""OrderSeason"",
	sum(distinct case when op.state >= 16 and op.state < 2048 then op.purchase_price else null end) as basket_purchase_price,
	sum(distinct case when op.state = 512 then op.purchase_price else null end) as return_purchase_price,
	sum(distinct case when op.state = 1024 then op.purchase_price else null end) as kept_purchase_price,
	sum(distinct case when op.state >= 16 and op.state < 2048 then op.retail_price else null end) as basket_retail_price,
	sum(distinct case when op.state = 512 then op.retail_price else null end) as return_retail_price,
	sum(distinct case when op.state = 1024 then op.retail_price else null end) as kept_retail_price,
	count(distinct case when op.state >= 16 and op.state < 2048 then op.id else null end) as basket_count,
	count(distinct case when op.state = 512 then op.id else null end) as return_count,
	count(distinct case when op.state = 1024 then op.id else null end) as kept_count
FROM views.order_position op
LEFT JOIN views.customer_order co on co.id=op.order_id
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12"	READY
196,690	2015-06-18 17:54:07	"1179989974"	true	2015-08-13 09:23:21	raw.stylist_info		"CREATE VIEW raw.stylist_info
AS

SELECT
  p.id as stylist_id,
  p.enabled,
  p.callable,
  p.balancer_enabled,
  CASE WHEN TRIM(p.first_name) = 'OUTFITTERY' OR TRIM(p.last_name) = 'OUTFITTERY' OR p.id = 118566682 OR TRIM(p.first_name) = 'Stylingteam' THEN false ELSE true END as real_stylist,
  TRIM(p.first_name) as first_name,
  TRIM(p.last_name) as last_name,
  TRIM(p.first_name) || ' ' || TRIM(p.last_name) as stylist_original,
  a.stylist,
  a.team_lead,
  CASE 
    WHEN TRIM(p.first_name) = 'OUTFITTERY' OR TRIM(p.last_name) = 'OUTFITTERY' OR p.id = 118566682 OR TRIM(p.first_name) = 'Stylingteam' THEN 'Fake'
    ELSE a.role
  END as role,
  p.balance_strategy_resolver_string
FROM postgres.principal p
/*This information is from ldap connector which connects to task manager*/
LEFT JOIN
(
  SELECT
  a.*,
  CASE 
    WHEN b.lead_name IS NOT NULL THEN 'Lead'
    ELSE 'Stylist'
  END AS role
FROM
(
  SELECT 
    col1 AS stylist,
  SUBSTRING(col2,4,LOCATE(',',col2)-4)team_lead,
  col3 as email
  FROM 
  (
    exec ""ldap.native""
    (  
      ""request"" => 'search;context-name=cn=Users,dc=outfittery,dc=lan;filter=(objectClass=*);timeout=6;search-scope=ONELEVEL_SCOPE;attributes=cn,manager,mail,memberOf' 
    )
  ) AS r, 
  ARRAYTABLE(r.tuple COLUMNS col1 string, col2 string,col3 string,col4 string) x
)a 
LEFT JOIN
(
  SELECT
        SUBSTRING(col2,4,LOCATE(',',col2)-4) as lead_name
  FROM 
  (
    exec ""ldap.native""
    (  
      ""request"" => 'search;context-name=cn=Groups,dc=outfittery,dc=lan;filter=(objectClass=*);timeout=6;search-scope=ONELEVEL_SCOPE;attributes=cn,member' 
    )
  ) AS r, 
  ARRAYTABLE(r.tuple COLUMNS col1 string, col2 string) x
  WHERE col1 LIKE '%stylist team%'
)b ON a.stylist=b.lead_name
)a on a.email=p.email
WHERE p.class='com.ps.stylelist.Stylelist'
AND p.salesforce_id IS NOT NULL"	READY
65,548	2015-05-05 11:04:26	"1112787912"	true	2015-05-05 11:04:26	tableau.mkt_rt_customer_cluster_order_processed		"CREATE VIEW tableau.mkt_rt_customer_cluster_order_processed
AS

SELECT
	a.date_created,
	a.country as shipping_country,
	b.stock_created_anzahl_order,
	b.new_orders,
	b.real_repeat_orders,
	b.club_orders,
	cac.costs
FROM
/*Marketing Construct*/
(
	SELECT 
		distinct country,
		cast(datecreated as date) date_created
	FROM views.marketingconstruct
	WHERE datecreated > '2014' AND datecreated <  TIMESTAMPADD(SQL_TSI_DAY,7,CURDATE())
) a
/*Order Processed*/
LEFT JOIN
(
	SELECT 
		CAST(CASE 
			WHEN co.invoice_date_created is not null THEN co.invoice_date_created
			WHEN co.state >=128 AND co.state <=1024 AND co.date_shipped is not null THEN co.date_shipped
			WHEN co.state >=128 AND co.state <=1024 THEN co.date_created
		END as date) as date_created,
		co.shipping_country,
		count(distinct co.id) as stock_created_anzahl_order,
		count(distinct case when co.order_type='first order' then co.id else null end) as new_orders,
		count(distinct case when co.order_type='real repeat order' and co.sales_channel not in ('clubWithCall','clubWithoutCall') then co.id else null end) as real_repeat_orders,
		count(distinct case when co.order_type='real repeat order' and co.sales_channel in ('clubWithCall','clubWithoutCall') then co.id else null end) as club_orders
	FROM views.customer_order co
	WHERE co.state > 8 
	AND co.state <= 1024 
	AND co.order_state='Real Order'
	GROUP BY 1,2
) b on b.date_created=a.date_created AND a.country=b.shipping_country
/*Marketing Costs*/
LEFT JOIN
(
	SELECT 
		datecreated, 
		country, 
		sum(case when lower(currency)= 'chf' then (costs*0.8) else costs end) as costs 
	FROM views.marketingcosts 
	WHERE datecreated<=timestampadd(SQL_TSI_DAY,-1,curdate())
	GROUP BY 1,2
) cac on cac.datecreated=a.date_created AND cac.country=a.country"	READY
65,559	2015-05-05 18:00:10	"1112787919"	true	2015-05-05 18:02:43	forecast.state_p6		"CREATE VIEW forecast.state_p6 AS
SELECT DISTINCT
	xx.customer_id,
    'P6' AS state
FROM
(SELECT
	cofo.customer_id,
	ac.count
FROM forecast.customer__first_order AS cofo
LEFT JOIN
(SELECT
	co.customer_id,
	count(*) AS count
FROM bi.customer_order AS co
WHERE co.order_type IN ('Repeat Order', 'Outfittery Club Order')
  AND NOT (TIMESTAMPADD(SQL_TSI_MONTH, -6, TIMESTAMPCREATE('2015-01-01', '00:00:00')) <= co.date_shipped
  AND co.date_shipped < TIMESTAMPCREATE('2015-01-01', '00:00:00'))
GROUP BY co.customer_id) AS ac
    ON ac.customer_id = cofo.customer_id
WHERE TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-01-01', '00:00:00')) >= 6
  AND ac.count IS NULL) AS xx
LEFT JOIN
(SELECT
    co2.customer_id
FROM bi.customer_order AS co2
WHERE co2.order_type IN ('Repeat Order', 'Outfittery Club Order')
  AND TIMESTAMPADD(SQL_TSI_MONTH, -12, TIMESTAMPCREATE('2015-01-01', '00:00:00')) <= co2.date_shipped
  AND co2.date_shipped < TIMESTAMPCREATE('2015-01-01', '00:00:00')) AS p
	ON p.customer_id = xx.customer_id
WHERE p.customer_id IS NOT NULL"	READY
65,560	2015-05-05 18:00:51	"1112787920"	true	2015-05-05 18:00:51	forecast.state_p12		"CREATE VIEW forecast.state_p12 AS
SELECT
	xx.customer_id,
    'P12' AS state
FROM
(SELECT
	cofo.customer_id,
	ac.count
FROM forecast.customer__first_order AS cofo
LEFT JOIN
(SELECT
	co.customer_id,
	count(*) AS count
FROM bi.customer_order AS co
WHERE co.order_type IN ('Repeat Order', 'Outfittery Club Order')
  AND NOT (TIMESTAMPADD(SQL_TSI_MONTH, -6, TIMESTAMPCREATE('2015-01-01', '00:00:00')) <= co.date_shipped
  AND co.date_shipped < TIMESTAMPCREATE('2015-01-01', '00:00:00'))
GROUP BY co.customer_id) AS ac
    ON ac.customer_id = cofo.customer_id
WHERE TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-01-01', '00:00:00')) >= 6
  AND ac.count IS NULL) AS xx
LEFT JOIN
(SELECT
    co2.customer_id
FROM bi.customer_order AS co2
WHERE co2.order_type IN ('Repeat Order', 'Outfittery Club Order')
  AND TIMESTAMPADD(SQL_TSI_MONTH, -12, TIMESTAMPCREATE('2015-01-01', '00:00:00')) <= co2.date_shipped
  AND co2.date_shipped < TIMESTAMPCREATE('2015-01-01', '00:00:00')) AS p
	ON p.customer_id = xx.customer_id
WHERE p.customer_id IS NULL"	READY
413	2015-04-24 18:25:30	"661538662"	true	2015-04-29 18:33:14	am.variant_pre_2		"CREATE VIEW ""am.variant_pre_2"" AS
SELECT
smcbs.""Size Group Code"" AS ""size_group_code_smcbs"",
smcbs.""size_code"" AS ""size_erp_smcbs"",
smcs.""Size Group Code"" AS ""size_group_code_smcs"",
smcs.""size_code"" AS ""size_erp_smcs"",
smcsl.""Size Group Code"" AS ""size_group_code_smcsl"",
smcsl.""size_code"" AS ""size_erp_smcsl"",
v.*
FROM ""am.variant_pre_1"" v
LEFT JOIN ""am.size_mapping_new_with_code__indexed_cg4_brand_size"" smcbs
ON smcbs.commodity_group4 = v.commodity_group4 
AND smcbs.brand = v.brand_pim
AND smcbs.eu_size = v.eu_size_normed
LEFT JOIN ""am.size_mapping_new_with_code__indexed_cg4_size"" smcs
ON smcs.commodity_group4 = v.commodity_group4
AND smcs.eu_size = v.eu_size_normed
LEFT JOIN ""am.size_mapping_new_with_code__indexed_cg4_sizelength"" smcsl
ON smcsl.commodity_group4 = v.commodity_group4
AND smcsl.eu_size_x_length = v.eu_size_x_length_normed"	READY
425,995	2015-08-04 16:29:03	"1112787022"	true	2015-08-04 16:29:03	raw.camunda_activiy_history		"CREATE view raw.camunda_activiy_history
AS

SELECT 
  row_number() over(partition by execution_id_ order by start_time_ desc) as rank,
  execution_id_ as execution_id,
  act_name_ as activiti_name,
  act_type_ as activiti_type,
  start_time_ as start_time,
  end_time_ as end_time,
  duration_ as duration
FROM camunda.act_hi_actinst"	READY
425,996	2015-08-04 16:30:14	"1112787045"	true	2015-08-04 16:30:14	raw.camunda_history_task		"CREATE VIEW raw.camunda_history_task
AS

SELECT
  a.execution_id,
  MIN(CASE WHEN a.activiti_name='CalculateDates' THEN a.start_time ELSE NULL END)as calculate_dates,
  MIN(CASE WHEN a.activiti_name='CallNow' THEN a.start_time ELSE NULL END)as call_now,
  MIN(CASE WHEN a.activiti_name='Checkout'THEN a.start_time ELSE NULL END)as check_out,
  MIN(CASE WHEN a.activiti_name='CustomerAnsweredPreviewEmailMessage'THEN a.start_time ELSE NULL END)as customer_answered_preview_email,
  MIN(CASE WHEN a.activiti_name='EnableOrderCheckout' THEN a.start_time ELSE NULL END)as enable_order_checkout,
  MIN(CASE WHEN a.activiti_name='IncomingCall' THEN a.start_time ELSE NULL END)as incoming_call,
  MIN(CASE WHEN a.activiti_name='NotReachDecision' THEN a.start_time ELSE NULL END)as not_reach_decision,
  MIN(CASE WHEN a.activiti_name='OrderProcessedMessage' THEN a.start_time ELSE NULL END)as order_processed_message,
  MIN(CASE WHEN a.activiti_name='Parallel Gateway' THEN a.start_time ELSE NULL END)as parallel_gateway,
  MIN(CASE WHEN a.activiti_name='Place order and await the call date' THEN a.start_time ELSE NULL END)as place_order_and_await_the_call_date,
  MIN(CASE WHEN a.activiti_name='PlaceOrder' THEN a.start_time ELSE NULL END)as place_order,
  MIN(CASE WHEN a.activiti_name='PlaceOrderConfirmationEvent' THEN a.start_time ELSE NULL END)as place_order_confirmation_event,
  MIN(CASE WHEN a.activiti_name='RescheduleWorkOnOrder' THEN a.start_time ELSE NULL END)as reschedule_work_on_order,
  MIN(CASE WHEN a.activiti_name='SendAnotherPreview' THEN a.start_time ELSE NULL END)as send_another_preview,
  MIN(CASE WHEN a.activiti_name='SendConfirmEmail' THEN a.start_time ELSE NULL END)as send_confirme_mail,
  MIN(CASE WHEN a.activiti_name='SendPreview' THEN a.start_time ELSE NULL END)as send_preview,
  MIN(CASE WHEN a.activiti_name='SendPreviewEmail' THEN a.start_time ELSE NULL END)as send_preview_email,
  MIN(CASE WHEN a.activiti_name='SendReminderEmail' THEN a.start_time ELSE NULL END)as send_reminder_email,
  MIN(CASE WHEN a.activiti_name='SendStylistCalendarEmail' THEN a.start_time ELSE NULL END)as send_stylist_calendar_email,
  MIN(CASE WHEN a.activiti_name='SendWrongNumberEmail' THEN a.start_time ELSE NULL END)as send_wrongnumber_email,
  MIN(CASE WHEN a.activiti_name='WhichAction' THEN a.start_time ELSE NULL END)as which_action,
  MIN(CASE WHEN a.activiti_name='WhichDate' THEN a.start_time ELSE NULL END)as which_date,
  MIN(CASE WHEN a.activiti_name='WorkOnOrder' THEN a.start_time ELSE NULL END)as work_on_order,
  MIN(CASE WHEN a.activiti_name='WorkOnPreview' THEN a.start_time ELSE NULL END)as work_on_preview
FROM raw.camunda_activiy_history a
GROUP BY 1"	READY
212	2015-04-24 18:19:19	"1112787718"	true	2015-04-24 18:19:19	ml.action_tracking		"create VIEW ml.action_tracking 
AS
SELECT
    a.id AS action_tracking_id,
    a.order_id,
    a.stylist_id,
    a.article_id,
    a.ml_response_id,
    op.order_position_id,
    a.date,
    a.action
FROM ( SELECT
           id,
           order_id,
           stylist_id,
           date_created ""date"",
           action,
           CASE WHEN origin = 'ARTICLE_ID' THEN CAST(foreign_id AS INTEGER) ELSE NULL END AS article_id,
           CASE WHEN action = 'SEARCH' THEN foreign_id ELSE at.ml_response_id END AS ml_response_id
       FROM ""postgres.action_tracking"" at ) a
LEFT JOIN ""raw.customer_order_articles"" op ON op.order_id = a.order_id AND op.article_id = a.article_id"	READY
65,563	2015-05-06 10:27:30	"1112787922"	true	2015-05-12 17:53:44	tableau.bisdev_geschenk		"CREATE VIEW tableau.bisdev_geschenk
AS

select

	co.order_id,
	co.customer_id,
	co.date_created,
	co.date_shipped,
	co.payment_type,
	co.shipping_country,
	co.shipping_city,
	co.billing_total,
	co.follow_on_count,
	co.real_order_count,
	co.sales_channel,
	co.order_state_number,
	co.preview_id,
	co.sales_sent as total_amount_basket_retail_gross,
	co.billing_total as total_amount_billed_retail_gross,
	CASE
		WHEN co.order_type = 'First Order' THEN 'First Order'
		WHEN co.order_type in ('Repeat Order', 'Outfittery Club Order') THEN 'Repeat Order'
		WHEN co.order_type in ('First Order Follow-on', 'Repeat Order Follow-on') THEN 'Follow-on'
	END as order_type,
	timestampdiff(SQL_TSI_DAY,co.date_shipped,co.date_returned) as days_shipped_returned,
	co.arvato_score as arvatoscore,
	co.box_type,
	sty.stylist,

	cu.customer_age,
	cast(f.first_order_date as date) as first_order_date,
	cu.club_membership_type,
	
	sfo.arvato_status,
	sfo.newcardrecommendation,
	sfa.customer_status,
	sfa.bmi,

	op.articles_sent,
	op.articles_kept,
	op.articles_returned,
	op.sales_sent,
	op.sales_kept,
	op.sales_returned,
	op.geschenk_box,
	op.geschenk_box_2009876543503,
	op.geschenk_box_2009876636489,
	op.geschenk_box_2009876543527,
	op.geschenk_box_2009876543534,
	op.geschenk_box_2009876543510,
	op.geschenk_box_2009876543497,
	op.geschenk_retourniert,

	md.marketing_channel,

	a.article_brand,
	a.article_commodity_group1,
	a.article_commodity_group2,
	a.article_commodity_group3,
	a.article_commodity_group4,
	a.article_commodity_group5,
	a.article_sales_price_de as price_retail_de,
	a.article_cost as purchase_price

FROM bi.customer_order_articles o
LEFT JOIN bi.customer_order co ON o.order_id=co.order_id
LEFT join bi.customer cu on cu.customer_id = co.customer_id
LEFT JOIN bi.article a on a.article_id=o.article_id
LEFT JOIN bi.customer_order_salesforce sfo on sfo.order_id = co.order_id
LEFT JOIN raw.customer_salesforce sfa on sfa.customer_id = co.customer_id
left join bi.stylist sty on sty.stylist_id=co.stylist_id
LEFT JOIN views.arvatoresults arv on co.order_id=arv.order_id
left join views.marketing_order md on md.order_id = co.order_id
JOIN(
	SELECT 
		coa.order_id,
		SUM(coa.articles_sent) AS articles_sent,
		SUM(coa.articles_kept) AS articles_kept,
		SUM(coa.articles_returned) AS articles_returned,
		SUM(coa.sales_sent) AS sales_sent,
		SUM(coa.sales_kept) AS sales_kept,
		SUM(coa.sales_returned) AS sales_returned,
		             		            		/*Geschenk Articles*/
		count(case when  art.article_ean in ('2009876543503','2009876543510') and coa.order_article_state_number < 2048 then '1' else Null end) as geschenk_box,
		count(case when  art.article_ean ='2009876543503' and coa.order_article_state_number < 2048 then 1 else Null end) as geschenk_box_2009876543503,
		count(case when  art.article_ean ='2009876636489' and coa.order_article_state_number < 2048 then 1 else Null end) as geschenk_box_2009876636489,
		count(case when  art.article_ean ='2009876543527' and coa.order_article_state_number < 2048 then 1 else Null end) as geschenk_box_2009876543527,
		count(case when  art.article_ean ='2009876543534' and coa.order_article_state_number < 2048 then 1 else Null end) as geschenk_box_2009876543534,   
		count(case when  art.article_ean ='2009876543510' and coa.order_article_state_number < 2048 then 1 else Null end) as geschenk_box_2009876543510,
		count(case when  art.article_ean ='2009876543497' and coa.order_article_state_number < 2048 then 1 else Null end) as geschenk_box_2009876543497,
		count(case when  art.article_ean in ('2009876543503','2009876543510','2009876543527','2009876636489','2009876543534','2009876543497') and coa.order_article_state_number = 512 
		then 1 else Null end) as geschenk_retourniert
	FROM bi.customer_order_articles coa
	LEFT JOIN bi.article art on art.article_id=coa.article_id
	GROUP BY 1
)op ON op.order_id=co.order_id
LEFT JOIN 
(
	SELECT 
		co.customer_id,
		min(co.date_created) as first_order_date,
		min(CASE WHEN co.order_state = 'Completed' THEN co.date_created ELSE null END) as first_order_date_completed
	FROM bi.customer_order co 
	GROUP BY 1
) f on f.customer_id = co.customer_id
WHERE co.order_state_number<>2048 
AND CAST(co.date_shipped as date) >= '2014-08-27'"	READY
65,571	2015-05-08 10:24:20	"1112787924"	true	2015-05-08 10:24:20	tableau.mgmt_sandbox_all_calls		"CREATE VIEW tableau.mgmt_sandbox_all_calls
AS

SELECT
	c.customer_id, 
	c.phone_number,
	n.date_called,
	n.waiting_time,
	CAST(CASE WHEN n.call_duration > 90 THEN n.call_duration ELSE null END as float)/60 as call_duration,
	n.disconnected_by,
	n.call_handled_by,
	n.call_queue,
	CASE WHEN n.call_duration > 90 THEN 1 ELSE 0 END as reached
FROM bi.customer c 
JOIN dwh.nfone_data n on n.phone_number = c.phone_number
WHERE n.date_called > '2015'
AND c.phone_number is not null"	READY
65,572	2015-05-08 10:25:33	"1112787925"	true	2015-05-08 10:25:33	tableau.mgmt_sandbox_call_tracking		"CREATE VIEW tableau.mgmt_sandbox_call_tracking
AS

SELECT
	s.stylist_id,
	s.stylist_original as stylist,
	s.team,
	CAST(pd.date_phone_call as DATE) as date_phone_call,
	COUNT(DISTINCT pd.date_phone_call) as all_booked_calls,
	COUNT(DISTINCT CASE WHEN CAST(pd.date_created as DATE) = CAST(pd.date_phone_call as DATE) THEN pd.date_phone_call ELSE null END) as same_day_booked_calls,
	CASE WHEN COUNT(DISTINCT pd.date_phone_call) > 12 THEN COUNT(DISTINCT pd.date_phone_call) ELSE 12 END as maximum_calls,
	COUNT(DISTINCT co.order_id) as distinct_orders
FROM bi.customer_order_phone_dates pd
JOIN bi.customer_order co on co.order_id = pd.order_id
JOIN raw.stylist s on s.stylist_id = co.stylist_id
WHERE pd.date_phone_call > '2014'
AND pd.date_phone_call < TIMESTAMPADD(SQL_TSI_DAY, 14, CURDATE())
AND pd.date_phone_call > pd.date_created
AND (NOT pd.date_invalidated < pd.date_phone_call OR pd.date_invalidated is null)
AND s.real_stylist = true
AND s.role = 'Stylist'
GROUP BY 1,2,3,4
HAVING COUNT(DISTINCT pd.date_phone_call) > 6 
OR (COUNT(DISTINCT pd.date_phone_call) > 4 AND CAST(MAX(pd.date_phone_call) as date) = CURDATE())
OR CAST(MAX(pd.date_phone_call) as date) > CURDATE()"	READY
65,573	2015-05-08 10:29:47	"1112787926"	true	2015-05-08 10:29:47	tableau.mgmt_sandbox_calls_per_order		"CREATE VIEW tableau.mgmt_sandbox_calls_per_order
AS

SELECT 
	cso.order_id,
	c.phone_number,
	co.date_phone_call,
	cso.not_reached,
	cso.new_phone_appointment,
	cso.wrong_phone_number,
	n.call_queue,
	MAX(CASE WHEN n.call_duration > 90 THEN 1 ELSE 0 END) as reached,
	COUNT(n.phone_number) as num_tries,
	SUM(CASE WHEN n.call_duration > 90 THEN 1 ELSE 0 END) as num_succesful_tries,
	MAX(CASE WHEN n.call_duration > 90 THEN n.call_duration ELSE null END)/60 as max_call_duration,
	MAX(CASE WHEN n.phone_number is not null THEN 1 ELSE 0 END) as matching_nfone_data
FROM bi.customer_order co 
JOIN bi.customer c on c.customer_id = co.customer_id
JOIN raw.customer_order_salesforce cso on CAST(co.order_id as string) = cso.order_id
LEFT JOIN dwh.nfone_data n on n.phone_number = c.phone_number
WHERE co.order_type = 'First Order'
AND c.phone_number is not null
AND c.phone_number like '+%'
AND co.date_phone_call is not null
AND co.date_phone_call > '2015'
GROUP BY 1,2,3,4,5,6,7"	READY
425,997	2015-08-04 16:31:04	"1112787049"	true	2015-08-04 16:31:04	raw.camunda_activity_variable		"CREATE view raw.camunda_activity_variable 
AS

SELECT 
	cast(execution_id_ as long) as execution_id,
	MAX(CASE WHEN name_='orderId' THEN cast(long_ as string) END) AS order_id,
	MAX(CASE WHEN name_='customerId' THEN cast(long_ as string) END) AS customer_id,
	MAX(CASE WHEN name_='stylistId' THEN cast(long_ as string) END) AS stylist_id,
	MAX(CASE WHEN name_='assigneeId' THEN cast(long_ as string) END) AS assignee_id,
	MAX(CASE WHEN name_='customerType' THEN cast(text_ as string) END) AS customer_type,
	MAX(CASE WHEN name_='orderType' THEN cast(text_ as string) END) AS order_type,
	MAX(CASE WHEN name_='confirmSemaforDate' THEN FROM_UNIXTIME(cast(left(long_,10) as integer)) END) AS confirm_date,
	MAX(CASE WHEN name_='reminderSemaforDate' THEN FROM_UNIXTIME(cast(left(long_,10) as integer)) END) AS reminder_date,
	MAX(CASE WHEN name_='callNowSemaforDate' THEN FROM_UNIXTIME(cast(left(long_,10) as integer)) END) AS call_now,
	MAX(CASE WHEN name_='phoneDate' THEN FROM_UNIXTIME(cast(left(long_,10) as integer)) END) AS phone_date,
	MAX(CASE WHEN name_='callNowExpiredDate' THEN FROM_UNIXTIME(cast(left(long_,10) as integer)) END) AS call_now_expired_date,
	MAX(CASE WHEN name_='rescheduleWorkOnOrderDate' THEN FROM_UNIXTIME(cast(left(long_,10) as integer)) END) AS reschedule_workon_order_date,
	MAX(CASE WHEN name_='callCounter' THEN cast(double_ as string) END) AS call_counter,
	MAX(CASE WHEN name_='callAnswered' THEN cast(long_ as string) END) AS call_answered,
	MAX(CASE WHEN name_='emailType' THEN cast(text_ as string) END) AS email_type,
	MAX(CASE WHEN name_='assignee' THEN cast(text_ as string) END) AS assignee,
	MAX(CASE WHEN name_='assigneeBackup' THEN cast(text_ as string) END) AS assignee_backup,
	MAX(CASE WHEN name_='stylistsChoice' THEN cast(text_ as string) END) AS stylists_choice,
	MAX(CASE WHEN name_='notReachedAction' THEN cast(text_ as string) END) AS not_reached_action,
	MAX(CASE WHEN name_='stylist' THEN cast(text_ as string) END) AS stylist,
	MAX(CASE WHEN name_='taskManagerConfirmation' THEN cast(text_ as string) END) AS task_manager_confirmation,
	MAX(CASE WHEN name_='customerAction' THEN cast(text_ as string) END) AS customer_action,
	MAX(CASE WHEN name_='reassignmentType' THEN cast(text_ as string) END) AS reassignment_type,
	MAX(CASE WHEN name_='taskManagerType' THEN cast(text_ as string) END) AS task_manager_type,
	MAX(CASE WHEN name_='taskManagerMessages' THEN cast(text_ as string) END) AS task_manager_messages
FROM
	camunda.act_hi_varinst
GROUP BY 1"	READY
131,078	2015-05-14 21:55:25	"1112787929"	true	2015-05-14 21:55:25	views.return_comments		"create view views.return_comments
as
/*Return Comments for Articles*/
select
original_orderid,
outfittery_article_number,
comment,
max(date_created) as ""max_date_created"",
min(date_created) as ""min_date_created""
from postgres.doc_data_return
where comment<>''
group by 1,2,3"	READY
191	2015-04-24 18:18:53	"1112787701"	true	2015-04-24 18:18:53	ml.project_return_time		"CREATE VIEW ml.project_return_time AS
SELECT
co.order_id,
c.customer_id,
co.date_created,
co.date_shipped_internal,
co.date_completed,
co.date_returned,
c.customer_age
FROM
raw.customer_order co
JOIN
raw.customer c
ON co.customer_id = c.customer_id
WHERE
co.state IN ('Completed')
AND
co.date_created > '2014-01-01'
AND
co.shipping_country = 'DE'
AND
co.payment_method = 'Invoice'
AND
co.order_type = 'First Order'
AND
co.date_returned IS NOT NULL
AND 
date_shipped_internal < date_completed
AND
co.date_shipped_internal != co.date_created"	FAILED
424	2015-04-24 18:27:08	"770345509"	true	2015-05-20 15:56:05	am.variant_pre_4		"CREATE VIEW ""am.variant_pre_4"" AS
SELECT
v.*,
colormap.color_code_erp ""color_code_erp""
FROM ""am.variant_pre_3"" v
LEFT JOIN ""am.color_mapping_new"" colormap ON colormap.color1 = v.color1"	READY
131,080	2015-05-15 16:32:26	"1112787930"	true	2015-05-15 16:32:26	tableau.mkt_topic_box_performance		"CREATE VIEW tableau.mkt_topic_box_performance
AS
SELECT 
	co.customer_id,
	co.order_id,
	CAST(co.date_incoming as date) as date_incoming,
	co.preview_id,
	pr.preview_name,
	pr.preview_type,
	co.order_state,
	co.shipping_country,
	co.order_type,
	co.box_type,
	co.sales_sent,
	co.articles_sent,
	co.sales_kept,
	co.articles_kept,
	co.billing_total,
	CASE WHEN co.date_invoiced is not null THEN 1 ELSE 0 END as order_invoiced,
	CASE WHEN bc.device_category is not null THEN bc.device_category
	ELSE 'Unknown'
	END AS device_category
FROM bi.customer_order co
LEFT JOIN raw.previews pr ON pr.preview_id = co.preview_id 
LEFT JOIN 
(
	SELECT
		DISTINCT 
		transaction_id,
		device_category
	FROM
	(
		SELECT 
			date_created,
			transaction_id,
			dense_rank() OVER (PARTITION BY transaction_id ORDER BY date_created ASC) as contact_count_asc,
			device_category
		FROM ""dwh.ga_information_device""
	) ab 
	WHERE ab.contact_count_asc = 1
) bc on bc.transaction_id = co.order_id
WHERE co.preview_id is not null
AND is_real_order = 'Real Order'
AND date_incoming is not null"	READY
425	2015-04-24 18:27:08	"638185425"	true	2015-04-24 18:27:08	am.bad_variant		"CREATE VIEW am.bad_variant AS
SELECT *
FROM
( SELECT pim_size_variation_id,
COUNT(*) ""count""
FROM ""am.variant_pre_4"" vr
GROUP BY vr.pim_size_variation_id ) x
WHERE x.count > 1"	READY
15	2015-04-24 18:17:13	"638185608"	true	2015-04-24 18:17:13	datavirtualitytest.managementkpis		"CREATE VIEW datavirtualitytest.managementkpis AS
SELECT stock.date_created, stock.stock_entry_quantity, stock.stock_entry_reserved, shipped.stock_shipped_anzahl_order, shipped.stock_anzahl_shipped_order_position_id, shipped.stock_sum_shipped_retail_price, shipped.stock_sum_shipped_purchase_price, shipped.own_stock_anzahl_shipped_order_position_id, shipped.own_stock_shipped_anzahl_order, shipped.own_stock_sum_shipped_retail_price, shipped.own_stock_sum_shipped_purchase_price, shipped.z_stock_shipped_anzahl_order, shipped.z_stock_anzahl_shipped_order_position_id, shipped.z_stock_sum_shipped_retail_price, shipped.z_stock_sum_shipped_purchase_price, shipped.chf_stock_shipped_anzahl_order, shipped.chf_stock_anzahl_shipped_order_position_id, shipped.chf_stock_sum_shipped_retail_price, shipped.chf_stock_sum_shipped_purchase_price, returned.stock_returned_anzahl_order, returned.stock_anzahl_returned_order_position_id, returned.stock_sum_returned_retail_price, returned.stock_sum_returned_purchase_price, returned.own_stock_returned_anzahl_order, returned.own_stock_anzahl_returned_order_position_id, returned.own_stock_sum_returned_retail_price, returned.own_stock_sum_returned_purchase_price, returned.z_stock_returned_anzahl_order, returned.z_stock_anzahl_returned_order_position_id, returned.z_stock_sum_returned_retail_price, returned.z_stock_sum_returned_purchase_price, returned.chf_stock_returned_anzahl_order, returned.chf_stock_anzahl_returned_order_position_id, returned.chf_stock_sum_returned_retail_price, returned.chf_stock_sum_returned_purchase_price, picked.stock_picked_anzahl_order, picked.stock_anzahl_picked_order_position_id, picked.stock_sum_picked_retail_price, picked.stock_sum_picked_purchase_price, picked.own_stock_picked_anzahl_order, picked.own_stock_anzahl_picked_order_position_id, picked.own_stock_sum_picked_retail_price, picked.own_stock_sum_picked_purchase_price, picked.z_stock_picked_anzahl_order, picked.z_stock_anzahl_picked_order_position_id, picked.z_stock_sum_picked_retail_price, picked.z_stock_sum_picked_purchase_price, picked.chf_stock_picked_anzahl_order, picked.chf_stock_anzahl_picked_order_position_id, picked.chf_stock_sum_picked_retail_price, picked.chf_stock_sum_picked_purchase_price, created.own_stock_created_anzahl_order, created.own_stock_anzahl_created_order_position_id, created.own_stock_sum_created_retail_price, created.own_stock_sum_created_purchase_price, created.z_stock_created_anzahl_order, created.z_stock_anzahl_created_order_position_id, created.z_stock_sum_created_retail_price, created.z_stock_sum_created_purchase_price, created.chf_stock_created_anzahl_order, created.chf_stock_anzahl_created_order_position_id, created.chf_stock_sum_created_retail_price, created.chf_stock_sum_created_purchase_price, created.stock_created_anzahl_order, created.stock_anzahl_created_order_position_id, created.stock_sum_created_retail_price, created.stock_sum_created_purchase_price, inv.stock_entry_quantity_retail_price_sum, inv.stock_entry_reserved_retail_price_sum, shippingmails.nb_shipping_mails, retourmails.nb_retouren_mails, datedeliverd.quantity_good, datedeliverd.quantity_good_min_retail_price_sum, datedeliverd.quantity_good_max_retail_price_sum FROM ((((((((SELECT cast(timestampadd(SQL_TSI_DAY, -1, han.stock_entry_history.date_created) AS date) AS date_created, SUM(quantity) AS stock_entry_quantity, SUM(reserved) AS stock_entry_reserved FROM han.stock_entry_history GROUP BY 1) AS stock LEFT OUTER JOIN (SELECT cast(op.date_shipped AS date) AS date_shipped, COUNT(DISTINCT op.order_id) AS stock_shipped_anzahl_order, COUNT(DISTINCT op.id) AS stock_anzahl_shipped_order_position_id, SUM((op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END)) AS stock_sum_shipped_retail_price, SUM((op.quantity * purchase_price)) AS stock_sum_shipped_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 2 THEN op.order_id END) AS own_stock_shipped_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 2 THEN op.id END) AS own_stock_anzahl_shipped_order_position_id, SUM(CASE WHEN stock_location_id = 2 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS own_stock_sum_shipped_retail_price, SUM(CASE WHEN stock_location_id = 2 THEN (op.quantity * purchase_price) END) AS own_stock_sum_shipped_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 1 THEN op.order_id END) AS z_stock_shipped_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 1 THEN op.id END) AS z_stock_anzahl_shipped_order_position_id, SUM(CASE WHEN stock_location_id = 1 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS z_stock_sum_shipped_retail_price, SUM(CASE WHEN stock_location_id = 1 THEN (op.quantity * purchase_price) END) AS z_stock_sum_shipped_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 3 THEN op.order_id END) AS chf_stock_shipped_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 3 THEN op.id END) AS chf_stock_anzahl_shipped_order_position_id, SUM(CASE WHEN stock_location_id = 3 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS chf_stock_sum_shipped_retail_price, SUM(CASE WHEN stock_location_id = 3 THEN (op.quantity * purchase_price) END) AS chf_stock_sum_shipped_purchase_price FROM postgres.order_position AS op INNER JOIN postgres.customer_order AS co ON co.id = op.order_id WHERE (op.state >= '128') AND (op.state <= '1024') AND (op.date_shipped IS NOT NULL) GROUP BY 1) AS shipped ON date_shipped = stock.date_created) LEFT OUTER JOIN (SELECT cast(op.date_returned AS date) AS date_returned, COUNT(DISTINCT op.order_id) AS stock_returned_anzahl_order, COUNT(DISTINCT op.id) AS stock_anzahl_returned_order_position_id, SUM((op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END)) AS stock_sum_returned_retail_price, SUM((op.quantity * purchase_price)) AS stock_sum_returned_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 2 THEN op.order_id END) AS own_stock_returned_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 2 THEN op.id END) AS own_stock_anzahl_returned_order_position_id, SUM(CASE WHEN stock_location_id = 2 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS own_stock_sum_returned_retail_price, SUM(CASE WHEN stock_location_id = 2 THEN (op.quantity * purchase_price) END) AS own_stock_sum_returned_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 1 THEN op.order_id END) AS z_stock_returned_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 1 THEN op.id END) AS z_stock_anzahl_returned_order_position_id, SUM(CASE WHEN stock_location_id = 1 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS z_stock_sum_returned_retail_price, SUM(CASE WHEN stock_location_id = 1 THEN (op.quantity * purchase_price) END) AS z_stock_sum_returned_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 3 THEN op.order_id END) AS chf_stock_returned_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 3 THEN op.id END) AS chf_stock_anzahl_returned_order_position_id, SUM(CASE WHEN stock_location_id = 3 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS chf_stock_sum_returned_retail_price, SUM(CASE WHEN stock_location_id = 3 THEN (op.quantity * purchase_price) END) AS chf_stock_sum_returned_purchase_price FROM postgres.order_position AS op INNER JOIN postgres.customer_order AS co ON co.id = op.order_id WHERE (op.state >= '128') AND (op.state <= '1024') AND (op.date_returned IS NOT NULL) GROUP BY 1) AS returned ON returned.date_returned = stock.date_created) LEFT OUTER JOIN (SELECT cast(co.date_picked AS date) AS date_created, COUNT(DISTINCT co.id) AS stock_created_anzahl_order, COUNT(DISTINCT op.id) AS stock_anzahl_created_order_position_id, SUM((op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END)) AS stock_sum_created_retail_price, SUM((op.quantity * purchase_price)) AS stock_sum_created_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 2 THEN co.id END) AS own_stock_created_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 2 THEN op.id END) AS own_stock_anzahl_created_order_position_id, SUM(CASE WHEN stock_location_id = 2 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS own_stock_sum_created_retail_price, SUM(CASE WHEN stock_location_id = 2 THEN (op.quantity * purchase_price) END) AS own_stock_sum_created_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 1 THEN co.id END) AS z_stock_created_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 1 THEN op.id END) AS z_stock_anzahl_created_order_position_id, SUM(CASE WHEN stock_location_id = 1 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS z_stock_sum_created_retail_price, SUM(CASE WHEN stock_location_id = 1 THEN (op.quantity * purchase_price) END) AS z_stock_sum_created_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 3 THEN co.id END) AS chf_stock_created_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 3 THEN op.id END) AS chf_stock_anzahl_created_order_position_id, SUM(CASE WHEN stock_location_id = 3 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS chf_stock_sum_created_retail_price, SUM(CASE WHEN stock_location_id = 3 THEN (op.quantity * purchase_price) END) AS chf_stock_sum_created_purchase_price FROM postgres.order_position AS op INNER JOIN postgres.customer_order AS co ON co.id = op.order_id WHERE (op.state <> '2048') AND (op.state <> '8') AND (op.date_created IS NOT NULL) GROUP BY 1) AS created ON created.date_created = stock.date_created) LEFT OUTER JOIN (SELECT cast(co.date_picked AS date) AS date_picked, COUNT(DISTINCT op.order_id) AS stock_picked_anzahl_order, COUNT(DISTINCT op.id) AS stock_anzahl_picked_order_position_id, SUM((op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END)) AS stock_sum_picked_retail_price, SUM((op.quantity * purchase_price)) AS stock_sum_picked_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 2 THEN op.order_id END) AS own_stock_picked_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 2 THEN op.id END) AS own_stock_anzahl_picked_order_position_id, SUM(CASE WHEN stock_location_id = 2 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS own_stock_sum_picked_retail_price, SUM(CASE WHEN stock_location_id = 2 THEN (op.quantity * purchase_price) END) AS own_stock_sum_picked_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 1 THEN op.order_id END) AS z_stock_picked_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 1 THEN op.id END) AS z_stock_anzahl_picked_order_position_id, SUM(CASE WHEN stock_location_id = 1 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS z_stock_sum_picked_retail_price, SUM(CASE WHEN stock_location_id = 1 THEN (op.quantity * purchase_price) END) AS z_stock_sum_picked_purchase_price, COUNT(DISTINCT CASE WHEN stock_location_id = 3 THEN op.order_id END) AS chf_stock_picked_anzahl_order, COUNT(DISTINCT CASE WHEN stock_location_id = 3 THEN op.id END) AS chf_stock_anzahl_picked_order_position_id, SUM(CASE WHEN stock_location_id = 3 THEN (op.quantity * CASE WHEN currency_code = 'CHF' THEN (retail_price * 0.8) WHEN currency_code IN ('SEK', 'DKK') THEN (retail_price * 0.1) ELSE retail_price END) END) AS chf_stock_sum_picked_retail_price, SUM(CASE WHEN stock_location_id = 3 THEN (op.quantity * purchase_price) END) AS chf_stock_sum_picked_purchase_price FROM postgres.order_position AS op INNER JOIN postgres.customer_order AS co ON co.id = op.order_id WHERE (op.state >= '128') AND (op.state <= '1024') AND (op.date_picked IS NOT NULL) GROUP BY 1) AS picked ON picked.date_picked = stock.date_created) LEFT OUTER JOIN (SELECT cast(received_date_time AS date) AS retoure_recieved_date, COUNT(DISTINCT supplierorderid) AS nb_retouren_mails FROM han.allretouremails GROUP BY 1) AS retourmails ON retourmails.retoure_recieved_date = stock.date_created) LEFT OUTER JOIN (SELECT cast(date_created AS date) AS date_delivered, SUM(cast(quantity_good AS integer)) AS quantity_good, SUM((cast(quantity_good AS integer) * min_price)) AS quantity_good_min_retail_price_sum, SUM((cast(quantity_good AS integer) * max_price)) AS quantity_good_max_retail_price_sum FROM postgres.doc_data_stock_mutation LEFT OUTER JOIN (SELECT article_id, MIN(price) AS min_price, MAX(price) AS max_price FROM postgres.article_price WHERE supplier_id = 15 GROUP BY 1) AS ap ON ap.article_id = postgres.doc_data_stock_mutation.customer_article_number WHERE (booking_code = 1) AND (po_number IN (SELECT cast(id AS string) FROM postgres.purchase_order WHERE stock_location_id = 2)) GROUP BY cast(date_created AS date)) AS datedeliverd ON datedeliverd.date_delivered = stock.date_created) LEFT OUTER JOIN (SELECT cast(timestampadd(SQL_TSI_DAY, -1, han.stock_entry_history.date_created) AS date) AS date_created, SUM((han.stock_entry_history.quantity * cast(ad.price_retail_de AS bigdecimal))) AS stock_entry_quantity_retail_price_sum, SUM((han.stock_entry_history.reserved * cast(ad.price_retail_de AS bigdecimal))) AS stock_entry_reserved_retail_price_sum FROM han.stock_entry_history LEFT OUTER JOIN (SELECT ads.id, ads.price_retail_de, sas.article_id FROM postgres.article_details AS ads LEFT OUTER JOIN postgres.supplier_article AS sas ON sas.id = ads.id WHERE ads.id IN (SELECT sa.id FROM postgres.supplier_article AS sa WHERE supplier_id = 15)) AS ad ON han.stock_entry_history.sku = ad.article_id GROUP BY 1) AS inv ON inv.date_created = stock.date_created) LEFT OUTER JOIN (SELECT cast(recieveddate AS date) AS recieveddate, COUNT(DISTINCT orderid) AS nb_shipping_mails FROM han.dhlpackagestatus GROUP BY 1) AS shippingmails ON shippingmails.recieveddate = stock.date_created"	FAILED
64	2015-04-24 18:17:43	"638185610"	true	2015-04-24 18:17:43	ga.goal_conversion		"CREATE view ga.goal_conversion
AS 
SELECT  
 g1.date_created,
 g1.country,
 g1.medium,
 g1.source,
 g1.devicecategory,
 g1.goal_1 as ""lead_conversion"", 
 g1.goal_2 as ""re_preview_favourite"", 
 g1.goal_3 as ""order_conversion"", 
 g1.goal_4 as ""phone_order_sucesses"", 
 g1.goal_5 as ""re_survey"", 
 g1.goal_6 as ""re_accountcreation1"", 
 g1.goal_7 as ""re_accountcreation2"", 
 g1.goal_8 as ""backend_overview"", 
 g1.goal_9 as ""backend_payment"", 
 g1.goal_10 as ""re_successnc_date"", 
 g2.goal_11 as ""re_successscreenfitprnocdacoh"", 
 g2.goal_12 as ""showroom_open"", 
 g2.goal_13 as ""re_sizes"", 
 g2.goal_14 as ""re_ordercreation"", 
 g2.goal_15 as ""re_pickcalldate"", 
 g2.goal_16 as ""re_successscreen_all"", 
 g2.goal_17 as ""re_profilecreation"", 
 g2.goal_18 as ""createprofile"", 
 g2.goal_19 as ""re_successnc"", 
 g2.goal_20 as ""re_successec"" 
FROM ""dwh.ga_goals_1"" g1
LEFT JOIN ""dwh.ga_goals_2"" g2 on g1.date_created=g2.date_created and g1.country=g2.country and g1.medium=g2.medium and g1.source=g2.source and g1.devicecategory=g2.devicecategory"	FAILED
149	2015-04-24 18:17:58	"656779411"	true	2015-04-28 17:58:20	am.bad_base		"CREATE VIEW am.bad_base AS
SELECT * FROM (
SELECT ""b.pim_model_id"",
COUNT(*) AS ""count"" FROM am.base_pre b
GROUP BY ""pim_model_id"" ) x
WHERE x.count > 1"	READY
229,446	2015-06-25 10:29:22	"1283793280"	true	2015-09-08 16:08:33	raw.desk_label_list		"CREATE VIEW raw.desk_label_list
AS

SELECT 
	ss.id as label_id, 
	ss.""name"" as label_name, 
	ss.description as label_description, 
	ss.color as label_color
from
(
	call ""desk_com_connector.get_list_labels"" ()
) ss
where types='case'"	READY
131,085	2015-05-18 13:23:29	"1112787933"	true	2015-07-31 09:45:55	tableau.mgmt_cm2_cohort_analysis		"CREATE VIEW tableau.mgmt_cm2_cohort_analysis
AS

SELECT
  con.order_id,
  con.customer_id,
  con.order_state,
  con.revenue_state,
  con.payment_state,
  con.shipping_country,
  con.order_type,
  con.sales_sent,
  con.sales_kept,
  con.discount_total,
  con.billing_total,
  con.billing_net_sales,
  con.sales_kept * cogs.percentage_cost cost_kept_calc,
  con.cost_kept,
  co.first_box_type,
  co.first_saleschannel_completed,
  mc.first_channel as first_marketing_channel,
  c.first_order_date_completed as date_created_first_order,
  cu.customer_age,
  con.date_invoiced,
  con.date_shipped,
  con.date_created,
  con.order_state_number,
  TIMESTAMPDIFF(SQL_TSI_DAY, c.first_order_date_completed, con.date_created)/30 as months_since_first_order
FROM bi.customer_order con
JOIN views.customer c on c.customer_id = con.customer_id
JOIN views.customer_order co on co.id = con.order_id
LEFT JOIN views.marketing_customer mc on mc.customer_id = co.customer_id
LEFT JOIN bi.customer cu on cu.customer_id = co.customer_id
JOIN /* Take COGs % from last 31 days. We will apply this to all orders, so that we are not biased against old cohorts due to high partner stock usage */
(
  SELECT
  shipping_country,
  sum(cost_kept)/sum(sales_kept) as percentage_cost
  FROM bi.customer_order co
  WHERE co.date_invoiced > TIMESTAMPADD(SQL_TSI_DAY, -31, CURDATE())
  GROUP BY 1
) cogs on cogs.shipping_country = co.shipping_country
WHERE con.order_state_number >= 128 
AND con.order_state_number < 2048
AND con.is_real_order = 'Real Order'

/* This UNION SELECT adds in dummy data so that we can draw nice cohorts charts for old cohorts that have very sparse data */
UNION SELECT
  null as order_id,
  null as customer_id,
  'Completed' as order_state,
  'Final' as revenue_state,
  null as payment_state,
  shipping_country,
  null as order_type,
  null as sales_sent,
  null as sales_kept,
  null as discount_total,
  null as billing_total,
  null as billing_net_sales,
  null as cost_kept_calc,
  null as cost_kept,
  first_box_type,
  null as first_saleschannel_completed,
  first_marketing_channel,
  fo.date as date_created_first_order,
  null as customer_age,
  null as date_invoiced,
  null as date_shipped,
  o.date as date_created,
  null as order_state_number,
  TIMESTAMPDIFF(SQL_TSI_DAY, fo.date, curdate())/30 as months_since_first_order
FROM dwh.calendar fo
JOIN dwh.calendar o on o.date > fo.date AND o.date < curdate()
CROSS JOIN (SELECT 'Call Box' as first_box_type UNION SELECT 'No Call Box' as first_box_type) x
CROSS JOIN (SELECT distinct shipping_country FROM bi.customer_order) y
CROSS JOIN (SELECT distinct first_channel as first_marketing_channel FROM views.marketing_customer) z
WHERE fo.date > '2012-02' and fo.date < curdate()
AND fo.day_of_month = 1
AND o.day_of_month = 1"	READY
131,110	2015-05-21 17:05:30	"1112787939"	true	2015-06-11 11:08:15	raw.ami_article_item_variant		"CREATE VIEW raw.ami_article_item_variant AS

SELECT 
	* 
FROM 
	postgres.article_item_variant
OPTION $NOOPT"	READY
236	2015-04-24 18:19:27	"1112787729"	true	2015-04-27 16:33:43	tableau.ops_no_shipment		"CREATE VIEW tableau.ops_no_shipment
AS

SELECT
  dt.order_id,
  dt.tracking_number,
  dt.slug,
  origin_country_iso3,
  col.return_track_and_trace_number,
  CASE 
  	WHEN dt.tracking_number=col.return_track_and_trace_number THEN 'Return Link'
  	ELSE 'Tracking Link'
  END as link_type,
  dt.tag,
  col.date_shipped,
  col.date_returned,
  CASE 
    WHEN origin_country_iso3 in ('DEU','BEL') then dt1.info_recieved_date
    WHEN origin_country_iso3 in ('CHE','AUT') then dt1.intransit_date
    ELSE dt1.init_created
  END AS start_date,
  dt1.info_recieved_date,
  dt1.intransit_date,
  dt1.outfordelivery_date,
  dt1.attemptfail_date,
  dt1.exception_date,
  dt1.expired_date,
  dt1.delivered_date
FROM
(
  SELECT * 
  FROM bi.delivery_tracking 
  WHERE rank=1
)dt
LEFT JOIN bi.customer_order_logistics col on col.order_id=dt.order_id and (col.track_and_trace_number=dt.tracking_number or col.return_track_and_trace_number=dt.tracking_number)
LEFT JOIN
(
  SELECT
  order_id,
  tracking_number,
    COUNT(order_id) AS nb_of_lines,
    COUNT(CASE WHEN tag='AttemptFail' THEN order_id ELSE NULL END) AS nb_of_attemptfails,
    COUNT(CASE WHEN tag='Exception' THEN order_id ELSE NULL END) AS nb_of_exceptions,
    MAX(CASE WHEN tag='Init' THEN created_at ELSE NULL END) AS init_created,
    MAX(CASE WHEN tag='InfoReceived' THEN updated_at ELSE NULL END) AS info_recieved_date,
    MAX(CASE WHEN tag='InTransit' THEN updated_at ELSE NULL END) AS intransit_date,
    MAX(CASE WHEN tag='OutForDelivery' THEN updated_at ELSE NULL END) AS outfordelivery_date,
    MAX(CASE WHEN tag='AttemptFail' THEN updated_at ELSE NULL END) AS attemptfail_date,
    MAX(CASE WHEN tag='Exception' THEN updated_at ELSE NULL END) AS exception_date,
    MAX(CASE WHEN tag='Expired' THEN updated_at ELSE NULL END) AS expired_date,
    MAX(CASE WHEN tag='Delivered' THEN updated_at ELSE NULL END) AS delivered_date
  FROM bi.delivery_tracking
  GROUP BY 1,2
)dt1 on dt.order_id=dt1.order_id and dt.tracking_number=dt1.tracking_number"	READY
261	2015-04-24 18:19:38	"1112787749"	true	2015-05-12 11:25:18	tableau.stylist_overview_dashboard_customers		"CREATE VIEW tableau.stylist_overview_dashboard_customers
AS
SELECT
c.customer_id,
c.first_name || ' ' || c.last_name as customer_name,
c.stylist_id,
CASE 
  WHEN s.role = 'Fake' AND s.stylist_id != 118566682 THEN 'Fake Stylist ' || s.team
  ELSE s.first_name || ' ' || s.last_name 
END as stylist_name,
s.team as stylist_team,
s.role as stylist_role,
c.club_member,
c.club_membership_type,
c.preferred_contact_channel,
c.age_group,
c.customer_status,
c.gender
FROM bi.customer c
JOIN bi.stylist s on s.stylist_id = c.stylist_id
WHERE c.user_type = 'Real User'
AND s.enabled"	READY
271	2015-04-24 18:19:49	"638185621"	true	2015-04-24 18:19:49	ml.project_compl_articles		"CREATE VIEW ml.project_compl_articles AS
SELECT
	ai.article_id,
    ai.model AS model_id,
    ai.molor,
    ai.brand_amidala,
    cat.flat_category
FROM ml.article_info AS ai
JOIN ml.article_category_new AS cat
    ON ai.article_id = cat.article_id"	FAILED
131,091	2015-05-19 14:20:23	"1112787934"	true	2015-07-19 13:37:52	tableau.data_source_own_stock		"CREATE VIEW tableau.data_source_own_stock AS

/* 	This is the 3rd iteration to replace tableau.data_source_own_stock2; it's intended to provide base measures and article info;
	final, post-kpi unification calculations (%'s) happen in the tableau data source 
*/

SELECT 
	own.*,
	
	item.item_no,
	item.variant_code,
	item.supplier_article_id,
	/* LIMIT 100 */
	item.parent_no,
	item.ean,
	item.vendor_item_no,
	item.item_description,
	item.category,
	item.product_group,
	item.item_status,
	CASE
		WHEN item.countries_blocked IS NULL THEN 'not blacklisted'
		ELSE item.countries_blocked
	END AS countries_blocked,
	item.item_status_purchase,
	item.item_status_purchase_description,
	item.net_weight,
	item.gross_weight,
	item.unit_of_measure,
	item.country_region_of_origin,
	item.tariff_no,
	item.tariff_no_ch,
	item.color,
	item.supplier_color,
	item.size,
	/* item.size_component_group, */
	item.season,
	item.brand,
	item.has_picture,
	item.pic1,
	/* item.pic2,
	item.pic3,
	item.pic4,
	item.pic5,
	item.pic6, */
	item.unit_cost,
	item.unit_price_be,
	item.unit_price_ch,
	item.unit_price_de,
	item.unit_price_dk,
	/*
	item.unit_price_fi,
	item.unit_price_gb, */
	item.unit_price_lu,
	item.unit_price_nl,
	/*item.unit_price_pl, */
	item.unit_price_se,
	item.pool,
	item.buyer,
	/* the following are actually at the item_no level, not the article_id level */
	book.date_po_received_min,
	book.date_po_received_max,
	CAST(TIMESTAMPDIFF(SQL_TSI_DAY,book.date_po_received_min,CURDATE()) AS SMALLINT) AS days_since_first_received_into_inventory,
	CAST(TIMESTAMPDIFF(SQL_TSI_DAY,book.date_po_received_min, book.date_po_received_max) AS SMALLINT) AS days_in_inventory
FROM 
	bi.own_stock AS own
	LEFT JOIN
	bi.item
		 ON own.article_id = item.article_id
	LEFT JOIN
	bi.po_received_dates AS book
		ON own.article_id = book.article_id

/* LIMIT 100 */"	READY
131,094	2015-05-20 10:12:21	"1112787935"	true	2015-05-20 10:12:21	tableau.buying_sandbox_articles_photo		"CREATE VIEW tableau.buying_sandbox_articles_photo
AS

SELECT
	poa.purchase_order_id,
	poa.date_poa_delivery_earliest as earliest_delivery_date,
	poa.date_poa_delivery_latest as latest_delivery_date,
	poa.stock_ordered_initially as quantity,
	poa.stock_fulfilled as fullfilled_quantity,
	po.po_season as season,
	art.article_o_parent_id as o_parentId,
	art.article_pic1 as pic1,
	sm.dd_quantity_good
FROM
raw.purchase_order_articles poa
JOIN raw.purchase_order po on po.purchase_order_id=poa.purchase_order_id
LEFT JOIN bi.article art on art.article_id=poa.article_id
LEFT JOIN
(
	SELECT 
		sb.purchase_order_id,
		sb.article_id, 
		sum(sb.stock_booked) dd_quantity_good
	FROM raw.stock_booked sb
	JOIN raw.purchase_order po on po.purchase_order_id=sb.purchase_order_id
	WHERE sb.stock_booking_code=1
	GROUP BY 1,2
)sm on po.purchase_order_id=poa.purchase_order_id AND sm.article_id=poa.article_id"	READY
196,608	2015-05-22 16:21:01	"1112787940"	true	2015-06-10 15:06:27	bi.own_stock		"CREATE VIEW bi.own_stock AS

/* This query brings together data from multiple tables and sources. It presents a daily article level breakdown of sales (sent/kept/returned), inventory, POs, virtual stock, etc.
Once new KPIs are finalized, confirm that AVG fields, as well as MIN/MAX, are needed */


SELECT
	COALESCE(stock.article_id, bookings.article_id, coa.article_id) AS article_id,
	COALESCE(stock.date_created, bookings.stock_booking_date, coa.date_shipped)  AS date_created,

	/*  inventory at t0 AND t1 FROM stock_entry history + stock_entry current stock*/
	stock.stock_beg,
	stock.stock_end,
	stock.reserved_beg,
	stock.reserved_end,

	/*Stock movements FROM stock_mutation */
	bookings.po_bookings,
	bookings.po_article_sales_price,
	bookings.po_article_cost,
	bookings.supplier_returns,	

	/*Deliveries AND returns FROM purchase_order ow only*/
	poa.poa_initial_qty,
	poa.poa_intial_qty_sales,
	poa.poa_intial_qty_cost,
	poa.poa_revised_qty,
	poa.poa_revised_qty_sales,
	poa.poa_revised_qty_cost,
	poa.poa_booked_qty,
	poa.poa_booked_qty_sales,
	poa.poa_booked_qty_cost,
	poa.poa_article_sales_price_min,
	poa.poa_article_sales_price_max,
	poa.poa_article_sales_price_avg,
	poa.poa_article_cost_min,
	poa.poa_article_cost_max,
	poa.poa_article_cost_avg,
	
	/* Customer Order Articles Sales */
	coa.articles_sent,
	coa.articles_sent_at,
	coa.articles_sent_be,
	coa.articles_sent_ch,
	coa.articles_sent_de,
	coa.articles_sent_dk,
	coa.articles_sent_lu,
	coa.articles_sent_nl,
	coa.articles_sent_se,
	
	coa.sales_sent,
	coa.sales_sent_avg,
	coa.sales_sent_at,
	coa.sales_sent_be,
	coa.sales_sent_ch,
	coa.sales_sent_de,
	coa.sales_sent_dk,
	coa.sales_sent_lu,
	coa.sales_sent_nl,
	coa.sales_sent_se,
	
	coa.cost_sent,
	coa.cost_sent_avg,
	coa.cost_sent_at,
	coa.cost_sent_be,
	coa.cost_sent_ch,
	coa.cost_sent_de,
	coa.cost_sent_dk,
	coa.cost_sent_lu,
	coa.cost_sent_nl,
	coa.cost_sent_se,
	
	coa.articles_kept,
	coa.articles_kept_at,
	coa.articles_kept_be,
	coa.articles_kept_ch,
	coa.articles_kept_de,
	coa.articles_kept_dk,
	coa.articles_kept_lu,
	coa.articles_kept_nl,
	coa.articles_kept_se,
	
	coa.sales_kept,
	coa.sales_kept_avg,
	coa.sales_kept_at,
	coa.sales_kept_be,
	coa.sales_kept_ch,
	coa.sales_kept_de,
	coa.sales_kept_dk,
	coa.sales_kept_lu,
	coa.sales_kept_nl,
	coa.sales_kept_se,
	
	coa.cost_kept,
	coa.cost_kept_avg,
	coa.cost_kept_at,
	coa.cost_kept_be,
	coa.cost_kept_ch,
	coa.cost_kept_de,
	coa.cost_kept_dk,
	coa.cost_kept_lu,
	coa.cost_kept_nl,
	coa.cost_kept_se,
	
	coa.articles_returned,
	coa.articles_returned_at,
	coa.articles_returned_be,
	coa.articles_returned_ch,
	coa.articles_returned_de,
	coa.articles_returned_dk,
	coa.articles_returned_lu,
	coa.articles_returned_nl,
	coa.articles_returned_se,
	
	coa.sales_returned,
	coa.sales_returned_avg,
	coa.sales_returned_at,
	coa.sales_returned_be,
	coa.sales_returned_ch,
	coa.sales_returned_de,
	coa.sales_returned_dk,
	coa.sales_returned_lu,
	coa.sales_returned_nl,
	coa.sales_returned_se,
	
	coa.cost_returned,
	coa.cost_returned_avg,
	coa.cost_returned_at,
	coa.cost_returned_be,
	coa.cost_returned_ch,
	coa.cost_returned_de,
	coa.cost_returned_dk,
	coa.cost_returned_lu,
	coa.cost_returned_nl,
	coa.cost_returned_se,
	
	coa.articles_lost,
	coa.cost_lost,
	coa.sales_lost,
	
	coa.virtual_stock_articles_sent,
	coa.virtual_stock_cost_sent,
	coa.virtual_stock_sales_sent,
	coa.virtual_stock_cost_sent_avg,
	coa.virtual_stock_sales_sent_avg	

FROM 
	
	bi.stock_levels_history AS stock

	/*Backlog FROM purchase - always agg. yesterday*/
	LEFT JOIN
	(	 
		SELECT /* for all data; no date filter */
			TIMESTAMPADD(SQL_TSI_DAY, -1, CURDATE()) AS date_created,
			poa.article_id AS article_id,
			CAST(SUM(poa.stock_booked) AS INTEGER) AS poa_booked_qty,
			CAST(SUM(poa.stock_ordered_revised) AS INTEGER) AS poa_revised_qty,
			CAST(SUM(poa.stock_ordered_initially) AS INTEGER) AS poa_initial_qty,
			MIN(poa.article_sales_price) AS poa_article_sales_price_min,
			MAX(poa.article_sales_price) AS poa_article_sales_price_max,
			MIN(poa.article_cost) AS poa_article_cost_min,
			MAX(poa.article_cost) AS poa_article_cost_max,
			ROUND(AVG(poa.article_sales_price),2) AS poa_article_sales_price_avg,
			ROUND(AVG(poa.article_cost),2) AS poa_article_cost_avg,
			ROUND(SUM(poa.stock_ordered_initially*poa.article_sales_price),2) AS poa_intial_qty_sales,
			ROUND(SUM(poa.stock_ordered_initially*poa.article_cost),2) AS poa_intial_qty_cost,
			ROUND(SUM(poa.stock_ordered_revised*poa.article_sales_price),2) AS poa_revised_qty_sales,
			ROUND(SUM(poa.stock_ordered_revised*poa.article_cost),2) AS poa_revised_qty_cost,
			ROUND(SUM(poa.stock_booked*poa.article_sales_price),2) AS poa_booked_qty_sales,
			ROUND(SUM(poa.stock_booked*poa.article_cost),2) AS poa_booked_qty_cost
		FROM 
			bi.purchase_order_articles poa
			JOIN 
			bi.purchase_order po 
				ON poa.purchase_order_id = po.purchase_order_id 
		WHERE
			po.stock_location_id=2
		AND	poa.driving_tbl_poa IS NOT NULL
		GROUP BY 1,2
	) AS poa
		 ON stock.date_created 	= poa.date_created
		AND stock.article_id 	= poa.article_id

	/* stock movements */
	FULL JOIN
	(
		SELECT
			sb.article_id,
			sb.stock_booking_date,
			ROUND(AVG(poa.article_sales_price),2) AS po_article_sales_price,
			ROUND(AVG(poa.article_cost),2) AS po_article_cost,
			CAST(SUM(sb.po_bookings) AS SMALLINT) AS po_bookings,
		    CAST(SUM(sb.supplier_returns) AS SMALLINT) AS supplier_returns
		FROM 
			bi.stock_booked AS sb
			LEFT JOIN
			bi.purchase_order AS po
				 ON sb.purchase_order_id  = po.purchase_order_id
				AND po.stock_location_id != 2
			LEFT JOIN
			/* bringing in poa to get the cost/sales price at the time of the po */
			bi.purchase_order_articles AS poa
				 ON sb.purchase_order_id 	= poa.purchase_order_id
				AND sb.article_id 			= poa.article_id
				and poa.driving_tbl_poa IS NOT NULL /* to address full outer join on poa table */
		WHERE
			sb.stock_booking_processing_state_number = 2
		AND COALESCE(sb.po_bookings,0) + COALESCE(sb.supplier_returns,0) > 0 /* to eliminate rows with no data */
		AND po.purchase_order_id IS NULL  /* to eliminate POs with a stock location other than 2, own stock */
		GROUP BY 1,2
	) AS bookings 
		  ON stock.article_id	= bookings.article_id
		 AND stock.date_created	= bookings.stock_booking_date

	/* customer order articles info */
	FULL JOIN
	(
		SELECT
			CAST(coa.date_shipped AS DATE) AS date_shipped,
			coa.article_id,
			
			/* SENT */
			CAST(SUM(coa.articles_sent) AS SMALLINT) AS articles_sent,
			CAST(SUM(CASE WHEN co.shipping_country = 'AT' THEN coa.articles_sent END) AS SMALLINT) AS articles_sent_at,
			CAST(SUM(CASE WHEN co.shipping_country = 'BE' THEN coa.articles_sent END) AS SMALLINT) AS articles_sent_be,
			CAST(SUM(CASE WHEN co.shipping_country = 'CH' THEN coa.articles_sent END) AS SMALLINT) AS articles_sent_ch,
			CAST(SUM(CASE WHEN co.shipping_country = 'DE' THEN coa.articles_sent END) AS SMALLINT) AS articles_sent_de,
			CAST(SUM(CASE WHEN co.shipping_country = 'DK' THEN coa.articles_sent END) AS SMALLINT) AS articles_sent_dk,
			CAST(SUM(CASE WHEN co.shipping_country = 'LU' THEN coa.articles_sent END) AS SMALLINT) AS articles_sent_lu,
			CAST(SUM(CASE WHEN co.shipping_country = 'NL' THEN coa.articles_sent END) AS SMALLINT) AS articles_sent_nl,
			CAST(SUM(CASE WHEN co.shipping_country = 'SE' THEN coa.articles_sent END) AS SMALLINT) AS articles_sent_se,
		
			ROUND(SUM(coa.sales_sent),2) AS sales_sent,
			ROUND(AVG(coa.sales_sent),2) AS sales_sent_avg,
			ROUND(SUM(CASE WHEN co.shipping_country = 'AT' THEN coa.sales_sent END),2) AS sales_sent_at,
			ROUND(SUM(CASE WHEN co.shipping_country = 'BE' THEN coa.sales_sent END),2) AS sales_sent_be,
			ROUND(SUM(CASE WHEN co.shipping_country = 'CH' THEN coa.sales_sent END),2) AS sales_sent_ch,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DE' THEN coa.sales_sent END),2) AS sales_sent_de,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DK' THEN coa.sales_sent END),2) AS sales_sent_dk,
			ROUND(SUM(CASE WHEN co.shipping_country = 'LU' THEN coa.sales_sent END),2) AS sales_sent_lu,
			ROUND(SUM(CASE WHEN co.shipping_country = 'NL' THEN coa.sales_sent END),2) AS sales_sent_nl,
			ROUND(SUM(CASE WHEN co.shipping_country = 'SE' THEN coa.sales_sent END),2) AS sales_sent_se,
		
			ROUND(SUM(CAST(coa.cost_sent AS DECIMAL)),2) AS cost_sent,
			ROUND(AVG(CAST(coa.cost_sent AS DECIMAL)),2) AS cost_sent_avg,
			ROUND(SUM(CASE WHEN co.shipping_country = 'AT' THEN CAST(coa.cost_sent AS DECIMAL) END),2) AS cost_sent_at,
			ROUND(SUM(CASE WHEN co.shipping_country = 'BE' THEN CAST(coa.cost_sent AS DECIMAL) END),2) AS cost_sent_be,
			ROUND(SUM(CASE WHEN co.shipping_country = 'CH' THEN CAST(coa.cost_sent AS DECIMAL) END),2) AS cost_sent_ch,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DE' THEN CAST(coa.cost_sent AS DECIMAL) END),2) AS cost_sent_de,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DK' THEN CAST(coa.cost_sent AS DECIMAL) END),2) AS cost_sent_dk,
			ROUND(SUM(CASE WHEN co.shipping_country = 'LU' THEN CAST(coa.cost_sent AS DECIMAL) END),2) AS cost_sent_lu,
			ROUND(SUM(CASE WHEN co.shipping_country = 'NL' THEN CAST(coa.cost_sent AS DECIMAL) END),2) AS cost_sent_nl,
			ROUND(SUM(CASE WHEN co.shipping_country = 'SE' THEN CAST(coa.cost_sent AS DECIMAL) END),2) AS cost_sent_se,
		
		
			/* KEPT */
			CAST(SUM(coa.articles_kept) AS SMALLINT) AS articles_kept,
			CAST(SUM(CASE WHEN co.shipping_country = 'AT' THEN coa.articles_kept END) AS SMALLINT) AS articles_kept_at,
			CAST(SUM(CASE WHEN co.shipping_country = 'BE' THEN coa.articles_kept END) AS SMALLINT) AS articles_kept_be,
			CAST(SUM(CASE WHEN co.shipping_country = 'CH' THEN coa.articles_kept END) AS SMALLINT) AS articles_kept_ch,
			CAST(SUM(CASE WHEN co.shipping_country = 'DE' THEN coa.articles_kept END) AS SMALLINT) AS articles_kept_de,
			CAST(SUM(CASE WHEN co.shipping_country = 'DK' THEN coa.articles_kept END) AS SMALLINT) AS articles_kept_dk,
			CAST(SUM(CASE WHEN co.shipping_country = 'LU' THEN coa.articles_kept END) AS SMALLINT) AS articles_kept_lu,
			CAST(SUM(CASE WHEN co.shipping_country = 'NL' THEN coa.articles_kept END) AS SMALLINT) AS articles_kept_nl,
			CAST(SUM(CASE WHEN co.shipping_country = 'SE' THEN coa.articles_kept END) AS SMALLINT) AS articles_kept_se,
		
			ROUND(SUM(coa.sales_kept),2) AS sales_kept,
			ROUND(AVG(coa.sales_kept),2) AS sales_kept_avg,
			ROUND(SUM(CASE WHEN co.shipping_country = 'AT' THEN coa.sales_kept END),2) AS sales_kept_at,
			ROUND(SUM(CASE WHEN co.shipping_country = 'BE' THEN coa.sales_kept END),2) AS sales_kept_be,
			ROUND(SUM(CASE WHEN co.shipping_country = 'CH' THEN coa.sales_kept END),2) AS sales_kept_ch,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DE' THEN coa.sales_kept END),2) AS sales_kept_de,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DK' THEN coa.sales_kept END),2) AS sales_kept_dk,
			ROUND(SUM(CASE WHEN co.shipping_country = 'LU' THEN coa.sales_kept END),2) AS sales_kept_lu,
			ROUND(SUM(CASE WHEN co.shipping_country = 'NL' THEN coa.sales_kept END),2) AS sales_kept_nl,
			ROUND(SUM(CASE WHEN co.shipping_country = 'SE' THEN coa.sales_kept END),2) AS sales_kept_se,
		
			ROUND(SUM(CAST(coa.cost_kept AS DECIMAL)),2) AS cost_kept,
			ROUND(AVG(CAST(coa.cost_kept AS DECIMAL)),2) AS cost_kept_avg,
			ROUND(SUM(CASE WHEN co.shipping_country = 'AT' THEN CAST(coa.cost_kept AS DECIMAL) END),2) AS cost_kept_at,
			ROUND(SUM(CASE WHEN co.shipping_country = 'BE' THEN CAST(coa.cost_kept AS DECIMAL) END),2) AS cost_kept_be,
			ROUND(SUM(CASE WHEN co.shipping_country = 'CH' THEN CAST(coa.cost_kept AS DECIMAL) END),2) AS cost_kept_ch,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DE' THEN CAST(coa.cost_kept AS DECIMAL) END),2) AS cost_kept_de,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DK' THEN CAST(coa.cost_kept AS DECIMAL) END),2) AS cost_kept_dk,
			ROUND(SUM(CASE WHEN co.shipping_country = 'LU' THEN CAST(coa.cost_kept AS DECIMAL) END),2) AS cost_kept_lu,
			ROUND(SUM(CASE WHEN co.shipping_country = 'NL' THEN CAST(coa.cost_kept AS DECIMAL) END),2) AS cost_kept_nl,
			ROUND(SUM(CASE WHEN co.shipping_country = 'SE' THEN CAST(coa.cost_kept AS DECIMAL) END),2) AS cost_kept_se,
		
			
			/* RETURNED */
			CAST(SUM(coa.articles_returned) AS SMALLINT) AS articles_returned,
			CAST(SUM(CASE WHEN co.shipping_country = 'AT' THEN coa.articles_returned END) AS SMALLINT) AS articles_returned_at,
			CAST(SUM(CASE WHEN co.shipping_country = 'BE' THEN coa.articles_returned END) AS SMALLINT) AS articles_returned_be,
			CAST(SUM(CASE WHEN co.shipping_country = 'CH' THEN coa.articles_returned END) AS SMALLINT) AS articles_returned_ch,
			CAST(SUM(CASE WHEN co.shipping_country = 'DE' THEN coa.articles_returned END) AS SMALLINT) AS articles_returned_de,
			CAST(SUM(CASE WHEN co.shipping_country = 'DK' THEN coa.articles_returned END) AS SMALLINT) AS articles_returned_dk,
			CAST(SUM(CASE WHEN co.shipping_country = 'LU' THEN coa.articles_returned END) AS SMALLINT) AS articles_returned_lu,
			CAST(SUM(CASE WHEN co.shipping_country = 'NL' THEN coa.articles_returned END) AS SMALLINT) AS articles_returned_nl,
			CAST(SUM(CASE WHEN co.shipping_country = 'SE' THEN coa.articles_returned END) AS SMALLINT) AS articles_returned_se,
		
			ROUND(SUM(coa.sales_returned),2) AS sales_returned,
			ROUND(AVG(coa.sales_returned),2) AS sales_returned_avg,
			ROUND(SUM(CASE WHEN co.shipping_country = 'AT' THEN coa.sales_returned END),2) AS sales_returned_at,
			ROUND(SUM(CASE WHEN co.shipping_country = 'BE' THEN coa.sales_returned END),2) AS sales_returned_be,
			ROUND(SUM(CASE WHEN co.shipping_country = 'CH' THEN coa.sales_returned END),2) AS sales_returned_ch,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DE' THEN coa.sales_returned END),2) AS sales_returned_de,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DK' THEN coa.sales_returned END),2) AS sales_returned_dk,
			ROUND(SUM(CASE WHEN co.shipping_country = 'LU' THEN coa.sales_returned END),2) AS sales_returned_lu,
			ROUND(SUM(CASE WHEN co.shipping_country = 'NL' THEN coa.sales_returned END),2) AS sales_returned_nl,
			ROUND(SUM(CASE WHEN co.shipping_country = 'SE' THEN coa.sales_returned END),2) AS sales_returned_se,
		
			ROUND(SUM(CAST(coa.cost_returned AS DECIMAL)),2) AS cost_returned,
			ROUND(AVG(CAST(coa.cost_returned AS DECIMAL)),2) AS cost_returned_avg,
			ROUND(SUM(CASE WHEN co.shipping_country = 'AT' THEN CAST(coa.cost_returned AS DECIMAL) END),2) AS cost_returned_at,
			ROUND(SUM(CASE WHEN co.shipping_country = 'BE' THEN CAST(coa.cost_returned AS DECIMAL) END),2) AS cost_returned_be,
			ROUND(SUM(CASE WHEN co.shipping_country = 'CH' THEN CAST(coa.cost_returned AS DECIMAL) END),2) AS cost_returned_ch,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DE' THEN CAST(coa.cost_returned AS DECIMAL) END),2) AS cost_returned_de,
			ROUND(SUM(CASE WHEN co.shipping_country = 'DK' THEN CAST(coa.cost_returned AS DECIMAL) END),2) AS cost_returned_dk,
			ROUND(SUM(CASE WHEN co.shipping_country = 'LU' THEN CAST(coa.cost_returned AS DECIMAL) END),2) AS cost_returned_lu,
			ROUND(SUM(CASE WHEN co.shipping_country = 'NL' THEN CAST(coa.cost_returned AS DECIMAL) END),2) AS cost_returned_nl,
			ROUND(SUM(CASE WHEN co.shipping_country = 'SE' THEN CAST(coa.cost_returned AS DECIMAL) END),2) AS cost_returned_se,
		
		
			/* LOST */
			CAST(SUM(coa.articles_lost) AS SMALLINT) AS articles_lost,
			ROUND(CAST(SUM(coa.cost_lost) AS DECIMAL),2) AS cost_lost,
			ROUND(CAST(SUM(coa.sales_lost) AS DECIMAL),2) AS sales_lost,
		
			
			/* VIRTUAL STOCK */
			CAST (SUM(CASE WHEN coa.order_article_state = 'Sent' THEN coa.articles_sent END) AS SMALLINT) AS virtual_stock_articles_sent,
			ROUND(SUM(CASE WHEN coa.order_article_state = 'Sent' THEN CAST(coa.cost_sent AS DECIMAL) END),2) AS virtual_stock_cost_sent,
			ROUND(SUM(CASE WHEN coa.order_article_state = 'Sent' THEN CAST(coa.sales_sent AS DECIMAL) END),2) AS virtual_stock_sales_sent,
			ROUND(AVG(CASE WHEN coa.order_article_state = 'Sent' THEN CAST(coa.cost_sent AS DECIMAL) END),2) AS virtual_stock_cost_sent_avg,
			ROUND(AVG(CASE WHEN coa.order_article_state = 'Sent' THEN CAST(coa.sales_sent AS DECIMAL) END),2) AS virtual_stock_sales_sent_avg
		
		FROM
			bi.customer_order AS co
			JOIN
			bi.customer_order_articles AS coa
				ON co.order_id = coa.order_id
		WHERE
			coa.stock_location_id =  2 /* own stock */
		AND coa.order_article_state_number !=2048 /* not cancelled */
		AND co.date_shipped  >= '2014-01-01'
		AND coa.date_shipped >= '2014-01-01'
		GROUP BY 1,2
	) AS coa 					/* coalesce to address 3 table full join */
		 ON coa.article_id 		= COALESCE(stock.article_id, bookings.article_id)
		AND coa.date_shipped 	= COALESCE(stock.date_created, bookings.stock_booking_date)

WHERE
	stock.date_created >='2014-01-01'
	/* the following strips out almost 2/3 of rows that have essentially no data; if any of the measures !=0 then the row is kept */
AND	COALESCE(ABS(stock.stock_beg),0) +
	COALESCE(ABS(stock.reserved_beg),0) +
	COALESCE(ABS(stock.stock_end),0) +
	COALESCE(ABS(stock.reserved_end),0) +
	COALESCE(ABS(bookings.po_bookings),0) +
	COALESCE(ABS(bookings.supplier_returns),0) +
	COALESCE(ABS(poa.poa_booked_qty),0) +
	COALESCE(ABS(poa.poa_revised_qty),0) +
	COALESCE(ABS(poa.poa_initial_qty),0) +
	COALESCE(ABS(coa.articles_sent),0) +
	COALESCE(ABS(coa.articles_kept),0) +
	COALESCE(ABS(coa.articles_returned),0) +
	COALESCE(ABS(coa.articles_lost),0) +
	COALESCE(ABS(coa.virtual_stock_articles_sent),0)
	> 0"	READY
131,097	2015-05-20 15:38:00	"892835091"	true	2015-06-16 15:14:12	raw.snowplow_events		"CREATE VIEW ""raw.snowplow_events"" AS 
SELECT 
	""events.app_id"",
	""events.platform"",
	""events.etl_tstamp"",
	""events.collector_tstamp"",
	""events.dvce_tstamp"",
	""events.event"",
	""events.event_id"",
	""events.txn_id"",
	""events.name_tracker"",
	""events.v_tracker"",
	""events.v_collector"",
	""events.v_etl"",
	""events.user_id"",
	""events.user_ipaddress"",
	""events.user_fingerprint"",
	""events.domain_userid"",
	""events.domain_sessionidx"",
	""events.network_userid"",
	""events.geo_country"",
	""events.geo_region"",
	""events.geo_city"",
	""events.geo_zipcode"",
	""events.geo_latitude"",
	""events.geo_longitude"",
	""events.geo_region_name"",
	""events.ip_isp"",
	""events.ip_organization"",
	""events.ip_domain"",
	""events.ip_netspeed"",
	""events.page_url"",
	""events.page_title"",
	""events.page_referrer"",
	""events.page_urlscheme"",
	""events.page_urlhost"",
	""events.page_urlport"",
	""events.page_urlpath"",
	""events.page_urlquery"",
	""events.page_urlfragment"",
	""events.refr_urlscheme"",
	""events.refr_urlhost"",
	""events.refr_urlport"",
	""events.refr_urlpath"",
	""events.refr_urlquery"",
	""events.refr_urlfragment"",
	""events.refr_medium"",
	""events.refr_source"",
	""events.refr_term"",
	""events.mkt_medium"",
	""events.mkt_source"",
	""events.mkt_term"",
	""events.mkt_content"",
	""events.mkt_campaign"",
	""events.se_category"",
	""events.se_action"",
	""events.se_label"",
	""events.se_property"",
	""events.se_value"",
	""events.tr_orderid"",
	""events.tr_affiliation"",
	""events.tr_total"",
	""events.tr_tax"",
	""events.tr_shipping"",
	""events.tr_city"",
	""events.tr_state"",
	""events.tr_country"",
	""events.ti_orderid"",
	""events.ti_sku"",
	""events.ti_name"",
	""events.ti_category"",
	""events.ti_price"",
	""events.ti_quantity"",
	""events.pp_xoffset_min"",
	""events.pp_xoffset_max"",
	""events.pp_yoffset_min"",
	""events.pp_yoffset_max"",
	""events.useragent"",
	""events.br_name"",
	""events.br_family"",
	""events.br_version"",
	""events.br_type"",
	""events.br_renderengine"",
	""events.br_lang"",
	""events.br_features_pdf"",
	""events.br_features_flash"",
	""events.br_features_java"",
	""events.br_features_director"",
	""events.br_features_quicktime"",
	""events.br_features_realplayer"",
	""events.br_features_windowsmedia"",
	""events.br_features_gears"",
	""events.br_features_silverlight"",
	""events.br_cookies"",
	""events.br_colordepth"",
	""events.br_viewwidth"",
	""events.br_viewheight"",
	""events.os_name"",
	""events.os_family"",
	""events.os_manufacturer"",
	""events.os_timezone"",
	""events.dvce_type"",
	""events.dvce_ismobile"",
	""events.dvce_screenwidth"",
	""events.dvce_screenheight"",
	""events.doc_charset"",
	""events.doc_width"",
	""events.doc_height"",
	""events.tr_currency"",
	""events.tr_total_base"",
	""events.tr_tax_base"",
	""events.tr_shipping_base"",
	""events.ti_currency"",
	""events.ti_price_base"",
	""events.base_currency"",
	""events.geo_timezone"",
	""events.mkt_clickid"",
	""events.mkt_network"",
	""events.etl_tags"",
	""events.dvce_sent_tstamp"",
	""events.refr_domain_userid"",
	""events.refr_dvce_tstamp"",
	""events.domain_sessionid"",
	""events.derived_tstamp""
FROM 
	""snowplow.events"""	READY
423	2015-04-24 18:27:03	"1126921203"	true	2015-08-07 10:48:12	tableau.finance_salesforce_reporting		"CREATE view tableau.finance_salesforce_reporting
AS
SELECT
  co.order_id,
  co.customer_id,
  co.shipping_street,
  co.shipping_zip,
  co.shipping_city,
  co.payment_type,
  co.shipping_country,
  co.date_created,
  co.sales_channel,
  co.date_phone_call_current,
  co.order_state_number,
  co.order_type,
  co.date_paid,
  co.billing_received,
  co.is_real_order,
  co.billing_received*co.exchange_rate as total_amount_paid,
  co.sales_sent*co.exchange_rate as total_amount_basket_retail_gross,
  co.date_phone_call,
  /*customer details*/
  cu.national_id,
  cu.first_name,
  cu.last_name,
  cu.date_of_birth,
  /*Salesforce Account Fields*/
  sa.salesforce_customer_id,
  sa.finance_negative_entry,
  sa.finance_negative_features,
  sa.finance_buergel_score,
  sa.vip_customer,
  /*Salesforce Opportunities fields*/
  so.salesforce_order_stage,
  so.ops_check,
  so.max_basket_arvato,
  so.newcardrecommendation,
  /*Financial Transaction*/
  ao.status,
  ao.arvatoresult,
  ao.arvatoscore,
  ao.max_valuation
FROM bi.customer_order co
LEFT JOIN bi.customer cu on co.customer_id=cu.customer_id
LEFT JOIN views.additional_order_information ao on ao.order_id=co.order_id
LEFT JOIN raw.customer_salesforce sa on sa.customer_id=co.customer_id
LEFT JOIN raw.customer_order_salesforce so on so.order_id=co.order_id
WHERE co.order_state_number not in (4,2048)"	READY
230	2015-04-24 18:19:25	"1112787725"	true	2015-04-24 18:19:25	ml.order_position_outfit_articles		"CREATE VIEW ml.order_position_outfit_articles AS
SELECT
	agg_outfit.order_position_id,
 	CAST(trim(trailing ',' from replace(to_chars(agg_outfit.cart_blob, 'UTF-8'), unescape('\n'), ',')) AS STRING) AS outfit_articles
 FROM
(SELECT
	coa.order_position_id,
	coa.article_id,
	textagg(coa.article_id QUOTE '') OVER (PARTITION BY coa.outfit_id) AS cart_blob
FROM bi.customer_order_articles AS coa) AS agg_outfit"	READY
272	2015-04-24 18:19:49	"1112787758"	true	2015-04-24 18:19:49	ml.project_tinder		"CREATE VIEW ml.project_tinder AS
SELECT
foo.molor,
foo.kept,
foo.returned,
foo.date_picked_latest,
ai.image_url,
ac.flat_category,
ainfo.model,
ab.attribute_name brand
FROM (
    SELECT
        molor,
        SUM(returned) returned,
        SUM(kept) kept,
        MIN(article_id) article_id,
        MAX(date_picked) date_picked_latest
    FROM
        (
        SELECT
        a.article_id,
        ai.molor,
        CASE WHEN coa.state = 'Returned' THEN 1 ELSE 0 END returned,
        CASE WHEN coa.state = 'Kept' THEN 1 ELSE 0 END kept,
        coa.date_picked
        FROM
        ""raw.customer_order_articles"" coa
        JOIN ""raw.article"" a ON coa.article_id = a.article_id
        JOIN ml.article_info ai ON ai.article_id = a.article_id
        WHERE coa.state in ( 'Returned', 'Kept' )
        ) x
GROUP BY molor
) foo
JOIN ml.article_image ai ON ai.id = foo.article_id
JOIN ml.article_info ainfo ON ainfo.article_id = foo.article_id
JOIN ml.article_brand ab ON ab.article_id = foo.article_id
LEFT JOIN ml.article_category_new ac ON ac.article_id = foo.article_id
WHERE ac.flat_category IS NOT NULL
AND ac.flat_category NOT IN ( 'other', 'shoulder_bag', 'socks', 'sport_socks', 't_shirt_basic', 'underpants', 'undershirt' )
AND ai.image_url LIKE_REGEX 'http://pim.*'"	FAILED
229,447	2015-06-25 11:05:44	"1189689256"	true	2015-08-20 15:55:31	raw.desk_case_users		"CREATE VIEW raw.desk_case_users
AS

SELECT 
	vv.id as user_id, 
	vv.""name"" as user_name, 
	vv.email as user_email,
	vv.level as user_type,
	vv.created_at,
	vv.last_login_at
from
(
	call ""desk_com_connector.get_list_users"" ()
) vv"	READY
118	2015-04-24 18:17:53	"1278724201"	true	2015-09-07 14:40:46	raw.snowplow_pageviews		"CREATE view raw.snowplow_pageviews
AS

SELECT
	fi.visitor_id,
	fi.user_id,
	fi.visitor_session_id,
	dense_rank() OVER (PARTITION BY fi.visitor_session_id ORDER BY fi.date_created ASC, fi.channel_rank ASC, fi.campaign_rank ASC) as pageview_count,
	fi.date_created,
	fi.device_type,
	fi.br_family,
	fi.br_type,
	fi.os_name,
	fi.os_family,
	fi.geo_country,
	fi.url_host,
	fi.url_path,
	fi.url_query,
	fi.source,
	fi.medium,
	fi.campaign,
	fi.term,
	/* Start Subchannel logic */
	CASE
		WHEN fi.marketing_channel = 'Direct' AND source is null THEN 'Direct Type-in'
	 	WHEN fi.marketing_channel = 'Direct' AND source is not null THEN 'Organic referral'
	 	WHEN fi.marketing_channel = 'Remarketing' THEN 'Remarketing'
	 	WHEN fi.marketing_channel = 'SEM Brand' THEN 'Google'
	 	WHEN fi.marketing_channel = 'Facebook' THEN 'CPC'
	 	WHEN fi.marketing_channel = 'Cooperations' THEN 'Web-contact'
	 	WHEN fi.marketing_channel = 'Referral Program' THEN 'Online'
	 	/*	Affiliate sub-channels */
	 	WHEN fi.marketing_channel = 'Affiliate' AND (fi.source || fi.medium || fi.campaign LIKE '%affilinet%' OR fi.source || fi.medium || fi.campaign LIKE '%affili.net%') THEN 'Affilinet'
	 	WHEN fi.marketing_channel = 'Affiliate' AND fi.source || fi.medium || fi.campaign LIKE '%daisycon%' THEN 'Daisycon'
	 	WHEN fi.marketing_channel = 'Affiliate' AND fi.source || fi.medium || fi.campaign LIKE '%mitarbeiterangebote%' THEN 'Corporate Benefit Program'
	 	WHEN fi.marketing_channel = 'Affiliate' AND fi.source || fi.medium || fi.campaign NOT LIKE '%daisycon%' AND fi.source || fi.medium || fi.campaign NOT LIKE '%affilinet%' AND fi.source || fi.medium || fi.campaign NOT LIKE '%affili.net%' AND fi.source || fi.medium || fi.campaign NOT LIKE '%mitarbeiterangebote%' THEN 'Other Platform'
		/*	SEO sub-channels */
		WHEN fi.marketing_channel = 'SEO' AND fi.source || fi.medium || fi.campaign LIKE '%google%' THEN 'Google'
		WHEN fi.marketing_channel = 'SEO' AND fi.source || fi.medium || fi.campaign LIKE '%bing%' THEN 'Bing'
		WHEN fi.marketing_channel = 'SEO' AND fi.source || fi.medium || fi.campaign LIKE '%yahoo%' THEN 'Yahoo'
		WHEN fi.marketing_channel = 'SEO' AND fi.source || fi.medium || fi.campaign NOT LIKE '%yahoo%' AND fi.source || fi.medium || fi.campaign NOT LIKE '%google%' AND fi.source || fi.medium || fi.campaign NOT LIKE '%bing%' THEN 'Blog'
		/*	SEM Non-brand sub-channels */
		WHEN fi.marketing_channel = 'SEM Non-brand' AND fi.source || fi.medium || fi.campaign LIKE '%google%' THEN 'Google'
		WHEN fi.marketing_channel = 'SEM Non-brand' AND fi.source || fi.medium || fi.campaign LIKE '%bing%' THEN 'Bing'
		WHEN fi.marketing_channel = 'SEM Non-brand' AND fi.source || fi.medium || fi.campaign LIKE '%yahoo%' THEN 'Yahoo'
		WHEN fi.marketing_channel = 'SEM Non-brand' AND fi.source || fi.medium || fi.campaign NOT LIKE '%yahoo%' AND fi.source || fi.medium || fi.campaign NOT LIKE '%google%' AND fi.source || fi.medium || fi.campaign NOT LIKE '%bing%' THEN 'Blog'
		/*	Display */
		WHEN fi.marketing_channel = 'Display' AND fi.source || fi.medium || fi.campaign LIKE '%gdn%' THEN 'GDN'
		WHEN fi.marketing_channel = 'Display' AND fi.source || fi.medium || fi.campaign NOT LIKE '%gdn%'THEN 'Other'
		/*	Social Media */
		WHEN fi.marketing_channel = 'Social Media' AND fi.source || fi.medium || fi.campaign LIKE '%twitter%' THEN 'Twitter'
		WHEN fi.marketing_channel = 'Social Media' AND fi.source || fi.medium || fi.campaign LIKE '%youtube%' THEN 'Youtube'
		WHEN fi.marketing_channel = 'Social Media' AND fi.source || fi.medium || fi.campaign LIKE '%facebook%' THEN 'Facebook'
		WHEN fi.marketing_channel = 'Social Media' AND fi.source || fi.medium || fi.campaign LIKE '%linkedin.com%' THEN 'LinkedIn'
		WHEN fi.marketing_channel = 'Social Media' AND fi.source || fi.medium || fi.campaign LIKE '%xing.com%' THEN 'Xing'
		/*	CRM */
		WHEN fi.marketing_channel = 'CRM' AND fi.source || fi.medium || fi.campaign LIKE '%remarketing%' THEN 'Remarketing'
		WHEN fi.marketing_channel = 'CRM' AND fi.source || fi.medium || fi.campaign NOT LIKE '%remarketing%' THEN 'Email'
		ELSE 'Other'
	END as marketing_subchannel,
	/* End Subchannel logic */
	
	fi.marketing_channel,
	fi.session_count
FROM
(
	SELECT
		ra.visitor_id,
		ra.user_id,
		ra.visitor_session_id,
		ra.date_created,
		ra.device_type,
		ra.br_family,
		ra.br_type,
		ra.os_name,
		ra.os_family,
		ra.geo_country,
		ra.url_host,
		ra.url_path,
		ra.url_query,
		ra.source,
		ra.medium,
		ra.campaign,
		CASE 
			WHEN ra.term is not null THEN ra.term
			WHEN ra.publisher_domain is not null THEN ra.publisher_domain
			ELSE null
		END AS term,
		ra.marketing_channel,
		ra.session_count,
		CASE 
			WHEN ra.marketing_channel = 'Facebook' THEN 1
			WHEN ra.marketing_channel = 'SEM Non-brand' THEN 2
			WHEN ra.marketing_channel = 'Display' THEN 3
			WHEN ra.marketing_channel = 'Referral Program' THEN 4
			WHEN ra.marketing_channel = 'Remarketing' THEN 4
			WHEN ra.marketing_channel = 'Affiliate' THEN 6
			WHEN ra.marketing_channel = 'CRM' THEN 7
			WHEN ra.marketing_channel = 'Social Media' THEN 8
			WHEN ra.marketing_channel = 'SEM Brand' THEN 9
			WHEN ra.marketing_channel = 'SEO' THEN 10
			WHEN ra.marketing_channel = 'Direct' THEN 11
		END as channel_rank,
		RAND() as campaign_rank
	FROM(
		SELECT
			DISTINCT
			sp.visitor_id,
			sp.user_id,
			sp.visitor_id ||'-'|| sp.session_count as visitor_session_id,
			sp.date_created,
			sp.device_type,
			sp.br_family,
			sp.br_type,
			sp.os_name,
			sp.os_family,
			sp.geo_country,
			sp.url_host,
			sp.url_path,
			sp.url_query,
			sp.source_final as source,
			sp.medium_final as medium,
			sp.campaign_final as campaign,
			sp.term_final as term,
			sp.publisher_domain,
			CASE
			WHEN chan.channel = 'praemienprogramm' OR sp.medium_final = 'referralpage' OR sp.source_final = 'praemienprogramm' then 'Referral Program'
			WHEN chan.channel ='remarketing' OR LOWER(sp.campaign_final || sp.source_final || sp.medium_final) like '%remarketing%' THEN 'Remarketing'
			WHEN chan.channel = 'twitter' OR chan.channel = 'youtube' OR LOWER(sp.campaign_final || sp.source_final || sp.medium_final) like '%twitter%' OR LOWER(sp.campaign_final || sp.source_final || sp.medium_final) like '%youtube%' OR LOWER(sp.campaign_final || sp.source_final || sp.medium_final) like '%linkedin%' OR LOWER(sp.campaign_final || sp.source_final || sp.medium_final) like '%xing%' OR LOWER(sp.campaign_final || sp.source_final || sp.medium_final) like '%google+%' OR LOWER(sp.source_final) like '%instagram%' THEN 'Social Media'
			WHEN chan.channel ='display' OR LOWER(sp.campaign_final || sp.source_final || sp.medium_final) like '%display%' THEN 'Display'
			WHEN chan.channel = 'affiliate' OR LOWER(sp.campaign_final || sp.source_final || sp.medium_final) like '%affili%' OR LOWER(sp.campaign_final || sp.source_final || sp.medium_final) like '%mitarbeiterangebote%' THEN 'Affiliate'
			WHEN chan.channel = 'facebook' OR LOWER(sp.campaign_final) like '%facebook%' OR LOWER(sp.source_final) like '%facebook%' OR LOWER(sp.medium_final) like '%facebook%' THEN 'Facebook'
			WHEN LOWER(sp.source_final) like '%google%' AND lower(sp.medium_final) = 'cpc' AND (LOWER(sp.campaign_final)  like '%brand%' OR LOWER(sp.campaign_final) is null) OR LOWER(sp.term_final) like '%outfitt%' THEN 'SEM Brand'
			WHEN (LOWER(sp.source_final) like '%google%' AND lower(sp.medium_final) = 'cpc' AND LOWER(sp.campaign_final) not like '%brand%' ) OR (LOWER(sp.source_final) LIKE 'bing%')  THEN 'SEM Non-brand'
			WHEN chan.channel = 'organic' OR LOWER(sp.medium_final) = 'organic' OR LOWER(sp.medium_final) = 'search' OR (sp.source_final like '%google%' AND LOWER(sp.medium_final) != 'cpc') THEN 'SEO'
			WHEN chan.channel = 'crm' OR sp.medium_final = 'email' OR LOWER(sp.source_final) like '%mail%' OR LOWER(sp.campaign_final || sp.source_final || sp.medium_final) LIKE '%crm%' OR LOWER(sp.source_final) = 'news.outfittery.com' THEN 'CRM' 
			WHEN chan.channel = 'kooperation' OR LOWER(sp.source_final) like 'coop%' THEN 'Cooperations'
			ELSE 'Direct'
			END AS marketing_channel,
			sp.session_count
		FROM
		(
			SELECT
				ab.visitor_id,
				ab.user_id,
				ab.date_created,
				ab.device_type,
				ab.br_family,
				ab.br_type,
				ab.os_name,
				ab.os_family,
				ab.geo_country,
				ab.url_host,
				ab.url_path,
				ab.url_query,
				ab.utm_source,
				ab.utm_medium,
				ab.utm_campaign,
				ab.utm_term,
				ab.gclid,
				ad.campaign as gclid_campaign,
				af.publisher_domain,
				ab.referrer_url_host,
				ab.referrer_url_path,
				ab.referrer_url_query,
				ab.referrer_source,
				ab.referrer_medium,
				ab.referrer_term,
				CASE
					WHEN ab.gclid is not null THEN 'Google' 
					WHEN ab.utm_source is not null THEN utm_source 
					WHEN ab.utm_source is null AND ab.referrer_source is not null THEN ab.referrer_source
					WHEN ab.utm_source is null AND ab.referrer_source is null AND ab.referrer_url_host like '%www.%' THEN SUBSTRING(ab.referrer_url_host,5)
					ELSE ab.referrer_url_host
				END AS source_final,
				CASE 
					WHEN ab.gclid is not null THEN 'CPC'
					WHEN ab.utm_medium is not null THEN utm_medium
					WHEN ab.utm_medium is null AND ab.referrer_medium is not null THEN ab.referrer_medium
					ELSE null
				END AS medium_final,
				CASE 
					WHEN ab.gclid is not null THEN ad.campaign
					WHEN ab.utm_campaign is not null THEN utm_campaign
					ELSE null
				END AS campaign_final,
				CASE 
					WHEN ab.utm_term is not null THEN ab.utm_term
					ELSE ab.referrer_term
				END AS term_final,		
				ab.session_count	
			FROM
			(
				SELECT
					domain_userid as visitor_id,
					user_id,
					MODIFYTIMEZONE(collector_tstamp,'UTC+1') as date_created,
					dvce_type as device_type,
					br_family,
					br_type,
					os_name,
					os_family,
					page_urlhost as url_host,
					geo_country,
					page_urlpath as url_path,
					page_urlquery as url_query,
					mkt_source as utm_source,
					mkt_medium as utm_medium,
					mkt_campaign as utm_campaign,
					mkt_term as utm_term,
					CASE 
						WHEN page_urlquery like '%gclid%' AND SUBSTRING(page_urlquery,LOCATE('gclid=',page_urlquery)+6) not like '%&%' THEN SUBSTRING(page_urlquery,LOCATE('gclid=',page_urlquery)+6) 
						WHEN page_urlquery like '%gclid%' AND SUBSTRING(page_urlquery,LOCATE('gclid=',page_urlquery)+6) like '%&%' THEN 		LEFT(LEFT(SUBSTRING(page_urlquery,LOCATE('gclid=',page_urlquery)+6),LOCATE('&',SUBSTRING(page_urlquery,LOCATE('gclid=',page_urlquery)+6))),LENGTH(LEFT(SUBSTRING(page_urlquery,LOCATE('gclid=',page_urlquery)+6),LOCATE('&',SUBSTRING(page_urlquery,LOCATE('gclid=',page_urlquery)+6))))-1) 
						ELSE null 
					END as gclid,
					CASE
						WHEN page_urlquery like '%publisherID=%' THEN LEFT(SUBSTRING(page_urlquery,LOCATE('publisherID=', page_urlquery)+12),6)
						ELSE null
					END AS publisher_id,
					refr_urlhost as referrer_url_host,
					refr_urlpath as referrer_url_path,
					refr_urlquery as referrer_url_query,
					refr_source as referrer_source,
					refr_medium as referrer_medium,
					refr_term as referrer_term,
					domain_sessionidx as session_count
				FROM raw.snowplow_events
				WHERE event = 'page_view'
				/* --Filter out own IP and bot traffic-- */
				AND user_ipaddress NOT LIKE '213.61.116.%'
				AND br_type != 'Robot'
				/* --Filter out domain tracking mistakes-- */
				AND ( page_urlhost = 'www.outfittery.de' OR page_urlhost = 'static.outfittery.de'  
				OR page_urlhost = 'www.outfittery.at' OR page_urlhost = 'static.outfittery.at'  
				OR page_urlhost = 'www.outfittery.ch' OR page_urlhost = 'static.outfittery.ch'  
				OR page_urlhost = 'www.outfittery.nl' OR page_urlhost = 'static.outfittery.nl' 
				OR page_urlhost = 'www.outfittery.be' OR page_urlhost = 'static.outfittery.be'  
				OR page_urlhost = 'www.outfittery.lu' OR page_urlhost = 'static.outfittery.lu'  
				OR page_urlhost = 'www.outfittery.dk' OR page_urlhost = 'static.outfittery.dk'  
				OR page_urlhost = 'www.outfittery.no' OR page_urlhost = 'static.outfittery.no'  
				OR page_urlhost = 'www.outfittery.se' OR page_urlhost = 'static.outfittery.se'  
				OR page_urlhost = 'www.outfittery.com' OR page_urlhost = 'static.outfittery.com')
				AND CAST(collector_tstamp as date) >= '2015-04'
			) ab
			LEFT JOIN dwh.ga_information_adwords ad ON ad.gclid = ab.gclid
			LEFT JOIN dwh.marketing_affilinet_publishers af ON ab.publisher_id = af.publisher_id
		) sp
		LEFT JOIN dwh.ga_channel_translation chan on lower(sp.source_final)|| ' / ' || lower(sp.medium_final) = lower(chan.source_medium)
	) ra
) fi"	READY
347	2015-04-24 18:22:44	"638185629"	true	2015-04-24 18:22:44	am.variant_old		"CREATE VIEW ""am.variant_old"" AS
SELECT v.*,
size_map.size_mapped ""size"",
pics.pics AS ""pics""
FROM
(
SELECT
size_variation.o_id AS ""pim_size_variation_id"",
size_variation.ean AS ""ean"",
article.pim_model_id AS ""pim_model_id"",
color_variation.o_id AS ""pim_color_variation_id"",
season.season_pim,
season.season_erp,
size_variation.net_weight_gram AS ""weight_net"",
size_variation.gross_weight_gram AS ""weight_gross"",
CAST (size_variation.purchase_price AS BIGDECIMAL) AS ""purchase_price"",
CAST (size_variation.price_retail_de AS BIGDECIMAL) AS ""retail_price_de"",
CAST (size_variation.price_retail_chf AS BIGDECIMAL) AS ""retail_price_ch"",
CAST (size_variation.price_retail_dkk AS BIGDECIMAL) AS ""retail_price_dk"",
CAST (size_variation.price_retail_sek AS BIGDECIMAL) AS ""retail_price_se"",
CAST (size_variation.price_retail_benelux AS BIGDECIMAL) AS ""retail_price_lu"",
CAST (size_variation.price_retail_benelux AS BIGDECIMAL) AS ""retail_price_nl"",
CAST (size_variation.price_retail_benelux AS BIGDECIMAL) AS ""retail_price_be"",
CASE
WHEN size_variation.eu_length IS NOT NULL THEN TRIM(size_variation.eu_length) || 'x' || TRIM(size_variation.eu_size)
ELSE TRIM(size_variation.eu_size)
END AS ""size_raw"",
'0010' ""color_erp""
FROM am.base ""article""
INNER JOIN am.object_17 ""color_variation"" ON color_variation.o_parentId = article.pim_model_id
INNER JOIN am.object_17 ""size_variation"" ON size_variation.o_parentId = color_variation.o_id
LEFT JOIN ""am.season_pim__season_erp"" season ON season.season_pim = color_variation.season
AND color_variation.o_type = 'variant'
AND size_variation.o_type = 'variant'
) ""v""
LEFT JOIN ""am.size_raw__size_mapped"" size_map ON size_map.size_raw = v.size_raw
LEFT JOIN ""am.o__pics"" pics ON pics.o_id = v.pim_color_variation_id"	FAILED
366	2015-04-24 18:23:20	"1112787843"	true	2015-06-25 14:12:28	tableau.finance_intrahandelsstatistik_at		"CREATE view tableau.finance_intrahandelsstatistik_at
AS

SELECT 
    cast(co.date_shipped as date) as date_shipped,
    co.shipping_country,
    it.brand,
    it.parent_no as o_parentId,
    it.net_weight as net_weight_gram,
    it.tariff_no as de_customs_tarff_number,
    sum(coa.articles_sent) as items_sent,
    sum(coa.cost_sent) as order_value_purchase_price
FROM bi.customer_order co 
LEFT JOIN bi.customer_order_articles coa ON co.order_id=coa.order_id
LEFT JOIN bi.item it ON it.article_id=coa.article_id
WHERE co.date_shipped IS NOT NULL AND co.order_state_number<2048
GROUP BY 1,2,3,4,5,6"	READY
368	2015-04-24 18:23:23	"1112787845"	true	2015-04-24 18:23:23	tableau.accounting_monthly_orders_returns_orders		"CREATE VIEW tableau.accounting_monthly_orders_returns_orders
AS
SELECT 
    order_id as customer_order_id,
    co.state as customer_order_state,
    co.date_returned as customer_order_date_returned,
    co.date_shipped as customer_order_date_shipped,
    co.invoice_date_created,
    co.shipping_first_name as first_name,
    co.shipping_last_name as last_name,
    co.shipping_country as country,
    co.total_amount_billed_discount,
    co.total_amount_billed_discount_euro,
    /*Basket Purchase Price*/
    sum(case when op.state>=16 and op.state<2048 then op.purchase_price else 0 end)  as total_amount_basket_purchase_gross,
    sum(case when op.stock_location_id = 4 and op.state>=16 and op.state<2048 then op.purchase_price else 0 end)  as total_amount_basket_purchase_gross_z_stock,
    sum(case when op.stock_location_id = 2 and op.state>=16 and op.state<2048 then op.purchase_price else 0 end) as total_amount_basket_purchase_gross_own,
    sum(case when op.stock_location_id = 4 and op.state>=16 and op.state<2048 then op.purchase_price else 0 end) as total_amount_basket_purchase_gross_z_ch,
    /*basket Retail Price*/
    sum(case when op.state>=16 and op.state<2048 then op.retail_price_euro else 0 end) as total_amount_basket_retail_gross,
    sum(case when op.stock_location_id = 4 and op.state>=16 and op.state<2048 then op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_z_stock,
    sum(case when op.stock_location_id = 2 and op.state>=16 and op.state<2048 then op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_own,
    sum(case when op.stock_location_id = 4 and op.state>=16 and op.state<2048 then op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_z_ch,
    /*Retail Price-local curreny*/
    sum(case when op.state>=16 and op.state<2048 then op.retail_price else 0 end) as total_amount_basket_retail_gross_no,
    sum(case when op.stock_location_id = 4  and op.state>=16 and op.state<2048 then op.retail_price else 0 end) as total_amount_basket_retail_gross_z_stock_no,
    sum(case when op.stock_location_id = 2 and op.state>=16 and op.state<2048 then op.retail_price else 0 end) as total_amount_basket_retail_gross_own_no,
    sum(case when op.stock_location_id = 4 and op.state>=16 and op.state<2048 then op.retail_price else 0 end) as total_amount_basket_retail_gross_z_ch_no,
    /*Billed Purhase Price*/
    sum(case when op.state=1024 then op.purchase_price else 0 end) as total_amount_billed_purchase_gross,
    sum(case when op.stock_location_id = 4 and op.state=1024 then op.purchase_price else 0 end) as total_amount_billed_purchase_gross_z_stock,
    sum(case when op.stock_location_id = 2 and op.state=1024 then op.purchase_price else 0 end) as total_amount_billed_purchase_gross_own,
    sum(case when op.stock_location_id = 4 and op.state=1024 then op.purchase_price else 0 end) as total_amount_billed_purchase_gross_z_ch,
    /*Billed Retail Price*/
    sum(case when op.state=1024 then op.retail_price_euro else 0 end) as total_amount_billed_retail_gross,
    sum(case when op.stock_location_id = 4 and op.state=1024 then op.retail_price_euro else 0 end) as total_amount_billed_retail_gross_z_stock,
    sum(case when op.stock_location_id = 2 and op.state=1024 then op.retail_price_euro else 0 end) as total_amount_billed_retail_gross_own,
    sum(case when op.stock_location_id = 4 and op.state=1024 then op.retail_price_euro else 0 end) as total_amount_billed_retail_gross_z_ch,
    /*Billed Retail Price-local currency*/
    sum(case when op.state=1024 then op.retail_price else 0 end) as total_amount_billed_retail_gross_no,
    sum(case when op.stock_location_id = 4 and op.state=1024 then op.retail_price else 0 end) as total_amount_billed_retail_gross_z_stock_no,
    sum(case when op.stock_location_id = 2 and op.state=1024 then op.retail_price else 0 end) as total_amount_billed_retail_gross_own_no,
    sum(case when op.stock_location_id = 4 and op.state=1024 then op.retail_price else 0 end) as total_amount_billed_retail_gross_z_ch_no
FROM views.order_position op
JOIN views.customer_order co on co.id=op.order_id
WHERE cast(co.invoice_date_created as date)>='2014-01-01' AND
co.state<2048 and
co.order_state='Real Order' AND co.state<2048
GROUP BY 1,2,3,4,5,6,7,8,9,10"	READY
120	2015-04-24 18:17:54	"647450458"	true	2015-04-26 11:43:08	tableau.monitoring_dv_failures		"CREATE VIEW tableau.monitoring_dv_failures
AS

SELECT
x.job_name, 
x.job_type,
x.start_time,
x.mins,
x.status,
left(x.failure_reason,4000) as failure_reason
FROM
(
	SELECT
	CASE 
		WHEN sjr.jobType = 'recopt' THEN SUBSTRING(SUBSTRING(sjr.sqlCommand, 16), 0, LOCATE('""', SUBSTRING(sjr.sqlCommand, 16))-1)
		ELSE sj.description
	END as job_name,
	CASE 
		WHEN sjr.jobType = 'recopt' THEN 'optimisation'
		ELSE sjr.jobType 
	END as job_type,
	sjr.startTime as start_time,
	CASE 
		WHEN sjr.status = 'RUNNING' THEN ROUND(cast(cast(TIMESTAMPDIFF(SQL_TSI_SECOND, sjr.startTime, now()) as double)/cast(60 as double) as decimal), 2)
		ELSE ROUND(cast(cast(TIMESTAMPDIFF(SQL_TSI_SECOND, sjr.startTime, sjr.endTime) as double)/cast(60 as double) as decimal), 2)
	END as mins,
	CASE 
		WHEN sjr.status = 'SUCCESS' THEN 'SUCCESS'
		WHEN sjr.status = 'FAILED' THEN 'FAILED'
		WHEN sjr.status = 'RUNNING' THEN 'RUNNING'
		ELSE 'INTERRUPTED'
	END as status,
	left(sjr.failureReason,4000) as failure_reason,
	rank() OVER(PARTITION BY 
		CASE 
			WHEN sjr.jobType = 'recopt' THEN SUBSTRING(SUBSTRING(sjr.sqlCommand, 16), 0, LOCATE('""', SUBSTRING(sjr.sqlCommand, 16))-1)
			ELSE sj.description
		END 
		ORDER BY sjr.startTime DESC) as job_recency
	FROM SYSADMIN.ScheduleJobRun sjr 
	LEFT JOIN SYSADMIN.ScheduleJobs sj on sj.id = sjr.jobId
	WHERE TIMESTAMPDIFF(SQL_TSI_HOUR, sjr.startTime, now()) < 25 
) x
WHERE x.job_recency = 1
AND job_type != 'cleanup'
AND status != 'SUCCESS'
AND job_name is not null
AND job_name not like '%sandbox%'
AND LOWER(COALESCE(failure_reason,'')) NOT LIKE '%the request%has been cancelled%'"	READY
917,508	2015-09-28 15:52:55	"1383764939"	true	2015-09-28 15:52:55	raw.order_comment		"CREATE VIEW raw.order_comment
AS

SELECT 
	order_id,
	date_create as date_created,
	comment,
	user_name
FROM postgres.order_comment oc"	READY
557,060	2015-08-18 12:20:10	"1329724672"	true	2015-08-18 12:40:24	ml.cases_idea		"CREATE VIEW ml.cases_idea AS

WITH

level_0 AS (
SELECT
  co0.order_id,
  co0.order_id ""origin_order_id"",
  0 ""level""
FROM ""raw.dim_customer_order"" co0
WHERE co0.parent_order_id IS NULL
),

level_1 AS (
SELECT
  co1.order_id,
  parent.origin_order_id,
  1 ""level""
FROM ""raw.dim_customer_order"" co1
INNER JOIN level_0 parent ON parent.order_id = co1.parent_order_id ),

level_2 AS (
SELECT
  co1.order_id,
  parent.origin_order_id,
  2 ""level""
FROM ""raw.dim_customer_order"" co1
INNER JOIN level_1 parent ON parent.order_id = co1.parent_order_id ),

level_3 AS (
SELECT
  co1.order_id,
  parent.origin_order_id,
  3 ""level""
FROM ""raw.dim_customer_order"" co1
INNER JOIN level_2 parent ON parent.order_id = co1.parent_order_id ),

level_4 AS (
SELECT
  co1.order_id,
  parent.origin_order_id,
  4 ""level""
FROM ""raw.dim_customer_order"" co1
INNER JOIN level_3 parent ON parent.order_id = co1.parent_order_id ),

level_5 AS (
SELECT
  co1.order_id,
  parent.origin_order_id,
  5 ""level""
FROM ""raw.dim_customer_order"" co1
INNER JOIN level_4 parent ON parent.order_id = co1.parent_order_id ),

level_6 AS (
SELECT
  co1.order_id,
  parent.origin_order_id,
  6 ""level""
FROM ""raw.dim_customer_order"" co1
INNER JOIN level_5 parent ON parent.order_id = co1.parent_order_id ),

level_7 AS (
SELECT
  co1.order_id,
  parent.origin_order_id,
  7 ""level""
FROM ""raw.dim_customer_order"" co1
INNER JOIN level_6 parent ON parent.order_id = co1.parent_order_id ),

all_levels AS (
	SELECT * FROM level_0
	UNION
	SELECT * FROM level_1
	UNION
	SELECT * FROM level_2
	UNION
	SELECT * FROM level_3
	UNION
	SELECT * FROM level_4
	UNION
	SELECT * FROM level_5
	UNION
	SELECT * FROM level_6
	UNION
	SELECT * FROM level_7
),

cases AS (
SELECT
co77.customer_id,
co77.order_id ""case_id"",
RANK() OVER(PARTITION BY co77.customer_id ORDER BY co77.date_created ASC) ""case_no""
FROM level_0
LEFT JOIN ""raw.dim_customer_order"" co77 ON co77.order_id = level_0.origin_order_id
)

SELECT
co88.order_id,
cases.case_id,
cases.case_no,
all_levels.level ""level""
FROM ""raw.dim_customer_order"" co88
LEFT JOIN all_levels ON all_levels.order_id = co88.order_id
LEFT JOIN cases ON cases.case_id = all_levels.origin_order_id"	READY
426,073	2015-08-05 17:25:45	"1383765073"	true	2015-09-28 16:32:54	tableau.mkt_rt_performance_vs_plan		"CREATE VIEW tableau.mkt_rt_performance_vs_plan
AS


/*This report only concerns invoiced orders*/
WITH act AS(
SELECT
  CAST(date_invoiced AS date) AS date_invoiced,
  CASE
    WHEN CAST(date_invoiced AS date) < CURDATE() THEN 'Actual' 
    ELSE 'Forecast'
  END AS order_state,
  shipping_country,
  SUBSTRING(date_invoiced,1,4)||'-'||SUBSTRING(date_invoiced,6,2) as year_month, 
  COUNT(order_id) as invoiced_orders,
  SUM(CASE WHEN order_type = 'Outfittery Club Order' THEN 1 ELSE 0 END) as actual_invoiced_club_orders,
  SUM(CASE WHEN order_type = 'Repeat Order' THEN 1 ELSE 0 END) as actual_invoiced_repeat_orders,
  SUM(CASE WHEN order_type = 'Repeat Order' AND LOWER(sales_channel) not like '%app%' AND (LOWER(campaign_title) not like '%crm-magazin%' AND LOWER(campaign_title) not like '%crm magazin%' AND LOWER(campaign_title) not like '%magazin sommer%' OR campaign_title is null) THEN 1 ELSE 0 END)  as actual_invoiced_repeat_orders_other,
  SUM(CASE WHEN LOWER(sales_channel) like '%app%' THEN 1 ELSE 0 END) as actual_invoiced_app_orders,
  SUM(CASE WHEN LOWER(campaign_title) like '%crm-magazin%' OR LOWER(campaign_title) like '%crm magazin%' OR LOWER(campaign_title) like '%magazin sommer%' THEN 1 ELSE 0 END) as actual_invoiced_magazine_orders
FROM ""bi.customer_order"" cu
LEFT JOIN raw.discount_campaigns dc ON dc.campaign_id = cu.campaign_id
WHERE order_type IN ('Outfittery Club Order', 'Repeat Order')
AND is_real_order = 'Real Order'
AND date_invoiced is not null
AND order_state_number >= 16 
AND order_state_number < 2048
GROUP BY 1,2,3,4
)


SELECT
  fc.""date"",
  fc.country as country,
  SUM(CASE 
    WHEN fc.days_month_passed = 0 THEN null
    WHEN fc.days_month_passed < fc.month_days THEN CAST(mo.actual_invoiced_repeat_orders_month/fc.days_month_passed as decimal)
    ELSE act.actual_invoiced_repeat_orders
  END) AS real_repeat_orders_forecast,
  SUM(CASE 
    WHEN fc.days_month_passed = 0 THEN null
    ELSE act.actual_invoiced_club_orders
  END) AS club_orders,
  SUM(fc.daily_orders) as invoiced_order_goal,
  SUM(act.actual_invoiced_club_orders) as actual_club_repeat_orders,
  SUM(act.actual_invoiced_repeat_orders) as actual_real_repeat_orders,
  SUM(act.actual_invoiced_repeat_orders_other) as actual_invoiced_repeat_orders_other,
  SUM(actual_invoiced_magazine_orders) as actual_magazine_orders,
  SUM(actual_invoiced_app_orders) as  actual_app_orders
FROM
(
  SELECT
    CAST(c.""date"" as date) as ""date"",
    c.year_month,
    ab.month_days,
    ab.days_month_passed,
    ab.country,
    ab.daily_orders 
  FROM dwh.calendar c
  LEFT JOIN
  (
    SELECT
      go.year_month,
      go.country,
      ca.month_days,
      ca.days_month_passed,
      CAST(go.invoiced_order_forecast as decimal) / ca.month_days as daily_orders
    FROM dwh.retention_marketing_order_goals go
    LEFT JOIN
    (
      SELECT
        year_month,
        COUNT(day_of_month) as month_days,
        SUM(CASE WHEN ""date"" < CURDATE() THEN 1 ELSE 0 END) AS days_month_passed
      FROM dwh.calendar
      GROUP BY 1 
    ) ca ON go.year_month = ca.year_month
  ) ab ON c.year_month = ab.year_month
  WHERE ""date"" >= '2015-01-01'
  AND daily_orders is not null
) fc 
LEFT JOIN act ON fc.""date"" = act.date_invoiced AND fc.country = act.shipping_country
LEFT JOIN
(
  SELECT
    year_month,
    shipping_country,
    SUM(CASE WHEN order_state = 'Actual' THEN 1 ELSE 0 END) AS month_day_passed,
    SUM(actual_invoiced_club_orders) as actual_invoiced_club_orders_month,
    SUM(actual_invoiced_repeat_orders) as actual_invoiced_repeat_orders_month
  FROM act
  GROUP BY 1,2
) mo ON mo.year_month = fc.year_month AND fc.country = mo.shipping_country
GROUP BY 1,2"	READY
310	2015-04-24 18:20:29	"1319282168"	true	2015-09-15 10:13:54	tableau.ops_daily_shipped_and_returned_dd		"CREATE VIEW tableau.ops_daily_shipped_and_returned_dd 
AS 

SELECT 
	co.customer_id,
	log.order_id,
	log.article_id,
	log.shipment_manifest_date,
	log.return_date,
	log.shipping_country,
	log.track_and_trace_number,
	log.return_track_and_trace_number,
	a.article_ean,
	a.article_commodity_group4,
	co.date_returned as date_order_returned
FROM 
	raw.customer_order_articles_logistics AS log
	LEFT JOIN 
	bi.article AS a 
		ON a.article_id = log.article_id
	LEFT JOIN 
	bi.customer_order AS co 
		ON log.order_id = co.order_id"	READY
338	2015-04-24 18:22:15	"1112787817"	true	2015-04-27 12:44:30	tableau.management_order_type		"CREATE view ""tableau.management_order_type"" 
AS

SELECT
  co.order_id,
  CASE WHEN length(pr.preview_name)>2 THEN pr.preview_name ELSE null END as preview_name,
  CASE
      WHEN co.customer_preview_id is not null AND co.preview_id is null THEN 'Customer Preview'
      ELSE pr.preview_type
  END as preview_type,
  co.order_state_number as state,
  CASE 
    WHEN co.date_invoiced is not null then 1
    ELSE 0
  END AS invoiced_order,
  co.box_type,
  co.order_type,
  co.sales_channel,
  co.shipping_country,
  co.sales_channel_special,
  co.revenue_state,
  cast(co.date_invoiced as date) as date_invoiced,
  cast(co.date_created as date) as date_created,
  cast(co.date_incoming as date) as date_incoming,
  co.articles_sent as total_articles,
  co.sales_sent as total_gross_retail_basket_in_eur,
  rq.returned_gross_retail_basket_in_eur,
  rq.kept_gross_retail_basket_in_eur,
  case 
  	when co.sales_sent=0 then null
  	when rq.returned_gross_retail_basket_in_eur=0 then null
  	else rq.returned_gross_retail_basket_in_eur/co.sales_sent
  end as return_rate,
  co.billing_net_sales as total_net_sales_in_eur,
  lim_look.limited_look,
  vi.visits
FROM bi.customer_order co
LEFT JOIN
(
	SELECT
		order_id,
		  case when co.revenue_state='Final' then co.sales_returned else 0 end as returned_gross_retail_basket_in_eur,
		  case when co.revenue_state='Final' then co.sales_kept else 0 end as kept_gross_retail_basket_in_eur
	FROM ""bi.customer_order""  co
)rq on rq.order_id=co.order_id
LEFT JOIN raw.previews pr on pr.preview_id = co.preview_id
/*this join is to get if the customer came from facebook campaign, order is created based on ready outfit (limited-look=look[1-8])*/
LEFT JOIN
(
    SELECT 
      c.customer_id,
      c.additional_info as limited_look
    FROM raw.customer c
    WHERE c.additional_info like '{limited-look%'
)lim_look on lim_look.customer_id=co.customer_id
/*Number of Visits*/
LEFT JOIN
(
  SELECT
    co.order_type, 
    visits, 
    min(co.order_id) min_order_id
  FROM bi.customer_order co
  left join 
  (
    SELECT 
      date_created  as ""date"",
      sum(visits) as visits
    FROM bi.marketing_funnel_by_date_domain_channel_device
    GROUP by 1
  )at on at.""date""=cast(co.date_created as date)
  GROUP BY 1,2
)vi on vi.min_order_id=co.order_id"	READY
32,841	2015-04-29 18:58:13	"1112787901"	true	2015-04-29 18:58:13	tableau.doc_data_transmission		"CREATE VIEW tableau.doc_data_transmission
AS

SELECT
	a.orderid,
	a.date_of_trasmission
FROM
(
	SELECT 
		sl.orderid,
		sl.date_created as date_of_trasmission,
		row_number() over (partition by sl.orderid order by sl.date_created) as rnum
	FROM postgres.doc_data_sales_order_line sl
)a
WHERE a.rnum=1"	READY
262,146	2015-06-29 15:10:24	"1112787981"	true	2015-06-30 12:29:26	raw.supplier_article		"CREATE VIEW raw.supplier_article AS 

SELECT
	""id"", ""version"", ""article_id"", ""date_created"", ""last_updated"", ""retail_price"", ""sku"", ""supplier_id"", ""purchase_price"", ""quantity"", 
	LEFT(CAST(""data"" AS STRING),4000) data, ""active"", ""ean"", ""image_url"", ""partner_shop_url"", ""manufacturer_sku""

FROM
	postgres.supplier_article"	READY
372	2015-04-24 18:23:35	"1127038914"	true	2015-08-07 14:00:12	tableau.accounting_order_report_with_adjusted_rr_ch_open_orders		"CREATE view tableau.accounting_order_report_with_adjusted_rr_ch_open_orders
AS
SELECT 
	op.order_id,
	co.customer_id,
	co.invoice_date_created,
	co.date_shipped,
	co.date_created,
	cu.date_created as customer_date_created,
	co.shipping_country,
	co.vat_percentage,
	co.currency_code,
    co.box_type,
	co.total_amount_billed_discount_euro,
	co.total_goodwill_credit_euro,
    co.total_amount_paid_euro,
	co.order_type,
	co.date_payed,
	co.payment_method,
	co.date_returned,
	co.first_saleschannel_completed,
	0.715 as return_rate_3_weeks,
	op.articles_sent,
	op.articles_sent_os,
	op.articles_sent_ps,
	op.articles_kept,
	op.articles_kept_os,
	op.articles_kept_ps,
	op.total_basket_purchase_price,
	op.total_amount_basket_purchase_gross_patner,
	op.total_amount_basket_purchase_gross_own,
	op.total_basket_retail_price,
	op.total_amount_basket_retail_gross_patner,
	op.total_amount_basket_retail_gross_own,
	op.retoure_value_purchase_price,
	op.return_purchase_gross_patner,
	op.return_purchase_gross_own,
	op.retoure_value,
	op.return_retail_gross_patner,
	op.return_retail_gross_own,
	op.gross_lost_purchase,
	op.gross_lost_purchase_patner,
	op.gross_lost_purchase_own,
	op.gross_lost_retail,
	op.gross_lost_retail_patner,
	op.gross_lost_retail_own,
	arv.paid_to_arvato,
	arv.arvato_paid_date,
/*Campaign Details*/
  ca.code as campaign_code,
  ca.campaign_title,
  ca.currency as campaign_currency
FROM views.customer_order co
LEFT JOIN views.customer cu on cu.customer_id=co.customer_id
/*Order Position KPI's*/
INNER JOIN 
(
	SELECT 
		op.order_id,
		/*Articles Sent*/
		count(DISTINCT CASE WHEN op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent"",
		count(DISTINCT CASE WHEN stock_location_id = 2 AND op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent_os"",
		count(DISTINCT CASE WHEN stock_location_id <> 2 AND op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent_ps"",
		/*Article Kept*/
		count(DISTINCT CASE WHEN op.state=1024 then op.id else null end) as ""articles_kept"",
		count(DISTINCT CASE WHEN stock_location_id = 2 AND op.state=1024 then op.id else null end) as ""articles_kept_os"",
		count(DISTINCT CASE WHEN stock_location_id <> 2 AND op.state= 1024 then op.id else null end) as ""articles_kept_ps"",
		/*Basket Purchase Price*/
		SUM(CASE WHEN op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end) total_basket_purchase_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end)  as total_amount_basket_purchase_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end) as total_amount_basket_purchase_gross_own,
		/*basket Retail Price*/
		SUM(CASE WHEN op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) total_basket_retail_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_own,
		/*Return Purchase Price*/
		SUM(CASE WHEN op.state=512 then quantity*op.purchase_price else 0 end) retoure_value_purchase_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=512 then quantity*op.purchase_price else 0 end)  as return_purchase_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=512 then quantity*op.purchase_price else 0 end) as return_purchase_gross_own,
		/*Return Retail Price*/
		SUM(CASE WHEN op.state=512 then quantity*op.retail_price_euro else 0 end) retoure_value,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=512 then quantity*op.retail_price_euro else 0 end) as return_retail_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=512 then quantity*op.retail_price_euro else 0 end) as return_retail_gross_own,
		/*Lost Purchase Price*/
		SUM(CASE WHEN op.state=1536 then op.quantity*op.purchase_price else 0 end) gross_lost_purchase,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=1536 then op.quantity*op.purchase_price else 0 end)  as gross_lost_purchase_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=1536 then op.quantity*op.purchase_price else 0 end) as gross_lost_purchase_own,
		/*Lost Retail Price*/
		SUM(CASE WHEN op.state=1536 then op.quantity*op.retail_price_euro else 0 end) gross_lost_retail,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_own
		FROM views.order_position op
		where op.state<2048
		GROUP BY 1
)op on op.order_id=co.id
/*Return Rate Per Country
LEFT JOIN
(
	SELECT 
	shipping_country,
	CASE 
		WHEN shipping_country in('SE','DK','BE','LU') then 0.75
                WHEN shipping_country='CH' then 0.70 
		else return_rate_3_weeks 
	end as return_rate_3_weeks 
	FROM(
			SELECT 
			shipping_country, 
			CASE WHEN total_basket_retail_price=0 then 0 
			else return_retail_price/total_basket_retail_price 
			end as return_rate_3_weeks 
			FROM(
				SELECT
					co.shipping_country,
					SUM(CASE WHEN op.state=512 then quantity*op.retail_price_euro else 0 end) return_retail_price,
					SUM(CASE WHEN co.state=1024 AND op.state<=1024 then quantity*op.retail_price_euro else 0 end) total_basket_retail_price
				FROM views.order_position op
				INNER JOIN views.customer_order co on co.id=op.order_id
				WHERE cast(co.invoice_date_created as date)>=timestampadd(sql_tsi_month,-3,timestampadd(sql_tsi_day,-14,curdate())) AND
				cast(co.invoice_date_created as date)<=timestampadd(sql_tsi_day,-14,curdate())
			GROUP BY 1)
		a)
b)ret on ret.shipping_country=co.shipping_country*/
LEFT JOIN
(
	SELECT 
		ordernumber,
		sum(amount) as paid_to_arvato,
		max(cast(date_created as date)) as arvato_paid_date
	FROM views.arvatopayments
	group by 1
)arv on arv.ordernumber=co.id
LEFT JOIN views.campaign ca on ca.id=co.campaign_id
WHERE cast(co.invoice_date_created as date)>='2014-01-01' AND
co.order_state='Real Order' AND co.state<=1024"	READY
32,779	2015-04-27 17:51:50	"1112787887"	true	2015-04-28 17:53:10	ml.stylist_order_time		"CREATE VIEW ml.stylist_order_time AS
SELECT
	atl.order_id,
   	atl.customer_id,
	atl.stylist_id,
	atl.time_spent_on_order,
	atl.start_time,
	atl.finish_time,
	atl.box_type
FROM
(SELECT DISTINCT
	aa.order_id,
   	co.customer_id,
	ato.stylist_id,
	aa.time_spent_on_order,
	aa.start_time,
	aa.finish_time,
	co.box_type,
	ROW_NUMBER() OVER (PARTITION BY aa.order_id ORDER BY aa.time_spent_on_order DESC) AS rk
FROM
(SELECT
   	a.order_id,
   	TIMESTAMPDIFF(SQL_TSI_MINUTE, MIN(a.date), MAX(a.date)) AS time_spent_on_order,
   	MIN(a.date) AS start_time,
 	MAX(a.date) AS finish_time
FROM
  	(SELECT
  		*
  	 FROM ml.action_tracking AS at
     	WHERE at.action IN ('ARTICLE_ADD', 'ARTICLE_REMOVE', 'INITIAL', 'SEARCH', 'PHONE_INTERFACE_START'))
     AS a
GROUP BY a.order_id) AS aa
JOIN ml.action_tracking AS ato
	ON ato.order_id = aa.order_id
JOIN bi.customer_order AS co
	ON co.order_id = aa.order_id) AS atl
WHERE atl.rk = 1
  AND atl.start_time > '2015-04-01'"	READY
167	2015-04-24 18:18:01	"652119350"	true	2015-04-27 14:53:35	am.color_mapping		"CREATE VIEW ""am.color_mapping"" AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.color_mapping.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""pim_model_id"" STRING ,
		""brand"" STRING ,
		""supplier_color_code"" STRING ,
		""color1"" STRING ,
		""color_code_erp"" STRING ,
		""key"" STRING 
		DELIMITER ',' 
		QUOTE '""' 
		HEADER 1 
	)
""csv_table"""	READY
131,096	2015-05-20 14:23:34	"1112787936"	true	2015-05-20 15:32:08	raw.customer_state_change		"CREATE view raw.customer_state_change
AS

with audit as
(
	SELECT 
		persisted_object_id AS order_id,
		old_value,
		new_value,
		max(date_created) as date_created
	FROM postgres.audit_log 
	where property_name='state'
	group by 1,2,3
)
SELECT
	order_id,
	MAX(CASE WHEN old_value=4 AND new_value=8 THEN date_created ELSE NULL END) AS date_created_8,
	MAX(CASE WHEN old_value=8 AND new_value=16 THEN date_created ELSE NULL END) AS date_created_16,
	MAX(CASE WHEN old_value=16 AND new_value=24 THEN date_created ELSE NULL END) AS date_created_24,
	MAX(CASE WHEN old_value=16 AND new_value=128 THEN date_created ELSE NULL END) AS date_created_16_128,
	MAX(CASE WHEN old_value=24 AND new_value=128 THEN date_created ELSE NULL END) AS date_created_24_128,
	MAX(CASE WHEN old_value=128 AND new_value=256 THEN date_created ELSE NULL END) AS date_created_256,
	/*Returned*/
	MAX(CASE WHEN old_value=128 AND new_value=384 THEN date_created ELSE NULL END) AS date_created_128_384,	
	MAX(CASE WHEN old_value=128 AND new_value=512 THEN date_created ELSE NULL END) AS date_created_128_512,	
	MAX(CASE WHEN old_value=256 AND new_value=512 THEN date_created ELSE NULL END) AS date_created_256_512,
	MAX(CASE WHEN old_value=384 AND new_value=512 THEN date_created ELSE NULL END) AS date_created_384_512,
	/*Completed*/
	MAX(CASE WHEN old_value=128 AND new_value=1024 THEN date_created ELSE NULL END) AS date_created_128_1024,
	MAX(CASE WHEN old_value=256 AND new_value=1024 THEN date_created ELSE NULL END) AS date_created_256_1024,
	MAX(CASE WHEN old_value=512 AND new_value=1024 THEN date_created ELSE NULL END) AS date_created_512_1024,
	/*Cancelled*/
	MAX(CASE WHEN old_value=8 AND new_value=2048 THEN date_created ELSE NULL END) AS date_created_2048
FROM audit
GROUP BY 1"	READY
131,103	2015-05-21 11:52:31	"1112787937"	true	2015-07-31 09:45:41	tableau.mgmt_cm2_cohort_analysis_costs		"CREATE VIEW tableau.mgmt_cm2_cohort_analysis_costs
AS

SELECT
  con.order_id,
  con.customer_id,
  con.order_state,
  con.revenue_state,
  con.payment_state,
  con.shipping_country,
  con.order_type,
  con.sales_sent,
  con.sales_kept,
  con.discount_total,
  con.billing_total,
  con.billing_net_sales,
  con.sales_kept * cogs.percentage_cost cost_kept_calc,
  con.cost_kept,
  co.first_box_type,
  co.first_saleschannel_completed,
  mc.first_channel as first_marketing_channel,
  c.first_order_date_completed as date_created_first_order,
  cu.customer_age,
  con.date_invoiced,
  con.date_shipped,
  con.date_created,
  con.order_state_number,
  TIMESTAMPDIFF(SQL_TSI_DAY, c.first_order_date_completed, con.date_created)/30 as months_since_first_order,
  dirc.payment_cost_per_order,
  dirc.service_cost_per_order,
  dirc.logistics_cost_per_order
FROM bi.customer_order con
JOIN views.customer c on c.customer_id = con.customer_id
JOIN views.customer_order co on co.id = con.order_id
LEFT JOIN views.marketing_customer mc on mc.customer_id = co.customer_id
LEFT JOIN bi.customer cu on cu.customer_id = co.customer_id
LEFT JOIN 
(
SELECT
  ccd.year_month,
  ccd.country_code,
  SUM(CASE WHEN ccd.cost_type='payment' then ccd.cost ELSE NULL END) AS payment_cost_per_order,
  SUM(CASE WHEN ccd.cost_type='service' then ccd.cost ELSE NULL END) AS service_cost_per_order,
  SUM(CASE WHEN ccd.cost_type='logistics' then ccd.cost ELSE NULL END) AS logistics_cost_per_order
FROM dwh.company_cost_cohort ccd
GROUP BY 1,2
)dirc on dirc.country_code=co.shipping_country and dirc.year_month=left(c.first_order_date_completed,7)
JOIN /* Take COGs % from last 31 days. We will apply this to all orders, so that we are not biased against old cohorts due to high partner stock usage */
(
  SELECT
  shipping_country,
  sum(cost_kept)/sum(sales_kept) as percentage_cost
  FROM bi.customer_order co
  WHERE co.date_invoiced > TIMESTAMPADD(SQL_TSI_DAY, -31, CURDATE())
  GROUP BY 1
) cogs on cogs.shipping_country = co.shipping_country
WHERE con.order_state_number >= 128 
AND con.order_state_number < 2048
AND con.is_real_order = 'Real Order'

/* This UNION SELECT adds in dummy data so that we can draw nice cohorts charts for old cohorts that have very sparse data */
UNION SELECT
  null as order_id,
  null as customer_id,
  'Completed' as order_state,
  'Final' as revenue_state,
  null as payment_state,
  shipping_country,
  null as order_type,
  null as sales_sent,
  null as sales_kept,
  null as discount_total,
  null as billing_total,
  null as billing_net_sales,
  null as cost_kept_calc,
  null as cost_kept,
  first_box_type,
  null as first_saleschannel_completed,
  first_marketing_channel,
  fo.date as date_created_first_order,
  null as customer_age,
  null as date_invoiced,
  null as date_shipped,
  o.date as date_created,
  null as order_state_number,
  TIMESTAMPDIFF(SQL_TSI_DAY, fo.date, curdate())/30 as months_since_first_order,
  null as payment_cost_per_order,
  null as service_cost_per_order,
  null as logistics_cost_per_order
FROM dwh.calendar fo
JOIN dwh.calendar o on o.date > fo.date AND o.date < curdate()
CROSS JOIN (SELECT 'Call Box' as first_box_type UNION SELECT 'No Call Box' as first_box_type) x
CROSS JOIN (SELECT distinct shipping_country FROM bi.customer_order) y
CROSS JOIN (SELECT distinct first_channel as first_marketing_channel FROM views.marketing_customer) z
WHERE fo.date > '2012-02' and fo.date < curdate()
AND fo.day_of_month = 1
AND o.day_of_month = 1"	READY
196,609	2015-05-22 16:21:39	"1112787942"	true	2015-06-10 12:22:14	bi.own_stock_monthly		"CREATE VIEW bi.own_stock_monthly AS

/* This is a rollup to monthly level of the own stock data to reduce the data size of older records; used in tableau.data_source_own_stock */

SELECT
	own.article_id,
	TIMESTAMPADD(SQL_TSI_DAY, 1-DAYOFMONTH(own.date_created), own.date_created) AS date_created,
	MAX(CASE 
		WHEN own.date_created = TIMESTAMPADD(SQL_TSI_DAY, 1-DAYOFMONTH(own.date_created), own.date_created)
		THEN own.stock_beg 
	END) stock_beg,
	MAX(CASE 
		WHEN own.date_created = TIMESTAMPADD(SQL_TSI_DAY, -1, TIMESTAMPADD(SQL_TSI_MONTH, 1, TIMESTAMPADD(SQL_TSI_DAY, -DAYOFMONTH(own.date_created)+1, own.date_created)))
		THEN own.stock_end
	END) stock_end,
	MAX(CASE 
		WHEN own.date_created = TIMESTAMPADD(SQL_TSI_DAY, 1-DAYOFMONTH(own.date_created), own.date_created) 
		THEN own.reserved_beg 
	END) reserved_beg,	
	MAX(CASE 
		WHEN own.date_created = TIMESTAMPADD(SQL_TSI_DAY, -1, TIMESTAMPADD(SQL_TSI_MONTH, 1, TIMESTAMPADD(SQL_TSI_DAY, -DAYOFMONTH(own.date_created)+1, own.date_created)))
		THEN own.reserved_end
	END) reserved_end,
	

	/*Stock movements FROM stock_mutation */
	CAST(SUM(own.po_bookings) AS SMALLINT) po_bookings,
	ROUND(AVG(own.po_article_sales_price),2) AS po_article_sales_price,
	ROUND(AVG(own.po_article_cost),2) AS po_article_cost,
	CAST(SUM(own.supplier_returns) AS SMALLINT) supplier_returns,

	/*Deliveries AND returns FROM purchase_order ow only*/
	CAST(SUM(own.poa_initial_qty) AS INTEGER) poa_initial_qty,
	SUM(own.poa_intial_qty_sales) poa_intial_qty_sales,
	SUM(own.poa_intial_qty_cost) poa_intial_qty_cost,
	CAST(SUM(own.poa_revised_qty) AS INTEGER) poa_revised_qty,
	SUM(own.poa_revised_qty_sales) poa_revised_qty_sales,
	SUM(own.poa_revised_qty_cost) poa_revised_qty_cost,
	CAST(SUM(own.poa_booked_qty) AS INTEGER) poa_booked_qty,
	SUM(own.poa_booked_qty_sales) poa_booked_qty_sales,
	SUM(own.poa_booked_qty_cost) poa_booked_qty_cost,
	MIN(own.poa_article_sales_price_min) poa_article_sales_price_min,
	MAX(own.poa_article_sales_price_max) poa_article_sales_price_max,
	ROUND(CASE WHEN SUM(own.poa_booked_qty) > 0 THEN SUM(poa_booked_qty_sales) / SUM(own.poa_booked_qty) END, 2) AS poa_article_sales_price_avg,
	MIN(own.poa_article_cost_min) poa_article_cost_min,
	MAX(own.poa_article_cost_max) poa_article_cost_max,
	ROUND(CASE WHEN SUM(own.poa_booked_qty) > 0 THEN SUM(poa_booked_qty_cost) / SUM(own.poa_booked_qty) END, 2) AS poa_article_cost_avg,
	
	CAST(SUM(own.articles_sent) AS SMALLINT) articles_sent,
	CAST(SUM(own.articles_sent_at) AS SMALLINT) articles_sent_at,
	CAST(SUM(own.articles_sent_be) AS SMALLINT) articles_sent_be,
	CAST(SUM(own.articles_sent_ch) AS SMALLINT) articles_sent_ch,
	CAST(SUM(own.articles_sent_de) AS SMALLINT) articles_sent_de,
	CAST(SUM(own.articles_sent_dk) AS SMALLINT) articles_sent_dk,
	CAST(SUM(own.articles_sent_lu) AS SMALLINT) articles_sent_lu,
	CAST(SUM(own.articles_sent_nl) AS SMALLINT) articles_sent_nl,
	CAST(SUM(own.articles_sent_se) AS SMALLINT) articles_sent_se,
	
	SUM(own.sales_sent) sales_sent,
	ROUND(SUM(own.sales_sent) / SUM(own.articles_sent),2) sales_sent_avg,
	SUM(own.sales_sent_at) sales_sent_at,
	SUM(own.sales_sent_be) sales_sent_be,
	SUM(own.sales_sent_ch) sales_sent_ch,
	SUM(own.sales_sent_de) sales_sent_de,
	SUM(own.sales_sent_dk) sales_sent_dk,
	SUM(own.sales_sent_lu) sales_sent_lu,
	SUM(own.sales_sent_nl) sales_sent_nl,
	SUM(own.sales_sent_se) sales_sent_se,
	
	SUM(own.cost_sent) cost_sent,
	ROUND(SUM(own.cost_sent) / SUM(own.articles_sent),2) cost_sent_avg,
	SUM(own.cost_sent_at) cost_sent_at,
	SUM(own.cost_sent_be) cost_sent_be,
	SUM(own.cost_sent_ch) cost_sent_ch,
	SUM(own.cost_sent_de) cost_sent_de,
	SUM(own.cost_sent_dk) cost_sent_dk,
	SUM(own.cost_sent_lu) cost_sent_lu,
	SUM(own.cost_sent_nl) cost_sent_nl,
	SUM(own.cost_sent_se) cost_sent_se,
	
	CAST(SUM(own.articles_kept) AS SMALLINT) articles_kept,
	CAST(SUM(own.articles_kept_at) AS SMALLINT) articles_kept_at,
	CAST(SUM(own.articles_kept_be) AS SMALLINT) articles_kept_be,
	CAST(SUM(own.articles_kept_ch) AS SMALLINT) articles_kept_ch,
	CAST(SUM(own.articles_kept_de) AS SMALLINT) articles_kept_de,
	CAST(SUM(own.articles_kept_dk) AS SMALLINT) articles_kept_dk,
	CAST(SUM(own.articles_kept_lu) AS SMALLINT) articles_kept_lu,
	CAST(SUM(own.articles_kept_nl) AS SMALLINT) articles_kept_nl,
	CAST(SUM(own.articles_kept_se) AS SMALLINT) articles_kept_se,
	
	SUM(own.sales_kept) sales_kept,
	ROUND(SUM(own.sales_kept) / SUM(own.articles_kept),2) sales_kept_avg,
	SUM(own.sales_kept_at) sales_kept_at,
	SUM(own.sales_kept_be) sales_kept_be,
	SUM(own.sales_kept_ch) sales_kept_ch,
	SUM(own.sales_kept_de) sales_kept_de,
	SUM(own.sales_kept_dk) sales_kept_dk,
	SUM(own.sales_kept_lu) sales_kept_lu,
	SUM(own.sales_kept_nl) sales_kept_nl,
	SUM(own.sales_kept_se) sales_kept_se,
	
	SUM(own.cost_kept) cost_kept,
	ROUND(SUM(own.cost_kept) / SUM(own.articles_kept),2) cost_kept_avg,
	SUM(own.cost_kept_at) cost_kept_at,
	SUM(own.cost_kept_be) cost_kept_be,
	SUM(own.cost_kept_ch) cost_kept_ch,
	SUM(own.cost_kept_de) cost_kept_de,
	SUM(own.cost_kept_dk) cost_kept_dk,
	SUM(own.cost_kept_lu) cost_kept_lu,
	SUM(own.cost_kept_nl) cost_kept_nl,
	SUM(own.cost_kept_se) cost_kept_se,
	
	CAST(SUM(own.articles_returned) AS SMALLINT) articles_returned,
	CAST(SUM(own.articles_returned_at) AS SMALLINT) articles_returned_at,
	CAST(SUM(own.articles_returned_be) AS SMALLINT) articles_returned_be,
	CAST(SUM(own.articles_returned_ch) AS SMALLINT) articles_returned_ch,
	CAST(SUM(own.articles_returned_de) AS SMALLINT) articles_returned_de,
	CAST(SUM(own.articles_returned_dk) AS SMALLINT) articles_returned_dk,
	CAST(SUM(own.articles_returned_lu) AS SMALLINT) articles_returned_lu,
	CAST(SUM(own.articles_returned_nl) AS SMALLINT) articles_returned_nl,
	CAST(SUM(own.articles_returned_se) AS SMALLINT) articles_returned_se,
		
	SUM(own.sales_returned) sales_returned,
	ROUND(SUM(own.sales_returned) / SUM(own.articles_returned),2) sales_returned_avg,
	SUM(own.sales_returned_at) sales_returned_at,
	SUM(own.sales_returned_be) sales_returned_be,
	SUM(own.sales_returned_ch) sales_returned_ch,
	SUM(own.sales_returned_de) sales_returned_de,
	SUM(own.sales_returned_dk) sales_returned_dk,
	SUM(own.sales_returned_lu) sales_returned_lu,
	SUM(own.sales_returned_nl) sales_returned_nl,
	SUM(own.sales_returned_se) sales_returned_se,
		
	SUM(own.cost_returned) cost_returned,
	ROUND(SUM(own.cost_returned) / SUM(own.articles_returned),2) cost_returned_avg,
	SUM(own.cost_returned_at) cost_returned_at,
	SUM(own.cost_returned_be) cost_returned_be,
	SUM(own.cost_returned_ch) cost_returned_ch,
	SUM(own.cost_returned_de) cost_returned_de,
	SUM(own.cost_returned_dk) cost_returned_dk,
	SUM(own.cost_returned_lu) cost_returned_lu,
	SUM(own.cost_returned_nl) cost_returned_nl,
	SUM(own.cost_returned_se) cost_returned_se,
		
	CAST(SUM(own.articles_lost) AS SMALLINT) articles_lost,
	SUM(own.cost_lost) cost_lost,
	SUM(own.sales_lost) sales_lost,
		
	CAST(SUM(own.virtual_stock_articles_sent) AS SMALLINT) virtual_stock_articles_sent,
	SUM(own.virtual_stock_sales_sent) virtual_stock_sales_sent,
	SUM(own.virtual_stock_cost_sent) virtual_stock_cost_sent,
	ROUND(SUM(own.virtual_stock_sales_sent) / SUM(own.virtual_stock_articles_sent),2) virtual_stock_sales_sent_avg,
	ROUND(SUM(own.virtual_stock_cost_sent) / SUM(own.virtual_stock_articles_sent),2) virtual_stock_cost_sent_avg
	
FROM 
	bi.own_stock own
GROUP BY 1,2"	READY
196,611	2015-05-22 16:50:33	"1112787944"	true	2015-06-30 18:25:55	bi.stock_levels_history		"CREATE view bi.stock_levels_history AS

/* this needs to run after the previous updates; so 00:40 */

SELECT 
	beg.date_created, 
	CAST(beg.article_id AS BIGINT) AS article_id,
	CAST(beg.quantity AS SMALLINT) AS stock_beg,
	CAST(beg.reserved AS SMALLINT) AS reserved_beg,
	CAST(ending.quantity AS SMALLINT) AS stock_end,
	CAST(ending.reserved AS SMALLINT) AS reserved_end
FROM
	( /* following is effectively the beginning numbers for a day;
		dwh.stock_entry_history has an insert performed daily at 00:30 */
		SELECT
			date_created,
			sku AS article_id,
			quantity AS quantity, 
			reserved AS reserved
		FROM dwh.stock_entry_history
	) AS beg
	
	JOIN
	/* following is effectively the ending numbers*/
	(	/* the snapshot is taken daily at 00:30 */
		SELECT 
			CURDATE() AS date_created,
			article_id,
			quantity AS quantity, 
			reserved AS reserved
		FROM 
			raw.stock_levels_daily_snapshot
		
		UNION
		/* dwh.stock_entry_history has an insert performed daily at 00:30 */
		SELECT 
			TIMESTAMPADD(SQL_TSI_DAY, -1, date_created) AS date_created,
			sku AS article_id,
			quantity AS quantity, 
			reserved AS reserved
		FROM 
			dwh.stock_entry_history
	) AS ending
		 ON beg.date_created = ending.date_created 
		AND beg.article_id	= ending.article_id
WHERE
		beg.article_id 		!= 'null'
	AND ending.article_id 	!= 'null'
	/*
	the following filter will remove 2/3 of the rows since that are all zeros; that's currently 20M/30M
	AND COALESCE(beg.quantity,0) + COALESCE(beg.reserved,0) + COALESCE(ending.quantity,0) + COALESCE(ending.reserved,0) > 0
	*/"	READY
917,509	2015-09-28 16:52:40	"1383765096"	true	2015-09-28 16:52:40	datamart.fact_order		"/********************************************************************************************** 
-- Author       Hemanth 
-- Created      2015-07-01 
-- Purpose      This view joins tables from raw and datamart schema, this view has all kpi's aggregated 
                on customer_id 
-- Tables       datamart.dim_order,datamart.dim_case,datamart.fact_order 
-------------------------------------------------------------------------------------------------- 
-- Modification History 
 
-- Date          Author      Description 
-- 2015-09-16    Hemanth     1) Header for query 
-- 2015-09-16    Hemanth     1) Added est_goodwill to nsexp_in_eur,nsexp_in_local_curreny
               gsexp_in_local_currency and gsexp_in_eur
               2) Added 2 columns for discount_marketing
**************************************************************************************************/ 
CREATE VIEW datamart.fact_order 
AS 
 
SELECT 
  op_1.order_id, 
   
  op_1.items_b4_can AS itb4canc, 
  op_1.items_cancelled AS itcan, 
  op_1.items_b4_ret AS itb4ret, 
  op_1.items_returned AS itret, 
  op_1.items_returned_est AS estitret, 
  COALESCE(op_1.items_kept,op_1.items_kept_est) AS itexp, 
 
  /*Gross Sales In euros*/ 
  op_1.gross_sales_b4_can_in_eur AS gsb4canc_in_eur, 
  op_1.gross_sales_can_in_eur AS gscanc_in_eur, 
  op_1.gross_sales_b4_ret_in_eur AS gsb4ret_in_eur, 
  op_1.gross_sales_ret_in_eur AS gret_in_eur, 
  fo_1.goodwill_in_eur AS ggood_in_eur, 
  op_1.gross_sales_ret_est_in_eur AS estgret_in_eur,
  fo_1.est_goodwill_in_eur,
  COALESCE(op_1.sales_kept_in_eur,op_1.sales_kept_est_in_eur)-fo_1.est_goodwill_in_eur AS gsexp_in_eur, 
  /*Net Sales*/ 
  op_1.gross_sales_b4_can_in_eur/(1+v.vat_rate) AS nsb4canc_in_eur, 
  op_1.gross_sales_can_in_eur/(1+v.vat_rate) AS nscanc_in_eur, 
  op_1.gross_sales_b4_ret_in_eur/(1+v.vat_rate) AS nsb4ret_in_eur, 
  op_1.gross_sales_ret_in_eur/(1+v.vat_rate) AS nret_in_eur, 
  fo_1.goodwill_in_eur/(1+v.vat_rate) AS ngood_in_eur, 
  op_1.gross_sales_ret_est_in_eur/(1+v.vat_rate) AS estnret_in_eur,
  fo_1.est_goodwill_in_eur/(1+v.vat_rate) AS estngood_in_eur,
  (COALESCE(op_1.sales_kept_in_eur,op_1.sales_kept_est_in_eur)-fo_1.est_goodwill_in_eur)/(1+v.vat_rate) AS nsexp_in_eur, 
   
  /*Gross Sales in Local Currency*/ 
  op_1.gross_sales_b4_can_in_local_currency  AS gsb4canc_in_local_currency, 
  op_1.gross_sales_can_in_local_currency AS gscanc_in_local_currency, 
  op_1.gross_sales_b4_ret_in_local_currency AS gsb4ret_in_local_currency, 
  op_1.gross_sales_ret_in_local_currency AS gret_in_local_currency, 
  fo_1.goodwill_in_local_currency AS ggood_in_local_currency, 
  op_1.gross_sales_ret_est_in_local_currency AS estgret_in_local_currency,
  fo_1.est_goodwill_in_local_currency as estggood_in_local_currency,
  COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency)-fo_1.est_goodwill_in_local_currency AS gsexp_in_local_currency, 
  /*Net Sales in Local Currency*/ 
  op_1.gross_sales_b4_can_in_local_currency/(1+v.vat_rate) AS nsb4canc_in_local_currency, 
  op_1.gross_sales_can_in_local_currency/(1+v.vat_rate) AS nscanc_in_local_currency, 
  op_1.gross_sales_b4_ret_in_local_currency/(1+v.vat_rate) AS nsb4ret_in_local_currency, 
  op_1.gross_sales_ret_in_local_currency/(1+v.vat_rate) AS nret_in_local_currency, 
  fo_1.goodwill_in_local_currency/(1+v.vat_rate) AS ngood_in_local_currency, 
  op_1.gross_sales_ret_est_in_local_currency/(1+v.vat_rate) AS estnret_in_local_currency,
  fo_1.est_goodwill_in_local_currency/(1+v.vat_rate) as estngood_in_local_currency, 
  (COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency)-fo_1.est_goodwill_in_local_currency)/(1+v.vat_rate) AS nsexp_in_local_currency, 
   
  op_1.cogb4canc, 
  op_1.cogcanc, 
  op_1.cogb4ret, 
  op_1.cogret, 
  op_1.Estcogret, 
  COALESCE(op_1.cogs_kept,op_1.cogs_kept_est) AS cogexp, 
 
  fo_1.discount_in_local_currency as netdisc_in_local_currency,
  fo_1.discount_in_eur as netdisc_in_eur,
  fo_1.est_discount_in_local_currency as estnetdisc_in_local_currency,
  fo_1.est_discount_in_eur as estnetdisc_in_eur,

  co_2.date_amount_paid, 
  CASE   
      WHEN COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total < 0 THEN 0  
      ELSE COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total  
    END AS billing_total, 
    co_2.billing_received, 
    CASE   
      WHEN COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total < 0 THEN 0  
      ELSE COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total 
    END - co_2.billing_received AS billing_open, 
 
    CASE   
      WHEN COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total < 0 THEN 0  
      ELSE COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total 
    END * (v.vat_rate/(1 + v.vat_rate)) AS billing_vat,  
    CASE   
     
      WHEN COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total < 0 THEN 0  
      ELSE COALESCE(op_1.sales_kept_in_local_currency,op_1.sales_kept_est_in_local_currency) - co_1.discount_total 
    END / (1 + v.vat_rate) AS billing_net_sales 
FROM raw.fact_order op_1
LEFT JOIN raw.dim_customer_order co_1 on co_1.order_id=op_1.order_id 
LEFT JOIN dwh.historical_exchange_rates e on e.currency_code = co_1.country_code_iso AND cast(co_1.date_invoiced AS date) = e.date 
LEFT JOIN dwh.calendar c on c.date = cast(co_1.date_invoiced AS date) 
LEFT JOIN dwh.vat_rates v on v.year_month = c.year_month AND co_1.shipping_country = v.country_code_iso 
LEFT JOIN
(
  SELECT
    fo.order_id,
    fo.goodwill_in_local_currency,
    fo.goodwill_in_eur,
    fo.discount_in_local_currency,
    fo.discount_in_eur,
    CASE 
      WHEN fo.items_returned=fo.items_b4_ret AND fo.goodwill_in_local_currency IS NOT NULL THEN 0 
      ELSE fo.goodwill_in_local_currency
    END AS est_goodwill_in_local_currency,
    CASE 
      WHEN fo.items_returned=fo.items_b4_ret AND fo.goodwill_in_eur IS NOT NULL THEN 0 
      ELSE fo.goodwill_in_eur
    END AS est_goodwill_in_eur,
    CASE 
      WHEN fo.items_returned=fo.items_b4_ret AND fo.discount_in_local_currency IS NOT NULL THEN 0
      ELSE fo.discount_in_local_currency
    END AS est_discount_in_local_currency,
    CASE 
      WHEN fo.items_returned=fo.items_b4_ret AND fo.discount_in_eur IS NOT NULL THEN 0
      ELSE fo.discount_in_eur
    END AS est_discount_in_eur
  FROM raw.fact_order fo
)fo_1 ON fo_1.order_id=op_1.order_id
LEFT JOIN 
( 
  SELECT 
    c.order_id, 
    /*billing recieved arvato customers is uploaded in dwh from arvato ftp server*/ 
    COALESCE(CASE  
      WHEN c.payment_type<>'Arvato' THEN c.total_amount_payed 
      ELSE arv.billing_received_arvato 
    END,0) AS billing_received, 
    CASE 
      WHEN c.payment_type<>'Arvato' THEN c.date_paid 
      ELSE arv.date_arvato_paid 
    END AS date_amount_paid 
  FROM raw.dim_customer_order c 
  LEFT JOIN 
  ( 
    SELECT   
      ordernumber AS order_id,  
      MIN(date_created) AS date_arvato_paid,  
      SUM(amount) AS billing_received_arvato  
    FROM dwh.arvato_payments ap  
    GROUP BY 1  
  )arv on arv.order_id = c.order_id 
)co_2 on co_1.order_id=co_2.order_id"	READY
182	2015-04-24 18:18:05	"988772509"	true	2015-07-08 16:01:32	views.marketing_order		"CREATE view views.marketing_order
as
select
/* --------------------------------------------------- google analytics  --------------------------------------------------------------------------------- */
  case
    when ga.transaction_id is null and tv.order_id is not null then tv.order_id
    when ga.transaction_id is not null and tv.order_id is null then ga.transaction_id
    when ga.transaction_id is not null and tv.order_id is not null then ga.transaction_id
  end as ""order_id"",
  case
    when ga.transaction_id is null then 'not tracked by google analytics'
    else 'tracked by google analytics'
  end as ""tracked_by_google_analytics"",
  ga.source as ""utm_source"",
  ga.medium as ""utm_medium"",
  ga.source_medium as ""utm_source_medium"",
  ga.keyword as ""utm_keyword"",
  ga.campaign as ""utm_campaign"",
  ga.cam_bit_1 as ""utm_campaign_bit_1"",
  ga.cam_bit_2 as ""utm_campaign_bit_2"",
  ga.cam_bit_3 as ""utm_campaign_bit_3"",
  ga.cam_bit_4 as ""utm_campaign_bit_4"",
  ga.cam_bit_5 as ""utm_campaign_bit_5"",
  ga.cam_bit_6 as ""utm_campaign_bit_6"",
  ga.cam_bit_7 as ""utm_campaign_bit_7"",
  ga.cam_bit_8 as ""utm_campaign_bit_8"",
  ga.cam_bit_9 as ""utm_campaign_bit_9"",
  ga.cam_bit_10 as ""utm_campaign_bit_10"",
  ga.cam_bit_11 as ""utm_campaign_bit_11"",
  ga.cam_bit_12 as ""utm_campaign_bit_12"",
  ga.cam_bit_13 as ""utm_campaign_bit_13"",
  ga.cam_bit_14 as ""utm_campaign_bit_14"",
  ga.cam_bit_15 as ""utm_campaign_bit_15"",
  ga.cam_bit_16 as ""utm_campaign_bit_16"",
  ga.cam_bit_17 as ""utm_campaign_bit_17"",
  ga.cam_bit_18 as ""utm_campaign_bit_18"",
  ga.cam_bit_19 as ""utm_campaign_bit_19"",
  ga.cam_bit_20 as ""utm_campaign_bit_20"",
  ga.optimizely_campaign as ""optimizely_campaign"",
  ga.adcontent as ""utm_adcontent"",
  ga.referred_by_customer as ""referred_by_customer"",
  ga.referring_customer_token as ""referring_customer_token"",
  ga.device_category as ""device_category"",
  ga.operating_system as ""operating_system"",
  ga.operating_system_version as ""operating_system_version"",
  ga.browser as ""browser"",
  ga.browser_version as ""browser_version"",
  ga.java_enabled as ""java_enabled"",
  ga.flash_version as ""flash_version"",
  ga.mobile_device_branding as ""mobile_device_branding"",
  ga.mobile_device_model as ""mobile_device_model"",
  ga.mobile_device_info as ""mobile_device_info"",
  ga.screen_colors as ""screen_colors"",
  ga.screen_resolution as ""screen_resolution"",
  ga.visits_per_transactionid as ""visits_per_transaction_id"",
/* --------------------------------------------------- rapidape tv information --------------------------------------------------------------------------------- */
  case  
    when tv.order_id is null    then 'not flagged as tv'
    when tv.order_id is not null  then 'flagged as tv'
  end as ""flagged_as_tv"",
  tv.""date_spot_aired"" as ""tv_spot_date_aired"",
  tv.""timestamp_spot_aired"" as ""tv_spot_time_aired"",
  tv.tv_station as ""tv_spot_station"",
  tv.tv_program as ""tv_spot_program"",
  case
/* --------------------------------------------------- case marketing channel when tv is not flagged by rapidape ----------------------------------------------- */
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'affiliate' then 'affiliate'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'crm' then 'crm'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'display'      then 'display'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'facebook'       then 'facebook'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'google gdn'     then 'google gdn'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'kooperation'    then 'kooperation'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'praemienprogramm'   then 'praemienprogramm'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'remarketing'    then 'remarketing'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'twitter'      then 'twitter'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'youtube'      then 'youtube'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_3!=  'brand' then 'google sem nobrand'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_3= 'brand' then 'google sem brand'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_1= 'bing' and ga.cam_bit_1= '1' then 'google sem brand'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_1= 'bing' and ga.cam_bit_1= '0' then 'google sem nobrand'
    when tv.order_id is null and ga.channel= 'direct'       then 'direct'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= 'organic'      then 'organic'
    when tv.order_id is null and ga.cam_bit_1!= 'rem' and ga.channel= '(not set)'      then '(not set)'
    when tv.order_id is null and ga.cam_bit_1= 'rem'                    then 'remarketing'
/* --------------------------------------------------- case marketing channel when tv is flagged by rapidape --------------------------------------------------- */
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'affiliate'      then 'affiliate'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'crm'        then 'crm'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'display'      then 'display'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'facebook'       then 'facebook'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'google gdn'     then 'google gdn'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'kooperation'    then 'kooperation'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'praemienprogramm'   then 'praemienprogramm'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'remarketing'    then 'remarketing'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'twitter'      then 'twitter'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'youtube'      then 'youtube'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_3!=  'brand' then 'google sem nobrand'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_3= 'brand' then 'tv'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_1= 'bing' and ga.cam_bit_1= '0' then 'google sem nobrand'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_1= 'bing' and ga.cam_bit_1= '1' then 'tv'
    when tv.order_id is not null and ga.channel= 'direct'       then 'tv'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= 'organic'      then 'tv'
    when tv.order_id is not null and ga.cam_bit_1!= 'rem' and ga.channel= '(not set)'      then 'tv'
    when tv.order_id is not null and ga.cam_bit_1= 'rem'                    then 'remarketing'
    else '(not set)'
  end as ""marketing_channel"",
/* --------------------------------------------------- case marketing channel excluding tv (used for order distribution check - tv share) ---------------------- */ 
  case
    when ga.cam_bit_1!= 'rem' and ga.channel= 'affiliate'      then 'affiliate'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'crm'        then 'crm'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'display'      then 'display'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'facebook'     then 'facebook'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'google gdn'     then 'google gdn'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'kooperation'    then 'kooperation'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'praemienprogramm' then 'praemienprogramm'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'remarketing'    then 'remarketing'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'twitter'      then 'twitter'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'youtube'      then 'youtube'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_3!= 'brand'  then 'google sem nobrand'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_3= 'brand' then 'google sem brand'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_1= 'bing' and ga.cam_bit_1= '1' then 'google sem brand'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'google sem' and ga.cam_bit_1= 'bing' and ga.cam_bit_1= '0' then 'google sem nobrand'
    when ga.cam_bit_1!= 'rem' then 'direct'
    when ga.cam_bit_1!= 'rem' and ga.channel= 'organic'      then 'organic'
    when ga.cam_bit_1!= 'rem' and ga.channel= '(not set)'      then '(not set)'
    when ga.cam_bit_1= 'rem'                    then 'remarketing'
    else '(not set)'
  end as ""marketing_channel_excluding_tv""
from views.ga_information ga
full join views.marketingtv tv on ga.transaction_id = tv.order_id"	READY
196,626	2015-06-01 17:21:27	"1214090198"	true	2015-08-25 16:15:41	tableau.mkt_crm_customers		"CREATE VIEW tableau.mkt_crm_customers
AS

SELECT
	c.customer_id,
	c.email,
	c.first_name,
	c.last_name,
	c.token,
	c.default_domain,
    CASE WHEN c.gender = 'Male' THEN 'Herr' ELSE 'Frau' END as anrede,
    c.formal as du_sie,
	case
		when c.gender= 'Male' THEN 'Lieber'
		when c.gender= 'Female' THEN 'Liebe'
	end AS ""begruessung"",
	c.date_created,
	c.subscribe_status,
	c.subscribed_to_sms,
	c.phone_number,
  	co.order_id,
  	co.shipping_country,
  	co.shipping_first_name,
  	co.shipping_last_name,
  	co.sales_channel,
  	st.stylist,
  	st.first_name as stylist_firstname,
    st.last_name as stylist_lastname,
  	st_o.stylist as stylist_order,
  	st_o.first_name as stylist_firstname_order,
    st_o.last_name as stylist_lastname_order,
    do.funnel_status,
    do.last_order_date
from bi.customer c
LEFT JOIN bi.customer_order co on co.customer_id=c.customer_id
LEFT JOIN raw.customer_salesforce sal on sal.customer_id = c.customer_id
LEFT JOIN bi.stylist st on st.stylist_id=c.new_stylist_id
LEFT JOIN bi.stylist st_o on st_o.stylist_id=co.stylist_id
/* For deciding whether someone is a no-call dropoff */
LEFT JOIN
(
	SELECT 
	    cu.customer_id,
	    co.last_order_date,
	    CASE
	        WHEN co.last_delivery_date is not null THEN 'Invoiced order'
	        WHEN co.no_call_funnel_dropoffs > 0 THEN 'No-call dropoff'
	        WHEN co.website_funnel_dropoffs > 0 THEN 'Other dropoff'
	        ELSE 'Other'
	    END AS funnel_status
	FROM bi.customer cu
	LEFT JOIN
  	(
    	SELECT
		    customer_id,
		    MAX(date_invoiced) as last_delivery_date,
		    MAX(date_incoming) as last_order_date,
		    SUM(CASE WHEN sales_channel = 'websiteWithoutDateAndPendingConfirmation' THEN 1 ELSE 0 END) AS no_call_funnel_dropoffs,
		    SUM(CASE WHEN sales_channel = 'website' THEN 1 ELSE 0 END) AS website_funnel_dropoffs
    	FROM bi.customer_order
    	WHERE is_real_order='Real Order'
    	GROUP BY 1
  	) co ON co.customer_id = cu.customer_id
) do ON c.customer_id = do.customer_id
where c.email not like '%invalid%'"	READY
196,621	2015-05-28 17:38:11	"1218994914"	true	2015-08-26 09:15:31	tableau.stylist_feedback_caller		"CREATE VIEW tableau.stylist_feedback_caller
AS

SELECT 
  /*Customer Order details*/
  co.order_id,
  cu.customer_id,
  co.shipping_first_name,
  co.shipping_last_name,
  co.shipping_country,
  co.date_paid,
  co.order_state,
  co.shipping_zip,
  co.box_type,
  case when co.sales_sent=0 then 0 else co.sales_returned/co.sales_sent end as return_rate,
  co.billing_total,
  /*Customer Details*/
  cu.first_name,
  cu.last_name,
  cu.phone_number,
  cu.email,
  cu.formal as formal_or_informal,
  cu.customer_status,
  cu.club_member,
  cu.club_membership_type,
  cu.vip_customer,
  st.stylist,
  /*Salesforce Opportunity*/
  cos.date_feedback_call,
  cos.wrong_phone_number,
  cos.feedback_status,
  /*Salesforce Account*/
  cs.club_member_offer,
  cs.last_reactivation_result,
  cs.feedback_call_poll,
  cs.feedback_caller,
  cs.stylist_lead,
  cs.customer_source,

  a.nb_orders,
  a.last_delivery_date,
  a.customer_return_rate,

  b.first_order_date,
  b.first_order_date_completed

FROM bi.customer_order co
LEFT JOIN bi.customer cu on cu.customer_id=co.customer_id
LEFT JOIN raw.customer_order_salesforce cos on cos.order_id = co.order_id 
LEFT JOIN raw.customer_salesforce cs on cs.customer_id=co.customer_id
LEFT JOIN bi.stylist st on st.stylist_id=cu.new_stylist_id
LEFT JOIN 
(
  SELECT 
    customer_id,
    count(order_id) as nb_orders,
    max(date_shipped) as last_delivery_date,
    case when sum(sales_sent)=0 then 0 else sum(sales_returned)/sum(sales_sent) end as customer_return_rate
  FROM bi.customer_order
  GROUP BY 1
) a on a.customer_id = co.customer_id
LEFT JOIN (
  SELECT 
    co.customer_id,
    min(co.date_created) as first_order_date,
    min(CASE WHEN co.order_state = 'Completed' THEN co.date_created ELSE null END) as first_order_date_completed
  FROM bi.customer_order co 
  GROUP BY co.customer_id
) b on b.customer_id = co.customer_id
where co.order_state_number in (512,1024)"	READY
229,453	2015-06-26 14:10:43	"1089390973"	true	2015-07-30 12:20:12	raw.nav_item_materials		"CREATE VIEW raw.nav_item_materials 
AS

SELECT
	""Item No_"" AS item_no,
	imat.""Material Code"" AS material_code,
	imat.""Quantity _"" as quantity,
	mat.description AS material
FROM

	""nav_test.Outfittery GmbH$Item Material"" imat
	LEFT JOIN
	""nav_test.Outfittery GmbH$Material"" mat
		 ON imat.""material code"" = mat.code"	READY
360,452	2015-07-22 18:37:40	"1367726320"	true	2015-09-25 11:32:03	raw.return_rate_probability		"CREATE VIEW raw.return_rate_probability
AS

SELECT
   order_position_id,
   min(cast(return_probability as double)) as return_probability
FROM ""mlpg.order_position_return_rate_prediction""
group by 1"	READY
98,318	2015-05-13 10:03:39	"1112787928"	true	2015-05-13 10:03:39	raw.stock_levels_daily_snapshot		"CREATE VIEW raw.stock_levels_daily_snapshot AS 

/* 	this query takes an snapshot of the numbers in postgres.stock_entry at 00:30; effectively, it's the ending inventory
	of the prior day and the beginning inventory of the next day; postgres.stock_entry gets a nightly overwrite 
	with doc data data at 4AM; it then gets updated throughout the day */

SELECT 
	CURDATE() AS date_created, 
	CAST(sku AS INTEGER) AS article_id,
	CAST(quantity AS SMALLINT) AS quantity, 
	CAST(reserved AS SMALLINT) AS reserved
FROM 
	postgres.stock_entry se
WHERE
	stock_location_id = 2 /* outfittery/own stock */
	
	
/* original code

CREATE view raw.stock_entry 
AS 
SELECT 
	CAST(curdate() AS DATE) as date_created, 
	quantity, 
	reserved, 
	sku as article_id
FROM postgres.stock_entry se
WHERE stock_location_id=2
*/"	READY
524,288	2015-08-11 16:06:49	"1383765187"	true	2015-09-28 17:25:49	tableau.cvr_dashboard_overview_second_step		"CREATE VIEW tableau.cvr_dashboard_overview_second_step
AS

SELECT
   order_id,
   CAST(co.date_created as date) as date_created,
   shipping_country as country,
   order_type,
   box_type,
   sales_channel,
   cu.customer_age,
   cu.age_group,
   CASE 
      WHEN ga.device_category is null THEN 'unknown'
      ELSE ga.device_category
   END as device_category,

   CASE 
      WHEN date_incoming is not null 
         AND co.order_state_number >= 8
      THEN 1
      WHEN co.order_state_number >= 16 THEN 1
      ELSE 0 
   END as confirmed_opportunity,

   CASE 
      WHEN date_stylist_picked is not null
         AND co.order_state_number >= 16
         AND co.order_state_number < 2048 
      THEN 1 
      ELSE 0 
   END as stylist_picked_order,

   CASE 
      WHEN date_incoming is not null 
         AND date_stylist_picked is null 
         AND order_state_number = 2048 
      THEN 1
      ELSE 0 
   END as canceled_within_second_step,

   CASE 
      WHEN date_incoming is not null 
         AND date_stylist_picked is null 
         AND order_sales_stage = 'On hold' 
      THEN 1 
      ELSE 0 
   END as on_hold,

   CASE 
      WHEN date_incoming is not null   
         AND date_stylist_picked is null 
         AND ops_check IN ('Not Scored','NS') 
      THEN 1 
      ELSE 0 
   END as ops_check_not_scored,

   CASE 
      WHEN date_incoming is not null 
         AND preview_type = 'Showroom' 
      THEN 1
      ELSE 0 
   END as showroom_order,

   CASE 
      WHEN date_incoming is not null 
         AND preview_type = 'Topic Box' 
      THEN 1 
      ELSE 0 
   END as topic_box_order,

   CASE 
      WHEN date_incoming is not null 
         AND not_reached = 'true' 
      THEN 1 
      ELSE 0 
   END as not_reached,

   CASE 
      WHEN date_incoming is not null 
         AND wrong_phone_number = 'true' 
      THEN 1 
      ELSE 0 
   END as wrong_phone_number,

   CASE 
      WHEN date_incoming is not null 
         AND payment_type = 'Pre-pay' 
            THEN 1 
      ELSE 0 END as prepay_order,

   CASE 
      WHEN date_incoming is not null 
         AND box_type != 'Call Box' 
         AND order_state_number IN(8,12) 
         AND payment_type != 'Pre-pay' 
      THEN 1 
      WHEN date_incoming is not null AND box_type = 'Call Box' 
         AND CAST(date_phone_call_current as date)  >= CURDATE() 
         AND payment_type != 'Pre-pay' THEN 1
      ELSE 0 
   END as backlog

FROM bi.customer_order co
LEFT JOIN bi.previews pr ON co.preview_id = pr.preview_id
LEFT JOIN bi.customer cu ON cu.customer_id = co.customer_id
LEFT JOIN views.ga_information  ga ON co.order_id = ga.transaction_id
WHERE (date_incoming is not null AND co.order_state_number >= 8) OR co.order_state_number >= 16"	READY
196,629	2015-06-02 12:15:06	"1112787948"	true	2015-07-16 18:16:30	tableau.mkt_linkedin_overview		"CREATE VIEW tableau.mkt_linkedin_overview
AS
SELECT
	ga.date_created, 
	CAST(co.date_incoming as date) as date_incoming,
	CAST(co.date_invoiced as date) as date_invoiced,
	co.shipping_country,
	ga.transaction_id,
	CASE
		WHEN LOWER(ga.source) LIKE '%linkedin%' THEN 'LinkedIn'
		WHEN LOWER(ga.source) like'%xing%' THEN 'Xing'
	END AS channel,
	ga.source, 
	ga.medium, 
	ga.campaign, 
	ga.country,
	co.customer_id,
	cu.customer_age,
	co.sales_sent,
	co.sales_kept,
	co.order_state,
	co.payment_type,
	co.revenue_state
FROM(
SELECT DISTINCT date_created, transaction_id, source, medium, campaign, country FROM ""dwh.ga_information_utm""
WHERE lower(source) like '%linkedin%' OR lower(source) like '%xing%'
AND date_created >= '2015-04-01'
) ga
LEFT JOIN bi.customer_order co ON co.order_id = ga.transaction_id
LEFT JOIN bi.customer cu ON co.customer_id = cu.customer_id
WHERE co.date_incoming is not null 
AND co.is_real_order = 'Real Order'"	READY
196,650	2015-06-09 15:35:38	"1112787955"	true	2015-06-09 15:35:38	tableau.stylist_overview_dashboard_live_calls_today		"CREATE VIEW tableau.stylist_overview_dashboard_live_calls_today
AS

SELECT   
	CASE 
  		WHEN st.role = 'Fake' AND st.stylist_id != 118566682 THEN 'Fake Stylist ' || st.team
  		ELSE st.first_name || ' ' || st.last_name 
  		END as stylist_name,
  	st.team as stylist_team,
  	count(*) as orders
FROM postgres.customer_order co
LEFT JOIN bi.stylist st on st.stylist_id=co.stylelist_id
WHERE cast(phone_date as date)=curdate()
GROUP BY 1,2"	READY
196,636	2015-06-03 10:21:33	"1179990869"	true	2015-08-18 18:50:01	tableau.data_source_own_stock_2		"CREATE VIEW tableau.data_source_own_stock_2 AS

SELECT 
	inv.article_id,
	inv.date_created,
	CAST(inv.quantity AS SMALLINT) quantity,
	CAST(inv.reserved AS SMALLINT) reserved,
	CAST(inv.quantity2 AS SMALLINT) quantity2,
	CAST(inv.reserved2 AS SMALLINT) reserved2,
	CAST(inv.quantity_ow_dlv AS SMALLINT) quantity_ow_dlv,
	CAST(inv.quantity_z_dlv AS SMALLINT) quantity_z_dlv,
	CAST(inv.quantity_ow_lret AS SMALLINT) quantity_ow_lret,
	CAST(inv.quantity_z_lret AS SMALLINT) quantity_z_lret,
	CAST(inv.pop_fulfilled_quantity AS INTEGER) pop_fulfilled_quantity,
	CAST(inv.pop_quantity AS INTEGER) pop_quantity,
	CAST(inv.pop_initial_quantity AS INTEGER) pop_initial_quantity,
	ROUND(CAST(inv.pop_retail_price_min AS DECIMAL), 2) pop_retail_price_min,
	ROUND(CAST(inv.pop_purchase_price_min AS DECIMAL), 2) pop_purchase_price_min,
	ROUND(CAST(inv.pop_retail_price_max AS DECIMAL), 2) pop_retail_price_max,
	ROUND(CAST(inv.pop_purchase_price_max AS DECIMAL), 2) pop_purchase_price_max,
	ROUND(CAST(inv.pop_retail_price_avg AS DECIMAL), 2) pop_retail_price_avg,
	ROUND(CAST(inv.pop_purchase_price_avg AS DECIMAL), 2) pop_purchase_price_avg,
	ROUND(CAST(inv.pop_intial_quantity_retail AS DECIMAL), 2) pop_intial_quantity_retail,
	ROUND(CAST(inv.pop_intial_quantity_purchase AS DECIMAL), 2) pop_intial_quantity_purchase,
	ROUND(CAST(inv.pop_quantity_retail AS DECIMAL), 2) pop_quantity_retail,
	ROUND(CAST(inv.pop_quantity_purchase AS DECIMAL), 2) pop_quantity_purchase,
	ROUND(CAST(inv.pop_fulfilled_quantity_retail AS DECIMAL), 2) pop_fulfilled_quantity_retail,
	ROUND(CAST(inv.pop_fulfilled_quantity_purchase AS DECIMAL), 2) pop_fulfilled_quantity_purchase,
	CAST(inv.final_stock AS SMALLINT) final_stock,
	CAST(inv.final_reserved AS SMALLINT) final_reserved,
	ROUND(CAST(inv.avg_purchase_price_128_all AS DECIMAL), 2) avg_purchase_price_128_all,
	ROUND(CAST(inv.avg_retail_price_128_all AS DECIMAL), 2) avg_retail_price_128_all,
	CAST(inv.shipped_128_all AS SMALLINT) shipped_128_all,
	ROUND(CAST(inv.shipped_128_ek_all AS DECIMAL), 2) shipped_128_ek_all,
	ROUND(CAST(inv.shipped_128_vk_all AS DECIMAL), 2) shipped_128_vk_all,
	CAST(inv.shipped_128_de AS SMALLINT) shipped_128_de,
	ROUND(CAST(inv.shipped_128_ek_de AS DECIMAL), 2) shipped_128_ek_de,
	ROUND(CAST(inv.shipped_128_vk_de AS DECIMAL), 2) shipped_128_vk_de,
	CAST(inv.shipped_128_at AS SMALLINT) shipped_128_at,
	ROUND(CAST(inv.shipped_128_ek_at AS DECIMAL), 2) shipped_128_ek_at,
	ROUND(CAST(inv.shipped_128_vk_at AS DECIMAL), 2) shipped_128_vk_at,
	CAST(inv.shipped_128_ch AS SMALLINT) shipped_128_ch,
	ROUND(CAST(inv.shipped_128_ek_ch AS DECIMAL), 2) shipped_128_ek_ch,
	ROUND(CAST(inv.shipped_128_vk_ch AS DECIMAL), 2) shipped_128_vk_ch,
	CAST(inv.shipped_128_nl AS SMALLINT) shipped_128_nl,
	ROUND(CAST(inv.shipped_128_ek_nl AS DECIMAL), 2) shipped_128_ek_nl,
	ROUND(CAST(inv.shipped_128_vk_nl AS DECIMAL), 2) shipped_128_vk_nl,
	CAST(inv.shipped_128_dk AS SMALLINT) shipped_128_dk,
	ROUND(CAST(inv.shipped_128_ek_dk AS DECIMAL), 2) shipped_128_ek_dk,
	ROUND(CAST(inv.shipped_128_vk_dk AS DECIMAL), 2) shipped_128_vk_dk,
	CAST(inv.shipped_128_se AS SMALLINT) shipped_128_se,
	ROUND(CAST(inv.shipped_128_ek_se AS DECIMAL), 2) shipped_128_ek_se,
	ROUND(CAST(inv.shipped_128_vk_se AS DECIMAL), 2) shipped_128_vk_se,
	CAST(inv.shipped_128_lu AS SMALLINT) shipped_128_lu,
	ROUND(CAST(inv.shipped_128_ek_lu AS DECIMAL), 2) shipped_128_ek_lu,
	ROUND(CAST(inv.shipped_128_vk_lu AS DECIMAL), 2) shipped_128_vk_lu,
	CAST(inv.shipped_128_be AS SMALLINT) shipped_128_be,
	ROUND(CAST(inv.shipped_128_ek_be AS DECIMAL), 2) shipped_128_ek_be,
	ROUND(CAST(inv.shipped_128_vk_be AS DECIMAL), 2) shipped_128_vk_be,
	CAST(inv.completed_1024_all AS SMALLINT) completed_1024_all,
	ROUND(CAST(inv.completed_1024_ek_all AS DECIMAL), 2) completed_1024_ek_all,
	ROUND(CAST(inv.completed_1024_vk_all AS DECIMAL), 2) completed_1024_vk_all,
	CAST(inv.completed_1024_de AS SMALLINT) completed_1024_de,
	ROUND(CAST(inv.completed_1024_ek_de AS DECIMAL), 2) completed_1024_ek_de,
	ROUND(CAST(inv.completed_1024_vk_de AS DECIMAL), 2) completed_1024_vk_de,
	CAST(inv.completed_1024_at AS SMALLINT) completed_1024_at,
	ROUND(CAST(inv.completed_1024_ek_at AS DECIMAL), 2) completed_1024_ek_at,
	ROUND(CAST(inv.completed_1024_vk_at AS DECIMAL), 2) completed_1024_vk_at,
	CAST(inv.completed_1024_ch AS SMALLINT) completed_1024_ch,
	ROUND(CAST(inv.completed_1024_ek_ch AS DECIMAL), 2) completed_1024_ek_ch,
	ROUND(CAST(inv.completed_1024_vk_ch AS DECIMAL), 2) completed_1024_vk_ch,
	CAST(inv.completed_1024_nl AS SMALLINT) completed_1024_nl,
	ROUND(CAST(inv.completed_1024_ek_nl AS DECIMAL), 2) completed_1024_ek_nl,
	ROUND(CAST(inv.completed_1024_vk_nl AS DECIMAL), 2) completed_1024_vk_nl,
	CAST(inv.completed_1024_dk AS SMALLINT) completed_1024_dk,
	ROUND(CAST(inv.completed_1024_ek_dk AS DECIMAL), 2) completed_1024_ek_dk,
	ROUND(CAST(inv.completed_1024_vk_dk AS DECIMAL), 2) completed_1024_vk_dk,
	CAST(inv.completed_1024_se AS SMALLINT) completed_1024_se,
	ROUND(CAST(inv.completed_1024_ek_se AS DECIMAL), 2) completed_1024_ek_se,
	ROUND(CAST(inv.completed_1024_vk_se AS DECIMAL), 2) completed_1024_vk_se,
	CAST(inv.completed_1024_lu AS SMALLINT) completed_1024_lu,
	ROUND(CAST(inv.completed_1024_ek_lu AS DECIMAL), 2) completed_1024_ek_lu,
	ROUND(CAST(inv.completed_1024_vk_lu AS DECIMAL), 2) completed_1024_vk_lu,
	CAST(inv.completed_1024_be AS SMALLINT) completed_1024_be,
	ROUND(CAST(inv.completed_1024_ek_be AS DECIMAL), 2) completed_1024_ek_be,
	ROUND(CAST(inv.completed_1024_vk_be AS DECIMAL), 2) completed_1024_vk_be,
	ROUND(CAST(inv.avg_retail_price_1024_all AS DECIMAL), 2) avg_retail_price_1024_all,
	ROUND(CAST(inv.avg_retail_price_1024_de AS DECIMAL), 2) avg_retail_price_1024_de,
	ROUND(CAST(inv.avg_retail_price_1024_at AS DECIMAL), 2) avg_retail_price_1024_at,
	ROUND(CAST(inv.avg_retail_price_1024_ch AS DECIMAL), 2) avg_retail_price_1024_ch,
	ROUND(CAST(inv.avg_retail_price_1024_nl AS DECIMAL), 2) avg_retail_price_1024_nl,
	ROUND(CAST(inv.avg_retail_price_1024_dk AS DECIMAL), 2) avg_retail_price_1024_dk,
	ROUND(CAST(inv.avg_retail_price_1024_se AS DECIMAL), 2) avg_retail_price_1024_se,
	ROUND(CAST(inv.avg_retail_price_1024_lu AS DECIMAL), 2) avg_retail_price_1024_lu,
	ROUND(CAST(inv.avg_retail_price_1024_be AS DECIMAL), 2) avg_retail_price_1024_be,
	CAST(inv.returned_512_all AS SMALLINT) returned_512_all,
	ROUND(CAST(inv.returned_512_ek_all AS DECIMAL), 2) returned_512_ek_all,
	ROUND(CAST(inv.returned_512_vk_all AS DECIMAL), 2) returned_512_vk_all,
	ROUND(CAST(inv.avg_purchase_price_512_all AS DECIMAL), 2) avg_purchase_price_512_all,
	ROUND(CAST(inv.avg_retail_price_512_all AS DECIMAL), 2) avg_retail_price_512_all,
	CAST(inv.returned_512_de AS SMALLINT) returned_512_de,
	ROUND(CAST(inv.returned_512_ek_de AS DECIMAL), 2) returned_512_ek_de,
	ROUND(CAST(inv.returned_512_vk_de AS DECIMAL), 2) returned_512_vk_de,
	CAST(inv.returned_512_at AS SMALLINT) returned_512_at,
	ROUND(CAST(inv.returned_512_ek_at AS DECIMAL), 2) returned_512_ek_at,
	ROUND(CAST(inv.returned_512_vk_at AS DECIMAL), 2) returned_512_vk_at,
	CAST(inv.returned_512_ch AS SMALLINT) returned_512_ch,
	ROUND(CAST(inv.returned_512_ek_ch AS DECIMAL), 2) returned_512_ek_ch,
	ROUND(CAST(inv.returned_512_vk_ch AS DECIMAL), 2) returned_512_vk_ch,
	CAST(inv.returned_512_nl AS SMALLINT) returned_512_nl,
	ROUND(CAST(inv.returned_512_ek_nl AS DECIMAL), 2) returned_512_ek_nl,
	ROUND(CAST(inv.returned_512_vk_nl AS DECIMAL), 2) returned_512_vk_nl,
	CAST(inv.returned_512_dk AS SMALLINT) returned_512_dk,
	ROUND(CAST(inv.returned_512_ek_dk AS DECIMAL), 2) returned_512_ek_dk,
	ROUND(CAST(inv.returned_512_vk_dk AS DECIMAL), 2) returned_512_vk_dk,
	CAST(inv.returned_512_se AS SMALLINT) returned_512_se,
	ROUND(CAST(inv.returned_512_ek_se AS DECIMAL), 2) returned_512_ek_se,
	ROUND(CAST(inv.returned_512_vk_se AS DECIMAL), 2) returned_512_vk_se,
	CAST(inv.returned_512_lu AS SMALLINT) returned_512_lu,
	ROUND(CAST(inv.returned_512_ek_lu AS DECIMAL), 2) returned_512_ek_lu,
	ROUND(CAST(inv.returned_512_vk_lu AS DECIMAL), 2) returned_512_vk_lu,
	CAST(inv.returned_512_be AS SMALLINT) returned_512_be,
	ROUND(CAST(inv.returned_512_ek_be AS DECIMAL), 2) returned_512_ek_be,
	ROUND(CAST(inv.returned_512_vk_be AS DECIMAL), 2) returned_512_vk_be,
	CAST(inv.lost_1536_all AS SMALLINT) lost_1536_all,
	ROUND(CAST(inv.lost_1536_ek_all AS DECIMAL), 2) lost_1536_ek_all,
	ROUND(CAST(inv.lost_1536_vk_all AS DECIMAL), 2) lost_1536_vk_all,
	CAST(inv.sum_virtual_stock_quantity AS SMALLINT) sum_virtual_stock_quantity,
	ROUND(CAST(inv.sum_vk_stock AS DECIMAL), 2) sum_vk_stock,
	ROUND(CAST(inv.sum_ek_stock AS DECIMAL), 2) sum_ek_stock,
	ROUND(CAST(inv.avg_virtual_stock_vk AS DECIMAL), 2) avg_virtual_stock_vk,
	ROUND(CAST(inv.avg_virtual_stock_ek AS DECIMAL), 2) avg_virtual_stock_ek,
	ROUND(CAST(inv.avg_purchase_price_128_partner AS DECIMAL), 2) avg_purchase_price_128_partner,
	ROUND(CAST(inv.avg_retail_price_128_partner AS DECIMAL), 2) avg_retail_price_128_partner,
	CAST(inv.shipped_128_partner AS SMALLINT) shipped_128_partner,
	ROUND(CAST(inv.shipped_128_ek_partner AS DECIMAL), 2) shipped_128_ek_partner,
	ROUND(CAST(inv.shipped_128_vk_partner AS DECIMAL), 2) shipped_128_vk_partner,
	ROUND(CAST(inv.shipped_128_de_partner AS DECIMAL), 2) shipped_128_de_partner,
	ROUND(CAST(inv.shipped_128_ek_de_partner AS DECIMAL), 2) shipped_128_ek_de_partner,
	ROUND(CAST(inv.shipped_128_vk_de_partner AS DECIMAL), 2) shipped_128_vk_de_partner,
	ROUND(CAST(inv.shipped_128_at_partner AS DECIMAL), 2) shipped_128_at_partner,
	ROUND(CAST(inv.shipped_128_ek_at_partner AS DECIMAL), 2) shipped_128_ek_at_partner,
	ROUND(CAST(inv.shipped_128_vk_at_partner AS DECIMAL), 2) shipped_128_vk_at_partner,
	CAST(inv.shipped_128_ch_partner AS SMALLINT) shipped_128_ch_partner,
	ROUND(CAST(inv.shipped_128_ek_ch_partner AS DECIMAL), 2) shipped_128_ek_ch_partner,
	ROUND(CAST(inv.shipped_128_vk_ch_partner AS DECIMAL), 2) shipped_128_vk_ch_partner,
	CAST(inv.shipped_128_nl_partner AS SMALLINT) shipped_128_nl_partner,
	ROUND(CAST(inv.shipped_128_ek_nl_partner AS DECIMAL), 2) shipped_128_ek_nl_partner,
	ROUND(CAST(inv.shipped_128_vk_nl_partner AS DECIMAL), 2) shipped_128_vk_nl_partner,
	CAST(inv.shipped_128_dk_partner AS SMALLINT) shipped_128_dk_partner,
	ROUND(CAST(inv.shipped_128_ek_dk_partner AS DECIMAL), 2) shipped_128_ek_dk_partner,
	ROUND(CAST(inv.shipped_128_vk_dk_partner AS DECIMAL), 2) shipped_128_vk_dk_partner,
	CAST(inv.shipped_128_se_partner AS SMALLINT) shipped_128_se_partner,
	ROUND(CAST(inv.shipped_128_ek_se_partner AS DECIMAL), 2) shipped_128_ek_se_partner,
	ROUND(CAST(inv.shipped_128_vk_se_partner AS DECIMAL), 2) shipped_128_vk_se_partner,
	CAST(inv.shipped_128_lu_partner AS SMALLINT) shipped_128_lu_partner,
	ROUND(CAST(inv.shipped_128_ek_lu_partner AS DECIMAL), 2) shipped_128_ek_lu_partner,
	ROUND(CAST(inv.shipped_128_vk_lu_partner AS DECIMAL), 2) shipped_128_vk_lu_partner,
	CAST(inv.shipped_128_be_partner AS SMALLINT) shipped_128_be_partner,
	ROUND(CAST(inv.shipped_128_ek_be_partner AS DECIMAL), 2) shipped_128_ek_be_partner,
	ROUND(CAST(inv.shipped_128_vk_be_partner AS DECIMAL), 2) shipped_128_vk_be_partner,
	CAST(inv.completed_1024_partner AS SMALLINT) completed_1024_partner,
	ROUND(CAST(inv.completed_1024_ek_partner AS DECIMAL), 2) completed_1024_ek_partner,
	ROUND(CAST(inv.completed_1024_vk_partner AS DECIMAL), 2) completed_1024_vk_partner,
	ROUND(CAST(inv.avg_retail_price_1024_de_partner AS DECIMAL), 2) avg_retail_price_1024_de_partner,
	CAST(inv.completed_1024_de_partner AS SMALLINT) completed_1024_de_partner,
	ROUND(CAST(inv.completed_1024_ek_de_partner AS DECIMAL), 2) completed_1024_ek_de_partner,
	ROUND(CAST(inv.completed_1024_vk_de_partner AS DECIMAL), 2) completed_1024_vk_de_partner,
	ROUND(CAST(inv.avg_retail_price_1024_at_partner AS DECIMAL), 2) avg_retail_price_1024_at_partner,
	CAST(inv.completed_1024_at_partner AS SMALLINT) completed_1024_at_partner,
	ROUND(CAST(inv.completed_1024_ek_at_partner AS DECIMAL), 2) completed_1024_ek_at_partner,
	ROUND(CAST(inv.completed_1024_vk_at_partner AS DECIMAL), 2) completed_1024_vk_at_partner,
	ROUND(CAST(inv.avg_retail_price_1024_ch_partner AS DECIMAL), 2) avg_retail_price_1024_ch_partner,
	CAST(inv.completed_1024_ch_partner AS SMALLINT) completed_1024_ch_partner,
	ROUND(CAST(inv.completed_1024_ek_ch_partner AS DECIMAL), 2) completed_1024_ek_ch_partner,
	ROUND(CAST(inv.completed_1024_vk_ch_partner AS DECIMAL), 2) completed_1024_vk_ch_partner,
	ROUND(CAST(inv.avg_retail_price_1024_nl_partner AS DECIMAL), 2) avg_retail_price_1024_nl_partner,
	CAST(inv.completed_1024_nl_partner AS SMALLINT) completed_1024_nl_partner,
	ROUND(CAST(inv.completed_1024_ek_nl_partner AS DECIMAL), 2) completed_1024_ek_nl_partner,
	ROUND(CAST(inv.completed_1024_vk_nl_partner AS DECIMAL), 2) completed_1024_vk_nl_partner,
	ROUND(CAST(inv.avg_retail_price_1024_dk_partner AS DECIMAL), 2) avg_retail_price_1024_dk_partner,
	CAST(inv.completed_1024_dk_partner AS SMALLINT) completed_1024_dk_partner,
	ROUND(CAST(inv.completed_1024_ek_dk_partner AS DECIMAL), 2) completed_1024_ek_dk_partner,
	ROUND(CAST(inv.completed_1024_vk_dk_partner AS DECIMAL), 2) completed_1024_vk_dk_partner,
	ROUND(CAST(inv.avg_retail_price_1024_se_partner AS DECIMAL), 2) avg_retail_price_1024_se_partner,
	CAST(inv.completed_1024_se_partner AS SMALLINT) completed_1024_se_partner,
	ROUND(CAST(inv.completed_1024_ek_se_partner AS DECIMAL), 2) completed_1024_ek_se_partner,
	ROUND(CAST(inv.completed_1024_vk_se_partner AS DECIMAL), 2) completed_1024_vk_se_partner,
	ROUND(CAST(inv.avg_retail_price_1024_lu_partner AS DECIMAL), 2) avg_retail_price_1024_lu_partner,
	CAST(inv.completed_1024_lu_partner AS SMALLINT) completed_1024_lu_partner,
	ROUND(CAST(inv.completed_1024_ek_lu_partner AS DECIMAL), 2) completed_1024_ek_lu_partner,
	ROUND(CAST(inv.completed_1024_vk_lu_partner AS DECIMAL), 2) completed_1024_vk_lu_partner,
	ROUND(CAST(inv.avg_retail_price_1024_be_partner AS DECIMAL), 2) avg_retail_price_1024_be_partner,
	CAST(inv.completed_1024_be_partner AS SMALLINT) completed_1024_be_partner,
	ROUND(CAST(inv.completed_1024_ek_be_partner AS DECIMAL), 2) completed_1024_ek_be_partner,
	ROUND(CAST(inv.completed_1024_vk_be_partner AS DECIMAL), 2) completed_1024_vk_be_partner,
	ROUND(CAST(inv.avg_purchase_price_1024_partner AS DECIMAL), 2) avg_purchase_price_1024_partner,
	ROUND(CAST(inv.avg_retail_price_1024_partner AS DECIMAL), 2) avg_retail_price_1024_partner,
	CAST(inv.returned_512_partner AS SMALLINT) returned_512_partner,
	ROUND(CAST(inv.returned_512_ek_partner AS DECIMAL), 2) returned_512_ek_partner,
	ROUND(CAST(inv.returned_512_vk_partner AS DECIMAL), 2) returned_512_vk_partner,
	ROUND(CAST(inv.avg_purchase_price_512_partner AS DECIMAL), 2) avg_purchase_price_512_partner,
	ROUND(CAST(inv.avg_retail_price_512_partner AS DECIMAL), 2) avg_retail_price_512_partner,
	CAST(inv.sum_virtual_stock_quantity_partner AS SMALLINT) sum_virtual_stock_quantity_partner,
	ROUND(CAST(inv.sum_vk_stock_partner AS DECIMAL), 2) sum_vk_stock_partner,
	ROUND(CAST(inv.sum_ek_stock_partner AS DECIMAL), 2) sum_ek_stock_partner,
	ROUND(CAST(inv.avg_virtual_stock_vk_partner AS DECIMAL), 2) avg_virtual_stock_vk_partner,
	ROUND(CAST(inv.avg_virtual_stock_ek_partner AS DECIMAL), 2) avg_virtual_stock_ek_partner,
	
	item.item_no,
	item.variant_code,
	item.supplier_article_id,
	item.parent_no,
	item.ean,
	item.vendor_item_no,
	item.item_description,
	item.item_status_purchase_description,
	item.category,
	item.product_group,
	item.item_status,
	item.item_status_internal,
	CASE
		WHEN item.countries_blocked IS NULL THEN 'not blacklisted'
		ELSE item.countries_blocked
	END AS countries_blocked,
	item.net_weight,
	item.gross_weight,
	item.unit_of_measure,
	item.country_region_of_origin,
	item.tariff_no,
	item.tariff_no_ch,
	item.color,
	item.supplier_color,
	item.size,
	item.season,
	item.brand,
	item.has_picture,
	item.pic1,
	item.unit_cost,
	item.unit_price_be,
	item.unit_price_ch,
	item.unit_price_de,
	item.unit_price_dk,
	item.unit_price_lu,
	item.unit_price_nl,
	item.unit_price_se,
	item.has_material_code,
	item.has_quantity,
	item.pool,
	item.buyer,
	item.paul_hunter,
	item.sample_size,
	/* the following are actually at the item_no level, not the article_id level */
	book.date_po_received_min,
	book.date_po_received_max,
	CAST(TIMESTAMPDIFF(SQL_TSI_DAY,book.date_po_received_min,CURDATE()) AS SMALLINT) AS days_since_first_received_into_inventory,
	CAST(TIMESTAMPDIFF(SQL_TSI_DAY,book.date_po_received_min, book.date_po_received_max) AS SMALLINT) AS days_in_inventory

FROM
	views.inventory AS inv
	LEFT JOIN
	bi.item
		 ON inv.article_id = item.article_id
	LEFT JOIN
	bi.po_received_dates AS book
		ON inv.article_id = book.article_id
WHERE
	/* the following filter is used to eliminate rows with no useable data */
	COALESCE(ABS(inv.quantity),0) + 
	COALESCE(ABS(inv.reserved),0) + 
	COALESCE(ABS(inv.quantity2),0) + 
	COALESCE(ABS(inv.reserved2),0) + 
	COALESCE(ABS(inv.quantity_ow_dlv),0) + 
	COALESCE(ABS(inv.quantity_z_dlv),0) + 
	COALESCE(ABS(inv.quantity_ow_lret),0) + 
	COALESCE(ABS(inv.quantity_z_lret),0) + 
	COALESCE(ABS(inv.pop_fulfilled_quantity),0) + 
	COALESCE(ABS(inv.pop_quantity),0) + 
	COALESCE(ABS(inv.pop_initial_quantity),0) + 
	COALESCE(ABS(inv.final_stock),0) + 
	COALESCE(ABS(inv.final_reserved),0) + 
	COALESCE(ABS(inv.shipped_128_all),0) + 
	COALESCE(ABS(inv.completed_1024_all),0) + 
	COALESCE(ABS(inv.returned_512_all),0) + 
	COALESCE(ABS(inv.lost_1536_all),0) + 
	COALESCE(ABS(inv.sum_virtual_stock_quantity),0) + 
	COALESCE(ABS(inv.shipped_128_partner),0) + 
	COALESCE(ABS(inv.completed_1024_partner),0) + 
	COALESCE(ABS(inv.returned_512_partner),0) + 
	COALESCE(ABS(inv.sum_virtual_stock_quantity_partner),0)
	>0

/*  LIMIT 100000 */"	READY
245	2015-04-24 18:19:33	"930897265"	true	2015-04-24 18:19:33	affilinet_adv.channels_channelgroup1		"create view affilinet_adv.channels_channelgroup1
as 
select * from ( call affilinet_adv.GetChannels( 'ChannelGroup1', 5245 ) ) a"	READY
246	2015-04-24 18:19:33	"930897266"	true	2015-04-24 18:19:33	affilinet_adv.channels_channelgroup2		"create view affilinet_adv.channels_channelgroup2
as 
select * from ( call affilinet_adv.GetChannels( 'ChannelGroup2', 5245 ) ) a"	READY
196,639	2015-06-04 10:09:58	"1248477093"	true	2015-09-01 17:17:10	tableau.stylist_club_customers		"CREATE VIEW tableau.stylist_club_customers
AS

SELECT
	co.order_id,
	co.customer_id,
	co.date_incoming,
	co.sales_channel,
	co.order_sales_stage,
	c.club_member,
	c.club_membership_type,
	st_c.stylist as customer_stylist,
	st_c.team as customer_stylist_team
FROM bi.customer_order co
LEFT JOIN bi.customer c on c.customer_id = co.customer_id
LEFT JOIN bi.stylist st_c on st_c.stylist_id = c.new_stylist_id"	READY
317	2015-04-24 18:20:34	"1112787796"	true	2015-07-22 14:50:31	raw.marketing_contacts_discounts		"CREATE VIEW raw.marketing_contacts_discounts
AS

SELECT 
	co.order_id,
	co.date_incoming as contact_timestamp,
	cam.marketing_channel as marketing_channel,
	CASE
		WHEN cam.marketing_channel = 'Referral Program' AND (cam.marketing_subchannel = 'Employees' OR LOWER(cam.marketing_campaign) LIKE '%employee%') THEN 'Employees'
		WHEN cam.marketing_channel = 'Referral Program' AND (cam.marketing_subchannel = 'Boxes' OR LOWER(cam.marketing_campaign) NOT LIKE '%employee%') THEN 'Boxes'
		WHEN cam.marketing_channel = 'Affiliate' AND (cam.marketing_subchannel = 'Platform' OR LOWER(cam.marketing_campaign) NOT LIKE '%cb%' AND LOWER(cam.marketing_campaign) NOT LIKE '%benefits%') THEN 'Platform'
		WHEN cam.marketing_channel = 'Affiliate' AND (cam.marketing_subchannel = 'Corporate Benefit Program' OR LOWER(cam.marketing_campaign) LIKE '%cb%' OR LOWER(cam.marketing_campaign) LIKE '%benefits%') THEN 'Corporate Benefit Program'
		WHEN cam.marketing_channel = 'Cooperations' AND (cam.marketing_subchannel = 'B2B' OR LOWER(cam.marketing_campaign) LIKE '%b2b%') THEN 'B2B'
		WHEN cam.marketing_channel = 'Cooperations' AND (cam.marketing_subchannel = 'Print Ads' OR LOWER(cam.marketing_campaign) LIKE '%print%') THEN 'Print Ads'
		WHEN cam.marketing_channel = 'Cooperations' AND (cam.marketing_subchannel = 'Offline Promo' OR LOWER(cam.marketing_campaign) LIKE '%promo%') THEN 'Offline Promo'
		WHEN cam.marketing_channel = 'Cooperations' AND (cam.marketing_subchannel = 'Newsletter' OR LOWER(cam.marketing_campaign) LIKE '%_nl_%') THEN 'Newsletter'
		WHEN cam.marketing_channel = 'Offline Promotions' THEN 'Offline Promotions'
		ELSE cam.campaign_type
	END AS marketing_sub_channel,
	cam.cluster,
	cam.publisher,
	CASE
		WHEN ca.campaign_title is null THEN 'Voucher campaign'
		ELSE ca.campaign_title
	END AS marketing_campaign
FROM bi.customer_order co
LEFT JOIN raw.discount_campaigns  ca on co.campaign_id = ca.campaign_id
LEFT JOIN 
(
	SELECT
		ca.campaign_id,
		CASE
			WHEN vcc.campaign_channel = 'Offline Promotions' OR ca.campaign_title like 'OFFLINE_%' THEN 'Offline Promotions'
			WHEN vcc.campaign_channel = 'Referral Program' OR LOWER(ca.campaign_title) like '%referral%' THEN 'Referral Program'
			WHEN de.marketing_channel = 'Inserts' OR vcc.campaign_channel = 'Inserts' OR LOWER(ca.campaign_title) like '%inserts%' THEN 'Inserts'
			WHEN de.marketing_channel = 'Cooperations' OR vcc.campaign_channel = 'Cooperations' OR LOWER(ca.campaign_title) like '%coop%' THEN 'Cooperations'
			WHEN vcc.campaign_channel = 'CRM' OR LOWER(ca.campaign_title) like '%crm%' THEN 'CRM'
			WHEN de.marketing_channel = 'Affiliate' OR vcc.campaign_channel = 'Affiliate' OR LOWER(ca.campaign_title) like '%affiliate%' THEN 'Affiliate'
			WHEN vcc.campaign_channel = 'Remarketing' OR LOWER(ca.campaign_title) like '%remarketing%' THEN 'Remarketing'
			WHEN vcc.campaign_channel = 'Display' OR LOWER(ca.campaign_title) like '%display%' THEN 'Display'
			WHEN vcc.campaign_channel = 'Facebook' OR LOWER(ca.campaign_title) like '%facebook%' THEN 'Facebook'
			WHEN vcc.campaign_channel = 'Offline Promotions' OR ca.campaign_title like 'OFFLINE_%' THEN 'Offline Promotions'
			ELSE 'Other voucher'
		END as marketing_channel,
		vcc.campaign_subchannel as marketing_subchannel,
		vcc.campaign_title as marketing_campaign,
		de.campaign_type,
		de.publisher,
		de.cluster		
	FROM raw.discount_campaigns  ca
	LEFT JOIN dwh.voucher_campaign_channel vcc ON ca.campaign_title = vcc.campaign_title
	LEFT JOIN 
	(
	SELECT 
		campaign_title,
		marketing_channel,
		campaign_type, 
		LOWER(publisher) as publisher,
		LOWER(cluster) as cluster
	FROM raw.marketing_voucher_campaign_details  
	) de ON ca.campaign_title = LTRIM(RTRIM(de.campaign_title))
) cam ON ca.campaign_id = cam.campaign_id
WHERE co.campaign_id is not null
AND co.date_incoming is not null"	READY
32,791	2015-04-28 10:32:03	"1112787889"	true	2015-05-11 11:17:51	tableau.sales_datasource_orginal_stylist_ds		"CREATE VIEW tableau.sales_datasource_orginal_stylist_ds
AS

SELECT

  co.order_id,
  co.customer_id,
  co.parent_order_id,
  co.sales_channel,
  co.sales_channel_special as saleschannel_special__c,
  co.order_state_number as customer_order_state,
  co.shipping_first_name,
  co.shipping_last_name,
  co.shipping_city,
  co.shipping_country,
  co.currency_code,
  co.date_created,
  co.date_incoming,
  co.date_phone_call as phone_date,
  co.date_invoiced,
  co.date_completed,
  co.order_type,
  co.revenue_state,
  
  /*Forecast Revenue*/
  fc.sales_kept_forecast,
  fc.sales_returned_forecast,
  fc.billing_total,
  fc.billing_net_sales,
  
  /*Customer Fields*/
  cu.customer_age,
  cu.default_domain as default_page,
  cu.age_group_felt as perceived_customer_age,
  COALESCE(cu.age_group_felt,cu.age_group) as perceived_customer_age_2,
  fo.first_order_date,
  fo.first_order_date_completed,

  /*Stylist Information-Information is from salesforce (Will be replaced with postgres or dwh table)*/
  s.team as user_role,
  s.stylist,
  s.stylist_original as Name,
  s.balancer_enabled,
  s.call_group,
  
  /*Order Position Fields*/
  coa.article_id,
  coa.order_article_state_number as state,
  coa.stock_location_id,
  coa.date_picked,
  coa.date_returned,
  coa.sales_picked,
  coa.sales_sent,
  coa.sales_kept,
  coa.sales_returned,
  coa.sales_lost,
  coa.articles_picked,
  coa.articles_sent,
  coa.articles_kept,
  coa.articles_returned,
  coa.articles_lost,
  /*Feedback reasons based on warehouse or customer_feedback when returned online*/
  coa.feedback_dont_like_the_colour,
  coa.feedback_dont_like_the_brand,
  coa.feedback_dont_like_the_pattern,
  coa.feedback_too_outrageous,
  coa.feedback_too_simple,
  coa.feedback_not_needed,
  coa.feedback_too_tight,
  coa.feedback_too_big,
  coa.feedback_too_small,
  coa.feedback_too_short,
  coa.feedback_too_long,
  coa.feedback_too_wide,
  coa.feedback_too_expensive,
  coa.feedback_too_cheap,
  coa.feedback_too_low_quality,
  coa.feedback_comment as comment, /*this comment is from doc data returns files*/

  /*Article Information (Zalando article info is missing for many articles)*/
  art.article_brand,
  art.article_title,
  art.article_name,
  art.article_color,
  art.article_color1 as color1,
  art.article_commodity_group2 as commodity_group2,
  art.article_commodity_group3 as commodity_group3,
  art.article_commodity_group4 as commodity_group4,
  art.article_push_stock AS push,
  
  /*Salesforce Fields (Will be replaced soon to dwh tables)*/
  cos.newcardrecommendation as newcardrecommendation__c,
  cos.dhl_return_next_steps as dhlreturnnextsteps__c,
  cos.inactive_reasons as inactivereason__c,
  cos.refusual_comment as refusals_comment__c,
  cos.not_reached as notReached__c,
  cos.wrong_phone_number as Telefonnummer_Falsch__c,
  
  sac.category2, /*Will be replaced soon with ERP article model*/

  CASE
    WHEN co.shipping_country='CH' AND CAST(co.date_invoiced as date) BETWEEN '2014-11-01' AND '2015-03-30' AND art_a.articles_sent=art_a.articles_kept THEN 'Open CH Orders'
    ELSE NULL
  END AS open_ch_order

FROM bi.customer_order co
LEFT JOIN bi.customer cu on cu.customer_id=co.customer_id
LEFT JOIN bi.customer_order_articles coa on coa.order_id=co.order_id
LEFT JOIN bi.stylist s ON co.stylist_id = s.stylist_id
LEFT JOIN bi.article art on coa.article_id = art.article_id
LEFT JOIN bi.customer_order_salesforce cos on cos.order_id=co.order_id
LEFT JOIN views.supplier_article_categories sac ON sac.supplier_article_id = coa.supplier_article_id
LEFT JOIN
(
  SELECT 
    co.customer_id,
    min(co.date_created) as first_order_date,
    min(CASE WHEN co.order_state = 'Completed' THEN co.date_created ELSE null END) as first_order_date_completed
  FROM bi.customer_order co 
  GROUP BY co.customer_id
)fo on fo.customer_id = co.customer_id
LEFT JOIN
(
  SELECT 
    order_id,
    SUM(articles_sent) as articles_sent,
    SUM(articles_kept) as articles_kept
  FROM bi.customer_order_articles
  GROUP BY 1
)art_a on art_a.order_id=co.order_id
/*Forcast KPI's*/
LEFT JOIN
(
	SELECT 
		co.order_id,
		min(coa.article_id) as min_article_id,
		avg(co.sales_kept) as sales_kept_forecast,
		avg(co.sales_returned) as sales_returned_forecast,
		avg(co.billing_total) as billing_total,
		avg(co.billing_net_sales) as billing_net_sales
	FROM bi.customer_order co 
	LEFT JOIN bi.customer_order_articles coa on coa.order_id=co.order_id
	GROUP BY 1
)fc on fc.order_id=co.order_id and fc.min_article_id=coa.article_id"	READY
196,655	2015-06-10 09:39:57	"1298625879"	true	2015-09-11 15:06:24	tableau.stylist_no_call_live		"CREATE VIEW tableau.stylist_no_call_live
AS

SELECT  
	co.id,
	co.date_created,
	st_c.stylist as customer_stylist,
	st_c.team as customer_stylist_team,
	CASE
	    WHEN cos.salesforce_order_stage = 'Datum vorschlagen' THEN 'Suggest date' 
	    WHEN cos.salesforce_order_stage in ('Artikel bestellen', 'order articles') THEN 'Order articles' 
	    WHEN cos.salesforce_order_stage in ('Feedback zur Bestellung einholen', 'get feedback') THEN 'Get feedback' 
	    WHEN cos.salesforce_order_stage in ('Termin ausmachen', 'arrange a date') THEN 'Arrange a date' 
	    WHEN cos.salesforce_order_stage in ('Inaktiv', 'inactive') THEN 'Inactive' 
	    WHEN cos.salesforce_order_stage = 'on hold' THEN 'On hold' 
	    WHEN cos.salesforce_order_stage in ('Packen', 'packing') THEN 'Packing' 
	    WHEN cos.salesforce_order_stage in ('Informationen vervollstndigen', 'complete information') THEN 'Complete information' 
	    WHEN cos.salesforce_order_stage in ('abgeschloen & Nachbereitung', 'completed & postprocessing') THEN 'Completed & Follow-up'  
	    WHEN cos.salesforce_order_stage = 'Vorschau erstellen' THEN 'Create preview' 
	    WHEN cos.salesforce_order_stage is null THEN 'Order not synced' 
	    ELSE 'Ask BI'
	END as order_sales_stage,
	CASE 
		WHEN CAST(co.date_created AS DATE)>=TIMESTAMPADD(SQL_TSI_WEEK, -4,CURDATE()) THEN 1 
		ELSE 0 
	END AS last_4_week
FROM postgres.customer_order co
LEFT JOIN bi.stylist st_c on st_c.stylist_id = co.stylelist_id
LEFT JOIN raw.customer_order_salesforce cos on cos.order_id=co.id
LEFT JOIN
(
  SELECT 
    customer_id,
    count(*) as nb_orders
  FROM postgres.customer_order 
  GROUP BY 1
)f_order on f_order.customer_id=co.customer_id
WHERE nb_orders=1
AND co.phone_date is null
AND cos.ops_check='OK'
AND cos.preview_not_liked='false'"	READY
196,653	2015-06-09 18:20:27	"1112787956"	true	2015-06-09 18:57:47	ml.forced_orders		CREATE VIEW ml.forced_orders AS
SELECT
co.order_id,
co.customer_id,
co.date_created,
co.order_state,
co.order_type,
co.sales_kept,
co.sales_channel,
CAST(bo.order_id IS NOT NULL AS INTEGER) AS "customer_complained"
FROM bi.customer_order co
LEFT JOIN "ml.orders_with_cs_reason_irrt_best" bo ON bo.order_id = co.order_id
LEFT JOIN bi.customer c ON c.customer_id = co.customer_id
WHERE co.date_created >= '2015-01-01'
AND co.date_created < '2015-05-01'	READY
196,682	2015-06-17 15:43:49	"1383765189"	true	2015-09-28 17:31:08	tableau.ops_booked_without_return		"CREATE VIEW tableau.ops_booked_without_return AS WITH dataset7 as (
    WITH dataset6 as (
        WITH dataset5 as (
            WITH dataset3 as (
                WITH dataset2 as (
                    WITH dataset1 as (
                        SELECT
                                sb.article_id
                                ,sb.date_stock_booked
                                ,cal.day_name as day_name_date_stock_booked
                                ,MAX (
                                    CASE
                                        WHEN coal.date_returned < sb.date_stock_booked
                                        THEN coal.date_returned
                                    END
                                ) as date_last_return
                            FROM
                                bi.stock_booked sb LEFT JOIN bi.customer_order_articles_logistics coal
                                on coal.article_id = sb.article_id LEFT JOIN dwh.calendar cal
                                on cal.date = cast (
                                    sb.date_stock_booked as date
                                )
                            WHERE
                                sb.supplier_id = 999997
                            GROUP BY
                                1
                                ,2
                                ,3
                    ) SELECT
                            dataset1.*
                            ,coal2.order_id
                            ,coal2.date_returned as date_article_returned
                            ,co.date_returned as date_customer_order_returned
                            ,co.shipping_country
                        From
                            dataset1 LEFT JOIN bi.customer_order_articles_logistics coal2
                            on dataset1.article_id = coal2.article_id LEFT JOIN bi.customer_order co
                            on co.order_id = coal2.order_id
                        WHERE
                            coal2.date_returned is null
                            AND co.date_returned is not null
                ) SELECT
                        dataset2.*
                        ,coa.date_returned_online
                        ,coa.date_returned as date_article_returned_grails
                        ,coa.date_lost as date_article_lost_grails
                    FROM
                        dataset2 LEFT JOIN bi.customer_order_articles coa
                        on coa.order_id = dataset2.order_id
                        AND coa.article_id = dataset2.article_id
            ) SELECT
                    dataset3.*
                    ,CASE
                        WHEN dataset3.day_name_date_stock_booked = 'Monday'
                        OR dataset3.day_name_date_stock_booked = 'Tuesday'
                        OR dataset3.day_name_date_stock_booked = 'Wednesday'
                        OR dataset3.day_name_date_stock_booked = 'Thursday'
                        THEN - 7
                        ELSE - 7
                    END
                    As days_to_count_from_stock_booked
                FROM
                    dataset3
        ) SELECT
                dataset5.article_id
                ,dataset5.date_stock_booked
                ,dataset5.day_name_date_stock_booked
                ,dataset5.days_to_count_from_stock_booked
                ,TIMESTAMPADD (
                    SQL_TSI_Day
                    ,days_to_count_from_stock_booked
                    ,cast (
                        date_stock_booked as date
                    )
                ) as date_stock_booked_minus_1_week
                ,dataset5.date_last_return
                ,dataset5.order_id
                ,dataset5.date_article_returned
                ,dataset5.date_customer_order_returned
                ,dataset5.date_returned_online
                ,dataset5.shipping_country
                ,dataset5.date_article_returned_grails
                ,dataset5.date_article_lost_grails
            FROM
                dataset5
            GROUP BY
                1
                ,2
                ,3
                ,4
                ,6
                ,7
                ,8
                ,9
                ,10
                ,11
                ,12
                ,13
    ) SELECT
            dataset6.article_id
            ,dataset6.date_stock_booked
            ,dataset6.date_stock_booked_minus_1_week
            ,dataset6.date_last_return
            ,dataset6.order_id
            ,dataset6.date_article_returned
            ,dataset6.date_customer_order_returned
            ,dataset6.date_returned_online
            ,dataset6.shipping_country
            ,dataset6.date_article_returned_grails
            ,dataset6.date_article_lost_grails
        FROM
            dataset6
        WHERE
            cast (
                date_last_return as date
            ) < date_stock_booked_minus_1_week
            AND cast (
                date_customer_order_returned as date
            ) >= date_stock_booked_minus_1_week
            AND cast (
                date_customer_order_returned as date
            ) >= date_stock_booked_minus_1_week
            AND cast (
                date_customer_order_returned as date
            ) <= date_stock_booked
            AND dataset6.shipping_country <> 'CH'
            AND dataset6.date_stock_booked > dataset6.date_customer_order_returned
        ORDER BY
            2 desc
            ,1 desc
) SELECT
        YEAR (date_stock_booked_minus_1_week) as year_date_stock_booked_1_week
        ,MONTH (date_stock_booked_minus_1_week) as month_date_stock_booked_minus_1_week
        ,COUNT (
            distinct date_stock_booked
        ) as sum_misbooked
        ,COUNT (
            distinct article_id
        ) as count_article_id
        ,COUNT (
            distinct co3.order_id
        ) as sum_order_returned
        ,COUNT (
            distinct dataset7.order_id
        ) as sum_order_ds
    FROM
        dataset7 
        JOIN 
        (
        	SELECT 
				order_id,
				comment
			FROM ""raw.order_comment"" oc
			WHERE 
			comment LIKE '%manuell%' OR
			comment LIKE '%Retoure%' OR
			comment LIKE '%retourniert%'
			AND 
			(LOWER(comment) NOT LIKE '%manuell retourniert%' OR LOWER(comment) NOT LIKE '%manuell retourniert%'
		 	OR LOWER(comment) NOT LIKE '%manuelle retoure%')
        ) oc on oc.order_id=dataset7.order_id
        LEFT JOIN bi.customer_order co3
        on YEAR (co3.date_returned) = YEAR (dataset7.date_stock_booked_minus_1_week)
        AND MONTH (co3.date_returned) = MONTH (dataset7.date_stock_booked_minus_1_week)
    WHERE co3.shipping_country <> 'CH'
    GROUP BY
        1
        ,2"	READY
196,663	2015-06-11 14:20:02	"1112787961"	true	2015-07-08 14:00:48	ob.molor		"CREATE VIEW ob.molor AS
SELECT
    molor_id,
    article_id AS article_id_arbitrary,
    category,
    product_group,
    flat_category,
    outfit_slot__belt,
    outfit_slot__headwear,
    outfit_slot__jacket,
    outfit_slot__neckwear,
    outfit_slot__over_shirt,
    outfit_slot__shirt,
    outfit_slot__shoes,
    outfit_slot__socks,
    outfit_slot__suit,
    outfit_slot__tie,
    outfit_slot__trousers,
    outfit_slot__underwear,
    outfit_slot__gloves,
    outfit_slot__swimwear,
    sales_price_de
    FROM
    (SELECT
        item_details.*,
        ROW_NUMBER() OVER (PARTITION BY item_details.molor_id
                           ORDER BY item_details.article_id) AS rank
        FROM
        (SELECT
        item.article_id AS article_id,
        am.molor_id,
        item.category,
        item.product_group,
        slot.flat_category,
        cast(slot.outfit_slot = 'belt' AS integer) AS ""outfit_slot__belt"",
        cast(slot.outfit_slot = 'headwear' AS integer) AS ""outfit_slot__headwear"",
        cast(slot.outfit_slot = 'jacket' AS integer) AS ""outfit_slot__jacket"",
        cast(slot.outfit_slot = 'neckwear' AS integer) AS ""outfit_slot__neckwear"",
        cast(slot.outfit_slot = 'over_shirt' AS integer) AS ""outfit_slot__over_shirt"",
        cast(slot.outfit_slot = 'shirt' AS integer) AS ""outfit_slot__shirt"",
        cast(slot.outfit_slot = 'shoes' AS integer) AS ""outfit_slot__shoes"",
        cast(slot.outfit_slot = 'socks' AS integer) AS ""outfit_slot__socks"",
        cast(slot.outfit_slot = 'suit' AS integer) AS ""outfit_slot__suit"",
        cast(slot.outfit_slot = 'tie' AS integer) AS ""outfit_slot__tie"",
        cast(slot.outfit_slot = 'trousers' AS integer) AS ""outfit_slot__trousers"",
        cast(slot.outfit_slot = 'underwear' AS integer) AS ""outfit_slot__underwear"",
        cast(slot.outfit_slot = 'gloves' AS integer) AS ""outfit_slot__gloves"",
        cast(slot.outfit_slot = 'swimwear' AS integer) AS ""outfit_slot__swimwear"",
        item.unit_price_de as sales_price_de
        FROM ""bi.item"" AS item
        LEFT JOIN ""ob.product_group_category_slot"" slot
        	ON item.product_group_code = slot.product_group_code
        INNER JOIN ""ob.article__molor"" am
        	ON item.article_id = am.article_id)
        AS item_details)
    AS item_rank
WHERE item_rank.rank = 1
	AND item_rank.molor_id IS NOT NULL
ORDER BY item_rank.molor_id"	READY
196,654	2015-06-09 18:34:10	"1278724668"	true	2015-09-07 17:22:53	tableau.mkt_marketing_investor_reporting		"CREATE VIEW tableau.mkt_marketing_investor_reporting
AS

SELECT
	ab.reporting_type,
  	ab.""date"", 
  	ab.domain, 
  	ab.marketing_channel, 
  	ad.incoming_orders_adjusted, 
  	ad.invoiced_orders_adjusted,
  	ad.sales_sent_adjusted,
  	ad.sales_kept_adjusted,
  	ad.billing_total_adjusted,
  	ad.billing_net_sales_adjusted,
  	CASE 
		WHEN ab.reporting_type = 'date_incoming' THEN SUM(mc3.cost)
		WHEN ab.reporting_type = 'date_invoiced' AND (SUM(cmc.attributed_costs_total) is null OR SUM(cmc.attributed_costs_total) = 0) THEN null
	 	WHEN ab.reporting_type = 'date_invoiced' AND (SUM(amc.actual_costs_total) is null OR SUM(amc.actual_costs_total) = 0)  THEN null
	 	ELSE (SUM(mc3.cost)/SUM(amc.actual_costs_total))*SUM(cmc.attributed_costs_total)
  	END as cost  
FROM
(
  SELECT
		rt.reporting_type,
	 	c.date,
	 	x.domain,
	 	y.marketing_channel
  	FROM dwh.calendar c 
  	CROSS JOIN (SELECT domain FROM raw.ga_visits WHERE domain != 'ALL' GROUP BY 1) x
  	CROSS JOIN 
  	(
  	SELECT marketing_channel FROM dwh.marketing_sub_channels GROUP BY 1
  	) y
  	CROSS JOIN (SELECT 'date_incoming' as reporting_type UNION SELECT 'date_invoiced' as reporting_type) rt
  	WHERE c.date > '2012'
  	AND c.date < CURDATE()
) ab
LEFT JOIN bi.marketing_referral_brand_effect_attribution ad ON ad.reporting_type = ab.reporting_type AND ad.""date""=ab.""date"" AND ad.domain=ab.domain AND ad.marketing_channel=ab.marketing_channel
LEFT JOIN
(
	SELECT
		mc2.date_created,
		 mc2.country,
		 mc2.marketing_channel,
		 SUM(mc2.cost) as cost    
	FROM raw.marketing_costs mc2
	GROUP BY 1,2,3
) mc3 ON ab.""date"" = mc3.date_created AND mc3.country = ab.domain AND mc3.marketing_channel = ab.marketing_channel
LEFT JOIN
(
 SELECT 
	 date_invoiced as ""date"",
	 country,
	 SUM(CAST(cost as decimal)*-1) as attributed_costs_total
  FROM bi.company_costs_marketing 
  GROUP BY 1,2
) cmc ON ab.""date"" = cmc.""date"" AND ab.domain = cmc.country
LEFT JOIN
(
  SELECT  
		 date_created as ""date"",
		country,
		SUM(CAST(cost as decimal)) as actual_costs_total
  FROM raw.marketing_costs
  GROUP BY 1,2  
) amc ON ab.""date"" = amc.""date"" AND ab.domain = amc.country
GROUP BY 1,2,3,4,5,6,7,8,9,10"	READY
196,664	2015-06-11 14:22:06	"1112787962"	true	2015-07-14 14:55:16	ob.outfit_candidate		"CREATE VIEW ob.outfit_candidate AS
SELECT DISTINCT
	'order_group__' || coa.outfit_id AS ""outfit_candidate_id"",
	'order_group' AS ""origin"",
	coa.outfit_id AS ""origin_candidate_id"",
	co.stylist_id,
	co.customer_id
FROM ""bi.customer_order"" co
LEFT JOIN ""bi.customer_order_articles"" coa
	ON coa.order_id = co.order_id
WHERE co.date_stylist_picked > '2014-01-01'
	AND coa.outfit_id IS NOT NULL
	AND co.order_type != 'First Order Follow-on'
	AND co.order_type != 'Repeat Order Follow-on'"	READY
196,673	2015-06-11 18:38:08	"1112787966"	true	2015-06-19 11:41:32	ob.outfit_candidate__molor		"CREATE VIEW ob.outfit_candidate__molor AS
SELECT DISTINCT
	oc.outfit_candidate_id,
	am.molor_id
FROM ""bi.customer_order"" co
LEFT JOIN ""bi.customer_order_articles"" AS coa
	ON coa.order_id = co.order_id
LEFT JOIN ""ob.outfit_candidate"" AS oc
	ON oc.origin_candidate_id = coa.outfit_id
INNER JOIN ""ob.article__molor"" AS am
	ON am.article_id = coa.article_id
LEFT JOIN ""bi.item"" AS item
	ON item.article_id = am.article_id
WHERE co.date_stylist_picked > '2014-01-01'
  AND coa.outfit_id IS NOT NULL
  AND am.molor_id IS NOT NULL
ORDER BY oc.outfit_candidate_id"	READY
196,674	2015-06-11 18:38:28	"1112787967"	true	2015-06-19 11:41:35	ob.article__molor		"CREATE VIEW ob.article__molor AS
SELECT
	item.article_id,
	item.item_no || '_' || item.color_code AS molor_id
FROM bi.item item
WHERE item.article_id IS NOT NULL
  AND item.item_status != 'Stop Amidala'
ORDER BY item.article_id ASC"	READY
196,675	2015-06-12 15:03:16	"1112787968"	true	2015-06-15 09:53:54	bi.po_received_dates		"CREATE VIEW bi.po_received_dates AS

/* This query takes the min/max dates at the item_no + color_code level, then assigns it back to the article_ids */

SELECT
	item.article_id,
	dates.date_po_received_min,
	dates.date_po_received_max
FROM
	(
	SELECT
		item.item_no,
		item.color_code,
		MIN(book.stock_booking_date) AS date_po_received_min,
		MAX(book.stock_booking_date) AS date_po_received_max
	FROM
		bi.stock_booked AS book
		LEFT JOIN
		bi.item
			ON book.article_id = item.article_id
	WHERE
			book.po_bookings IS NOT NULL
		AND item.item_no IS NOT NULL
	GROUP BY 1,2
	) AS dates
	LEFT JOIN
	bi.item
		 ON dates.item_no 		= item.item_no
		AND dates.color_code 	= item.color_code"	READY
196,676	2015-06-12 15:16:52	"1112787969"	true	2015-06-12 15:16:52	tableau.ops_dpd_test		"CREATE view tableau.ops_dpd_test
AS

SELECT 
  co.id, 
  INITCAP(ship_add.first_name) as shipping_first_name,
  INITCAP(ship_add.last_name) as shipping_last_name,
  INITCAP(ship_add.street) as shipping_street,
  ship_add.street_number as shipping_street_number,
  INITCAP(ship_add.co) as shipping_co,
  ship_add.zip as shipping_zip,
  INITCAP(ship_add.city) as shipping_city,
  CASE 
  WHEN ship_add.country='A' THEN 'AT'
  WHEN ship_add.country='' THEN null
  ELSE ship_add.country 
  END as shipping_country
FROM postgres.customer_order co
JOIN postgres.address as ship_add on ship_add.id = co.shipping_address_id
where cast(date_picked as date)=curdate()
and country='DE'"	READY
196,680	2015-06-16 12:09:38	"1112787970"	true	2015-06-16 12:09:38	tableau.mkt_pick_call_drop_off_list		"CREATE VIEW tableau.mkt_pick_call_drop_off_list
AS
SELECT
	cu.customer_id,
	cu.date_created,
	cu.phone_number,
	cu.first_name,
	cu.last_name,
	cu.default_domain,
	sf.date_last_contacted,
	sf.last_call_reactivation,
	sf.last_reactivation_result
FROM bi.customer cu
LEFT JOIN raw.stylist st ON st.stylist_id = cu.stylist_id
LEFT JOIN
(
SELECT	
	customer_id,
	COUNT(order_id) as order_count
FROM bi.customer_order
WHERE date_invoiced is not null
GROUP BY 1
) co ON co.customer_id = cu.customer_id
LEFT JOIN
(
	SELECT 
		customer_id,
		date_last_contacted,
		last_call_reactivation,
		last_reactivation_result
FROM raw.customer_salesforce
) sf ON sf.customer_id = cu.customer_id
WHERE st.role = 'Fake'
AND phone_number is not null
AND co.order_count is null
ORDER BY 2"	READY
917,510	2015-09-28 18:08:44	"1389129788"	true	2015-09-29 09:54:05	raw.dfc_calls		"CREATE VIEW raw.dfc_calls
AS

WITH dfc AS
(
SELECT 
  ROW_NUMBER() over(PARTITION BY order_id ORDER BY date_create DESC) AS rank,
  order_id,
  date_create as date_created,
  comment 
FROM ""postgres.order_comment"" 
WHERE lower(comment) like '%dfc%'
)
SELECT 
  a.order_id,
  a.date_created as date_last_contacted,
  a.comment,
  b.nb_of_tries,
  CASE WHEN LOWER(comment) like '%dfc erreicht%' THEN 1 ELSE 0 END AS reached
FROM 
(
  SELECT 
  * 
  FROM dfc a 
  WHERE rank=1 
) a
LEFT JOIN
(
  SELECT
    order_id,
    COUNT(*) as nb_of_tries
  FROM dfc
  GROUP BY 1
)b ON b.order_id=a.order_id"	READY
239	2015-04-24 18:19:28	"1253466977"	true	2015-09-02 15:52:20	raw.marketing_contacts_snowplow		"CREATE VIEW raw.marketing_contacts_snowplow
AS


SELECT
	ab.order_id,
	vi.date_created as contact_timestamp,
	vi.visitor_session_id,
	marketing_channel,
	marketing_subchannel,
	LOWER(source) as source,
	LOWER(medium) as medium,
	LOWER(campaign) as campaign,
	LOWER(term) as term
FROM(
	SELECT 
		tr.visitor_id,
		tr.user_id,
		tr.order_id,
		tr.date_created,
		CASE
			WHEN tr.date_created_previous_order is null THEN '2014-01-01'
			ELSE tr.date_created_previous_order
		END AS date_created_previous_order
	FROM raw.snowplow_transactions tr
) ab
LEFT JOIN raw.snowplow_visits vi ON vi.visitor_id = ab.visitor_id
WHERE vi.date_created < ab.date_created
AND  vi.date_created >= ab.date_created_previous_order"	READY
32,810	2015-04-28 18:05:47	"656779492"	true	2015-04-28 18:07:10	am.check_variant		CREATE VIEW am.check_variant AS
SELECT
v.pim_model_id,
v.pim_size_variation_id,
v.pim_color_variation_id,
CASE WHEN v.supplier_color_code IS NOT NULL THEN 1 ELSE 0 END "has_supplier_color_code",
CASE WHEN v.size_erp IS NOT NULL THEN 1 ELSE 0 END "has_size_erp",
CASE WHEN v.season_erp IS NOT NULL THEN 1 ELSE 0 END "has_season_erp",
CASE WHEN v.ean IS NOT NULL THEN 1 ELSE 0 END "has_ean",
CASE WHEN v.color_code_erp IS NOT NULL THEN 1 ELSE 0 END "has_color_code_erp"
FROM
"am.variant_pre_4" v	READY
28	2015-04-24 18:17:16	"656779502"	true	2015-04-28 18:16:46	raw.stock_scanned		"CREATE VIEW raw.stock_scanned AS

SELECT 
	CAST(po AS LONG) AS purchase_order_id,
	ean AS article_ean,
	CASE 
		WHEN ean_unknown = 'JA' THEN 'ean unknown'
	END AS scan_ean_unknown,
	CASE 
		WHEN article_overdelivered = 'JA' THEN 'article overdelivered'
	END AS scan_article_overdelivered,
	CASE 
		WHEN photo_article = 'JA' THEN 'photo article selected'
	END AS scan_photo_article,
	CASE
		WHEN hanging = 'JA' THEN 'garment'
	END AS scan_garment,
	CASE
		WHEN ean_unknown = 'JA' THEN 'ean unknown'
		WHEN article_overdelivered = 'JA' THEN 'article overdelivered'
	END AS scan_clarification_case,
	delivery_note AS stock_delivery_note,
	parseTimestamp(date_delivered, 'yyyy-MM-dd HH:mm:ss.S') AS date_stock_delivered,
	parseTimestamp(date_scanned, 'yyyy-MM-dd HH:mm:ss.S') AS date_stock_scanned,
	parseTimestamp(date_given_to_serviceprovi, 'yyyy-MM-dd HH:mm:ss.S') AS date_stock_handedover,
	parseTimestamp(date_uploaded, 'yyyy-MM-dd HH:mm:ss.S') AS date_stock_uploaded,
	added_value AS scan_added_value
FROM 
	dwh.scantemplatestool
WHERE 
		po IS NOT NULL 
	 OR ean IS NOT NULL 
	 OR delivery_note IS NOT NULL


/* ORIGINAL CODE
SELECT 
	po AS purchase_order_id,
	ean AS article_ean,
	CASE 
		WHEN ean_unknown = 'JA' THEN 'ean unknown'
	END AS scan_ean_unknown,
	CASE 
		WHEN article_overdelivered = 'JA' THEN 'article overdelivered'
	END AS scan_article_overdelivered,
	CASE 
		WHEN photo_article = 'JA' THEN 'photo article selected'
	END AS scan_photo_article,
	CASE
		WHEN ean_unknown = 'JA' THEN 'ean unknown'
		WHEN article_overdelivered = 'JA' THEN 'article overdelivered'
	END AS scan_clarification_case,
	delivery_note AS stock_delivery_note,
	parseTimestamp(date_delivered, 'yyyy-MM-dd HH:mm:ss.S') AS date_stock_delivered,
	parseTimestamp(date_scanned, 'yyyy-MM-dd HH:mm:ss.S') AS date_stock_scanned,
	parseTimestamp(date_given_to_serviceprovi, 'yyyy-MM-dd HH:mm:ss.S') AS date_stock_handedover,
	parseTimestamp(date_uploaded, 'yyyy-MM-dd HH:mm:ss.S') AS date_stock_uploaded
FROM 
	dwh.scantemplatestool
WHERE 
		po IS NOT NULL 
	 OR ean IS NOT NULL 
	 OR delivery_note IS NOT NULL
*/"	READY
32,800	2015-04-28 15:30:54	"1112787891"	true	2015-04-28 16:25:32	bi.company_costs_direct		"CREATE VIEW bi.company_costs_direct
AS

/* Past costs from the finance team are entered into dwh.company_costs_direct_monthly,
are converted into a cost per order for the current number of real orders in each month */

WITH orders_invoiced AS
(
  SELECT 
    cal1.year_month,
    co1.shipping_country,
    COUNT(*) as num_orders
    FROM bi.customer_order co1
    JOIN dwh.calendar cal1 on cal1.date = CAST(co1.date_invoiced as date)
    WHERE co1.is_real_order = 'Real Order'
    AND co1.order_state_number >= 16
    AND co1.order_state_number < 2048
    GROUP BY 1,2
)

/* Join monthly costs to calendar to get daily cost per order */
SELECT
    cal.date as date_invoiced,
    x.country,
    x.cost_type,
    x.cost_per_order
FROM dwh.calendar cal
JOIN 
(
    /* First join real costs to orders to get cost per order for past months */
    SELECT
        od1.year_month,
        cos1.country_code as country,
        cos1.cost_type,
        CAST(cos1.cost as bigdecimal) as cost,
        cos1.cost/od1.num_orders as cost_per_order
    FROM orders_invoiced od1
    LEFT JOIN raw.company_cost cos1 on cos1.year_month = od1.year_month AND od1.shipping_country = cos1.country_code

    /* Now do a UNION to use the latest known month's costs for all future months */
    UNION
    SELECT
        b.year_month,
        a.country,
        a.cost_type,
        CAST(a.cost as bigdecimal) as cost,
        a.cost_per_order
    FROM
    (
        SELECT
        cos2.cost_type,
        cos2.country_code as country,
        cos2.cost,
        cos2.cost/od2.num_orders as cost_per_order
        FROM orders_invoiced od2
        JOIN raw.company_cost cos2 on cos2.year_month = od2.year_month AND od2.shipping_country = cos2.country_code
        WHERE cos2.cost_type<>'payment' AND cos2.year_month = (SELECT MAX(year_month) FROM raw.company_cost WHERE cost_type<>'payment')  /* Select the last month with known costs */
    ) a
    /* Cross join the costs with all months that have no cost data */
    CROSS JOIN
    (
    SELECT
      od3.year_month
    FROM 
    (
      SELECT 
        DISTINCT ca1.year_month
      FROM bi.customer_order co3
      JOIN dwh.calendar ca1 on ca1.date = CAST(co3.date_invoiced as date)
      WHERE co3.is_real_order = 'Real Order'
      AND co3.order_state_number >= 16
      AND co3.order_state_number < 2048
    ) od3
    LEFT JOIN (select * from raw.company_cost where cost_type<>'payment') cos3 on cos3.year_month = od3.year_month
    WHERE cos3.year_month is null
    AND od3.year_month > '2014'
    ) b
) x on x.year_month = cal.year_month"	READY
557,063	2015-08-18 14:48:22	"1179990323"	true	2015-08-18 14:48:22	tableau.mkt_discount_campaign_last_click		"CREATE VIEW tableau.mkt_discount_campaign_last_click
AS

SELECT 
	dc.order_id,
	dc.marketing_channel,
	dc.marketing_campaign,
	CASE
		WHEN lc.marketing_channel_last_click is null THEN 'Untracked'
		ELSE lc.marketing_channel_last_click
	END AS marketing_channel_last_click
FROM raw.marketing_contacts_discounts dc
LEFT JOIN
(
	SELECT
		order_id,
		marketing_channel as marketing_channel_last_click
	FROM
	(
		SELECT 
			order_id,
			contact_timestamp,
			marketing_channel,
			RANK () OVER (PARTITION BY order_id ORDER BY contact_timestamp DESC) as contact_count_desc
		FROM raw.marketing_contacts_web
	) ab
	WHERE contact_count_desc = 1	
) lc ON lc.order_id = dc.order_id"	READY
32,816	2015-04-28 18:52:17	"770346402"	true	2015-05-20 17:44:04	am.base		CREATE VIEW am.base AS
SELECT
bp.*,
sg.size_group_code "size_group_code"
FROM "am.base_pre" bp
LEFT JOIN "am.pim_model__size_group_code__indexed" sg ON sg.pim_model_id = bp.pim_model_id	READY
32,805	2015-04-28 17:49:04	"656779347"	true	2015-04-28 17:49:04	am.pim_model__size_group_code		CREATE VIEW "am.pim_model__size_group_code" AS
SELECT DISTINCT pim_model_id, size_group_code FROM "am.variant_pre_4" 
WHERE size_group_code IS NOT NULL
GROUP BY pim_model_id, size_group_code	READY
32,806	2015-04-28 17:52:02	"656779349"	true	2015-04-28 17:52:02	am.pim_model__size_group_code__indexed		"CREATE VIEW ""am.pim_model__size_group_code__indexed""  AS
WITH ""pim_model__size_group_count"" AS (
	SELECT pim_model_id, COUNT(*) ""size_group_count""
    FROM am.pim_model__size_group_code
    GROUP BY pim_model_id )
SELECT
sg.pim_model_id,
sg.size_group_code
FROM ""pim_model__size_group_count"" msgc
LEFT JOIN ""am.pim_model__size_group_code"" sg ON sg.pim_model_id = msgc.pim_model_id
WHERE size_group_count = 1"	READY
32,815	2015-04-28 18:45:17	"656779563"	true	2015-04-28 18:45:17	am.brand_pim__creditor		"CREATE VIEW am.brand_pim__creditor AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.brand_pim__creditor.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""brand_pim"" STRING ,
		""creditor"" STRING 
		DELIMITER ',' 
		QUOTE '""' 
		HEADER 1 
	)
""csv_table"""	READY
32,813	2015-04-28 18:25:53	"661460413"	true	2015-04-29 12:17:51	am.check_base__all		CREATE VIEW "am.check_base__all" AS
SELECT
cb.pim_model_id,
(
cb.has_article_category = 1
AND cb.has_product_group = 1
AND cb.has_pim_model_id = 1
AND cb.has_pieces = 1
AND cb.has_gender = 1
AND cb.has_color_group_code = 1
AND cb.has_brand_erp = 1
AND cb.has_article_name = 1
AND cb.has_size_group_code = 1
)  "has_all"
FROM "am.check_base" cb	READY
32,819	2015-04-29 09:32:32	"770344742"	true	2015-05-20 14:13:49	am.variant_pre_5		CREATE VIEW "am.variant_pre_5" AS
SELECT
v.*,
CASE
WHEN o.age = 'all' THEN 'ALL'
WHEN o.age = 'over_40' THEN 'OVER40'
WHEN o.age = 'under_40' THEN 'UNDER40'
ELSE NULL
END AS "age",
CASE
WHEN o_color_variation.amidala_deactive THEN 'STOP'
WHEN o_color_variation.push = 1 THEN 'PUSH'
ELSE 'FREE' END "state_erp",
pics.pics "pics"
FROM "am.variant_pre_4" v
LEFT JOIN "am.object_17" o_color_variation ON o_color_variation.o_id = v.pim_color_variation_id
LEFT JOIN "am.object_17" o ON o.o_id = v.pim_model_id
LEFT JOIN "am.o__pics" pics ON pics.o_id = o_color_variation.o_id	READY
32,808	2015-04-28 17:57:00	"656779404"	true	2015-04-28 17:57:00	am.variant_pre		"CREATE VIEW ""am.variant_pre"" AS
SELECT
size_variation.o_id AS ""pim_size_variation_id"",
size_variation.ean AS ""ean"",
article.pim_model_id AS ""pim_model_id"",
color_variation.o_id AS ""pim_color_variation_id"",
article.brand_pim ""brand_pim"",
article.commodity_group4 ""commodity_group4"",
season.season_pim,
season.season_erp,
size_variation.net_weight_gram AS ""weight_net"",
size_variation.gross_weight_gram AS ""weight_gross"",
CAST (size_variation.purchase_price AS BIGDECIMAL) AS ""purchase_price"",
CAST (size_variation.price_retail_de AS BIGDECIMAL) AS ""retail_price_de"",
CAST (size_variation.price_retail_chf AS BIGDECIMAL) AS ""retail_price_ch"",
CAST (size_variation.price_retail_dkk AS BIGDECIMAL) AS ""retail_price_dk"",
CAST (size_variation.price_retail_sek AS BIGDECIMAL) AS ""retail_price_se"",
CAST (size_variation.price_retail_benelux AS BIGDECIMAL) AS ""retail_price_lu"",
CAST (size_variation.price_retail_benelux AS BIGDECIMAL) AS ""retail_price_nl"",
CAST (size_variation.price_retail_benelux AS BIGDECIMAL) AS ""retail_price_be"",
TRIM(size_variation.eu_size) AS ""eu_size"",
CASE
WHEN size_variation.eu_length IS NOT NULL THEN TRIM(size_variation.eu_size) || 'x' || TRIM(size_variation.eu_length)
ELSE NULL
END AS ""eu_size_x_length"",
CASE WHEN color_variation.supplier_color_code IS NULL THEN 'None' ELSE TRIM(color_variation.supplier_color_code) END AS ""supplier_color_code"",
CASE WHEN color_variation.color1 IS NULL THEN 'None' ELSE TRIM(color_variation.color1) END AS ""color1""
FROM am.base_pre ""article""
INNER JOIN am.object_17 ""color_variation"" ON color_variation.o_parentId = article.pim_model_id
INNER JOIN am.object_17 ""size_variation"" ON size_variation.o_parentId = color_variation.o_id
LEFT JOIN ""am.season_pim__season_erp"" season ON season.season_pim = color_variation.season
AND color_variation.o_type = 'variant'
AND size_variation.o_type = 'variant'"	READY
32,814	2015-04-28 18:29:19	"770348368"	true	2015-05-20 19:38:01	am.check_complete		CREATE VIEW am.check_complete AS
SELECT 
c.pim_model_id,
(c.has_all AND cvg.has_all_in_group ) "all_okay"
FROM "am.check_base__all" c
LEFT JOIN "am.check_variant__grouped" cvg ON cvg.pim_model_id = c.pim_model_id
OPTION $NOOPT	READY
32,812	2015-04-28 18:19:44	"656779517"	true	2015-04-28 18:19:59	am.check_base		CREATE VIEW am.check_base AS
SELECT
b.pim_model_id,
CASE WHEN b.article_category IS NOT NULL THEN 1 ELSE 0 END "has_article_category",
CASE WHEN b.product_group IS NOT NULL THEN 1 ELSE 0 END "has_product_group",
CASE WHEN b.pim_model_id IS NOT NULL THEN 1 ELSE 0 END "has_pim_model_id",
CASE WHEN b.pieces IS NOT NULL THEN 1 ELSE 0 END "has_pieces",
CASE WHEN b.gender IS NOT NULL THEN 1 ELSE 0 END "has_gender",
CASE WHEN b.color_group_code IS NOT NULL THEN 1 ELSE 0 END "has_color_group_code",
CASE WHEN b.brand_erp IS NOT NULL THEN 1 ELSE 0 END "has_brand_erp",
CASE WHEN b.article_name IS NOT NULL THEN 1 ELSE 0 END "has_article_name",
CASE WHEN b.size_group_code IS NOT NULL THEN 1 ELSE 0 END "has_size_group_code"
FROM "am.base" b	READY
7	2015-04-24 18:17:10	"1112787623"	true	2015-04-24 18:17:10	raw.purchase_order		"CREATE VIEW raw.purchase_order AS

SELECT
	po.id AS purchase_order_id,
	po.order_id,
	po.date_created AS po_date_created,
	po.date_fulfilled AS po_date_fulfilled,
	po.date_canceled AS po_date_cancelled,
	po.due_date AS po_date_due,
	po.last_updated AS po_date_updated,
	po.date_initialized AS po_date_initialized,
	/* ddpo.po_import_result AS po_date_import_result, */
	po.supplier_id,
	po.state AS po_state_number,
	po.class AS po_class,
	CASE
		WHEN po.order_typ ='Sonderposten' 	THEN 'special reduced price order'
		WHEN po.order_typ ='Vororder' 		THEN 'early order for later season'
		WHEN po.order_typ ='Nachorder' 		THEN 'reorder'
		WHEN po.order_typ ='Sofortorder' 	THEN 'order delivered instantly'
		WHEN po.order_typ ='Blockorder' 	THEN 'optional order held at supplier'
		WHEN po.order_typ IS NULL THEN NULL
		ELSE 'Ask BI'
	END AS po_order_type,
	CASE
		WHEN po.state = 4 		THEN 'PO created'
		WHEN po.state = 8 		THEN 'PO issued to supplier'
		WHEN po.state = 1024 	THEN 'PO complete'
		WHEN po.state = 2048	THEN 'PO cancelled'
		ELSE 'Ask BI'
	END AS po_state,
	CASE
		WHEN po.season IS NULL THEN NULL
		ELSE
		CASE
			WHEN po.season LIKE '%13' OR po.season LIKE '%2013%' THEN '2013-'
			WHEN po.season LIKE '%14' OR po.season LIKE '%2014%' THEN '2014-'
			WHEN po.season LIKE '%15' OR po.season LIKE '%2015%' THEN '2015-'
			WHEN po.season LIKE '%16' OR po.season LIKE '%2016%' THEN '2016-'
			WHEN po.season LIKE '%17' OR po.season LIKE '%2017%' THEN '2017-'
			WHEN po.season LIKE '%18' OR po.season LIKE '%2018%' THEN '2018-'
			WHEN po.season LIKE '%19' OR po.season LIKE '%2019%' THEN '2019-'
			WHEN po.season LIKE '%20' OR po.season LIKE '%2020%' THEN '2020-'
			ELSE ''
		END ||
		CASE
			WHEN LOWER(po.season) LIKE '%fs%' 	 		THEN '1-SS'
			WHEN LOWER(po.season) LIKE '%hw%'			THEN '2-FW'
			ELSE ''
		END 
	END AS po_season,
	po.flagged_for_resubmission AS po_flagged_for_resubmission,
	po.stock_location_id
FROM
	postgres.purchase_order po
	/*
	LEFT JOIN
	(
		SELECT 
			outfittery_purchaseid, MAX(ddpo.date_created) AS po_import_result
		FROM
			postgres.doc_data_purchase_order_import_result ddpo
		GROUP BY 1
	) ddpo
		ON po.id = ddpo.outfittery_purchaseid
	*/"	READY
65,552	2015-05-05 16:11:24	"1112787914"	true	2015-05-11 15:01:36	forecast.customer__first_order		"CREATE VIEW forecast.customer__first_order AS
SELECT
	co.customer_id,
	co.order_id,
	co.date_shipped,
	co.box_type,
	co.shipping_country,
	club.first_club_order_date_shipped
FROM ""bi.customer_order"" co
LEFT JOIN
(SELECT
	c.customer_id,
	c.date_shipped AS first_club_order_date_shipped
FROM
(SELECT 
	co2.customer_id,
    co2.date_shipped,
	ROW_NUMBER() OVER ( PARTITION BY co2.customer_id ORDER BY co2.date_shipped ASC) AS rank
 FROM ""bi.customer_order"" AS co2
 WHERE co2.order_type = 'Outfittery Club Order') AS c
WHERE c.rank = 1 ) AS club
	ON club.customer_id = co.customer_id
WHERE co.order_type = 'First Order'
AND co.date_shipped IS NOT NULL"	READY
32,811	2015-04-28 18:14:40	"661460432"	true	2015-04-29 12:26:34	am.check_variant__grouped		CREATE VIEW "am.check_variant__grouped" AS
SELECT
pim_model_id,
( x.has_supplier_color_code = 1
AND x.has_size_erp = 1
AND x.has_season_erp = 1
AND x.has_ean = 1
AND x.has_color_code_erp = 1
) "has_all_in_group"
FROM (
SELECT 
pim_model_id,
MIN(c.has_supplier_color_code) "has_supplier_color_code",
MIN(c.has_size_erp) "has_size_erp",
MIN(c.has_season_erp) "has_season_erp",
MIN(c.has_ean) "has_ean",
MIN(c.has_color_code_erp) "has_color_code_erp"
FROM "am.check_variant" c
GROUP BY pim_model_id ) x	READY
8	2015-04-24 18:17:11	"1112787624"	true	2015-04-24 18:17:11	views.preview_data		"CREATE view views.preview_data
as
select
p.preview_id as parent_preview_id,
p.id as preview_id,
p.customer_id as customer_id,
p.date_created as date_created,
p.last_updated as last_updated,
p.order_id as order_id,
p.state as state,
p.class as class,
p.created_by_id as created_by_id,
p.name as name,
pp.id as position_id,
pp.version as position_version,
pp.article_id as position_article_id,
pp.date_created as position_date_created,
pp.feedback_reason_id as position_feedback_reason_id,
pp.last_updated as position_last_updated,
pp.property_id as position_property_id,
pp.variant as position_variant,
pp.preview_positions_idx as position_preview_position_idx,
pp.group_id as position_group_id
from postgres.preview p 
inner join postgres.preview_position pp on pp.preview_id = p.id"	READY
9	2015-04-24 18:17:11	"1112787625"	true	2015-04-24 18:17:11	views.billing_data		"CREATE view views.billing_data
as
/*This view has credit card information if customer entered during registration*/
SELECT 
  bd.id,
  bd.credit_card_brand,
  bd.credit_card_expires,
  bd.credit_card_number,
  bd.customer_id,type,
  bd.bank_account_holder,
  bd.bank_account_number,
  bd.bank_code,
  bd.bank_due_date,
  bd.bank_name,
  bd.bank_payer_note,
  bt.date_credit_card_entered
FROM ""postgres"".""billing_data"" bd
/*this join gets the credit card entered date, we don't have this detail in billing data*/
LEFT JOIN
(
  SELECT 
    billing_data_id,
    MIN(date_credit_card_entered) as date_credit_card_entered 
  FROM
  (
    select
      bt.billing_data_id,
      MIN(bt.date_created) OVER (PARTITION BY bt.billing_data_id) AS date_credit_card_entered
    FROM postgres.billing_transaction bt
  )a
  GROUP BY 1
)bt on bt.billing_data_id=bd.id"	READY
65,554	2015-05-05 16:36:19	"1112787916"	true	2015-05-05 16:36:19	forecast.state_vh1		"CREATE VIEW forecast.state_vh1 AS
SELECT
	cofo.customer_id,
	'VH1' AS ""state""
FROM forecast.customer__first_order AS cofo
WHERE TIMESTAMPDIFF(SQL_TSI_DAY, cofo.date_shipped, TIMESTAMPCREATE('2015-01-01', '00:00:00')) >= 30.4
  AND TIMESTAMPDIFF(SQL_TSI_DAY, cofo.date_shipped, TIMESTAMPCREATE('2015-01-01', '00:00:00')) < 2 * 30.4"	READY
196,750	2015-06-22 13:55:12	"1112787973"	true	2015-07-30 14:47:16	tableau.data_source_incoming_purchase_orders		"CREATE VIEW tableau.data_source_incoming_purchase_orders AS

SELECT 
	poa.poa_id AS id, 
	poa.article_id, 
	poa.purchase_order_id, 
	poa.date_poa_created AS date_created,
	poa.stock_ordered_initially AS initial_quantity,
	poa.stock_ordered_revised AS quantity, 
	poa.stock_booked AS fulfilled_quantity,
	poa.stock_scanned,
	poa.poa_supplier_order_number AS supplier_order_number, 
	poa.date_poa_cancelled AS date_canceled, 
	poa.date_poa_fulfilled AS date_fulfilled,
	poa.order_position_id, 
	poa.poa_state_number AS state, 
	poa.article_sales_price AS retail_price, 
	poa.article_cost AS purchase_price,
	poa.poa_position_number AS purchase_order_positions_idx, 
	poa.date_poa_delivery_earliest AS earliest_delivery_date, 
	poa.date_poa_delivery_latest AS latest_delivery_date,
	po.po_season as ""purchase_order_season"",
	po.po_order_type AS order_type,
	i.ean,
	i.size,
	i.brand,
	i.item_description,
	i.category,
	i.product_group,
	i.item_no,
	i.item_status,
	i.parent_no,
	i.supplier_color,
	i.season,
	i.color,
	i.vendor_item_no,
	i.pic1,
	i.pool
FROM
	bi.purchase_order AS po
	JOIN
	bi.purchase_order_articles AS poa
		ON po.purchase_order_id = poa.purchase_order_id
	LEFT JOIN
	bi.item i
		ON poa.article_id = i.article_id
WHERE
	driving_tbl_poa IS NOT NULL

/*  limit 100 */"	READY
196,752	2015-06-23 14:05:30	"1112787974"	true	2015-06-23 14:51:47	tableau.ops_stage_check_sf		"CREATE VIEW tableau.ops_stage_check_sf
AS

/* this query is used to check salesforce stage change*/
SELECT 
	co.order_id,
	cos.salesforce_order_stage,
	co.order_state,
	co.date_shipped,
	co.date_completed,
	co.shipping_country,
	ss.track_and_trace_number,
	st.stylist
FROM bi.customer_order co
LEFT JOIN raw.customer_order_salesforce cos on cos.order_id=co.order_id
LEFT JOIN bi.stylist st on st.stylist_id=co.stylist_id
LEFT JOIN
(
	SELECT 
		order_id,
		track_and_trace_number 
	from raw.stock_shipped ss
	GROUP BY 1,2
)ss on ss.order_id=co.order_id
where co.order_state_number between 128 and 1024"	READY
229,376	2015-06-24 10:54:17	"1112787975"	true	2015-06-24 12:03:57	tableau.ops_error_log_not_checked_out_with_states		"CREATE VIEW tableau.ops_error_log_not_checked_out_with_states AS

SELECT
	coa.order_id,
	coa.article_id,
	co.order_type,
	co.order_state_number,
	order_state,
	coa.order_article_state_number,
	coa.order_article_state,
	coa.date_created
FROM
	bi.customer_order AS co
	JOIN
	bi.customer_order_articles AS coa
		ON co.order_id = coa.order_id
WHERE
		co.date_preview_created IS NULL
	AND	coa.order_article_state_number = 8
	AND coa.date_created >= timestampadd(SQL_TSI_day, -5, curdate())"	READY
375	2015-04-24 18:23:49	"1127038924"	true	2015-08-07 14:01:29	tableau.billing_customer_service_report		"CREATE view tableau.billing_customer_service_report
AS
SELECT 
	co.id,
	co.state,
	co.customer_id,
	co.date_returned,
	co.date_created,
	co.date_shipped,
	co.payment_state,
	co.total_amount_payed,
	co.total_amount_billed_discount,
	co.total_goodwill_credit,
	co.shipping_first_name as first_name,
	co.shipping_last_name as last_name,
	co.shipping_country as country,
	co.payment_method,
	co.total_amount_basket_purchase_gross,
	co.total_amount_basket_retail_gross,
	co.total_amount_billed_retail_gross,
	co.total_amount_billed_purchase_gross,
	a.retoure_value,
	co.invoice_number as reference_number,
	co.invoice_date_created as Rechnungsdatum
FROM views.customer_order co 
LEFT JOIN 
(
	SELECT 
		order_id,
		sum(quantity*retail_price) as retoure_value 
		FROM views.order_position 
		WHERE state=512 
		GROUP BY 1
)a on a.order_id=co.id"	READY
231	2015-04-24 18:19:25	"1112787726"	true	2015-04-24 18:19:25	ml.project_compl_customers		"CREATE VIEW ml.project_compl_customers AS
SELECT
    customer.customer_id,
	customer.spending_budget_for_jeans_from,
	customer.spending_budget_for_jeans_to,
	customer.spending_budget_for_shoes_from,
	customer.spending_budget_for_shoes_to,
	customer.spending_budget_for_shirts_from,
	customer.spending_budget_for_shirts_to,
	customer.spending_budget_for_jackets_from,
	customer.spending_budget_for_jackets_to,
	survey.is_new_survey,
	survey.typical_style__classic,
    survey.typical_style__country,
    survey.typical_style__adventure,
    survey.typical_style__dark_denim,
    survey.typical_style__sporty,
    survey.typical_style__smart_casual,
    survey.typical_style__prints,
    survey.typical_style__excentric,
    survey.age_felt__18_30,
    survey.age_felt__31_35,
    survey.age_felt__36_45,
    survey.age_felt__46_55,
    survey.work_style__suit,
    survey.work_style__smart_casual,
    survey.work_style__casual,
    survey.work_style__relaxed,
    survey.colors_liked__natural,
    survey.colors_liked__denim,
    survey.colors_liked__classic,
    survey.colors_liked__strong,
    survey.typical_shoes__sneakers,
    survey.typical_shoes__boat_shoes,
    survey.typical_shoes__boots,
    survey.typical_shoes__classic_trendy,
    survey.typical_shoes__desert_boots,
    survey.typical_shoes__sneakers_casual,
    survey.typical_shoes__chelsea_boots,
    survey.typical_shoes__classic_business,
    survey.typical_shoes__chucks,
    survey.typical_shoes__sneakers_trendy,
    survey.typical_shoes__timberland_boots,
    survey.would_never_wear__biglogo,
    survey.would_never_wear__checkered,
    survey.would_never_wear__button_down_shirt,
    survey.would_never_wear__pink_shirt,
    survey.would_never_wear__tommy_hilfiger,
    survey.would_never_wear__print_tshirts,
    survey.would_never_wear__polo_shirt,
    survey.brands_liked__scotch_soda,
    survey.brands_liked__levis,
    survey.brands_liked__tiger,
    survey.brands_liked__bugatti,
    survey.brands_liked__gstar,
    survey.brands_liked__gant,
    survey.brands_liked__selected,
    survey.brands_liked__jack_jones,
    survey.brands_liked__strellson,
    survey.brands_liked__tommy,
    survey.brands_liked__ralphlauren,
    survey.brands_liked__marcopolo,
    survey.underwear_style__boxers,
    survey.underwear_style__trunks,
    survey.underwear_style__briefs
FROM raw.customer AS customer
JOIN ml.customer_survey AS survey
	ON survey.customer_id = customer.customer_id"	READY
786,436	2015-09-14 12:46:03	"1314110232"	true	2015-09-14 12:46:03	raw.customer_oder_issue_stg1_view		"create view raw.customer_oder_issue_stg1_view
as
select week(a.date_created) as ""Week_No"", a.vol as ""Repeat"", b.vol as ""follow_on"" , (a.vol+b.vol) as ""Total""
from (	select * from dwh.customer_order_may_aug_repeat
				order by date_created asc) a
left join
			(select * from raw.customer_order_issue_onlyfo 
				order by date_created asc) b
on a.date_created=b.date_created;"	READY
229,445	2015-06-24 18:19:40	"1112787977"	true	2015-07-03 09:04:38	tableau.stylist_no_call		"CREATE view tableau.stylist_no_call
AS

SELECT  
  co.order_id,
  co.date_created,
  st_c.stylist as customer_stylist,
  st_c.team as customer_stylist_team, 
  co.order_sales_stage
FROM bi.customer_order co
LEFT JOIN bi.stylist st_c on st_c.stylist_id = co.stylist_id
LEFT JOIN raw.customer_order_salesforce cos on cos.order_id=co.order_id
LEFT JOIN
(
  SELECT 
    customer_id,
    count(*) as nb_orders
  FROM bi.customer_order 
  GROUP BY 1
)f_order on f_order.customer_id=co.customer_id
WHERE nb_orders=1
AND co.date_phone_call is null
AND cos.ops_check='OK'
AND cos.preview_not_liked='false'"	READY
229,451	2015-06-25 11:49:27	"1112787978"	true	2015-06-29 15:33:20	tableau.ops_customs_check		"CREATE VIEW tableau.ops_customs_check AS

SELECT
	stock.article_id,
	i.item_description,
	i.pic1,
	i.ean,
	i.item_status,
	i.net_weight,
	i.season,
	i.tariff_no,
	i.tariff_no_ch,
	i.brand,
	im.material

FROM
	raw.stock_levels_daily_snapshot stock
	LEFT JOIN
	bi.item i
		ON stock.article_id = i.article_id
	LEFT JOIN
	raw.nav_item_materials im
		ON i.item_no = im.item_no"	READY
229,454	2015-06-26 15:55:38	"1112787979"	true	2015-06-26 16:12:23	sandbox.mc2		"CREATE view sandbox.mc2 as


  SELECT
    mc.date_created,
    mc.country,
    mc.marketing_channel,
    mc.cost as cost_date_incoming,
    CASE WHEN amc.actual_costs_total is null OR amc.actual_costs_total = 0 THEN null
    ELSE mc.cost/amc.actual_costs_total*cmc.attributed_costs_total END as cost_date_invoiced
  FROM
  ( 
    SELECT
      date_created,
      country,
      marketing_channel,
      SUM(CAST(cost as decimal)) as cost    
    FROM raw.marketing_costs
    GROUP BY 1,2,3
  ) mc
  LEFT JOIN
  (
   SELECT 
      date_invoiced as ""date"",
      country,
      SUM(CAST(cost as decimal)*-1) as attributed_costs_total
    FROM bi.company_costs_marketing 
    GROUP BY 1,2
  ) cmc ON mc.date_created = cmc.date AND mc.country = cmc.country
  LEFT JOIN
    (
      SELECT  
        date_created as ""date"",
        country,
        SUM(CAST(cost as decimal)) as actual_costs_total
    FROM raw.marketing_costs
    GROUP BY 1,2  
  ) amc ON mc.date_created = amc.date AND mc.country = amc.country"	READY
262,144	2015-06-29 10:14:30	"1112787980"	true	2015-06-29 11:16:38	tableau.mkt_arvato_acceptance		"CREATE VIEW tableau.mkt_arvato_acceptance
AS
SELECT 
    CAST(co.date_created as date) as date_incoming,
	co.shipping_country,
	CASE
		WHEN at.marketing_channel is null THEN 'Untracked'
		ELSE at.marketing_channel
	END AS marketing_channel, 
	cu.customer_age,
	co.arvato_result,
	SUM(CASE 
		WHEN at.marketing_channel is null THEN 1
		ELSE at.contact_weight
	END) AS weight
FROM bi.marketing_order_attribution at
FULL JOIN bi.customer_order co ON at.order_id = co.order_id
LEFT JOIN bi.customer cu ON co.customer_id = cu.customer_id
WHERE co.shipping_country IN ('DE', 'AT', 'CH', 'NL')
AND co.order_type = 'First Order'
GROUP BY 1,2,3,4,5"	READY
262,151	2015-06-30 17:32:21	"1112787983"	true	2015-06-30 17:33:26	sandbox.cs_cancels_from_audit_log		"CREATE VIEW sandbox.cs_cancels_from_audit_log AS

/* 	currently, cs cancels is coming from salesforce; this is a different approach, but likely not as accurate;
	plus, it has to be manually updated
*/

WITH orders AS
(
SELECT
	persisted_object_id,
	MIN(CAST(a.date_created AS DATE)) AS date_created,
	MIN(CASE
			WHEN property_name = 'dateCanceled' 
				AND actor IN
				( /* THIS LIST NEEDS TO BE UPDATED FOR NEW CUSTOMER SUPPORT PERSONALE */
				'alan.schouten@outfittery.de',
				'amena.zoltani@outfittery.de',
				'caroline.christiansen@outfittery.de',
				'christina.ek@outfittery.de',
				'daniel.schumann@outfittery.de',
				'elisabeth.lengefeldt@outfittery.de',
				'flavia.ostermann@outfittery.de',
				'gregor.becker@outfittery.de',
				'hoang-cam.vu@outfittery.de',
				'jaimie.refo@outfittery.de',
				'janni.bittner@outfittery.de',
				'julia.thierfelder@outfittery.de',
				'lars@outfittery.de',
				'lucie.lauble@outfittery.de',
				'lynsey.sime@outfittery.de',
				'maria.nehme@outfittery.de',
				'mehdi.sangsari@outfittery.de',
				'neele.sippel@outfittery.de',
				'patrick.lueke@outfittery.de',
				'philipp.risse@outfittery.de',
				'roy.roelandt@outfittery.nl',
				'roy@outfittery.de',
				'sandra.jovanovic@outfittery.de',
				'sarah.pawlonka@outfittery.de',
				'sophie.poelchau@outfittery.de',
				'sven.klein@outfittery.de',
				'tolga.tosunoglu@outfittery.de',
				'yanafts@googlemail.com',
				'sarah.juergens@outfittery.de'
				) THEN CAST(a.date_created AS DATE)		
		END) AS date_cancelled
FROM
	postgres.audit_log a
	JOIN
	postgres.customer_order co
		ON a.persisted_object_id = co.id
WHERE
		a.date_created >= '2014-01-01'
	AND co.date_created >= '2014-01-01'
GROUP BY 1
HAVING
	MIN(a.date_created) >= '2014-01-01'
)

SELECT
	date_created,
	COUNT(*) AS orders,
	SUM(CASE WHEN date_cancelled IS NOT NULL THEN 1 END) AS cs_cancels,
	SUM(CASE WHEN date_cancelled IS NOT NULL THEN TIMESTAMPDIFF(SQL_TSI_DAY, date_created, date_cancelled) END) AS total_days_to_cs_cancel
FROM
	orders
GROUP BY 1"	READY
196,610	2015-05-22 16:26:08	"1179990864"	true	2015-08-18 18:47:39	tableau.data_source_item		"CREATE VIEW tableau.data_source_item AS

SELECT * FROM bi.item"	READY
419	2015-04-24 18:26:42	"1112787884"	true	2015-06-23 11:17:19	sandbox.marketing_overview_new		"CREATE VIEW sandbox.marketing_overview_new
AS
SELECT
  pl.date as date_created,
  pl.domain,
  pl.marketing_channel,
  ab.incoming_first_orders,
  ab.invoiced_first_orders,
  inc.actual_invoiced_first_orders,
  ab.sales_sent,
  ab.sales_kept,
  ab.billing_net_sales,
  mc3.cost,
  CAST(cd.visits as BIGINT) as visits,
  amc.actual_costs_total,
 	cmc.attributed_costs_total
FROM
(
    SELECT
    c.date,
        x.domain,
        y.marketing_channel
    FROM dwh.calendar c 
    CROSS JOIN (SELECT domain FROM raw.ga_visits WHERE domain != 'ALL' GROUP BY 1) x
    CROSS JOIN 
    (
  SELECT marketing_channel FROM dwh.marketing_sub_channels GROUP BY 1
  ) y
    WHERE c.date > '2012'
    AND c.date < CURDATE()
    ) pl
    LEFT JOIN
    (
    SELECT 
      cast(co.date_incoming as date) as date_incoming,
      cu.default_domain,
      CASE
        WHEN oa.marketing_channel is null AND co.sales_channel like '%website%' THEN 'Website not tracked'
        WHEN oa.marketing_channel is null AND co.sales_channel not like '%website%' THEN 'Other not tracked'
        ELSE oa.marketing_channel
      END as marketing_channel,
      SUM(oa.contact_weight) as incoming_first_orders,
      SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 AND co.order_state_number < 2048 AND co.date_stylist_picked is not null THEN oa.contact_weight ELSE 0 END) as invoiced_first_orders,
      SUM(oa.contact_weight*co.sales_sent) as sales_sent,
      SUM(oa.contact_weight*co.sales_kept) as sales_kept,
      SUM(oa.contact_weight*co.billing_net_sales) as billing_net_sales 
    FROM bi.customer_order co
    LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
    LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
    WHERE co.date_incoming is not null
    AND co.is_real_order = 'Real Order'
    AND order_type = 'First Order'
    GROUP BY 1,2,3
) ab ON pl.date = ab.date_incoming AND ab.default_domain = pl.domain AND pl.marketing_channel = ab.marketing_channel
LEFT JOIN 
( 
      SELECT 
      cast(co.date_invoiced as date) as ""date"",
      cu.default_domain,
      CASE
        WHEN oa.marketing_channel is null AND co.sales_channel like '%website%' THEN 'Website not tracked'
        WHEN oa.marketing_channel is null AND co.sales_channel not like '%website%' THEN 'Other not tracked'
        ELSE oa.marketing_channel
      END as marketing_channel,
      SUM(oa.contact_weight) as actual_invoiced_first_orders
    FROM bi.customer_order co
    LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
    LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
    WHERE co.date_invoiced is not null
    AND co.is_real_order = 'Real Order'
    AND order_type = 'First Order'
    AND co.order_state_number >= 16
    AND co.order_state_number < 2048
    AND co.date_stylist_picked is not null 
    GROUP BY 1,2,3
) inc ON pl.date = inc.date AND inc.default_domain = pl.domain AND pl.marketing_channel = inc.marketing_channel
LEFT JOIN
(
     SELECT 
        date_created,
        domain,
        marketing_channel,
        SUM(visits) as visits
      FROM raw.ga_visits
      WHERE domain != 'ALL'
      GROUP BY 1,2,3
) cd ON cd.date_created = pl.date AND cd.domain = pl.domain AND cd.marketing_channel = pl.marketing_channel
LEFT JOIN
(
        SELECT
            mc2.date_created,
            mc2.country,
            mc2.marketing_channel,
            SUM(mc2.cost) as cost
        FROM
        (
            SELECT 
                mc.date_created,
                mc.country,
                CASE 
                  WHEN mc.channel = 'google gdn' THEN 'Display'
                  WHEN mc.channel = 'google sem' THEN 'SEM Non-brand'
                  WHEN mc.channel = 'display' THEN 'Display'
                  WHEN mc.channel = 'facebook' THEN 'Facebook'
                  WHEN mc.channel = 'affiliate' THEN 'Affiliate'
                  WHEN mc.channel = 'crm' THEN 'CRM'
                  WHEN mc.channel = 'kooperation' THEN 'Cooperations'
                  WHEN mc.channel = 'praemienprogramm' THEN 'Cooperations'
                  WHEN mc.channel = 'remarketing' THEN 'Remarketing'
                  WHEN mc.channel = 'seo/direct' THEN 'SEO'
                  WHEN mc.channel = 'tv' THEN 'TV'
                  WHEN mc.channel = 'twitter' THEN 'Social Media' 
                  WHEN mc.channel = 'youtube' THEN 'Social Media'
                  WHEN mc.channel = 'google sem brand' THEN 'SEM Brand'
                  WHEN mc.channel = 'google sem nobrand' THEN 'SEM Non-brand'
                  WHEN mc.channel = 'app download campaign' THEN 'App campaign'
                  WHEN mc.channel = 'Xing' THEN 'Social Media'
                  WHEN mc.channel = 'LinkedIn' THEN 'Social Media'
                  WHEN mc.channel = 'Offline_Promotions' THEN 'Offline Promotions'
                  WHEN mc.channel = 'Insert' THEN 'Inserts'
                END as marketing_channel, 
                  mc.cost
            FROM raw.marketing_costs mc
      ) mc2
      GROUP BY 1,2,3
) mc3 ON pl.date = mc3.date_created AND mc3.country = pl.domain AND mc3.marketing_channel = pl.marketing_channel
LEFT JOIN
(
 SELECT 
	  date_invoiced as ""date"",
	  country,
	  SUM(cost*-1) as attributed_costs_total
  FROM bi.company_costs_marketing 
  GROUP BY 1,2
) cmc ON pl.date = cmc.date AND pl.domain = cmc.country
 LEFT JOIN
  (
    SELECT  
	    date_created as ""date"",
    	country,
    	SUM(cost) as actual_costs_total
  FROM raw.marketing_costs
  GROUP BY 1,2  
) amc ON pl.date = amc.date AND pl.domain = amc.country"	READY
65,555	2015-05-05 16:36:34	"1112787917"	true	2015-05-05 16:36:34	forecast.state_vh2		"CREATE VIEW forecast.state_vh2 AS
SELECT
	cofo.customer_id,
	'VH2' AS ""state""
FROM forecast.customer__first_order AS cofo
WHERE TIMESTAMPDIFF(SQL_TSI_DAY, cofo.date_shipped, TIMESTAMPCREATE('2015-01-01', '00:00:00')) >= 2 * 30.4
  AND TIMESTAMPDIFF(SQL_TSI_DAY, cofo.date_shipped, TIMESTAMPCREATE('2015-01-01', '00:00:00')) < 6 * 30.4"	READY
65,556	2015-05-05 17:00:52	"1112787918"	true	2015-05-05 17:50:43	forecast.state_ac		"CREATE VIEW forecast.state_ac AS
SELECT
    cofo.customer_id,
	ac.count
FROM forecast.customer__first_order AS cofo
LEFT JOIN (SELECT
               co.customer_id,
               count(*) AS count
            FROM bi.customer_order AS co
            WHERE co.order_type IN ('Repeat Order', 'Outfittery Club Order')
            AND TIMESTAMPADD(SQL_TSI_MONTH, -6, TIMESTAMPCREATE('2015-01-01', '00:00:00')) <= co.date_shipped
            AND co.date_shipped < TIMESTAMPCREATE('2015-01-01', '00:00:00')
            GROUP BY co.customer_id) AS ac
        ON ac.customer_id = cofo.customer_id
WHERE TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-01-01', '00:00:00')) >= 6
AND ac.count IS NOT NULL"	READY
786,437	2015-09-14 14:57:12	"1314113220"	true	2015-09-14 14:57:12	raw.customer_order_return_fo_issue		"create view raw.customer_order_return_fo_issue
as
select date_created,  'Repeat' as ""Order_Type"",repeat as volume from raw.customer_oder_issue_final_view
union
select date_created,  'Follow_On' as ""Order_Type"", follow_on as volume from raw.customer_oder_issue_final_view"	READY
32,835	2015-04-29 18:25:46	"1126921208"	true	2015-08-07 10:49:13	tableau.ops_followon_throughput		"CREATE VIEW tableau.ops_followon_throughput
AS

SELECT 
	co.id as order_id,
	CAST(co.date_picked AS DATE) as followon_date_picked,
	sum(cal1.working_days) as working_days
FROM 
	views.customer_order co
	join
		(select
			id,
			date_returned as original_return_date,
			state as parent_order_state
		from
			views.customer_order) a
		on a.id = parent_order_id
	join 
	dwh.calendar cal1
		on cal1.""date"" between cast(a.original_return_date as date) and cast(co.date_picked as date)
WHERE
	co.parent_order_id is not null
and co.state >= 16 
and co.state <> 2048
and a.parent_order_state >= 16
and a.parent_order_state <> 2048
and co.date_picked is not null
group by 1,2
HAVING 
	sum(cal1.working_days) IS NOT NULL"	READY
371	2015-04-24 18:23:32	"1127038923"	true	2015-08-07 14:01:14	tableau.accounting_order_report_with_adjusted_rr_open_orders		"CREATE view tableau.accounting_order_report_with_adjusted_rr_open_orders
AS
SELECT 
	op.order_id,
	co.customer_id,
	co.invoice_date_created,
	co.date_shipped,
	co.date_created,
	cu.date_created as customer_date_created,
	co.shipping_country,
	co.vat_percentage,
	co.currency_code,
    co.box_type,
	co.total_amount_billed_discount_euro,
	co.total_goodwill_credit_euro,
    co.total_amount_paid_euro,
	co.order_type,
	co.date_payed,
	co.payment_method,
	co.date_returned,
	co.first_saleschannel_completed,
	0.715 as return_rate_3_weeks,
	op.articles_sent,
	op.articles_sent_os,
	op.articles_sent_ps,
	op.articles_kept,
	op.articles_kept_os,
	op.articles_kept_ps,
	op.total_basket_purchase_price,
	op.total_amount_basket_purchase_gross_patner,
	op.total_amount_basket_purchase_gross_own,
	op.total_basket_retail_price,
	op.total_amount_basket_retail_gross_patner,
	op.total_amount_basket_retail_gross_own,
	op.retoure_value_purchase_price,
	op.return_purchase_gross_patner,
	op.return_purchase_gross_own,
	op.retoure_value,
	op.return_retail_gross_patner,
	op.return_retail_gross_own,
	op.gross_lost_purchase,
	op.gross_lost_purchase_patner,
	op.gross_lost_purchase_own,
	op.gross_lost_retail,
	op.gross_lost_retail_patner,
	op.gross_lost_retail_own,
	arv.paid_to_arvato,
	arv.arvato_paid_date,
/*Campaign Details*/
  ca.code as campaign_code,
  ca.campaign_title,
  ca.currency as campaign_currency
FROM views.customer_order co
LEFT JOIN views.customer cu on cu.customer_id=co.customer_id
/*Order Position KPI's*/
INNER JOIN 
(
	SELECT 
		op.order_id,
		/*Articles Sent*/
		count(DISTINCT CASE WHEN op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent"",
		count(DISTINCT CASE WHEN stock_location_id = 2 AND op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent_os"",
		count(DISTINCT CASE WHEN stock_location_id <> 2 AND op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent_ps"",
		/*Article Kept*/
		count(DISTINCT CASE WHEN op.state=1024 then op.id else null end) as ""articles_kept"",
		count(DISTINCT CASE WHEN stock_location_id = 2 AND op.state=1024 then op.id else null end) as ""articles_kept_os"",
		count(DISTINCT CASE WHEN stock_location_id <> 2 AND op.state= 1024 then op.id else null end) as ""articles_kept_ps"",
		/*Basket Purchase Price*/
		SUM(CASE WHEN op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end) total_basket_purchase_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end)  as total_amount_basket_purchase_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end) as total_amount_basket_purchase_gross_own,
		/*basket Retail Price*/
		SUM(CASE WHEN op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) total_basket_retail_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_own,
		/*Return Purchase Price*/
		SUM(CASE WHEN op.state=512 then quantity*op.purchase_price else 0 end) retoure_value_purchase_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=512 then quantity*op.purchase_price else 0 end)  as return_purchase_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=512 then quantity*op.purchase_price else 0 end) as return_purchase_gross_own,
		/*Return Retail Price*/
		SUM(CASE WHEN op.state=512 then quantity*op.retail_price_euro else 0 end) retoure_value,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=512 then quantity*op.retail_price_euro else 0 end) as return_retail_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=512 then quantity*op.retail_price_euro else 0 end) as return_retail_gross_own,
		/*Lost Purchase Price*/
		SUM(CASE WHEN op.state=1536 then op.quantity*op.purchase_price else 0 end) gross_lost_purchase,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=1536 then op.quantity*op.purchase_price else 0 end)  as gross_lost_purchase_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=1536 then op.quantity*op.purchase_price else 0 end) as gross_lost_purchase_own,
		/*Lost Retail Price*/
		SUM(CASE WHEN op.state=1536 then op.quantity*op.retail_price_euro else 0 end) gross_lost_retail,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_own
		FROM views.order_position op
		GROUP BY 1
)op on op.order_id=co.id
/*Return Rate Per Country
LEFT JOIN
(
	SELECT 
	shipping_country,
	CASE 
		WHEN shipping_country in('SE','DK','BE','LU') then 0.75 
		else return_rate_3_weeks 
	end as return_rate_3_weeks 
	FROM(
			SELECT 
			shipping_country, 
			CASE WHEN total_basket_retail_price=0 then 0 
			else return_retail_price/total_basket_retail_price 
			end as return_rate_3_weeks 
			FROM(
				SELECT
					co.shipping_country,
					SUM(CASE WHEN op.state=512 then quantity*op.retail_price_euro else 0 end) return_retail_price,
					SUM(CASE WHEN co.state=1024 AND op.state<=1024 then quantity*op.retail_price_euro else 0 end) total_basket_retail_price
				FROM views.order_position op
				INNER JOIN views.customer_order co on co.id=op.order_id
				WHERE cast(co.invoice_date_created as date)>=timestampadd(sql_tsi_month,-3,timestampadd(sql_tsi_day,-14,curdate())) AND
				cast(co.invoice_date_created as date)<=timestampadd(sql_tsi_day,-14,curdate())
			GROUP BY 1)
		a)
b)ret on ret.shipping_country=co.shipping_country*/
LEFT JOIN
(
	SELECT 
		ordernumber,
		sum(amount) as paid_to_arvato,
		max(cast(date_created as date)) as arvato_paid_date
	FROM views.arvatopayments
	group by 1
)arv on arv.ordernumber=co.id
LEFT JOIN views.campaign ca on ca.id=co.campaign_id
WHERE cast(co.invoice_date_created as date)>='2014-01-01' AND
co.order_state='Real Order' AND co.state<=1024"	READY
53	2015-04-24 18:17:23	"1112787648"	true	2015-04-24 18:17:23	views.order_position_kpis		"CREATE view ""views.order_position_kpis""
as 
	select
	op.order_id,
	/*Items Sent*/
	count(case when op.state>=16 and op.state<2048 then op.id else null end) as ""items_sent"",
	count(case when op.stock_location_id = 2 and op.state>=16 and op.state<2048 then op.id else null end) as ""items_sent_os"",
	count(case when op.stock_location_id <> 2 and op.state>=16 and op.state<2048 then op.id else null end) as ""items_sent_ps"",
	/*Items Kept*/
	count(case when op.state=1024 then op.id else null end) as ""items_kept"",
	count(case when stock_location_id = 2 and op.state=1024 then op.id else null end) as ""items_kept_os"",
	count(case when stock_location_id <> 2 and op.state= 1024 then op.id else null end) as ""items_kept_ps"",
	/*Items Returned*/
	count(case when op.state=512 then op.id else null end) as ""items_returned"",
	count(case when stock_location_id = 2 and op.state=512 then op.id else null end) as ""items_returned_os"",
	count(case when stock_location_id <> 2 and op.state= 512 then op.id else null end) as ""items_returned_ps"",
	/*Items Lost*/
	count(case when op.state=1536 then op.id else null end) as ""items_lost"",
	count(case when stock_location_id = 2 and op.state=1536 then op.id else null end) as ""items_lost_os"",
	count(case when stock_location_id <> 2 and op.state= 1536 then op.id else null end) as ""items_lost_ps"",
	/*-----------------------------------------PURCHASE PRICE---------------------------------------------------*/
	/*Order Value Sent-Purchase Price*/
	sum(case when op.state>=16 and op.state<2048 then op.purchase_price else 0 end) order_value_sent_pu,
	sum(case when op.stock_location_id = 1 and op.state>=16 and op.state<2048 then op.purchase_price else 0 end) as order_value_sent_pu_z,
	sum(case when op.stock_location_id = 2 and op.state>=16 and op.state<2048 then op.purchase_price else 0 end) as order_value_sent_pu_os,
	sum(case when op.stock_location_id = 3 and op.state>=16 and op.state<2048 then op.purchase_price else 0 end) as order_value_sent_pu_z_ch,
	/*Order Value Kept-Purchase Price*/
	sum(case when op.state=1024 then op.purchase_price else 0 end) order_value_kept_pu,
	sum(case when op.stock_location_id = 1 and op.state=1024 then op.purchase_price else 0 end) as order_value_kept_pu_z,
	sum(case when op.stock_location_id = 2 and op.state=1024 then op.purchase_price else 0 end) as order_value_kept_pu_own,
	sum(case when op.stock_location_id = 3 and op.state=1024 then op.purchase_price else 0 end) as order_value_kept_pu_z_ch,
	/*Order Value Returned-Purchase Price*/
	sum(case when op.state =512 then op.purchase_price else 0 end) order_value_returned_pu,
	sum(case when op.stock_location_id = 1 and op.state =512 then op.purchase_price else 0 end) as order_value_returned_pu_z,
	sum(case when op.stock_location_id = 2 and op.state =512 then op.purchase_price else 0 end) as order_value_returned_pu_own,
	sum(case when op.stock_location_id = 3 and op.state =512 then op.purchase_price else 0 end) as order_value_returned_pu_z_ch,
	/*Order Value Lost-Purchase Price*/
	sum(case when op.state=1536 then op.purchase_price else 0 end) order_value_lost_pu,
	sum(case when op.stock_location_id = 1 and op.state=1536 then op.purchase_price else 0 end) as order_value_lost_pu_z,
	sum(case when op.stock_location_id = 2 and op.state=1536 then op.purchase_price else 0 end) as order_value_lost_pu_own,
	sum(case when op.stock_location_id = 3 and op.state=1536 then op.purchase_price else 0 end) as order_value_lost_pu_z_ch,
	/*-----------------------------------------RETAIL PRICE---------------------------------------------------*/
	/*Order Value Sent-Retail Price*/
	sum(case when op.state>=16 and op.state<2048 then op.retail_price else 0 end) as order_value_sent_re,
	sum(case when op.stock_location_id = 1 and op.state>=16 and op.state<2048 then op.retail_price else 0 end) as order_value_sent_re_z,
	sum(case when op.stock_location_id = 2 and op.state>=16 and op.state<2048 then op.retail_price else 0 end) as order_value_sent_re_os,
	sum(case when op.stock_location_id = 3 and op.state>=16 and op.state<2048 then op.retail_price else 0 end) as order_value_sent_z_re_ch,
	/*Order Value Kept-Retail Price*/
	sum(case when op.state=1024 then op.retail_price else 0 end) as order_value_kept_re,
	sum(case when op.stock_location_id = 1 and op.state=1024 then op.retail_price else 0 end) as order_value_kept_re_z,
	sum(case when op.stock_location_id = 2 and op.state=1024 then op.retail_price else 0 end) as order_value_kept_re_own,
	sum(case when op.stock_location_id = 3 and op.state=1024 then op.retail_price else 0 end) as order_value_kept_re_z_ch,
	/*Order Value Returned-Retail Price*/
	sum(case when op.state=512 then op.retail_price else 0 end) as order_value_returned_re,
	sum(case when op.stock_location_id = 1 and op.state=512 then op.retail_price else 0 end) as order_value_returned_re_z,
	sum(case when op.stock_location_id = 2 and op.state=512 then op.retail_price else 0 end) as order_value_returned_re_own,
	sum(case when op.stock_location_id = 3 and op.state=512 then op.retail_price else 0 end) as order_value_returned_re_z_ch,
	/*Order Value Lost-Retail Price*/
	sum(case when op.state=1536 then op.retail_price else 0 end) as order_value_lost_re,
	sum(case when op.stock_location_id = 1 and op.state=1536 then op.retail_price else 0 end) as order_value_lost_re_z,
	sum(case when op.stock_location_id = 2 and op.state=1536 then op.retail_price else 0 end) as order_value_lost_re_own,
	sum(case when op.stock_location_id = 3 and op.state=1536 then op.retail_price else 0 end) as order_value_lost_re_z_ch,
	/*Order Value Lost-Retail Price*/
	sum(case when op.state >=128 and op.state<2048 then op.retail_price else 0 end) as order_value_incl_ret_re,
	sum(case when op.stock_location_id = 1 and op.state >=128 and op.state<2048 then op.retail_price else 0 end) as order_value_incl_ret_z,
	sum(case when op.stock_location_id = 2 and op.state >=128 and op.state<2048 then op.retail_price else 0 end) as order_value_incl_ret_own,
	sum(case when op.stock_location_id = 3 and op.state >=128 and op.state<2048 then op.retail_price else 0 end) as order_value_incl_ret_ch,
	/*Geschenk Articles*/
	count(case when  sa.ean in ('2009876543503','2009876543510') and op.state < 2048 then '1' else Null end) as geschenk_box,
	count(case when  sa.ean ='2009876543503' and op.state < 2048 then 1 else Null end) as geschenk_box_2009876543503, 
	count(case when  sa.ean ='2009876636489' and op.state < 2048 then 1 else Null end) as geschenk_box_2009876636489, 
	count(case when  sa.ean ='2009876543527' and op.state < 2048 then 1 else Null end) as geschenk_box_2009876543527, 
	count(case when  sa.ean ='2009876543534' and op.state < 2048 then 1 else Null end) as geschenk_box_2009876543534,   
	count(case when  sa.ean ='2009876543510' and op.state < 2048 then 1 else Null end) as geschenk_box_2009876543510,
	count(case when  sa.ean ='2009876543497' and op.state < 2048 then 1 else Null end) as geschenk_box_2009876543497,
	count(case when  sa.ean in ('2009876543503','2009876543510','2009876543527','2009876636489','2009876543534','2009876543497') and op.state = 512 then 1 else Null end) as geschenk_retourniert
FROM ""postgres.order_position"" op
LEFT JOIN ""postgres.customer_order"" co on co.id=op.order_id
LEFT JOIN postgres.supplier_article sa on sa.id=op.supplier_article_id
WHERE co.state<2048
GROUP BY 1"	READY
32,836	2015-04-29 18:27:56	"661538597"	true	2015-04-29 18:27:56	am.size_mapping_new_with_code		"CREATE VIEW am.size_mapping_new_with_code AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('am.size_mapping_new_with_code.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""commodity_group4"" STRING ,
		""brand"" STRING ,
		""eu_size"" STRING ,
		""eu_length"" STRING ,
		""Size Group Code"" STRING ,
		""Description"" STRING ,
		""eu_size_x_length"" STRING ,
		""size_code"" STRING 
		DELIMITER ',' 
		QUOTE '""' 
		HEADER 1 
	)
""csv_table"""	READY
294,918	2015-07-07 11:18:36	"1112787993"	true	2015-07-07 15:13:36	tableau.ops_purchase_order		"CREATE VIEW tableau.ops_purchase_order
AS

SELECT 
	pop.purchase_order_id, 
	pop.fulfilled_quantity, 
	pop.quantity, 
	pop.order_position_id,
	sa.ean,
	it.item_description,
	it.color,
	it.category,
	it.size,
	it.pic1,
	it.has_picture
FROM postgres.purchase_order_position pop 
LEFT JOIN postgres.supplier_article sa ON sa.article_id = pop.article_id
LEFT JOIN bi.item it on it.ean=sa.ean
WHERE sa.supplier_id = 15"	READY
393,218	2015-07-28 11:26:33	"1089390664"	true	2015-07-30 11:36:53	raw.snowplow_optimizely_events		"CREATE VIEW raw.snowplow_optimizely_events
AS
WITH sp_data AS
(
SELECT
	domain_userid ||'-'|| domain_sessionidx as visitor_session_id,
	domain_userid as visitor_id,
	user_id,
	domain_sessionidx as session_count,
	MODIFYTIMEZONE(collector_tstamp,'UTC+1') as date_created,
	dense_rank() OVER (PARTITION BY domain_userid ||'-'|| domain_sessionidx, page_urlpath ORDER BY collector_tstamp DESC) as test_rank,
	page_urlpath as test_page_url,
	CASE 
		WHEN page_urlpath IN ('/', '/b/light', '/facebook') THEN 'Landing Page'
		WHEN page_urlpath LIKE '%pickCallAppointment%' THEN 'Pick Call Page'
		WHEN page_urlpath LIKE '%successScreen%' THEN 'Success Page'
		WHEN page_urlpath LIKE '%/previews/%' THEN 'Previews Page'
		WHEN page_urlpath LIKE '%/orders/create%' THEN 'Orders Create Page'
		WHEN page_urlpath LIKE '%/feedbacks' THEN 'Orders Feedback Page'
		ELSE 'Other'
	END as test_page_type,
	se_action as optimizely_test_name,
	se_label as optimizely_test_id,
	se_property as optimizely_variation_name,
	se_value as optimizely_variation_id
FROM raw.snowplow_events
WHERE event = 'struct'
AND se_category = 'optimizely test'
/* --Filter out own IP and bot traffic-- */
AND user_ipaddress NOT LIKE '213.61.116.%'
AND br_type != 'Robot'
/* --Filter out domain tracking mistakes-- */
AND ( page_urlhost = 'www.outfittery.de' OR page_urlhost = 'static.outfittery.de'  
OR page_urlhost = 'www.outfittery.at' OR page_urlhost = 'static.outfittery.at'  
OR page_urlhost = 'www.outfittery.ch' OR page_urlhost = 'static.outfittery.ch'  
OR page_urlhost = 'www.outfittery.nl' OR page_urlhost = 'static.outfittery.nl' 
OR page_urlhost = 'www.outfittery.be' OR page_urlhost = 'static.outfittery.be'  
OR page_urlhost = 'www.outfittery.lu' OR page_urlhost = 'static.outfittery.lu'  
OR page_urlhost = 'www.outfittery.dk' OR page_urlhost = 'static.outfittery.dk'  
OR page_urlhost = 'www.outfittery.no' OR page_urlhost = 'static.outfittery.no'  
OR page_urlhost = 'www.outfittery.se' OR page_urlhost = 'static.outfittery.se'  
OR page_urlhost = 'www.outfittery.com' OR page_urlhost = 'static.outfittery.com')
AND CAST(collector_tstamp as date) >= '2015-04'
)

SELECT
	DISTINCT
	visitor_session_id,
	visitor_id,
	user_id,
	session_count,
	date_created,
	test_page_url,
	test_page_type,
	optimizely_test_name,
	optimizely_test_id,
	optimizely_variation_name,
	optimizely_variation_id
FROM sp_data
WHERE test_rank = 1"	READY
32,837	2015-04-29 18:28:53	"775235971"	true	2015-05-21 11:49:54	am.size_mapping_new_with_code__indexed_cg4_brand_size		"CREATE VIEW am.size_mapping_new_with_code__indexed_cg4_brand_size AS
SELECT * FROM ""am.size_mapping_new_with_code""
WHERE eu_size_x_length IS NULL
AND brand IS NOT NULL"	READY
363	2015-04-24 18:23:13	"1184834972"	true	2015-08-19 15:11:45	tableau.billing_arvato_payment_analysis		"CREATE view tableau.billing_arvato_payment_analysis
AS

SELECT
	co.id,
	co.customer_id,
	co.date_created,
	co.last_updated,
	co.state,
	co.payment_method,
	co.payment_state,
	co.total_amount_basket_purchase_gross,
	co.total_amount_basket_retail_gross,
	co.total_amount_billed_discount,
	co.total_amount_billed_purchase_gross,
	co.total_amount_billed_retail_gross,
	co.date_billed,
	co.date_payed,
	co.total_amount_payed,
	co.date_returned,
	co.date_shipped,
	co_1.date_shipped_internal,
	co.total_amount_reserved,
	co.sales_channel,
	co.phone_date,
	co.stylelist_id,
	co.discount_type,
	co.discount_content,
	co.total_amount_billed_discount_percentage,
	co.total_amount_billed_discount_absolute,
	co.date_completed,
	co.date_encashment,
	co.date_returned_online,
	co.currency_code,
	co.vat_percentage,
	co.invoice_date_created,
	co.invoice_number,
	co.shipping_city,
	co.shipping_country,
	co.shipping_street,
	co.shipping_street_number,
	co.shipping_zip,
	co.shipping_first_name,
	co.shipping_last_name,
	co.shipping_co,
	co.billing_city,
	co.billing_country,
	co.billing_street,
	co.billing_street_number,
	co.billing_zip,
	co.billing_first_name,
	co.billing_last_name,
	co.total_goodwill_credit,
	co.total_amount_billed_retail_gross-coalesce(a.arvato_amount,0) as Open_Ammount_Arvato__c,
	coalesce(a.arvato_amount,0) as Paid_to_Arvato__c,
	co.order_type,
	a.date_created as arvato_date_updated,
	bill.credit_card_brand,
	ret.retoure_value,
	bill.nb_of_credit_card_entries,
	mo.marketing_channel
from views.customer_order co 
left join raw.customer_order co_1 on co_1.order_id=co.id
LEFT JOIN views.marketing_order mo on mo.order_id=co.id
left join 
(
	SELECT 
		ordernumber,
		min(date_created) as date_created,
		sum(amount) as arvato_amount
	FROM views.arvatopayments
	GROUP BY 1
) a on co.id = a.ordernumber
left join 
(
	select 
		customer_id,
		credit_card_brand,
		count(customer_id) as nb_of_credit_card_entries
	from views.billing_data  group by 1,2
) bill on bill.customer_id=co.customer_id
left join 
(
	select 
		order_id,
		sum(quantity*retail_price) as retoure_value 
	from views.order_position 
	where state=512 
	group by 1
) ret on ret.order_id=co.id"	READY
917,511	2015-09-28 21:55:58	"1389130735"	true	2015-09-29 16:30:03	tableau.dfc_call_list		"CREATE VIEW tableau.dfc_call_list
AS

SELECT
	co.order_id,
	co.customer_id,
	co.date_invoiced,
	co.order_type,
	cu.email,
	cu.phone_number,
	CASE
		WHEN marketing_campaign='DIRECT_FEEDBACK_CALLS' OR lower(df.comment) LIKE 'dfc erreicht%' THEN 'Reached' 
		WHEN lower(df.comment) LIKE '%dfc nicht erreicht 3x%' THEN 'Not reached-3 Times' 
		ELSE 'Not Reached'
	END AS dfc_reached,
	st.stylist,
	st.team,
	df.comment,
	df.date_last_contacted,
	df.nb_of_tries,
	date_phone_call
FROM raw.customer_order co
LEFT JOIN raw.customer cu on cu.customer_id=co.customer_id
LEFT JOIN raw.stylist st on st.stylist_id=co.stylist_id
LEFT JOIN raw.dfc_calls df on df.order_id=co.order_id
WHERE CAST(co.date_invoiced AS DATE)<=TIMESTAMPADD(SQL_TSI_DAY,-7,curdate())
AND co.parent_order_id IS NULL
AND co.order_state_number IN (128,256)"	READY
32,838	2015-04-29 18:30:40	"775235973"	true	2015-05-21 11:50:14	am.size_mapping_new_with_code__indexed_cg4_size		"CREATE VIEW am.size_mapping_new_with_code__indexed_cg4_size AS
SELECT * FROM ""am.size_mapping_new_with_code""
WHERE eu_size_x_length IS NULL
AND brand IS NULL"	READY
32,839	2015-04-29 18:31:57	"775235976"	true	2015-05-21 11:50:22	am.size_mapping_new_with_code__indexed_cg4_sizelength		"CREATE VIEW am.size_mapping_new_with_code__indexed_cg4_sizelength AS
SELECT * FROM ""am.size_mapping_new_with_code""
WHERE eu_size_x_length IS NOT NULL"	READY
119	2015-04-24 18:17:53	"988772848"	true	2015-07-08 18:17:56	raw.snowplow_transactions		"CREATE VIEW raw.snowplow_transactions 
AS
SELECT
	bc.domain_userid as visitor_id,
	bc.user_id,
	bc.session_count,
	bc.visitor_session_id,
	bc.tr_orderid as order_id,
	bc.collector_tstamp as date_created,
	bc.marketing_channel,
	bc.source,
	bc.medium,
	bc.campaign,
	bc.domain,
	bc.device_type,
	bc.br_family,
	bc.br_type,
	bc.os_name,
	bc.os_family,
	de.collector_tstamp as date_created_previous_order
FROM
(
	SELECT
		ab.domain_userid,
		ab.session_count,
		ab.user_id,
		ab.tr_orderid,
		ab.collector_tstamp,
		ab.visitor_session_id,
		ab.marketing_channel,
		ab.source,
		ab.medium,
		ab.campaign,
		ab.domain,
		ab.device_type,
		ab.br_family,
		ab.br_type,
		ab.os_name,
		ab.os_family,
		dense_rank() OVER (PARTITION BY ab.domain_userid ORDER BY ab.collector_tstamp ASC) as order_count
	FROM
	(
		SELECT
			DISTINCT 
			sp.domain_userid,
			sp.domain_sessionidx as session_count,
			sp.user_id,
			sp.tr_orderid,
			sp.domain_userid ||'-'|| sp.domain_sessionidx as visitor_session_id,
			TIMESTAMPADD(SQL_TSI_HOUR, 2, sp.collector_tstamp) as collector_tstamp,
			vi.marketing_channel,
			vi.source,
			vi.medium,
			vi.campaign,
			vi.domain,
			vi.device_type,
			vi.br_family,
			vi.br_type,
			vi.os_name,
			vi.os_family,
			dense_rank() OVER (PARTITION BY sp.tr_orderid ORDER BY sp.collector_tstamp ASC) as order_rank_asc			
			FROM raw.snowplow_events sp
			LEFT JOIN raw.snowplow_visits vi ON vi.visitor_session_id = sp.domain_userid ||'-'|| sp.domain_sessionidx
		WHERE event = 'transaction'
		AND tr_orderid IS NOT NULL
		/* --Filter out own IP and bot traffic-- */
		AND sp.user_ipaddress NOT LIKE '213.61.116.%'
		AND sp.br_type != 'Robot'
		AND CAST(sp.collector_tstamp as date) >= '2015-04'
	) ab
WHERE ab.order_rank_asc = 1
) bc
LEFT JOIN 
(
	SELECT
		cd.domain_userid,
		cd.user_id,
		cd.tr_orderid,
		cd.collector_tstamp,
		dense_rank() OVER (PARTITION BY cd.domain_userid ORDER BY cd.collector_tstamp ASC) as order_count
	FROM
	(
		SELECT 
			domain_userid,
			user_id,
			tr_orderid,
			TIMESTAMPADD(SQL_TSI_HOUR, 2, collector_tstamp) as collector_tstamp,
			dense_rank() OVER (PARTITION BY tr_orderid ORDER BY collector_tstamp ASC) as order_rank_asc
			FROM raw.snowplow_events
		WHERE event = 'transaction'
		AND tr_orderid IS NOT NULL
		/* --Filter out own IP and bot traffic-- */
		AND user_ipaddress NOT LIKE '213.61.116.%'
		AND br_type != 'Robot'
		AND CAST(collector_tstamp as date) >= '2015-04'
	) cd
	WHERE cd.order_rank_asc = 1
) de ON bc.domain_userid = de.domain_userid AND bc.order_count = (de.order_count+1)"	READY
32,840	2015-04-29 18:51:10	"1112787900"	true	2015-04-29 18:51:10	tableau.ops_time_between_stylist_picked_submitted		"CREATE VIEW tableau.ops_time_between_stylist_picked_submitted
AS

SELECT
	PARSETIMESTAMP(a.date || ' ' || b.hh, 'yyyy-MM-dd HH') as day_hour,
	COALESCE(c.orders_picked_by_stylist, 0) as orders_picked_by_stylist,
	COALESCE(d.orders_invoiced,0) as orders_invoiced,
	COALESCE(c.time_to_submit,0) as time_to_submit
FROM 
(
	SELECT 
		c.date
	FROM dwh.calendar c 
	WHERE c.date > TIMESTAMPADD(SQL_TSI_DAY, -30, CURDATE()) 
	AND c.date < CURDATE()
) a 
CROSS JOIN (SELECT DISTINCT substring(date_created, 12, 2) as hh FROM bi.customer_order co) b
LEFT JOIN
(
	SELECT 
		PARSETIMESTAMP(LEFT(date_stylist_picked, 13), 'yyyy-MM-dd HH') as day_hour,
		COUNT(order_id) as orders_picked_by_stylist,
		AVG(TIMESTAMPDIFF(SQL_TSI_MINUTE, date_stylist_picked, date_invoiced)) as time_to_submit
	FROM bi.customer_order 
	WHERE date_stylist_picked > TIMESTAMPADD(SQL_TSI_DAY, -30, CURDATE())
	GROUP BY 1
) c on c.day_hour = PARSETIMESTAMP(a.date || ' ' || b.hh, 'yyyy-MM-dd HH')
LEFT JOIN
(
	SELECT 
		PARSETIMESTAMP(LEFT(date_invoiced, 13), 'yyyy-MM-dd HH')  as day_hour,
		COUNT(order_id) as orders_invoiced
	FROM bi.customer_order
	WHERE date_invoiced > TIMESTAMPADD(SQL_TSI_DAY, -30, CURDATE())
	GROUP BY 1
) d on d.day_hour = PARSETIMESTAMP(a.date || ' ' || b.hh, 'yyyy-MM-dd HH')"	READY
65,561	2015-05-05 18:30:46	"1112787921"	true	2015-05-05 18:47:58	forecast.union		CREATE VIEW forecast.union AS
SELECT
        cofo.customer_id,
        'IOP' AS "state"
    FROM forecast.customer__first_order AS cofo
    WHERE TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-05-05', '18:42:29')) >= 0
          AND TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-05-05', '18:42:29')) < 1
    
UNION
SELECT
        cofo.customer_id,
        'vh1' AS "state"
    FROM forecast.customer__first_order AS cofo
    WHERE TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-05-05', '18:42:29')) >= 1
      AND TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-05-05', '18:42:29')) < 2
    
UNION
SELECT
        cofo.customer_id,
        'vh2' AS "state"
    FROM forecast.customer__first_order AS cofo
    WHERE TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-05-05', '18:42:29')) >= 2
      AND TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-05-05', '18:42:29')) < 6
    
UNION
SELECT
        cofo.customer_id,
        'AC' AS state
    FROM forecast.customer__first_order AS cofo
    LEFT JOIN ( SELECT
        co.customer_id,
        count(*) AS "count"
    FROM bi.customer_order AS co
    WHERE co.order_type IN ('Repeat Order', 'Outfittery Club Order')
          AND TIMESTAMPCREATE('2014-11-04', '09:06:29') <= co.date_shipped
          AND co.date_shipped < TIMESTAMPCREATE('2015-05-05', '18:42:29')
    GROUP BY co.customer_id ) AS "ac" ON ac.customer_id = cofo.customer_id
    WHERE TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-05-05', '18:42:29')) >= 6
    AND ac.count IS NOT NULL
UNION
SELECT
        cofo.customer_id,
        'P6' AS state
    FROM forecast.customer__first_order AS cofo
    LEFT JOIN (SELECT
        co.customer_id,
        count(*) AS "count"
    FROM bi.customer_order AS co
    WHERE co.order_type IN ('Repeat Order', 'Outfittery Club Order')
          AND TIMESTAMPCREATE('2014-11-04', '09:06:29') <= co.date_shipped
          AND co.date_shipped < TIMESTAMPCREATE('2015-05-05', '18:42:29')
    GROUP BY co.customer_id) AS r6 ON r6.customer_id = cofo.customer_id
    LEFT JOIN (SELECT
        co.customer_id,
        count(*) AS "count"
    FROM bi.customer_order AS co
    WHERE co.order_type IN ('Repeat Order', 'Outfittery Club Order')
          AND TIMESTAMPCREATE('2014-05-05', '23:30:29') <= co.date_shipped
          AND co.date_shipped < TIMESTAMPCREATE('2014-11-04', '09:06:29')
    GROUP BY co.customer_id) AS r12 ON r12.customer_id = cofo.customer_id
    WHERE TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-05-05', '18:42:29')) >= 6
          AND r6.count IS NULL
          AND r12.count IS NOT NULL
    
UNION
SELECT
        cofo.customer_id,
        'P12' AS state
    FROM forecast.customer__first_order AS cofo
    LEFT JOIN (SELECT
        co.customer_id,
        count(*) AS "count"
    FROM bi.customer_order AS co
    WHERE co.order_type IN ('Repeat Order', 'Outfittery Club Order')
          AND TIMESTAMPCREATE('2014-11-04', '09:06:29') <= co.date_shipped
          AND co.date_shipped < TIMESTAMPCREATE('2015-05-05', '18:42:29')
    GROUP BY co.customer_id) AS r6 ON r6.customer_id = cofo.customer_id
    LEFT JOIN (SELECT
        co.customer_id,
        count(*) AS "count"
    FROM bi.customer_order AS co
    WHERE co.order_type IN ('Repeat Order', 'Outfittery Club Order')
          AND TIMESTAMPCREATE('2014-05-05', '23:30:29') <= co.date_shipped
          AND co.date_shipped < TIMESTAMPCREATE('2014-11-04', '09:06:29')
    GROUP BY co.customer_id) AS r12 ON r12.customer_id = cofo.customer_id
    WHERE TIMESTAMPDIFF(SQL_TSI_MONTH, cofo.date_shipped, TIMESTAMPCREATE('2015-05-05', '18:42:29')) >= 6
          AND r6.count IS NULL
          AND r12.count IS NULL	READY
294,920	2015-07-07 12:28:44	"1112787994"	true	2015-07-29 16:43:58	raw.marketing_voucher_campaign_details		"CREATE VIEW raw.marketing_voucher_campaign_details
AS


WITH
def AS (
SELECT
	campaign_title, 
	country, 
	CAST(promotion_start as date) as promotion_start, 
	CAST(promotion_end as date) as promotion_end, 
	CAST(TIMESTAMPADD(SQL_TSI_DAY, 28, CAST(promotion_end as timestamp)) as date) as cost_reporting_date,
	TIMESTAMPDIFF(SQL_TSI_DAY, CAST(promotion_start as timestamp), CAST(promotion_end as timestamp)) + 1 as promotion_runtime,
	TIMESTAMPDIFF(SQL_TSI_DAY, CAST(promotion_start as timestamp), TIMESTAMPADD(SQL_TSI_DAY, 28, CAST(promotion_end as timestamp))) + 1 as reporting_runtime,
	campaign_type, 
	CASE 
		WHEN campaign_type = 'Inserts' OR campaign_type = 'Barter' THEN 'Inserts'
		WHEN campaign_type = 'Affiliate' THEN 'Affiliate'
		ELSE 'Cooperations'
	END AS marketing_channel,
	cluster, 
	agency, 
	publisher, 
	volume,
	cpm_print, 
	cpm_publisher, 
	envelope_costs,
	ifnull(cpm_print,0)+ifnull(cpm_publisher,0)+ifnull(envelope_costs,0) as cpm_total,
	ad_costs, 
	volume/1000 * (ifnull(cpm_print,0)+ifnull(cpm_publisher,0)+ifnull(envelope_costs,0)) + ifnull(ad_costs, 0) as fixed_costs, 
	cpo_publisher,
	cvr_forecast,
	volume * cvr_forecast  as	new_customer_invoiced_order_forecast
FROM dwh.marketing_voucher_campaign_details
)


SELECT
	def.campaign_title,
	country,
	promotion_start,
	promotion_end,
	cost_reporting_date,
	dc.date_discount_end,
	dc.date_discount_start,
	promotion_runtime,
	reporting_runtime,
	TIMESTAMPDIFF(SQL_TSI_DAY, promotion_start, dc.date_discount_end) AS discount_runtime,
	campaign_type,
	marketing_channel,
	cluster,
	agency,
	publisher,
	volume,
	CASE 
		WHEN promotion_runtime is null OR promotion_runtime = 0 then volume
		ELSE volume / promotion_runtime 
	END as daily_spread,
	cpm_print,
	cpm_publisher,
	envelope_costs,
	cpm_total,
	fixed_costs,
	ad_costs,
	cpo_publisher,
	fixed_costs + ifnull(new_customer_invoiced_order_forecast * ifnull(cpo_publisher,0),0) as total_costs_forecast,
	cvr_forecast,
	new_customer_invoiced_order_forecast,
	CASE 
		WHEN new_customer_invoiced_order_forecast is null OR new_customer_invoiced_order_forecast = 0 THEN 0
		ELSE (fixed_costs + ifnull(new_customer_invoiced_order_forecast * ifnull(cpo_publisher,0),0)) / new_customer_invoiced_order_forecast 
	END as cac_forecast,
	CASE 
		WHEN reporting_runtime is null OR reporting_runtime = 0 THEN 0
		ELSE (fixed_costs + ifnull(new_customer_invoiced_order_forecast * ifnull(cpo_publisher,0),0)) / reporting_runtime 
	END as daily_costs
FROM def
LEFT JOIN
(
	SELECT
		campaign_title,
		MAX(CAST(date_discount_end as date)) as date_discount_end,
		MAX(CAST(date_discount_start as date)) as date_discount_start
	FROM raw.discount_campaigns
	GROUP BY 1
) dc ON dc.campaign_title = def.campaign_title"	READY
917,512	2015-09-30 09:41:57	"1394512968"	true	2015-09-30 09:41:57	tableau.company_okr		"CREATE VIEW tableau.company_okr
AS

with okr as
(
   SELECT   
    o.year_quarter,  
    o.new_customer_target,  
    o.repeat_customer_target,  
    o.cart_value_target as avg_basket_target,  
    o.revenue_per_stylist_target, 
    o.cac,
    SUM(c.working_days) as working_days_quarter,  
    SUM(CASE WHEN c.date < CURDATE() THEN c.working_days ELSE 0 END) as working_days_gone,  
    SUM(CASE WHEN c.date >= CURDATE() THEN c.working_days ELSE 0 END) as working_days_left  
   FROM dwh.company_okrs_quarterly o  
   JOIN dwh.calendar c on c.year_quarter = o.year_quarter AND c.year_quarter='2015-Q3'
   GROUP BY 1,2,3,4,5,6
),
c_order as
(
  SELECT
      c.year_quarter,
      COUNT(CASE WHEN order_type = 'First Order' THEN order_id ELSE null END) as new_customers,  
      COUNT(CASE WHEN order_type in ('Repeat Order', 'Outfittery Club Order') THEN order_id ELSE null END) as repeat_customers,  
      AVG(sales_kept) as avg_basket
  FROM bi.customer_order co   
  JOIN dwh.calendar c on c.date = CAST(co.date_invoiced as date)  
  WHERE co.is_real_order = 'Real Order'  
  AND co.order_state_number BETWEEN 16 and 1024  
  AND co.date_invoiced < CURDATE()  
  AND c.year_quarter='2015-Q3' 
  GROUP BY 1
),
nps AS 
( 
  SELECT 
    SUM
    (
      CASE 
      WHEN nps_score>=0 and nps_score<=6 then 1 
      else 0 
      end 
    ) as nb_of_detractors, 
    SUM 
    ( 
      CASE 
      WHEN nps_score>=9 and nps_score<=10 then 1 
      else 0 
    end 
    ) as nb_of_promoters, 
    COUNT(DISTINCT order_id) as nb_of_answers 
  FROM bi.customer_order co 
  WHERE CAST(co.date_nps_submitted as date) BETWEEN '2015-07-01' AND '2015-09-30' 
)

SELECT 
  cast('New Customers' as string) as key_results,
  o1.new_customer_target AS  target,
  co.new_customers AS actual
FROM okr o1
JOIN c_order co on co.year_quarter=o1.year_quarter
GROUP BY 1,2,3

UNION 
SELECT 
  cast('Repeat Customers' as string) as key_results,
  o2.repeat_customer_target AS  target,
  co.repeat_customers AS actual
FROM okr o2
JOIN c_order co on co.year_quarter=o2.year_quarter
GROUP BY 1,2,3

UNION 
SELECT 
  cast('Average Cart Value' as string) as key_results,
  o3.avg_basket_target AS  target,
  co.avg_basket AS actual
FROM okr o3 
JOIN c_order co on co.year_quarter=o3.year_quarter
GROUP BY 1,2,3

UNION
SELECT  
CAST('NPS Score' as string) as key_results,
65 as target,
(cast(nb_of_promoters as double)/cast(nb_of_answers as double)-cast(nb_of_detractors as double)/cast(nb_of_answers as double))*100 as actual
FROM nps

UNION
SELECT 
  cast('CAC' as string) as key_results,
  56 AS  target,
  cos.cost/co_4.new_customers AS actual
FROM okr o4
JOIN
(
	SELECT  
    	year_quarter,  
    	sum(cost) AS cost 
  	FROM raw.marketing_costs co    
  	JOIN dwh.calendar c on c.date = CAST(co.date_created as date)   
  	WHERE co.date_created < CURDATE() 
  	AND c.year_quarter='2015-Q3'
  	GROUP BY 1
)cos on o4.year_quarter=cos.year_quarter
JOIN c_order co_4 on cos.year_quarter=co_4.year_quarter

UNION
SELECT
	cast('Club Customers' as string) as key_results,
	14000 as target,
	count(*) as actual
FROM ""raw.customer_salesforce"" club
JOIN c_order co_4 on '2015-Q3'=co_4.year_quarter
WHERE club_member=1"	READY
196,613	2015-05-26 13:51:22	"1263532288"	true	2015-09-04 17:18:25	raw.snowplow_visits		"CREATE view raw.snowplow_visits
AS


SELECT
  DISTINCT
  sp.visitor_id,
  sp.visitor_session_id,
  id.user_id,
  sp.date_created,
  sp.device_type,
  sp.br_family,
  sp.br_type,
  sp.os_name,
  sp.os_family,
  sp.geo_country,
  CASE
    WHEN sp.url_host like '%.de%' THEN 'DE'
    WHEN sp.url_host like '%.at%' THEN 'AT'
    WHEN sp.url_host like '%.ch%' THEN 'CH'
    WHEN sp.url_host like '%.nl%' THEN 'NL'
    WHEN sp.url_host like '%.be%' THEN 'BE'
    WHEN sp.url_host like '%.lu%' THEN 'LU'
    WHEN sp.url_host like '%.dk%' THEN 'DK'
    WHEN sp.url_host like '%.no%' THEN 'NO'
    WHEN sp.url_host like '%.se%' THEN 'SE'
    WHEN sp.url_host like '%.com%' THEN 'COM'
  END AS domain,
  sp.marketing_channel,
  sp.marketing_subchannel,
  sp.source,
  sp.medium,
  sp.campaign,
  sp.term,
  sp.session_count,
  pv.pageviews,
  pv.session_length,
  sp.url_path as landing_page_url_path,
  qu.funnel_questionnaire_visit,  
  cc.funnel_customer_create_visit,
  pe.funnel_profile_edit_visit,
  oc.funnel_orders_create_visit,
  pc.funnel_pick_call_visit,
  sx.funnel_successpage_visit,
  sxn.funnel_success_nc_visit
FROM raw.snowplow_pageviews sp
LEFT JOIN
  (
  SELECT 
    visitor_id,
    session_count,
    max(pageview_count) as pageviews,
    TIMESTAMPDIFF(SQL_TSI_SECOND, min(date_created), max(date_created)) as session_length
  FROM raw.snowplow_pageviews 
  GROUP BY 1,2  
  ) pv ON pv.visitor_id = sp.visitor_id AND pv.session_count = sp.session_count
LEFT JOIN
(
  SELECT
  DISTINCT 
  visitor_session_id ,
  1 as funnel_questionnaire_visit 
  FROM ""raw.snowplow_pageviews""
  WHERE url_path like '%survey%'  
) qu ON qu.visitor_session_id = sp.visitor_session_id
LEFT JOIN
(
  SELECT 
    DISTINCT
    visitor_session_id,
    1 as funnel_customer_create_visit 
  FROM ""raw.snowplow_pageviews""
  WHERE url_path like '%/customers/create%' 
) cc ON cc.visitor_session_id = sp.visitor_session_id
LEFT JOIN
(
  SELECT 
    DISTINCT
    visitor_session_id, 
    1 as funnel_profile_edit_visit 
  FROM ""raw.snowplow_pageviews""
  WHERE url_path like '%/profile/edit%'
) pe ON pe.visitor_session_id = sp.visitor_session_id
LEFT JOIN
(
  SELECT 
    DISTINCT
    visitor_session_id,
    session_count, 
    1 as funnel_orders_create_visit 
  FROM ""raw.snowplow_pageviews""
  WHERE url_path like '%/orders/create%'  
) oc ON oc.visitor_session_id = sp.visitor_session_id
LEFT JOIN
(
  SELECT 
    DISTINCT
    visitor_session_id, 
    1 as funnel_pick_call_visit 
  FROM ""raw.snowplow_pageviews""
  WHERE url_path like '%/pickCallAppointment%'
) pc ON pc.visitor_session_id = sp.visitor_session_id
LEFT JOIN
(
  SELECT 
    DISTINCT
    visitor_session_id,  
    1 as funnel_success_nc_visit 
  FROM ""raw.snowplow_pageviews""
  WHERE url_path like '%/successScreenFt%'
) sxn ON sxn.visitor_session_id = sp.visitor_session_id
LEFT JOIN
(
  SELECT 
    DISTINCT
    visitor_session_id,  
    1 as funnel_successpage_visit 
  FROM ""raw.snowplow_pageviews""
  WHERE url_path like '%/successScreen%'
) sx ON sx.visitor_session_id = sp.visitor_session_id
LEFT JOIN 
(
   SELECT
      visitor_session_id,
      user_id
   FROM
   (
      SELECT
         distinct
         visitor_session_id,
         user_id
      FROM
      (
         SELECT
            visitor_session_id, 
            user_id,
            RANK() OVER(PARTITION by visitor_session_id ORDER BY MAX(date_created) desc, RAND() desc)  as login_desc
         FROM raw.snowplow_pageviews
         WHERE user_id is not null
         GROUP BY 1,2
      ) uid
      WHERE login_desc = 1
   ) ab
GROUP BY 1,2
) id ON id.visitor_session_id = sp.visitor_session_id
WHERE sp.pageview_count = 1 
AND sp.visitor_id is not null"	READY
392	2015-04-24 18:24:22	"1126921205"	true	2015-08-07 10:48:20	tableau.mkt_tv_overview		"CREATE VIEW tableau.mkt_tv_overview
AS
SELECT 
	co.id as order_id,
	mo.flagged_as_tv,
	mo.tv_spot_date_aired,
	mo.tv_spot_station,
	mo.tv_spot_program,
	mo.marketing_channel_excluding_tv,
	mo.marketing_channel,
	co.shipping_country,
	co.shipping_zip,
	co.shipping_city,
	co.payment_method,
	co.sales_channel,
	co.date_picked,
	co.state,
	cu.default_page,
	coalesce(op.order_value_kept_re,0) as order_value_kept_re,
	coalesce(op.order_value_sent_re,0) as order_value_sent_re,
	coalesce(op.order_value_returned_re,0) as order_value_returned_re,
	case 
		when coalesce(op.order_value_sent_re,0)=0 then 0 
		else coalesce(op.order_value_returned_re,0)/coalesce(op.order_value_sent_re,0)
	end as return_rate
FROM views.customer_order co
LEFT JOIN views.marketing_order mo on co.id=mo.order_id
LEFT JOIN views.customer cu on cu.customer_id=co.customer_id
LEFT JOIN 
(
	SELECT
		op.order_id,
		sum(case when op.state>=16 and op.state<2048 then op.retail_price_euro else 0 end) order_value_sent_re,
		sum(case when op.state=1024 then op.retail_price_euro else 0 end) order_value_kept_re,
		sum(case when op.state=512 then op.retail_price_euro else 0 end) order_value_returned_re
	FROM views.order_position op
	GROUP BY 1
)op on op.order_id=co.id"	READY
46	2015-04-24 18:17:21	"1330319494"	true	2015-09-18 12:55:53	raw.customer_order_details__audit_log		"CREATE VIEW raw.customer_order_details__audit_log
AS

SELECT 
	CAST(al.persisted_object_id as long) as order_id,
	MAX(CASE WHEN al.property_name = 'paymentMethod' AND (al.old_value = '4' OR al.new_value = '4') THEN 1 ELSE 0 END) as pre_pay,
	/*workaround to fix the parsetimestamp until problem is found*/
	PARSETIMESTAMP(SUBSTRING(MIN(CASE WHEN al.property_name = 'phoneDate' AND (al.old_value is null OR al.old_value = 'null') THEN al.new_value END), 5, 30), 'MMM dd HH:mm:ss ''CEST'' yyyy') as original_phone_date,
	                                                                                                                                                                                                               	MIN(case when al.property_name='state' and al.old_value=4 and al.new_value=8 then al.date_created end) as date_incoming,                                                                                                                                                                         	MIN(case when al.property_name='state' and al.old_value=4 and al.new_value=12 then al.date_created end) as date_incoming_no_call,
	MIN(case when al.property_name='state' and al.old_value=8 and al.new_value=2048 then al.date_created end) as date_cancelled,
	MIN(case when al.property_name='state' and al.old_value=256 and al.new_value=384 then al.date_created end) as date_returned_online,
	MIN(CASE WHEN property_name='dateCompleted' and new_value is null and old_value is not null then cast(old_value as timestamp) END) as date_completed,
	MIN(CASE WHEN property_name='dateReturned' and new_value is null and old_value is not null then cast(old_value as timestamp) END) as date_returned,
	MIN(case when al.property_name='paymentMethod' and al.old_value=4 and al.new_value=2 then al.date_created end) as date_prepay_to_credit_card,
	MIN(case when al.property_name='paymentMethod' and al.old_value=1 and al.new_value=6 then al.date_created end) as date_arvato_accepted,
	MIN(case when al.property_name='paymentMethod' and al.old_value=2 and al.new_value=1 then al.date_created end) as date_cc_to_invoice
FROM postgres.audit_log al
GROUP BY 1"	READY
65,540	2015-05-04 17:51:05	"1112787904"	true	2015-05-04 17:51:05	tableau.bisdev_big_size_cg4_analysis		"CREATE view tableau.bisdev_big_size_cg4_analysis
AS

SELECT 
	coalesce(a.commodity_group4,sa.cat2) as commodity_group4,
	a.article_size,
	count(case when op.state>=16 and op.state<2048 then op.id else null end) as shipped_items,
	count(case when op.state=1024 then op.id else null end) as kept_items
FROM views.order_position op
LEFT JOIN views.article a on a.article_id=op.article_id
LEFT JOIN views.supplier_article_categories sa on sa.supplier_article_id=op.supplier_article_id
WHERE CAST(op.date_shipped as date)>=timestampadd(sql_tsi_week,-4,curdate())
group by 1,2"	READY
294,921	2015-07-07 13:52:25	"1112787995"	true	2015-07-20 14:36:21	raw.marketing_costs_per_voucher_campaign		"CREATE VIEW raw.marketing_costs_per_voucher_campaign
AS

SELECT
	co.date_created,
	co.country,
	co.marketing_channel,
	co.campaign_title,
	co.daily_costs,
	sp.daily_spread
FROM
(
	SELECT
	 	ca.date_created,
	 	dc.country,
	 	dc.marketing_channel,
	 	dc.campaign_title,
	 	dc.daily_costs
	FROM
	(
		SELECT
			""date"" as date_created
		FROM ""dwh.calendar"" 
		WHERE ""date"" >= '2014-01-01'	
	) ca
	CROSS JOIN
	(
		SELECT 
			campaign_title,
			marketing_channel,
			country,
			daily_costs 
		FROM raw.marketing_voucher_campaign_details
	) dc
	LEFT JOIN raw.marketing_voucher_campaign_details vc ON vc.campaign_title = dc.campaign_title
	WHERE ca.date_created >= vc.promotion_start
	AND ca.date_created <= vc.cost_reporting_date
	AND dc.daily_costs is not null
	ORDER BY 1,2
) co
LEFT JOIN 
(
	SELECT
	 	ca.date_created,
	 	dc.country,
	 	dc.marketing_channel,
	 	dc.campaign_title,
	 	dc.daily_spread
	FROM
		(
			SELECT
				""date"" as date_created
			FROM ""dwh.calendar"" 
			WHERE ""date"" >= '2014-01-01'	
		) ca
	CROSS JOIN
	(
		SELECT 
			campaign_title,
			marketing_channel,
			country,
			daily_spread
		FROM raw.marketing_voucher_campaign_details
	) dc
	LEFT JOIN raw.marketing_voucher_campaign_details vc ON vc.campaign_title = dc.campaign_title
	WHERE ca.date_created >= vc.promotion_start
	AND ca.date_created <= vc.promotion_end
	AND dc.daily_spread is not null
	ORDER BY 1,2
) sp ON sp.date_created = co.date_created AND sp.country = co.country AND sp.marketing_channel = co.marketing_channel AND sp.campaign_title = co.campaign_title"	READY
331	2015-04-24 18:20:53	"1126921209"	true	2015-08-07 10:49:25	tableau.ops_throughput_times_followons		"CREATE VIEW tableau.ops_throughput_times_followons AS

SELECT 
co.customer_id, 
co.shipping_country,
co.order_id, 
co.parent_order_id,
co.order_type, 
a.original_return_date,
co.date_created as followon_date_created,
co.date_stylist_picked as followon_date_picked,
co.date_shipped as followon_date_shipped,
co.date_returned as followon_date_returned,
sum(cal1.working_days) as total_working_days1,
sum(cal2.working_days)*-1 as total_working_days2
FROM bi.customer_order co
left join
(select
order_id,
date_returned as original_return_date,
order_state_number as parent_order_state
from
bi.customer_order) a
on a.order_id = parent_order_id
left join dwh.calendar cal1
on cal1.""date"" between cast(a.original_return_date as date) and cast(co.date_stylist_picked as date)
left join dwh.calendar cal2
on cal2.""date"" between cast(co.date_stylist_picked as date) and cast(a.original_return_date as date)
where co.parent_order_id is not null
and co.order_state_number >= 16 
and co.order_state_number <> 2048
and a.parent_order_state >= 16
and a.parent_order_state <> 2048
and co.date_stylist_picked is not null
group by 1,2,3,4,5,6,7,8,9,10"	READY
65,536	2015-05-04 14:17:25	"685090264"	true	2015-05-04 14:17:25	am.bugreport_base		CREATE VIEW am.bugreport_base AS
SELECT
bp.*,
sg.size_group_code "size_group_code"
FROM "am.base_pre" bp
LEFT JOIN "am.pim_model__size_group_code__indexed" sg ON sg.pim_model_id = bp.pim_model_id	READY
65,537	2015-05-04 14:17:38	"685092625"	true	2015-05-04 14:17:38	am.bugreport_check_complete		CREATE VIEW am.bugreport_check_complete AS
SELECT
c.pim_model_id,
(c.has_all AND cvg.has_all_in_group ) "all_okay"
FROM "am.check_base__all" c
LEFT JOIN "am.check_variant__grouped" cvg ON cvg.pim_model_id = c.pim_model_id	READY
65,542	2015-05-05 09:28:52	"1112787906"	true	2015-05-05 09:28:52	tableau.geschenk_article_based_ds		"CREATE VIEW tableau.geschenk_article_based_ds
AS

select 
	op.order_id,
	co.customer_id,
	co.payment_method,
	co.shipping_country,
	co.date_created,
	co.shipping_city,
	co.total_amount_basket_retail_gross,
	co.total_amount_billed_retail_gross,
	co.total_amount_payed,
	co.info_picagerange,
	co.info_pictypicalstyle,
	co.info_picclothwork,
	co.customer_age,
	co.follow_on_count,
	co.real_repeat_order_count,
	co.sales_channel,
	co.state,
	a.article_brand,
	a.commodity_group1,
	a.commodity_group2,
	a.commodity_group3,
	a.commodity_group4,
	a.commodity_group5,
	a.price_retail_de,
	a.purchase_price,
	case
	 	when co.real_repeat_order_count= '1' then 'first order'
	  when co.real_repeat_order_count is null then 'follow on order'
	  else 'real repeat'
	end as order_typ,
	timestampdiff(SQL_TSI_DAY,co.date_shipped,co.date_returned) as days_shipped_returned,
	sfo.arvatoStatus__c,
	sfo.NewCardrecommendation__c,
	sfo.NoCall_Box__c,
	md.marketing_channel,
	ad.arvatoscore,
	sty.""Name"",
	cast(c.first_order_date as date) as first_order_date,
	sfa.CustomerStatus__c,
	sfa.BMI__c,
	sfa.Outfittery_Club_Mitglied__c,
	a2.*,
	op2.*
from views.order_position op
left join views.article a on a.supplier_article_id = op.supplier_article_id
left join views.customer_order co on co.id = op.order_id
left join views.salesforce_opportunity sfo on sfo.ExternalOrderId__c = op.order_id
left join views.marketing_order md on md.order_id = op.order_id
left join views.additional_order_information ad on ad.order_id = op.order_id
left join views.stylist sty on sty.stylist_id=co.stylelist_id
inner join views.customer c on c.customer_id = co.customer_id
left join views.salesforce_account sfa on sfa.ExternalCustomerId__c = co.customer_id
inner join
(
	select 
		op.order_id as op2_order_id,
		avg(case when op.preview_id is null then 1 else 0 end) as has_preview,
		sum(case when op.state in (512, 1024, 1536) and op.date_shipped is not null then quantity else 0 end) as anzahl_artikel_verschickt,
		sum(case when  op.state=1024 and date_shipped is not null then  quantity else 0 end) as anzahl_artikel_verschickt_behalten, 
		sum(case when op.state in (512, 1024, 1536) and op.date_shipped  is not null then op.retail_price_euro else Null end) as gross_basket,
		sum(case when  op.state=1024 and op.date_shipped  is not null then op.retail_price_euro else 0 end) as net_basket, 
		round(((sum(case when op.state in (512, 1024, 1536) and op.date_shipped  is not null then op.retail_price_euro else Null end))-(sum(case when  op.state=1024 and op.date_shipped  is not null then op.retail_price_euro else 0 end)))/(sum(case when op.state in (512, 1024, 1536) and op.date_shipped  is not null then op.retail_price_euro else Null end) ),2) as rq_value,
		round((sum(case when op.state in (512, 1024, 1536) and op.date_shipped is not null then cast(quantity as bigdecimal) else null end)-(sum(case when  op.state=1024 and date_shipped is not null then cast(quantity as bigdecimal) else null end)))/(sum(case when op.state in (512, 1024, 1536) and op.date_shipped is not null then cast (quantity as bigdecimal) else Null end)),2)as rq_item
	from views.order_position op
	where cast(date_shipped as date)>='2013-07-01'
	group by op.order_id
) op2 on op.order_id = op2.op2_order_id
inner join 
(
	select 
		a.a2_order_id,
		count(case when ( a.article_ean ='2009876543503' or a.article_ean='2009876543510') then '1' else Null end) as geschenk_box,
		count(case when  a.article_ean ='2009876543503' then 1 else Null end) as geschenk_box_2009876543503, 
		count(case when  a.article_ean ='2009876636489' then 1 else Null end) as geschenk_box_2009876636489, 
		count(case when  a.article_ean ='2009876543527' then 1 else Null end) as geschenk_box_2009876543527, 
		count(case when  a.article_ean ='2009876543534' then 1 else Null end) as geschenk_box_2009876543534,  
		count(case when  a.article_ean ='2009876543510' then 1 else Null end) as geschenk_box_2009876543510
	from
	(
		select 
			op.order_id as a2_order_id, 
			article_ean
		from views.order_position op 
		inner join views.article a on a.supplier_article_id=op.supplier_article_id ) a 
		group by a2_order_id
	)a2 on a2.a2_order_id=op.order_id
where co.state!=2048 and co.date_shipped >= '2014-08-27'"	READY
65,544	2015-05-05 09:55:38	"1112787908"	true	2015-05-05 09:55:38	tableau.bisdev_days_returned_followon_orders		"CREATE VIEW tableau.bisdev_days_returned_followon_orders
AS

SELECT 
	co.customer_id, 
	co.id, 
	co.parent_order_id,
	co.order_type, 
	co.date_returned, 
	a.original_return_date,
	co.date_shipped
FROM views.customer_order co
LEFT JOIN
(
	select
		id,
		date_returned as original_return_date
	from views.customer_order
) a
on a.id = parent_order_id
where co.parent_order_id is not null"	READY
917,513	2015-09-30 09:43:25	"1394512972"	true	2015-09-30 09:43:25	tableau.mkt_picture_uploads_wishlist		"CREATE view tableau.mkt_picture_uploads_wishlist
AS

SELECT 
	cu.customer_id,
	cu.last_name as customer_last_name,
	cu.first_name as customer_first_name,
	sf.formal_or_informal,
	cu.prefix,
	st.first_name as stylist_first_name,
	st.last_name as stylist_last_name,
	cu.token,
	cu.email,
	cast(a.first_picture_uploaded as date) first_picture_upload_date,
	cast(a.last_picture_uploaded as date) last_picture_upload_date,
	cu.default_domain,
	a.nb_images as number_of_images,
	co.last_order_date 
FROM bi.customer cu
JOIN
(
	SELECT 
		customer_id,
		MAX(date_created) as last_picture_uploaded, 
		MIN(date_created) as first_picture_uploaded, 
		count(distinct image_url) as nb_images 
	FROM postgres.customer_image 
	WHERE original_file_name like '%APP+WISH_LIST%'
	AND cast(date_created as date)>='2015-01-01'
	group by 1
)a on a.customer_id=cu.customer_id
LEFT JOIN
(
	SELECT 
		customer_id, 
		max(cast(date_created as date)) as last_order_date
	FROM bi.customer_order
	group by 1
) co  ON co.customer_id = cu.customer_id
LEFT JOIN raw.stylist st ON cu.new_stylist_id = st.stylist_id 
LEFT JOIN raw.customer_salesforce sf ON sf.customer_id = cu.customer_id
WHERE cu.subscribe_status != 'Unsubscribed'
AND cu.user_type = 'Real User'
AND  co.last_order_date < cast(a.first_picture_uploaded as date)"	READY
416	2015-04-24 18:25:44	"1126921207"	true	2015-08-07 10:48:53	tableau.mkt_tv_performance		"CREATE view tableau.mkt_tv_performance
AS
SELECT 
	CAST(co.date_incoming as date) as ""date"",
	co.order_id as order_id,
	tv.program_after,
	tv.program_before,
	tv.spotname,
	tv.spotstation,
	tv.airingtime,
	CASE WHEN co.date_invoiced is not null THEN 1 ELSE 0 END AS orders_invoiced,
	at.contact_weight,
	co.shipping_country,
	co.shipping_zip,
	co.shipping_city,
	co.payment_type,
	co.sales_channel,
	co.date_invoiced,
	co.order_state,
	cu.default_domain,
	co.sales_sent,
	co.sales_kept,
	co.billing_total
FROM bi.customer_order co
LEFT JOIN bi.marketing_order_attribution at ON at.order_id = co.order_id
LEFT JOIN dwh.marketing_tv tv ON tv.order_id = co.order_id
LEFT JOIN bi.customer cu on cu.customer_id=co.customer_id
WHERE at.marketing_channel = 'TV'"	READY
330	2015-04-24 18:20:52	"1126921231"	true	2015-08-07 10:50:42	tableau.ops_throughput_times_order_overview		"CREATE VIEW tableau.ops_throughput_times_order_overview 
AS

SELECT 
  co.customer_id, 
  co.order_id,
  co.order_state_number AS co_state, 
  co.date_created AS customer_order_date, 
  op.order_position_mindate,
  op.order_position_maxdate, 
  co.date_invoiced, 
  co.date_cancelled, 
  co.date_completed, 
  co.date_paid, 
  co.date_stylist_picked, 
  co.date_returned, 
  co.date_shipped, 
  co.date_submitted, 
  co.shipping_country,
  co.articles_kept,
  co.articles_picked,
  co.articles_returned,
  co.articles_sent,
  dd.sales_order_header_created,
  dd.date_picklist_created,
  dd.date_backorder, 
  dd.date_on_error, 
  dd.date_shipment_manifest, 
  dd.date_shipment_confirmation, 
  dd.date_returned as dd_date_returned, 
  at.first_pick, 
  at.last_pick,
  at.stylist_article_adds as article_add,
  at.stylist_article_searches as article_search,
  at.stylist_article_removals as article_remove,
  at.stylist_id,
  at.stylist_name
FROM bi.customer_order co 
LEFT JOIN 
(
  select 
    coa.order_id, 
    MIN(coa.date_created) as order_position_mindate,
    MAX(coa.date_created) as order_position_maxdate
  from bi.customer_order_articles coa
  group by 1
) op ON op.order_id = co.order_id 
LEFT JOIN raw.customer_order_logistics dd ON dd.order_id = co.order_id
LEFT JOIN raw.stylist_action_tracking at on at.order_id=co.order_id and co.stylist_id=at.stylist_id
Where co.is_real_order = 'Real Order'"	READY
65,547	2015-05-05 10:31:15	"1112787911"	true	2015-05-05 10:31:15	tableau.mkt_rt_customer_cluster_basket_value		"CREATE VIEW tableau.mkt_rt_customer_cluster_basket_value
AS

SELECT 
	op.order_id,
	cast(co.invoice_date_created as date) as invoice_date_created,
	co.shipping_country,
	co.vat_percentage,
	co.currency_code,
	co.total_amount_billed_discount,
	co.total_goodwill_credit,
	case
		when repeat_orders.real_repeat_count is null and co.parent_order_id is null then '1'
		when repeat_orders.real_repeat_count= '1' and co.parent_order_id is null then '1'
		when repeat_orders.real_repeat_count> '1' and co.parent_order_id is null then '2'
		when repeat_orders.real_repeat_count is null and co.parent_order_id is not null then '3'
		when repeat_orders.real_repeat_count= '1' and co.parent_order_id is not null then '3'
	when repeat_orders.real_repeat_count> '1' and co.parent_order_id is not null then '3'
	end as ""co_newrepeatfollow"",
	ret.return_rate_3_weeks,
	count(co.id) as nb_of_orders,
	/*Articles Sent*/
	count(distinct case when op.state>= '128' and op.state<'2048' then op.id else null end) as ""articles sent"",
	count(distinct case when op.state= '128' then op.id else null end) as ""articles_sent_test"",
	count(distinct case when stock_location_id = 2 and op.state>= '128' and op.state<'2048' then op.id else null end) as ""articles_sent_os"",
	count(distinct case when stock_location_id <> 2 and op.state>= '128' and op.state<'2048' then op.id else null end) as ""articles_sent_ps"",
	/*Article Kept*/
	count(distinct case when op.state= '1024' then op.id else null end) as ""articles kept"",
	count(distinct case when stock_location_id = 2 and op.state= '1024' then op.id else null end) as ""articles_kept_os"",
	count(distinct case when stock_location_id <> 2 and op.state= '1024' then op.id else null end) as ""articles_kept_ps"",
	/*Gross Basket Purchase Price*/
	sum(case when op.state>=16 and op.state<2048 then op.quantity*op.purchase_price else 0 end) total_basket_purchase_price,
	sum(case when stock_location_id = 1 and op.state>=16 and op.state<2048 then op.quantity*op.purchase_price else 0 end)  as total_amount_basket_purchase_gross_z_stock,
	sum(case when stock_location_id = 2 and op.state>=16 and op.state<2048 then op.quantity*op.purchase_price else 0 end) as total_amount_basket_purchase_gross_own,
	sum(case when stock_location_id = 3 and op.state>=16 and op.state<2048 then op.quantity*op.purchase_price else 0 end) as total_amount_basket_purchase_gross_z_ch,
	/*Gross Basket Retail Price*/
	sum(case when op.state>=16 and op.state<2048 then op.quantity*op.retail_price_euro else 0 end) total_basket_retail_price,
	sum(case when stock_location_id = 1 and op.state>=16 and op.state<2048 then op.quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_z_stock,
	sum(case when stock_location_id = 2 and op.state>=16 and op.state<2048 then op.quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_own,
	sum(case when stock_location_id = 3 and op.state>=16 and op.state<2048 then op.quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_z_ch,
	/*Return Purchase Price*/
	sum(case when op.state=512 then op.quantity*op.purchase_price else 0 end) retoure_value_purchase_price,
	sum(case when stock_location_id = 1 and op.state=512 then op.quantity*op.purchase_price else 0 end)  as return_purchase_gross_z_stock,
	sum(case when stock_location_id = 2 and op.state=512 then op.quantity*op.purchase_price else 0 end) as return_purchase_gross_own,
	sum(case when stock_location_id = 3 and op.state=512 then op.quantity*op.purchase_price else 0 end) as return_purchase_gross_z_ch,
	/*Return Retail Price*/
	sum(case when op.state=512 then op.quantity*op.retail_price_euro else 0 end) retoure_value,
	sum(case when stock_location_id = 1 and op.state=512 then op.quantity*op.retail_price_euro else 0 end) as return_retail_gross_z_stock,
	sum(case when stock_location_id = 2 and op.state=512 then op.quantity*op.retail_price_euro else 0 end) as return_retail_gross_own,
	sum(case when stock_location_id = 3 and op.state=512 then quantity*op.retail_price_euro else 0 end) as return_retail_gross_z_ch,
	/*Lost Purchase Price*/
	sum(case when op.state=1536 then op.quantity*op.purchase_price else 0 end) gross_lost_purchase,
	sum(case when stock_location_id = 1 and op.state=1536 then op.quantity*op.purchase_price else 0 end)  as gross_lost_purchase_z_stock,
	sum(case when stock_location_id = 2 and op.state=1536 then op.quantity*op.purchase_price else 0 end) as gross_lost_purchase_own,
	sum(case when stock_location_id = 3 and op.state=1536 then op.quantity*op.purchase_price else 0 end) as gross_lost_purchase_z_ch,
	/*Lost Retail Price*/
	sum(case when op.state=1536 then op.quantity*op.retail_price_euro else 0 end) gross_lost_retail,
	sum(case when stock_location_id = 1 and op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_z_stock,
	sum(case when stock_location_id = 2 and op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_own,
	sum(case when stock_location_id = 3 and op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_z_ch
FROM views.order_position op
JOIN views.customer_order co on co.id=op.order_id
/*Order Type*/
LEFT JOIN (
	SELECT
	distinct rank() over (partition by customer_id order by id, cast(date_created as date) asc) as ""real_repeat_count"",
	id 
	FROM views.customer_order 
	WHERE parent_order_id is null
) repeat_orders on repeat_orders.id=co.id
/*Return Rate Per Country*/
LEFT JOIN
(
	SELECT shipping_country,case when shipping_country in('SE','DK','BE','LU') then 0.75 else return_rate_3_weeks end as return_rate_3_weeks 
	FROM
	(
		SELECT shipping_country, case when total_basket_retail_price=0 then 0 else return_retail_price/total_basket_retail_price end as return_rate_3_weeks 
		FROM
		(
			SELECT
				co.shipping_country,
				sum(case when op.state=512 then op.quantity*op.retail_price_euro else null end) return_retail_price,
				sum(case when co.state=1024 and op.state<=1024 then op.quantity*op.retail_price_euro else null end) total_basket_retail_price
			FROM views.order_position op
			JOIN views.customer_order co on co.id=op.order_id
			WHERE cast(co.invoice_date_created as date)>=timestampadd(sql_tsi_month,-3,timestampadd(sql_tsi_day,-14,curdate())) 
			AND cast(co.invoice_date_created as date)<=timestampadd(sql_tsi_day,-14,curdate())
			GROUP BY 1
		) a
	) b
) ret on ret.shipping_country=co.shipping_country
/*Where Conditions*/
WHERE co.order_state='Real Order'
AND co.state<=1024 
AND op.state<2048 
GROUP BY 1,2,3,4,5,6,7,8,9"	READY
65,553	2015-05-05 16:35:28	"1112787915"	true	2015-05-05 16:35:28	forecast.state_iop		"CREATE VIEW forecast.state_iop AS
SELECT
	cofo.customer_id,
	'IOP' AS ""state""
FROM forecast.customer__first_order AS cofo
WHERE TIMESTAMPDIFF(SQL_TSI_DAY, cofo.date_shipped, TIMESTAMPCREATE('2015-01-01', '00:00:00')) >= 0
  AND TIMESTAMPDIFF(SQL_TSI_DAY, cofo.date_shipped, TIMESTAMPCREATE('2015-01-01', '00:00:00')) < 30.4"	READY
294,926	2015-07-08 16:02:12	"1112787998"	true	2015-07-08 16:04:21	raw.customer_raw		"CREATE VIEW raw.customer_raw
AS

SELECT
	p.id AS customer_id,
	p.date_created,
	p.email,
	p.first_name,
	p.last_name,
	pr.date_of_birth,
	pr.phone_number,
	uc.providerid,
	CASE 
    	WHEN
      	p.first_name IN('test','Test','tester','Tester')
      	OR p.first_name like '% test %' OR p.first_name like '% Test %' 
      	OR p.last_name IN('test','Test','tester','Tester') OR p.last_name like '% test %' OR p.last_name like '% Test %' 
      	OR (p.email like '%test%' and p.email like '%@outfittery%')
      	OR (p.email like '%+%' and p.email like '%@outfittery%')
   		THEN 'Test User'
    	WHEN p.id in ('179899816','179886634','11804631','31281783','143553094','834667','197384812','163836386','62252329','94204965','234063161','242674884','243692185') THEN 		'Outfittery Showroom'
    ELSE 'Real User'
  	END as user_type,
  	CASE 
    	WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) >= 18 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) <= 30 THEN '18-30'
    	WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) >= 31 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) <= 35 THEN '31-35'
    	WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) >= 36 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) <= 45 THEN '36-45'
    	WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) >= 46 AND TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) <= 55 THEN '46-55'
    	WHEN TIMESTAMPDIFF(SQL_TSI_YEAR, cast(pr.date_of_birth as date),curdate()) >= 56 THEN '56+'
    	ELSE null
  	END as age_group
FROM postgres.principal p
LEFT JOIN postgres.profile pr on pr.id=p.profile_id
LEFT JOIN 
(
	SELECT 
		userid,
		providerid 
	FROM postgres.userconnection
)uc on uc.userid=p.email"	READY
370	2015-04-24 18:23:28	"1127038917"	true	2015-08-07 14:00:23	tableau.accounting_order_report_weekly_ch_correction		"CREATE VIEW tableau.accounting_order_report_weekly_ch_correction
AS
SELECT 
	op.order_id,
	co.customer_id,
	co.invoice_date_created,
	co.date_shipped,
	co.date_created,
	cu.date_created as customer_date_created,
	co.shipping_country,
	co.vat_percentage,
	co.currency_code,
    co.box_type,
	co.total_amount_billed_discount_euro,
	co.total_goodwill_credit_euro,
    co.total_amount_paid_euro,
	co.order_type,
	co.date_payed,
    co.date_picked,
	co.payment_method,
	co.date_returned,
	co.first_saleschannel_completed,
	ret.return_rate_3_weeks,
	op.articles_sent,
	op.articles_sent_os,
	op.articles_sent_ps,
	op.articles_kept,
	op.articles_kept_os,
	op.articles_kept_ps,
	op.total_basket_purchase_price,
	op.total_amount_basket_purchase_gross_patner,
	op.total_amount_basket_purchase_gross_own,
	op.total_basket_retail_price,
	op.total_amount_basket_retail_gross_patner,
	op.total_amount_basket_retail_gross_own,
	op.retoure_value_purchase_price,
	op.return_purchase_gross_patner,
	op.return_purchase_gross_own,
	op.retoure_value,
	op.return_retail_gross_patner,
	op.return_retail_gross_own,
	op.gross_lost_purchase,
	op.gross_lost_purchase_patner,
	op.gross_lost_purchase_own,
	op.gross_lost_retail,
	op.gross_lost_retail_patner,
	op.gross_lost_retail_own,
	arv.paid_to_arvato,
	arv.arvato_paid_date,
/*Campaign Details*/
  ca.code as campaign_code,
  ca.campaign_title,
  ca.currency as campaign_currency,
/*Stylist Information*/
  	sty.""Name"" as stylist_name,
  	sty.user_role
FROM views.customer_order co
LEFT JOIN views.customer cu on cu.customer_id=co.customer_id
/*Order Position KPI's*/
INNER JOIN 
(
	SELECT 
		op.order_id,
		/*Articles Sent*/
		count(DISTINCT CASE WHEN op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent"",
		count(DISTINCT CASE WHEN stock_location_id = 2 AND op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent_os"",
		count(DISTINCT CASE WHEN stock_location_id <> 2 AND op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent_ps"",
		/*Article Kept*/
		count(DISTINCT CASE WHEN op.state=1024 then op.id else null end) as ""articles_kept"",
		count(DISTINCT CASE WHEN stock_location_id = 2 AND op.state=1024 then op.id else null end) as ""articles_kept_os"",
		count(DISTINCT CASE WHEN stock_location_id <> 2 AND op.state= 1024 then op.id else null end) as ""articles_kept_ps"",
		/*Basket Purchase Price*/
		SUM(CASE WHEN op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end) total_basket_purchase_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end)  as total_amount_basket_purchase_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end) as total_amount_basket_purchase_gross_own,
		/*basket Retail Price*/
		SUM(CASE WHEN op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) total_basket_retail_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_own,
		/*Return Purchase Price*/
		SUM(CASE WHEN op.state=512 then quantity*op.purchase_price else 0 end) retoure_value_purchase_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=512 then quantity*op.purchase_price else 0 end)  as return_purchase_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=512 then quantity*op.purchase_price else 0 end) as return_purchase_gross_own,
		/*Return Retail Price*/
		SUM(CASE WHEN op.state=512 then quantity*op.retail_price_euro else 0 end) retoure_value,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=512 then quantity*op.retail_price_euro else 0 end) as return_retail_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=512 then quantity*op.retail_price_euro else 0 end) as return_retail_gross_own,
		/*Lost Purchase Price*/
		SUM(CASE WHEN op.state=1536 then op.quantity*op.purchase_price else 0 end) gross_lost_purchase,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=1536 then op.quantity*op.purchase_price else 0 end)  as gross_lost_purchase_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=1536 then op.quantity*op.purchase_price else 0 end) as gross_lost_purchase_own,
		/*Lost Retail Price*/
		SUM(CASE WHEN op.state=1536 then op.quantity*op.retail_price_euro else 0 end) gross_lost_retail,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_own
		FROM views.order_position op
		GROUP BY 1
)op on op.order_id=co.id
/*Return Rate Per Country*/
LEFT JOIN
(
	SELECT 
	shipping_country,
	CASE 
		WHEN shipping_country in('SE','DK','BE','LU') then 0.75
                WHEN shipping_country='CH' then 0.70 
		else return_rate_3_weeks 
	end as return_rate_3_weeks 
	FROM(
			SELECT 
			shipping_country, 
			CASE WHEN total_basket_retail_price=0 then 0 
			else return_retail_price/total_basket_retail_price 
			end as return_rate_3_weeks 
			FROM(
				SELECT
					co.shipping_country,
					SUM(CASE WHEN op.state=512 then quantity*op.retail_price_euro else 0 end) return_retail_price,
					SUM(CASE WHEN co.state=1024 AND op.state<=1024 then quantity*op.retail_price_euro else 0 end) total_basket_retail_price
				FROM views.order_position op
				INNER JOIN views.customer_order co on co.id=op.order_id
				WHERE cast(co.invoice_date_created as date)>=timestampadd(sql_tsi_month,-3,timestampadd(sql_tsi_day,-14,curdate())) AND
				cast(co.invoice_date_created as date)<=timestampadd(sql_tsi_day,-14,curdate())
			GROUP BY 1)
		a)
b)ret on ret.shipping_country=co.shipping_country
LEFT JOIN
(
	SELECT 
		ordernumber,
		sum(amount) as paid_to_arvato,
		max(cast(date_created as date)) as arvato_paid_date
	FROM views.arvatopayments
	group by 1
)arv on arv.ordernumber=co.id
LEFT JOIN views.campaign ca on ca.id=co.campaign_id
LEFT JOIN views.stylist sty on sty.stylist_id=co.stylelist_id
WHERE cast(co.invoice_date_created as date)>='2014-01-01' AND
co.order_state='Real Order' AND co.state<=1024"	READY
917,514	2015-09-30 09:59:39	"1394513010"	true	2015-09-30 09:59:39	raw.fact_order		"/**********************************************************************************************
-- Author       Hemanth
-- Created      2015-07-01
-- Purpose      This view applies estimation for orders which are not returned and finally 
                all kpi's are aggreated on order_id
-- Tables       datamart.dim_opportunity,datamart.dim_order,raw.customer,raw.dim_case
--------------------------------------------------------------------------------------------------
-- Modification History

-- Date          Author      Description
-- 2015-09-16    Hemanth     1) Added Estimation for Item
                             2) Header for query
-- 2015-09-28   Hemanth      1) Added discount_goodwill and discount_marketing subquery  
-- 2015-09-30	Hemanth		 1) Added purchase price (cost) from item/article table
**************************************************************************************************/
CREATE VIEW ""raw"".""fact_order""
AS

WITH o_position AS
(
  SELECT
  coa.order_position_id,
  coa.order_id,
  coa.state,
  coa.quantity,

  coa.items_picked_wt_can,
  coa.items_picked,
  coa.items_kept,
  coa.items_returned,
  coa.items_lost,
  coa.items_cancelled,

  /*Sales in Local Currency*/
  coa.items_picked_wt_can*coa.sales_in_local_currency AS sales_picked_wt_can_in_local_currency,
  coa.items_picked*coa.sales_in_local_currency AS sales_picked_in_local_currency,
  coa.items_kept*coa.sales_in_local_currency AS sales_kept_in_local_currency,
  coa.items_returned*coa.sales_in_local_currency AS sales_returned_in_local_currency,
  coa.items_lost*coa.sales_in_local_currency AS sales_lost_in_local_currency,
  coa.items_cancelled*coa.sales_in_local_currency AS sales_cancelled_in_local_currency,
  COALESCE(
        CASE 
            WHEN coa.state=512 then coa.sales_in_local_currency
            ELSE coa.sales_in_local_currency*return_probability 
        END,0) AS sales_returned_est_in_local_currency,
  COALESCE(
        CASE 
            WHEN coa.state=1024 then coa.sales_in_local_currency
            ELSE coa.sales_in_local_currency*(1-return_probability)
        END,0) AS sales_kept_est_in_local_currency,

  /*Sales In Euros*/
  coa.items_picked_wt_can*coa.sales_in_local_currency/e.exchange_rate  AS sales_picked_wt_can_in_eur,
  coa.items_picked*coa.sales_in_local_currency/e.exchange_rate AS sales_picked_in_eur,
  coa.items_kept*coa.sales_in_local_currency/e.exchange_rate AS sales_kept_in_eur,
  coa.items_returned*coa.sales_in_local_currency/e.exchange_rate AS sales_returned_in_eur,
  coa.items_lost*coa.sales_in_local_currency/e.exchange_rate AS sales_lost_in_eur,
  coa.items_cancelled*coa.sales_in_local_currency/e.exchange_rate AS sales_cancelled_in_eur,
  COALESCE(
    CASE 
      WHEN coa.state=512 then coa.sales_in_local_currency/e.exchange_rate
      ELSE (coa.sales_in_local_currency/e.exchange_rate)*return_probability 
    END,0) AS sales_returned_est_in_eur,
  COALESCE(
    CASE 
      WHEN coa.state=1024 then coa.sales_in_local_currency/e.exchange_rate
      ELSE (coa.sales_in_local_currency/e.exchange_rate)*(1-return_probability)
    END,0) AS sales_kept_est_in_eur,
  /*COST*/
  coa.items_picked_wt_can*COALESCE(it.unit_cost,art.article_cost) AS cost_picked_with_can,
  coa.items_picked*COALESCE(it.unit_cost,art.article_cost) AS cost_picked,
  coa.items_kept*COALESCE(it.unit_cost,art.article_cost) AS cost_kept,
  coa.items_returned*COALESCE(it.unit_cost,art.article_cost) AS cost_returned,
  coa.items_lost*COALESCE(it.unit_cost,art.article_cost) AS cost_lost,
  coa.items_cancelled*COALESCE(it.unit_cost,art.article_cost) AS cost_cancelled,
  COALESCE(
    CASE 
      WHEN coa.state=512 then coa.items_picked
      ELSE coa.items_picked*return_probability 
    END,0) AS items_returned_est,
  COALESCE(
    CASE 
      WHEN coa.state=1024 then coa.items_picked
      ELSE coa.items_picked*(1-return_probability)
    END,0) AS items_kept_est,

  COALESCE(CASE WHEN coa.state=512 THEN coa.cost_in_eur ELSE coa.cost_in_eur*return_probability END,0) AS cost_returned_est,
  COALESCE(CASE WHEN coa.state=1024 THEN coa.cost_in_eur ELSE coa.cost_in_eur*(1-return_probability) END,0) AS cost_kept_est

  FROM raw.fact_order_position coa
  JOIN raw.dim_customer_order co ON co.order_id = coa.order_id
  LEFT JOIN bi.item it on it.article_id=coa.article_id
  LEFT JOIN bi.article art on art.article_id=coa.article_id
  LEFT JOIN dwh.historical_exchange_rates e on e.currency_code = co.country_code_iso AND cast(co.date_invoiced AS date) = e.date
  LEFT JOIN dwh.order_position_fixed_purchase_prices opfpp on coa.order_position_id = opfpp.order_position_id
  LEFT JOIN raw.return_rate_probability rp on rp.order_position_id=coa.order_position_id
)

SELECT
    op.order_id,
    
    /*Items*/
    SUM(op.items_picked_wt_can) AS items_b4_can,
    SUM(op.items_cancelled) AS items_cancelled,
    SUM(op.items_picked) AS items_b4_ret,
    SUM(COALESCE(op.items_returned, 0) + COALESCE(op.items_lost, 0)) AS items_returned,
    SUM(op.items_returned_est) AS items_returned_est,
    SUM(op.items_kept) AS items_kept,
    SUM(op.items_kept_est) AS items_kept_est,
    
    /*Sales in EUROs-Datamart*/
    SUM(op.sales_picked_wt_can_in_eur) AS gross_sales_b4_can_in_eur,
    SUM(op.sales_cancelled_in_eur) AS gross_sales_can_in_eur,
    SUM(op.sales_picked_in_eur) AS gross_sales_b4_ret_in_eur,
    SUM(COALESCE(op.sales_returned_in_eur, 0) + COALESCE(op.sales_lost_in_eur, 0)) AS gross_sales_ret_in_eur, 
    SUM(op.sales_returned_est_in_eur) AS gross_sales_ret_est_in_eur,
    SUM(op.sales_kept_in_eur) AS sales_kept_in_eur,
    SUM(op.sales_kept_est_in_eur) AS sales_kept_est_in_eur,
    
    /*Sales in Local Currency-Datamart*/
    SUM(op.sales_picked_wt_can_in_local_currency) AS gross_sales_b4_can_in_local_currency,
    SUM(op.sales_cancelled_in_local_currency) AS gross_sales_can_in_local_currency,
    SUM(op.sales_picked_in_local_currency) AS gross_sales_b4_ret_in_local_currency,
    SUM(COALESCE(op.sales_returned_in_local_currency, 0) + COALESCE(op.sales_lost_in_local_currency, 0)) AS gross_sales_ret_in_local_currency, 
    SUM(op.sales_returned_est_in_local_currency) AS gross_sales_ret_est_in_local_currency,
    SUM(op.sales_kept_in_local_currency) AS sales_kept_in_local_currency, 
    SUM(op.sales_kept_est_in_local_currency) AS sales_kept_est_in_local_currency,
    
    /*COGS (currency is always in EUR)-Datamart*/
    SUM(op.cost_picked_with_can) AS cogb4canc,
    SUM(op.cost_cancelled) AS cogcanc, 
    SUM(op.cost_picked) AS cogb4ret,
    SUM(COALESCE(op.cost_returned, 0) + COALESCE(op.cost_lost, 0)) AS cogret,
    SUM(op.cost_returned_est) AS estcogret,
    SUM(op.cost_kept) as cogs_kept,
    SUM(op.cost_kept_est) as cogs_kept_est,
    
    AVG(co.goodwill_in_local_currency) AS goodwill_in_local_currency,
  	AVG(co.goodwill_in_eur) AS goodwill_in_eur,
  	AVG(co.discount_in_local_currency) AS discount_in_local_currency,
  	AVG(co.discount_in_eur) AS discount_in_eur
  
FROM o_position op
LEFT JOIN
(
  SELECT 
    co_1.order_id,
    co_1.discount_goodwill as goodwill_in_local_currency,
    co_1.discount_goodwill/e.exchange_rate AS goodwill_in_eur,
    co_1.discount_marketing as discount_in_local_currency,
    co_1.discount_marketing/e.exchange_rate as discount_in_eur
  FROM raw.dim_customer_order co_1
  LEFT JOIN dwh.historical_exchange_rates e on e.currency_code = co_1.country_code_iso AND cast(co_1.date_invoiced AS date) = e.date 
)co on co.order_id=op.order_id
GROUP BY op.order_id"	READY
917,515	2015-09-30 17:45:18	"1399912864"	true	2015-10-01 09:08:42	tableau.ios_performance		"CREATE VIEW ""tableau.ios_performance"" 
AS

SELECT
co_1.*,
vi.visits,
av.app_installs
FROM 
(
		SELECT		
		CAST(co.date_created AS DATE) as date_created,
		CASE
			WHEN co.sales_channel IN('appWithDate','appWithoutDate','miniAppWithDate','miniAppWithDate','miniApp','app')
			THEN 'App'
			ELSE 'Desktop'
		END AS app_type,
		COUNT(DISTINCT co.order_id) AS nb_order,
		COUNT(DISTINCT CASE WHEN co.date_invoiced is not null then co.order_id end) AS nb_order_invoiced,
		SUM(co.sales_sent) as sales_sent,
		SUM(co.sales_kept) as sales_kept,
		SUM(co.sales_sent)/
			COUNT(DISTINCT CASE WHEN co.date_invoiced is not null then co.order_id end) as avg_sales_sent,
		SUM(co.sales_kept)/
			COUNT(DISTINCT CASE WHEN co.date_invoiced is not null then co.order_id end) as avg_sales_kept,
		COUNT(DISTINCT CASE WHEN co.box_type='Call Box' THEN co.order_id END) AS nb_order_call,
		COUNT(DISTINCT CASE WHEN co.box_type='No Call Box' THEN co.order_id END) AS nb_order_no_call,
		COUNT(DISTINCT CASE WHEN co.date_invoiced is not null and co.box_type='Call Box' then co.order_id end) AS nb_order_invoiced_call,
		COUNT(DISTINCT CASE WHEN co.date_invoiced is not null and co.box_type='No Call Box' then co.order_id end) AS nb_order_invoiced_nocall,
		COUNT(DISTINCT CASE WHEN co.box_type='Call Box' THEN co.sales_sent END) AS sales_sent_call,
		COUNT(DISTINCT CASE WHEN co.box_type='No Call Box' THEN co.sales_sent END) AS sales_sent_no_call,
		COUNT(DISTINCT CASE WHEN co.box_type='Call Box' THEN co.sales_kept END) AS sales_kept_call,
		COUNT(DISTINCT CASE WHEN co.box_type='No Call Box' THEN co.sales_kept END) AS sales_kept_no_call
		FROM bi.customer_order co
		GROUP BY 1,2
)co_1
LEFT JOIN 
(
	SELECT 
    	date_created,
    	CAST('Desktop' AS string) as app_type,
    	SUM(visits) as visits 
  	FROM ""bi.marketing_funnel_by_date_domain_channel_device""
  	GROUP BY 1,2
)vi on vi.date_created=CAST(co_1.date_created AS DATE) AND vi.app_type=co_1.app_type
LEFT JOIN
(
	SELECT
		CAST(date_created as date) as date_created,
		CAST('App' AS string) AS app_type,
		SUM(installs) as app_installs
	FROM dwh.appdownloads
	GROUP BY 1,2
)av on av.date_created=CAST(co_1.date_created AS DATE) AND av.app_type=co_1.app_type"	READY
917,517	2015-10-01 10:23:28	"1399913004"	true	2015-10-01 10:26:47	tableau.followon_movement_invoiced_vs_calcelled		"CREATE view tableau.followon_movement_invoiced_vs_calcelled
as
select  case when used_invoice_number is not null then 'Invoiced'
	   		else 'Not-Invoiced'
	   end as invoice_state,        
       followon_date_created ,
	  
	   count(distinct(order_id)) as Volume	     
from 
(
	select followon_date_created,
           a.order_id,
           b.used_invoice_number
    from (
		select
			cast(date_created as date) as followon_date_created,  
			order_id
		from ""raw.customer_order"" 
		where cast(date_created as date)  >= '2015-01-01'
			and order_type in ('Repeat Order Follow-on', 'First Order Follow-on')) as a	
	left join
	( 
		select orderid,used_invoice_number
		from ""postgres.doc_data_manifest_shipping"" 
		where cast(date_created as date)  >= '2015-01-01'
	) as b
	on  a.order_id = b.orderid) tab
	group by 1,2;"	READY
196,671	2015-06-11 17:41:32	"871959056"	true	2015-06-11 17:41:32	ob.product_group_category_slot		"CREATE VIEW ob.product_group_category_slot AS
SELECT ""csv_table"".* FROM
(call ""file"".getFiles('product_group_category_slot.csv')) f,
	TEXTTABLE(to_chars(f.file,'UTF-8') 
		COLUMNS 
		""product_group_code"" STRING,
		""flat_category"" STRING,
		""outfit_slot"" STRING 
		DELIMITER ',' 
		QUOTE '''' 
		HEADER 1 
	)
""csv_table"""	READY
294,941	2015-07-10 15:24:57	"1112788001"	true	2015-07-23 10:21:30	tableau.mkt_campaign_detail_overview		"CREATE view tableau.mkt_campaign_detail_overview
AS

SELECT
 	ca.campaign_title,
 	ca.country,
 	ca.promotion_start, 
 	ca.promotion_end, 
 	ca.cost_reporting_date, 
 	ca.promotion_runtime, 
 	ca.campaign_type, 
 	ca.marketing_channel, 
 	ca.cluster, 
 	ca.agency, 
 	ca.publisher,
 	ca.volume,
 	ca.cpm_print,
 	ca.cpm_publisher,
 	ca.envelope_costs,
 	ca.cpm_total,
 	ca.ad_costs,
 	ca.fixed_costs,
 	ca.cpo_publisher,
 	ca.cvr_forecast,
 	ca.total_costs_forecast,
 	ca.new_customer_invoiced_order_forecast,
 	ca.cac_forecast,
 	ca.daily_costs,
 	od.orders_incoming,
 	at.incoming_first_orders as attributed_orders_incoming,
 	od.orders_invoiced,
 	at.invoiced_first_orders as attributed_orders_invoiced,
 	od.articles_sent,
 	od.articles_kept,
 	od.sales_sent,
 	at.sales_sent as attributed_sales_sent,
 	od.sales_kept,
 	at.sales_kept as attributed_sales_kept,
 	od.discount_total,
 	od.billing_total,
 	od.billing_net_sales,
 	at.billing_net_sales as attributed_billing_net_sales,
 	mc.aggregated_costs,
 	mc.aggregated_spread 	
FROM raw.marketing_voucher_campaign_details ca
LEFT JOIN
(
SELECT
	RTRIM(LTRIM(cam.campaign_title)) as campaign_title,
	SUM(CASE WHEN co.date_incoming is not null then 1 ELSE null END) AS orders_incoming,
	SUM(CASE WHEN co.date_invoiced is not null then 1 ELSE null END) AS orders_invoiced,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.articles_sent else null END) as articles_sent,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.articles_kept else null END) as articles_kept,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.sales_sent else null END) as sales_sent,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.sales_kept else null END) as sales_kept,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.discount_total else null END) as discount_total,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.billing_total else null END) as billing_total,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.billing_net_sales else null END) as billing_net_sales
FROM bi.customer_order co
LEFT JOIN raw.discount_campaigns cam ON co.campaign_id = cam.campaign_id
WHERE co.is_real_order = 'Real Order'
AND cam.campaign_title is not null
AND order_type = 'First Order'
GROUP BY 1
) od ON od.campaign_title = ca.campaign_title
LEFT JOIN
(
	SELECT 
		campaign_title,
		SUM(daily_costs) as aggregated_costs,
		SUM(daily_spread) as aggregated_spread
	FROM raw.marketing_costs_per_voucher_campaign
	WHERE date_created <= CURDATE() 
	GROUP BY 1
) mc ON mc.campaign_title = ca.campaign_title
LEFT JOIN
(
SELECT 
	marketing_campaign,
	SUM(incoming_first_orders) as incoming_first_orders,
	SUM(invoiced_first_orders) as invoiced_first_orders,
	SUM(sales_sent) as sales_sent,
	SUM(sales_kept) as sales_kept,
	SUM(billing_net_sales) as billing_net_sales
FROM bi.marketing_order_attribution_aggregated
WHERE reporting_type = 'date_incoming'
AND marketing_channel IN ('Inserts', 'Affiliate', 'Cooperations')
GROUP BY 1
) at ON LTRIM(RTRIM(at.marketing_campaign)) = ca.campaign_title"	READY
369	2015-04-24 18:23:25	"1127038921"	true	2015-08-07 14:01:08	tableau.accounting_order_report_weekly_monthly_75		"CREATE VIEW tableau.accounting_order_report_weekly_monthly_75
AS
SELECT 
	op.order_id,
	co.customer_id,
	co.invoice_date_created,
	co.date_shipped,
	co.date_created,
	cu.date_created as customer_date_created,
	co.shipping_country,
	co.vat_percentage,
	co.currency_code,
    co.box_type,
	co.total_amount_billed_discount_euro,
	co.total_goodwill_credit_euro,
    co.total_amount_paid_euro,
	co.order_type,
	co.date_payed,
	co.payment_method,
	co.date_returned,
	co.first_saleschannel_completed,
	CASE 
    	WHEN extract(YEAR from co.invoice_date_created)='2014' then 0.75
    	else ret.return_rate_3_weeks
  	END AS return_rate_3_weeks,
	op.articles_sent,
	op.articles_sent_os,
	op.articles_sent_ps,
	op.articles_kept,
	op.articles_kept_os,
	op.articles_kept_ps,
	op.total_basket_purchase_price,
	op.total_amount_basket_purchase_gross_patner,
	op.total_amount_basket_purchase_gross_own,
	op.total_basket_retail_price,
	op.total_amount_basket_retail_gross_patner,
	op.total_amount_basket_retail_gross_own,
	op.retoure_value_purchase_price,
	op.return_purchase_gross_patner,
	op.return_purchase_gross_own,
	op.retoure_value,
	op.return_retail_gross_patner,
	op.return_retail_gross_own,
	op.gross_lost_purchase,
	op.gross_lost_purchase_patner,
	op.gross_lost_purchase_own,
	op.gross_lost_retail,
	op.gross_lost_retail_patner,
	op.gross_lost_retail_own,
	arv.paid_to_arvato,
	arv.arvato_paid_date,
/*Campaign Details*/
  ca.code as campaign_code,
  ca.campaign_title,
  ca.currency as campaign_currency
FROM views.customer_order co
LEFT JOIN views.customer cu on cu.customer_id=co.customer_id
/*Order Position KPI's*/
INNER JOIN 
(
	SELECT 
		op.order_id,
		/*Articles Sent*/
		count(DISTINCT CASE WHEN op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent"",
		count(DISTINCT CASE WHEN stock_location_id = 2 AND op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent_os"",
		count(DISTINCT CASE WHEN stock_location_id <> 2 AND op.state>= '128' AND op.state<2048 then op.id else null end) as ""articles_sent_ps"",
		/*Article Kept*/
		count(DISTINCT CASE WHEN op.state=1024 then op.id else null end) as ""articles_kept"",
		count(DISTINCT CASE WHEN stock_location_id = 2 AND op.state=1024 then op.id else null end) as ""articles_kept_os"",
		count(DISTINCT CASE WHEN stock_location_id <> 2 AND op.state= 1024 then op.id else null end) as ""articles_kept_ps"",
		/*Basket Purchase Price*/
		SUM(CASE WHEN op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end) total_basket_purchase_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end)  as total_amount_basket_purchase_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state>=16 AND op.state<2048 then quantity*op.purchase_price else 0 end) as total_amount_basket_purchase_gross_own,
		/*basket Retail Price*/
		SUM(CASE WHEN op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) total_basket_retail_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state>=16 AND op.state<2048 then quantity*op.retail_price_euro else 0 end) as total_amount_basket_retail_gross_own,
		/*Return Purchase Price*/
		SUM(CASE WHEN op.state=512 then quantity*op.purchase_price else 0 end) retoure_value_purchase_price,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=512 then quantity*op.purchase_price else 0 end)  as return_purchase_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=512 then quantity*op.purchase_price else 0 end) as return_purchase_gross_own,
		/*Return Retail Price*/
		SUM(CASE WHEN op.state=512 then quantity*op.retail_price_euro else 0 end) retoure_value,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=512 then quantity*op.retail_price_euro else 0 end) as return_retail_gross_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=512 then quantity*op.retail_price_euro else 0 end) as return_retail_gross_own,
		/*Lost Purchase Price*/
		SUM(CASE WHEN op.state=1536 then op.quantity*op.purchase_price else 0 end) gross_lost_purchase,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=1536 then op.quantity*op.purchase_price else 0 end)  as gross_lost_purchase_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=1536 then op.quantity*op.purchase_price else 0 end) as gross_lost_purchase_own,
		/*Lost Retail Price*/
		SUM(CASE WHEN op.state=1536 then op.quantity*op.retail_price_euro else 0 end) gross_lost_retail,
		SUM(CASE WHEN stock_location_id <> 2 AND op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_patner,
		SUM(CASE WHEN stock_location_id = 2 AND op.state=1536 then op.quantity*op.retail_price_euro else 0 end) as gross_lost_retail_own
		FROM views.order_position op
		GROUP BY 1
)op on op.order_id=co.id
/*Return Rate Per Country*/
LEFT JOIN
(
	SELECT 
	shipping_country,
	CASE 
		WHEN shipping_country in('SE','DK','BE','LU') then 0.75 
		else return_rate_3_weeks 
	end as return_rate_3_weeks 
	FROM(
			SELECT 
			shipping_country, 
			CASE WHEN total_basket_retail_price=0 then 0 
			else return_retail_price/total_basket_retail_price 
			end as return_rate_3_weeks 
			FROM(
				SELECT
					co.shipping_country,
					SUM(CASE WHEN op.state=512 then quantity*op.retail_price_euro else 0 end) return_retail_price,
					SUM(CASE WHEN co.state=1024 AND op.state<=1024 then quantity*op.retail_price_euro else 0 end) total_basket_retail_price
				FROM views.order_position op
				INNER JOIN views.customer_order co on co.id=op.order_id
				WHERE cast(co.invoice_date_created as date)>=timestampadd(sql_tsi_month,-3,timestampadd(sql_tsi_day,-14,curdate())) AND
				cast(co.invoice_date_created as date)<=timestampadd(sql_tsi_day,-14,curdate())
			GROUP BY 1)
		a)
b)ret on ret.shipping_country=co.shipping_country
LEFT JOIN
(
	SELECT 
		ordernumber,
		sum(amount) as paid_to_arvato,
		max(cast(date_created as date)) as arvato_paid_date
	FROM views.arvatopayments
	group by 1
)arv on arv.ordernumber=co.id
LEFT JOIN views.campaign ca on ca.id=co.campaign_id
WHERE cast(co.invoice_date_created as date)>='2014-01-01' AND
co.order_state='Real Order' AND co.state<=1024"	READY
557,062	2015-08-18 14:10:37	"1189689522"	true	2015-08-20 17:55:46	tableau.sales_ccc_report		"CREATE view tableau.sales_ccc_report
as
/*customer call center report, this report is exported every 2nd week by sales team to call 
customers */

with c_order as
(
	SELECT 
 		rank() OVER(PARTITION BY customer_id ORDER BY date_created desc) as rank_cust,
 		order_id,
 		order_type,
		customer_id,
		date_created,
		shipping_country,
		case when revenue_state='Final' then sales_kept end as sales_kept,
		case when revenue_state='Final' then articles_kept end as articles_kept
	from bi.customer_order
	WHERE shipping_country='DE'
)

SELECT 
	cu.customer_id,
	cu.vip_customer,
	cu.first_name||' '||cu.last_name as customer_name,
	st.stylist,
	cu.phone_number,
	cu.email,
	b.articles_kept,
	b.sales_kept,
	b.last_date_ordered,
	cos.last_call_reactivation
FROM bi.customer cu
LEFT JOIN bi.stylist st on st.stylist_id=cu.new_stylist_id
JOIN
(
	SELECT
		customer_id,
		MAX(date_created) as last_date_ordered,
		sum(sales_kept) as sales_kept,
		SUM(articles_kept) as articles_kept
	FROM
	(
		SELECT * FROM c_order WHERE rank_cust=1 and sales_kept>=150
	)a
	WHERE 
	   order_type in ('Repeat Order', 'Repeat Order Follow-on')
	GROUP BY 1
	HAVING SUM(sales_kept)>=150
	AND MAX(CAST(date_created AS DATE))>=TIMESTAMPADD(SQL_TSI_YEAR,-1,CURDATE())
)b on b.customer_id=cu.customer_id
LEFT JOIN raw.customer_salesforce cos on cos.customer_id=cu.customer_id
WHERE cu.club_member<>'true'
and cu.phone_number IS NOT NULL
AND cos.last_call_reactivation<=TIMESTAMPADD(SQL_TSI_WEEK,-2,CURDATE())"	READY
458,752	2015-08-07 14:09:40	"1127039218"	true	2015-08-07 16:15:11	sandbox.attributed_marketing_report		"CREATE VIEW sandbox.attributed_marketing_report
AS


SELECT
  ab.reporting_type,
  ab.date,
  CASE
  	WHEN ab.""date"" < CURDATE() THEN 'Actuals'
  	ELSE 'Forecast'
  END AS forecast_or_actuals,
  ab.year_month,
  ab.year_week,
  ab.domain,
  ab.marketing_channel,
  ab.days_in_week,
  ab.days_week_passed,
  ab.days_in_month,
  ab.days_month_passed,   
  at.incoming_first_orders,
  at.invoiced_first_orders,
  at.sales_sent,
  at.sales_kept,
  at.billing_net_sales,
  SUM(vi.visits) as visits,
  SUM(CASE WHEN ab.reporting_type = 'date_incoming' THEN mc2.cost_date_incoming ELSE mc2.cost_date_invoiced END) AS cost
FROM
(
SELECT
    rt.reporting_type,
    c.date,
    c.year_month,
    c.year_week,
    x.domain,
    y.marketing_channel,
    we.days_in_week,
    we.days_week_passed,
    mo.days_in_month,
    mo.days_month_passed    
FROM dwh.calendar c 
CROSS JOIN (SELECT domain FROM raw.ga_visits WHERE domain != 'ALL' GROUP BY 1) x
CROSS JOIN 
(
  SELECT marketing_channel FROM dwh.marketing_sub_channels GROUP BY 1
) y
CROSS JOIN 
(
  SELECT 'date_incoming' as reporting_type UNION SELECT 'date_invoiced' as reporting_type) rt
LEFT JOIN
(
  SELECT
    year_week,
    COUNT(""date"") AS days_in_week,
    SUM(CASE WHEN ""date"" < CURDATE() THEN 1 ELSE 0 END) AS days_week_passed
  FROM dwh.calendar
  GROUP BY 1
) we ON we.year_week = c.year_week
LEFT JOIN
(
  SELECT
    year_month,
    COUNT(""date"") AS days_in_month,
    SUM(CASE WHEN ""date"" <= TIMESTAMPADD(SQL_TSI_DAY,-1,CURDATE()) THEN 1 ELSE 0 END) AS days_month_passed
  FROM dwh.calendar
  GROUP BY 1
) mo ON mo.year_month = c.year_month
WHERE c.date >= '2013-01-01'
AND last_day_of_week < TIMESTAMPADD(SQL_TSI_DAY,7,CURDATE())
) ab
LEFT JOIN 
(
  SELECT
    reporting_type,
    ""date"",
    domain,
    marketing_channel,
    SUM(incoming_first_orders) as incoming_first_orders,
    SUM(invoiced_first_orders) as invoiced_first_orders,
    SUM(sales_sent) as sales_sent,
    SUM(sales_kept) as sales_kept,
    SUM(billing_net_sales) as billing_net_sales
  FROM bi.marketing_order_attribution_aggregated
  GROUP BY 1,2,3,4
) at ON at.reporting_type = ab.reporting_type AND ab.date = at.date AND ab.domain = at.domain AND ab.marketing_channel = at.marketing_channel 
LEFT JOIN
(
  SELECT 
    date_created,
    domain,
    marketing_channel,
    SUM(visits) as visits
  FROM raw.daily_visits
  GROUP BY 1,2,3
) vi ON vi.date_created = ab.date AND vi.domain = ab.domain AND vi.marketing_channel = ab.marketing_channel
LEFT JOIN
(
  SELECT
    mc.date_created,
    mc.country,
    mc.marketing_channel,
    mc.cost as cost_date_incoming,
    CASE WHEN amc.actual_costs_total is null OR amc.actual_costs_total = 0 THEN null
    ELSE mc.cost/amc.actual_costs_total*cmc.attributed_costs_total END as cost_date_invoiced
  FROM
  ( 
    SELECT
      date_created,
      country,
      marketing_channel,
      SUM(CAST(cost as decimal)) as cost    
    FROM raw.marketing_costs
    WHERE CAST(date_created AS DATE) < CURDATE()
    GROUP BY 1,2,3
  ) mc
  LEFT JOIN
  (
  SELECT 
      date_invoiced as ""date"",
      country,
      SUM(CAST(cost as decimal)*-1) as attributed_costs_total
    FROM bi.company_costs_marketing 
    GROUP BY 1,2
  ) cmc ON mc.date_created = cmc.date AND mc.country = cmc.country
  LEFT JOIN
    (
      SELECT  
        date_created as ""date"",
        country,
        SUM(CAST(cost as decimal)) as actual_costs_total
    FROM raw.marketing_costs
    WHERE CAST(date_created AS DATE) < CURDATE()
    GROUP BY 1,2  
  ) amc ON mc.date_created = amc.date AND mc.country = amc.country
) mc2 ON mc2.date_created = ab.""date"" AND mc2.country = ab.domain AND mc2.marketing_channel = ab.marketing_channel
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16"	READY
458,753	2015-08-07 15:09:41	"1127039069"	true	2015-08-07 15:09:41	sandbox.attributed_marketing_report_final		"CREATE VIEW sandbox.attributed_marketing_report_final
AS

SELECT 
	at.reporting_type,
	at.""date"",
	at.forecast_or_actuals,
	at.domain,
	at.marketing_channel,
	SUM(CASE
		WHEN forecast_or_actuals = 'Actuals' THEN at.incoming_first_orders
		WHEN at.days_week_passed = 0 THEN mo.incoming_first_orders_monthly / at.days_month_passed
		ELSE we.incoming_first_orders_weekly / at.days_week_passed
	END) AS incoming_first_orders,
	SUM(CASE
		WHEN forecast_or_actuals = 'Actuals' THEN at.invoiced_first_orders
		WHEN at.days_week_passed = 0 THEN mo.invoiced_first_orders_monthly / at.days_month_passed
		ELSE we.invoiced_first_orders_weekly / at.days_week_passed
	END) AS invoiced_first_orders,
	SUM(CASE
		WHEN forecast_or_actuals = 'Actuals' THEN at.sales_kept
		WHEN at.days_week_passed = 0 THEN mo.sales_kept_monthly / at.days_month_passed
		ELSE we.sales_kept_weekly / at.days_week_passed
	END) AS sales_kept,
	SUM(CASE
		WHEN forecast_or_actuals = 'Actuals' THEN at.sales_sent
		WHEN at.days_week_passed = 0 THEN mo.sales_sent_monthly / at.days_month_passed
		ELSE we.sales_sent_weekly / at.days_week_passed
	END) AS sales_sent,
	SUM(CASE
		WHEN forecast_or_actuals = 'Actuals' THEN at.billing_net_sales
		WHEN at.days_week_passed = 0 THEN mo.billing_net_sales_monthly / at.days_month_passed
		ELSE we.billing_net_sales_weekly / at.days_week_passed
	END) AS billing_net_sales,
	SUM(CASE
		WHEN forecast_or_actuals = 'Actuals' THEN at.visits
		WHEN at.days_week_passed = 0 THEN mo.visits_monthly / at.days_month_passed
		ELSE we.visits_weekly / at.days_week_passed
	END) AS visits,
	SUM(CASE
		WHEN forecast_or_actuals = 'Actuals' THEN at.cost
		WHEN at.days_week_passed = 0 THEN mo.cost_monthly / at.days_month_passed
		ELSE we.cost_weekly / at.days_week_passed
	END) AS cost
FROM sandbox.attributed_marketing_report at
LEFT JOIN
(
	SELECT
		reporting_type,
		year_week,
		domain,
		marketing_channel,
		SUM(incoming_first_orders) as incoming_first_orders_weekly,
		SUM(invoiced_first_orders) as invoiced_first_orders_weekly,
		SUM(sales_sent) as sales_sent_weekly,
		SUM(sales_kept) as sales_kept_weekly,
		SUM(billing_net_sales) as billing_net_sales_weekly,
		SUM(visits) as visits_weekly,
		SUM(cost) as cost_weekly
	FROM sandbox.attributed_marketing_report
	GROUP BY 1,2,3,4
) we ON we.reporting_type = at.reporting_type AND we.year_week = at.year_week AND we.domain = at.domain AND	we.marketing_channel = at.marketing_channel
LEFT JOIN
(
	SELECT
		reporting_type,
		year_month,
		domain,
		marketing_channel,
		SUM(incoming_first_orders) as incoming_first_orders_monthly,
		SUM(invoiced_first_orders) as invoiced_first_orders_monthly,
		SUM(sales_sent) as sales_sent_monthly,
		SUM(sales_kept) as sales_kept_monthly,
		SUM(billing_net_sales) as billing_net_sales_monthly,
		SUM(visits) as visits_monthly,
		SUM(cost) as cost_monthly
	FROM sandbox.attributed_marketing_report
	GROUP BY 1,2,3,4
) mo ON mo.reporting_type = at.reporting_type AND mo.year_month = at.year_month AND mo.domain = at.domain AND	mo.marketing_channel = at.marketing_channel
GROUP BY 1,2,3,4,5"	READY
491,593	2015-08-10 16:02:16	"1194555464"	true	2015-08-21 16:50:52	tableau.cvr_dashboard_overview		"CREATE VIEW tableau.cvr_dashboard_overview
AS

SELECT 
  CAST(co.date_created as date) as date_created,
  shipping_country as country,
  order_type,
  box_type,
  sales_channel,
  cu.customer_age,
  cu.age_group,
  SUM(CASE WHEN date_incoming is not null THEN 1 ELSE 0 END) as incoming_orders,
  SUM(CASE WHEN date_stylist_picked is not null THEN 1 ELSE 0 END) as stylist_picked_orders,
  SUM(CASE WHEN date_incoming is not null AND date_stylist_picked is null AND  order_state_number = 2048 THEN 1 ELSE 0 END) as canceled_within_second_step,
  SUM(CASE WHEN date_incoming is not null AND date_stylist_picked is null AND  order_sales_stage = 'On hold' THEN 1 ELSE 0 END) as on_hold,
  SUM(CASE WHEN date_incoming is not null AND date_stylist_picked is null AND  ops_check IN ('Not Scored','NS') THEN 1 ELSE 0 END) as ops_check_not_scored,
  SUM(CASE WHEN date_incoming is not null AND preview_type = 'Showroom' THEN 1 ELSE 0 END) as showroom_orders,
  SUM(CASE WHEN date_incoming is not null AND preview_type = 'Topic Box' THEN 1 ELSE 0 END) as topic_box_orders,
  SUM(CASE WHEN date_incoming is not null AND not_reached = 'true' THEN 1 ELSE 0 END) as not_reached,
  SUM(CASE WHEN date_incoming is not null AND wrong_phone_number = 'true' THEN 1 ELSE 0 END) as wrong_phone_number,
  SUM(CASE WHEN date_incoming is not null AND payment_type = 'Pre-pay' THEN 1 ELSE 0 END) as prepay_orders,
  SUM(CASE 
        WHEN date_incoming is not null AND box_type != 'Call Box' AND order_state_number IN(8,12) AND payment_type != 'Pre-pay' THEN 1 
        WHEN date_incoming is not null AND box_type = 'Call Box' AND CAST(date_phone_call_current as date)  >= CURDATE() AND payment_type != 'Pre-pay' THEN 1
        ELSE 0 
      END) as backlog
FROM bi.customer_order co
LEFT JOIN bi.previews pr ON co.preview_id = pr.preview_id
LEFT JOIN bi.customer cu ON cu.customer_id = co.customer_id
GROUP BY 1,2,3,4,5,6,7
ORDER BY 1 desc"	READY
173	2015-04-24 18:18:02	"1319289089"	true	2015-09-15 13:54:45	bi.customer_order_articles		"CREATE VIEW bi.customer_order_articles
AS

SELECT
  coa.order_position_id,
  coa.order_id,
  coa.group_id,
  coa.outfit_id,
  coa.article_id,
  coa.stock_location_id,
  coa.supplier_article_id,
  coa.supplier_order_number,
  coa.track_and_trace_number,
  coa.order_position_count,
  coa.order_article_state,
  coa.order_article_state_number,
  i.brand,
  coa.articles_picked,
  coa.articles_sent,
  coa.articles_kept,
  coa.articles_returned,
  coa.articles_lost,
  
  coa.articles_picked*coa.sales_in_local_currency/e.exchange_rate as sales_picked,
  coa.articles_sent*coa.sales_in_local_currency/e.exchange_rate as sales_sent,
  coa.articles_kept*coa.sales_in_local_currency/e.exchange_rate as sales_kept,
  coa.articles_returned*coa.sales_in_local_currency/e.exchange_rate as sales_returned,
  coa.articles_lost*coa.sales_in_local_currency/e.exchange_rate as sales_lost,

  coa.articles_picked*CASE WHEN opfpp.purchase_price_fixed is not null THEN opfpp.purchase_price_fixed ELSE coa.cost END as cost_picked,
  coa.articles_sent*CASE WHEN opfpp.purchase_price_fixed is not null THEN opfpp.purchase_price_fixed ELSE coa.cost END as cost_sent,
  coa.articles_kept*CASE WHEN opfpp.purchase_price_fixed is not null THEN opfpp.purchase_price_fixed ELSE coa.cost END as cost_kept,
  coa.articles_returned*CASE WHEN opfpp.purchase_price_fixed is not null THEN opfpp.purchase_price_fixed ELSE coa.cost END as cost_returned,
  coa.articles_lost*CASE WHEN opfpp.purchase_price_fixed is not null THEN opfpp.purchase_price_fixed ELSE coa.cost END as cost_lost,

 /*Estimation on Sales*/

  return_probability IS NULL ""estimation_missing"",
  
  COALESCE(CASE 
            WHEN coa.order_article_state_number=512 and revenue_state='Final' then coa.sales_in_local_currency/e.exchange_rate
            WHEN coa.order_article_state_number=2048 THEN 0
            ELSE (coa.sales_in_local_currency/e.exchange_rate)*return_probability
    END,0) as sales_returned_est,
    COALESCE(CASE 
            WHEN coa.order_article_state_number=1024 and revenue_state='Final' then coa.sales_in_local_currency/e.exchange_rate
            WHEN coa.order_article_state_number=2048 THEN 0
            ELSE (coa.sales_in_local_currency/e.exchange_rate)*(1-return_probability)
    END,0) as sales_kept_est,
    /*Own Stock Sales Estimation*/
    COALESCE(CASE 
            WHEN coa.order_article_state_number=512 and coa.stock_location_id=2 and revenue_state='Final' then coa.sales_in_local_currency/e.exchange_rate
            WHEN coa.order_article_state_number=2048 THEN 0
            WHEN coa.order_article_state_number=512 and coa.stock_location_id=2 and revenue_state<>'Final' then (coa.sales_in_local_currency/e.exchange_rate)*return_probability
    END,0) as own_stock_sales_returned_est,
    COALESCE(CASE 
            WHEN coa.order_article_state_number=1024 and coa.stock_location_id=2 and revenue_state='Final' then coa.sales_in_local_currency/e.exchange_rate
            WHEN coa.order_article_state_number=2048 THEN 0
            WHEN coa.order_article_state_number=1024 and coa.stock_location_id=2 and revenue_state<>'Final' then (coa.sales_in_local_currency/e.exchange_rate)*(1-return_probability)
    END,0) as own_stock_sales_kept_est,
    /*Patner Stock Sales Estimation*/
    COALESCE(CASE 
            WHEN coa.order_article_state_number=512 and coa.stock_location_id<>2 and revenue_state='Final' then coa.sales_in_local_currency/e.exchange_rate
            WHEN coa.order_article_state_number=2048 THEN 0
            WHEN coa.order_article_state_number=512 and coa.stock_location_id<>2 and revenue_state<>'Final' then (coa.sales_in_local_currency/e.exchange_rate)*return_probability
    END,0) as partner_stock_sales_returned_est,
    COALESCE(CASE 
            WHEN coa.order_article_state_number=1024 and coa.stock_location_id<>2 and revenue_state='Final' then coa.sales_in_local_currency/e.exchange_rate
            WHEN coa.order_article_state_number=2048 THEN 0
            WHEN coa.order_article_state_number=1024 and coa.stock_location_id<>2 and revenue_state<>'Final' then (coa.sales_in_local_currency/e.exchange_rate)*(1-return_probability)
    END,0) as partner_stock_sales_kept_est,

    COALESCE(CASE 
            WHEN coa.order_article_state_number=512 and revenue_state='Final' THEN coa.cost 
            WHEN coa.order_article_state_number=2048 THEN 0
            ELSE coa.cost*return_probability 
    END,0) as cost_returned_est,
    COALESCE(CASE 
            WHEN coa.order_article_state_number=1024 and revenue_state='Final' THEN coa.cost 
            WHEN coa.order_article_state_number=2048 THEN 0
            ELSE coa.cost*(1-return_probability) 
    END,0) as cost_kept_est,

    /*Cost-Own Stock*/
    COALESCE(CASE 
            WHEN coa.order_article_state_number=512 and coa.stock_location_id=2 and revenue_state='Final' THEN coa.cost 
            WHEN coa.order_article_state_number=2048 THEN 0
            WHEN coa.order_article_state_number=512 and coa.stock_location_id=2 and revenue_state<>'Final' THEN coa.cost*return_probability 
    END,0) as own_stock_cost_returned_est,
    COALESCE(CASE 
            WHEN coa.order_article_state_number=1024 and coa.stock_location_id=2 and revenue_state='Final' THEN coa.cost
            WHEN coa.order_article_state_number=2048 THEN 0
            WHEN coa.order_article_state_number=1024 and coa.stock_location_id=2 and revenue_state<>'Final' THEN coa.cost*(1-return_probability) 
    END,0) as own_stock_cost_kept_est,
    /*Cost-Partner Stock*/
    COALESCE(CASE 
            WHEN coa.order_article_state_number=512 and coa.stock_location_id<>2 and revenue_state='Final' THEN coa.cost 
            WHEN coa.order_article_state_number=2048 THEN 0
            WHEN coa.order_article_state_number=512 and coa.stock_location_id<>2 and revenue_state<>'Final' THEN coa.cost*return_probability 
            END,0) as partner_stock_cost_returned_est,
    COALESCE(CASE 
            WHEN coa.order_article_state_number=1024 and coa.stock_location_id<>2 and revenue_state='Final' THEN coa.cost
            WHEN coa.order_article_state_number=2048 THEN 0
            WHEN coa.order_article_state_number=1024 and coa.stock_location_id<>2 and revenue_state<>'Final' THEN coa.cost*(1-return_probability) 
    END,0) as partner_stock_cost_kept_est,
  
  coa.date_created,
  coa.date_picked,
  coa.date_cancelled,
  coa.date_returned,
  coa.date_shipped,
  coa.date_incoming,
  coa.date_returned_online,
  coa.date_lost, 

  /*Feedback Reasons*/
  coa.feedback_damaged,
  coa.feedback_was_dirty,
  coa.feedback_late_delivery,
  coa.feedback_good_colour,
  coa.feedback_good_quality,
  coa.feedback_good_fit,
  coa.feedback_good_match_to_customers_style,
  coa.feedback_dont_like_style,
  coa.feedback_not_needed,
  coa.feedback_would_like_to_try_something_new,
  coa.feedback_bad_fit,
  coa.feedback_too_big,
  coa.feedback_too_small,
  coa.feedback_too_short,
  coa.feedback_too_long,
  coa.feedback_too_tight,
  coa.feedback_too_wide,
  coa.feedback_too_outrageous,
  coa.feedback_too_simple,
  coa.feedback_too_cheap,
  coa.feedback_too_expensive,
  coa.feedback_too_low_quality,
  coa.feedback_dont_like_the_brand,
  coa.feedback_dont_like_the_pattern,
  coa.feedback_dont_like_the_colour,
  coa.feedback_fraud,
  coa.feedback_comment
FROM raw.customer_order_articles coa
JOIN raw.customer_order co ON co.order_id = coa.order_id
LEFT JOIN bi.item i on i.article_id=coa.article_id
LEFT JOIN dwh.historical_exchange_rates e on e.currency_code = co.currency_code AND cast(co.date_invoiced as date) = e.date
LEFT JOIN dwh.order_position_fixed_purchase_prices opfpp on coa.order_position_id = opfpp.order_position_id
LEFT JOIN raw.return_rate_probability rp on rp.order_position_id=coa.order_position_id
/*This join is used to apply right estimation on order position*/
LEFT JOIN
(
  SELECT 
    co.order_id,
  CASE
    WHEN co.order_state = 'Completed'
        AND co.date_returned is null  
          AND COALESCE(co.billing_received_in_local_currency, arv.billing_received_arvato,0) < 1
          AND co.date_invoiced > TIMESTAMPADD(SQL_TSI_DAY, -70, CURDATE()) 
          THEN 'Estimated' 
      WHEN co.order_state in ('Returned', 'Completed') THEN 'Final'     
      WHEN co.order_state = 'Cancelled' THEN null 
      WHEN co.order_state_number < 512 AND TIMESTAMPDIFF(SQL_TSI_DAY, co.date_invoiced, CURDATE()) > 100 THEN null     
      ELSE 'Estimated'
     END as revenue_state
  FROM raw.customer_order co 
  LEFT JOIN
  ( 
    SELECT
      ordernumber as order_id, 
          MIN(date_created) as date_arvato_paid, 
          SUM(amount) as billing_received_arvato 
        FROM dwh.arvato_payments ap 
        GROUP BY 1
  )arv on arv.order_id = co.order_id
)a on a.order_id=coa.order_id"	READY
753,669	2015-09-11 17:59:21	"1319289193"	true	2015-09-15 15:07:06	raw.customer_oder_issue_final_view		"CREATE view raw.customer_oder_issue_final_view
as
select cast(a.date_created as date) as ""Date_Created"", cast(a.vol as integer) as ""Repeat"", 
		cast(b.vol as integer)as ""follow_on"" , (a.vol+b.vol) as ""Total""
from (	select * from dwh.customer_order_may_aug_repeat
				order by date_created asc) a
left join
			(select * from raw.customer_order_issue_onlyfo 
				order by date_created asc) b
on a.date_created=b.date_created;"	READY
786,435	2015-09-14 11:55:00	"1314113628"	true	2015-09-14 17:54:29	sandbox.crm_nabholz_list		"CREATE view sandbox.crm_nabholz_list
as

SELECT
  a.customer_id,
  a.email,
  a.begruessung,
  a.anrede,
  a.du_sie as firstnamebasis,
  a.first_name as Vorname,
  a.last_name as Nachname,
  a.default_page as ""UTM Country"",
  lower(a.default_page) as ""country inital"",
  b.completed_orders,
  b.articles_kept,
  a.stylist_firstname as ""style-experte firstname"",
  a.stylist_lastname as ""style-experte lastname"",
  a.customer_age,
  cf.spending_budget_for_jackets_from,
  cf.spending_budget_for_jackets_to,
  cf.spending_budget_for_shoes_from,
  cf.spending_budget_for_shoes_to,
  cf.spending_budget_for_shirts_from,
  cf.spending_budget_for_shirts_to,
  cf.spending_budget_for_jeans_from,
  cf.spending_budget_for_jeans_to
FROM
(
  SELECT 
    row_number() over (partition by co.customer_id order by co.date_created desc) AS ""rnum"",
    cu.email,
    CASE WHEN cu.gender = 'Male' THEN 'Herr' ELSE 'Frau' END as anrede,
    case
      when cu.gender= 'Male' THEN 'Lieber'
      when cu.gender= 'Female' THEN 'Liebe'
    end AS ""begruessung"",
    cu.formal as du_sie,
    cu.first_name,
    cu.last_name,
    cu.phone_number,
    cu.customer_age,
    cu.default_domain as default_page,
    cu.customer_id,
    st.first_name as stylist_firstname,
    st.last_name as stylist_lastname,
    cu.token
  FROM bi.customer_order co
  JOIN bi.customer cu on cu.customer_id=co.customer_id and cu.subscribe_status != 'Unsubscribed' AND cu.email not like '%invalid%' and cu.club_member='false'
  LEFT JOIN raw.customer_salesforce cs on cs.customer_id=co.customer_id 
  LEFT JOIN bi.stylist st on st.stylist_id=cu.new_stylist_id
  LEFT JOIN raw.customer_brand_cluster cr on cr.customer_id = co.customer_id
  WHERE
  cu.gender= 'Male'
  and co.shipping_country in ('DE','AT','CH','LU')
  AND co.order_state='Completed'
  AND co.date_given_to_debt_collection IS NULL
)a
JOIN
(
    SELECT 
      customer_id,
      spending_budget_for_jackets_from,
      spending_budget_for_jackets_to,
      spending_budget_for_shoes_from,
      spending_budget_for_shoes_to,
      spending_budget_for_shirts_from,
      spending_budget_for_shirts_to,
      spending_budget_for_jeans_from,
      spending_budget_for_jeans_to
    FROM ""bi.customer""
    WHERE spending_budget_for_jackets_FROM>=200
)cf on cf.customer_id=a.customer_id
LEFT JOIN
(
  SELECT
    customer_id,
    max(date_created) as last_order_date,
    sum(CASE WHEN order_state= 'Completed' THEN  articles_kept ELSE NULL END) articles_kept,
    COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as completed_orders
  FROM bi.customer_order
  group by 1
)b on a.customer_id=b.customer_id
WHERE a.rnum = '1'
and b.articles_kept>=1
and cast(b.last_order_date as date)<=timestampadd(sql_tsi_week,-4,curdate())"	READY
381	2015-04-24 18:24:06	"1194554756"	true	2015-08-21 11:29:50	bi.marketing_contacts		"CREATE VIEW bi.marketing_contacts
AS

/* SELECT * statement necessary for materialization, otherwise error will occur */
SELECT 
	*
FROM
(
	SELECT
		data.order_id,
		dense_rank() OVER (PARTITION BY data.order_id ORDER BY data.contact_timestamp ASC, data.channel_rank ASC, data.campaign_rank ASC) as contact_count_asc,
		dense_rank() OVER (PARTITION BY data.order_id ORDER BY data.contact_timestamp DESC, data.channel_rank DESC, data.campaign_rank DESC) as contact_count_desc,
		data.contact_timestamp,
		data.marketing_channel,
		data.marketing_subchannel,
		data.source,
		data.medium,
		data.marketing_campaign,
		data.term,
		data.contact_type
	FROM 
	(
		SELECT 
			rd.order_id,
			rd.contact_timestamp,
			rd.marketing_channel,
			rd.marketing_sub_channel as marketing_subchannel,
			rd.cluster as source,
			rd.publisher as medium,
			rd.marketing_campaign,
			null as term,
			2 as channel_rank,
			RAND() as campaign_rank,
			'Discounts' as contact_type
			FROM raw.marketing_contacts_discounts rd
		  	WHERE rd.marketing_channel != 'Other voucher'	
	 	UNION ALL
		SELECT 
			rtv.order_id,
			rtv.contact_timestamp,
			rtv.marketing_channel,
			rtv.format as marketing_subchannel,
			rtv.tv_spot_station as source,
			rtv.tv_program as medium,
			rtv.tv_spot_name as campaign,
			null as term,
			1 as channel_rank,
			RAND() as campaign_rank,
			'TV' as contact_type
		FROM raw.marketing_contacts_tv rtv
		UNION ALL 
		SELECT 
			ga2.order_id,
			ga2.contact_timestamp,
			ga2.marketing_channel,
			ga2.marketing_subchannel,
			ga2.source,
			ga2.medium,
			ga2.campaign,
			ga2.term,
			/* Ranks channels in case of 2 visits with exact same timestamp but different channels */
			CASE 
				WHEN marketing_channel = 'Facebook' THEN 3
				WHEN marketing_channel = 'SEM Non-brand' THEN 4
				WHEN marketing_channel = 'Display' THEN 5
				WHEN marketing_channel = 'Referral Program' THEN 6
				WHEN marketing_channel = 'Remarketing' THEN 7
				WHEN marketing_channel = 'Affiliate' THEN 8
				WHEN marketing_channel = 'CRM' THEN 9
				WHEN marketing_channel = 'Social Media' THEN 10
				WHEN marketing_channel = 'SEM Brand' THEN 11
				WHEN marketing_channel = 'SEO' THEN 12
				WHEN marketing_channel = 'Direct' THEN 13
				END as channel_rank,
			RAND() as campaign_rank,
			'Web' as contact_type
		FROM
		(
			SELECT 
				ga.order_id,
				ga.contact_timestamp,
				ga.marketing_channel,
				ga.marketing_subchannel,
				ga.source,
				ga.medium,
				ga.campaign,
				ga.term,
				/* Filters out visits associated with TV contacts (visits throught Direct, SEM brand and SEO that happened within an our before or after a TV contact*/		
				CASE 
					WHEN (tv.order_id is not null AND ga.marketing_channel IN ('Direct', 'SEM Brand', 'SEO') AND TIMESTAMPDIFF(SQL_TSI_MINUTE, ga.contact_timestamp, tv.contact_timestamp) BETWEEN -59 AND 59) THEN 'true'
		 			ELSE 'false' 
		 		END as tv_visit,
		 		/* Filters out all branded contacts once a voucher is present */
		 			CASE 
					WHEN di.order_id is not null AND di.marketing_channel != 'Other voucher' AND ga.marketing_channel IN ('Direct', 'SEM Brand', 'SEO') THEN true
		 			ELSE 'false' 
		 		END as branded_voucher_visit,
		 		/* Filters out a GA contact associated with a voucher if that visit is the same channel as the voucher and took place witin a timeframe of an 90 min. from the order being placed  */
		 			CASE 
					WHEN di.marketing_channel = ga.marketing_channel AND TIMESTAMPDIFF(SQL_TSI_MINUTE, ga.contact_timestamp, di.contact_timestamp) BETWEEN -90 AND 90 THEN 'true'
		 			ELSE 'false' 
		 		END as voucher_same_channel_contact,
		 		/* Filters out any GA brand contact that is made after a paid channel was already present */
		 			CASE
		 			WHEN ga.marketing_channel IN ('Direct', 'SEM Brand', 'SEO') AND ga.contact_timestamp > fo.first_paid_channel THEN 'true'
		 			ELSE 'false'
		 			END as brand_contact_after_paid_contact
		 	FROM raw.marketing_contacts_web ga
			LEFT JOIN raw.marketing_contacts_tv tv ON tv.order_id = ga.order_id
			LEFT JOIN raw.marketing_contacts_discounts di ON di.order_id = ga.order_id
			LEFT JOIN 
			(
				SELECT 
					order_id,
					MIN(contact_timestamp) as first_paid_channel
				FROM ""raw.marketing_contacts_web"" 
				WHERE marketing_channel NOT IN ('Direct', 'SEM Brand', 'SEO')
				GROUP BY 1
			) fo ON fo.order_id = ga.order_id
		) ga2
		WHERE ga2.tv_visit = 'false'
		AND ga2.branded_voucher_visit = 'false'
		AND ga2.voucher_same_channel_contact = 'false'
		AND ga2.brand_contact_after_paid_contact = 'false'
	) data
) ab"	READY
334	2015-04-24 18:20:58	"1112787813"	true	2015-07-30 16:03:30	tableau.mkt_affiliate_order_check		"CREATE VIEW tableau.mkt_affiliate_order_check
AS

SELECT
	cast(co.date_created as date) as ""date_created"",
	co.order_id,
	co.customer_id,
	co.shipping_country,
	co.sales_channel,
	co.order_state,
	co.order_state_number,
	co.order_type,
	CAST(co.date_incoming as date) as date_incoming,
	CAST(co.date_invoiced as date) as date_invoiced,
	co.revenue_state,
	co.sales_sent,
	co.discount_total,
	co.billing_total,
	co.sales_kept,
	co.shipping_city,
	cu.customer_age,
	mo.marketing_channel,
	mo.marketing_channel_excluding_tv,
	dc.discount_code,
	dc.campaign_title
FROM bi.customer_order co
LEFT JOIN bi.customer cu ON co.customer_id = cu.customer_id
LEFT JOIN views.marketing_order mo ON co.order_id = mo.order_id
LEFT JOIN raw.discount_campaigns dc ON co.campaign_id = dc.campaign_id
WHERE co.date_incoming is not null
AND co.date_incoming >= '2014-01-01'"	READY
131,105	2015-05-21 14:53:49	"1112787938"	true	2015-05-21 14:53:49	forecast.customer_info		"CREATE VIEW forecast.customer_info AS
SELECT
	co.customer_id,
	co.date_shipped AS first_order_date_shipped,
	co.box_type AS first_order_box_type,
	co.shipping_country AS country,
	club.first_club_order_date_shipped
FROM ""bi.customer_order"" co
LEFT JOIN
(SELECT
	c.customer_id,
	c.date_shipped AS first_club_order_date_shipped
FROM
(SELECT 
	co2.customer_id,
    co2.date_shipped,
	ROW_NUMBER() OVER ( PARTITION BY co2.customer_id ORDER BY co2.date_shipped ASC) AS rank
 FROM ""bi.customer_order"" AS co2
 WHERE co2.order_type = 'Outfittery Club Order') AS c
WHERE c.rank = 1 ) AS club
	ON club.customer_id = co.customer_id
WHERE co.order_type = 'First Order'
AND co.date_shipped IS NOT NULL
ORDER BY co.customer_id"	READY
307	2015-04-24 18:20:10	"1223918711"	true	2015-08-27 13:58:12	tableau.mkt_campaign_overview		"CREATE VIEW tableau.mkt_campaign_overview
AS
SELECT
	co.order_id,
	co.date_invoiced,
	CASE
		  WHEN co.date_invoiced is not null then 1
          ELSE 0
	END as count_invoiced,
	CAST(co.date_incoming as date) as date_incoming,
	CAST(co.date_created as date) as date_created,
	co.shipping_country,
	co.box_type,
	co.order_type,
	co.payment_type,
	co.order_state,
	co.revenue_state,
	co.articles_sent,
	co.articles_kept,
	co.sales_sent,
	co.sales_kept,
	co.discount_total,
	co.billing_total,
	co.billing_vat,
	co.billing_net_sales,
	CAST(co.date_phone_call_current as date) as date_phone_call_current,
	CAST(co.date_phone_call_original as date) as date_phone_call_original,
	cam.code,
	CASE 
		WHEN co.not_reached = 'true' THEN 1
		ELSE null
	END AS not_reached,
	CASE 
		WHEN CAST(cam.date_end as date) <= CAST(CURRENT_DATE as date) THEN 'Running'
		ELSE 'Finished'
	END as campaign_status,
	cam.date_start,
	cam.date_end,
	cam.campaign_title,
	cam.discount_percentage,
	cam.discount_absolute,
	co.inactive_reasons,
	cu.customer_age,
	cu.phone_number,
	cu.occupation,
	cu.email,
	cu.date_of_birth
FROM ""bi.customer_order"" co
JOIN ""views.campaign"" cam ON co.campaign_id=cam.id
LEFT JOIN bi.customer cu ON cu.customer_id = co.customer_id
WHERE co.is_real_order = 'Real Order'
AND co.date_incoming IS NOT NULL"	READY
361	2015-04-24 18:23:10	"1112787838"	true	2015-07-30 17:58:46	tableau.billing_all_order_paid_open_amount		"CREATE view tableau.billing_all_order_paid_open_amount
AS
SELECT 
	co.id,
	co.customer_id,
	co.date_created,
	co.state,
	co.payment_method,
	co.payment_state,
	co.total_amount_billed_discount,
	co.date_returned,
	co.date_shipped,
	co.date_payed,
	co.invoice_date_created,
	co.invoice_number,
	co.total_amount_payed,
	co.currency_code,
	co.vat_percentage,
	co.total_amount_basket_purchase_gross,
	co.total_amount_basket_retail_gross,
	co.total_amount_billed_purchase_gross,
	co.total_amount_billed_retail_gross,
	co.shipping_city,
	co.shipping_country,
	co.shipping_street,
	co.shipping_street_number,
	co.shipping_zip,
	co.shipping_first_name,
	co.shipping_last_name,
	coalesce(amount,0) as Paid_to_Arvato__c,
	co.total_amount_billed_retail_gross-coalesce(a.open_amount,0) as Open_Ammount_Arvato__c,
	a.date_created as arvato_date_updated,
	bill.credit_card_brand,
	bill.nb_of_credit_card_entries,
	desk.nb_of_desk_cases
FROM views.customer_order co 
/*Arvato Amount*/
LEFT JOIN 
(
	SELECT 
		id,
		ordernumber,date_created,amount,
		sum(amount) over(partition by ordernumber ORDER BY date_created) as open_amount 
	FROM views.arvatopayments 
)a on co.id=a.ordernumber
/*this join gives Nb of Credit Card Entries*/
LEFT JOIN 
(
	SELECT 
		customer_id,
		credit_card_brand,
		count(distinct credit_card_number) as nb_of_credit_card_entries
	FROM views.billing_data  
	GROUP BY 1,2
) bill on bill.customer_id=co.customer_id
/*Desk Cases-All desk cases are assigned on salesforce account level*/
LEFT JOIN
(
	SELECT 
		ExternalCustomerId__c,
		count(*) as nb_of_desk_cases 
	FROM views.deskcom_cases desk
	JOIN views.salesforce_account sacct on desk.Deskcom__Account__c=sacct.Id 
	GROUP BY 1
)desk on desk.ExternalCustomerId__c=co.customer_id"	READY
65,541	2015-05-04 17:59:47	"1112787905"	true	2015-07-30 17:59:45	tableau.treasury_stock_underway		"CREATE view tableau.treasury_stock_underway
AS

SELECT
  cASt(co.date_shipped AS date) AS date_shipped,
  SUM(op.retail_price_euro) AS retail_price_euro,
  COUNT(CASE WHEN op.state>=128 AND op.state<2048 THEN op.id else NULL END) AS shipped_items_incl_returns_all,
  COUNT(CASE WHEN op.stock_locatiON_id=1 AND op.state>=128 AND op.state<2048 THEN op.id else NULL END) AS shipped_items_incl_returns_z,
  COUNT(CASE WHEN op.stock_locatiON_id=2 AND op.state>=128 AND op.state<2048 THEN op.id else NULL END) AS shipped_items_incl_returns_own,
  COUNT(CASE WHEN op.stock_locatiON_id=3 AND op.state>=128 AND op.state<2048 THEN op.id else NULL END) AS shipped_items_incl_returns_z_ch,
  SUM(CASE WHEN op.state>=128 AND op.state<2048 THEN retail_price_euro else 0 END) AS shipped_value_incl_returns_all,
  SUM(CASE WHEN op.stock_locatiON_id=1 AND op.state>=128 AND op.state<2048 THEN retail_price_euro else 0 END) AS shipped_value_incl_returns_z,
  SUM(CASE WHEN op.stock_locatiON_id=2 AND op.state>=128 AND op.state<2048 THEN retail_price_euro else 0 END) AS shipped_value_incl_returns_own,
  SUM(CASE WHEN op.stock_locatiON_id=3 AND op.state>=128 AND op.state<2048 THEN retail_price_euro else 0 END) AS shipped_value_incl_returns_z_ch
FROM views.customer_order co
JOIN views.order_positiON op ON op.order_id=co.id
WHERE cast(co.date_shipped as date)>='2014-01-01'
and co.state<2048
GROUP BY 1"	READY
557,065	2015-08-20 12:14:02	"1194554832"	true	2015-08-21 11:53:50	tableau.mkt_web_campaign_details		"CREATE VIEW tableau.mkt_web_campaign_details
AS

SELECT
	ba.date_incoming,
	ba.domain,
	ba.customer_age,
	ba.box_type,
	ba.marketing_channel,
	ba.marketing_subchannel,
	ba.source,
	ba.medium,
	ba.campaign,
	ba.term,
	ba.incoming_first_orders as incoming_first_orders_unattributed,
	ba.invoiced_first_orders as invoiced_first_orders_unattributed,
	ba.sales_sent as sales_sent_unattributed,
	ba.sales_kept as sales_kept_unattributed, 
	ba.billing_net_sales as billing_net_sales_unattributed,
	bb.incoming_first_orders as incoming_first_orders_attributed,
	bb.invoiced_first_orders as invoiced_first_orders_attributed,
	bb.sales_sent as sales_sent_attributed,
	bb.sales_kept as sales_kept_attributed, 
	bb.billing_net_sales as billing_net_sales_attributed
FROM
(
	SELECT
	  	cast(co.date_incoming as date) as date_incoming,
	  	cu.default_domain as domain,
	  	cu.customer_age,
	  	co.box_type,
	  	ua.marketing_channel,
	    ua.marketing_subchannel,
	    ua.source,
	    ua.medium,
	    ua.campaign,
	    ua.term,
	    COUNT(co.order_id) as incoming_first_orders,
	  	SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 AND co.order_state_number < 2048 AND co.date_stylist_picked is not null THEN 1 ELSE 0 END) as invoiced_first_orders,
	 	SUM(co.sales_sent) as sales_sent,
	  	SUM(co.sales_kept) as sales_kept,
	  	SUM(co.billing_net_sales) as billing_net_sales
	FROM bi.customer_order co
	LEFT JOIN
	(
		SELECT
			order_id,
			contact_timestamp,
			marketing_channel, 
			marketing_subchannel,
			source,
			medium,
			campaign,
			term
		FROM
		(
			SELECT
				order_id,
				contact_timestamp,
				marketing_channel,
				marketing_subchannel,
				source,
				medium,
				campaign,
				term,
				RANK () OVER (PARTITION BY order_id ORDER BY contact_timestamp DESC, channel_rank ASC, campaign_rank ASC ) as contact_count_desc
			FROM
			(
				SELECT 
					order_id,
					contact_timestamp,
					marketing_channel,
					marketing_subchannel,
					source,
					medium,
					campaign,
					term,
					/* Ranks channels in case of 2 visits with exact same timestamp but different channels */
					CASE 
						WHEN marketing_channel = 'Facebook' THEN 3
						WHEN marketing_channel = 'SEM Non-brand' THEN 4
						WHEN marketing_channel = 'Display' THEN 5
						WHEN marketing_channel = 'Referral Program' THEN 6
						WHEN marketing_channel = 'Remarketing' THEN 7
						WHEN marketing_channel = 'Affiliate' THEN 8
						WHEN marketing_channel = 'CRM' THEN 9
						WHEN marketing_channel = 'Social Media' THEN 10
						WHEN marketing_channel = 'SEM Brand' THEN 11
						WHEN marketing_channel = 'SEO' THEN 12
						WHEN marketing_channel = 'Direct' THEN 13
					END as channel_rank,
					RAND() as campaign_rank
				FROM raw.marketing_contacts_web
				) ab
		) bc
		WHERE contact_count_desc = 1
	) ua ON ua.order_id = co.order_id
	LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
	WHERE co.date_incoming is not null
	AND co.is_real_order = 'Real Order'
	AND order_type = 'First Order'
	AND marketing_channel is not null
	GROUP BY 1,2,3,4,5,6,7,8,9,10
) ba
LEFT JOIN
(
	SELECT
  	cast(co.date_incoming as date) as date_incoming,
  	cu.default_domain as domain,
  	cu.customer_age,
  	co.box_type,
  	oa.marketing_channel,
    oa.marketing_subchannel,
    oa.source,
    oa.medium,
    oa.marketing_campaign as campaign,
    oa.term,
  	SUM(oa.contact_weight) as incoming_first_orders,
  	SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 AND co.order_state_number < 2048 AND co.date_stylist_picked is not null THEN oa.contact_weight ELSE 0 END) as invoiced_first_orders,
 	SUM(oa.contact_weight*co.sales_sent) as sales_sent,
  	SUM(oa.contact_weight*co.sales_kept) as sales_kept,
  	SUM(oa.contact_weight*co.billing_net_sales) as billing_net_sales 
FROM bi.customer_order co
LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
WHERE co.date_incoming is not null
AND co.is_real_order = 'Real Order'
AND order_type = 'First Order'
AND contact_type = 'Web'
AND marketing_channel is not null
GROUP BY 1,2,3,4,5,6,7,8,9,10
) bb ON 
	ba.date_incoming = bb.date_incoming AND
	ba.domain=bb.domain AND 
	ba.customer_age = bb.customer_age AND
	ba.box_type=bb.box_type AND
	ba.marketing_channel = bb.marketing_channel AND
	ba.marketing_subchannel = bb.marketing_subchannel AND
	ba.source = bb.source AND
	ba.medium = bb.medium AND
	ba.campaign= bb.campaign"	READY
491,520	2015-08-10 11:27:31	"1141299903"	true	2015-08-10 11:27:31	tableau.mkt_rt_whatsapp_test		"CREATE VIEW tableau.mkt_rt_whatsapp_test
AS

SELECT
	cu.customer_id,
	cu.first_name,
	cu.last_name,
	cu.phone_number,
	st.stylist,
	COUNT(co.order_id) as order_count,
	SUM(billing_total) as billing_total,
	MAX(CAST(date_incoming as date)) as last_order_date,
	TIMESTAMPDIFF(SQL_TSI_DAY,MAX(date_incoming), CURDATE()) as days_since_last_order	
FROM bi.customer cu
LEFT JOIN raw.stylist st ON st.stylist_id = cu.new_stylist_id
LEFT JOIN bi.customer_order co ON cu.customer_id = co.customer_id
WHERE phone_number is not null
AND co.date_paid is not null
AND user_type = 'Real User'
AND is_real_order = 'Real Order'
GROUP BY 1,2,3,4,5
HAVING MAX(date_incoming) >= TIMESTAMPADD(SQL_TSI_MONTH, -6, CURDATE())"	READY
786,438	2015-09-14 18:01:03	"1314113657"	true	2015-09-14 18:01:03	bi.customer_order_fo_rep_view		"create view bi.customer_order_fo_rep_view as
select
	cast(o1.date_created as date) as date_created,
	case when o1.order_type like '%Follow%' then 'Follow-on' else 'Repeat' end as order_type,
	count(*) as cnt
from dwh.customer_order_apr_aug o1                        where o1.order_state != 'Cancelled'
	and cast(o1.date_created as date) between '2015-05-01' and '2015-08-31'
	and o1.order_type != 'First Order'                                 	and exists (
		select 1 from dwh.customer_order_apr_aug o2
		where o2.order_id != o1.order_id                     			and o2.customer_id = o1.customer_id                          			and TIMESTAMPDIFF(SQL_TSI_DAY, o2.date_created, o1.date_created) <= 30                    			and TIMESTAMPDIFF(SQL_TSI_DAY, o2.date_created, o1.date_created) > 0                   			and o2.order_state != 'Cancelled'
	)
group by 1, 2
order by 1, 2;"	READY
393,222	2015-07-28 15:38:09	"1112788013"	true	2015-07-31 10:30:30	tableau.crm_club_customer_overview		"CREATE VIEW tableau.crm_club_customer_overview
AS


SELECT
	da.country,
	COUNT(customer_id) as customer_base,
	SUM(da.club_member) AS club_customer,
	SUM(da.shipped_order) AS customer_with_shipped_order,
	SUM(da.shipped_orders_last_year) AS customer_with_shipped_orders_last_year
FROM
(
	SELECT 
		ab.customer_id,
		ab.shipping_country as country,
		CASE WHEN cu.club_member = 'true' THEN 1 ELSE null END AS club_member,
		CASE WHEN co.shipped_orders = 0 THEN null ELSE 1 END AS shipped_order,
		CASE WHEN co.shipped_orders_last_year = 0 THEN null ELSE 1 END AS shipped_orders_last_year
	FROM
	(
		SELECT	
			customer_id,
			shipping_country,
			dense_rank() OVER (PARTITION BY customer_id ORDER BY date_created DESC) as count_desc
		FROM bi.customer_order
		WHERE is_real_order = 'Real Order'
	) ab
	LEFT JOIN bi.customer cu ON cu.customer_id = ab.customer_id
	LEFT JOIN
	(
		SELECT
			customer_id,
		 	SUM(CASE WHEN date_shipped is not null THEN 1 ELSE 0 END) AS shipped_orders,
		 	SUM(CASE WHEN date_shipped is not null AND CAST(date_shipped as date) >= TIMESTAMPADD(SQL_TSI_DAY,-365,CURDATE()) THEN 1 ELSE 0 END) AS shipped_orders_last_year
		FROM bi.customer_order
		WHERE is_real_order = 'Real Order'
		GROUP BY 1		
	) co ON co.customer_id = ab.customer_id
	WHERE count_desc = 1
) da
WHERE country is not null
AND country != 'GB'
GROUP BY 1"	READY
32,789	2015-04-27 18:59:47	"1367726637"	true	2015-09-25 12:57:47	bi.item		"CREATE VIEW bi.item 
AS

SELECT
	aiv.article_id,
	aiv.supplier_article_id,
	item.item_no,
	item.variant_code,
	item.item_no ||' - '|| item.color AS item_no_color,
	item.parent_no,
	item.ean,
	item.vendor_item_no,
	item.item_description,
	item.item_status_purchase,
	item.item_status_purchase_description,
	item.category_code,	
	item.category,
	item.product_group_code,
	item.product_group,
	item.item_status,
	item.item_status_internal,
	item.countries_blocked,
	item.net_weight,
	item.gross_weight,
	item.unit_of_measure,
	item.country_region_of_origin,
	item.tariff_no,
	item.tariff_no_ch,
	item.color_code,
	item.color,
	item.supplier_color,
	item.size,
	item.size_component_group,
	/* item.material_code,
	item.material, */
	item.season,
	item.brand_code,
	item.brand,
	item.has_picture,
	REPLACE(item.pic1,'\\10.0.0.4\','http://article.apps.outfittery.de/resize/catalog/') AS pic1,
	REPLACE(item.pic2,'\\10.0.0.4\','http://article.apps.outfittery.de/resize/catalog/') AS pic2,
	REPLACE(item.pic3,'\\10.0.0.4\','http://article.apps.outfittery.de/resize/catalog/') AS pic3,
	REPLACE(item.pic4,'\\10.0.0.4\','http://article.apps.outfittery.de/resize/catalog/') AS pic4,
	REPLACE(item.pic5,'\\10.0.0.4\','http://article.apps.outfittery.de/resize/catalog/') AS pic5,
	REPLACE(item.pic6,'\\10.0.0.4\','http://article.apps.outfittery.de/resize/catalog/') AS pic6,
	item.unit_cost,
	item.unit_price_be,
	item.unit_price_ch,
	item.unit_price_de,
	item.unit_price_dk,
	item.unit_price_fi,
	item.unit_price_gb,
	item.unit_price_lu,
	item.unit_price_nl,
	item.unit_price_pl,
	item.unit_price_se,
	CASE 
		WHEN ""brand""='PAUL HUNTER' then 1
		ELSE 0 
	END AS paul_hunter,
	COALESCE(mt.has_material_code,0) AS has_material_code,
	COALESCE(mt.has_quantity,0) AS has_quantity,
	br.pool,
	br.buyer,
	case when a_sample.sample_size is null then 'N'
	     else a_sample.sample_size
	end as sample_size
	
FROM
	raw.nav_item as item
	LEFT JOIN
	raw.ami_article_item_variant AS aiv
		 ON item.item_no 		= aiv.item_no
		AND item.variant_code 	= aiv.variant_code
	LEFT JOIN
	(
		SELECT 
			item_no,
			MAX(CASE WHEN material_code IS NOT NULL THEN 1 ELSE 0 END) has_material_code,
			MAX(CASE WHEN quantity>1 THEN 1 ELSE 0 END) has_quantity
		FROM ""raw.nav_item_materials""
		GROUP BY 1
	)mt on item.item_no=mt.item_no
	LEFT JOIN
	(
		SELECT 
			""name"",
			pool,
			buyer 
		FROM ""dwh.brands"" 
		WHERE pool is not null
		GROUP BY 1,2,3
	) br on br.""name""=item.brand
	LEFT JOIN dwh.article_size_sample a_sample
		on a_sample.category=item.category
		and item.size=a_sample.size
		and a_sample.size_group_code = item.size_component_group"	READY
196,662	2015-06-11 14:15:03	"1253467269"	true	2015-09-02 17:15:55	tableau.mkt_attributed_marketing_report		"CREATE VIEW tableau.mkt_attributed_marketing_report
AS 


WITH agg AS
(
  SELECT
  ab.reporting_type,
  ab.date,
  CASE
    WHEN ab.""date"" < CURDATE() THEN 'Actuals'
    ELSE 'Forecast'
  END AS forecast_or_actuals,
  ab.year_month,
  ab.year_week,
  ab.domain,
  ab.marketing_channel,
  ab.days_in_week,
  ab.days_week_passed,
  ab.days_in_month,
  ab.days_month_passed,   
  at.incoming_first_orders,
  at.invoiced_first_orders,
  at.sales_sent,
  at.sales_kept,
  at.billing_net_sales,
  SUM(vi.visits) as visits,
  SUM(CASE WHEN ab.reporting_type = 'date_incoming' THEN mc2.cost_date_incoming ELSE mc2.cost_date_invoiced END) AS cost
FROM
(
SELECT
    rt.reporting_type,
    c.date,
    c.year_month,
    c.year_week,
    x.domain,
    y.marketing_channel,
    we.days_in_week,
    we.days_week_passed,
    mo.days_in_month,
    mo.days_month_passed    
FROM dwh.calendar c 
CROSS JOIN (SELECT domain FROM raw.ga_visits WHERE domain != 'ALL' GROUP BY 1) x
CROSS JOIN 
(
  SELECT marketing_channel FROM dwh.marketing_sub_channels GROUP BY 1
) y
CROSS JOIN 
(
  SELECT 'date_incoming' as reporting_type UNION SELECT 'date_invoiced' as reporting_type) rt
LEFT JOIN
(
  SELECT
    year_week,
    COUNT(""date"") AS days_in_week,
    SUM(CASE WHEN ""date"" < CURDATE() THEN 1 ELSE 0 END) AS days_week_passed
  FROM dwh.calendar
  GROUP BY 1
) we ON we.year_week = c.year_week
LEFT JOIN
(
  SELECT
    year_month,
    COUNT(""date"") AS days_in_month,
    SUM(CASE WHEN ""date"" < TIMESTAMPADD(SQL_TSI_DAY,-1,CURDATE()) THEN 1 ELSE 0 END) AS days_month_passed
  FROM dwh.calendar
  GROUP BY 1
) mo ON mo.year_month = c.year_month
WHERE c.date >= '2013-01-01'
AND last_day_of_month < TIMESTAMPADD(SQL_TSI_MONTH,1,CURDATE())
) ab
LEFT JOIN 
(
  SELECT
    reporting_type,
    ""date"",
    domain,
    marketing_channel,
    SUM(incoming_first_orders) as incoming_first_orders,
    SUM(invoiced_first_orders) as invoiced_first_orders,
    SUM(sales_sent) as sales_sent,
    SUM(sales_kept) as sales_kept,
    SUM(billing_net_sales) as billing_net_sales
  FROM bi.marketing_order_attribution_aggregated
  GROUP BY 1,2,3,4
) at ON at.reporting_type = ab.reporting_type AND ab.date = at.date AND ab.domain = at.domain AND ab.marketing_channel = at.marketing_channel 
LEFT JOIN
(
  SELECT 
    date_created,
    domain,
    marketing_channel,
    SUM(visits) as visits
  FROM raw.daily_visits
  GROUP BY 1,2,3
) vi ON vi.date_created = ab.date AND vi.domain = ab.domain AND vi.marketing_channel = ab.marketing_channel
LEFT JOIN
(
  SELECT
    mc.date_created,
    mc.country,
    mc.marketing_channel,
    mc.cost as cost_date_incoming,
    CASE WHEN amc.actual_costs_total is null OR amc.actual_costs_total = 0 THEN null
    ELSE mc.cost/amc.actual_costs_total*cmc.attributed_costs_total END as cost_date_invoiced
  FROM
  ( 
    SELECT
      date_created,
      country,
      marketing_channel,
      SUM(CAST(cost as decimal)) as cost    
    FROM raw.marketing_costs
    WHERE CAST(date_created AS DATE) < CURDATE()
    GROUP BY 1,2,3
  ) mc
  LEFT JOIN
  (
  SELECT 
      date_invoiced as ""date"",
      country,
      SUM(CAST(cost as decimal)*-1) as attributed_costs_total
    FROM bi.company_costs_marketing 
    GROUP BY 1,2
  ) cmc ON mc.date_created = cmc.date AND mc.country = cmc.country
  LEFT JOIN
    (
      SELECT  
        date_created as ""date"",
        country,
        SUM(CAST(cost as decimal)) as actual_costs_total
    FROM raw.marketing_costs
    WHERE CAST(date_created AS DATE) < CURDATE()
    GROUP BY 1,2  
  ) amc ON mc.date_created = amc.date AND mc.country = amc.country
) mc2 ON mc2.date_created = ab.""date"" AND mc2.country = ab.domain AND mc2.marketing_channel = ab.marketing_channel
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16
)





SELECT 
  at.reporting_type,
  at.""date"",
  at.forecast_or_actuals,
  CASE 
    WHEN at.year_week > YEAR(TIMESTAMPADD(SQL_TSI_DAY,-2,CURDATE()))||'-'||WEEK(TIMESTAMPADD(SQL_TSI_DAY,-2,CURDATE())) THEN 1
    ELSE 0
  END AS monthly_runrate,  
  at.domain,
  at.marketing_channel,
  SUM(CASE
    WHEN forecast_or_actuals = 'Actuals' THEN at.incoming_first_orders
    WHEN at.days_week_passed = 0 THEN mo.incoming_first_orders_monthly / at.days_month_passed
    ELSE we.incoming_first_orders_weekly / at.days_week_passed
  END) AS incoming_first_orders,
  SUM(CASE
    WHEN forecast_or_actuals = 'Actuals' THEN at.invoiced_first_orders
    WHEN at.days_week_passed = 0 THEN mo.invoiced_first_orders_monthly / at.days_month_passed
    ELSE we.invoiced_first_orders_weekly / at.days_week_passed
  END) AS invoiced_first_orders,
  SUM(CASE
    WHEN forecast_or_actuals = 'Actuals' THEN at.sales_kept
    WHEN at.days_week_passed = 0 THEN mo.sales_kept_monthly / at.days_month_passed
    ELSE we.sales_kept_weekly / at.days_week_passed
  END) AS sales_kept,
  SUM(CASE
    WHEN forecast_or_actuals = 'Actuals' THEN at.sales_sent
    WHEN at.days_week_passed = 0 THEN mo.sales_sent_monthly / at.days_month_passed
    ELSE we.sales_sent_weekly / at.days_week_passed
  END) AS sales_sent,
  SUM(CASE
    WHEN forecast_or_actuals = 'Actuals' THEN at.billing_net_sales
    WHEN at.days_week_passed = 0 THEN mo.billing_net_sales_monthly / at.days_month_passed
    ELSE we.billing_net_sales_weekly / at.days_week_passed
  END) AS billing_net_sales,
  SUM(CASE
    WHEN forecast_or_actuals = 'Actuals' THEN at.visits
    WHEN at.days_week_passed = 0 THEN mo.visits_monthly / at.days_month_passed
    ELSE we.visits_weekly / at.days_week_passed
  END) AS visits,
  SUM(CASE
    WHEN forecast_or_actuals = 'Actuals' THEN at.cost
    WHEN at.days_week_passed = 0 THEN mo.cost_monthly / at.days_month_passed
    ELSE we.cost_weekly / at.days_week_passed
  END) AS cost
FROM agg at
LEFT JOIN
(
  SELECT
    reporting_type,
    year_week,
    domain,
    marketing_channel,
    SUM(incoming_first_orders) as incoming_first_orders_weekly,
    SUM(invoiced_first_orders) as invoiced_first_orders_weekly,
    SUM(sales_sent) as sales_sent_weekly,
    SUM(sales_kept) as sales_kept_weekly,
    SUM(billing_net_sales) as billing_net_sales_weekly,
    SUM(visits) as visits_weekly,
    SUM(cost) as cost_weekly
  FROM agg
  GROUP BY 1,2,3,4
) we ON we.reporting_type = at.reporting_type AND we.year_week = at.year_week AND we.domain = at.domain AND we.marketing_channel = at.marketing_channel
LEFT JOIN
(
  SELECT
    reporting_type,
    year_month,
    domain,
    marketing_channel,
    SUM(incoming_first_orders) as incoming_first_orders_monthly,
    SUM(invoiced_first_orders) as invoiced_first_orders_monthly,
    SUM(sales_sent) as sales_sent_monthly,
    SUM(sales_kept) as sales_kept_monthly,
    SUM(billing_net_sales) as billing_net_sales_monthly,
    SUM(visits) as visits_monthly,
    SUM(cost) as cost_monthly
  FROM agg
  GROUP BY 1,2,3,4
) mo ON mo.reporting_type = at.reporting_type AND mo.year_month = at.year_month AND mo.domain = at.domain AND mo.marketing_channel = at.marketing_channel
GROUP BY 1,2,3,4,5,6"	READY
786,439	2015-09-14 18:01:04	"1324496717"	true	2015-09-16 09:32:41	sandbox.customer_order_date_incoming_check		"CREATE VIEW sandbox.customer_order_date_incoming_check
AS

WITH c_order AS
(
	SELECT 
  		co.order_id, 
	  	co.date_created,
  		CASE
  		/* Orders with sales_channel = 'website' and websiteWithoutDateAndPendingConfirmation are not real orders, hence exclude date_created should be set to null */ 
    		WHEN (co.sales_channel = 'website' AND co.order_state in ('Incoming', 'Cancelled') AND NOT (co.date_preview_created is not null OR cu.phone_number is not   null))
    		OR co.sales_channel = 'websiteWithoutDateAndPendingConfirmation' THEN null
    		WHEN co.sales_channel = 'website' AND co.date_preview_created > co.date_created THEN co.date_preview_created
    		WHEN CAST(co.date_created as date)<'2015-07-21' THEN COALESCE(cod.date_incoming, co.date_created)
    	/*Because of task manager job all old orders in state 4 is changed to 8*/
    		WHEN CAST(co.date_created as date)>='2015-07-21' THEN COALESCE(cod.date_incoming,date_incoming_no_call)
  		END date_incoming,
    	CASE
  		/* Orders with sales_channel = 'website' and websiteWithoutDateAndPendingConfirmation are not real orders, hence exclude date_created should be set to null */ 
    		WHEN (co.sales_channel = 'website' AND co.order_state in ('Incoming', 'Cancelled') AND NOT (co.date_preview_created is not null OR cu.phone_number is not   null))
    		OR co.sales_channel = 'websiteWithoutDateAndPendingConfirmation' THEN null
    		WHEN co.sales_channel = 'website' AND co.date_preview_created > co.date_created THEN co.date_preview_created
    		WHEN CAST(co.date_created as date)<'2015-07-21' THEN COALESCE(cod.date_incoming, co.date_created)
    		/*Because of task manager job all old orders in state 4 is changed to 8*/
    		WHEN CAST(co.date_created as date)>='2015-07-21' THEN co.date_created
  		END date_incoming_old
FROM raw.customer_order co 
LEFT JOIN raw.customer cu on cu.customer_id = co.customer_id 
LEFT JOIN raw.customer_order_details__audit_log cod on cod.order_id = co.order_id 
WHERE CAST(co.date_created as date)>=timestampadd(sql_tsi_month,-4,curdate())
)
SELECT
	ca.""date"",
	a.incoming_orders_new,
	incoming_orders_old
FROM ""dwh.calendar"" ca
JOIN
(
	SELECT
		CAST(date_incoming_old AS DATE) AS date_incoming_old,
		COUNT(DISTINCT order_id) as incoming_orders_old
	FROM c_order
	GROUP BY 1
)b ON ca.""date""=b.date_incoming_old
JOIN
(
	SELECT
		CAST(date_incoming AS DATE) AS date_incoming_new,
		COUNT(DISTINCT order_id) as incoming_orders_new
	FROM c_order
	GROUP BY 1
)a ON ca.""date""=a.date_incoming_new"	READY
196,634	2015-06-02 16:00:05	"1112787949"	true	2015-06-05 18:27:13	sandbox.marketing_attribution_crm		"CREATE view sandbox.marketing_attribution_crm
AS
SELECT  
	at.date_incoming, 
	at.domain, 
	at.reporting_type, 
	at.order_type, 
	at.marketing_channel, 
	SUM(CASE 
		WHEN at.marketing_channel = 'CRM' THEN null 
		WHEN bf.marketing_channel_group = 'Brand' THEN at.incoming_orders_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.incoming_orders_total is null THEN null 
	  	WHEN bf.marketing_channel_group = 'Paid' AND tot.incoming_orders_crm is null THEN at.incoming_orders_adjusted 
	  	WHEN bf.marketing_channel_group = 'Paid' AND tot.incoming_orders_total is null THEN at.incoming_orders_adjusted 
	  	WHEN bf.marketing_channel_group = 'Paid' AND tot.incoming_orders_paid is null OR tot.incoming_orders_paid = 0 THEN at.incoming_orders_adjusted 
	  	ELSE at.incoming_orders_adjusted+((at.incoming_orders_adjusted/tot.incoming_orders_paid)*tot.incoming_orders_crm) END) 
	 as incoming_orders_adjusted,
	 	SUM(CASE 
		WHEN at.marketing_channel = 'CRM' THEN null 
		WHEN bf.marketing_channel_group = 'Brand' THEN at.invoiced_orders_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.invoiced_orders_total is null THEN null 
	  	WHEN bf.marketing_channel_group = 'Paid' AND tot.invoiced_orders_crm is null THEN at.invoiced_orders_adjusted 
	  	WHEN bf.marketing_channel_group = 'Paid' AND tot.invoiced_orders_total is null THEN at.invoiced_orders_adjusted 
	  	WHEN bf.marketing_channel_group = 'Paid' AND tot.invoiced_orders_paid is null OR tot.invoiced_orders_paid = 0 THEN at.invoiced_orders_adjusted 
	  	ELSE at.invoiced_orders_adjusted+((at.invoiced_orders_adjusted/tot.invoiced_orders_paid)*tot.invoiced_orders_crm) END) 
	 as invoiced_orders_adjusted
FROM sandbox.marketing_order_attribution_new at 
LEFT JOIN 
( 
 SELECT  
  ab.date_incoming, 
  ab.domain, 
  ab.order_type, 
  ab.reporting_type, 
  SUM(ab.invoiced_orders_adjusted) as invoiced_orders_total, 
  SUM(CASE WHEN bf.marketing_channel_group = 'CRM' THEN ab.invoiced_orders_adjusted ELSE 0 END) as invoiced_orders_crm,
  SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN ab.invoiced_orders_adjusted ELSE 0 END) as invoiced_orders_paid,  
  SUM(ab.incoming_orders_adjusted) as incoming_orders_total, 
  SUM(CASE WHEN bf.marketing_channel_group = 'CRM' THEN ab.incoming_orders_adjusted ELSE 0 END) as incoming_orders_crm,
  SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN ab.incoming_orders_adjusted ELSE 0 END) as incoming_orders_paid
 FROM sandbox.marketing_order_attribution_new ab 
 LEFT JOIN dwh.marketing_investor_reporting_brand_factors bf ON bf.domain=ab.domain AND bf.marketing_channel=ab.marketing_channel 
 GROUP  BY 1,2,3,4 
) tot ON tot.date_incoming = at.date_incoming AND tot.domain=at.domain AND tot.order_type=at.order_type AND tot.reporting_type = at.reporting_type 
LEFT JOIN dwh.marketing_investor_reporting_brand_factors bf ON bf.domain=at.domain AND bf.marketing_channel=at.marketing_channel 
GROUP BY 1,2,3,4,5"	READY
393,234	2015-07-31 16:43:49	"1112788022"	true	2015-07-31 18:40:36	sandbox.insert_campaign_forecast		"CREATE VIEW sandbox.insert_campaign_forecast
AS

SELECT
	ab.date_created,
	ab.campaign_title,
	vc.date_discount_start,
	vc.promotion_start,
	vc.date_discount_end,
	fd.first_date_incoming,
	vc.promotion_end,
	vc.country,
	vc.campaign_type,
	vc.cluster,
	CASE 
		WHEN date_discount_end <= CURDATE() THEN 'Running'
		ELSE 'Finished'
	END status,
	TIMESTAMPDIFF(SQL_TSI_DAY, vc.promotion_start, ab.date_created) as days_since_promotion_start,
	TIMESTAMPDIFF(SQL_TSI_DAY, vc.date_discount_start, ab.date_created) as days_since_discount_start,
	TIMESTAMPDIFF(SQL_TSI_DAY, fd.first_date_incoming, ab.date_created) as days_since_first_order,
	co.orders_incoming	
FROM
(
	SELECT
	    c.date as date_created,
		x.campaign_title
	FROM dwh.calendar c 
	CROSS JOIN (SELECT campaign_title FROM  raw.marketing_voucher_campaign_details GROUP BY 1) x
	WHERE c.date > '2014'
	AND c.date < CURDATE()	
) ab	
LEFT JOIN 
(
	SELECT
		campaign_title, 
		date_discount_start,
		date_discount_end,
		promotion_start,
		promotion_end,
		country,
		campaign_type,
		cluster		
	FROM  raw.marketing_voucher_campaign_details
) vc ON vc.campaign_title = ab.campaign_title
LEFT JOIN
(
	SELECT
		RTRIM(LTRIM(cam.campaign_title)) as campaign_title,
		CAST(date_incoming as date) as date_incoming,
		SUM(CASE WHEN co.date_incoming is not null then 1 ELSE null END) AS orders_incoming
	FROM bi.customer_order co
	LEFT JOIN raw.discount_campaigns cam ON co.campaign_id = cam.campaign_id
	WHERE co.is_real_order = 'Real Order'
	AND date_incoming is not null
	AND cam.campaign_title is not null
	AND order_type = 'First Order'
	GROUP BY 1,2
) co ON co.campaign_title = ab.campaign_title AND co.date_incoming = ab.date_created
LEFT JOIN
(
	SELECT
		RTRIM(LTRIM(cam.campaign_title)) as campaign_title,
		MIN(CAST(date_incoming as date)) as first_date_incoming
	FROM bi.customer_order co
	LEFT JOIN raw.discount_campaigns cam ON co.campaign_id = cam.campaign_id
	WHERE co.is_real_order = 'Real Order'
	AND date_incoming is not null
	AND cam.campaign_title is not null
	AND order_type = 'First Order'
	GROUP BY 1
) fd ON fd.campaign_title = ab.campaign_title
WHERE ab.date_created >= vc.date_discount_start
AND ab.date_created <= vc.date_discount_end"	READY
786,432	2015-09-14 10:58:14	"1314113718"	true	2015-09-14 18:19:49	sandbox.callcenter_report		"CREATE view sandbox.callcenter_report
AS

SELECT
   cu.customer_id,
   sf.salesforce_account_status,
   cu.first_name,
   cu.last_name,
   cu.email,
   cu.phone_number,
   CAST(cu.date_created as date) as account_creation_date,
   st.stylist,
   st.team,
   lio.shipping_country,
   lio.shipping_street   || ' ' || lio.shipping_street_number || ' ' ||lio.shipping_zip || ' ' || lio.shipping_city as shipping_address,
   sf.date_last_contacted,
   CAST(sf.last_call_reactivation as date) as last_call_reactivation,
   cu.club_member,
   cu.customer_age,
   cu.formal,
   sf.club_member_offer,
   TIMESTAMPDIFF(SQL_TSI_DAY, cu.date_created, CURDATE()) as days_since_account_creation,
   lco.box_type as box_type_of_last_completed_order,
   lco.date_invoiced as date_invoiced_of_last_completed_order,
   TIMESTAMPADD(SQL_TSI_YEAR, +1, lco.date_invoiced) as date_invoiced_of_last_completed_order_plus_one_year,
   lco.articles_kept as articles_kept_of_last_completed_order,
   lco.sales_kept as sales_kept_of_last_completed_order,
   lco.billing_net_sales as billing_net_sales_of_last_completed_order,
   lco.order_type as order_type_of_last_completed_order,
   lco.has_preview as has_preview_of_last_completed_order, 
   lco.ops_check as ops_check_of_last_completed_order,
   lio.payment_type as payment_type_last_incoming_order,
   lio.order_type as order_type_last_incoming_order,
   lio.cancelled as cancelled_last_incoming_order,
   lio.call_date_tomorrow as call_date_tomorrow,
   lio.order_state as orders_state_last_incoming_order,
   bc.completed_orders,
   bc.last_date_incoming,
   bc.last_date_invoiced,
   bc.first_date_incoming,
   bc.last_date_phone_call as last_phone_call,
   bc.highest_kept_gross_basket,
   sf.vip_customer,
   cu.subscribe_status,
   sf.wrong_phone_number,
   cu.subscribed_to_sms,
   cu.subscribed_to_stylist_emails
   
FROM bi.customer cu
LEFT JOIN raw.stylist st ON st.stylist_id = cu.new_stylist_id
LEFT JOIN raw.customer_salesforce sf ON sf.customer_id = cu.customer_id

/* Data related to a customer's last incoming order*/

LEFT JOIN
(
   SELECT
      customer_id,
      billing_total,
      shipping_city,
      shipping_country,
      shipping_street,
      shipping_street_number,
      shipping_zip,
      not_reached,
      order_type_completed,
      payment_type,
      order_type,
      call_date_tomorrow,
      cancelled,
      order_state
   FROM
   (
      SELECT
         customer_id,
         billing_total,
         shipping_city,
         shipping_country,
         shipping_street,
         shipping_street_number,
         not_reached,
         order_type_completed,
         payment_type,
         order_type,
         shipping_zip,
         order_state,
         CASE WHEN CAST(TIMESTAMPADD(SQL_TSI_DAY, 1, CURDATE()) as date) = CAST(date_phone_call_current as date) THEN 'yes' ELSE 'no' END as call_date_tomorrow,
         CASE WHEN date_cancelled is not null THEN 'yes' ELSE 'no' END as cancelled,
         RANK() OVER (PARTITION BY customer_id ORDER BY date_incoming DESC) as order_count
      FROM bi.customer_order
      WHERE date_incoming is not null
      AND is_real_order = 'Real Order'
   ) ab
   WHERE ab.order_count = 1
) lio ON lio.customer_id = cu.customer_id

/* Data related to a customer's last completed order*/

LEFT JOIN
(
   SELECT
      customer_id,
      box_type,
      date_invoiced,
      articles_kept,
      sales_kept,
      billing_net_sales,
      order_type,
      has_preview,
      ops_check
   FROM
   (
      SELECT
         customer_id,
         box_type,
         CAST(date_invoiced as date) as date_invoiced,
         articles_kept,
         sales_kept,
         billing_net_sales,
         order_type,
         CASE WHEN preview_id is not null THEN 'yes' ELSE 'no' END as has_preview,
         RANK() OVER (PARTITION BY customer_id ORDER BY date_incoming DESC) as order_count,
         ops_check
      FROM bi.customer_order
      WHERE order_state = 'Completed'
      AND is_real_order = 'Real Order'
   ) ab
   WHERE ab.order_count = 1
) lco ON lco.customer_id = cu.customer_id

/*  customer order count */

LEFT JOIN
(
   SELECT
      customer_id,
      SUM(CASE WHEN order_state = 'Completed' THEN 1 ELSE 0 END)  as completed_orders,
      CAST(max(date_incoming) as date) as last_date_incoming,
      CAST(min(date_incoming) as date) as first_date_incoming,
      CAST(max(date_invoiced) as date) as last_date_invoiced,
      max(date_phone_call) as last_date_phone_call,
      MAX(sales_kept) as highest_kept_gross_basket
   FROM bi.customer_order
   WHERE is_real_order = 'Real Order'
   GROUP BY 1
) bc ON bc.customer_id = cu.customer_id

/* fixed filters (for all reports) */

WHERE cu.phone_number is not null
AND cu.user_type = 'Real User'
AND (cu.subscribed_to_sms = 1 OR cu.subscribed_to_stylist_emails = 1)"	READY
196,640	2015-06-04 14:18:00	"1112787953"	true	2015-06-08 15:33:39	sandbox.marketing_attribution_referral_brand_effect		"CREATE VIEW sandbox.marketing_attribution_referral_brand_effect
AS
SELECT 
	at.date_incoming, 
	at.domain,
	at.reporting_type, 
	at.order_type, 
	at.marketing_channel,
	SUM(CASE
			WHEN bf.marketing_channel = 'Facebook' OR bf.marketing_channel = 'TV' THEN at.incoming_orders_adjusted * bf.referral_factor * bf.brand_factor
			WHEN bf.marketing_channel_group = 'Paid' THEN at.incoming_orders_adjusted * bf.referral_factor
			WHEN bf.marketing_channel_group = 'Brand' THEN at.incoming_orders_adjusted-((ab.incoming_orders_paid_adjusted-ab.incoming_orders_paid)*(at.incoming_orders_adjusted/ab.incoming_orders_brand)) END) 
	as incoming_orders_adjusted,
		SUM(CASE
			WHEN bf.marketing_channel = 'Facebook' OR bf.marketing_channel = 'TV' THEN at.invoiced_orders_adjusted * bf.referral_factor * bf.brand_factor
			WHEN bf.marketing_channel_group = 'Paid' THEN at.invoiced_orders_adjusted * bf.referral_factor
			WHEN bf.marketing_channel_group = 'Brand' AND (ab.invoiced_orders_brand = 0 OR ab.invoiced_orders_brand is null) THEN null
			WHEN bf.marketing_channel_group = 'Brand' THEN at.invoiced_orders_adjusted-((ab.invoiced_orders_paid_adjusted-ab.invoiced_orders_paid)*(at.invoiced_orders_adjusted/ab.invoiced_orders_brand)) END) 
	as invoiced_orders_adjusted
FROM sandbox.marketing_attribution_crm at
LEFT JOIN dwh.marketing_investor_reporting_brand_factors bf ON bf.domain=at.domain AND bf.marketing_channel=at.marketing_channel
LEFT JOIN
(
	SELECT 
		at.date_incoming, 
		at.domain, 
		at.reporting_type, 
		at.order_type, 
		SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.incoming_orders_adjusted * bf.referral_factor * bf.brand_factor ELSE null END) as incoming_orders_paid_adjusted,
		SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.incoming_orders_adjusted ELSE null END) as incoming_orders_paid,
		SUM(CASE WHEN bf.marketing_channel_group = 'Brand' THEN at.incoming_orders_adjusted ELSE null END) as incoming_orders_brand,
		SUM(at.incoming_orders_adjusted) as incoming_orders_total,
		SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.invoiced_orders_adjusted * bf.referral_factor * bf.brand_factor ELSE null END) as invoiced_orders_paid_adjusted,
		SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN at.invoiced_orders_adjusted ELSE null END) as invoiced_orders_paid,
		SUM(CASE WHEN bf.marketing_channel_group = 'Brand' THEN at.invoiced_orders_adjusted ELSE null END) as invoiced_orders_brand,
		SUM(at.invoiced_orders_adjusted) as invoiced_orders_total		
	FROM sandbox.marketing_attribution_crm at
	LEFT JOIN dwh.marketing_investor_reporting_brand_factors bf ON bf.domain=at.domain AND bf.marketing_channel=at.marketing_channel
	GROUP BY 1,2,3,4
) ab on ab.date_incoming=at.date_incoming AND ab.domain=at.domain AND ab.reporting_type=at.reporting_type AND ab.order_type = at.order_type
GROUP BY 1,2,3,4,5"	READY
196,648	2015-06-09 10:04:39	"1112787954"	true	2015-06-15 16:42:23	tableau.ops_cs_cancels		"CREATE VIEW tableau.ops_cs_cancels AS

WITH cs AS
(
SELECT
	co.date_created,
	co.date_cancelled,
	CASE 
		WHEN cos.customer_support_reason =    'Datenlschung' 					THEN 1
		WHEN cos.customer_support_reason LIKE 'Doch kein Bedarf mehr%' 			THEN 1
		WHEN cos.customer_support_reason LIKE 'Storno irrtmliche Bestellung%' 	THEN 1
	END AS cs_cancel
FROM
	raw.customer_order_salesforce AS cos
	JOIN
	bi.customer_order AS co
		ON cos.order_id = co.order_id
WHERE
	co.date_created >= '2014-01-01'
)

SELECT
	CAST(date_created AS DATE) AS date_created,
	COUNT(*) AS orders,
	SUM(cs_cancel) AS cs_cancels,
	SUM(CASE
			WHEN cs_cancel IS NOT NULL THEN TIMESTAMPDIFF(SQL_TSI_DAY,date_created,date_cancelled)
		END) AS total_days_to_cancel
FROM
	cs
GROUP BY 1


/*
SELECT
	CAST(co.date_created AS DATE) date_created,
	COUNT(*) AS orders,
	SUM(CASE 
			WHEN cos.customer_support_reason =    'Datenlschung' 					THEN 1
			WHEN cos.customer_support_reason LIKE 'Doch kein Bedarf mehr%' 			THEN 1
			WHEN cos.customer_support_reason LIKE 'Storno irrtmliche Bestellung%' 	THEN 1
			ELSE 0
		END) AS cs_cancels
FROM 
	raw.customer_order_salesforce AS cos
	JOIN
	bi.customer_order AS co
		ON cos.order_id = co.order_id
GROUP BY 1
*/"	READY
96	2015-04-24 18:17:49	"1319279037"	true	2015-09-15 09:53:20	raw.customer_order_articles_logistics		"CREATE view raw.customer_order_articles_logistics  
AS 
SELECT 
  ddsoh.orderid as order_id, 
  ddsol.outfittery_article_number AS article_id, 
  ddsoh.shipping_code, 
  ddsoh.sales_order_header_date, 
  ddsol.sales_order_line_date_created, 
  ddsol.sales_order_line_date_cancelled, 
  ddsoir.sales_order_import_result_date, 
  ddsoir.error_date, 
  ddsoir.error_message, 
  ddsosc.date_picklist_created, 
  ddsosc.date_backorder, 
  ddsosc.date_not_on_stock, 
  ddsc.date_created as shipment_confirmation_date, 
  ddsc.transport_company_code AS shipment_confirmation_transport_company_code, 
  ddms.receiver_country_code AS shipping_country, 
  ddms.date_created as shipment_manifest_date, 
  ddms.track_and_trace_number, 
  ddms.return_track_and_trace_number,
  left(ddms.processing_reason, 4000) as shipment_manifest_error, 
  ddr.date_created as return_date 
FROM 
/*---there are often multiple entries in doc_data_sales_order_header, because every time an order is adjusted (by finance or a line item is cancelled because it is out of stock) it is re-submitted. Therefore, always use the min ---*/ 
( 
  SELECT  
    a.orderid, 
    a.shipping_code, 
    min(a.date_created) AS sales_order_header_date 
  FROM postgres.doc_data_sales_order_header a 
  GROUP BY 1,2 
) AS ddsoh  
LEFT JOIN 
/*---quantity = 0 means that the articles is out of stock and will go on backorder. This leads to the item getting cancelled off of the order. Therefore the max date where quantity = 0 is sales_order_line_date_cancelled ---*/ 
( 
  SELECT 
    a.orderid, 
    a.outfittery_article_number, 
    a.line_number, 
    MIN(CASE WHEN a.quantity  = 1 THEN a.date_created END) AS sales_order_line_date_created, 
    CASE WHEN MIN(CASE WHEN a.quantity < 1 THEN a.date_created END) > MIN(CASE WHEN a.quantity = 1 THEN a.date_created END) 
          THEN MIN(CASE WHEN a.quantity < 1 THEN a.date_created END) 
            ELSE NULL END AS sales_order_line_date_cancelled 
    FROM 
    postgres.doc_data_sales_order_line a 
    group by 1,2,3 
) AS ddsol ON ddsoh.orderid = ddsol.orderid  
/*--- if the line item in doc_data_sales_order_import_result has a message, that means it is ""on error"" and requires action from operations. Sometimes a line entry with a message shows up with the  
error message, ""No changes possible in order"", after it has been shipped. These can be ignored.  ---*/ 
LEFT JOIN  
(SELECT  
    a.orderid, 
    a.line_number, 
    MIN(CASE WHEN a.message  = '' THEN a.date_created END) AS sales_order_import_result_date, 
    CASE WHEN MIN(CASE WHEN a.message != '' THEN a.date_created END) < MIN(b.date_created) 
        THEN MIN(CASE WHEN a.message != '' THEN a.date_created END) 
        ELSE NULL END AS error_date, 
    CASE WHEN MIN(CASE WHEN a.message != '' THEN a.date_created END) < MIN(b.date_created) 
        THEN max(a.message) 
        ELSE NULL END AS error_message 
    FROM postgres.doc_data_sales_order_import_result a 
    JOIN postgres.doc_data_shipment_confirmation b on b.orderid = a.orderid and b.line_number = a.line_number 
    GROUP BY 1,2 
) AS ddsoir ON ddsoir.orderid = ddsoh.orderid and ddsoir.line_number = ddsol.line_number  
LEFT JOIN 
  (SELECT  
 a.orderid, 
 a.customer_article_number,  
    MIN(CASE WHEN a.message  = 'PICKLIST CREATED' THEN a.date_created END) AS date_picklist_created, 
 CASE WHEN MIN(CASE WHEN a.message = 'BACKORDER' THEN a.date_created END) < MIN(CASE WHEN a.message  = 'PICKLIST CREATED' THEN a.date_created END)  
  THEN MIN(CASE WHEN a.message = 'BACKORDER' THEN a.date_created END)  
   WHEN MIN(CASE WHEN a.message  = 'PICKLIST CREATED' THEN a.date_created END) is null 
    THEN MIN(CASE WHEN a.message = 'BACKORDER' THEN a.date_created END)  
     ELSE NULL END AS date_backorder, 
 CASE WHEN MIN(CASE WHEN a.message = 'NOT ON STOCK' THEN a.date_created END) < MIN(CASE WHEN a.message  = 'PICKLIST CREATED' THEN a.date_created END)  
  THEN MIN(CASE WHEN a.message = 'NOT ON STOCK' THEN a.date_created END)  
   WHEN MIN(CASE WHEN a.message  = 'PICKLIST CREATED' THEN a.date_created END) is null 
    THEN MIN(CASE WHEN a.message = 'NOT ON STOCK' THEN a.date_created END)  
     ELSE NULL END AS date_not_on_stock 
 FROM postgres.doc_data_sales_order_status_change a  
 GROUP BY 1,2 
      ) ddsosc on ddsosc.orderid = ddsoh.orderid and ddsosc.customer_article_number = ddsol.outfittery_article_number 
/*--- shipment confirmation is the time that all the contents of the order has been collected and it needs to be packed and labeled  ---*/ 
LEFT JOIN postgres.doc_data_shipment_confirmation ddsc on ddsc.orderid = ddsoh.orderid and ddsc.outfittery_article_number = ddsol.outfittery_article_number  
/*--- the shipment manifest is received every night at 22:30 with the previous day's packed orders ---*/ 
LEFT JOIN postgres.doc_data_manifest_shipping ddms on ddms.orderid = ddsoh.orderid and ddms.outfittery_article_number =ddsol.outfittery_article_number 
LEFT JOIN postgres.doc_data_return ddr on ddr.original_orderid = ddsoh.orderid and ddr.outfittery_article_number =ddsol.outfittery_article_number"	READY
226	2015-04-24 18:19:24	"1209197761"	true	2015-08-24 16:54:59	bi.stylist		"CREATE VIEW bi.stylist
AS

SELECT
	stylist_id,
	salesforce_customer_id,
	role,
	enabled,
	callable,
	balancer_enabled,
	real_stylist,
	first_name,
	last_name,
	stylist_original,
	stylist_email,
	stylist,
	team,
	profile_name,
	/*Dsseldorf Stylist list is provided by Sales Controlling team
	DUS-Dsseldorf Stylist, BER-Berlin Stylist*/
	CASE 
		WHEN stylist IN ('Stefanie Eisend','Nici Mai','Daniel Bergmann','Jonas Zimmermann','Tabea Koschmal','Estelle Schuessler','Eve Rosenthal','Eleni Tarso','Desiree Herbst')
		 THEN 'DUS'
		ELSE 'BER'
	END AS stylist_group,
	 CASE  
  		WHEN callable=false OR balancer_enabled=false THEN 'No Call Stylist' 
  		ELSE 'Call Stylist' 
 		END AS call_group, 
	balance_strategy_resolver_string
FROM raw.stylist"	READY
786,442	2015-09-15 13:13:40	"1319289031"	true	2015-09-15 13:13:40	tableau.dv_queries_last_3hours		"CREATE VIEW tableau.dv_queries_last_3hours
AS

SELECT 
	id,
	startTime,
	endTime,
	state,
	issuer
FROM ""SYSADMIN.Queries"" 
WHERE startTime>=timestampadd(sql_tsi_hour,-3,now())"	READY
196,658	2015-06-11 10:54:37	"1283792265"	true	2015-09-08 10:08:38	bi.marketing_order_attribution_aggregated		"CREATE VIEW bi.marketing_order_attribution_aggregated
AS

SELECT
	 'date_incoming' as reporting_type,
	cast(co.date_incoming as date) as ""date"",
	cu.default_domain as domain,
	oa.marketing_channel,
	oa.marketing_subchannel,
	oa.source,
	oa.medium,
	oa.marketing_campaign,
	oa.term,
	SUM(oa.contact_weight) as incoming_first_orders,
	SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 AND co.order_state_number < 2048 AND co.date_stylist_picked is not null THEN oa.contact_weight ELSE 0 END) as invoiced_first_orders,
	SUM(oa.contact_weight*co.sales_sent) as sales_sent,
	SUM(oa.contact_weight*co.sales_kept) as sales_kept,
	SUM(oa.contact_weight*co.billing_net_sales) as billing_net_sales,
	SUM(oa.contact_weight*co.billing_total) as billing_total
FROM bi.customer_order co
LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
WHERE co.date_incoming is not null
AND co.is_real_order = 'Real Order'
AND order_type = 'First Order'
GROUP BY 1,2,3,4,5,6,7,8,9
UNION ALL
SELECT
	'date_invoiced' as reporting_type,
	cast(co.date_invoiced as date) as ""date"",
	cu.default_domain as domain,
	oa.marketing_channel,
	oa.marketing_subchannel,
	oa.source,
	oa.medium,
	oa.marketing_campaign,
	oa.term,
	null as incoming_first_orders,
	SUM(oa.contact_weight) as invoiced_first_orders,
	SUM(oa.contact_weight*co.sales_sent) as sales_sent,
	SUM(oa.contact_weight*co.sales_kept) as sales_kept,
	SUM(oa.contact_weight*co.billing_net_sales) as billing_net_sales,
	SUM(oa.contact_weight*co.billing_total) as billing_total
FROM bi.customer_order co
LEFT JOIN bi.marketing_order_attribution oa ON oa.order_id = co.order_id
LEFT JOIN ""bi.customer"" cu ON cu.customer_id = co.customer_id
WHERE co.date_invoiced is not null
AND co.is_real_order = 'Real Order'
AND order_type = 'First Order'
AND co.order_state_number >= 16
AND co.order_state_number < 2048
GROUP BY 1,2,3,4,5,6,7,8,9"	READY
360,450	2015-07-21 16:03:55	"1112788008"	true	2015-07-21 16:03:55	ml.optimizely1		CREATE VIEW ml.optimizely1 AS
SELECT
*
FROM "tableau.product_optimizely_performance" opti
WHERE optimizely_test_name = 'Optimizely_DE_PICK_CALL_NOCALL_Call_Nocall_Control_Short_Nocall_Funnel_12.06. (3026870441)'
AND order_incoming = '1'	READY
425,989	2015-08-04 10:44:55	"1112788027"	true	2015-08-04 11:31:22	tableau.app_order_details		"CREATE VIEW tableau.app_order_details
AS

SELECT
	co.order_id,
	co.date_incoming,
	co.date_invoiced,
	co.shipping_country,
	co.sales_channel,
	co.sales_sent,
	co.sales_kept,
	co.billing_total,
	CASE
		WHEN at.device is not null THEN at.device
		ELSE 'Unkown'
	END AS device	
FROM
(
	SELECT
		order_id,
		CAST(date_incoming as date) as date_incoming,
		CAST(date_invoiced as date) as date_invoiced,
		shipping_country,
		sales_channel,
		sales_sent,
		sales_kept,
		billing_total	
	FROM bi.customer_order
	WHERE LOWER(sales_channel) like '%app%'
	AND date_incoming is not null
) co
LEFT JOIN
(
/*Device by order id */
SELECT 
	order_id, 
	device
FROM dwh.apptracking
GROUP BY 1,2
) at ON at.order_id = co.order_id"	READY
425,998	2015-08-04 16:33:41	"1112788033"	true	2015-08-04 16:33:41	tableau.it_activity_history		"CREATE VIEW tableau.it_activity_history
AS

SELECT
	ah.execution_id,
	ah.activiti_name,
	ah.activiti_type,
	ah.start_time,
	ah.end_time,
	ah.duration,
	ah.rank as activity_history_rank,
	
	av.customer_id,
	av.order_id,
	av.assignee,
	av.stylist,
	MODIFYTIMEZONE(av.confirm_date,'GMT','GMT-1') as confirm_date,
	MODIFYTIMEZONE(av.reminder_date,'GMT','GMT-1') as reminder_date,
	MODIFYTIMEZONE(av.call_now,'GMT','GMT-1') as call_now,
	MODIFYTIMEZONE(av.call_now_expired_date,'GMT','GMT-1') as call_now_expired_date,
	
	av.email_type,
	av.call_answered,
	av.customer_action,
	av.task_manager_confirmation,
	av.task_manager_type,
	
	/*Activity History*/
	aht.calculate_dates,
	aht.check_out,
	aht.customer_answered_preview_email,
	aht.enable_order_checkout,
	aht.incoming_call,
	aht.not_reach_decision,
	aht.order_processed_message,
	aht.parallel_gateway,
	aht.place_order_and_await_the_call_date,
	aht.place_order,
	aht.place_order_confirmation_event,
	aht.reschedule_work_on_order,
	aht.send_another_preview,
	aht.send_confirme_mail,
	aht.send_preview,
	aht.send_preview_email,
	aht.send_reminder_email,
	aht.send_stylist_calendar_email,
	aht.send_wrongnumber_email,
	aht.which_action,
	aht.which_date,
	aht.work_on_order,
	aht.work_on_preview,
	
	co.order_type,
	co.date_phone_call_current,
	co.order_state_number,
	co.payment_type,
	co.date_created
	
FROM raw.camunda_activiy_history ah
LEFT JOIN raw.camunda_activity_variable av ON av.execution_id=ah.execution_id
LEFT JOIN raw.camunda_history_task aht on aht.execution_id=ah.execution_id
LEFT JOIN bi.customer_order co on co.order_id=av.order_id"	READY
280	2015-04-24 18:19:52	"1112787761"	true	2015-04-24 18:19:52	ml.project_secondstep		"CREATE VIEW ml.project_secondstep AS 
SELECT
co.order_id,
co.customer_id,
co.date_phone_call,
co.date_created AS customer_date_created,
co.billing_total,
CAST((co.date_stylist_picked IS NOT NULL AND co.order_state_number >= 16 AND co.order_state_number != 2048) AS FLOAT) processed,
CAST(so.notReached__c AS INTEGER) AS not_reached,
CAST(so.Telefonnummer_Falsch__c AS INTEGER) phone_number_incorrect,
CAST(so.OpsCheck__c = 'OK' AS INTEGER) AS ""ops_check_ok"",
CEILING(CAST(TIMESTAMPDIFF(SQL_TSI_HOUR, co.date_created, co.date_phone_call) AS FLOAT) / 24.0) AS days_until_phone_call
FROM
bi.customer_order co
LEFT JOIN views.salesforce_opportunity so ON co.order_id = so.ExternalOrderId__c
WHERE co.date_created >= '2014-08-01'
AND co.date_created < '2014-11-01'
AND	co.order_type = 'First Order'
AND co.payment_type != 4
AND co.sales_channel IN ('userbackendWithDate', 'appWithDate', 'websiteWithoutDate', 'websiteWithDate', 'miniAppWithDate')"	READY
281	2015-04-24 18:19:52	"1112787762"	true	2015-04-24 18:19:52	ml.project_compl_op		"CREATE VIEW ml.project_compl_op AS
SELECT
	coa.order_position_id,
	ai.article_id,
    ai.model AS model_id,
    ai.molor,
    ai.brand_amidala,
    ai.c1,
    ai.c2,
    ai.c3,
    cat.flat_category,
    coa.outfit_id,
	CASE WHEN coa.articles_kept > 0 THEN 1
	     WHEN coa.articles_returned > 0 THEN -1
		 ELSE NULL
		 END AS rating,
    coa.articles_kept,
    coa.articles_returned,
    co.order_id,
    co.billing_total,
    co.customer_id,
	co.date_stylist_picked,
	co.date_created,
	co.date_completed,
	co.parent_order_id IS NOT NULL AS has_parent_order,
	op_outfit.outfit_articles,
	customer.spending_budget_for_jeans_from,
	customer.spending_budget_for_jeans_to,
	customer.spending_budget_for_shoes_from,
	customer.spending_budget_for_shoes_to,
	customer.spending_budget_for_shirts_from,
	customer.spending_budget_for_shirts_to,
	customer.spending_budget_for_jackets_from,
	customer.spending_budget_for_jackets_to,
	survey.is_new_survey,
	survey.typical_style__classic,
    survey.typical_style__country,
    survey.typical_style__adventure,
    survey.typical_style__dark_denim,
    survey.typical_style__sporty,
    survey.typical_style__smart_casual,
    survey.typical_style__prints,
    survey.typical_style__excentric,
    survey.age_felt__18_30,
    survey.age_felt__31_35,
    survey.age_felt__36_45,
    survey.age_felt__46_55,
    survey.work_style__suit,
    survey.work_style__smart_casual,
    survey.work_style__casual,
    survey.work_style__relaxed,
    survey.colors_liked__natural,
    survey.colors_liked__denim,
    survey.colors_liked__classic,
    survey.colors_liked__strong,
    survey.typical_shoes__sneakers,
    survey.typical_shoes__boat_shoes,
    survey.typical_shoes__boots,
    survey.typical_shoes__classic_trendy,
    survey.typical_shoes__desert_boots,
    survey.typical_shoes__sneakers_casual,
    survey.typical_shoes__chelsea_boots,
    survey.typical_shoes__classic_business,
    survey.typical_shoes__chucks,
    survey.typical_shoes__sneakers_trendy,
    survey.typical_shoes__timberland_boots,
    survey.would_never_wear__biglogo,
    survey.would_never_wear__checkered,
    survey.would_never_wear__button_down_shirt,
    survey.would_never_wear__pink_shirt,
    survey.would_never_wear__tommy_hilfiger,
    survey.would_never_wear__print_tshirts,
    survey.would_never_wear__polo_shirt,
    survey.brands_liked__scotch_soda,
    survey.brands_liked__levis,
    survey.brands_liked__tiger,
    survey.brands_liked__bugatti,
    survey.brands_liked__gstar,
    survey.brands_liked__gant,
    survey.brands_liked__selected,
    survey.brands_liked__jack_jones,
    survey.brands_liked__strellson,
    survey.brands_liked__tommy,
    survey.brands_liked__ralphlauren,
    survey.brands_liked__marcopolo,
    survey.underwear_style__boxers,
    survey.underwear_style__trunks,
    survey.underwear_style__briefs,
	ml_response.ml_response_id
FROM bi.customer_order_articles AS coa
JOIN bi.customer_order AS co
	ON co.order_id = coa.order_id
JOIN ml.order_position_outfit_articles AS op_outfit
	ON op_outfit.order_position_id = coa.order_position_id
JOIN raw.customer AS customer
	ON customer.customer_id = co.customer_id
JOIN ml.customer_survey AS survey
	ON survey.customer_id = customer.customer_id
LEFT JOIN ml.order_position_ml_response AS ml_response
	ON coa.order_position_id = ml_response.order_position_id
JOIN ml.article_category_new AS cat
    ON coa.article_id = cat.article_id
JOIN ml.article_info AS ai
    ON coa.article_id = ai.article_id"	FAILED
296	2015-04-24 18:20:02	"1112787776"	true	2015-04-24 18:20:02	ml.articles_categories		"CREATE VIEW ml.articles_categories AS
SELECT
a.article_id,
fc.flat_category,
CAST(fc.outfit_slot = 'belt' AS INTEGER) AS ""outfit_slot__belt"",
CAST(fc.outfit_slot = 'headwear' AS INTEGER) AS ""outfit_slot__headwear"",
CAST(fc.outfit_slot = 'jacket' AS INTEGER) AS ""outfit_slot__jacket"",
CAST(fc.outfit_slot = 'neckwear' AS INTEGER) AS ""outfit_slot__neckwear"",
CAST(fc.outfit_slot = 'over_shirt' AS INTEGER) AS ""outfit_slot__over_shirt"",
CAST(fc.outfit_slot = 'shirt' AS INTEGER) AS ""outfit_slot__shirt"",
CAST(fc.outfit_slot = 'shoes' AS INTEGER) AS ""outfit_slot__shoes"",
CAST(fc.outfit_slot = 'socks' AS INTEGER) AS ""outfit_slot__socks"",
CAST(fc.outfit_slot = 'suit' AS INTEGER) AS ""outfit_slot__suit"",
CAST(fc.outfit_slot = 'tie' AS INTEGER) AS ""outfit_slot__tie"",
CAST(fc.outfit_slot = 'trousers' AS INTEGER) AS ""outfit_slot__trousers"",
CAST(fc.outfit_slot = 'underwear' AS INTEGER) AS ""outfit_slot__underwear""
FROM
""bi.article"" a
LEFT JOIN ""ml.amidala_category_flat"" acf ON acf.attribute_id = a.article_attribute_id
LEFT JOIN ""ml.flat_category"" fc ON fc.flat_category = acf.flat_category"	READY
786,440	2015-09-14 18:56:36	"1324497607"	true	2015-09-16 13:55:28	tableau.mkt_crm_whatsapp		"CREATE VIEW tableau.mkt_crm_whatsapp
AS

SELECT
  cu.customer_id,
  b.order_id,
  cu.email,
  CASE WHEN cu.gender = 'Male' THEN 'Herr' ELSE 'Frau' END as anrede,
  case
    when cu.gender= 'Male' THEN 'Lieber'
    when cu.gender= 'Female' THEN 'Liebe'
  end AS ""begruessung"",
  cu.formal as du_sie,
  cu.default_domain as ""UTM Country"",
  lower(cu.default_domain) as ""country inital"",
  cu.first_name,
  cu.last_name,
  cu.phone_number,
  cu.customer_age,
  st.first_name as stylist_firstname,
  st.last_name as stylist_lastname,
  st.team,
  cu.token,
  dt.tag,
  CASE
    WHEN dt.shipment_type like ('%Rcksendung%') OR dt.shipment_type like ('%returned%') then 'return/refusal'
    WHEN (dt.date_1st_attemptfail is not null OR dt.date_1st_attemptfail='' OR dt.date_1st_exception is not null OR dt.date_1st_exception='') and dt.date_delivered_to_customer is null then 'non-delivered after exception/attemptfail'
    WHEN (dt.date_1st_attemptfail is not null OR dt.date_1st_attemptfail='' OR dt.date_1st_exception is not null OR dt.date_1st_exception='') and dt.date_delivered_to_customer is not null then 'delivered after exception/attemptfail'
    WHEN dt.date_1st_attemptfail is null And dt.date_1st_exception is null and dt.date_delivered_to_customer is not null  THEN 'delivered without exceptions/attemptfails'
    ELSE 'non-delivered' 
  END AS delivery_state_with_exceptions,
  CAST(col.date_shipped AS DATE) AS date_shipped,
  CAST(col.date_returned AS DATE) AS date_returned,
  CAST(dt.date_delivered_to_customer AS DATE) AS date_delivered_to_customer,
  CAST(dt.date_transmission_to_carrier AS DATE) AS date_transmission_to_carrier
FROM bi.customer cu
LEFT JOIN raw.customer_salesforce cs on cs.customer_id=cu.customer_id 
LEFT JOIN bi.stylist st on st.stylist_id=cu.new_stylist_id
LEFT JOIN raw.customer_brand_cluster cr on cr.customer_id = cu.customer_id
JOIN
(
  SELECT
  * 
  FROM
  (
    SELECT 
      row_number() over (partition by customer_id order by date_created desc) AS ""rnum"",
      order_id,
    customer_id
  FROM bi.customer_order
  WHERE date_given_to_debt_collection IS NULL
  )a WHERE rnum=1
)b on cu.customer_id=b.customer_id
JOIN
(
    SELECT
      order_id,
      tracking_number,
      MAX(CASE WHEN rank=1 THEN tag END) AS tag,
      MAX(CASE WHEN rank=1 THEN shipment_type END) AS shipment_type,
      MAX(CASE WHEN tag='InfoReceived' THEN updated_at ELSE NULL END) AS date_transmission_to_carrier,
      MIN(CASE WHEN tag='AttemptFail' THEN updated_at ELSE NULL END) AS date_1st_attemptfail,
      MIN(CASE WHEN tag='Exception' THEN updated_at ELSE NULL END) AS date_1st_exception,
      MAX(CASE WHEN tag='Delivered' THEN updated_at ELSE NULL END) AS date_delivered_to_customer
  FROM bi.delivery_tracking
  GROUP BY 1,2
)dt on dt.order_id=b.order_id
JOIN bi.customer_order_logistics col on col.order_id=dt.order_id and col.track_and_trace_number=dt.tracking_number
WHERE
cu.gender= 'Male'
AND cu.subscribe_status != 'Unsubscribed'
AND cu.email not like '%invalid%' 
AND cu.subscribed_to_sms='true'"	READY
62	2015-04-24 18:17:42	"1112787649"	true	2015-04-24 18:17:42	ml.article_brand		"/*
Article -> Brand from Amidala
There is at most one Brand per Article by breaking ties
on favoring the brand with the shorter name.
This makes sense in most cases, since usually one brand
is a ""sub-brand"" of the other, e.g. ""Strellson Sportswear"" and ""Strellson""
*/

CREATE VIEW ml.article_brand AS

/* Brand length lookup table */
WITH brand_att AS
     ( SELECT
           att.id,
           att.name,
           att.last_updated,
           LENGTH(att.name) length
       FROM postgres.attribute att
       WHERE att.property_id = 3409 )
   SELECT
    ab.article_id,
    ab.attribute_id,
    ab.attribute_name
FROM
    ( SELECT
        a.id AS article_id,
        brand_att.id AS attribute_id,
        brand_att.name AS attribute_name,
        brand_att.length AS attribute_name_length,
        ROW_NUMBER() OVER ( PARTITION BY a.id ORDER BY brand_att.length ASC,
                                                       brand_att.last_updated DESC ) AS rank
    FROM
        postgres.article AS a
               JOIN
        postgres.article_attribute AS aa
        ON aa.article_attributes_id = a.id
               JOIN
        brand_att
        ON aa.attribute_id = brand_att.id
    ) as ab
WHERE
ab.rank = 1"	READY
302	2015-04-24 18:20:06	"1112787782"	true	2015-07-30 17:59:25	tableau.finance_financial_overview		"CREATE VIEW tableau.finance_financial_overview
AS
SELECT
	co.order_id,
	co.order_state,
	co.revenue_state,
	co.shipping_country,
	co.order_type,
	co.sales_sent,
	co.sales_kept,
	co.billing_total,
	co.billing_net_sales,
	co.cost_sent,
	co.cost_kept,
	co.date_invoiced,
	CASE 
		WHEN (
				(LEFT(co.date_returned,7) != LEFT(co.date_invoiced,7) AND co.date_returned > co.date_invoiced)
				OR co.date_returned is null
			)
			THEN 'Underway'
			ELSE 'Not'
	END as underway_at_month_end
FROM bi.customer_order co
WHERE co.order_state_number >= 16 
AND co.order_state_number < 2048
AND co.is_real_order = 'Real Order'
AND co.date_invoiced is not null"	READY
786,441	2015-09-15 11:10:44	"1319289434"	true	2015-09-15 16:52:16	tableau.sales_callcenter_report		"CREATE view tableau.sales_callcenter_report
AS

SELECT
   cu.customer_id,
   sf.salesforce_account_status,
   cu.first_name,
   cu.last_name,
   cu.email,
   cu.phone_number,
   CAST(cu.date_created as date) as account_creation_date,
   st.stylist,
   st.team,
   lio.shipping_country,
   lio.shipping_street   || ' ' || lio.shipping_street_number || ' ' ||lio.shipping_zip || ' ' || lio.shipping_city as shipping_address,
   sf.date_last_contacted,
   CAST(sf.last_call_reactivation as date) as last_call_reactivation,
   cu.club_member,
   cu.customer_age,
   cu.formal,
   sf.club_member_offer,
   TIMESTAMPDIFF(SQL_TSI_DAY, cu.date_created, CURDATE()) as days_since_account_creation,
   lco.box_type as box_type_of_last_completed_order,
   lco.date_invoiced as date_invoiced_of_last_completed_order,
   TIMESTAMPADD(SQL_TSI_YEAR, +1, lco.date_invoiced) as date_invoiced_of_last_completed_order_plus_one_year,
   lco.articles_kept as articles_kept_of_last_completed_order,
   lco.sales_kept as sales_kept_of_last_completed_order,
   lco.billing_net_sales as billing_net_sales_of_last_completed_order,
   lco.order_type as order_type_of_last_completed_order,
   lco.has_preview as has_preview_of_last_completed_order, 
   lco.ops_check as ops_check_of_last_completed_order,
   lio.payment_type as payment_type_last_incoming_order,
   lio.order_type as order_type_last_incoming_order,
   lio.cancelled as cancelled_last_incoming_order,
   lio.call_date_tomorrow as call_date_tomorrow,
   lio.order_state as orders_state_last_incoming_order,
   lio.box_type as box_type_last_incoming_order,
   lio.not_reached,
   lio.has_preview as last_incoming_order_incoming_order, 
   bc.completed_orders,
   bc.last_date_incoming,
   bc.last_date_invoiced,
   bc.first_date_incoming,
   bc.last_date_phone_call as last_phone_call,
   bc.highest_kept_gross_basket,
   sf.vip_customer,
   cu.subscribe_status,
   sf.wrong_phone_number,
   cu.subscribed_to_sms,
   cu.subscribed_to_stylist_emails
   
FROM bi.customer cu
LEFT JOIN raw.stylist st ON st.stylist_id = cu.new_stylist_id
LEFT JOIN raw.customer_salesforce sf ON sf.customer_id = cu.customer_id

/* Data related to a customer's last incoming order*/

LEFT JOIN
(
   SELECT
      customer_id,
      billing_total,
      shipping_city,
      shipping_country,
      shipping_street,
      shipping_street_number,
      shipping_zip,
      not_reached,
      order_type_completed,
      payment_type,
      order_type,
      call_date_tomorrow,
      cancelled,
      order_state,
      has_preview,
      box_type
   FROM
   (
      SELECT
         customer_id,
         billing_total,
         shipping_city,
         shipping_country,
         shipping_street,
         shipping_street_number,
         not_reached,
         order_type_completed,
         payment_type,
         order_type,
         shipping_zip,
         order_state,
         box_type,
         CASE WHEN CAST(TIMESTAMPADD(SQL_TSI_DAY, 1, CURDATE()) as date) = CAST(date_phone_call_current as date) THEN 'yes' ELSE 'no' END as call_date_tomorrow,
         CASE WHEN date_cancelled is not null THEN 'yes' ELSE 'no' END as cancelled,
         CASE WHEN preview_id is not null THEN 'yes' ELSE 'no' END as has_preview,
         RANK() OVER (PARTITION BY customer_id ORDER BY date_incoming DESC) as order_count
      FROM bi.customer_order
      WHERE date_incoming is not null
      AND is_real_order = 'Real Order'
   ) ab
   WHERE ab.order_count = 1
) lio ON lio.customer_id = cu.customer_id

/* Data related to a customer's last completed order*/

LEFT JOIN
(
   SELECT
      customer_id,
      box_type,
      date_invoiced,
      articles_kept,
      sales_kept,
      billing_net_sales,
      order_type,
      has_preview,
      ops_check
   FROM
   (
      SELECT
         customer_id,
         box_type,
         CAST(date_invoiced as date) as date_invoiced,
         articles_kept,
         sales_kept,
         billing_net_sales,
         order_type,
         CASE WHEN preview_id is not null THEN 'yes' ELSE 'no' END as has_preview,
         RANK() OVER (PARTITION BY customer_id ORDER BY date_incoming DESC) as order_count,
         ops_check
      FROM bi.customer_order
      WHERE order_state = 'Completed'
      AND is_real_order = 'Real Order'
   ) ab
   WHERE ab.order_count = 1
) lco ON lco.customer_id = cu.customer_id

/*  customer order count */

LEFT JOIN
(
   SELECT
      customer_id,
      SUM(CASE WHEN order_state = 'Completed' THEN 1 ELSE 0 END)  as completed_orders,
      CAST(max(date_incoming) as date) as last_date_incoming,
      CAST(min(date_incoming) as date) as first_date_incoming,
      CAST(max(date_invoiced) as date) as last_date_invoiced,
      max(date_phone_call) as last_date_phone_call,
      MAX(sales_kept) as highest_kept_gross_basket
   FROM bi.customer_order
   WHERE is_real_order = 'Real Order'
   GROUP BY 1
) bc ON bc.customer_id = cu.customer_id

/* fixed filters (for all reports) */

WHERE cu.phone_number is not null
AND cu.user_type = 'Real User'
AND (cu.subscribed_to_sms = 1 OR cu.subscribed_to_stylist_emails = 1)"	READY
394	2015-04-24 18:24:27	"1214090053"	true	2015-08-25 15:24:08	tableau.mkt_crm_reporting		"CREATE VIEW tableau.mkt_crm_reporting
AS

SELECT
  a.customer_id,
  a.email,
  a.begruessung,
  a.anrede,
  a.du_sie as firstnamebasis,
  a.first_name as Vorname,
  a.last_name as Nachname,
  a.customer_age,
  a.default_page as ""UTM Country"",
  lower(a.default_page) as ""country inital"",
  a.default_page,
  a.shipping_country,
  a.subscribe_status,
  b.completed_orders,
  b.articles_kept,
  b.billing_total,
  b.billing_recieved_total,
  a.date_of_birth,
  b.avg_billing_total,
  a.stylist_firstname as ""style-experte firstname"",
  a.stylist_lastname as ""style-experte lastname"",
  a.stylist,
  a.token,
  a.brandcluster,
  a.phone_number,
  a.club_member,
  a.shipping_street,
  a.shipping_street_number,
  a.shipping_zip,
  a.shipping_first_name,
  a.shipping_last_name,
  a.shipping_co,
  a.shipping_city,
  a.subscribed_to_sms,
  a.club_membership_type,
  a.date_first_club_box,
  a.date_last_contacted,
  a.sales_channel as sales_channel_first_order,
  ld.first_order_date,
  ld.last_delivery_date,
  ld.last_order_date,
  case 
  	when cast(ld.last_order_date as date)>=timestampadd(sql_tsi_week,-4,curdate()) then '4 Weeks'
  	when cast(ld.last_order_date as date)>=timestampadd(sql_tsi_week,-6,curdate()) then '6 Weeks' 
  	when cast(ld.last_order_date as date)>=timestampadd(sql_tsi_week,-8,curdate()) then '8 Weeks'
  end as last_order_created,
  is_real_order
FROM
(
  SELECT 
    row_number() over (partition by co.customer_id order by co.date_created desc) AS ""rnum"",
    cu.email,
    CASE WHEN cu.gender = 'Male' THEN 'Herr' ELSE 'Frau' END as anrede,
	case
		when cu.gender= 'Male' THEN 'Lieber'
		when cu.gender= 'Female' THEN 'Liebe'
	end AS ""begruessung"",
	cu.formal as du_sie,
    cu.first_name,
    cu.last_name,
    cu.phone_number,
    co.shipping_country,
    co.shipping_street,
    co.shipping_street_number,
    co.shipping_zip,
    co.shipping_first_name,
    co.shipping_last_name,
    co.shipping_co,
    co.shipping_city,
    co.sales_channel,
    co.is_real_order,
    cu.customer_age,
    cu.default_domain as default_page,
    cu.subscribe_status,
    cu.customer_id,
    cu.subscribed_to_sms,
    cu.date_of_birth,
    st.first_name as stylist_firstname,
    st.last_name as stylist_lastname,
    st.stylist,
    cu.token,
    cu.club_member,
    cu.club_membership_type,
    cu.date_first_club_box,
    cs.date_last_contacted,
    cr.marketing_cluster as brandcluster
  FROM bi.customer_order co
  JOIN bi.customer cu on cu.customer_id=co.customer_id and cu.subscribe_status != 'Unsubscribed' AND cu.email not like '%invalid%'
  LEFT JOIN raw.customer_salesforce cs on cs.customer_id=co.customer_id 
  LEFT JOIN bi.stylist st on st.stylist_id=cu.new_stylist_id
  LEFT JOIN raw.customer_brand_cluster cr on cr.customer_id = co.customer_id
  WHERE
   co.order_state='Completed'
  AND co.date_given_to_debt_collection IS NULL
)a
LEFT JOIN
(
	SELECT 
		customer_id,
		min(date_created) as first_order_date,
		max(date_created) as last_order_date,
		max(date_shipped) as last_delivery_date
  	FROM bi.customer_order
  	GROUP BY 1
)ld on ld.customer_id=a.customer_id
LEFT JOIN
(
  SELECT
    customer_id,
    sum(articles_kept) articles_kept,
    COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as completed_orders,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_total ELSE NULL END) as billing_total,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_total ELSE NULL END) /COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as avg_billing_total,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_received ELSE NULL END) as billing_recieved_total
  FROM bi.customer_order
  WHERE order_state= 'Completed'
  group by 1
)b on a.customer_id=b.customer_id
WHERE a.rnum = '1'"	READY
393,227	2015-07-31 09:41:43	"1093859029"	true	2015-07-31 09:41:43	raw.salesforce_ops_check		"/*This view is used for defining date_incoming in bi.customer_order
This job runs every 6 hours with full refresh*/
CREATE VIEW raw.salesforce_ops_check
AS

SELECT
	ExternalOrderId__c as order_id,
	StageName as salesforce_order_stage,
	OpsCheck__c as ops_check,
	SystemModstamp as last_updated_date
FROM ""salesforce.Opportunity"""	READY
187	2015-04-24 18:18:07	"1112787698"	true	2015-07-23 09:53:19	raw.stylist		"CREATE VIEW raw.stylist
AS
SELECT
	p.id as stylist_id,
	sfu.sf_user_id as salesforce_customer_id,
	CASE 
		WHEN SUBSTRING(sfu.user_role, 0, CASE WHEN LOCATE(' ', sfu.user_role) > 0 THEN LOCATE(' ', sfu.user_role)-1 ELSE LENGTH(sfu.user_role) END) = TRIM(p.first_name) THEN 'Lead'
		WHEN p.id = 1282479 THEN 'Lead'  /* Mandy Brunnecker */
		WHEN TRIM(p.first_name) = 'OUTFITTERY' OR TRIM(p.last_name) = 'OUTFITTERY' OR p.id = 118566682 OR TRIM(p.first_name) = 'Stylingteam' THEN 'Fake'
		ELSE 'Stylist'
	END as role,
	sfu.Username as stylist_email,
	p.enabled,
	p.callable,
	p.balancer_enabled,
	CASE WHEN TRIM(p.first_name) = 'OUTFITTERY' OR TRIM(p.last_name) = 'OUTFITTERY' OR p.id = 118566682 OR TRIM(p.first_name) = 'Stylingteam' THEN false ELSE true END as real_stylist,
	TRIM(p.first_name) as first_name,
	TRIM(p.last_name) as last_name,
	TRIM(p.first_name) || ' ' || TRIM(p.last_name) as stylist_original,
	sfu.Name as stylist,
	sfu.user_role as team,
	sfu.profile_name,
	p.balance_strategy_resolver_string
FROM postgres.principal p
LEFT JOIN views.salesforce_user_info sfu on LEFT(p.salesforce_id,15) = LEFT(sfu.sf_user_id,15)  /* p.salesforce_id is truncated to 15 characters!?! */
WHERE p.class='com.ps.stylelist.Stylelist'
AND p.salesforce_id IS NOT NULL"	READY
292	2015-04-24 18:20:00	"1112787773"	true	2015-04-24 18:20:00	ml.customer_article		"CREATE VIEW ml.customer_article AS
SELECT
	co.customer_id,
	coa.article_id,
	coa.order_article_state AS state
FROM bi.customer_order AS co
JOIN bi.customer_order_articles AS coa
	ON co.order_id = coa.order_id
ORDER BY customer_id ASC"	READY
293	2015-04-24 18:20:01	"1112787774"	true	2015-04-24 18:20:01	ml.article_brand_properties		"CREATE VIEW ml.article_brand_properties AS
SELECT DISTINCT
	a.article_id,
	bp.brand_over_40,
	bp.brand_under_40,
	bp.price_high,
	bp.price_medium,
	bp.price_low
FROM
bi.article AS a
LEFT JOIN ml.flat_brand_bi_brand AS br
	ON br.bi_brand = a.article_brand
LEFT JOIN ml.flat_brand_properties AS bp
	ON bp.flat_brand = br.flat_brand"	READY
355	2015-04-24 18:23:03	"1126921323"	true	2015-08-07 11:01:05	views.financial_data		"CREATE view ""views.financial_data"" 
as
select 
	/*Financial Transaction*/
	fds.order_id,
	fds.customer_id,
	fds.response_code,
	fds.provider_transaction_id,
	fds.valuation,
	fds.date_created as fd_date_created,
	fds.status,
	/*Financial Transaction details*/
	fds.arvato_type as arvatotype,
	fds.arvato_order_limit as arvatoorderlimit,
	fds.arvato_result as arvatoresult,
	fds.arvato_score as arvatoscore,
	/*Customer Order*/
	co.date_created as customer_order_date_created,
	null as customer_order_last_updated,
	co.state as customer_order_state,
	co.payment_method as customer_order_payment_method,
	co.payment_state as customer_order_payment_state,
	co.total_amount_basket_purchase_gross as customer_order_total_amount_basket_purchase_gross,
	co.total_amount_basket_retail_gross as customer_order_total_amount_basket_retail_gross,
	co.total_amount_billed_discount as customer_order_total_amount_billed_discount,
	co.total_amount_billed_purchase_gross as customer_order_total_amount_billed_purchase_gross,
	co.total_amount_billed_retail_gross as customer_order_total_amount_billed_retail_gross,
	co.parent_order_id as customer_order_parent_order_id,
	co.date_billed as customer_order_date_billed,
	co.date_payed as customer_order_date_payed,
	co.date_returned as customer_order_date_returned,
	co.date_shipped as customer_order_date_shipped,
	co.sales_channel as customer_order_sales_channel,
	co.currency_code as customer_order_currency_code,
	co.shipping_city,
	co.shipping_country,
	co.order_type,
	/*Arvato Results*/
	ar.arvatoresult_1,
	ar.arvatoresult_2,
	ar.arvatoresult_3,
	/*Response Code*/
	ar.responseCode_1,
	ar.responseCode_2,
	ar.responseCode_3,
	/*Arvato Order limt*/
	ar.arvatoorderlimit1,
	ar.arvatoorderlimit2,
	ar.arvatoorderlimit3,
	/*Valuation*/
	ar.valuation1,
	ar.valuation2,
	ar.valuation3,
	/*Request Body*/
	ar.requestbody_1,
	ar.requestbody_2,
	ar.requestbody_3,
	/*Provider Transaction Id*/
	ar.provider_transaction_id1,
	ar.provider_transaction_id2,
	ar.provider_transaction_id3,
	ar.avg_arvatoorderlimit,
	ar.max_valuation,
	sinfo.Max_Warenkorbempfehlung_Arvato__c as ""sf_Max_Warenkorbempfehlung_Arvato__c"",
	sinfo.NewCardrecommendation__c as ""sf_NewCardrecommendation__c"",
	sinfo.arvatoStatus__c as ""sf_arvatoStatus__c"",
	sinfo.ArvatoYorN__c as ""sf_ArvatoYorN__c"",
	sty.""Name"" as ""stylist"",
	cast(sinfo.NewCardrecommendation__c-co.total_amount_basket_retail_gross as float) as ""diff_basket_values""
from
(
	select * from 
	(
		SELECT
		f.*,
		row_number() over(partition by order_id order by date_created desc) as rank
		FROM raw.financial_transactions f
	)fd where rank=1
)fds
left JOIN views.customer_order co on co.id=fds.order_id
left join views.arvatoresults ar on ar.order_id=fds.order_id
left join views.salesforce_opportunity sinfo on sinfo.ExternalOrderId__c=fds.order_id
left join views.stylist sty on co.stylelist_id = sty.stylist_id"	READY
589,827	2015-08-27 10:32:39	"1223918420"	true	2015-08-27 11:54:20	tableau.mkt_campaigns_attribution_ratio		"CREATE VIEW tableau.mkt_campaigns_attribution_ratio
AS

SELECT
	od.date_incoming,
	od.domain,
 	od.campaign_title,
 	od.marketing_channel,
 	od.orders_incoming,
 	at.incoming_first_orders as attributed_orders_incoming,
 	od.orders_invoiced,
 	at.invoiced_first_orders as attributed_orders_invoiced,
 	od.articles_sent,
 	od.articles_kept,
 	od.sales_sent,
 	at.sales_sent as attributed_sales_sent,
 	od.sales_kept,
 	at.sales_kept as attributed_sales_kept,
 	od.discount_total,
 	od.billing_total,
 	od.billing_net_sales,
 	at.billing_net_sales as attributed_billing_net_sales	
FROM
(
SELECT
	CAST(co.date_incoming as date) as date_incoming,
	RTRIM(LTRIM(cam.campaign_title)) as campaign_title,
	cu.default_domain as domain,
	ca.marketing_channel,
	SUM(CASE WHEN co.date_incoming is not null then 1 ELSE null END) AS orders_incoming,
	SUM(CASE WHEN co.date_invoiced is not null then 1 ELSE null END) AS orders_invoiced,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.articles_sent else null END) as articles_sent,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.articles_kept else null END) as articles_kept,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.sales_sent else null END) as sales_sent,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.sales_kept else null END) as sales_kept,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.discount_total else null END) as discount_total,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.billing_total else null END) as billing_total,
	SUM(CASE WHEN co.revenue_state = 'Final' THEN co.billing_net_sales else null END) as billing_net_sales
FROM bi.customer_order co
LEFT JOIN raw.discount_campaigns cam ON co.campaign_id = cam.campaign_id
LEFT JOIN bi.customer cu ON cu.customer_id = co.customer_id
LEFT JOIN
(
	SELECT 
		LTRIM(RTRIM(marketing_campaign)) as campaign_title, 
		marketing_channel 
	FROM ""raw.marketing_contacts_discounts""
	WHERE marketing_channel IN ('Inserts', 'Affiliate', 'Cooperations')
	GROUP BY 1,2		
) ca ON ca.campaign_title = RTRIM(LTRIM(cam.campaign_title))	
WHERE co.is_real_order = 'Real Order'
AND cam.campaign_title is not null
AND order_type = 'First Order'
AND ca.campaign_title is not null
GROUP BY 1,2,3,4
) od 
LEFT JOIN
(
SELECT 
	""date"" as date_incoming,
	domain,
	RTRIM(LTRIM(marketing_campaign)) as marketing_campaign,
	SUM(incoming_first_orders) as incoming_first_orders,
	SUM(invoiced_first_orders) as invoiced_first_orders,
	SUM(sales_sent) as sales_sent,
	SUM(sales_kept) as sales_kept,
	SUM(billing_net_sales) as billing_net_sales
FROM bi.marketing_order_attribution_aggregated
WHERE reporting_type = 'date_incoming'
AND marketing_channel IN ('Inserts', 'Affiliate', 'Cooperations')
GROUP BY 1,2,3
) at ON od.date_incoming = at.date_incoming AND at.marketing_campaign = od.campaign_title AND od.domain = at.domain"	READY
327,681	2015-07-13 15:43:52	"1214090266"	true	2015-08-25 16:52:12	tableau.mkt_crm_dropoff_mailing		"CREATE VIEW tableau.mkt_crm_dropoff_mailing
AS

SELECT 
    cu.email,
    cu.date_created,
    CASE WHEN cu.gender = 'Male' THEN 'Herr' ELSE 'Frau' END as anrede,
    cu.formal as firstnamebasis,
	case
		when cu.gender= 'Male' THEN 'Lieber'
		when cu.gender= 'Female' THEN 'Liebe'
	end AS ""begruessung"",
    cu.first_name,
    cu.last_name,
    cu.phone_number,
    cu.customer_age,
    cu.default_domain as ""UTM Country"",
    LOWER(cu.default_domain) as ""country inital"",
    cu.subscribe_status,
    cu.subscribed_to_sms,
    cu.customer_id,
    cu.date_of_birth,
    st.first_name as stylist_firstname,
    st.last_name as stylist_lastname,
    st.stylist,
    cu.token,
    cu.club_member,
    cu.club_membership_type,
    cu.date_first_club_box,
    cs.date_last_contacted,
    cr.marketing_cluster as brandcluster,
    co.orders_created,
    co.last_delivery_date,
    no_call_funnel_dropoffs,
    website_funnel_dropoffs  
FROM bi.customer cu
LEFT JOIN
(
    SELECT
	    customer_id,
	    MAX(date_invoiced) as last_delivery_date,
	    COUNT(order_id) as orders_created,
	    SUM(CASE WHEN sales_channel = 'websiteWithoutDateAndPendingConfirmation' THEN 1 ELSE 0 END) AS no_call_funnel_dropoffs,
	    SUM(CASE WHEN sales_channel = 'website' THEN 1 ELSE 0 END) AS website_funnel_dropoffs,
	    SUM(CASE WHEN date_created is not null THEN 1 ELSE null END) AS invoiced_orders
    FROM bi.customer_order
    WHERE is_real_order='Real Order'
    GROUP BY 1
)co ON co.customer_id = cu.customer_id
LEFT JOIN raw.customer_salesforce cs on cs.customer_id=co.customer_id 
LEFT JOIN bi.stylist st on st.stylist_id=cu.new_stylist_id
LEFT JOIN raw.customer_brand_cluster cr on cr.customer_id = co.customer_id
WHERE cu.subscribe_status != 'Unsubscribed' 
AND cu.email not like '%invalid%'"	READY
589,828	2015-08-27 15:03:54	"1248475867"	true	2015-09-01 11:59:52	sandbox.mkt_attributed_marketing_campaign_report		"CREATE VIEW sandbox.mkt_attributed_marketing_campaign_report
AS

SELECT
   ab.date_incoming,
   ab.domain,
   ab.marketing_channel,
   ab.source,
   ab.medium,
   ab.term,
   at.incoming_first_orders,
   at.invoiced_first_orders,
   at.sales_sent,
   at.sales_kept,
   at.billing_net_sales,
   vi.visits 
FROM
(
   SELECT
      c.date as date_incoming,
      ca.domain,
      ca.marketing_channel,
      CASE 
         WHEN ca.source is null THEN 'Not set'
         ELSE ca.source
      END AS source,
      CASE 
         WHEN ca.medium is null THEN 'Not set'
         ELSE ca.medium
      END AS medium,
      CASE 
         WHEN ca.term is null THEN 'Not set'
         ELSE ca.term
      END AS term
   FROM dwh.calendar c 
   CROSS JOIN 
   (
      SELECT
         domain,
         marketing_channel,
         source,
         medium,
         term            
      FROM
      (   
         SELECT
            domain,
            marketing_channel,
            CASE 
               WHEN source is null THEN 'Not set'
               ELSE source
            END AS source,
            CASE 
               WHEN medium is null THEN 'Not set'
               ELSE medium
            END AS medium,
            CASE 
               WHEN term is null THEN 'Not set'
               ELSE term
            END AS term 
         FROM ""bi.marketing_order_attribution_aggregated""
         GROUP BY 1,2,3,4,5
         UNION
         SELECT
            domain,
            marketing_channel,
            CASE 
               WHEN source is null THEN 'Not set'
               ELSE source
            END AS source,
            CASE 
               WHEN medium is null THEN 'Not set'
               ELSE medium
            END AS medium,
            CASE 
               WHEN term is null THEN 'Not set'
               ELSE term
            END AS term 
         FROM raw.daily_visits
         GROUP BY 1,2,3,4,5
      ) ab
      GROUP BY 1,2,3,4,5
   ) ca
WHERE c.date >= '2014-01-01'
AND c.date < CURDATE()
) ab
LEFT JOIN
(
  SELECT
      ""date"" as date_incoming,
      domain,
      marketing_channel,
      CASE 
        WHEN source is null THEN 'Not set'
        ELSE source
      END AS source,
      CASE 
         WHEN medium is null THEN 'Not set'
        ELSE medium
      END AS medium,
      CASE 
        WHEN term is null THEN 'Not set'
        ELSE term
      END AS term,
      SUM(incoming_first_orders) as incoming_first_orders,
      SUM(invoiced_first_orders) as invoiced_first_orders,
      SUM(sales_sent) as sales_sent,
      SUM(sales_kept) as sales_kept,
      SUM(billing_net_sales) as billing_net_sales
   FROM bi.marketing_order_attribution_aggregated
   WHERE reporting_type = 'date_incoming'
   GROUP BY 1,2,3,4,5,6
) at ON  at.date_incoming = ab.date_incoming AND
         at.domain = ab.domain AND
         at.marketing_channel = ab.marketing_channel AND
         at.source =  ab.source AND
         at.medium = ab.medium AND
         at.term = ab.term
LEFT JOIN
(
   SELECT
      date_created,
      domain,
      marketing_channel,
      source,
      medium,
      term,
      visits
   FROM
   (
   SELECT 
      date_created,
      domain,
      marketing_channel,
      CASE
        WHEN source is null THEN 'Not set'
        ELSE LOWER(source)
      END as source,
      CASE
        WHEN medium is null THEN 'Not set'
        ELSE LOWER(medium)
      END as medium,
      CASE
        WHEN term is null THEN 'Not set'
        ELSE LOWER(term)
      END as term,
      SUM(visits) as visits
   FROM raw.daily_visits
   GROUP BY 1,2,3,4,5,6
   ) vs
) vi ON  vi.date_created = ab.date_incoming AND
         vi.domain = ab.domain AND
         vi.marketing_channel = ab.marketing_channel AND
         vi.source =  ab.source AND
         vi.medium = ab.medium AND
         vi.term = ab.term
WHERE vi.visits is not null OR at.incoming_first_orders is not null"	READY
557,061	2015-08-18 12:57:49	"1214090276"	true	2015-08-25 16:57:57	tableau.mkt_rt_unsubscribe_overview		"CREATE VIEW tableau.mkt_rt_unsubscribe_overview
AS

SELECT
	cu.default_domain as country,
	SUM(CASE WHEN cu.subscribe_status = 'Unsubscribed' THEN 1 ELSE null END) AS unsubscribed_count_total,
	SUM(CASE WHEN cu.subscribe_status = 'Unsubscribed' AND phone_number is not null THEN 1 ELSE null END) AS unsubscribed_with_phone_number,
	SUM(CASE WHEN cu.subscribe_status = 'Subscribed'  THEN 1 ELSE null END) AS subscribed_count_total,
	SUM(CASE WHEN cu.subscribe_status = 'Unsubscribed' AND ab.customer_id_invoiced_order is not null THEN 1 ELSE null END) AS unsubscribed_with_invoiced_order,
	SUM(CASE WHEN cu.subscribe_status = 'Subscribed' AND ab.customer_id_invoiced_order is not null THEN 1 ELSE null END) AS subscribed_with_invoiced_order,
	SUM(CASE WHEN cu.subscribe_status = 'Unsubscribed' AND bc.customer_id_created_order is not null THEN 1 ELSE null END) AS unsubscribed_with_created_order,
	SUM(CASE WHEN cu.subscribe_status = 'Subscribed' AND bc.customer_id_created_order is not null THEN 1 ELSE null END) AS subscribed_with_created_order
FROM bi.customer cu 
LEFT JOIN 
(
	SELECT	
		DISTINCT
		customer_id as customer_id_invoiced_order
	FROM bi.customer_order
	WHERE is_real_order = 'Real Order'
	AND date_invoiced is not null
	GROUP BY 1
) ab ON ab.customer_id_invoiced_order = cu.customer_id
LEFT JOIN 
(
	SELECT	
		DISTINCT
		customer_id as customer_id_created_order
	FROM bi.customer_order
	WHERE is_real_order = 'Real Order'
	AND date_created is not null
	GROUP BY 1
) bc ON bc.customer_id_created_order = cu.customer_id
GROUP BY 1"	READY
589,829	2015-08-28 10:06:31	"1228858798"	true	2015-08-28 10:06:31	sandbox.data_enrichment		"create view sandbox.data_enrichment
as

with c_order as
(
	SELECT
	  rank() OVER(PARTITION BY co.customer_id ORDER BY co.date_created desc) as rank_cust,
	  co.id,
	  co.customer_id,
	  CASE WHEN ship_add.salutation = 1 THEN 'Herr' WHEN ship_add.salutation = 2 then 'Frau' ELSE null END as ship_salutation,
	  INITCAP(ship_add.last_name) as shipping_last_name,
	  INITCAP(ship_add.first_name) as shipping_first_name,
	  INITCAP(ship_add.street) as shipping_street,
	  ship_add.street_number as shipping_street_number,
	      CASE 
	    WHEN ship_add.country='A' THEN 'AT'
	    WHEN ship_add.country='' THEN null
	    ELSE ship_add.country 
	  END as shipping_country,
	  INITCAP(ship_add.city) as shipping_city,
	  ship_add.zip as shipping_zip,
	  ship_add.co as shipping_co,
	  INITCAP(bill_add.last_name) as billing_last_name,
	  INITCAP(bill_add.first_name) as billing_first_name,
	  INITCAP(bill_add.street) as billing_street,
	  bill_add.street_number as billing_street_number,
	    CASE
	    WHEN bill_add.country='A' then 'AT'
	    WHEN bill_add.country='' THEN null
	    ELSE bill_add.country 
	  END as billing_country,
	  INITCAP(bill_add.city) as billing_city,
	  bill_add.zip as billing_zip,
	  bill_add.co as billing_co,
	  p.email
	FROM postgres.customer_order co
	LEFT JOIN postgres.address as ship_add on ship_add.id = co.shipping_address_id
	LEFT JOIN postgres.address as bill_add on bill_add.id = co.billing_address_id
	LEFT JOIN postgres.principal p on p.id=co.customer_id
)
select * from c_order
where rank_cust=1 and customer_id
in
(
  10120508,
13151566,
40147041,
48426436,
48658733,
58121159,
66643213,
72748276,
73596758,
78642078,
79478773,
82027463,
107131214,
122339407,
132125991,
196069981,
196435918,
215700193,
220888447,
235955415,
236948421
)"	READY
753,665	2015-09-10 16:57:45	"1324497547"	true	2015-09-16 13:30:08	tableau.mkt_crm_full_returns		"CREATE VIEW tableau.mkt_crm_full_returns
AS

WITH c_order AS
(
  SELECT 
    rank() OVER(PARTITION BY customer_id ORDER BY date_created desc) as rank_cust,
    order_id,
    customer_id,
    order_state_number,
    order_type,
    kept_state,
    sales_channel,
    case when revenue_state='Final' then sales_kept end as sales_kept,
    case when revenue_state='Final' then articles_kept end as items_kept
  FROM bi.customer_order
  WHERE order_state_number=1024
  AND date_given_to_debt_collection IS NULL
)

SELECT
  c.customer_id,
  cu.email,
  CASE WHEN cu.gender = 'Male' THEN 'Herr' ELSE 'Frau' END as anrede,
  case
  when cu.gender= 'Male' THEN 'Lieber'
  when cu.gender= 'Female' THEN 'Liebe'
  end AS ""begruessung"",
  cu.formal as du_sie,
  cu.first_name,
  cu.last_name,
  cu.phone_number,
  cu.customer_age,
  cu.default_domain as default_page,
  cu.subscribe_status,
  cu.subscribed_to_sms,
  cu.subscribed_to_stylist_emails,
  cu.date_of_birth,
  st.first_name as stylist_firstname,
  st.last_name as stylist_lastname,
  st.stylist,
  cu.token,
  c.order_id,
  c.sales_sent,
  c.articles_sent,
  c.feedback_dont_like_the_colour,
  c.feedback_dont_like_the_brand,
  c.feedback_dont_like_the_pattern,
  c.feedback_too_outrageous,
  c.feedback_too_simple,
  c.feedback_not_needed,
  c.feedback_too_tight,
  c.feedback_too_big,
  c.feedback_too_small,
  c.feedback_too_short,
  c.feedback_too_long,
  c.feedback_too_wide,
  c.feedback_too_expensive,
  c.feedback_too_cheap,
  c.feedback_too_low_quality,
  cd.last_order_date,
  cd.completed_orders,
  cd.avg_billing_total,
  cd.articles_kept
FROM
(
  SELECT
  a.customer_id,
  b.*
  FROM(SELECT * FROM c_order WHERE rank_cust=1)a
  LEFT JOIN 
  (
    SELECT 
      op.order_id,
      SUM(articles_sent) as articles_sent,
      SUM(articles_returned) as articles_returned,
      SUM(sales_sent) as sales_sent,
      SUM(op.feedback_dont_like_the_colour) as feedback_dont_like_the_colour,
      SUM(op.feedback_dont_like_the_brand) as feedback_dont_like_the_brand,
      SUM(op.feedback_dont_like_the_pattern) as feedback_dont_like_the_pattern,
      SUM(op.feedback_too_outrageous) as feedback_too_outrageous,
      SUM(op.feedback_too_simple) as feedback_too_simple,
      SUM(op.feedback_not_needed) as feedback_not_needed,
      SUM(op.feedback_too_tight) as feedback_too_tight,
      SUM(op.feedback_too_big) as feedback_too_big,
      SUM(op.feedback_too_small) as feedback_too_small,
      SUM(op.feedback_too_short) as feedback_too_short,
      SUM(op.feedback_too_long) as feedback_too_long,
      SUM(op.feedback_too_wide) as feedback_too_wide,
      SUM(op.feedback_too_expensive) as feedback_too_expensive,
      SUM(op.feedback_too_cheap) as feedback_too_cheap,
      SUM(op.feedback_too_low_quality) as feedback_too_low_quality
    FROM bi.customer_order_articles op
    GROUP BY 1
  )b ON a.order_id=b.order_id
  WHERE 
  a.sales_channel<>'manual'
  AND a.order_type NOT LIKE '%Follow%'
  AND kept_state='All Returned'
  AND articles_returned is not null
)c
JOIN bi.customer cu on cu.customer_id=c.customer_id  AND cu.email not like '%invalid%' and cu.club_member='false'
LEFT JOIN bi.stylist st on st.stylist_id=cu.new_stylist_id
LEFT JOIN
(
  SELECT
    customer_id,
    MAX(date_created) as last_order_date,
    SUM(DISTINCT CASE WHEN order_state= 'Completed' THEN articles_kept ELSE NULL END) articles_kept,
    COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as completed_orders,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_total ELSE NULL END) /COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as avg_billing_total
  FROM bi.customer_order
  GROUP BY 1
)cd on c.customer_id=cd.customer_id"	READY
425,992	2015-08-04 15:28:26	"1112788045"	true	2015-08-04 17:44:22	tableau.mkt_rt_order_performance		"CREATE VIEW tableau.mkt_rt_order_performance
AS
                                                     
SELECT
	fc.""date"",
	fc.country as country,
	SUM(co.invoiced_orders) as actual_invoiced_retention_orders_total,
	SUM(fc.daily_orders) as forecasted_retention_invoiced_orders,
	SUM(co.actual_invoiced_club_orders) as actual_club_repeat_orders,
	SUM(co.actual_invoiced_repeat_orders_other) as actual_invoiced_repeat_orders_other,
	SUM(actual_invoiced_magazine_orders) as actual_invoiced_magazine_orders,
	SUM(actual_invoiced_app_orders) as 	actual_invoiced_app_orders
FROM
(
	SELECT
		""date"",
		ab.country,
		ab.daily_orders	
	FROM dwh.calendar c
	LEFT JOIN
	(
		SELECT
			go.year_month,
			go.country,
			CAST(go.invoiced_order_forecast as decimal) / ca.month_days as daily_orders
		FROM dwh.retention_marketing_order_goals go
		LEFT JOIN
		(
			SELECT
				year_month,
				COUNT(day_of_month) as month_days
			FROM dwh.calendar
			GROUP BY 1 
		) ca ON go.year_month = ca.year_month
	) ab ON c.year_month = ab.year_month
	WHERE ""date"" >= '2015-01-01'
	AND daily_orders is not null
) fc 
LEFT JOIN
(
	SELECT
		CAST(date_invoiced AS date) AS date_invoiced,
		shipping_country, 
		COUNT(order_id) as invoiced_orders,
		SUM(CASE WHEN order_type = 'Outfittery Club Order' THEN 1 ELSE 0 END) as actual_invoiced_club_orders,
		SUM(CASE WHEN order_type = 'Repeat Order' AND LOWER(sales_channel) not like '%app%' AND (LOWER(campaign_title) not like '%crm-magazin%' AND LOWER(campaign_title) not like '%crm magazin%' AND LOWER(campaign_title) not like '%magazin sommer%' OR campaign_title is null) THEN 1 ELSE 0 END)  as actual_invoiced_repeat_orders_other,
		SUM(CASE WHEN LOWER(sales_channel) like '%app%' THEN 1 ELSE 0 END) as actual_invoiced_app_orders,
		SUM(CASE WHEN LOWER(campaign_title) like '%crm-magazin%' OR LOWER(campaign_title) like '%crm magazin%' OR LOWER(campaign_title) like '%magazin sommer%' THEN 1 ELSE 0 END) as actual_invoiced_magazine_orders
	FROM ""bi.customer_order"" cu
	LEFT JOIN raw.discount_campaigns dc ON dc.campaign_id = cu.campaign_id
	WHERE order_type IN ('Outfittery Club Order', 'Repeat Order')
	AND is_real_order = 'Real Order'
	AND date_invoiced is not null
	AND order_state_number >= 16 
	AND order_state_number < 2048
	GROUP BY 1,2
) co ON fc.""date"" = co.date_invoiced AND fc.country = co.shipping_country
GROUP BY 1,2"	READY
333	2015-04-24 18:20:57	"1248476599"	true	2015-09-01 15:35:52	tableau.mkt_outfittery_club_report		"CREATE VIEW tableau.mkt_outfittery_club_report
AS
SELECT
  ab.date,
  ab.country,
  ab.box_type,
  CASE
    WHEN ab.club_order_quantity = 1 THEN '1st'
    WHEN ab.club_order_quantity = 2 THEN '2nd'
    WHEN ab.club_order_quantity = 3 THEN '3rd'
    WHEN ab.club_order_quantity = 4 THEN '4th'
    WHEN ab.club_order_quantity = 5 THEN '5th'
    WHEN ab.club_order_quantity = 6 THEN '6th'
    WHEN ab.club_order_quantity = 7 THEN '7th'
    WHEN ab.club_order_quantity = 8 THEN '8th'
    WHEN ab.club_order_quantity = 9 THEN '9th'
    WHEN ab.club_order_quantity = 10 THEN '10th'
  END AS club_order_quantity,
  inc.orders_incoming,
  inc.orders_invoiced,
  inc.sales_sent,
  inc.sales_kept,
  inc.billing_net_sales,
  inv.orders_invoiced_actual,
  inv.sales_sent_actual,
  inv.sales_kept_actual,
  inv.billing_net_sales_actual,
  inv.full_returns
FROM
(
  SELECT
    c.date,
    x.country,
    x.box_type,
    z.club_order_quantity
  FROM dwh.calendar c 
  CROSS JOIN (SELECT shipping_country as country, box_type  FROM bi.customer_order WHERE sales_kept > 0 GROUP BY 1,2) x
  CROSS JOIN (SELECT 1 as club_order_quantity UNION 
              SELECT 2 as club_order_quantity UNION 
              SELECT 3 as club_order_quantity UNION
              SELECT 4 as club_order_quantity UNION
              SELECT 5 as club_order_quantity UNION
              SELECT 6 as club_order_quantity UNION
              SELECT 7 as club_order_quantity UNION 
              SELECT 8 as club_order_quantity UNION 
              SELECT 9 as club_order_quantity UNION 
              SELECT 10 as club_order_quantity ) z
  WHERE c.date >= '2014-09'
  AND c.date < CURDATE()
) ab
LEFT JOIN
(
  SELECT 
    cast(co.date_incoming as date) as ""date"",
    co.shipping_country,
    co.box_type,
    rk.club_order_quantity,
    count(co.order_id) as orders_incoming,
    SUM(CASE WHEN co.date_invoiced is not null AND co.order_state_number >= 16 THEN 1 ELSE 0 END) as orders_invoiced,
    SUM(co.sales_sent) as sales_sent,
    SUM(co.sales_kept) as sales_kept,
    SUM(co.billing_net_sales) as billing_net_sales
  FROM bi.customer_order co
  LEFT JOIN
  (
    SELECT 
      order_id,
      RANK() OVER (Partition BY customer_id ORDER BY date_created ASC) as club_order_quantity
    FROM bi.customer_order
    WHERE order_type = 'Outfittery Club Order'
    ORDER BY 1
  ) rk ON rk.order_id = co.order_id
  WHERE co.order_type = 'Outfittery Club Order'
  GROUP BY 1,2,3,4
) inc ON inc.date = ab.date AND inc.shipping_country = ab.country and inc.box_type = ab.box_type AND inc.club_order_quantity = ab.club_order_quantity
LEFT JOIN
(
  SELECT 
    cast(co.date_invoiced as date) as ""date"",
    co.shipping_country,
    co.box_type,
    rk.club_order_quantity,
    count(co.order_id) as orders_invoiced_actual,
    sum(co.sales_sent) as sales_sent_actual,
    SUM(co.sales_kept) as sales_kept_actual,
    SUM(co.billing_net_sales) as billing_net_sales_actual,
    SUM(full_return) as full_returns
  FROM bi.customer_order co
  LEFT JOIN
  (
     SELECT 
      order_id,
      RANK() OVER (Partition BY customer_id ORDER BY date_created ASC) as club_order_quantity,
      CASE
        WHEN sales_kept = 0 THEN 1
        ELSE 0
     END AS full_return   
    FROM bi.customer_order
    WHERE order_type = 'Outfittery Club Order'
    ORDER BY 1
  ) rk ON rk.order_id = co.order_id
  WHERE co.order_type = 'Outfittery Club Order'
  AND co.order_state_number >= 16
  AND co.date_invoiced is not null
  GROUP BY 1,2,3,4
) inv ON inv.date = ab.date AND inv.shipping_country = ab.country and inv.box_type = ab.box_type AND inv.club_order_quantity = ab.club_order_quantity
WHERE inc.orders_incoming is not null"	READY
2	2015-04-24 18:17:09	"1112787620"	true	2015-04-24 18:17:09	views.purchase_order_position_outfittery_stock		"CREATE view views.purchase_order_position_outfittery_stock 
AS 
SELECT 
	op.article_id AS ""op_article_id"",
	x.quantity_good  AS ""op_fulfilled_quantity"",
	SUM(op.initial_quantity) AS ""op_initial_quantity"",
	AVG(op.retail_price) AS ""op_retail_price"",
	AVG(op.purchase_price) AS ""op_purchase_price"",
	SUM(op.quantity) AS ""op_quantity"",
	MIN(op.date_created) AS ""op_min_date_created"",
	MAX(op.date_created) AS ""op_max_date_created"",
	MIN(po.date_created) AS""po_min_date_created"",
	MAX(po.date_created) AS""po_max_date_created"",
	CAST(MIN(min_delivery_date_table.date_first_delivery) AS date) AS ""date_min_first_delivery""
FROM postgres.purchase_order_position op    
INNER JOIN  postgres.purchase_order po ON op.purchase_order_id=po.id    
LEFT JOIN
(
	SELECT 
		CAST(customer_article_number AS biginteger) AS article_id,
		CAST(po_number AS biginteger) AS purchase_order_id,
		MIN(doc_data_stock_mutation.date_created) AS date_first_delivery 
	FROM postgres.doc_data_stock_mutation 
	INNER JOIN postgres.purchase_order ON CAST(purchase_order.id AS STRING) = doc_data_stock_mutation.po_number
	WHERE stock_location_id=2 AND booking_code=1 
	GROUP BY 1,2
)min_delivery_date_table ON min_delivery_date_table.article_id =op.article_id AND op.purchase_order_id = min_delivery_date_table.purchase_order_id
LEFT JOIN
(
	SELECT 
		customer_article_number,
		SUM(CAST(quantity_good AS integer)) AS quantity_good 
	FROM postgres.doc_data_stock_mutation sm 
	WHERE 
	po_number in 
	(
		SELECT 
			CAST(id AS STRING) 
		FROM postgres.purchase_order 
		WHERE stock_location_id=2 
	)
	GROUP BY 1
)x ON x.customer_article_number=op.article_id
WHERE stock_location_id=2
GROUP BY 1,2"	READY
5	2015-04-24 18:17:10	"1112787621"	true	2015-04-24 18:17:10	views.purchase_order		"CREATE view views.purchase_order AS 

SELECT 
	purchase_order.id,
	purchase_order.version,
	purchase_order.date_created,
	purchase_order.date_fulfilled,
	purchase_order.due_date,
	purchase_order.last_updated,
	purchase_order.order_id,
	purchase_order.state,
	purchase_order.supplier_id,
	purchase_order.class,
	purchase_order.flagged_for_resubmission,
	purchase_order.date_canceled,
	purchase_order.date_initialized,
	purchase_order.stock_location_id,
	purchase_order.season,
	purchase_order.order_typ
FROM 
	postgres.purchase_order



/* newer code, but rolling back because of erp
SELECT 
	purchase_order_id AS id,
	CAST(NULL AS LONG) AS version,
	po_date_created AS date_created,
	po_date_fulfilled AS date_fulfilled,
	po_date_due AS due_date,
	po_date_updated AS last_updated,
	order_id,
	po_state_number AS state,
	supplier_id,
	po_class AS class,
	po_flagged_for_resubmission AS flagged_for_resubmission,
	po_date_cancelled AS date_canceled,
	po_date_initialized AS date_initialized,
	stock_location_id,
	CAST(
	CASE
		WHEN po_season ='1-SS' 		THEN 'FS'
		WHEN po_season ='2-FW' 		THEN 'HW'
		WHEN po_season ='2014-1-SS' THEN 'FS14'
		WHEN po_season ='2015-1-SS' THEN 'FS15'
		WHEN po_season ='2016-1-SS' THEN 'FS16'
		WHEN po_season ='2017-1-SS' THEN 'FS17'
		WHEN po_season ='2018-1-SS' THEN 'FS18'
		WHEN po_season ='2019-1-SS' THEN 'FS19'
		WHEN po_season ='2020-1-SS' THEN 'FS20'
		WHEN po_season ='2014-2-FW' THEN 'HW14'
		WHEN po_season ='2015-2-FW' THEN 'HW15'
		WHEN po_season ='2016-2-FW' THEN 'HW16'
		WHEN po_season ='2017-2-FW' THEN 'HW17'
		WHEN po_season ='2018-2-FW' THEN 'HW18'
		WHEN po_season ='2019-2-FW' THEN 'HW19'
		WHEN po_season ='2020-2-FW' THEN 'HW20'
		WHEN po_season IS NULL THEN NULL
		ELSE 'Ask BI'
	END 
	AS STRING(50)) AS season,
	CAST(
	CASE
		WHEN po_order_type  = 'special reduced price order'		THEN 'Sonderposten'
		WHEN po_order_type  = 'early order for later season' 	THEN 'Vororder'
		WHEN po_order_type  = 'reorder' 						THEN 'Nachorder'
		WHEN po_order_type  = 'order delivered instantly' 		THEN 'Sofortorder'
		WHEN po_order_type  = 'optional order held at supplier' THEN 'Blockorder'
		WHEN po_order_type  IS NULL THEN NULL
		ELSE 'Ask BI'
	END
	AS STRING(50)) AS order_typ
FROM 
	bi.purchase_order
*/"	READY
589,824	2015-08-25 12:11:34	"1248476866"	true	2015-09-01 16:44:59	sandbox.sales_ccc_request		"CREATE view sandbox.sales_ccc_request
as

with c_order as
(
	SELECT 
 		rank() OVER(PARTITION BY customer_id ORDER BY date_created desc) as rank_cust,
 		order_id,
 		order_type,
		customer_id,
		date_created,
		kept_state,
		payment_type,
		date_invoiced,
		shipping_city,
		shipping_country, 
		shipping_street, 
		shipping_street_number, 
		shipping_zip, 
		shipping_first_name, 
		shipping_last_name, 
		shipping_co, 
		given_to_debt_collection,
		case when revenue_state='Final' then sales_kept end as sales_kept,
		case when revenue_state='Final' then articles_kept end as items_kept
	from bi.customer_order
	where shipping_country ='CH'
)
SELECT
	cu.customer_id,
	cu.first_name||' '||cu.last_name as customer_name,
	cu.phone_number,
	st.stylist,
	st.team,
	c.date_invoiced_last_box,
	c.items_kept_last_box,
	c.sales_kept_last_box,
	ad.shipping_first_name, 
	ad.shipping_last_name, 
	ad.shipping_street, 
	ad.shipping_street_number, 
	ad.shipping_co,
	ad.shipping_zip,
	ad.shipping_city,
	ad.shipping_country
FROM raw.customer cu
LEFT JOIN bi.customer cu_1 on cu_1.customer_id=cu.customer_id
LEFT JOIN bi.stylist st on st.stylist_id=cu.stylist_id
JOIN
(
	SELECT 
		DISTINCT customer_id
	FROM c_order
	WHERE sales_kept>=100
)a on a.customer_id=cu.customer_id
/*customer had 2 full returns within the last 12 months at the most*/
JOIN
(
	SELECT 
		customer_id,
		kept_state,
		COUNT(*) as full_return_boxes
	FROM c_order
	WHERE kept_state='All Returned'
	AND CAST(date_created AS DATE)>=TIMESTAMPADD(SQL_TSI_MONTH,-10,CURDATE())
	GROUP BY 1,2
	HAVING COUNT(*)<=2
)b on a.customer_id=b.customer_id
JOIN
(
	SELECT 
		customer_id,
		max(case when rank_cust=1 then items_kept end) as items_kept_last_box,
		max(case when rank_cust=1 then sales_kept end) as sales_kept_last_box,
		max(case when rank_cust=1 then date_invoiced end) as date_invoiced_last_box,
		sum(sales_kept) as sales_kept,
		max(date_created) as date_created,
		max(given_to_debt_collection) as given_to_debt_collection,
		max(case when rank_cust=1 then payment_type end) as last_payment_type
	FROM c_order 
	GROUP BY 1
)c on c.customer_id=a.customer_id AND c.given_to_debt_collection<>true
left join
(
	select
		customer_id,
		shipping_city,
		shipping_country, 
		shipping_street, 
		shipping_street_number, 
		shipping_zip, 
		shipping_first_name, 
		shipping_last_name, 
		shipping_co
		from c_order where rank_cust=1
)ad on ad.customer_id=cu.customer_id
and c.last_payment_type not like 'Pre-pay'
WHERE
cu.club_member=false
and cu.phone_number is not null
and cu.email not like '%invalid%'
and cu_1.vip_customer<>true
and (cu.subscribed_to_sms=true
or cu.newsletter_accepted=true
or cu.subscribed_to_stylist_emails=true)
and CAST(c.date_created AS DATE)>=TIMESTAMPADD(SQL_TSI_MONTH,-10,CURDATE())"	READY
335	2015-04-24 18:20:59	"1357078079"	true	2015-09-23 11:40:27	tableau.ops_delivery_tracking		"CREATE view tableau.ops_delivery_tracking 
AS

SELECT
  dt.order_id,
  dt.tracking_number,
  CASE 
  	WHEN col.date_returned IS NOT NULL and dt1.date_delivered_to_customer IS NULL then 'deliverd'
  	ELSE dt.tag 
  END AS tag,
  dt.active,
  dt.shipment_type,
  dt.slug AS carrier,
  CASE
  WHEN dt.shipment_type like ('%Rcksendung%') OR dt.shipment_type like ('%returned%') then
'return/refusal'
    WHEN (dt1.date_1st_attemptfail is not null OR dt1.date_1st_attemptfail='' OR dt1.date_1st_exception is not null OR dt1.date_1st_exception='') and dt1.date_delivered_to_customer is null then 'non-delivered after exception/attemptfail'
    WHEN (dt1.date_1st_attemptfail is not null OR dt1.date_1st_attemptfail='' OR dt1.date_1st_exception is not null OR dt1.date_1st_exception='') and dt1.date_delivered_to_customer is not null then 'delivered after exception/attemptfail'
    WHEN dt1.date_1st_attemptfail is null And dt1.date_1st_exception is null and dt1.date_delivered_to_customer is not null  THEN 'delivered without exceptions/attemptfails'
    ELSE 'non-delivered' 
  END AS delivery_state_with_exceptions,
  dt1.nb_of_tracking_events,
  dt1.nb_of_exceptions,
  dt1.nb_of_attemptfails,
  co.date_submitted,
  dt1.date_transmission_to_aftership, /*this date is set by IT after we get shippment label*/
  dt1.date_transmission_to_carrier,
  dt1.date_1st_scan_by_carrier,
  dt1.date_1st_out_for_delivery,
  dt1.date_1st_attemptfail,
  dt1.date_1st_exception,
  dt1.expired_date,
  dt1.date_delivered_to_customer,
  /*Customer Order Details*/
  co.order_state,
  co.order_type,
  co.payment_type,
  co.shipping_first_name,
  co.shipping_last_name,
  co.shipping_co,
  co.shipping_street,
  co.shipping_street_number,
  co.shipping_city,
  co.shipping_zip,
  co.shipping_country,
  /*Customer Order Logistics*/
  col.return_track_and_trace_number,
  col.date_shipped,
  col.date_returned
FROM
(
  SELECT * 
  FROM bi.delivery_tracking 
  WHERE rank=1
)dt
JOIN bi.customer_order_logistics col on col.order_id=dt.order_id and col.track_and_trace_number=dt.tracking_number
LEFT JOIN
(
  SELECT
  	order_id,
  	tracking_number,
    COUNT(order_id) AS nb_of_tracking_events,
    COUNT(CASE WHEN tag='AttemptFail' THEN order_id ELSE NULL END) AS nb_of_attemptfails,
    COUNT(CASE WHEN tag='Exception' THEN order_id ELSE NULL END) AS nb_of_exceptions,
    MAX(CASE WHEN tag='Init' THEN created_at ELSE NULL END) AS date_transmission_to_aftership,
    MAX(CASE WHEN tag='InfoReceived' THEN updated_at ELSE NULL END) AS date_transmission_to_carrier,
    MIN(CASE WHEN tag='InTransit' THEN updated_at ELSE NULL END) AS date_1st_scan_by_carrier,
    MIN(CASE WHEN tag='OutForDelivery' THEN updated_at ELSE NULL END) AS date_1st_out_for_delivery,
    MIN(CASE WHEN tag='AttemptFail' THEN updated_at ELSE NULL END) AS date_1st_attemptfail,
    MIN(CASE WHEN tag='Exception' THEN updated_at ELSE NULL END) AS date_1st_exception,
    MAX(CASE WHEN tag='Expired' THEN updated_at ELSE NULL END) AS expired_date,
    MAX(CASE WHEN tag='Delivered' THEN updated_at ELSE NULL END) AS date_delivered_to_customer
  FROM bi.delivery_tracking
  GROUP BY 1,2
)dt1 on dt.order_id=dt1.order_id and dt.tracking_number=dt1.tracking_number
LEFT JOIN bi.customer_order co on co.order_id=dt.order_id
LEFT JOIN dwh.calendar ca on ca.""date""=cast(dt1.date_delivered_to_customer as date)"	READY
106	2015-04-24 18:17:51	"1112787671"	true	2015-07-02 10:18:19	raw.customer_order_articles_logistics_3mo		"CREATE view raw.customer_order_articles_logistics_3mo AS

WITH so AS
(
SELECT 
	h.order_id,
	h.date_header_created,
	h.shipping_code,
	l.article_id,
	l.line_number,
	l.date_order_line_created,
	l.date_line_created,
	l.date_line_cancelled
FROM
/*---there are often multiple entries in doc_data_sales_order_header, because every time an order is adjusted (by finance or a line item is cancelled because it is out of stock) it is re-submitted. Therefore, always use the min ---*/
	(
	SELECT
		order_id,
		MIN(date_stock_sales_order_header_created) AS date_header_created,
		MAX(shipping_code) AS shipping_code /* almost never more than 1 */
	FROM 
		raw.stock_sales_order_header
	GROUP BY 1
	HAVING
		MIN(date_stock_sales_order_header_created) >= TIMESTAMPADD(SQL_TSI_MONTH,-3,CURDATE())
	) h
	JOIN
/*---quantity = 0 means that the articles is out of stock and will go on backorder. This leads to the item getting cancelled off of the order. Therefore the max date where quantity = 0 is sales_order_line_date_cancelled ---*/
	(
	SELECT
	    b.*,
	    CASE 
	        WHEN date_line_cancelled_sub IS NOT NULL AND date_line_created IS NULL  THEN date_line_cancelled_sub
	        WHEN date_line_cancelled_sub > date_line_created                        THEN date_line_cancelled_sub
	    END AS date_line_cancelled
	FROM
		(
		SELECT
			order_id,
			article_id,
			line_number,
			MIN(date_stock_sales_order_line_created) AS date_order_line_created,
			MIN(CASE WHEN articles = 1 THEN date_stock_sales_order_line_created END) AS date_line_created,
			MIN(CASE WHEN articles < 1 THEN date_stock_sales_order_line_created END) AS date_line_cancelled_sub
		FROM
			raw.stock_sales_order_line
		GROUP BY 1,2,3
		) b
	) l
		 ON h.order_id 		= l.order_id
),
ir AS
(
/*--- if the line item in doc_data_sales_order_import_result has a message, that means it is ""on error"" and requires action from operations. Sometimes a line entry with a message shows up with the 
error message, ""No changes possible in order"", after it has been shipped. These can be ignored.  ---*/
SELECT 
    order_id,
    line_number,
	MIN(date_stock_imported) AS date_import_created,
    MIN(CASE WHEN message  = '' THEN date_stock_imported END) AS date_imported, /* '' equals success */
    MIN(CASE WHEN message != '' THEN date_stock_imported END) AS date_import_error,
    MAX(CASE WHEN message != '' THEN message END) AS import_error /* there are cases where >1 messages; if all messages are needed, then need to change */
FROM
	raw.stock_imported
WHERE
		message != 'No changes possible in order' /* message is not null */
	AND line_number != 0
GROUP BY 1,2
),

sc AS
(
SELECT
    y.*,
    CASE /* THIS CATORGIZES THE ORDER INTO A BUCKET BASED UPON THE LAST ROW OF DATA BEFORE manifest_shipping */
        WHEN date_picklist_created_max IS NOT NULL AND date_backordered_nos_max IS NULL THEN 'picklist created'
        WHEN date_picklist_created_max > date_backordered_nos_max                       THEN 'picklist created'
        ELSE 'backordered/not on stock'
    END AS order_status_change_state /* ARTICLE LEVEL */
FROM
    (
    SELECT
        sc.order_id,
        sc.article_id,
        MIN(sc.date_status_change) AS date_order_status_change_created,
        /* message has only 3 values, 'PICKLIST CREATED', 'BACKORDER', 'NOT ON STOCK' */
        MIN(CASE WHEN sc.message  = 'PICKLIST CREATED' 	THEN sc.date_status_change END) AS date_picklist_created,
        MIN(CASE WHEN sc.message  = 'BACKORDER' 		THEN sc.date_status_change END) AS date_backordered,
        MIN(CASE WHEN sc.message  = 'NOT ON STOCK' 		THEN sc.date_status_change END) AS date_not_on_stock,
        /* MAX USED AT ORDER LEVEL ROLLUP */
        MAX(CASE WHEN sc.message  = 'PICKLIST CREATED' 	THEN sc.date_status_change END) AS date_picklist_created_max,
        MAX(CASE WHEN sc.message != 'PICKLIST CREATED' 	THEN sc.date_status_change END) AS date_backordered_nos_max
    FROM
        raw.stock_sales_order_status_change sc
        LEFT JOIN
        /* JOIN TO doc_data_manifest_shipping TO FILTER OUT ANY DATES AFTER AN ORDER ARRIVES INTO THAT TABLE */
        raw.stock_shipped AS ms
            ON sc.order_id = ms.order_id
    WHERE
            sc.date_status_change < ms.date_stock_shipped
         OR ms.order_id IS NULL
    GROUP BY 1,2
    ) AS y
)


/* MAIN BODY */
SELECT 
	/* Identifiers */
	so.order_id,
	so.article_id,
	
	/* Dates (in order) */
	MIN(so.date_header_created) AS date_header_created,
	MIN(so.date_order_line_created) AS date_order_line_created,
	MIN(so.date_line_created) AS date_line_created,
	MIN(so.date_line_cancelled) AS date_line_cancelled,
	MIN(ir.date_import_created) AS date_import_created,
	MIN(ir.date_imported) AS date_imported,
	CASE
		WHEN MIN(ir.date_import_error) < MIN(sc.date_order_status_change_created)
		THEN MIN(ir.date_import_error)
		WHEN MIN(ir.date_import_error) IS NOT NULL AND MIN(sc.date_order_status_change_created) IS NULL
		THEN MIN(ir.date_import_error)
	END AS date_import_error,
	MIN(sc.date_order_status_change_created) AS date_order_status_change_created,
	MAX(sc.date_picklist_created_max) AS date_picklist_created_max,
	MAX(sc.date_backordered_nos_max) AS date_backordered_nos_max,
	MIN(sc.date_backordered) AS date_backordered,
	MIN(sc.date_not_on_stock) AS date_not_on_stock,
	MIN(sc.date_picklist_created) AS date_picklist_created,
	MIN(ddsc.date_stock_packed) AS date_packed,
	MIN(ddms.date_stock_shipped) AS date_shipped,
	/* add row for date deliverd once data is available from ""postgres.delivery_tracking"" */
	MIN(ddr.date_stock_returned) AS date_returned,
	
	/* other data points */
	MAX(ir.import_error) AS import_error,
	MAX(CAST(ddsc.transport_company_code AS LONG)) AS transport_company_code,
	MAX(ddms.track_and_trace_number) AS track_and_trace_number,
	MAX(ddms.receiver_country_code) AS shipping_country,
	MAX(so.shipping_code) AS shipping_code,
	MAX(LEFT(CAST(ddms.processing_reason AS STRING), 4000)) AS shipment_error,
	MAX(ddms.return_track_and_trace_number) AS return_track_and_trace_number,
	MAX(ddr.return_number) AS return_number,
	MAX(LEFT(CAST(ddr.processing_reason AS STRING), 4000)) AS return_error,
	MAX(sc.order_status_change_state) AS order_status_change_state
	
FROM 
	so
	LEFT JOIN
	ir
		 ON so.order_id 		= ir.order_id
		AND so.line_number 		= ir.line_number
	LEFT JOIN
	sc
		 ON so.order_id 		= sc.order_id
		AND so.article_id		= sc.article_id
	LEFT JOIN 
	raw.stock_packed AS ddsc 
		 ON so.order_id 		= ddsc.order_id
		AND so.article_id		= ddsc.article_id
	LEFT JOIN
	raw.stock_shipped AS ddms 
		 ON so.order_id  		= ddms.order_id
		AND so.article_id		= ddms.article_id		
	LEFT JOIN 
	raw.stock_returned ddr
		 ON so.order_id 		= ddr.order_id
		AND so.article_id 		= ddr.article_id
GROUP BY 1,2"	READY
197	2015-04-24 18:18:57	"1112787706"	true	2015-04-24 18:18:57	views.campaign		"CREATE VIEW views.campaign 
AS
SELECT
campaign_id as id,
NULL as version,
discount_code as code,
date_discount_start as date_start,
date_discount_end as date_end,
discount_usable_amount as useable_amount,
discount_percentage,
discount_absolute,
campaign_type,
campaign_title,
discount_currency as currency
FROM raw.discount_campaigns c"	READY
294,929	2015-07-08 17:52:56	"1329723611"	true	2015-09-17 09:32:23	raw.marketing_contacts_web		"CREATE VIEW raw.marketing_contacts_web
AS


SELECT 
  order_id,
  contact_timestamp,
  marketing_channel,
  marketing_subchannel,
  source,
  medium,
  campaign,
  null as term,
  'Google Analytics' as data_source
FROM raw.marketing_contacts_ga
WHERE CAST(contact_timestamp as date) < '2015-05-24'
/* Fix for missing Snowplow data on 2015-08-24   */ 
OR CAST(contact_timestamp as date) = '2015-08-24'
/* Fix for missing Snowplow data since 2015-09-14   */ 
OR CAST(contact_timestamp as date) = '2015-09-14'
UNION
SELECT
  order_id,
  contact_timestamp,
  marketing_channel,
  marketing_subchannel,
  source,
  medium,
  campaign,
  term,
  'Snowplow' as data_source
FROM raw.marketing_contacts_snowplow
WHERE CAST(contact_timestamp as date) >= '2015-05-28'
AND CAST(contact_timestamp as date) != '2015-08-24'
/* Fix for missing Snowplow data since 2015-09-14   */ 
OR CAST(contact_timestamp as date) != '2015-09-14'"	READY
622,600	2015-09-01 17:50:22	"1248477137"	true	2015-09-01 17:50:22	tableau.ops_address_change		create view tableau.ops_address_change
as

with c_order as
(
SELECT 
    rank() OVER(PARTITION BY customer_id ORDER BY date_created asc) as rank_cust,
    order_id,
    order_type,
    customer_id,
    date_created,
    kept_state,
    payment_type,
    date_invoiced,
    shipping_city,
    shipping_country, 
    shipping_street, 
    shipping_street_number, 
    shipping_zip, 
    shipping_first_name, 
    shipping_last_name, 
    shipping_co, 
    given_to_debt_collection,
    case when revenue_state='Final' then sales_kept end as sales_kept,
    case when revenue_state='Final' then articles_kept end as items_kept
  from bi.customer_order
)
select
a.customer_id,
CASE
  WHEN  
    a.shipping_first_name=b.shipping_first_name
    AND a.shipping_last_name=b.shipping_last_name
    AND a.shipping_street=b.shipping_street
    AND a.shipping_street_number=b.shipping_street_number
    AND a.shipping_zip=b.shipping_zip
    AND a.shipping_city=b.shipping_city
    AND a.shipping_co=b.shipping_co
  THEN 'Y'
  ELSE 'N'
end second_addres_change
from
(
  select
    co.customer_id,
    co.shipping_city,
    co.shipping_country, 
    co.shipping_street, 
    co.shipping_street_number, 
    co.shipping_zip, 
    co.shipping_first_name, 
    co.shipping_last_name, 
    co.shipping_co
  from c_order co
  where rank_cust=1
)a
left join
(
  select
    customer_id,
    co.shipping_city,
    co.shipping_country, 
    co.shipping_street, 
    co.shipping_street_number, 
    co.shipping_zip, 
    co.shipping_first_name, 
    co.shipping_last_name, 
    co.shipping_co
  from c_order co
  where rank_cust=2
)b on a.customer_id=b.customer_id	READY
196,689	2015-06-18 17:31:35	"1329723629"	true	2015-09-17 09:38:45	raw.daily_visits		"CREATE view raw.daily_visits
AS
SELECT 
    ga.date_created, 
    domain, 
    null as geo_country,
    source,
    medium, 
    campaign,
    null as term,
    devicecategory, 
    marketing_subchannel, 
    marketing_channel,
    CASE 
    WHEN marketing_channel = 'Direct' THEN 'direct'
    WHEN marketing_channel = 'SEM Non-brand' THEN 'google sem nobrand'
    WHEN marketing_channel = 'CRM' THEN 'crm'
    WHEN marketing_channel = 'Cooperations' THEN 'kooperation'
    WHEN marketing_channel = 'Facebook' THEN 'facebook'
    WHEN marketing_channel = 'SEO' THEN 'organic'
    WHEN marketing_channel = 'Display' THEN 'display'
    WHEN marketing_channel = 'Affiliate' THEN 'affiliate'
    WHEN marketing_channel = 'SEM Brand' THEN 'google sem brand'
    WHEN marketing_channel = 'Social Media' THEN 'social media'
    WHEN marketing_channel = 'Remarketing' THEN 'remarketing'
    WHEN marketing_channel = 'Referral Program' THEN 'praemienprogramm'
  END AS channel,  
  visits, 
  'Google Analytics' as data_source
FROM raw.ga_visits ga
LEFT JOIN (SELECT CAST(date_created as date) as date_created FROM ""raw.snowplow_visits"" WHERE CAST(date_created as date) >= '2015-05-28' AND /* Until Snowplow data is fixed */ CAST(date_created as date) != '2015-08-24' AND /* Snowplow broken as of 14-09-2015 */ CAST(date_created as date) != '2015-09-14' GROUP BY 1) vi ON ga.date_created = vi.date_created
WHERE vi.date_created is null
AND domain != 'ALL'
AND ga.date_created < CURDATE()
UNION
SELECT 
    CAST(sp.date_created as date) as date_created, 
    domain,
    geo_country, 
    source,
    medium, 
    campaign, 
    term, 
    CASE 
      WHEN device_type = 'Computer' THEN 'desktop'
        WHEN device_type = 'Mobile' THEN 'mobile'
        WHEN device_type = 'Tablet' THEN 'tablet'   
    END AS devicecategory,
    null as  marketing_subchannel,
    marketing_channel,
    CASE 
    WHEN marketing_channel = 'Direct' THEN 'direct'
    WHEN marketing_channel = 'SEM Non-brand' THEN 'google sem nobrand'
    WHEN marketing_channel = 'CRM' THEN 'crm'
    WHEN marketing_channel = 'Cooperations' THEN 'kooperation'
    WHEN marketing_channel = 'Facebook' THEN 'facebook'
    WHEN marketing_channel = 'SEO' THEN 'organic'
    WHEN marketing_channel = 'Display' THEN 'display'
    WHEN marketing_channel = 'Affiliate' THEN 'affiliate'
    WHEN marketing_channel = 'SEM Brand' THEN 'google sem brand'
    WHEN marketing_channel = 'Social Media' THEN 'social media'
    WHEN marketing_channel = 'Remarketing' THEN 'remarketing'
    WHEN marketing_channel = 'Referral Program' THEN 'praemienprogramm'
  END AS channel, 
    COUNT(visitor_session_id) as visits,
    'Snowplow' as data_source
FROM raw.snowplow_visits sp 
LEFT JOIN (SELECT CAST(date_created as date) as date_created FROM ""raw.snowplow_visits"" WHERE  CAST(date_created as date) >= '2015-05-28' AND /* Until Snowplow data is fixed */ CAST(date_created as date) != '2015-08-24' AND /* Snowplow broken as of 14-09-2015 */ CAST(date_created as date) != '2015-09-14'  GROUP BY 1) vi ON CAST(sp.date_created as date) = vi.date_created
WHERE vi.date_created is not null
AND sp.date_created < CURDATE()
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,13"	READY
622,601	2015-09-02 11:17:22	"1253466415"	true	2015-09-02 11:17:22	sandbox.ops_delivery_tracking		"CREATE view sandbox.ops_delivery_tracking 
AS

SELECT
  dt.order_id,
  dt.tracking_number,
  cast(col.track_and_trace_number as double) as track_and_trace_number,
  dt.tag,
  dt.active,
  dt.shipment_type,
  dt.slug AS carrier,
  CASE
  WHEN dt.shipment_type like ('%Rcksendung%') OR dt.shipment_type like ('%returned%') then
'return/refusal'
    WHEN (dt1.date_1st_attemptfail is not null OR dt1.date_1st_attemptfail='' OR dt1.date_1st_exception is not null OR dt1.date_1st_exception='') and dt1.date_delivered_to_customer is null then 'non-delivered after exception/attemptfail'
    WHEN (dt1.date_1st_attemptfail is not null OR dt1.date_1st_attemptfail='' OR dt1.date_1st_exception is not null OR dt1.date_1st_exception='') and dt1.date_delivered_to_customer is not null then 'delivered after exception/attemptfail'
    WHEN dt1.date_1st_attemptfail is null And dt1.date_1st_exception is null and dt1.date_delivered_to_customer is not null  THEN 'delivered without exceptions/attemptfails'
    ELSE 'non-delivered' 
  END AS delivery_state_with_exceptions,
  dt1.nb_of_tracking_events,
  dt1.nb_of_exceptions,
  dt1.nb_of_attemptfails,
  co.date_submitted,
  dt1.date_transmission_to_aftership, /*this date is set by IT after we get shippment label*/
  dt1.date_transmission_to_carrier,
  dt1.date_1st_scan_by_carrier,
  dt1.date_1st_out_for_delivery,
  dt1.date_1st_attemptfail,
  dt1.date_1st_exception,
  dt1.expired_date,
  dt1.date_delivered_to_customer,
  /*Customer Order Details*/
  co.order_state,
  co.order_type,
  co.payment_type,
  co.shipping_first_name,
  co.shipping_last_name,
  co.shipping_co,
  co.shipping_street,
  co.shipping_street_number,
  co.shipping_city,
  co.shipping_zip,
  co.shipping_country,
  /*Customer Order Logistics*/
  col.return_track_and_trace_number,
  col.date_shipped,
  col.date_returned
FROM
(
  SELECT * 
  FROM bi.delivery_tracking 
  WHERE rank=1
)dt
LEFT JOIN
(
  SELECT
  order_id,
  tracking_number,
    COUNT(order_id) AS nb_of_tracking_events,
    COUNT(CASE WHEN tag='AttemptFail' THEN order_id ELSE NULL END) AS nb_of_attemptfails,
    COUNT(CASE WHEN tag='Exception' THEN order_id ELSE NULL END) AS nb_of_exceptions,
    MAX(CASE WHEN tag='Init' THEN created_at ELSE NULL END) AS date_transmission_to_aftership,
    MAX(CASE WHEN tag='InfoReceived' THEN updated_at ELSE NULL END) AS date_transmission_to_carrier,
    MIN(CASE WHEN tag='InTransit' THEN updated_at ELSE NULL END) AS date_1st_scan_by_carrier,
    MIN(CASE WHEN tag='OutForDelivery' THEN updated_at ELSE NULL END) AS date_1st_out_for_delivery,
    MIN(CASE WHEN tag='AttemptFail' THEN updated_at ELSE NULL END) AS date_1st_attemptfail,
    MIN(CASE WHEN tag='Exception' THEN updated_at ELSE NULL END) AS date_1st_exception,
    MAX(CASE WHEN tag='Expired' THEN updated_at ELSE NULL END) AS expired_date,
    MAX(CASE WHEN tag='Delivered' THEN updated_at ELSE NULL END) AS date_delivered_to_customer
  FROM bi.delivery_tracking
  GROUP BY 1,2
)dt1 on dt.order_id=dt1.order_id and dt.tracking_number=dt1.tracking_number
LEFT JOIN bi.customer_order co on co.order_id=dt.order_id
LEFT JOIN bi.customer_order_logistics col on col.order_id=dt.order_id and col.track_and_trace_number=dt.tracking_number
LEFT JOIN dwh.calendar ca on ca.""date""=cast(dt1.date_delivered_to_customer as date)"	READY
622,602	2015-09-02 12:37:33	"1253466770"	true	2015-09-02 13:49:53	tableau.mkt_rt_performance_by_sales_channel		"CREATE VIEW tableau.mkt_rt_performance_by_sales_channel
AS

SELECT
	CAST(date_invoiced as date) as date_invoiced,
	order_id,
	sales_channel,
	sales_channel_special,
	shipping_country,
	CASE 
		WHEN sales_channel = 'showroom' THEN 'Showroom'
		WHEN sales_channel_special = 'Direct Feedback Calls' THEN 'Direct Feedback Calls'
		WHEN sales_channel_special = 'sms' THEN 'sms'
		WHEN sales_channel_special = 'magazine email' THEN 'Magazine email'
		WHEN sales_channel_special = 'OUTFITTERY CLUB' THEN 'Outfittery club'
		WHEN LOWER(sales_channel) like '%website%' THEN 'Website'
		WHEN LOWER(sales_channel) like '%app%' THEN 'App'
		ELSE sales_channel
	END AS sales_channel_adjusted,
	sales_sent,
	sales_kept,
	billing_total
FROM ""bi.customer_order"" co
WHERE co.date_invoiced is not null
AND co.order_type = 'Repeat Order'
AND co.is_real_order = 'Real Order'
AND co.order_state_number >= 16
AND co.order_state_number < 2048"	READY
294,931	2015-07-09 11:58:01	"1253466939"	true	2015-09-02 15:31:24	tableau.stylist_overview_live		"CREATE VIEW tableau.stylist_overview_live
AS

SELECT
  co.id as order_id,
  co.stylelist_id as stylist_id,  
  CASE 
  WHEN s.role = 'Fake' AND s.stylist_id != 118566682 THEN 'Fake Stylist ' || s.team
  ELSE s.first_name || ' ' || s.last_name 
  END as stylist_name,
  s.team as stylist_team,
  s.role as stylist_role,
  co.customer_id,  
  co.sales_channel, 
  CASE
    WHEN real_order.real_order_count = 1 THEN 'First Order'
    WHEN co.sales_channel like 'club%' THEN 'Outfittery Club Order'
    WHEN real_order.real_order_count > 1 AND co.parent_order_id is null THEN 'Repeat Order'
    WHEN co.parent_order_id is not null THEN 'Follow-on Order'
  END as order_type,
  CASE 
    WHEN co.state = 4  THEN 'Initiated'
    WHEN co.state = 8  THEN 'Incoming'
    WHEN co.state = 16 THEN 'Stylist Picked'
    WHEN co.state = 20 THEN 'Purchase Order Created'
    WHEN co.state = 24 THEN 'Sales Order Submitted'
    WHEN co.state = 32 THEN 'Stocked'
    WHEN co.state = 64 THEN 'Placed'
    WHEN co.state = 128 THEN 'Sent'
    WHEN co.state = 256 THEN 'Arrived'
    WHEN co.state = 384 THEN 'Returned Online'
    WHEN co.state = 512 THEN 'Returned'
    WHEN co.state = 1024 THEN 'Completed'
    WHEN co.state = 2048 THEN 'Cancelled'
    ELSE 'Ask BI'
  END as order_state,
  CASE 
    WHEN co.payment_method = 1 THEN 'Invoice'
    WHEN co.payment_method = 2 THEN 'Credit Card'
    WHEN co.payment_method = 4 THEN 'Pre-pay'
    WHEN co.payment_method = 6 THEN 'Arvato'
    ELSE 'Ask BI'
  END as payment_type,
  
/* All dates */
  co.date_created as date_incoming,
  co.phone_date as date_phone_call,
  inv.date_created as date_invoiced,
  co.date_picked as date_stylist_picked,

  CASE 
    WHEN ship_add.country='A' THEN 'AT'
    WHEN ship_add.country='' THEN null
    ELSE ship_add.country 
  END as shipping_country,
  case when CAST(co.date_picked as DATE) = CURDATE() then 1 else null end as processed_today,
  case when CAST(phone_date as date)=curdate() and co.sales_channel != 'website' then 1 else null end as calls_today

FROM postgres.customer_order as co
JOIN postgres.address as ship_add on ship_add.id = co.shipping_address_id
LEFT JOIN postgres.voucher as inv on inv.order_id = co.id AND inv.voucher_type = 'INVOICE'
LEFT JOIN 
(
  SELECT 
    co1.id,
    rank() OVER(PARTITION BY co1.customer_id ORDER BY co1.id) as ""real_order_count""
  FROM postgres.customer_order as co1
  WHERE co1.parent_order_id is null
  OR id=parent_order_id                   /* to deal with bad data where order_id=parent_id */
) as real_order on real_order.id = co.id
JOIN bi.stylist s on s.stylist_id = co.stylelist_id
AND s.enabled
where 
(CAST(co.date_picked as DATE) = CURDATE()
or CAST(phone_date as DATE)=CURDATE())
and co.state <> 2048"	READY
524,289	2015-08-11 17:03:32	"1253467176"	true	2015-09-02 16:39:36	tableau.cs_desk_cases		"CREATE VIEW tableau.cs_desk_cases
AS
SELECT
	ca.""date"",
	COALESCE(a.new_cases,0) AS new_cases,
	COALESCE(b.first_resolved,0) AS first_resolved,
	COALESCE(c.cases_resolved,0) AS cases_resolved
FROM dwh.calendar ca
LEFT JOIN
(
	SELECT 
		cast(created_at as date) as ""date"",
		count(distinct id) as new_cases 
	FROM ""dwh.desk_raw_cases""
	GROUP BY 1
)a on a.""date""=ca.""date""
/*1st resolved*/
LEFT JOIN
(
	SELECT 
		cast(first_resolved_at as date) as ""date"",
		count(distinct id) as first_resolved 
	FROM ""dwh.desk_raw_cases""
	GROUP BY 1
)b on b.""date""=ca.""date""
/*Cases Resolved*/
LEFT JOIN
(
	SELECT 
		cast(resolved_at as date) as ""date"",
		count(distinct id) as cases_resolved 
	FROM ""dwh.desk_raw_cases""
	GROUP BY 1
)c on c.""date""=ca.""date""
WHERE ca.""date""<=curdate()"	READY
819,201	2015-09-17 11:48:02	"1329723900"	true	2015-09-17 11:48:02	raw.dim_customer		"/*******************************************************************
-- Author       Hemanth
-- Created      2015-07-01
-- Purpose      This view Gets the raw data from POSTGRES tables. This table has all  
--              customer related information.
--Tables        principal,profile,userconnection,customer_subscription
-------------------------------------------------------------------------------
-- Modification History
--Date          Author      Description
--2015-09-16   	Hemanth     Added status ""cancelled"" in club_member column
*******************************************************************/

CREATE VIEW raw.dim_customer
AS

SELECT

  p.id AS customer_id,
  p.date_created,
  p.email,
  p.first_name,
  p.last_name,
  CASE 
      WHEN club_status='ACTIVE' THEN 'true'
      WHEN club_status='CANCELLED' THEN 'Cancelled'
      ELSE 'false'
    END AS club_member,
  pr.date_of_birth,
  pr.phone_number,
  p.default_page as domain_page,
  uc.providerid,
  CASE 
      WHEN
          p.first_name IN('test','Test','tester','Tester')
          OR p.first_name like '% test %' OR p.first_name like '% Test %' 
          OR p.last_name IN('test','Test','tester','Tester') OR p.last_name like '% test %' OR p.last_name like '% Test %' 
          OR (p.email like '%test%' and p.email like '%@outfittery%')
          OR (p.email like '%+%' and p.email like '%@outfittery%')
      THEN 'Test User'
      WHEN p.id in ('179899816','179886634','11804631','31281783','143553094','834667','197384812','163836386',
        '62252329','94204965','234063161','242674884','243692185') THEN 'Outfittery Showroom'
    ELSE 'Real User'
    END as user_type,
    CASE 
      WHEN TIMESTAMPDIFF(SQL_TSI_YEAR,cast(pr.date_of_birth as date),curdate())>= 18 AND TIMESTAMPDIFF(SQL_TSI_YEAR,cast(pr.date_of_birth as date),curdate())<=30 THEN '18-30'
      WHEN TIMESTAMPDIFF(SQL_TSI_YEAR,cast(pr.date_of_birth as date),curdate())>= 31 AND TIMESTAMPDIFF(SQL_TSI_YEAR,cast(pr.date_of_birth as date),curdate())<=35 THEN '31-35'
      WHEN TIMESTAMPDIFF(SQL_TSI_YEAR,cast(pr.date_of_birth as date),curdate())>= 36 AND TIMESTAMPDIFF(SQL_TSI_YEAR,cast(pr.date_of_birth as date),curdate())<=45 THEN '36-45'
      WHEN TIMESTAMPDIFF(SQL_TSI_YEAR,cast(pr.date_of_birth as date),curdate())>= 46 AND TIMESTAMPDIFF(SQL_TSI_YEAR,cast(pr.date_of_birth as date),curdate())<=55 THEN '46-55'
      WHEN TIMESTAMPDIFF(SQL_TSI_YEAR,cast(pr.date_of_birth as date),curdate())>= 56 THEN '56+'
      ELSE null
    END as age_group
    
FROM postgres.principal p
LEFT JOIN postgres.profile pr on pr.id=p.profile_id
/*this table has information if customer used facebook,xing,linkdin to register at outfittery*/
LEFT JOIN
(
  SELECT
    row_number() over(partition by userid order by providerid) as r_num,
    userid,
    providerid 
  FROM postgres.userconnection
  WHERE rank=1
  AND secret is not null
)uc on uc.userid=p.email AND r_num=1
/*this table has club information of customer from grails*/
LEFT JOIN
(
  SELECT 
    row_number() over(partition by customer_id order by date_created desc) as rank, 
    customer_id,
  status as club_status
  FROM postgres.customer_subscription
)cl on cl.customer_id=p.id and cl.rank=1"	READY
622,603	2015-09-02 16:40:12	"1253467178"	true	2015-09-02 16:40:35	tableau.cs_desk_cases_test_0209		"CREATE VIEW tableau.cs_desk_cases_test_0209
AS
SELECT
	ca.""date"",
	COALESCE(a.new_cases,0) AS new_cases,
	COALESCE(b.first_resolved,0) AS first_resolved,
	COALESCE(c.cases_resolved,0) AS cases_resolved
FROM dwh.calendar ca
LEFT JOIN
(
	SELECT 
		cast(created_at as date) as ""date"",
		count(distinct id) as new_cases 
	FROM ""dwh.desk_raw_cases""
	GROUP BY 1
)a on a.""date""=ca.""date""
/*1st resolved*/
LEFT JOIN
(
	SELECT 
		cast(first_resolved_at as date) as ""date"",
		count(distinct id) as first_resolved 
	FROM ""dwh.desk_raw_cases""
	GROUP BY 1
)b on b.""date""=ca.""date""
/*Cases Resolved*/
LEFT JOIN
(
	SELECT 
		cast(resolved_at as date) as ""date"",
		count(distinct id) as cases_resolved 
	FROM ""dwh.desk_raw_cases""
	GROUP BY 1
)c on c.""date""=ca.""date""
WHERE ca.""date""<=curdate()"	READY
819,202	2015-09-17 11:57:00	"1329723919"	true	2015-09-17 11:57:00	raw.dim_case		"/*******************************************************************
-- Author       Hemanth
-- Created      2015-07-01
-- Purpose      This view assigns the parent order id if the order id has 
                parent_order_id column filled (ONLY for follown Orders) and
                assigns number of followons created for parent order
--Tables        raw.dim_customer_order
-------------------------------------------------------------------------------
-- Modification History
--Date          Author      Description
--2015-09-16    Hemanth     Added Header to query
*******************************************************************/

CREATE VIEW raw.dim_case 
AS

WITH level_0 AS 
(
  SELECT
    co0.order_id,
    co0.order_id ""origin_order_id"",
    co0.date_created as ""orgin_date_created"",
    0 ""level""
  FROM ""raw.dim_customer_order"" co0
  WHERE co0.parent_order_id IS NULL
),

level_1 AS 
(
  SELECT
    co1.order_id,
    parent.origin_order_id,
    parent.orgin_date_created,
    1 ""level""
  FROM ""raw.dim_customer_order"" co1
  INNER JOIN level_0 parent ON parent.order_id = co1.parent_order_id 
),

level_2 AS 
(
  SELECT
    co1.order_id,
    parent.origin_order_id,
    parent.orgin_date_created,
    2 ""level""
  FROM ""raw.dim_customer_order"" co1
  INNER JOIN level_1 parent ON parent.order_id = co1.parent_order_id 
),

level_3 AS 
(
  SELECT
    co1.order_id,
    parent.origin_order_id,
    parent.orgin_date_created,
    3 ""level""
  FROM ""raw.dim_customer_order"" co1
  INNER JOIN level_2 parent ON parent.order_id = co1.parent_order_id
),

level_4 AS 
(
  SELECT
    co1.order_id,
    parent.origin_order_id,
    parent.orgin_date_created,
    4 ""level""
  FROM ""raw.dim_customer_order"" co1
  INNER JOIN level_3 parent ON parent.order_id = co1.parent_order_id 
),

level_5 AS 
(
  SELECT
    co1.order_id,
    parent.origin_order_id,
    parent.orgin_date_created,
    5 ""level""
  FROM ""raw.dim_customer_order"" co1
  INNER JOIN level_4 parent ON parent.order_id = co1.parent_order_id 
),

level_6 AS 
(
  SELECT
    co1.order_id,
    parent.origin_order_id,
    parent.orgin_date_created,
    6 ""level""
  FROM ""raw.dim_customer_order"" co1
  INNER JOIN level_5 parent ON parent.order_id = co1.parent_order_id 
),

level_7 AS (
SELECT
  co1.order_id,
  parent.origin_order_id,
  parent.orgin_date_created,
  7 ""level""
FROM ""raw.dim_customer_order"" co1
INNER JOIN level_6 parent ON parent.order_id = co1.parent_order_id ),

all_levels AS 
(
  SELECT * FROM level_0
  UNION
  SELECT * FROM level_1
  UNION
  SELECT * FROM level_2
  UNION
  SELECT * FROM level_3
  UNION
  SELECT * FROM level_4
  UNION
  SELECT * FROM level_5
  UNION
  SELECT * FROM level_6
  UNION
  SELECT * FROM level_7
),

cases AS 
(
  SELECT
    co77.customer_id,
    co77.order_id ""case_id"",
    co77.date_created ""case_date_created"",
    RANK() OVER(PARTITION BY co77.customer_id ORDER BY co77.date_created ASC) ""case_no""
  FROM level_0
  LEFT JOIN ""raw.dim_customer_order"" co77 ON co77.order_id = level_0.origin_order_id
)

SELECT
  co88.order_id,
  cases.case_id,
  cases.case_date_created,
  cases.case_no,
  all_levels.level ""level""
FROM ""raw.dim_customer_order"" co88
LEFT JOIN all_levels ON all_levels.order_id = co88.order_id
LEFT JOIN cases ON cases.case_id = all_levels.origin_order_id"	READY
323	2015-04-24 18:20:49	"1308954584"	true	2015-09-13 19:08:02	bi.customer_order_logistics		"CREATE view bi.customer_order_logistics AS

SELECT
	z.*,
	CASE WHEN logistics_order_state = 'created' 					THEN 1 END AS orders_created,
	CASE WHEN logistics_order_state = 'awaiting stylist pick' 		THEN 1 END AS orders_awaiting_stylist_pick,
	CASE WHEN logistics_order_state = 'stylist picked'				THEN 1 END AS orders_stylist_picked,
	CASE WHEN logistics_order_state = 'header created'				THEN 1 END AS orders_header_created,
	CASE WHEN logistics_order_state = 'data import error'			THEN 1 END AS orders_import_error,
	CASE WHEN logistics_order_state = 'imported successfully'		THEN 1 END AS orders_imported_successfully,
	CASE WHEN logistics_order_state = 'backordered/not on stock'	THEN 1 END AS orders_backordered_nos,
	CASE WHEN logistics_order_state = 'picklist created'			THEN 1 END AS orders_picklist_created,
	CASE WHEN logistics_order_state = 'packed'						THEN 1 END AS orders_packed,
	CASE WHEN logistics_order_state = 'shipped'						THEN 1 END AS orders_shipped,
	CASE WHEN logistics_order_state = 'returned'					THEN 1 END AS orders_returned,
	CASE WHEN logistics_order_state IN ('returned', 'shipped')		THEN 1 END AS orders_shipped_and_returned

FROM

(
	WITH col AS
	(
	SELECT
		cos.order_id,
		cos.order_state_number,
		cos.shipping_country,
		sla.sla_date_start,
		sla.sla_date_start_adjusted,
		sla.sla_date_shipment_confirmation,
		sla.sla_date_shipped,
		sla.sla_next_ship_day,
		sla.sla_performance,
		sla.sla_working_days,
		sla.sla_hours,
		MIN(cos.date_created) 					AS date_created,
		MIN(p.date_awaiting_stylist_pick) 		AS date_awaiting_stylist_pick,
		MIN(cos.date_stylist_picked) 			AS date_stylist_picked,
		MIN(c.date_header_created) 				AS date_header_created,
		MIN(c.date_import_created) 				AS date_import_created,
		MIN(c.date_imported) 					AS date_imported,
		MIN(c.date_import_error) 				AS date_import_error,
		MIN(c.date_order_status_change_created)	AS date_order_status_change_created,
		MIN(c.date_backordered) 				AS date_backordered,
		MIN(c.date_not_on_stock) 				AS date_not_on_stock,
		MIN(c.date_picklist_created) 			AS date_picklist_created,
		MAX(c.date_picklist_created_max)		AS date_picklist_created_max,
		MAX(c.date_backordered_nos_max)			AS date_backordered_nos_max,
		MIN(c.date_packed) 						AS date_packed,
		MIN(c.date_shipped) 					AS date_shipped,
		MIN(c.date_returned) 					AS date_returned,
		MAX(c.import_error) 					AS import_error,
		MAX(c.transport_company_code) 			AS transport_company_code,
		MAX(c.track_and_trace_number) 			AS track_and_trace_number,
		MAX(c.shipping_code) 					AS shipping_code,
		MAX(c.return_track_and_trace_number)	AS return_track_and_trace_number,
		MAX(c.shipment_error) 					AS shipment_error,
		MAX(c.return_number) 					AS return_number,
		MAX(c.return_error) 					AS return_error
	FROM
		raw.customer_order_state_number cos
		LEFT JOIN
		/* coal is not the driving table b/c it doesn't cover orders before stylist pick */
		bi.customer_order_articles_logistics c
			ON cos.order_id 		= c.order_id
		LEFT JOIN
		raw.awaiting_stylist_pick AS p
			ON cos.order_id 		= p.order_id
		LEFT JOIN
		raw.customer_order_logists_outbound_sla AS sla
			ON cos.order_id 		= sla.order_id
	GROUP BY
		1,2,3,4,5,6,7,8,9,10,11
	)
	
	SELECT
		order_id,
		order_state_number,
		CASE 
			WHEN date_returned						IS NOT NULL THEN 'returned'
			WHEN date_shipped						IS NOT NULL THEN 'shipped'
			WHEN date_packed						IS NOT NULL THEN 'packed'
			/* Orders can go back and forth between picklist and bo/nos; that's why there's logic to find max dates and evaluate. Also, this is a rollup at the order level */
			WHEN date_picklist_created_max IS NOT NULL AND date_backordered_nos_max IS NULL 	THEN 'picklist created'
			WHEN date_picklist_created_max > date_backordered_nos_max 							THEN 'picklist created'
			WHEN date_picklist_created_max IS NULL AND date_backordered_nos_max IS NOT NULL 	THEN 'backordered/not on stock'
			WHEN date_picklist_created_max < date_backordered_nos_max							THEN 'backordered/not on stock'
			WHEN date_imported						IS NOT NULL	THEN 'imported successfully'
			WHEN date_import_error					IS NOT NULL THEN 'data import error'
			WHEN date_header_created				IS NOT NULL THEN 'header created'
			WHEN date_stylist_picked				IS NOT NULL THEN 'stylist picked'
			WHEN date_awaiting_stylist_pick			IS NOT NULL	THEN 'awaiting stylist pick'
			WHEN date_created						IS NOT NULL	THEN 'created'
			ELSE 'Ask BI'
		END AS logistics_order_state,
		CASE /* to sort the list in tableau quickfilters */
			WHEN date_returned						IS NOT NULL THEN '11-returned'
			WHEN date_shipped						IS NOT NULL THEN '10-shipped'
			WHEN date_packed						IS NOT NULL THEN '09-packed'
			WHEN date_picklist_created_max IS NOT NULL AND date_backordered_nos_max IS NULL 	THEN '08-picklist created'
			WHEN date_picklist_created_max > date_backordered_nos_max 							THEN '08-picklist created'
			WHEN date_picklist_created_max IS NULL AND date_backordered_nos_max IS NOT NULL 	THEN '07-backordered/not on stock'
			WHEN date_picklist_created_max < date_backordered_nos_max							THEN '07-backordered/not on stock'
			WHEN date_imported						IS NOT NULL	THEN '06-imported successfully'
			WHEN date_import_error					IS NOT NULL THEN '05-data import error'	
			WHEN date_header_created				IS NOT NULL THEN '04-header created'
			WHEN date_stylist_picked				IS NOT NULL THEN '03-stylist picked'
			WHEN date_awaiting_stylist_pick			IS NOT NULL	THEN '02-awaiting stylist pick'
			WHEN date_created						IS NOT NULL	THEN '01-created'
			ELSE 'Ask BI'
		END AS logistics_order_state_numbered,
		
		/* DATES */
		date_created,
		CASE
			WHEN order_state_number >= 16 THEN NULL ELSE date_awaiting_stylist_pick 
		END AS date_awaiting_stylist_pick,
		COALESCE(date_stylist_picked, date_header_created) AS date_stylist_picked, /* FOR OLDER RECORDS W/ POOR DATA QUALITY */
		CAST(COALESCE(date_stylist_picked, date_header_created, date_created) AS DATE) AS date_stylist_picked_or_created,
		date_header_created,
		date_import_created,
		date_imported,
		date_import_error,
		date_order_status_change_created,
		date_backordered,
		date_not_on_stock,
		date_picklist_created,
		date_packed,
		date_shipped,
		date_returned,
		
		/* OTHER DATE */
		import_error,
		transport_company_code,
		track_and_trace_number,
		shipping_country,
		shipping_code,
		return_track_and_trace_number,
		shipment_error,
		return_number,
		return_error,
		sla_date_start,
		sla_date_start_adjusted,
		sla_date_shipment_confirmation,
		sla_date_shipped,
		sla_next_ship_day,
		sla_performance,
		sla_working_days,
		sla_hours
	FROM
		col
) z"	READY
688,128	2015-09-07 09:59:13	"1394514001"	true	2015-09-30 17:54:09	tableau.product_visits_funnel_conversion_report		"CREATE VIEW tableau.product_visits_funnel_conversion_report
AS

SELECT
  date_created,
  domain,
  marketing_channel as channel,
  devicecategory,
  visits,
  started_survey,
  completed_survey,
  account_created,
  size_details_added,
  personal_details_added,
  placed_first_order
FROM bi.marketing_funnel_by_date_domain_channel_device"	READY
65,550	2015-05-05 12:28:57	"1278723050"	true	2015-09-07 12:37:42	tableau.product_optimizely_performance		"CREATE VIEW tableau.product_optimizely_performance
AS

SELECT
	op.transaction_id,
	op.optimizely_test_type,
	op.optimizely_test_name as optimizely_test_name_full,
	LEFT(op.optimizely_test_name,LOCATE('):',op.optimizely_test_name)) as optimizely_test_name,
	SUBSTRING(op.optimizely_test_name,LOCATE('):',op.optimizely_test_name)+3) as optimizely_test_version,
	CASE 
		WHEN dv.device_category is not null THEN dv.device_category
		ELSE 'desktop'
	END as device_category,
	co.date_created,
	co.date_stylist_picked,
	co.date_incoming,
	co.date_invoiced,
	co.date_completed,
	co.order_type,
	CASE WHEN co.date_incoming is not null THEN 1 ELSE 0 END AS order_incoming,
	CASE WHEN co.date_invoiced is not null THEN 1 ELSE 0 END AS order_invoiced,
	CASE WHEN cu.phone_number IS NOT NULL THEN 1 ELSE 0 END AS has_phone_number,
	CASE WHEN cos.not_reached=1 THEN 'Not Reached' ELSE 'Reached' END AS reached,
	co.sales_channel,
	co.shipping_country,
	co.revenue_state,
	co.box_type,
	co.sales_sent,
	co.sales_kept,
	co.billing_total,
	cos.date_feedback_call
FROM dwh.ga_information_optimizely op
LEFT JOIN 
(
	SELECT
		a.*,
		b.optimizely_test_type,
		b.optimizely_test_name
	FROM bi.customer_order a
	LEFT JOIN 
	(
		SELECT 
			row_number() OVER(PARTITION BY transaction_id ORDER BY date_created desc) as rank_opt, t.* 
		FROM dwh.ga_information_optimizely t
	)b on b.transaction_id=a.order_id AND b.rank_opt=1
) co ON co.order_id = op.transaction_id and op.optimizely_test_type=co.optimizely_test_type and op.optimizely_test_name=co.optimizely_test_name
LEFT JOIN bi.customer_order_salesforce cos ON co.order_id = cos.order_id
LEFT JOIN bi.customer cu ON cu.customer_id = co.customer_id
LEFT JOIN
(
	SELECT
		transaction_id,
		device_category
	FROM
	(
		SELECT
			DISTINCT
			transaction_id,
			device_category 
		FROM
		(	
			SELECT 
				transaction_id,
				date_created,
				hour_created,
				device_category,
				rank() OVER (PARTITION BY transaction_id ORDER BY date_created ASC, hour_created ASC) as order_count
			FROM ""dwh.ga_information_device""
		) ga
		WHERE order_count = 1
	) ga2
) dv ON dv.transaction_id = op.transaction_id"	READY
819,203	2015-09-17 12:12:17	"1329724566"	true	2015-09-17 15:27:21	sandbox.mkt_investor_report		"CREATE view sandbox.mkt_investor_report
AS


SELECT 
	at.reporting_type, 
	at.""date"", 
	at.domain,
	at.marketing_channel, 
	at.incoming_orders_adjusted,
	at.invoiced_orders_adjusted,
	ua.incoming_first_orders,
	ua.invoiced_first_orders,
	ua.sales_sent,
	ua.sales_kept,
	ua.billing_net_sales,
	ua.billing_total,
	CASE 
		WHEN COALESCE(at.incoming_orders_adjusted, 0) = 0 THEN 0
		ELSE ROUND(ua.incoming_first_orders, 3) / ROUND(at.incoming_orders_adjusted, 3) END as incoming_factor,
	CASE 
		WHEN COALESCE(at.invoiced_orders_adjusted, 0) = 0 THEN 0
		ELSE ROUND(ua.invoiced_first_orders, 3) / ROUND(at.invoiced_orders_adjusted, 3) END as invoiced_factor		
	
FROM bi.marketing_referral_brand_effect_attribution at
LEFT JOIN 
(
			SELECT
					reporting_type,
					""date"",
					domain,
					marketing_channel,
					SUM(incoming_first_orders) as incoming_first_orders,
					SUM(invoiced_first_orders) as invoiced_first_orders,
					SUM(sales_sent) as sales_sent,
					SUM(sales_kept) as sales_kept,
					SUM(billing_net_sales) as billing_net_sales,
					SUM(billing_total) as billing_total
			FROM bi.marketing_order_attribution_aggregated
			GROUP BY 1,2,3,4
) ua ON ua.reporting_type = at.reporting_type AND
		ua.""date"" = at.""date"" AND
		ua.domain = at.domain AND
		ua.marketing_channel = at.marketing_channel"	READY
356	2015-04-24 18:23:04	"1112787834"	true	2015-04-24 18:23:04	ml.project_outfit_customer_info		"CREATE VIEW ml.project_outfit_customer_info AS
SELECT 
	c.customer_id,
	c.first_name,
	c.last_name,
	cos.order_ids
FROM bi.customer AS c
INNER JOIN ml.customer_orders AS cos
	ON cos.customer_id = c.customer_id"	READY
196,670	2015-06-11 17:39:58	"1278724549"	true	2015-09-07 16:48:05	bi.marketing_crm_attribution		"CREATE VIEW bi.marketing_crm_attribution
AS

SELECT  
	at.""date"", 
	at.domain, 
	at.reporting_type, 
	at.marketing_channel, 
	SUM(CASE 
		WHEN at.marketing_channel = 'CRM' THEN null 
		WHEN bf.marketing_channel_group = 'Brand' THEN at.incoming_orders_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.incoming_orders_total is null THEN null 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.incoming_orders_crm is null THEN at.incoming_orders_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.incoming_orders_total is null THEN at.incoming_orders_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.incoming_orders_paid is null OR tot.incoming_orders_paid = 0 THEN at.incoming_orders_adjusted 
		ELSE at.incoming_orders_adjusted+((at.incoming_orders_adjusted/tot.incoming_orders_paid)*tot.incoming_orders_crm) END) 
	 as incoming_orders_adjusted,
		
	SUM(CASE 
		WHEN at.marketing_channel = 'CRM' THEN null 
		WHEN bf.marketing_channel_group = 'Brand' THEN at.invoiced_orders_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.invoiced_orders_total is null THEN null 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.invoiced_orders_crm is null THEN at.invoiced_orders_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.invoiced_orders_total is null THEN at.invoiced_orders_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.invoiced_orders_paid is null OR tot.invoiced_orders_paid = 0 THEN at.invoiced_orders_adjusted 
		ELSE at.invoiced_orders_adjusted+((at.invoiced_orders_adjusted/tot.invoiced_orders_paid)*tot.invoiced_orders_crm) END) 
	as invoiced_orders_adjusted,

	SUM(CASE 
		WHEN at.marketing_channel = 'CRM' THEN null 
		WHEN bf.marketing_channel_group = 'Brand' THEN at.sales_kept_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.sales_kept_total is null THEN null 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.sales_kept_crm is null THEN at.sales_kept_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.sales_kept_total is null THEN at.sales_kept_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.sales_kept_paid is null OR tot.sales_kept_paid = 0 THEN at.sales_kept_adjusted 
		ELSE at.sales_kept_adjusted+((at.sales_kept_adjusted/tot.sales_kept_paid)*tot.sales_kept_crm) END) 
	as sales_kept_adjusted,

	SUM(CASE 
		WHEN at.marketing_channel = 'CRM' THEN null 
		WHEN bf.marketing_channel_group = 'Brand' THEN at.sales_sent_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.sales_sent_total is null THEN null 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.sales_sent_crm is null THEN at.sales_sent_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.sales_sent_total is null THEN at.sales_sent_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.sales_sent_paid is null OR tot.sales_sent_paid = 0 THEN at.sales_sent_adjusted 
		ELSE at.sales_sent_adjusted+((at.sales_sent_adjusted/tot.sales_sent_paid)*tot.sales_sent_crm) END) 
	as sales_sent_adjusted,

	SUM(CASE 
		WHEN at.marketing_channel = 'CRM' THEN null 
		WHEN bf.marketing_channel_group = 'Brand' THEN at.billing_total_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.billing_total_total is null THEN null 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.billing_total_crm is null THEN at.billing_total_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.billing_total_total is null THEN at.billing_total_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.billing_total_paid is null OR tot.billing_total_paid = 0 THEN at.billing_total_adjusted 
		ELSE at.billing_total_adjusted+((at.billing_total_adjusted/tot.billing_total_paid)*tot.billing_total_crm) END) 
	as billing_total_adjusted,

	SUM(CASE 
		WHEN at.marketing_channel = 'CRM' THEN null 
		WHEN bf.marketing_channel_group = 'Brand' THEN at.billing_net_sales_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.billing_net_sales_total is null THEN null 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.billing_net_sales_crm is null THEN at.billing_net_sales_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.billing_net_sales_total is null THEN at.billing_net_sales_adjusted 
		WHEN bf.marketing_channel_group = 'Paid' AND tot.billing_net_sales_paid is null OR tot.billing_net_sales_paid = 0 THEN at.billing_net_sales_adjusted 
		ELSE at.billing_net_sales_adjusted+((at.billing_net_sales_adjusted/tot.billing_net_sales_paid)*tot.billing_net_sales_crm) END) 
	as billing_net_sales_adjusted

FROM bi.marketing_untracked_attribution at 
LEFT JOIN 
( 
	SELECT  
		ab.""date"", 
		ab.domain, 
		ab.reporting_type, 

		SUM(ab.invoiced_orders_adjusted) as invoiced_orders_total, 
		SUM(CASE WHEN bf.marketing_channel_group = 'CRM' THEN ab.invoiced_orders_adjusted ELSE 0 END) as invoiced_orders_crm,
		SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN ab.invoiced_orders_adjusted ELSE 0 END) as invoiced_orders_paid,  
		
		SUM(ab.incoming_orders_adjusted) as incoming_orders_total, 
		SUM(CASE WHEN bf.marketing_channel_group = 'CRM' THEN ab.incoming_orders_adjusted ELSE 0 END) as incoming_orders_crm,
		SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN ab.incoming_orders_adjusted ELSE 0 END) as incoming_orders_paid,

		SUM(ab.sales_kept_adjusted) as sales_kept_total, 
		SUM(CASE WHEN bf.marketing_channel_group = 'CRM' THEN ab.sales_kept_adjusted ELSE 0 END) as sales_kept_crm,
		SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN ab.sales_kept_adjusted ELSE 0 END) as sales_kept_paid,

		SUM(ab.sales_sent_adjusted) as sales_sent_total, 
		SUM(CASE WHEN bf.marketing_channel_group = 'CRM' THEN ab.sales_sent_adjusted ELSE 0 END) as sales_sent_crm,
		SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN ab.sales_sent_adjusted ELSE 0 END) as sales_sent_paid,

		SUM(ab.billing_total_adjusted) as billing_total_total, 
		SUM(CASE WHEN bf.marketing_channel_group = 'CRM' THEN ab.billing_total_adjusted ELSE 0 END) as billing_total_crm,
		SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN ab.billing_total_adjusted ELSE 0 END) as billing_total_paid,

		SUM(ab.billing_net_sales_adjusted) as billing_net_sales_total, 
		SUM(CASE WHEN bf.marketing_channel_group = 'CRM' THEN ab.billing_net_sales_adjusted ELSE 0 END) as billing_net_sales_crm,
		SUM(CASE WHEN bf.marketing_channel_group = 'Paid' THEN ab.billing_net_sales_adjusted ELSE 0 END) as billing_net_sales_paid

	FROM bi.marketing_untracked_attribution ab 
 	LEFT JOIN dwh.marketing_investor_reporting_brand_factors bf ON bf.domain=ab.domain AND bf.marketing_channel=ab.marketing_channel 
 	GROUP  BY 1,2,3
) tot ON tot.""date"" = at.""date"" AND tot.domain=at.domain AND tot.reporting_type = at.reporting_type 
LEFT JOIN dwh.marketing_investor_reporting_brand_factors bf ON bf.domain=at.domain AND bf.marketing_channel=at.marketing_channel 
GROUP BY 1,2,3,4"	READY
408	2015-04-24 18:25:08	"1283792326"	true	2015-09-08 10:26:49	bi.marketing_order_attribution		"CREATE VIEW bi.marketing_order_attribution
AS

SELECT 
	co.order_id,
	CASE 
		WHEN ma.contact_timestamp is null THEN co.date_incoming
		ELSE ma.contact_timestamp
	END AS contact_timestamp,
	CASE
		WHEN ma.marketing_channel is null THEN 'Untracked'
		ELSE ma.marketing_channel
	END as marketing_channel,
	ma.marketing_subchannel,
	ma.source,
	ma.medium,
	ma.term,
	ma.marketing_campaign,
	ma.contact_type,
	CASE
		WHEN ma.marketing_channel is null THEN CAST(1 as DECIMAL (12,5))
		ELSE cast(ma.contact_weight as DECIMAL(12,5))
	END as contact_weight
FROM bi.customer_order co
LEFT JOIN 
(
	SELECT 
			mc.order_id,
			mc.contact_timestamp,
			mc.marketing_channel,
			mc.marketing_subchannel,
			mc.source,
			mc.medium,
			mc.marketing_campaign,
			mc.contact_type,
			mc.term,
			/* Attribution logic */
			CASE 
				WHEN mc2.max_contact_count = 1 THEN 1
				WHEN mc2.max_contact_count = 2 THEN 0.5
				WHEN mc2.max_contact_count > 2 AND mc.contact_count_asc = 1 THEN 0.4
				WHEN mc2.max_contact_count > 2 AND mc.contact_count_asc = mc2.max_contact_count THEN 0.4
				ELSE 0.2/(mc2.max_contact_count-2)			
			END AS contact_weight
		FROM bi.marketing_contacts mc
		LEFT JOIN 
		(
		SELECT 
			order_id,
			MAX(contact_count_asc) as max_contact_count
		FROM bi.marketing_contacts
		GROUP BY 1
		) mc2 ON mc2.order_id = mc.order_id
) ma ON ma.order_id = co.order_id
WHERE (co.order_type = 'First Order' OR co.order_type = 'Repeat Order')"	READY
386	2015-04-24 18:24:11	"1112787861"	true	2015-04-24 18:24:11	tableau.ops_sla_performance_outbound		"CREATE VIEW tableau.ops_sla_performance_outbound AS

SELECT
	col.*
	/* CAST(COALESCE(date_stylist_picked, date_header_created, date_created) AS DATE) AS date_stylist_picked_or_created
	 COALESCE(orders_returned, orders_shipped) orders_shipped_and_returned	*/
FROM 
	bi.customer_order_logistics col"	READY
688,130	2015-09-08 13:59:10	"1283792917"	true	2015-09-08 13:59:10	tableau.cs_desk_cases_test_1304		"create VIEW tableau.cs_desk_cases_test_1304
AS
SELECT
	ca.""date"" as ""rep_date"",
	COALESCE(a.new_cases,0) AS new_cases
FROM dwh.calendar ca
LEFT JOIN
(
	SELECT 
		cast(created_at as date) as ""rep_date"",
		count(distinct id) as new_cases 
	FROM ""dwh.desk_raw_cases""
	GROUP BY 1
)a on a.""rep_date""=ca.""date""
WHERE ca.""date"" <= curdate()"	READY
196,669	2015-06-11 17:27:44	"1293495856"	true	2015-09-10 12:35:29	bi.marketing_untracked_attribution		"CREATE VIEW bi.marketing_untracked_attribution
AS

SELECT
   ba.""date"",
   ba.reporting_type,
   ba.domain,
   ba.marketing_channel,
   ba.incoming_orders_adjusted,
   ba.invoiced_orders_adjusted,
   ba.sales_kept_adjusted,
   ba.sales_sent_adjusted,
   ba.billing_total_adjusted,
   ba.billing_net_sales_adjusted

FROM
(
   SELECT
      ca.""date"",
      ca.reporting_type,
      ca.domain,
      ca.marketing_channel,


      SUM(
         CASE 
         WHEN COALESCE(ab.incoming_orders_not_untracked, 0) = 0 AND COALESCE(ab.incoming_orders_untracked, 0) != 0 THEN mo.monthly_incoming_first_orders_share * ab.incoming_orders_untracked
         WHEN COALESCE(ab.incoming_orders_not_untracked, 0) = 0 THEN 0
         WHEN ab.incoming_orders_untracked is null THEN at.incoming_orders
         ELSE at.incoming_orders + (at.incoming_orders / ab.incoming_orders_not_untracked) * ab.incoming_orders_untracked
      END) AS incoming_orders_adjusted,

      SUM(
         CASE 
         WHEN COALESCE(ab.invoiced_orders_not_untracked, 0) = 0 AND COALESCE(ab.invoiced_orders_untracked, 0) != 0 THEN mo.monthly_invoiced_first_orders_share * ab.invoiced_orders_untracked
         WHEN COALESCE(ab.invoiced_orders_not_untracked, 0) = 0 THEN 0
         WHEN ab.invoiced_orders_untracked is null THEN at.invoiced_orders
         ELSE at.invoiced_orders + (at.invoiced_orders / ab.invoiced_orders_not_untracked) * ab.invoiced_orders_untracked
      END) AS invoiced_orders_adjusted,
      
      SUM(
         CASE 
         WHEN COALESCE(ab.sales_kept_not_untracked, 0) = 0 AND COALESCE(ab.sales_kept_untracked, 0) != 0 THEN mo.monthly_sales_kept_share * ab.sales_kept_untracked
         WHEN COALESCE(ab.sales_kept_not_untracked, 0) = 0 THEN 0
         WHEN ab.sales_kept_untracked is null THEN at.sales_kept
         ELSE at.sales_kept + (at.sales_kept / ab.sales_kept_not_untracked) * ab.sales_kept_untracked
      END) AS sales_kept_adjusted,

      SUM(
         CASE 
         WHEN COALESCE(ab.sales_sent_not_untracked, 0) = 0 AND COALESCE(ab.sales_sent_untracked, 0) != 0 THEN mo.monthly_sales_sent_share * ab.sales_sent_untracked
         WHEN COALESCE(ab.sales_sent_not_untracked, 0) = 0 THEN 0
         WHEN ab.sales_sent_untracked is null THEN at.sales_sent
         ELSE at.sales_sent + (at.sales_sent / ab.sales_sent_not_untracked) * ab.sales_sent_untracked
      END) AS sales_sent_adjusted,

      SUM(
         CASE 
         WHEN COALESCE(ab.billing_total_not_untracked, 0) = 0 AND COALESCE(ab.billing_total_untracked, 0) != 0 THEN mo.monthly_billing_total_share * ab.billing_total_untracked
         WHEN COALESCE(ab.billing_total_not_untracked, 0) = 0 THEN 0
         WHEN ab.billing_total_untracked is null THEN at.billing_total
         ELSE at.billing_total + (at.billing_total / ab.billing_total_not_untracked) * ab.billing_total_untracked
      END) AS billing_total_adjusted,

      SUM(
         CASE 
         WHEN COALESCE(ab.billing_net_sales_not_untracked, 0) = 0 AND COALESCE(ab.billing_net_sales_untracked, 0) != 0 THEN mo.monthly_billing_net_sales_share * ab.billing_net_sales_untracked
         WHEN COALESCE(ab.billing_net_sales_not_untracked, 0) = 0 THEN 0
         WHEN ab.billing_net_sales_untracked is null THEN at.billing_net_sales
         ELSE at.billing_net_sales + (at.billing_net_sales / ab.billing_net_sales_not_untracked) * ab.billing_net_sales_untracked
      END) AS billing_net_sales_adjusted

   FROM
   (
   SELECT
         rt.reporting_type,
         c.date,
         c.year_month,
         x.domain,
         x.marketing_channel
      FROM dwh.calendar c 
      CROSS JOIN (SELECT domain, marketing_channel FROM bi.marketing_order_attribution_aggregated GROUP BY 1,2) x
      CROSS JOIN (SELECT 'date_incoming' as reporting_type UNION SELECT 'date_invoiced' as reporting_type) rt
      WHERE c.date > '2012'
      AND c.date < CURDATE()
   ) ca

   /* These are the tracked orders and will serve as the starting point for the calculation  */ 
   LEFT JOIN
   (
      SELECT
         ag.reporting_type,
         ag.""date"",
         ag.domain,
         ag.marketing_channel,
         SUM(incoming_first_orders) as incoming_orders,
         SUM(invoiced_first_orders) as invoiced_orders,
         SUM(sales_sent) as sales_sent,
         SUM(sales_kept) as sales_kept,
         SUM(billing_total) as billing_total,
         SUM(billing_net_sales) as billing_net_sales
      FROM bi.marketing_order_attribution_aggregated ag
      WHERE marketing_channel != 'Untracked'
      GROUP BY 1,2,3,4
   ) at ON ca.date = at.date AND ca.domain = at.domain AND ca.reporting_type = at.reporting_type AND at.marketing_channel = ca.marketing_channel


   /* daily totals for calculation */
   LEFT JOIN
   (
      SELECT
         ag.reporting_type,
         ag.""date"",
         ag.domain,
         SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN incoming_first_orders ELSE null END) as incoming_orders_untracked,
         SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN invoiced_first_orders ELSE null END) as invoiced_orders_untracked,
         SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN incoming_first_orders ELSE null END) as incoming_orders_not_untracked,
         SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN invoiced_first_orders ELSE null END) as invoiced_orders_not_untracked,
         SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN sales_kept ELSE null END) as sales_kept_untracked,
         SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN sales_kept ELSE null END) as sales_kept_not_untracked,
         SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN sales_sent ELSE null END) as sales_sent_untracked,
         SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN sales_sent ELSE null END) as sales_sent_not_untracked,
         SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN billing_total ELSE null END) as billing_total_untracked,
         SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN billing_total ELSE null END) as billing_total_not_untracked,
         SUM(CASE WHEN mi.marketing_channel_group = 'Untracked' THEN billing_net_sales ELSE null END) as billing_net_sales_untracked,
         SUM(CASE WHEN mi.marketing_channel_group != 'Untracked' THEN billing_net_sales ELSE null END) as billing_net_sales_not_untracked
      FROM 
      (
         SELECT 
            reporting_type,
            ""date"",
            domain,
            marketing_channel,
            SUM(incoming_first_orders) as incoming_first_orders,
            SUM(invoiced_first_orders) as invoiced_first_orders,
            SUM(sales_sent) as sales_sent,
            SUM(sales_kept) as sales_kept,
            SUM(billing_net_sales) as billing_net_sales,
            SUM(billing_total) as billing_total
         FROM bi.marketing_order_attribution_aggregated
         GROUP BY 1,2,3,4
      ) ag
      LEFT JOIN dwh.marketing_investor_reporting_brand_factors mi ON mi.marketing_channel = ag.marketing_channel AND mi.domain = ag.domain
      GROUP BY 1,2,3
   ) ab ON ca.date = ab.date AND ca.domain = ab.domain AND ca.reporting_type = ab.reporting_type

   LEFT JOIN
   (
   /* When there are only untracked orders on a certain day, these orders can't be distributed by daily share and will be distributed by monthly share */
      SELECT
         mc.reporting_type,
         mc.year_month,
         mc.domain,
         mc.marketing_channel,
         CASE WHEN COALESCE(mt.invoiced_first_orders_monthly, 0) = 0 THEN 0 ELSE mc.invoiced_first_orders_monthly / mt.invoiced_first_orders_monthly END as monthly_invoiced_first_orders_share,
         CASE WHEN COALESCE(mt.incoming_first_orders_monthly, 0) = 0 THEN 0 ELSE mc.incoming_first_orders_monthly / mt.incoming_first_orders_monthly END as monthly_incoming_first_orders_share,
         CASE WHEN COALESCE(mt.sales_sent_monthly, 0) = 0 THEN 0 ELSE mc.sales_sent_monthly / mt.sales_sent_monthly END as monthly_sales_sent_share,
         CASE WHEN COALESCE(mt.sales_kept_monthly, 0) = 0 THEN 0 ELSE mc.sales_kept_monthly / mt.sales_kept_monthly END as monthly_sales_kept_share,
         CASE WHEN COALESCE(mt.billing_net_sales_monthly, 0) = 0 THEN 0 ELSE mc.billing_net_sales_monthly / mt.billing_net_sales_monthly END as monthly_billing_net_sales_share,
         CASE WHEN COALESCE(mt.billing_total_monthly, 0) = 0 THEN 0 ELSE  mc.billing_total_monthly / mt.billing_total_monthly END as monthly_billing_total_share
      FROM
      (
         SELECT 
            reporting_type,
            c.year_month,
            domain,
            marketing_channel,
            SUM(incoming_first_orders) as incoming_first_orders_monthly,
            SUM(invoiced_first_orders) as invoiced_first_orders_monthly,
            SUM(sales_sent) as sales_sent_monthly,
            SUM(sales_kept) as sales_kept_monthly,
            SUM(billing_net_sales) as billing_net_sales_monthly,
            SUM(billing_total) as billing_total_monthly
         FROM bi.marketing_order_attribution_aggregated ag
         LEFT JOIN dwh.calendar c ON c.""date"" = ag.""date""
         WHERE marketing_channel != 'Untracked'
         GROUP BY 1,2,3,4
      ) mc
      LEFT JOIN
      (
         SELECT 
            reporting_type,
            c.year_month,
            domain,
            SUM(incoming_first_orders) as incoming_first_orders_monthly,
            SUM(invoiced_first_orders) as invoiced_first_orders_monthly,
            SUM(sales_sent) as sales_sent_monthly,
            SUM(sales_kept) as sales_kept_monthly,
            SUM(billing_net_sales) as billing_net_sales_monthly,
            SUM(billing_total) as billing_total_monthly
         FROM bi.marketing_order_attribution_aggregated ag
         LEFT JOIN dwh.calendar c ON c.""date"" = ag.""date""
         WHERE marketing_channel != 'Untracked'
         GROUP BY 1,2,3
      ) mt ON mt.reporting_type = mc.reporting_type AND mt.year_month = mc.year_month AND mt.domain = mc.domain
   ) mo ON mo.reporting_type = ca.reporting_type AND mo.year_month = ca.year_month AND mo.domain = ca.domain AND mo.marketing_channel = ca.marketing_channel
   GROUP BY 1,2,3,4
) ba
WHERE COALESCE(ba.incoming_orders_adjusted, 0) != 0 OR COALESCE(ba.invoiced_orders_adjusted, 0) != 0"	READY
819,213	2015-09-17 17:08:43	"1351408999"	true	2015-09-22 09:55:55	raw.nfone_DE_summary_view		"CREATE view raw.nfone_DE_summary_view
as
WITH answered_call as (
						select cast(date_called as date) as date_called, count(*) as answered_call_vol
 	 					from ""dwh.nfone_data""
	 					where call_queue is not null
	 					and call_queue like '%DE%'
	 					and call_duration <> 0
	 					and cast(date_called as date) >= '2015-01-01'
	 					group by  cast(date_called as date)
	 					order by cast(date_called as date) asc
	 					),
	unanswered_call as (
						select cast(date_called as date) as date_called, count(*) as unanswered_call_vol
 	 					from ""dwh.nfone_data""
	 					where call_duration = 0
	 					and call_queue like '%DE%'
	 					and cast(date_called as date) >= '2015-01-01'
	 					group by cast(date_called as date)
	 					order by cast(date_called as date) asc												
						),
	total_call as (
						select cast(date_called as date) as date_called, count(*) as total_call_vol
 	 					from ""dwh.nfone_data""
	 					where call_queue like '%DE%'
	 					and cast(date_called as date) >= '2015-01-01'
	 					group by  cast(date_called as date)
	 					order by cast(date_called as date) asc	
				)	 														
select answered_call.date_called, 
	   total_call_vol as ""eingehende_Calls"", 
	   answered_call_vol as ""beantwortete"", 
	   unanswered_call_vol as ""unbeantwortet""	   
from answered_call, unanswered_call, total_call
where answered_call.date_called = unanswered_call.date_called
and unanswered_call.date_called = total_call.date_called
order by date_called desc;"	READY
819,209	2015-09-17 16:25:52	"1351409054"	true	2015-09-22 10:06:07	raw.nfone_NL_summary_view		"CREATE view raw.nfone_NL_summary_view
as
WITH answered_call as (
						select cast(date_called as date) as date_called, count(*) as answered_call_vol
 	 					from ""dwh.nfone_data""
	 					where call_queue is not null
	 					and call_queue like '%NL%'
	 					and call_duration <> 0
	 					and cast(date_called as date) >= '2015-01-01'
	 					group by  cast(date_called as date)
	 					),
	unanswered_call as (
						select cast(date_called as date) as date_called, count(*) as unanswered_call_vol
 	 					from ""dwh.nfone_data""
	 					where call_duration = 0
	 					and call_queue like '%NL%'
	 					and cast(date_called as date) >= '2015-01-01'
	 					group by cast(date_called as date)											
						),
	total_call as (
						select cast(date_called as date) as date_called, count(*) as total_call_vol
 	 					from ""dwh.nfone_data""
	 					where call_queue like '%NL%'
	 					and cast(date_called as date) >= '2015-01-01'
	 					group by cast(date_called as date)	
				)	 														
select answered_call.date_called, 
	   total_call_vol as ""eingehende_Calls"", 
	   answered_call_vol as ""beantwortete"", 
	   unanswered_call_vol as ""unbeantwortet""	   
from answered_call, unanswered_call, total_call
where answered_call.date_called = unanswered_call.date_called
and unanswered_call.date_called = total_call.date_called
order by date_called desc;"	READY
819,215	2015-09-18 18:05:15	"1351631479"	true	2015-09-22 14:12:10	raw.customer_order_issue_full_30days_all		"CREATE view raw.customer_order_issue_full_30days_all
as
select
	cast(a.date_shipped as date) as date_created,
	case
		when a.order_type = 'Repeat Order' then 'Repeat'
		else 'Follow_On'
	end as order_type,
	count(distinct a.order_id) as volume
from dwh.customer_order_apr_sep a
where cast(a.date_shipped as date)  >= '2015-05-01'
	and a.order_state != 'Cancelled'
	and a.order_type in ('Repeat Order', 'Repeat Order Follow-on', 'First Order Follow-on')
	and exists (
		select 1
		from dwh.customer_order_apr_sep b
		where a.customer_id = b.customer_id
			and b.order_id != a.order_id
			and b.order_state != 'Cancelled'
			and cast(b.date_shipped as date) >= '2015-04-01'
			                                                                                                                                          			and TIMESTAMPDIFF(SQL_TSI_DAY, b.date_shipped, a.date_shipped) <= 31                    			and TIMESTAMPDIFF(SQL_TSI_DAY, b.date_shipped, a.date_shipped) >= 0                   	)
group by 1,2
;"	READY
819,216	2015-09-18 18:05:46	"1351631480"	true	2015-09-22 14:12:54	raw.customer_order_issue_full_30days_repeats		"CREATE view raw.customer_order_issue_full_30days_repeats
as
select
	cast(a.date_shipped as date) as date_created,
	'Repeat' as order_type,
	count(distinct a.order_id) as volume
from dwh.customer_order_apr_sep a
where cast(a.date_shipped as date) >= '2015-05-01'
	and a.order_type = 'Repeat Order'
	and exists (
		select 1
		from dwh.customer_order_apr_sep b
		where a.customer_id = b.customer_id
			and cast(b.date_shipped as date) between cast(TIMESTAMPADD(SQL_TSI_DAY, -30, a.date_shipped) as date) and cast(a.date_shipped as date)
	)
group by cast(a.date_shipped as date)

union all

select
	cast(a.date_shipped as date) as date_created,
	'Follow_On' as order_type,
	count(distinct a.order_id) as volume
from dwh.customer_order_apr_sep a
where cast(a.date_shipped as date) >= '2015-05-01'
	and a.order_type in ('Repeat Order Follow-on', 'First Order Follow-on')
group by cast(a.date_shipped as date)
;"	READY
121	2015-04-24 18:17:54	"1330320509"	true	2015-09-18 21:52:31	tableau.monitoring_dv_optimizations		"CREATE VIEW tableau.monitoring_dv_optimizations
AS

SELECT
CASE 
	WHEN sjr.jobType = 'recopt' THEN 'optimisation'
	ELSE sjr.jobType 
END as job_type,
jobId as job_id,
CASE WHEN sj.id is not null THEN SUBSTRING(cast(sjr.startTime as string) , 12, 2) ELSE null END as job_run_time, 
CASE 
	WHEN sjr.jobType = 'recopt' THEN SUBSTRING(SUBSTRING(sjr.sqlCommand, 16), 0, LOCATE('""', SUBSTRING(sjr.sqlCommand, 16))-1)
	ELSE sj.description
END as job_name,
ds.data_source,
sjr.startTime as start_time,
CASE WHEN sjr.status = 'RUNNING' THEN now() ELSE sjr.endTime END as end_time,
CASE 
	WHEN sjr.status = 'RUNNING' THEN ROUND(cast(cast(TIMESTAMPDIFF(SQL_TSI_SECOND, sjr.startTime, now()) as double)/cast(60 as double) as decimal), 2)
	ELSE ROUND(cast(cast(TIMESTAMPDIFF(SQL_TSI_SECOND, sjr.startTime, sjr.endTime) as double)/cast(60 as double) as decimal), 2)
END as mins,
CASE 
	WHEN sjr.status = 'SUCCESS' THEN 'SUCCESS'
	WHEN sjr.status = 'FAILED' THEN 'FAILED'
	WHEN sjr.status = 'RUNNING' THEN 'RUNNING'
	ELSE 'INTERRUPTED'
END as status,
sjr.failureReason as failure_reason
FROM SYSADMIN.ScheduleJobRun sjr 
LEFT JOIN SYSADMIN.ScheduleJobs sj on sj.id = sjr.jobId
LEFT JOIN dwh.dv_job_data_sources ds on ds.job_name = 
(
CASE 
	WHEN sjr.jobType = 'recopt' THEN SUBSTRING(SUBSTRING(sjr.sqlCommand, 16), 0, LOCATE('""', SUBSTRING(sjr.sqlCommand, 16))-1)
	ELSE sj.description
END
)
WHERE 
NOT (sjr.status = 'RUNNING' 
AND TIMESTAMPDIFF(SQL_TSI_SECOND, sjr.startTime, now())/60 > 1500)
AND NOT TIMESTAMPDIFF(SQL_TSI_SECOND, sjr.startTime, sjr.endTime)/60 > 1500"	READY
851,968	2015-09-21 12:24:39	"1346130216"	true	2015-09-21 12:46:29	sandbox.crm_business_look		"CREATE view sandbox.crm_business_look
AS

SELECT
  a.customer_id,
  a.email,
  a.begruessung,
  a.anrede,
  a.du_sie as firstnamebasis,
  a.first_name as Vorname,
  a.last_name as Nachname,
  a.default_page as ""UTM Country"",
  lower(a.default_page) as ""country inital"",
  b.completed_orders,
  b.articles_kept,
  ROUND(b.avg_billing_total,2) as avg_billing_total,
  a.stylist_firstname as ""style-experte firstname"",
  a.stylist_lastname as ""style-experte lastname"",
  a.token,
  a.customer_age,
  b.last_order_date,
  cs.work_style_suit,
  cs.work_style_smart_casual,
  cs.work_style_conservative
FROM
(
  SELECT 
    row_number() over (partition by co.customer_id order by co.date_created desc) AS ""rnum"",
    cu.email,
    CASE WHEN cu.gender = 'Male' THEN 'Herr' ELSE 'Frau' END as anrede,
    case
      when cu.gender= 'Male' THEN 'Lieber'
      when cu.gender= 'Female' THEN 'Liebe'
    end AS ""begruessung"",
    cu.formal as du_sie,
    cu.first_name,
    cu.last_name,
    cu.phone_number,
    cu.customer_age,
    cu.default_domain as default_page,
    cu.customer_id,
    st.first_name as stylist_firstname,
    st.last_name as stylist_lastname,
    cu.token
  FROM bi.customer_order co
  JOIN bi.customer cu on cu.customer_id=co.customer_id and cu.subscribe_status != 'Unsubscribed' AND cu.email not like '%invalid%' and cu.club_member='false'
  LEFT JOIN raw.customer_salesforce cs on cs.customer_id=co.customer_id 
  LEFT JOIN bi.stylist st on st.stylist_id=cu.new_stylist_id
  LEFT JOIN raw.customer_brand_cluster cr on cr.customer_id = co.customer_id
  WHERE
  cu.gender= 'Male'
  and co.shipping_country in ('DE','AT','CH','LU')
  AND co.order_state='Completed'
  AND co.date_given_to_debt_collection IS NULL
)a
JOIN
(
SELECT 
  customer_id,
  COALESCE(work_style__suit,old_work_style__suit,0) AS work_style_suit,
  COALESCE(work_style__smart_casual,old_work_style__smart_casual,0) AS work_style_smart_casual,
  COALESCE(work_style__conservative,0) as work_style_conservative
FROM raw.customer_survey
WHERE
COALESCE(work_style__suit,old_work_style__suit)=1
OR
COALESCE(work_style__smart_casual,old_work_style__smart_casual)=1
OR
work_style__conservative=1
)cs on cs.customer_id=a.customer_id
LEFT JOIN
(
  SELECT
    customer_id,
    max(date_created) as last_order_date,
    sum(CASE WHEN order_state= 'Completed' THEN  articles_kept ELSE NULL END) articles_kept,
    COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as completed_orders,
    SUM(CASE WHEN order_state= 'Completed' THEN billing_total ELSE NULL END) /COUNT(DISTINCT CASE WHEN order_state= 'Completed' THEN order_id ELSE NULL END) as avg_billing_total
  FROM bi.customer_order
  group by 1
)b on a.customer_id=b.customer_id
WHERE a.rnum = '1'
and b.articles_kept>=1
and cast(b.last_order_date as date)<=timestampadd(sql_tsi_week,-4,curdate())"	READY
360,449	2015-07-20 18:04:20	"1112788007"	true	2015-07-21 12:45:59	sandbox.discount_contacts		"CREATE VIEW sandbox.discount_contacts
AS


SELECT 
	co.order_id,
	co.date_incoming as contact_timestamp,
	cam.marketing_channel as marketing_channel,
	CASE
		WHEN cam.marketing_channel = 'Referral Program' AND (cam.marketing_subchannel = 'Employees' OR LOWER(cam.marketing_campaign) LIKE '%employee%') THEN 'Employees'
		WHEN cam.marketing_channel = 'Referral Program' AND (cam.marketing_subchannel = 'Boxes' OR LOWER(cam.marketing_campaign) NOT LIKE '%employee%') THEN 'Boxes'
		WHEN cam.marketing_channel = 'Affiliate' AND (cam.marketing_subchannel = 'Platform' OR LOWER(cam.marketing_campaign) NOT LIKE '%cb%' AND LOWER(cam.marketing_campaign) NOT LIKE '%benefits%') THEN 'Platform'
		WHEN cam.marketing_channel = 'Affiliate' AND (cam.marketing_subchannel = 'Corporate Benefit Program' OR LOWER(cam.marketing_campaign) LIKE '%cb%' OR LOWER(cam.marketing_campaign) LIKE '%benefits%') THEN 'Corporate Benefit Program'
		WHEN cam.marketing_channel = 'Cooperations' AND (cam.marketing_subchannel = 'B2B' OR LOWER(cam.marketing_campaign) LIKE '%b2b%') THEN 'B2B'
		WHEN cam.marketing_channel = 'Cooperations' AND (cam.marketing_subchannel = 'Print Ads' OR LOWER(cam.marketing_campaign) LIKE '%print%') THEN 'Print Ads'
		WHEN cam.marketing_channel = 'Cooperations' AND (cam.marketing_subchannel = 'Offline Promo' OR LOWER(cam.marketing_campaign) LIKE '%promo%') THEN 'Offline Promo'
		WHEN cam.marketing_channel = 'Cooperations' AND (cam.marketing_subchannel = 'Newsletter' OR LOWER(cam.marketing_campaign) LIKE '%_nl_%') THEN 'Newsletter'
		WHEN cam.marketing_channel = 'Offline Promotions' THEN 'Offline Promotions'
		ELSE cam.campaign_type
	END AS marketing_sub_channel,
	cam.cluster,
	cam.publisher,
	CASE
		WHEN ca.campaign_title is null THEN 'Voucher campaign'
		ELSE ca.campaign_title
	END AS marketing_campaign
FROM bi.customer_order co
LEFT JOIN raw.discount_campaigns  ca on co.campaign_id = ca.campaign_id
LEFT JOIN 
(
	SELECT
		ca.campaign_id,
		CASE
			WHEN vcc.campaign_channel = 'Offline Promotions' OR ca.campaign_title like 'OFFLINE_%' THEN 'Offline Promotions'
			WHEN vcc.campaign_channel = 'Referral Program' OR LOWER(ca.campaign_title) like '%referral%' THEN 'Referral Program'
			WHEN de.marketing_channel = 'Inserts' OR vcc.campaign_channel = 'Inserts' OR LOWER(ca.campaign_title) like '%inserts%' THEN 'Inserts'
			WHEN de.marketing_channel = 'Cooperations' OR vcc.campaign_channel = 'Cooperations' OR LOWER(ca.campaign_title) like '%coop%' THEN 'Cooperations'
			WHEN vcc.campaign_channel = 'CRM' OR LOWER(ca.campaign_title) like '%crm%' THEN 'CRM'
			WHEN de.marketing_channel = 'Affiliate' OR vcc.campaign_channel = 'Affiliate' OR LOWER(ca.campaign_title) like '%affiliate%' THEN 'Affiliate'
			WHEN vcc.campaign_channel = 'Remarketing' OR LOWER(ca.campaign_title) like '%remarketing%' THEN 'Remarketing'
			WHEN vcc.campaign_channel = 'Display' OR LOWER(ca.campaign_title) like '%display%' THEN 'Display'
			WHEN vcc.campaign_channel = 'Facebook' OR LOWER(ca.campaign_title) like '%facebook%' THEN 'Facebook'
			WHEN vcc.campaign_channel = 'Offline Promotions' OR ca.campaign_title like 'OFFLINE_%' THEN 'Offline Promotions'
			ELSE 'Other voucher'
		END as marketing_channel,
		vcc.campaign_subchannel as marketing_subchannel,
		vcc.campaign_title as marketing_campaign,
		de.campaign_type,
		de.publisher,
		de.cluster		
	FROM raw.discount_campaigns  ca
	LEFT JOIN dwh.voucher_campaign_channel vcc ON ca.campaign_title = vcc.campaign_title
	LEFT JOIN 
	(
	SELECT 
		campaign_title,
		marketing_channel,
		campaign_type, 
		LOWER(publisher) as publisher,
		LOWER(cluster) as cluster
	FROM raw.marketing_voucher_campaign_details  
	) de ON ca.campaign_title = de.campaign_title
) cam ON ca.campaign_id = cam.campaign_id
WHERE co.campaign_id is not null
AND co.date_incoming is not null"	READY
425,988	2015-08-04 10:37:18	"1243498962"	true	2015-08-31 17:36:54	tableau.daily_app_overview		"CREATE VIEW tableau.daily_app_overview
AS

SELECT
	co.date_incoming,
	co.shipping_country,
	co.incoming_app_orders,
	dl.app_installs,
	co.invoiced_orders,
	co.sales_sent_call,
	co.sales_sent_no_call
FROM
(
	SELECT
		CAST(date_incoming as date) as date_incoming,
		shipping_country,
		COUNT(order_id) as incoming_app_orders,
		COUNT(DISTINCT CASE WHEN date_invoiced IS NOT NULL THEN order_id ELSE NULL END) as invoiced_orders,
		SUM(CASE WHEN revenue_state='Final' AND box_type='Call Box' THEN sales_sent ELSE 0 END) as sales_sent_call,
		SUM(CASE WHEN revenue_state='Final' AND box_type='No Call Box' THEN sales_sent ELSE 0 END) as sales_sent_no_call
	FROM bi.customer_order
	WHERE LOWER(sales_channel) like '%app%'
	AND date_incoming is not null
	GROUP BY 1,2
	ORDER BY 1 desc
) co
LEFT JOIN
(
/*Number of app installs per display */
SELECT
	CAST(date_created as date) as date_created,
	CASE
		WHEN country = 'de' THEN 'DE'
		WHEN country = 'at' THEN 'AT'
		WHEN country = 'ch' THEN 'CH'
		WHEN country = 'nl' THEN 'NL'
		WHEN country = 'be' THEN 'BE'
		WHEN country = 'lu' THEN 'lu'
		WHEN country = 'se' THEN 'SE'
		WHEN country = 'dk' THEN 'DK'
		ELSE 'Other'
	END AS country,
	SUM(installs) as app_installs
FROM dwh.appdownloads
GROUP BY 1,2	
) dl ON dl.date_created = co.date_incoming AND dl.country = co.shipping_country"	READY
